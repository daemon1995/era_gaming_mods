ZVSE2

********************************************************************************
                 Advanced Classes Mod 1.09 for ERA 3.x
********************************************************************************

A Mod by Perry R. 2016-2024.
Contributors: Credits in the readme.txt

Content:

1. Disabled WoG Options and Global Settings
2. Handling of Class Points
3. Level up Procedure
4. Global Skill Balancing
5. Master and Grandmaster Secondary Skills (0-27)
6. Class Bonus Handling
7. Changes to Commanders
8. Setting Hero Specialisation descriptions
9. Scripting Hero Specialisation
10. New Artifact and Sets Section
11. Warmachine Upgrades
12. Spell Trainer

For feedback, bug reports and updates
Visit http://heroescommunity.com Advanced Classes Mod
Name on Heroescommunity: RerryR (but please, call me Perry)

********************************************************************************
!#VRi^acm_isGameStarted^:S(FALSE);

!#SN:W^Adept_Level_Global_Value^/10;
!#SN:W^Expert_Level_Global_Value^/20;
!#SN:W^Master_Level_Global_Value^/35;
!#SN:W^Grandmaster_Level_Global_Value^/58; [Set Global Values for Class Here eg to reach Grandmaster or Master]

!#VRi^acm_optionChooseClass^:S0;        [Option allows to delay class selection and choose desired class when enough points are accumulated]
                               ; If it's off, class selection occurs automaticlly based on highest points.

!#VRi^acm_optionNoSkillDependenciesOnClass^:S0; [Option allow to disable restriction, according to which you need master/grandmaster level class]
                                              ; in order to upgrade fixed set of skills to master/grandmaster.
!#VRi^acm_ACM_Core^:S1;                 [A option with no functionallity, it is just to illustrate differences between the different game modes]
!#VRi^wog_newCombiArtEnabled^:S(FALSE); [future compatibility flag for new artifact sets by Archer]

****************************************************************************************************
Disable Various WoG Options which can conflict with Advanced Classes Mod

!#UN:P204/0;                            [Disable First Aid I    Reason: Included in ACM on First Aid skill]
!#UN:P190/0;                            [Disable First Aid II   Reason: Included and free spells break compatibility with multicast]
!#UN:P210/0;                            [Disable Resistance II  Reason: Included in ACM on Resistance skill]

!#UN:P54/0;  !#VRv591:S0;               [Disabled Enhanced War Machines 1]
!#UN:P55/0;  !#VRv7180:S0;              [Disabled Enhanced War Machines 2]
!#UN:P73/0;  !#VRv847:S0;               [Disabled Enhanced War Machines 3]
!#UN:P39/0;  !#VRv425:S0;    !#IF:V429/0; !#VRv436:S255; [Disabled Hero Specialization Boost]
*#UN:P23/0;                             [Disable Sorcery Script]
!#UN:P51/0;                             [Disable Enhanced Commanders]
!#VRv7185:S0;                           [Disable Enhanced Commanders]

!#UN:C7771781/1/195;                    [Disable Paladin Commander +50% Experience Bonus]
!#UN:C7785525/2/37008;                  [Disable Succubus Commander Charming]
!#UN:C7788148/4/195;                    [Disable Temple Guardian Commander Mana Regeneration]
!#UN:C7788157/4/195;                    [Disable Temple Guardian Commander Mana Regeneration]
!#UN:C7772712/2/37008;                  [Disable Brute Commander Gold Bonus]
!#UN:C7775876/1/195;                    [Disable Shaman Commander 150% Attack and Defense Bonus]
!#UN:C7786301/1/195;                    [Disable Astral Spirit Commander Pacifist ability]
!#UN:C7786959/1/195;                    [Disable Astral Spirit Commander Pacifist ability]


*A few Global changes
!#MA:A146/6;                            [Ballista Attack is 6 instead of 10]
!#MA:M146/4;                            [Ballista Dam Low 4]
!#MA:E146/6;                            [Ballista Dam High 6]
!#MA:P147/150;                          [First Aid Tent HP 150]
!#MA:C147/6/1000;                       [First Aid Tent Cost 1000]
!#MA:P148/150;                          [Ammo Cart HP 150]
!#MA:C148/6/1000;                       [Ammo Cart Cost 1000]

!#UN:A146/2/4;                          [set axe of smashing - right hand]
!#UN:A147/2/6;                          [set mithril mail - torso]
!#UN:A148/2/4;                          [set sword of sharpness - right hand]
!#UN:A149/2/1;                          [set helm of immortality - head]
!#UN:A150/2/3;                          [set pendant of sorcery - neck]
!#UN:A151/2/8;                          [set boots of haste - feet]
!#UN:A152/2/2;                          [set bow of seeking - shoulder]
!#UN:A153/2/7;                          [set dragon eye ring - ring]
!#UN:A154/2/5;                          [set hardened shield - left hand]
!#UN:A155/2/7;                          [set slava's ring of power - ring]

!#UN:C4498547/1/235;                    [removes effect from Badge of Courage to grant mind immunity]

Enable Artefact to appear on the map
!#UN:A141/0 A141/3/8;                   [Magic Wand]
!#UN:A142/0 A142/3/4;                   [Gold Tower Arrow]
!#UN:A143/0 A143/3/8;                   [Monster's Power]
!#UN:A160/0 A160/3/8;                   [Gate Key]


*Show splash screen at first mod start
!#UN:V?y1/?y2;                          [Check ERA version]
!#SN&y2<3912:T^AC_Misc.ATTENTION GRANDPA^/?z2/^version^/y2 Iz2/?z2; [Interpolate String]
!#IF&y2<3912:M^%Z2^;                    [Updated to version 3.911 with advanced MP support erm syntax]

!#VRz-2:S^ACM Update 1.07^;             [User-defined section of WoG.ini file ("ACM Update 1.0X")]
!#UN:N6/-1/1/-2;                        [Check if ACM Update 1.0X Message has already been displayed]
!#VRz-1:H2;                             [Set Flag 2 to True if z-1 isn't empty: Flag 2]
!#SN:T^AC_Misc.First_Time^/?s^Text^;
!#IF&-2:Q1/21/134/1^%S(Text)^;
!#VRz-1&-2:S^message shown^;            ["message shown"]
!#UN&-2:N5/-1/1/-2;                     [Write data to WoG.ini to show that Ctrl Message has already been displayed]

!#VRz-1:S^^;                            [empty var]
!#VRz-2:S^ACM Update 1.09^;             [User-defined section of WoG.ini file ("ACM Update 1.0X")]
!#UN:N6/-1/1/-2;                        [Check if ACM Update 1.0X Message has already been displayed]
!#VRz-1:H2;                             [Set Flag 2 to True if z-1 isn't empty: Flag 2]
!#SN:T^AC_Misc.First_Time2^/?s^Text^;
!#IF&-2:Q1/21/134/1^%S(Text)^;
!#VRz-1&-2:S^message shown2^;           ["message shown"]
!#UN&-2:N5/-1/1/-2;                     [Write data to WoG.ini to show that Ctrl Message has already been displayed]


; ==================================================================================================

!#DC(ACM_SKILL_MASTER)      = 4;
!#DC(ACM_SKILL_GRANDMASTER) = 5;

!#DC(ACM_NUM_MAIN_CLASSES) = 3;
!#DC(ACM_NO_CLASS)         = 0;
!#DC(ACM_FIRST_CLASS)      = 1;

!#DC(ACM_CLASS_WARRIOR)    = 1;
!#DC(ACM_CLASS_MAGE)       = 2;
!#DC(ACM_CLASS_ADVENTURER) = 4;
!#DC(ACM_CLASS_HUNTER)     = 5;
!#DC(ACM_CLASS_BATTLEMAGE) = 3;
!#DC(ACM_CLASS_DRUID)      = 6;

!#DC(ACM_WARRIOR_CLASS_IND)    = 0;
!#DC(ACM_MAGE_CLASS_IND)       = 1;
!#DC(ACM_ADVENTURER_CLASS_IND) = 2;

!#DC(ACM_NO_CLASS_LEVEL)          = 0;
!#DC(ACM_CLASS_LEVEL_NORMAL)      = 1;
!#DC(ACM_CLASS_LEVEL_ADEPT)       = 2;
!#DC(ACM_CLASS_LEVEL_EXPERT)      = 3;
!#DC(ACM_CLASS_LEVEL_MASTER)      = 4;
!#DC(ACM_CLASS_LEVEL_GRANDMASTER) = 5;

!#DC(ACM_BACKUPED_SKILL_WAS_DECREASED_FLAG) = (BIT_31);
!#DC(ACM_WM_DLG_ID) = 50;

!#DC(ACM_CMD_CLASS_FIGHTER) = 1;
!#DC(ACM_CMD_CLASS_RANGER) = 2;
!#DC(ACM_CMD_CLASS_DEFENDER) = 3;
!#DC(ACM_CMD_CLASS_CASTER) = 4;
!#DC(ACM_CMD_CLASS_SUPPORTER) = 5;
!#DC(ACM_CMD_CLASS_LEADER) = 6;
!#DC(ACM_CMD_CLASS_SCOUT) = 7;
!#DC(ACM_CMD_CLASS_UNDEAD) = 8;
!#DC(ACM_CMD_CLASS_FIREMAGE) = 9;
!#DC(ACM_CMD_CLASS_DRAGONSLAYER) = 11;
!#DC(ACM_CMD_CLASS_SNIPER) = 12;
!#DC(ACM_CMD_CLASS_RETALIATOR) = 13;
!#DC(ACM_CMD_CLASS_ARCHMAGE) = 14;
!#DC(ACM_CMD_CLASS_CONSTRUCTOR) = 15;
!#DC(ACM_CMD_CLASS_KING) = 16;
!#DC(ACM_CMD_CLASS_PROSPECTOR) = 17;
!#DC(ACM_CMD_CLASS_LICH) = 18;
!#DC(ACM_CMD_CLASS_VAMPIRE) = 19;
!#DC(ACM_CMD_CLASS_PALADIN) = 21;
!#DC(ACM_CMD_CLASS_MARKSMAN) = 22;
!#DC(ACM_CMD_CLASS_AVENGER) = 23;
!#DC(ACM_CMD_CLASS_WARDEN) = 24;
!#DC(ACM_CMD_CLASS_ARCANIST) = 25;
!#DC(ACM_CMD_CLASS_GENERAL) = 26;
!#DC(ACM_CMD_CLASS_LANCER) = 27;
!#DC(ACM_CMD_CLASS_NECROMANT) = 28;
!#DC(ACM_CMD_CLASS_ANCIENT) = 29;

!#FU(NewIntArray):P(NUM_SECONDARY_SKILLS)/0/?i^acm_SecSkillsBackup^/(M_STORED);


// Compatibility with Era Scripts Mod
; by Archer30

; Third Class
; This script must be executed earlier than option 733 - third class.erm
!?FU(ES_733_GetSkillLevelString)&x3>=(SKILL_EXPERT);
!#VA(hero:x) (skill:x) (level:x) (result:x);

; Exit if the hero is not learning a M/GM skill
!!SN:Mi^acm_SecSkillsBackup^/(skill)/?(prevSkillLevel:y);
!!VR(prevSkillLevel):Sd~(ACM_BACKUPED_SKILL_WAS_DECREASED_FLAG);
!!FU&(prevSkillLevel)<(SKILL_EXPERT):E;

!!SN:Mi^acm_SkillNames_ArrayId^/(skill)/?(skillName:z);

!!if&i^H3_%(skillName)_0_Hero%(hero)^;
  !!SN:T^AC_Misc.Grandmaster^/?(skillLevelStr:z);
!!el;
  !!SN:T^AC_Misc.Master^/?(skillLevelStr);
!!en;

!!VR(result):Z(skillLevelStr);

!!SN:Q;

!?FU(ES_733_GetSkillIconIndex)&x3>=(SKILL_EXPERT);
!#VA(hero:x) (skill:x) (level:x) (result:x);

; Exit if the hero is not learning a M/GM skill
!!SN:Mi^acm_SecSkillsBackup^/(skill)/?(prevSkillLevel:y);
!!VR(prevSkillLevel):Sd~(ACM_BACKUPED_SKILL_WAS_DECREASED_FLAG);
!!FU&(prevSkillLevel)<(SKILL_EXPERT):E;

!!VR(isGrandmaster:y):S(FALSE);
!!VR(isGrandmaster)&(prevSkillLevel)>=4:S(TRUE);

!!FU(ACM_Calc_Correct_Def_Cadre):P(skill)/(SKILL_EXPERT)/(TRUE)/(isGrandmaster)/?(result)/1;

!!SN:Q;

; Set up Adventurer class in Third Class option (this affects the skill preferences in the level up dialogue)
!?FU(OnAfterErmInstructions);
!!UN:P733/?(wogOption:y);
!!FU&(wogOption)<>(TRUE):E;

!!re i/(HERO_FIRST)/(HERO_LAST_WOG);
  !!FU(Valid_Adventurer_Hero):Pi/?(result:y);
  !!SN&(result):W^es_733_hс.%i^/1;
!!en;

// Set up critical artifact variables
; by Archer30
; Ideally this must be placed in stdlib.erm
!?FU(OnAfterBattleSetup);
!!FU(acm_ResetArtifactVars):P;

!!re i/(BATTLE_LEFT)/i^battle_hero_vs_hero^;
  !!VR(hero:y):Si^battle_hero_%i^;

  !!HE(hero):A2/(ART_RECANTERS_CLOAK)/?(has:y)/?(equipped:y);
  !!VRi^acm_%(ART_RECANTERS_CLOAK)_equipped^&(equipped):S(TRUE);

  !!HE(hero):A2/(ART_SPHERE_OF_PERMANENCE)/?(has)/?(equipped);
  !!VRi^acm_%(ART_SPHERE_OF_PERMANENCE)_equipped^&(equipped):S(TRUE);

  !!HE(hero):A2/(ART_ORB_OF_VULNERABILITY)/?(has)/?(equipped);
  !!VRi^acm_%(ART_ORB_OF_VULNERABILITY)_equipped^&(equipped):S(TRUE);

  !!HE(hero):A2/(ART_ORB_OF_INHIBITION)/?(has)/?(equipped);
  !!VRi^acm_%(ART_ORB_OF_INHIBITION)_equipped^&(equipped):S(TRUE);
!!en;

!?FU(OnAfterBattleUniversal);
!!FU(acm_ResetArtifactVars):P;

!?FU(acm_ResetArtifactVars);
!!VRi^acm_%(ART_RECANTERS_CLOAK)_equipped^:S(FALSE);
!!VRi^acm_%(ART_SPHERE_OF_PERMANENCE)_equipped^:S(FALSE);
!!VRi^acm_%(ART_ORB_OF_VULNERABILITY)_equipped^:S(FALSE);
!!VRi^acm_%(ART_ORB_OF_INHIBITION)_equipped^:S(FALSE);

// Set up stack id and side before melee attack
; by Archer30
; Please don't use BG:N in MR/MF triggers! In mose cases you won't get the correct result (with retaliation). 
; Use i^acm_attackStack^ and i^acm_meleeSide^ instead
!?FU(ACM_OnBeforeMelee);
!#VA(atkStack:x) (defStack:x);

!!VRi^acm_attackStack^:S(atkStack);
!!FU(ACM_GetActualStackSide):P(atkStack)/?i^acm_meleeSide^;

// Custom Fire Shield
; by Archer30
; This function is called by external scripts to alter the Fire Shield damage in ACM
; It should be executed as early as possible
!?FU(ACM_GetCustomFireShieldMultiplier);
!#VA(mon:x) (result:x);

!!VR(result):S1;

// Update stack damaged animation
; Use when the stack animation stuck at somewhere
; SN:D sometimes crashes the game, especailly in some bad timing
; This is usually used after BM:K to show the damaging animation of stacks
!?FU(ACM_DrawActionPlay);
!!UN:C(COMBAT_MANAGER)/(UNC_INT)/?(cmbMgr:y);
!!SN:E4621680/2/(cmbMgr)/-1/1;

// Execute Phoenix Resurrection
; Usually is used after BM:K
!?FU(ACM_ExecutePhoenixResurrection);
!!UN:C(COMBAT_MANAGER)/(UNC_INT)/?(cmbMgr:y);
!!SN:E4624416/(CALLCONV_THISCALL)/(cmbMgr); 469020

// Other functions
!?FU(acm_CountNumUniqueSkillsLearned);
!#VA(hero:x);
!#VA(result:x);

!!VR(result):S0;

!!re i/0/(SEC_SKILL_LAST);
  !!HE(hero):Si/?(skillLevel:y);
  !!VR(result)&(skillLevel)>(SKILL_NOT_LEARNED):+1;
!!en;

!?FU(acm_GetSkillDependenciesOnClass);
; Originally mod allows to master/grandmaster skills, depending on class and class level (master/grandmaster).
; Return ID of array with NUM_SECONDARY_SKILLS items, each contains allowed classes mask.
!#VA(result:x);

!!VR(result):Si^acm_skillDependenciesOnClass^;

!!if&(result)=(NULL);
  !!FU(NewIntArray):P(NUM_SECONDARY_SKILLS)/(ACM_NO_CLASS)/?(result)/(M_STORED);

  !!if&i^acm_optionNoSkillDependenciesOnClass^=(FALSE);
    !!SN:V(result)/(SKILL_PATHFINDING)/(ACM_CLASS_ADVENTURER);
    !!SN:V(result)/(SKILL_ARCHERY)/(ACM_CLASS_WARRIOR);
    !!SN:V(result)/(SKILL_LOGISTICS)/(ACM_CLASS_ADVENTURER);
    !!SN:V(result)/(SKILL_SCOUTING)/(ACM_CLASS_ADVENTURER);
    !!SN:V(result)/(SKILL_DIPLOMACY)/(ACM_CLASS_ADVENTURER);
    !!SN:V(result)/(SKILL_NAVIGATION)/(ACM_CLASS_ADVENTURER);
    !!SN:V(result)/(SKILL_LEADERSHIP)/(ACM_CLASS_WARRIOR);
    !!SN:V(result)/(SKILL_WISDOM)/(ACM_CLASS_MAGE);
    !!SN:V(result)/(SKILL_MYSTICISM)/(ACM_CLASS_MAGE);
    !!SN:V(result)/(SKILL_LUCK)/(ACM_CLASS_WARRIOR);
    !!SN:V(result)/(SKILL_BALLISTICS)/(ACM_CLASS_WARRIOR);
    !!SN:V(result)/(SKILL_EAGLE_EYE)/(ACM_CLASS_ADVENTURER);
    !!SN:V(result)/(SKILL_NECROMANCY)/(ACM_NO_CLASS);
    !!SN:V(result)/(SKILL_ESTATES)/(ACM_CLASS_ADVENTURER);
    !!SN:V(result)/(SKILL_FIRE_MAGIC)/(ACM_CLASS_MAGE);
    !!SN:V(result)/(SKILL_AIR_MAGIC)/(ACM_CLASS_MAGE);
    !!SN:V(result)/(SKILL_WATER_MAGIC)/(ACM_CLASS_MAGE);
    !!SN:V(result)/(SKILL_EARTH_MAGIC)/(ACM_CLASS_MAGE);
    !!SN:V(result)/(SKILL_SCHOLAR)/(ACM_CLASS_MAGE);
    !!SN:V(result)/(SKILL_TACTICS)/(ACM_CLASS_WARRIOR);
    !!SN:V(result)/(SKILL_ARTILLERY)/(ACM_CLASS_WARRIOR);
    !!SN:V(result)/(SKILL_LEARNING)/(ACM_CLASS_ADVENTURER);
    !!SN:V(result)/(SKILL_OFFENCE)/(ACM_CLASS_WARRIOR);
    !!SN:V(result)/(SKILL_ARMORER)/(ACM_CLASS_WARRIOR);
    !!SN:V(result)/(SKILL_INTELLIGENCE)/(ACM_CLASS_MAGE);
    !!SN:V(result)/(SKILL_SORCERY)/(ACM_CLASS_MAGE);
    !!SN:V(result)/(SKILL_RESISTANCE)/(ACM_CLASS_WARRIOR);
    !!SN:V(result)/(SKILL_FIRST_AID)/(ACM_CLASS_ADVENTURER);
  !!en; if
!!en; acm_GetSkillDependenciesOnClass

!?FU(acm_GetSecSkillLevel);
!#VA(hero:x);
!#VA(skill:x);
!#VA(result:x); Result is in (SKILL_NOT_LEARNED) .. (ACM_SKILL_GRANDMASTER) range

!!HE(hero):S(skill)/?(result);

!!if&(result)>=(SKILL_EXPERT);
  !!FU(H3_Mod_Check_Skill_Level):P(hero)/?(isMaster:y)/?(isGrandmaster:y)/(skill);
  !!VR(result)&(isMaster)<>(FALSE):S(ACM_SKILL_MASTER);
  !!VR(result)&(isGrandmaster)<>(FALSE):S(ACM_SKILL_GRANDMASTER);
!!en;

!?FU(acm_SetSecSkillLevel);
!#VA(hero:x);
!#VA(skill:x);
!#VA(level:x); Level must be in (SKILL_NOT_LEARNED) .. (ACM_SKILL_GRANDMASTER) range

!!VR(level):F(SKILL_NOT_LEARNED)/(ACM_SKILL_GRANDMASTER);
!!VR(nativeLevel:y):S(level) F(SKILL_NOT_LEARNED)/(SKILL_EXPERT);
!!HE(hero):S(skill)/(nativeLevel);

!!if&(level)<(ACM_SKILL_MASTER);
  !!FU(H3_Mod_Set_Skill_ExtraLevel):P(hero)/(FALSE)/(FALSE)/(skill);
!!el&(level)=(ACM_SKILL_MASTER);
  !!FU(H3_Mod_Set_Skill_ExtraLevel):P(hero)/(TRUE)/(FALSE)/(skill);
!!el&(level)=(ACM_SKILL_GRANDMASTER);
  !!FU(H3_Mod_Set_Skill_ExtraLevel):P(hero)/(TRUE)/(TRUE)/(skill);
!!en;

!?FU(acm_GetHeroClass);
!#VA(hero:x);       hero ID
!#VA(class:x);      OUT. One of ACM_CLASS_XXX constants or ACM_NO_CLASS
!#VA(classLevel:x); OUT. One of ACM_CLASS_LEVEL_XXX constants or ACM_NO_CLASS_LEVEL. Levels till Master are ignored and not used in the mod.

!!VR(class):S(ACM_NO_CLASS);
!!VR(classLevel):S(ACM_NO_CLASS_LEVEL);

!!VR(isWarrior:y):Si^Master_Warrior_Hero%(hero)^;
!!VR(isMage:y):Si^Master_Mage_Hero%(hero)^;
!!VR(isAdventurer:y):Si^Master_Adventurer_Hero%(hero)^;

!!VR(class)&(isWarrior)=(TRUE):S(ACM_CLASS_WARRIOR);
!!VR(class)&(isMage)=(TRUE):S(ACM_CLASS_MAGE);
!!VR(class)&(isAdventurer)=(TRUE):S(ACM_CLASS_ADVENTURER);
!!VR(class)&(isWarrior)=(TRUE)/(isMage)=(TRUE):S(ACM_CLASS_BATTLEMAGE);
!!VR(class)&(isWarrior)=(TRUE)/(isAdventurer)=(TRUE):S(ACM_CLASS_HUNTER);
!!VR(class)&(isMage)=(TRUE)/(isAdventurer)=(TRUE):S(ACM_CLASS_DRUID);

!!if&(class)<>(ACM_NO_CLASS);
  !!VR(classLevel):S(ACM_CLASS_LEVEL_MASTER);
  !!VR(classLevel)|i^Grandmaster_Warrior_Hero%(hero)^=(TRUE)/i^Grandmaster_Mage_Hero%(hero)^=(TRUE)/i^Grandmaster_Adventurer_Hero%(hero)^=(TRUE):S(ACM_CLASS_LEVEL_GRANDMASTER);
!!en;

!?FU(acm_BackupAndPrepareSecSkillsForLevelUp);
; Saves all hero native skill levels in global var. Reduces expert skills to advanced for skills, which hero is able to promote.
; Thus H3 engine will be used to determine, which skill to display in level-up dialog.
!#VA(hero:x);

!!VR(noSkillLevelRestriction:y):Si^acm_optionNoSkillDependenciesOnClass^;
!!FU(acm_GetHeroClass):P(hero)/?(heroClass:y)/?(heroClassLevel:y);
!!FU(acm_GetSkillDependenciesOnClass):P?(skillDeps:y);

; For all skills
!!re i/(SEC_SKILL_FIRST)/(SEC_SKILL_LAST);
  ; Get skill level and save
  !!FU(acm_GetSecSkillLevel):P(hero)/i/?(skillLevel:y);

  ; If skill can be upgraded to master/grandmaster
  !!if&(skillLevel)>=(SKILL_EXPERT)/(skillLevel)<(ACM_SKILL_GRANDMASTER);
    !!SN:V(skillDeps)/i/?(requiredClass:y);
    !!VRt:S(heroClass) &(requiredClass);

    !!if|t<>(ACM_NO_CLASS)/(requiredClass)=(ACM_NO_CLASS);
      !!if|(skillLevel)<(heroClassLevel)/(noSkillLevelRestriction)=(TRUE);
        !!HE(hero):Si/(SKILL_ADVANCED);
        !!VR(skillLevel):|(ACM_BACKUPED_SKILL_WAS_DECREASED_FLAG);
      !!en;
    !!en;
  !!en; if

  !!SN:Vi^acm_SecSkillsBackup^/i/(skillLevel);
!!en; re

!?FU(acm_RestoreSecSkillsAndApplyDetectedUpgrades);
; Restores original expert skills from advanced level to expert after level up. Detects which skills were promoted to master/grandmaster level.
!#VA(hero:x);

!!FU(acm_GetHeroClass):P(hero)/?(heroClass:y)/?(heroClassLevel:y);
!!FU(acm_GetSkillDependenciesOnClass):P?(skillDeps:y);

!!re i/(SEC_SKILL_FIRST)/(SEC_SKILL_LAST);
  !!FU(acm_GetSecSkillLevel):P(hero)/i/?(skillLevel:y);
  !!SN:Vi^acm_SecSkillsBackup^/i/?(prevSkillLevel:y);

  !!VR(skillLevelWasDecreased:y):S(prevSkillLevel) &(ACM_BACKUPED_SKILL_WAS_DECREASED_FLAG) B;
  !!VR(prevSkillLevel):Sd~(ACM_BACKUPED_SKILL_WAS_DECREASED_FLAG);

  !!if&(skillLevelWasDecreased)=(TRUE);
    !!VR(newSkillLevel:y):S(prevSkillLevel);
    !!VR(newSkillLevel)&(skillLevel)>=(prevSkillLevel):S(prevSkillLevel) +1;
    !!FU(acm_SetSecSkillLevel):P(hero)/i/(newSkillLevel);
  !!en;
!!en;

; ==================================================================================================

!?FU(ACM_LoadOptionsFromIni);
!!VR(filePath:z):S^Runtime/advanced classes.ini^;

; Advanced Classes Mod
!!FU(ReadIniInts):P(filePath)/^advanced classes^/
  ^Spell_Trainer_Mod^/?i^Spell_Trainer_Mod^/0/
  ^Easier_Class_option^/?i^Easier_Class_option^/0/
  ^Classic_Skin_Mod^/?i^Classic_Skin_Mod^/0/
  ^Alternative_Necromancy_Mod^/?i^Alternative_Necromancy_Mod^/0;

!!FU(ReadIniInts):P(filePath)/^advanced classes^/
  ^acm_ACM_Core^/?i^acm_ACM_Core^/0/
  ^Tactics_enabled^/?i^Tactics_enabled^/0/
  ^acm_Weak_Commanders^/?i^acm_Weak_Commanders^/0/
  ^Spell_Duration_Mod^/?i^Spell_Duration_Mod^/0;

!!FU(ReadIniInts):P(filePath)/^advanced classes^/
  ^acm_Classic_Diplomacy^/?i^acm_Classic_Diplomacy^/0/  
  ^acm_optionChooseClass^/?i^acm_optionChooseClass^/0/
  ^acm_optionNoSkillDependenciesOnClass^/?i^acm_optionNoSkillDependenciesOnClass^/0/
  ^Tower_Cancel^/?i^Tower_Cancel^/0;  


!?FU(ACM_SaveOptionsToIni);
!!VR(filePath:z):S^Runtime/advanced classes.ini^;

; Advanced Classes Mod
!!FU(WriteIniInts):P(filePath)/^advanced classes^/
  ^Spell_Trainer_Mod^/i^Spell_Trainer_Mod^/
  ^Easier_Class_option^/i^Easier_Class_option^/
  ^Classic_Skin_Mod^/i^Classic_Skin_Mod^/
  ^Alternative_Necromancy_Mod^/i^Alternative_Necromancy_Mod^;

!!FU(WriteIniInts):P(filePath)/^advanced classes^/
  ^acm_ACM_Core^/i^acm_ACM_Core^/
  ^Tactics_enabled^/i^Tactics_enabled^/
  ^acm_Weak_Commanders^/i^acm_Weak_Commanders^/
  ^Spell_Duration_Mod^/i^Spell_Duration_Mod^;

!!FU(WriteIniInts):P(filePath)/^advanced classes^/
  ^acm_Classic_Diplomacy^/i^acm_Classic_Diplomacy^/
  ^acm_optionChooseClass^/i^acm_optionChooseClass^/
  ^acm_optionNoSkillDependenciesOnClass^/i^acm_optionNoSkillDependenciesOnClass^/
  ^Tower_Cancel^/i^Tower_Cancel^;    

!!FU(SaveIni):P(filePath);


*** Post-Instruction trigger ***
!?PI;
!!FU(ACM_Game_start_Options):P;         [Show additional options at game start. Will be replaced by Dialogue]
!!DO(AC_Function_73)/0/69/1:P;          [Save Spell Points Costs at Map Start]
!!DO(AC_Function_129)/0/155/1:P;        [Reset Magic Arrow damage increase for all Heroes when Map Starts]

; Check if 10 ss mode is enabled depending on the actual skills limit in the game
; Here we must use FU(OnGameEnter_Quit) to ensure it executes later than ES - 28 secondary skills
!?FU(OnGameEnter_Quit);
!!FU(ACM_Manage10SkillsMode):P;

********************************************************************************
; Set up Necromancy hooks
!?FU(ACM_CreateERMHook);
!#VA(setHook:x);

!!if&i^Alternative_Necromancy_Mod^;
  !!SN:E(setHook)/1/5127891/(ACM_OnDetermineNecromancyMon);
  !!SN:E(setHook)/1/5128011/(Necro_ChangePower_2); [Get the hero Id for Custom Necromancy] 4E3F4B
!!en;

!!SN:E(setHook)/1/5128029/(Necro_ChangePower_1); [Change the power Necromancy when the hero learns M/GM Neromany by daemon_n]
!!SN:E(setHook)/1/5128574/(Necro_ChangePower_3); [Divide Necromancy power by 2]

!!SN:E(setHook)/1/5081528/(ACM_Hook_HeroReset); [for hero variables]

!?FU(ACM_Hook_HeroReset);
!#VA(hook:x);

!!UN:C(hook)/(STRUCT_HOOK_CONTEXT_EDX)/4/?(heroId:y);
!!FU(ACM_OnResetHero):P(heroId);

!?FU(OnGameEnter);                      [At game start 2]
; Change the Necromancy rate of Soul Prism to 0.4 (as it would be divided by 2 later)
!!UN:C5128477/2/1/176; - replace address of the variable which contains 0.2 with variable that's equal to 0.4

!!FU(Set_SS_Skill_Name_and_Text):P;     [Set Secondary Skill Descriptions and Names]

!!UN:C6548196/4/1022739087;             [SecSkills specPower 3% thanks to Igrik for providing code]
*!UN:C6548196/4/1017370378;             [SecSkills specPower 2% thanks to Archer for providing code] Test

!!UN:C7771781/1/195;                    [Disable Paladin +50% Experience Bonus]
!!UN:C7785525/2/37008;                  [Disable Succubus Charming]
!!UN:C7788148/4/195;                    [Disable Temple Guardian Mana Reg] bug free???]
!!UN:C7788157/4/195;                    [Disable Temple Guardian Mana Reg]
!!UN:C7772712/2/37008;                  [Disable Brute Gold Bonus]
!!UN:C7775876/1/195;                    [Disable Shaman - Attack and Defense Bonus (commander's window)]
!!UN:C7786301/1/195;                    [Disable 8: Astral Spirit_0 - Pacifist]
!!UN:C7786959/1/195;                    [Disable 8: Astral Spirit_1 - Pacifist remove ability by setting from 8 to 195]

!!UN:C4498547/1/235;                    [removes effect from Badge of Courage to grant mind immunity] 
; Magic Wand (id 141) thanks to Igrik :)
!!UN:C7661053/4/999;                    [disable effects of magic wand by changeing ID from 141 to 999]
; Gate Key (id 160)
*!UN:C7381428/4/999 C7381572/4/999 C7381619/4/999;
; Monster's Power (id 143)
!!UN:C7736062/4/999;
; Gold Tower Arrow (id 142)
!!UN:C7718799/4/999 C7718828/4/999 C7734120/4/999;
; disabling Wizard's well art check (id from 143 to 2 - grail)
!!UN:C5013326/4/2;

!!UN:C4605318/1/6;                      [change Moral and set to max six]
!!UN:C4605344/1/6;
!!UN:C4605354/1/33;                     [Moral divisor set to 33  means 3% per point of Moral]
!!UN:C4605324/1/-10;
!!UN:C4605331/1/-10;
!!UN:C4605854/1/10;

!!UN:C5129872/1/233 C5129873/4/340;     [Disable the standart Eagel Eye reaction]

!!UN:C7779070/1/144;                    [Fix commander cast from Hawaiing, so that the correct amount of casts are displayed for commander in combat]
!!UN:C7779071/2/37008;                  [Fix commander cast from Hawaiing]

thanks to Archer :)
!!UN:C5137159/2/51505;                  [Make Damage Spell Specialist always do 3% more damage per level] 4E6307
!!UN:C5137161/1/65;                     [Code provided by Berserker]
!!UN:C5137162/2/63385;                  [This is to restore the original code in case it's been patched by Majaczek in Amethyst for weird reasons]
; Archer30: In the future if there is a division by 0 issue around this address, let me know

!!UN:C7789298/1/75;                     [set the defense reduce ability from commander to 25% instead of 50% thanks to Archer]

thanks to Daemon :)
!!VRe1:S5:4;                            [create 1,25 multiplier]
!!UN:C6548272/4/e1;                     [Set the damage from the Artifacts Orbs to +25% instead of +50%]

!!SN:W^Magic_Arrow_dmg_increment^/2;    [sets the percent in damage increase for Magic Arrow M/GM perk per kill]

It simply skips the condition of "don't check resistance when it's a monster spell"
this should make creature casts respecting dwarv type golem resistance
!!UN:C5899743/(UNC_INT16)/(OPCODE_NOP_2);[5A05DF by Archer]

; Building - Necromancy Amplifier
!!UN:C6977844/4/?(ptr:y);
!!SN:B(ptr)/d/?(desc:z);
!!FU(ACM_SetDividedNecromancyDesc):P(desc)/10/?(newDesc:z);
!!SN&(newDesc)<>^^:B(ptr)/d/(newDesc);

; Author:   SadnessPower (robertomaest1@gmail.com)
; Updated by Archer30
; Engine:   ERM 2.0+;
; Buff the Landmine spell by doing these changes:
; - Now the spell can be cast if there are native terrain creatures on enemy stack
; - Native terrain creatures will see landmine as normal but will take damage from mines
!!UN:C5894160/1/235;                    [0059F010 - Skip terrain check on spell cast]
!!UN:C5897919/1/235;                    [0059FEBF - Skip monster native terrain check while moving]

; Disable Spell book description from Spell Description Mod, as those descriptions are already included in ACM
; by Archer30
!!UN:C5881790/4/4127999627;
!!UN:C5881794/4/2215576260;
!!UN:C5881798/4/186;

!!UN:C5881831/4/1781552779;
!!UN:C5881835/1/0;


// Function to divide a number before % by 2
; by Archer30
; Here we assume all the percentage is belowe 100% (max at 2 characters for the number)
; We also assume that there is the first % we found is next to the number we needed
!?FU(ACM_SetDividedNecromancyDesc);
!#VA(descPtr:x) (number:x) (newDescPtr:x);

!!VR(newDescPtr):Z^^;
!!VR(numberStr:z):S^%(number)^;
!!SN:K(numberStr)/?(numberSize:y);
!!SN:Kz(descPtr)/?(size:y);

!!re i/0/(size)/1/-1;
  !!SN:Kz(descPtr)/i/?(character:z);

  !!if&(character)=^%^;
    !!VR(numbersInSentence[2]:y):C0/0;
    !!VR(index:y):Si -1;

    !!SN:Kz(descPtr)/(index)/?(character);
    !!FU(ACM_CheckIfCharacterIsNumber):P(character)/?(result:y);
    !!if&(result);
      !!VR(numbersInSentence[1]):V(character);

      !!if&(numberSize)>1;
        !!VR(index): -1;
        !!SN:Kz(descPtr)/(index)/?(character);
        !!FU(ACM_CheckIfCharacterIsNumber):P(character)/?(result:y);
        !!VR(numbersInSentence[0])&(result):V(character);
      !!en;

      ; Two character number
      !!if&(numberSize)>1/(result);
        !!VR(numbersInSentenceStr:z):S^%(numbersInSentence[0])%(numbersInSentence[1])^;
      ; One character number
      !!el;
        !!VR(numbersInSentenceStr):S^%(numbersInSentence[1])^;
      !!en;
      !!VR(numbersInSentenceFinal:y):V(numbersInSentenceStr);      
      ; If the number before % is the same with the number provided, divide it by 2
      !!if&(number)=(numbersInSentenceFinal);
        !!VR(numberFloat:e):S(number);
        !!VR(numberFloat)::2;
        !!VR(numberStr):S^%(numberFloat)^;
        !!FU(ACM_OptimiseFloatNumberString):P(numberStr)/?(numberStr);
        *!VR(index:y):-1;
        !!FU(Substr):Pz(descPtr)/0/(index)/?(str1:z);
        !!VR(lastInd:y):S(size) -1;
        !!FU(Substr):Pz(descPtr)/i/(lastInd)/?(str2:z);

        !!VR(newDesc:z):S^%(str1)%(numberStr)%(str2)^;
        !!VR(newDescPtr):Z(newDesc);
      ; Exit if the number before % is differnt from the number provided (this means Necromancy has already been customised)
      !!el;
        !!FU:E;
      !!en;
    ; Exit the function if the character before % is not even a number (something's seriously wrong)
    !!el;
      !!FU:E;
    !!en;

    !!br;
  !!en;
!!en;


!?FU(ACM_CheckIfCharacterIsNumber);
!#VA(charPtr:x) (result:x);

!!VR(result):S(FALSE);
!!re i/0/9;
  !!br&z(charPtr)=^%i^;
!!en;
!!VR(result)&i<=9:S(TRUE);


!?FU(ACM_OptimiseFloatNumberString);
!#VA(strPtr:x) (result:x);

!!VR(result):Z^^;
!!SN:Kz(strPtr)/?(size:y);
!!VR(pointPos:y):S0;
!!re i/0/(size)/1/-1;
  !!SN:Kz(strPtr)/i/?(character:z);
  !!VR(pointPos)&(character)=^.^:Si;
  ; If 0 is found, check if it is the first character after decimal point
  !!if&(pointPos)>0/(character)=^0^;
    !!VR(difference:y):Si -(pointPos);
    !!VRi&(difference)=1:-1;
    !!br;
  !!en;
!!en;

!!if&i<(size);
  !!FU(Substr):Pz(strPtr)/0/i/?(newStr:z);
  !!VR(result):Z(newStr);
!!en;


// Necromancy features
; by Archer30
*Set Necromancy value according to Expert/Master/Grandmaster skill level
!?FU(Necro_ChangePower_1);
; Note that with this hook, part of the lines are eaten so we need to manually put them back
!#VA(hook:x);

!!UN:C(hook)/(STRUCT_HOOK_CONTEXT_EDX)/4/?(necroPower:e); [by default, this value is twice of the real Necromancy value]
!!UN:C(hook)/(STRUCT_HOOK_CONTEXT_EBP)/4/?(ebp:y);
!!UN:C(hook)/(STRUCT_HOOK_CONTEXT_EAX)/1/?(necroLvl:y);

!!if&(necroLvl)=(SKILL_EXPERT);
  !!UN:C(hook)/(STRUCT_HOOK_CONTEXT_EDI)/4/?(hero:y) C(hero)/26/4/?(heroId:y);

  !!if&i^H3_Necromancy_0_Hero%(heroId)^;
    !!VR(var:e):S10 :100;               [5%]
    !!VR(necroPower): +(var);

    !!if&i^H3_Necromancy_1_Hero%(heroId)^;
      !!VR(var:e):S10 :100;             [5%]
      !!VR(necroPower): +(var);      
    !!en;

    !!UN:C(hook)/(STRUCT_HOOK_CONTEXT_EDX)/4/(necroPower); 
    !!UN:C(ebp)/-4/4/(necroPower);    
  !!en;
!!el&(necroLvl)<=(SKILL_NOT_LEARNED);
  !!UN:C(ebp)/-4/4/(necroPower);

  !!SN:X?t/0;
  !!UN:C(hook)/(STRUCT_HOOK_CONTEXT_RET)/(UNC_INT)/5128496; 4E4130
!!en;


*At battle end change the Necromancy value depending on certain options
; Note that Alternative Necromancy will overrides Cloak of the Undead King and restrain the rate of Necromancy, even if the raised creature is weaker than default
!?FU(Necro_ChangePower_2);
!#VA(hook:x);

!!VRi^acm_altNecro_customMon^:S0;
!!UN:C(hook)/(STRUCT_HOOK_CONTEXT_EDI)/4/?(heroStruct:y);
!!UN:C(heroStruct)/26/4/?(heroId:y);
!!FU|(heroId)<(HERO_FIRST)/(heroId)>(HERO_LAST_WOG); [For some reason, hero Id here may be wrong, which is really not likely]

; QoL: If the hero has Cloak of the Undead King but also choose an option that raises the same creature, the rate of necromancy won't be reduced
!!FU(ACM_GetDefaultNecromancyMon):P(heroId)/?(defaultMon:y);

!!if&i^H3_Necromancy_Choice_%(heroId)^<>(defaultMon);
  !!VR(necroMon:y):Si^H3_Necromancy_Choice_%(heroId)^ F(MON_SKELETON)/(INT_MAX);
  !!VRi^acm_altNecro_customMon^:S(necroMon);
!!en;

!?FU(Necro_ChangePower_3);
!#VA(hook:x);

; Get current power
!!UN:C(hook)/(STRUCT_HOOK_CONTEXT_EBP)/4/?(ebp:y);
!!UN:C(ebp)/-4/4/?(power:y);

; Get the latest power in float
!!SN:X?t X(power) X?(powerFloat:e) Xt;  [get fct parameters]
!!VR(powerFloat)::2;

; Fix the power if Necromancy is customised
!!if&i^acm_altNecro_customMon^>(MON_SKELETON); [if anything higher than skeletons was selected - Alternative Necromancy]
  !!VR(customMon:y):Si^acm_altNecro_customMon^;
  !!VRi^acm_altNecro_customMon^:S0;

  !!if&(customMon)=(MON_WALKING_DEAD);
    !!VR(ratio:e):S80;                  [The raito of Necromany becomes 80%. For example, normally GM Necromany has 25% in Necromancy, when raising Walking Dead, it becomes 20%]
    *!VR(maxPowerFloat:e):S100;         [The max Necromancy value: set to 100%. (does nothing as the internal limit IS 100%)]
  !!el&(customMon)=(MON_WIGHT);
    !!VR(ratio):S55;
    *!VR(maxPowerFloat):S70;            [set to 70%]
  !!el&(customMon)=(MON_VAMPIRE);
    !!VR(ratio):S30;
    *!VR(maxPowerFloat):S40;            [set to 40%]
  !!el&(customMon)=(MON_LICH);
    !!VR(ratio):S25;
    *!VR(maxPowerFloat):S30;            [set to 30%]
  !!el&(customMon)=(MON_BLACK_KNIGHT);
    !!VR(ratio):S15;
    *!VR(maxPowerFloat):S20;            [set to 20%]
  !!en;

  ; Set the new ratio
  !!VR(powerFloat):*(ratio) :100;
  ; Restrain the current power to the given value
  *!VR(powerFloat):*(ratio) F0/(maxPowerFloat) :100;
!!en;

; Convert to Int
!!SN:X?t X(powerFloat) X?(power) Xt;    [get fct parameters]
; Set
!!UN:C(ebp)/-4/4/(power);


*When clicked on hero name the player sees the prefered class of that hero, if he is mage, warrior or adventurer
!?CM2;

!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!if&v3=512/v5=14;
!!if|v4=1/v4=140;                       [140 Level and Class]
  !!HE-1:N?y1;                          [Get current Number]
  !!HEy1:B0/?z1 B2/?y2 N?y3 O?y14;      [class of hero  / hero number /owner]
* set class name for level text box
  !!SN&y2=0:T^AC_Misc.Class_Knight^/?z-7;
  !!SN&y2=1:T^AC_Misc.Class_Cleric^/?z-7;
  !!SN&y2=2:T^AC_Misc.Class_Ranger^/?z-7;
  !!SN&y2=3:T^AC_Misc.Class_Druid^/?z-7;
  !!SN&y2=4:T^AC_Misc.Class_Alchemist^/?z-7;
  !!SN&y2=5:T^AC_Misc.Class_Wizard^/?z-7;

  !!SN&y2=6:T^AC_Misc.Class_Demoniac^/?z-7;
  !!SN&y2=7:T^AC_Misc.Class_Heretic^/?z-7;
  !!SN&y2=8:T^AC_Misc.Class_Death Knight^/?z-7;
  !!SN&y2=9:T^AC_Misc.Class_Necromancer^/?z-7;
  !!SN&y2=10:T^AC_Misc.Class_Warlock^/?z-7;
  !!SN&y2=11:T^AC_Misc.Class_Overlord^/?z-7;

  !!SN&y2=12:T^AC_Misc.Class_Barbarian^/?z-7;
  !!SN&y2=13:T^AC_Misc.Class_Battle Mage^/?z-7;
  !!SN&y2=14:T^AC_Misc.Class_Beastmaster^/?z-7;
  !!SN&y2=15:T^AC_Misc.Class_Witch^/?z-7;
  !!SN&y2=16:T^AC_Misc.Class_Planeswalker^/?z-7;
  !!SN&y2=17:T^AC_Misc.Class_Elementalist^/?z-7;

  !!FU(Valid_Adventurer_Hero):Py1/?y4;  [Check if this hero is an adventuerer hero]
  !!VRy3:Sy2 %2;
  !!VRz3&y3=0:S^Warrior^;
  !!VRz3&y3=1:S^Mage^;
  !!VRz3&y4=1:S^Adventurer^;

  !!SN&y3=0:T^AC_Misc.Warrior^/?z3;
  !!SN&y3=1:T^AC_Misc.Mage^/?z3;
  !!SN&y4=1:T^AC_Misc.Adventurer^/?z3;
  !!SN:Iz3/?z3;

  !!SN&y3=0:T^AC_Misc.Main_Class_warrior^/?z4;
  !!SN&y3=1:T^AC_Misc.Main_Class_mage^/?z4;
  !!SN&y4=1:T^AC_Misc.Main_Class_adventurer^/?z4;
  !!SN:Iz4/?z4;

  !!IF:M1/4/^%Z4^;                      [Show text when clicked]
!!en;


!?FU(OnHeroScreenMouseClick)&i^mouse_item^=45/i^mouse_action^<>(MOUSE_LMB_RELEASED);
[Show Description in Hero Screen Trigger when left click on Hero Portrait]
!!if&i^mouse_action^=(MOUSE_RMB_PRESSED);
  !!FU(acm_Dlg_HeroClass_Prepare):P;
!!el&i^mouse_flags^=(NO_MOUSE_FLAGS);
  !!FU(acm_Dlg_ClassTable_Prepare):P;
!!en;

// Press hotkeys from hero screen for different features
; by Archer30
!?FU(OnKeyPressed_HeroScreen)|i^key^=(KEY_A)/i^key^=(KEY_W)/i^key^=(KEY_E)/i^key^=(KEY_R);
!#VA(key:x) (preventDefault:x);

; For R, exit if spell trainer isn't enabled
!!FU&i^key^=(KEY_R)/i^Spell_Trainer_Mod^<>(TRUE):E;

!!VR(preventDefault):S(TRUE);

!!if&i^key^=(KEY_W);
  !!FU(acm_Dlg_ClassTable_Prepare):P;
!!el&i^key^=(KEY_A);
  !!FU(acm_Dlg_HeroClass_Prepare):P;
!!el&i^key^=(KEY_E);
  !!FU(ACM_OpenBonusTable):P;
!!el&i^key^=(KEY_R);
  !!FU(ACM_OpenSpellTrainerTable):P;
!!en;

********************************************************************************
!?FU(acm_Dlg_ClassTable_Prepare);[When clicked on Hero Portrait]
  !!SN:W^Adept_Level_Global_Value^/?y90;
  !!SN:W^Expert_Level_Global_Value^/?y91;
  !!SN:W^Master_Level_Global_Value^/?y92;
  !!SN:W^Grandmaster_Level_Global_Value^/?y93;

  !!HE-1:N?y1; [CW fix to keep hero number for later processing; otherwise value is overwritten by (itemId) used later]
  !!HE-1:N?(hero:y);
  ;[CW: changed call to get more information -- START]
  !!FU(Calc_Class_Points_Original):Py1/0/?y10/?y20/?y30/?y40/?y41/?y42/?y43/?y44/?y45/?y46/?y47/?y48;
  *!FU(acm_RecalcClassPoints):Py1/?y10/?y20/?y30/(TRUE);
  ;[y40/y41/y42: hero changes W/M/A, y43/y44/y45: master skill bonus, y46/y47: easy class changes, y48: artefact sets changes]
  ;[CW: changed call to get more information -- END]

  !!SN&y10>=y93:T^AC_Misc.Grandmaster^/?z6; !!SN&y10<y93:T^AC_Misc.Master^/?z6; !!SN&y10<y92:T^AC_Misc.Expert^/?z6; !!SN&y10<y91:T^AC_Misc.Adept^/?z6;
  !!SN&y20>=y93:T^AC_Misc.Grandmaster^/?z7; !!SN&y20<y93:T^AC_Misc.Master^/?z7; !!SN&y20<y92:T^AC_Misc.Expert^/?z7; !!SN&y20<y91:T^AC_Misc.Adept^/?z7;
  !!SN&y30>=y93:T^AC_Misc.Grandmaster^/?z8; !!SN&y30<y93:T^AC_Misc.Master^/?z8; !!SN&y30<y92:T^AC_Misc.Expert^/?z8; !!SN&y30<y91:T^AC_Misc.Adept^/?z8;

  !!CM:R0;
  !!SN:T^AC_Misc.Warrior^/?z3;
  !!SN:T^AC_Misc.Mage^/?z4;
  !!SN:T^AC_Misc.Adventurer^/?z5;

  !!SN:T^AC_Misc.Bonus Table 2^/?s^Bonus Table 2^;

  !!DL270:N^Class_Table.txt^;             [parse dialogue]
  !!SN:T^AC_Misc.Bonus Table 20^/?z20 Iz20/?z20;
  !!SN:T^AC_Misc.Bonus Table 21^/?z21 Iz21/?z21;
  !!SN:T^AC_Misc.Bonus Table 22^/?z22 Iz22/?z22;
  !!SN:T^AC_Misc.Bonus Table 4^/?z10;
  !!SN:T^AC_Misc.Bonus Table 5^/?z11;
  !!SN:T^AC_Misc.Bonus Table 6^/?z12;

  !!SN:T^AC_Misc.Bonus Table 8^/?z13;
  !!SN:T^AC_Misc.Bonus Table 9^/?z14;
  !!SN:T^AC_Misc.Bonus Table 10^/?z15;
  !!SN:T^AC_Misc.Bonus Table 11^/?z16 Iz16/?z16;  [CW: change info (footline) on class experience table dialog]

  ;[CW: color the skills the hero has START]
  ;[the idea is to color the skills which the hero currently has to give a better overview]
  ;[using v41..v50 for warrior    skills in sequences they are shown in the screen]
  ;[using v71..v79 for mage       skills in sequences they are shown in the screen]
  ;[using v91..v99 for adventurer skills in sequences they are shown in the screen]

  !!VRv41:C22/23/1/19/6/9/20/10/26/12; [warrior skills:    Offense,   Armorer,      Archery,  Warfare,   Leadership, Luck,       Artillery, Ballistics,  Resistance, Necromancy]
  !!VRv71:C25/24/7/8/18/14/15/16/17;    [mage skills:       Sorcery,   Intelligence, Wisdom,   Mysticism, Scholar,    Fire Magic, Air Magic, Water Magic, Earth Magic]
  !!VRv91:C27/0/3/2/4/11/21/13/5;    [adventurer skills: First Aid, Pathfinding,  Scouting, Logistics, Diplomacy,  Eagle Eye,  Learning,  Estates,     Nobility]

  !!re i/41/109;
    !!VRi&i=63:S71;   [skip values 63 to 70]
    !!VRi&i=80:S81; [skip value  80]
    !!VRi&i=90:S91; [skip value  90]
    !!VRi&i=100:S101; [skip value 100]

    !!VR(isSkill:y):S(FALSE);          [init with FALSE; TRUE means skillText, FALSE means skillValues]
    !!VR(isSkill)&i>=41/i<=50:S(TRUE); [warrior    skillTexts from 41 to 50, skillValues from  51 to  60]
    !!VR(isSkill)&i>=71/i<=79:S(TRUE); [mage       skillTexts from 71 to 79, skillValues from  81 to  89]
    !!VR(isSkill)&i>=91/i<=99:S(TRUE); [adventurer skillTexts from 91 to 99, skillValues from 101 to 109]

    !!VR(color:z)&i>=41/i<=49:S^Red^;
    !!VR(color:z)&i>=50/i<=50:S^DarkGrey^;
    !!VR(color:z)&i>=71/i<=79:S^DodgerBlue^;
    !!VR(color:z)&i>=91/i<=99:S^LimeGreen^;

    !!VRy76:Si-10;                                                 [BugFixCW: determine index for v variable]
    !!VRy76|i=60/i=61/i=62:S50;                                    [BugFixCW: necro values for warrior/mage/adventurer]
    !!FU(CWGetSkillValues)&(isSkill)=(FALSE):Pvy76/?y77/?y78/?y79; [BugFixCW: get values only for skillValues]
    !!SN:T^AC_Misc.Bonus Table %i^/?(text:z) I(text)/?(text);      [BugFixCW: set text variable]

    !!if&(isSkill)=(TRUE):;
      !!HE(hero):Svi/?(skillIndex:y);  [vi is the skill number taken from the arrays defined above]
      !!VR(text)&(skillIndex)>0:S^{~%(color)}%(text){~}^;
    !!en:;
    !!DL270&i<>61/i<>62:Ai/(DLG_CMD_SET_TEXT)/(text)/1; [e.g. A51/3/z51/1;]
    !!DL270&i=50:A61/(DLG_CMD_SET_TEXT)/(text)/1; [text Necromancy for Mage]
    !!DL270&i=61:A62/(DLG_CMD_SET_TEXT)/(text)/1; [values for Mage]
    !!DL270&i=50:A63/(DLG_CMD_SET_TEXT)/(text)/1; [text Necromancy for Adventurer]
    !!DL270&i=62:A64/(DLG_CMD_SET_TEXT)/(text)/1; [values for Adventurer]
  !!en;
  ;[CW: color the skills the hero has END]

  !!SN:T^AC_Misc.Bonus Table 3^/?z23; !!DL270:A20/3/z23/1; [Class Experience and class point table]
  !!SN:T^AC_Misc.Warrior^/?z24; !!DL270:A11/3/z24/1;
  !!SN:T^AC_Misc.Mage^/?z25; !!DL270:A12/3/z25/1;
  !!SN:T^AC_Misc.Adventurer^/?z26; !!DL270:A13/3/z26/1;
  !!SN:T^AC_Misc.Druid^/?z27; !!DL270:A15/3/z27/1;
  !!SN:T^AC_Misc.Hunter^/?z28; !!DL270:A14/3/z28/1;
  !!SN:T^AC_Misc.Battlemage^/?z29; !!DL270:A16/3/z29/1;
  !!DL270:A22/3/z20/1;
  !!DL270:A23/3/z21/1;
  !!DL270:A24/3/z22/1;
  !!DL270:A4/3/z10/1;
  !!DL270:A5/3/z11/1;
  !!DL270:A6/3/z12/1;

  !!DL270:A8/3/z13/1;
  !!DL270:A9/3/z14/1;
  !!DL270:A10/3/z15/1;
  !!DL270:A21/3/z16/1;

  !!DL270:S;


!?FU(OnCustomDialogEvent)&x1=667/i^mouse_item^=45/i^mouse_action^<>(MOUSE_LMB_RELEASED);
!!if&i^mouse_action^=(MOUSE_RMB_PRESSED);
  !!DL:C1;
!!el&i^mouse_flags^=(NO_MOUSE_FLAGS);
  !!FU(acm_Dlg_ClassTable_Prepare):P;
!!en;


!?DL&v998=270/v999>=11/v999<=31/v1000=14;[right click on the three pictures to show text for upgrade and description]

  !!SN:W^Master_Level_Global_Value^/?y92;
  !!SN:W^Grandmaster_Level_Global_Value^/?y93;
  !!SN|v999=11/v999=26:T^AC_Misc.Warrior Table^/?s^Text^/^Master^/y92/^Grandmaster^/y93; [set text for 1st]
  !!SN|v999=12/v999=27:T^AC_Misc.Mages Table^/?s^Text^/^Master^/y92/^Grandmaster^/y93;
  !!SN|v999=13/v999=28:T^AC_Misc.Adventurer Table^/?s^Text^/^Master^/y92/^Grandmaster^/y93;
  !!SN|v999=14/v999=29:T^AC_Misc.Hunter Table^/?s^Text^/^Master^/y92/^Grandmaster^/y93;
  !!SN|v999=15/v999=30:T^AC_Misc.Druid Table^/?s^Text^/^Master^/y92/^Grandmaster^/y93;
  !!SN|v999=16/v999=31:T^AC_Misc.Battlemage Table^/?s^Text^/^Master^/y92/^Grandmaster^/y93;
  !!IF|v999=11/v999=12/v999=13/v999=14/v999=15/v999=16/v999=26/v999=27/v999=28/v999=29/v999=30/v999=31:M0/4/^%S(Text)^;

Close Dialouge
!?DL&v998=270/v999=30722/v1000=13;
!!DL:C1;


*Options menu at map start to select gameplay modes
!?FU(ACM_Game_start_Options);

!!FU(ACM_LoadOptionsFromIni):P;         [Try to load options from ini]

; Enable ACM option if Berserker mode is disabled
!!VRi^acm_ACM_Core^&i^acm_optionNoSkillDependenciesOnClass^<>(TRUE):S(TRUE);

!!FU(ACM_Manage10SkillsMode):P?v1;

!!UN:R7/1/0;
!!UN:R5/1/0;                            [change mouse pointer]

!!DL271:N^GameOp.txt^;                  [parse dialogue]

!!DL271:A41/4/v1/1;                     [Set checkbox for 10 SS if plugin is active]


!!re i/1/12;
  !!DL271:Ai/(DLG_CMD_SET_PCX)/^Opt_%i.pcx^/1;
!!en;

!!re i/0/11;
  !!SN:T^AC_Misc.GameOpt_%i^/?(text:z);
  !!VR(itemId:y):Si+20;
  !!DL271:A(itemId)/(DLG_CMD_SET_TEXT)/(text)/1;
!!en;

!!DL271:A60/3/^%T(AC_Misc.GameOpt_Text)^/1; [heading additional game options]

!!re i/0/11;
  !!VR(itemId:y):Si+1;
  !!VR(zInd:y):Si+40;
  !!SN:T^AC_Misc.GameOpt_Hint_%i^/?z(zInd);
  !!DL271:H(itemId)/z(zInd);
!!en;

!!SN:T^AC_Misc.GameOpt_Hint_Play^/?z61; !!DL271:H30722/61;

!!SN:W^Spell_Trainer_Mod^/?y1;          [Check if options have already been activated]
!!SN:W^Easier_Class_option^/?y3;
!!SN:W^Classic_Skin_Mod^/?y4;
*!SN:W^Typhon_Third_Upgrade_Mod_Active^/?y10; [Check for Third Upgrade Mod - Archer: doesn't seem to be needed, the option is compatible with TUM]
*!SN&y10=1:W^Alternative_Necromancy_Mod^/0;
!!SN:W^Alternative_Necromancy_Mod^/?y5;
!!SN:W^Spell_Duration_Mod^/?y6;
!!SN:W^acm_optionChooseClass^/?y7;
!!SN:W^acm_optionNoSkillDependenciesOnClass^/?y8;
!!SN:W^acm_ACM_Core^/?y9; 
!!SN:W^Tactics_enabled^/?y10;
!!SN:W^acm_Weak_Commanders^/?y11;
!!SN:W^acm_Classic_Diplomacy^/?y12;
!!DL271:A40/4/y1/1;[switch def cardre to 0 or 1]
*!DL271:A41/4/y2/1;
!!DL271:A42/4/y3/1;
!!DL271:A43/4/y4/1;
!!DL271:A44/4/y5/1;
!!DL271:A45/4/y6/1;  
!!DL271:A46/4/y7/1;  
!!DL271:A47/4/y8/1;  
!!DL271:A48/4/y9/1; 
!!DL271:A49/4/y10/1;  
!!DL271:A50/4/y11/1;
!!DL271:A51/4/y12/1;                       

!!DL271:S;                              [Show Dialogue]

!!FU(ACM_SaveOptionsToIni):P;           [save options to ini in runtime folder]

!?FU(ACM_Manage10SkillsMode);
!#VA(result:x);

!!UN:C4881872/1/?(skillsLimit:y);                   [Check the current hero secondary skills limit]

!!if&(skillsLimit)>=10;
  !!SN:W^Adept_Level_Global_Value^/20;
  !!SN:W^Expert_Level_Global_Value^/30;
  !!SN:W^Master_Level_Global_Value^/45;
  !!SN:W^Grandmaster_Level_Global_Value^/72; [Set Global Values for Class Here eg to reach Grandmaster or Master]
  !!VR(result):S(TRUE);
!!el;
  !!SN:W^Adept_Level_Global_Value^/10;
  !!SN:W^Expert_Level_Global_Value^/20;
  !!SN:W^Master_Level_Global_Value^/35;
  !!SN:W^Grandmaster_Level_Global_Value^/58; [Set Global Values for Class Here eg to reach Grandmaster or Master]
  !!VR(result):S(FALSE);
!!en;

!?DL&v998=271/v999>=1/v999<=12/v1000=14; [right click on the options to show text for upgrade and description]

!!SN|v999=1:T^AC_Misc.Play_Spell_Trainer^/?s^Text^; [set text for 1st]
*!SN|v999=2:W^Master_Level_Global_Value^/?y30;
*!SN|v999=2:W^Grandmaster_Level_Global_Value^/?y40; [Get Global Values for Class Here eg to reach Grandmaster or Master]
!!SN|v999=2:T^AC_Misc.Play_10_skills^/?s^Text^/^Master^/45/^Grandmaster^/72; [Show Dialogue if Player activated the 10 skills option]
!!SN|v999=3:T^AC_Misc.Play_Easier_Class^/?s^Text^;
!!SN|v999=4:T^AC_Misc.Play_Classic_Skin^/?s^Text^;
!!SN|v999=5:T^AC_Misc.Play_Necro_Balancing^/?s^Text^;
!!SN|v999=6:T^AC_Misc.Play_Spell_Duration^/?s^Text^;
!!SN|v999=7:T^AC_Misc.Play_Berserker_Mode^/?s^Text^;
!!SN|v999=8:T^AC_Misc.Play_No_Class_Mode^/?s^Text^;
!!SN|v999=9:T^AC_Misc.Play_ACM_Core^/?s^Text^;
!!SN|v999=10:T^AC_Misc.Play_Tactics^/?s^Text^;
!!SN|v999=11:T^AC_Misc.Play_Commanders^/?s^Text^;
!!SN|v999=12:T^AC_Misc.Play_Diplomacy^/?s^Text^;
!!IF:M0/4/^%S(Text)^;


!?DL&v998=271/v999>=40/v999<=51/v1000=13;[LMB on the options icons ]
!!VRz1:S^Button.wav^;
!!SN:Pz1;                               [Play Sound]

!!SN:W^Spell_Trainer_Mod^/?y1;          [Check if options have already been activated]
!!SN:W^Easier_Class_option^/?y3;
!!SN:W^Classic_Skin_Mod^/?y4;
!!SN:W^Alternative_Necromancy_Mod^/?y5;
!!SN:W^Spell_Duration_Mod^/?y6;
!!SN:W^acm_optionChooseClass^/?y7;
!!SN:W^acm_optionNoSkillDependenciesOnClass^/?y8;
!!SN:W^acm_ACM_Core^/?y9;
!!SN:W^Tactics_enabled^/?y10;
!!SN:W^acm_Weak_Commanders^/?y11;
!!SN:W^acm_Classic_Diplomacy^/?y12;

*!SN:W^Typhon_Third_Upgrade_Mod_Active^/?y20; [Check for Third Upgrade Mod]

!!SN&v999=40/y1=0:W^Spell_Trainer_Mod^/1;[activate 1st]
!!SN&v999=40/y1=1:W^Spell_Trainer_Mod^/0;[deactivate first]
!!SN&v999=42/y3=0:W^Easier_Class_option^/1;
!!SN&v999=42/y3=1:W^Easier_Class_option^/0;
!!SN&v999=43/y4=0:W^Classic_Skin_Mod^/1;
!!SN&v999=43/y4=1:W^Classic_Skin_Mod^/0;
*!SN&v999=44/y5=0/y20=0:W^Alternative_Necromancy_Mod^/1;
*!SN&v999=44/y5=1/y20=0:W^Alternative_Necromancy_Mod^/0;
!!SN&v999=44/y5=0:W^Alternative_Necromancy_Mod^/1;
!!SN&v999=44/y5=1:W^Alternative_Necromancy_Mod^/0;
!!SN&v999=45/y6=0:W^Spell_Duration_Mod^/1;
!!SN&v999=45/y6=1:W^Spell_Duration_Mod^/0;
!!SN&v999=46/y7=0:W^acm_optionChooseClass^/1;
!!SN&v999=46/y7=1:W^acm_optionChooseClass^/0;
!!SN&v999=47/y8=0:W^acm_optionNoSkillDependenciesOnClass^/1; !!SN&v999=47/y8=0:W^acm_ACM_Core^/0;
!!SN&v999=47/y8=1:W^acm_optionNoSkillDependenciesOnClass^/0; !!SN&v999=47/y8=1:W^acm_ACM_Core^/1; [Disable ACM_Core Mode if other game modes are activated]
!!SN&v999=48/y9=0:W^acm_ACM_Core^/1; !!SN&v999=48/y9=0:W^acm_optionNoSkillDependenciesOnClass^/0;
!!SN&v999=48/y9=1:W^acm_ACM_Core^/0; !!SN&v999=48/y9=1:W^acm_optionNoSkillDependenciesOnClass^/1;  Disable Berserker Mode if other game modes are activated]
!!SN&v999=49/y10=0:W^Tactics_enabled^/1;
!!SN&v999=49/y10=1:W^Tactics_enabled^/0;
!!SN&v999=50/y11=0:W^acm_Weak_Commanders^/1;
!!SN&v999=50/y11=1:W^acm_Weak_Commanders^/0;
!!SN&v999=51/y12=0:W^acm_Classic_Diplomacy^/1;
!!SN&v999=51/y12=1:W^acm_Classic_Diplomacy^/0;

!!SN:W^Spell_Trainer_Mod^/?y1;  [Check Status of options]
!!SN:W^Easier_Class_option^/?y3;
!!SN:W^Classic_Skin_Mod^/?y4;          
!!SN:W^Alternative_Necromancy_Mod^/?y5;
!!SN:W^Spell_Duration_Mod^/?y6;
!!SN:W^acm_optionChooseClass^/?y7;
!!SN:W^acm_optionNoSkillDependenciesOnClass^/?y8;  
!!SN:W^acm_ACM_Core^/?y9;  
!!SN:W^Tactics_enabled^/?y10;
!!SN:W^acm_Weak_Commanders^/?y11;
!!SN:W^acm_Classic_Diplomacy^/?y12;

!!DL271:A40/4/y1/1;                     [switch def cardre to 0 or 1]
*!DL271:A41/4/y2/1;
!!DL271:A42/4/y3/1;
!!DL271:A43/4/y4/1;
!!DL271:A44/4/y5/1;
!!DL271:A45/4/y6/1;                     
!!DL271:A46/4/y7/1;                     
!!DL271:A47/4/y8/1;                   
!!DL271:A48/4/y9/1;                     
!!DL271:A49/4/y10/1;                     
!!DL271:A50/4/y11/1;
!!DL271:A51/4/y12/1; 

Close Dialouge
!?DL&v998=271/v999=30722/v1000=13;
!!DL:C1;


********************************************************************************


                   Level Up Section


***************************Level Up Section*************************************
**Check for changed Class Points after visiting certain objects that can change secondary skills

!$OB(OBJ_PANDORAS_BOX)&(ERM_FLAG_IS_HUMAN);
!!HE-1:N?(hero:y);
!!FU(acm_RecalcClassPoints):P(hero);

!$OB(OBJ_EVENT)&(ERM_FLAG_IS_HUMAN);
!!HE-1:N?(hero:y);
!!FU(acm_RecalcClassPoints):P(hero);

!$OB(OBJ_SCHOLAR)&(ERM_FLAG_IS_HUMAN);
!!HE-1:N?(hero:y);
!!FU(acm_RecalcClassPoints):P(hero);

!$OB(OBJ_SEERS_HUT)&(ERM_FLAG_IS_HUMAN);
!!HE-1:N?(hero:y);
!!FU(acm_RecalcClassPoints):P(hero);

!$OB(OBJ_UNIVERSITY)&(ERM_FLAG_IS_HUMAN);
!!HE-1:N?(hero:y);
!!FU(acm_RecalcClassPoints):P(hero);

!$OB(OBJ_WITCH_HUT)&(ERM_FLAG_IS_HUMAN);
!!HE-1:N?(hero:y);
!!FU(acm_RecalcClassPoints):P(hero);

!$OB(OBJ_TOWN)/(TOWN_CONFLUX)&(ERM_FLAG_IS_HUMAN);
!!HE-1:N?(hero:y);
!!FU(acm_RecalcClassPoints):P(hero);


********************************************************************************
!?FU(Check_SS_SKILLS);
!!HEx1:Sx16/?y1;
!!VRx2:S0;
!!VRx2|y1=1/y1=2:S1;
!!VRx16|y1=1/y1=2:S27;                  [If Skill at Basic or Advanced found exit Loop]

********************************************************************************
!?FU(acm_RecalcClassPoints);
!#VA(hero:x);
!#VA(warriorPoints:x);    OUT
!#VA(magePoints:x);       OUT
!#VA(adventurerPoints:x); OUT
!#VA(returnRealPoints:x); Optional. Return real class points for display purposes only. Default: false.
                        ; Usually we have to return fake points, satisfying certain constraints for compatibility with mod legacy code

; Exit if in battle
!!FU(H3Dlg_GetCurrentDlgId):P?(dlgId:y);
!!FU&(dlgId)=(DLG_BATTLE):E;

; Backup original classes to be able to track changes
!!VR(prevWasMasterWarrior:y):Si^Master_Warrior_Hero%(hero)^;
!!VR(prevWasMasterMage:y):Si^Master_Mage_Hero%(hero)^;
!!VR(prevWasMasterAdventurer:y):Si^Master_Adventurer_Hero%(hero)^;
!!VR(prevWasGrandmasterWarrior:y):Si^Grandmaster_Warrior_Hero%(hero)^;
!!VR(prevWasGrandmasterMage:y):Si^Grandmaster_Mage_Hero%(hero)^;
!!VR(prevWasGrandmasterAdventurer:y):Si^Grandmaster_Adventurer_Hero%(hero)^;

; Call original function for compatibility reasons, exit if it's called for display only
!!FU(Calc_Class_Points_Original):P(hero)/(NULL)/?(warriorPoints)/?(magePoints)/?(adventurerPoints);

; Copy class points to list to operate them in loops
!#VA(classPoints[ACM_NUM_MAIN_CLASSES]:y);
!!VR(classPoints[ACM_WARRIOR_CLASS_IND]):S(warriorPoints);
!!VR(classPoints[ACM_MAGE_CLASS_IND]):S(magePoints);
!!VR(classPoints[ACM_ADVENTURER_CLASS_IND]):S(adventurerPoints);

; Fetch global settings
!!VR(masterClassRequiredPoints:y):Si^Master_Level_Global_Value^;
!!VR(grandmasterClassRequiredPoints:y):Si^Grandmaster_Level_Global_Value^;

; Get more info about current hero
!!HE(hero):Ed/?(heroLevel:y) O?(heroOwner:y) B0/?(heroName:z);
!!OW:I(heroOwner)/?(isAi:y);

; Desired class can be selected by player to force upgrading only that class points and ignore non-revevant skills
!!VR(chosenClass:y):Si^acm_chosenClass_%(hero)^;

!!VR(shouldDelayClassSelection:y):S(FALSE);
!!VR(shouldDelayClassSelection)&i^acm_dontAskToChooseClassTillMapStart_%(hero)^/i^acm_isGameStarted^=(FALSE):S(TRUE);
!!VR(shouldDelayClassSelection)&(heroLevel)<i^acm_dontAskToChooseClassTillLevel_%(hero)^:S(TRUE);

!!if&(shouldDelayClassSelection)=(FALSE);
  !!VRi^acm_dontAskToChooseClassTillMapStart_%(hero)^:S(FALSE);
  !!FU(RadioDlg_Reset):P;

  !!if&(classPoints[ACM_WARRIOR_CLASS_IND])>=(masterClassRequiredPoints)/(chosenClass)=(ACM_NO_CLASS);
    !!SN:T^acm.class_name_%(ACM_CLASS_WARRIOR)^/?(text:z);
    !!FU(RadioDlg_AddItem):P^%(text) (%(classPoints[ACM_WARRIOR_CLASS_IND])/%(masterClassRequiredPoints))^/(ACM_CLASS_WARRIOR);
  !!en;

  !!if&(classPoints[ACM_MAGE_CLASS_IND])>=(masterClassRequiredPoints)/(chosenClass)=(ACM_NO_CLASS);
    !!SN:T^acm.class_name_%(ACM_CLASS_MAGE)^/?(text:z);
    !!FU(RadioDlg_AddItem):P^%(text) (%(classPoints[ACM_MAGE_CLASS_IND])/%(masterClassRequiredPoints))^/(ACM_CLASS_MAGE);
  !!en;

  !!if&(classPoints[ACM_ADVENTURER_CLASS_IND])>=(masterClassRequiredPoints)/(chosenClass)=(ACM_NO_CLASS);
    !!SN:T^acm.class_name_%(ACM_CLASS_ADVENTURER)^/?(text:z);
    !!FU(RadioDlg_AddItem):P^%(text) (%(classPoints[ACM_ADVENTURER_CLASS_IND])/%(masterClassRequiredPoints))^/(ACM_CLASS_ADVENTURER);
  !!en;

  !!if&(classPoints[ACM_WARRIOR_CLASS_IND])>=(masterClassRequiredPoints)/(classPoints[ACM_MAGE_CLASS_IND])>=(masterClassRequiredPoints)/(chosenClass)<>(ACM_CLASS_BATTLEMAGE);
    !!VR(incompatibleClasses:y):S(chosenClass) Sd~(ACM_CLASS_BATTLEMAGE);

    !!if&(incompatibleClasses)=(ACM_NO_CLASS);
      !!SN:T^acm.class_name_%(ACM_CLASS_BATTLEMAGE)^/?(text:z);
      !!FU(RadioDlg_AddItem):P^%(text) (%(classPoints[ACM_WARRIOR_CLASS_IND])/%(masterClassRequiredPoints), %(classPoints[ACM_MAGE_CLASS_IND])/%(masterClassRequiredPoints))^/(ACM_CLASS_BATTLEMAGE);
    !!en;
  !!en;

  !!if&(classPoints[ACM_WARRIOR_CLASS_IND])>=(masterClassRequiredPoints)/(classPoints[ACM_ADVENTURER_CLASS_IND])>=(masterClassRequiredPoints)/(chosenClass)<>(ACM_CLASS_HUNTER);
    !!VR(incompatibleClasses:y):S(chosenClass) Sd~(ACM_CLASS_HUNTER);

    !!if&(incompatibleClasses)=(ACM_NO_CLASS);
      !!SN:T^acm.class_name_%(ACM_CLASS_HUNTER)^/?(text:z);
      !!FU(RadioDlg_AddItem):P^%(text) (%(classPoints[ACM_WARRIOR_CLASS_IND])/%(masterClassRequiredPoints), %(classPoints[ACM_ADVENTURER_CLASS_IND])/%(masterClassRequiredPoints))^/(ACM_CLASS_HUNTER);
    !!en;
  !!en;

  !!if&(classPoints[ACM_MAGE_CLASS_IND])>=(masterClassRequiredPoints)/(classPoints[ACM_ADVENTURER_CLASS_IND])>=(masterClassRequiredPoints)/(chosenClass)<>(ACM_CLASS_DRUID);
    !!VR(incompatibleClasses:y):S(chosenClass) Sd~(ACM_CLASS_DRUID);

    !!if&(incompatibleClasses)=(ACM_NO_CLASS);
      !!SN:T^acm.class_name_%(ACM_CLASS_DRUID)^/?(text:z);
      !!FU(RadioDlg_AddItem):P^%(text) (%(classPoints[ACM_MAGE_CLASS_IND])/%(masterClassRequiredPoints), %(classPoints[ACM_ADVENTURER_CLASS_IND])/%(masterClassRequiredPoints))^/(ACM_CLASS_DRUID);
    !!en;
  !!en;

  !!FU(RadioDlg_GetNumItems):P?(numProposedClasses:y);

  !!if&(numProposedClasses)>0;
    !!if&i^acm_optionChooseClass^=(TRUE)/(isAi)=(FALSE)/(ERM_FLAG_IS_HUMAN);
      !!SN:T^acm.class_selection_dlg.title^/?(text:z)/^hero_name^/(heroName);
      !!FU(RadioDlg_SetTitle):P(text);
      !!FU(RadioDlg_AddCancelButton):P;

      !!SN:T^acm.class_selection_dlg.delay_selection_for^/?(text:z)/^levels^/2;
      !!FU(RadioDlg_AddItem):P(text)/-2;
      !!FU(RadioDlg_AddItem)&i^acm_isGameStarted^=(FALSE):P^%T(acm.class_selection_dlg.delay_selection_till_game_start)^/-1/^till_game_start^;

      !!SN:T^acm.class_selection_dlg.delay_selection_for^/?(text:z)/^levels^/5;
      !!FU(RadioDlg_AddItem):P(text)/-5;

      !!SN:T^acm.class_name_%(chosenClass)^/?(className:z);
      !!SN:T^acm.class_selection_dlg.never_ask^/?(text:z)/^class_name^/(className);
      !!FU(RadioDlg_AddItem):P(text)/-1000;

      !!FU(RadioDlg_Show):P?(itemInd:y)/?(dlgRes:y)/?(dlgResTag:z);

      !!if&(dlgRes)<0;
        !!if&(dlgResTag)=^till_game_start^;
          !!VRi^acm_dontAskToChooseClassTillMapStart_%(hero)^:S(TRUE);
        !!el;
          !!VRi^acm_dontAskToChooseClassTillLevel_%(hero)^:S(heroLevel) -(dlgRes);
        !!en;
      !!el;
        !!VR(chosenClass):S(dlgRes);
        !!VRi^acm_chosenClass_%(hero)^:S(chosenClass);
      !!en;
    !!el;
      ; Select the last class automatically
      !!VR(lastDlgItemInd:y):S(numProposedClasses) -1;
      !!FU(RadioDlg_GetItemValue):P(lastDlgItemInd)/?(chosenClass);
      !!VRi^acm_chosenClass_%(hero)^:S(chosenClass);
    !!en; else
  !!en; if
!!en; if

!!if&(chosenClass)<>(ACM_NO_CLASS);
  ; Desired class is set, nullify all non-relevant class points
  !!VR(testClass:y):S(ACM_FIRST_CLASS);

  !!re i/0/(ACM_NUM_MAIN_CLASSES)/1/-1;
    ; If tested class is the desired class or is a part of desired multiclass, multiplier will be 1, 0 otherwise
    !!VR(classPointsMultiplier:y):S(chosenClass) &(testClass) F0/1;
    !!VR(classPoints[i]):*(classPointsMultiplier);
    !!VR(testClass):Sd<<1;
  !!en;
!!el;
  ; Desired class is not set, nullify all points
  !!re i/0/(ACM_NUM_MAIN_CLASSES)/1/-1;
    !!VR(classPoints[i]):S0;
  !!en;
!!en; else

; Re-evaluate global class variables
!!VRi^Master_Warrior_Hero%(hero)^:S(FALSE);
!!VRi^Master_Mage_Hero%(hero)^:S(FALSE);
!!VRi^Master_Adventurer_Hero%(hero)^:S(FALSE);
!!VRi^Grandmaster_Warrior_Hero%(hero)^:S(FALSE);
!!VRi^Grandmaster_Mage_Hero%(hero)^:S(FALSE);
!!VRi^Grandmaster_Adventurer_Hero%(hero)^:S(FALSE);

!!if&(classPoints[ACM_WARRIOR_CLASS_IND])>=(masterClassRequiredPoints)/(classPoints[ACM_MAGE_CLASS_IND])>=(masterClassRequiredPoints);
  !!VRi^Master_Warrior_Hero%(hero)^:S(TRUE);
  !!VRi^Master_Mage_Hero%(hero)^:S(TRUE);
!!el&(classPoints[ACM_WARRIOR_CLASS_IND])>=(masterClassRequiredPoints)/(classPoints[ACM_ADVENTURER_CLASS_IND])>=(masterClassRequiredPoints);
  !!VRi^Master_Warrior_Hero%(hero)^:S(TRUE);
  !!VRi^Master_Adventurer_Hero%(hero)^:S(TRUE);
!!el&(classPoints[ACM_MAGE_CLASS_IND])>=(masterClassRequiredPoints)/(classPoints[ACM_ADVENTURER_CLASS_IND])>=(masterClassRequiredPoints);
  !!VRi^Master_Mage_Hero%(hero)^:S(TRUE);
  !!VRi^Master_Adventurer_Hero%(hero)^:S(TRUE);
!!el;
  !!VRi^Master_Warrior_Hero%(hero)^&(classPoints[ACM_WARRIOR_CLASS_IND])>=(masterClassRequiredPoints):S(TRUE);
  !!VRi^Master_Mage_Hero%(hero)^&(classPoints[ACM_MAGE_CLASS_IND])>=(masterClassRequiredPoints):S(TRUE);
  !!VRi^Master_Adventurer_Hero%(hero)^&(classPoints[ACM_ADVENTURER_CLASS_IND])>=(masterClassRequiredPoints):S(TRUE);
  !!VRi^Grandmaster_Warrior_Hero%(hero)^&(classPoints[ACM_WARRIOR_CLASS_IND])>=(grandmasterClassRequiredPoints):S(TRUE);
  !!VRi^Grandmaster_Mage_Hero%(hero)^&(classPoints[ACM_MAGE_CLASS_IND])>=(grandmasterClassRequiredPoints):S(TRUE);
  !!VRi^Grandmaster_Adventurer_Hero%(hero)^&(classPoints[ACM_ADVENTURER_CLASS_IND])>=(grandmasterClassRequiredPoints):S(TRUE);
!!en;

; Return updated class points
!!if&(returnRealPoints)=(FALSE);
  !!VR(warriorPoints):S(classPoints[ACM_WARRIOR_CLASS_IND]);
  !!VR(magePoints):S(classPoints[ACM_MAGE_CLASS_IND]);
  !!VR(adventurerPoints):S(classPoints[ACM_ADVENTURER_CLASS_IND]);
!!en;

; Show class promotion dialog if any main class is changed and a class is chosen to promote to
!!if|i^Master_Warrior_Hero%(hero)^         <> (prevWasMasterWarrior)/
     i^Master_Mage_Hero%(hero)^            <> (prevWasMasterMage)/
     i^Master_Adventurer_Hero%(hero)^      <> (prevWasMasterAdventurer)/
     i^Grandmaster_Warrior_Hero%(hero)^    <> (prevWasGrandmasterWarrior)/
     i^Grandmaster_Mage_Hero%(hero)^       <> (prevWasGrandmasterMage)/
     i^Grandmaster_Adventurer_Hero%(hero)^ <> (prevWasGrandmasterAdventurer);
  !!FU(acm_ShowClassPromotionDlg)&(chosenClass)<>(ACM_NO_CLASS):P(hero)/(classPoints[ACM_WARRIOR_CLASS_IND])/(classPoints[ACM_MAGE_CLASS_IND])/(classPoints[ACM_ADVENTURER_CLASS_IND]);
!!en;

!?FU(Calc_Class_Points_Original);                [Calculate class points function]
;[CW: additional parameters to return more detailed information - START]
;[x6  = OUT hard coded warrior offset for specific heroes]
;[x7  = OUT hard coded mage offset for specific heroes]
;[x8  = OUT hard coded adventurer offset for specific heroes]
;[x9  = OUT extra points for warrior master level skills]
;[x10 = OUT extra points for mage master level skills]
;[x11 = OUT extra points for adventurer master level skills]
;[x12 = OUT current extra points in case of easy class option is active]
;[x13 = OUT maxium extra points in case of easy class option is active]
;[x14 = OUT additional points coming from equiped artefacts]
!!VRx6:S0; !!VRx7:S0; !!VRx8:S0; !!VRx9:S0; !!VRx10:S0; !!VRx11:S0; !!VRx12:S0; !!VRx13:S0; !!VRx14:S0; [init OUT variables]
;[CW: additional parameters to return more detailed information - END]

!!HEx1:B2/?y2;
!!VRy3:Sy2 %2;
*!VRy10&y3=1:-5;     warrior
*!VRy20&y3=0:-5;     mage
*!VRy30:+10;         adventurer

!!SN:W^Number_Of_Hero_Skills^/0;

!!VRy10:S0; !!VRy20:S0; !!VRy30:S0;

!!HEx1:S0/?y1;                          [Pathfinding]
!!VRy10&y1>0:+3;                        [warrior]
!!VRy20&y1>0:+3;                        [mage]
!!VRy30&y1>0:+7;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Pathfinding_0_Hero%X1^/?y1; !!VRy30&y1=1:+2; [adventurer]
!!VRx11&y1=1:+2; [CW: add 2 extra points for adventurer]

!!HEx1:S1/?y1;                          [Archery]
!!VRy10&y1>0:+7;                        [warrior]
!!VRy20&y1>0:+2;                        [mage]
!!VRy30&y1>0:+2;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Archery_0_Hero%X1^/?y1; !!VRy10&y1=1:+2; [warrior]
!!VRx9&y1=1:+2; [CW: add 2 extra points for warrior]

!!HEx1:S2/?y1;                          [Logistics]
!!VRy10&y1>0:+3;                        [warrior]
!!VRy20&y1>0:+2;                        [mage]
!!VRy30&y1>0:+6;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Logistics_0_Hero%X1^/?y1; !!VRy30&y1=1:+2; [adventurer]
!!VRx11&y1=1:+2; [CW: add 2 extra points for adventurer]

!!HEx1:S3/?y1;                          [Scouting]
!!VRy10&y1>0:+2;                        [warrior]
!!VRy20&y1>0:+2;                        [mage]
!!VRy30&y1>0:+8;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Scouting_0_Hero%X1^/?y1; !!VRy30&y1=1:+2; [adventurer]
!!VRx11&y1=1:+2; [CW: add 2 extra points for adventurer]

!!HEx1:S4/?y1;                          [Diplomacy]
!!VRy10&y1>0:+2;                        [warrior]
!!VRy20&y1>0:+2;                        [mage]
!!VRy30&y1>0:+6;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Diplomacy_0_Hero%X1^/?y1; !!VRy30&y1=1:+2; [adventurer]
!!VRx11&y1=1:+2; [CW: add 2 extra points for adventurer]

!!HEx1:S5/?y1;                          [Nobility]
!!VRy10&y1>0:+4;                        [warrior]
!!VRy20&y1>0:+2;                        [mage]
!!VRy30&y1>0:+7;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Nobility_0_Hero%X1^/?y1; !!VRy30&y1=1:+2; [adventurer]
!!VRx11&y1=1:+2; [CW: add 2 extra points for adventurer]

!!HEx1:S6/?y1;                          [Leadership]
!!VRy10&y1>0:+6;                        [warrior]
!!VRy20&y1>0:+4;                        [mage]
!!VRy30&y1>0:+3;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Leadership_0_Hero%X1^/?y1; !!VRy10&y1=1:+2; [warrior]
!!VRx9&y1=1:+2; [CW: add 2 extra points for warrior]

!!HEx1:S7/?y1;                          [Wisdom]
!!VRy10&y1>0:+1;                        [warrior]
!!VRy20&y1>0:+7;                        [mage]
!!VRy30&y1>0:+3;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Wisdom_0_Hero%X1^/?y1; !!VRy20&y1=1:+2; [mage]
!!VRx10&y1=1:+2; [CW: add 2 extra points for mage]

!!HEx1:S8/?y1;                          [Mysticism]
!!VRy10&y1>0:+4;                        [warrior]
!!VRy20&y1>0:+6;                        [mage]
!!VRy30&y1>0:+3;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Mysticism_0_Hero%X1^/?y1; !!VRy20&y1=1:+2; [mage]
!!VRx10&y1=1:+2; [CW: add 2 extra points for mage]

!!HEx1:S9/?y1;                          [Luck]
!!VRy10&y1>0:+6;                        [warrior]
!!VRy20&y1>0:+3;                        [mage]
!!VRy30&y1>0:+4;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Luck_0_Hero%X1^/?y1; !!VRy10&y1=1:+2; [warrior]
!!VRx9&y1=1:+2; [CW: add 2 extra points for warrior]

!!HEx1:S10/?y1;                         [Ballistics]
!!VRy10&y1>0:+6;                        [warrior]
!!VRy20&y1>0:+4;                        [mage]
!!VRy30&y1>0:+3;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Ballistics_0_Hero%X1^/?y1; !!VRy10&y1=1:+2; [warrior]
!!VRx9&y1=1:+2; [CW: add 2 extra points for warrior]

!!HEx1:S11/?y1;                         [Eagle Eye]
!!VRy10&y1>0:+3;                        [warrior]
!!VRy20&y1>0:+4;                        [mage]
!!VRy30&y1>0:+6;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Eagle Eye_0_Hero%X1^/?y1; !!VRy30&y1=1:+2; [adventurer]
!!VRx11&y1=1:+2; [CW: add 2 extra points for adventurer]

!!HEx1:S12/?y1;                         [Necromancy]
!!VRy10&y1>0:+4;                        [warrior]
!!VRy20&y1>0:+4;                        [mage]
!!VRy30&y1>0:+4;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1; [Neutral Skills]

!!HEx1:S13/?y1;                         [Estates]
!!VRy10&y1>0:+4;                        [warrior]
!!VRy20&y1>0:+2;                        [mage]
!!VRy30&y1>0:+6;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Estates_0_Hero%X1^/?y1; !!VRy30&y1=1:+2; [adventurer]
!!VRx11&y1=1:+2; [CW: add 2 extra points for adventurer]

!!HEx1:S14/?y1;                         [Fire Magic]
!!VRy10&y1>0:+2;                        [warrior]
!!VRy20&y1>0:+6;                        [mage]
!!VRy30&y1>0:+3;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Fire Magic_0_Hero%X1^/?y1; !!VRy20&y1=1:+2; [mage]
!!VRx10&y1=1:+2; [CW: add 2 extra points for mage]

!!HEx1:S15/?y1;                         [Air Magic]
!!VRy10&y1>0:+2;                        [warrior]
!!VRy20&y1>0:+6;                        [mage]
!!VRy30&y1>0:+3;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Air Magic_0_Hero%X1^/?y1; !!VRy20&y1=1:+2; [mage]
!!VRx10&y1=1:+2; [CW: add 2 extra points for mage]

!!HEx1:S16/?y1;                         [Water Magic]
!!VRy10&y1>0:+2;                        [warrior]
!!VRy20&y1>0:+6;                        [mage]
!!VRy30&y1>0:+3;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Water Magic_0_Hero%X1^/?y1; !!VRy20&y1=1:+2; [mage]
!!VRx10&y1=1:+2; [CW: add 2 extra points for mage]

!!HEx1:S17/?y1;                         [Earth Magic]
!!VRy10&y1>0:+1;                        [warrior]
!!VRy20&y1>0:+7;                        [mage]
!!VRy30&y1>0:+2;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Earth Magic_0_Hero%X1^/?y1; !!VRy20&y1=1:+2; [mage]
!!VRx10&y1=1:+2; [CW: add 2 extra points for mage]

!!HEx1:S18/?y1;                         [Scholar]
!!VRy10&y1>0:+3;                        [warrior]
!!VRy20&y1>0:+7;                        [mage]
!!VRy30&y1>0:+3;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Scholar_0_Hero%X1^/?y1; !!VRy20&y1=1:+2; [mage]
!!VRx10&y1=1:+2; [CW: add 2 extra points for mage]

!!HEx1:S19/?y1;                         [Tactics/Warfare]
!!VRy10&y1>0:+7;                        [warrior]
!!VRy20&y1>0:+3;                        [mage]
!!VRy30&y1>0:+2;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Tactics_0_Hero%X1^/?y1; !!VRy10&y1=1:+2; [warrior]
!!VRx9&y1=1:+2; [CW: add 2 extra points for warrior]

!!HEx1:S20/?y1;                         [Artillery]
!!VRy10&y1>0:+6;                        [warrior]
!!VRy20&y1>0:+3;                        [mage]
!!VRy30&y1>0:+3;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Artillery_0_Hero%X1^/?y1; !!VRy10&y1=1:+2; [warrior]
!!VRx9&y1=1:+2; [CW: add 2 extra points for warrior]

!!HEx1:S21/?y1;                         [Learning]
!!VRy10&y1>0:+2;                        [warrior]
!!VRy20&y1>0:+3;                        [mage]
!!VRy30&y1>0:+6;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Learning_0_Hero%X1^/?y1; !!VRy30&y1=1:+2; [adventurer]
!!VRx11&y1=1:+2; [CW: add 2 extra points for adventurer]

!!HEx1:S22/?y1;                         [Offense]
!!VRy10&y1>0:+8;                        [warrior]
!!VRy20&y1>0:+1;                        [mage]
!!VRy30&y1>0:+1;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Offense_0_Hero%X1^/?y1; !!VRy10&y1=1:+2; [warrior]
!!VRx9&y1=1:+2; [CW: add 2 extra points for warrior]

!!HEx1:S23/?y1;                         [Armorer]
!!VRy10&y1>0:+7;                        [warrior]
!!VRy20&y1>0:+1;                        [mage]
!!VRy30&y1>0:+2;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Armorer_0_Hero%X1^/?y1; !!VRy10&y1=1:+2; [warrior]
!!VRx9&y1=1:+2; [CW: add 2 extra points for warrior]

!!HEx1:S24/?y1;                         [Intelligence]
!!VRy10&y1>0:+4;                        [warrior]
!!VRy20&y1>0:+7;                        [mage]
!!VRy30&y1>0:+2;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Intelligence_0_Hero%X1^/?y1; !!VRy20&y1=1:+2; [mage]
!!VRx10&y1=1:+2; [CW: add 2 extra points for mage]

!!HEx1:S25/?y1;                         [Sorcery]
!!VRy10&y1>0:+1;                        [warrior]
!!VRy20&y1>0:+8;                        [mage]
!!VRy30&y1>0:+2;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Sorcery_0_Hero%X1^/?y1; !!VRy20&y1=1:+2; [mage]
!!VRx10&y1=1:+2; [CW: add 2 extra points for mage]

!!HEx1:S26/?y1;                         [Resistance]
!!VRy10&y1>0:+6;                        [warrior]
!!VRy20&y1>0:+4;                        [mage]
!!VRy30&y1>0:+3;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Resistance_0_Hero%X1^/?y1; !!VRy10&y1=1:+2; [warrior]
!!VRx9&y1=1:+2; [CW: add 2 extra points for warrior]

!!HEx1:S27/?y1;                         [First Aid]
!!VRy10&y1>0:+2;                        [warrior]
!!VRy20&y1>0:+2;                        [mage]
!!VRy30&y1>0:+6;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_First Aid_0_Hero%X1^/?y1; !!VRy30&y1=1:+2; [adventurer]
!!VRx11&y1=1:+2; [CW: add 2 extra points for adventurer]


***************************************
**Special Hero Starting Conditions**
***************************************

;[CW: additional parameters to return more detailed information - START]
;[save values of y10, y20 and y30 to determine changes after this section]
!!VRy40:Sy10; !!VRy50:Sy20; !!VRy60:Sy30;
;[CW: additional parameters to return more detailed information - END]

!!VRy10&x1=4:-7; !!VRy30&x1=4:+7;       [Lord Haart Starts with +7 A -7 W Points]
!!VRy10&x1=9:+5; !!VRy30&x1=9:-5;       [Adela Starts with +5 W -5 A Points]

!!VRy10&x1=35:+6; !!VRy20&x1=35:-4;     [Neela +6 W -4 M Point]

!!VRy10&x1=59:+6; !!VRy20&x1=59:-4;     [Olema +6 W -4 M Point]
!!VRy10&x1=61:+6; !!VRy20&x1=61:-4;     [Ash +6 W -4 M Point]

!!VRy10&x1=69:+2; !!VRy20&x1=69:-4; !!VRy30&x1=69:+2; [Isra +2 W -4 M +2 A Point]
!!VRy10&x1=70:+2; !!VRy20&x1=70:-4; !!VRy30&x1=70:+2; [Clavius +2 W -4 M +2 A Point]
!!VRy10&x1=77:+6; !!VRy20&x1=77:-4;     [Xsi +6 W -4 M Point]
!!VRy10&x1=78:+2; !!VRy20&x1=78:-4; !!VRy30&x1=78:+2; [Vidomina +2 W -4 M +2 A Point]
!!VRy10&x1=79:+2; !!VRy20&x1=79:-4; !!VRy30&x1=79:+2; [Nagash +2 W -4 M +2 A Point]

!!VRy10&x1=95:+6; !!VRy20&x1=95:-4;     [Darkstorn +6 W -4 M Point]

!!VRy10&x1=107:+1; !!VRy20&x1=107:+1;   [Terek +1 W +1 M Point]
!!VRy10&x1=108:+1; !!VRy20&x1=108:+1;   [Zubin +1 W +1 M Point]

!!VRy10&x1=120:+6; !!VRy20&x1=120:-4;   [Mirlanda +6 W -4 M Point]

!!SN:W^Zulu_Mod_On^/?y79;
!!if&y79=0;
  !!VRy10&x1=137:+6; !!VRy20&x1=137:-4; [Brissa +6 W -4 M Point]
  !!VRy10&x1=139:+6; !!VRy20&x1=139:-4; [Labetha +6 W -4 M Point]
!!en;

*!VRy30&x1=129:-5;                      [Thunar Starts with -5 A Points]
*!VRy20&x1=129:+5;                      [Thunar Starts with +5 M Points]
*!VRy10&x1=129:-5;                      [Thunar Starts with -5 W Points]

***************************************
**Special Commander Class**
***************************************
!!FU(Check_Com_Masteries):Px1/0/?y83/0/?y84; [Pass Hero Number and return current com class and kill count]
!!if&y84=16;                            [If King Class]
  !!VRy85:Sy83:25;                      [+1 class point for each 25 kill counts]
  !!VRy10:+y85;                         [warrior]
  !!VRy20:+y85;                         [mage]
  !!VRy30:+y85;                         [adventurer]
!!en;
**************************************


;[CW: additional parameters to return more detailed information - START]
!!VRx6:Sy10-y40; !!VRx7:Sy20-y50; !!VRx8:Sy30-y60; [hero changes: x6=W, x7=M, x8=A]
;[save values of y10 to determine changes after this section, always the same for all classes]
!!VRy40:Sy10;
!!VRx13:S0;                             [init max number of class points from Easier Class Option]

!!SN:W^Easier_Class_option^/?y80;       [If option active you get +5 to all class points between level 20 and 30]
!!if&y80=1;
  !!VRx13:S5;                           [max number of class points from Easier Class Option when option is active]
  !!HEx1:E?y81/?y82/1;
  !!VRy10&y82>=20:+1; !!VRy10&y82>=22:+1; !!VRy10&y82>=25:+1; !!VRy10&y82>=27:+1; !!VRy10&y82>=30:+1;
  !!VRy20&y82>=20:+1; !!VRy20&y82>=22:+1; !!VRy20&y82>=25:+1; !!VRy20&y82>=27:+1; !!VRy20&y82>=30:+1;
  !!VRy30&y82>=20:+1; !!VRy30&y82>=22:+1; !!VRy30&y82>=25:+1; !!VRy30&y82>=27:+1; !!VRy30&y82>=30:+1;
!!en;

!!VRx12:Sy10-y40;                       [easy class changes for all classes: x12]
;[save values of y10 to determine changes after this section, always the same for all classes]
!!VRy40:Sy10;

*artifacts bonus
!!FU(Count_Set_Pieces_2):Px1/0/0/?y90/?y91/?y92; [Check for class Sets]
!!VRy10&y91=3:+5;                       [+5 Warrior Class Points]
!!VRy20&y90=3:+5;                       [+5 Mage Class Points]
!!VRy30&y92=3:+5;                       [+5 Adventurer Class Points]

!!HEx1:A2/49/?y50/?y51;                 [49 Badge of Courage]
!!VRy10&y51=1:+1;                       [+1 Warrior Class Points]
!!VRy20&y51=1:+1;                       [+1 Mage Class Points]
!!VRy30&y51=1:+1;                       [+1 Adventurer Class Points]

!!VRx14:Sy10-y40;                       [artefact sets changes for all classes: x14]

****************************************

!!VRx3:Sy10;                            [return values to fct]
!!VRx4:Sy20;
!!VRx5:Sy30;

!!SN:W^Expert_Level_Global_Value^/?y11;
!!SN:W^Master_Level_Global_Value^/?y21;
!!SN:W^Grandmaster_Level_Global_Value^/?y31; [Check Global Values for Class Here eg to reach Grandmaster or Master]

!!SN&y10<y11:W^Expert_Warrior_Hero%X1^/0;    !!SN&y10<y21:W^Master_Warrior_Hero%X1^/0;    !!SN&y10<y31:W^Grandmaster_Warrior_Hero%X1^/0; [Drop out of Class if Skill is removed and not enough class points]
!!SN&y20<y11:W^Expert_Mage_Hero%X1^/0;       !!SN&y20<y21:W^Master_Mage_Hero%X1^/0;       !!SN&y20<y31:W^Grandmaster_Mage_Hero%X1^/0;
!!SN&y30<y11:W^Expert_Adventurer_Hero%X1^/0; !!SN&y30<y21:W^Master_Adventurer_Hero%X1^/0; !!SN&y30<y31:W^Grandmaster_Adventurer_Hero%X1^/0;

***********************Skill Description Section********************************

!?FU(OnPreHeroScreen);
!#VA(hero:x);

!!FU(acm_RecalcClassPoints):P(hero);                                      [Calculate class points]
!!FU(acm_SyncSkillsNativeAndExtraLevels):P(hero);                         [Call this function to delete Master and Grandmaster Level if native skill level was
                                                ;                          changed from expert to something else]
!!DO(AC_Set_SS_Description)/(SEC_SKILL_FIRST)/(SEC_SKILL_LAST)/1:P(hero); [Set new Skill descriptions]
!!DO(AC_Set_SS_Names)/(SEC_SKILL_FIRST)/(SEC_SKILL_LAST)/1:P(hero);       [Set new Skill names]

!?FU(OnCloseHeroScreen);
!!FU(Set_SS_Skill_Name_and_Text):P;  [Reset Skill Descriptions to show correct name in in Which Huts and Stuff]
!!HE-1:N?(hero:y);                   [Give Advanced Level if enough points when closing Hero Screen]
!!FU(acm_RecalcClassPoints):P(hero);

!$OB(OBJ_NEW_WOG_OBJECTS)/51;         [Post visit Trigger Market of Time]
!!HE-1:N?(hero:y);
!!FU(acm_RecalcClassPoints):P(hero);  [Call Calculation Function to delete Master/Grandmaster Rank if not enough Class Points]


!?FU(AC_Set_SS_Names);
!!HEx1:Sx16/?(nativeLevel:y);

!!if&(nativeLevel)>0;
  !!FU(H3_Mod_Check_Skill_Level):Px1/?(masterLvl:y)/?(gmLvl:y)/x16;
  !!VR(skillLvl:y):S(nativeLevel) +(masterLvl) +(gmLvl); y1+y2+y3;
  !!VR(strInd:y):S(skillLvl)*100+ 199100+x16;
  !!SN:H^secskill^/x16/0/z(strInd);
!!en;


!?FU(acm_CreateArray);
!!SN:M(M_AUTO_ID)/0/(M_STR)/(M_STORED)/?i^acm_SkillNames_ArrayId^;(array:y);
!!FU(Array_Push):Pi^acm_SkillNames_ArrayId^/^Pathfinding^/^Archery^/^Logistics^/^Scouting^/^Diplomacy^
/^Nobility^/^Leadership^/^Wisdom^/^Mysticism^/^Luck^/^Ballistics^/^Eagle Eye^/^Necromancy^/^Estates^;/^^;

!!FU(Array_Push):Pi^acm_SkillNames_ArrayId^/^Fire Magic^/^Air Magic^/^Water Magic^/^Earth Magic^/^Scholar^
/^Tactics^/^Artillery^/^Learning^/^Offense^/^Armorer^/^Intelligence^/^Sorcery^/^Resistance^/^First Aid^;
!#FU(acm_CreateArray):P;

********************************************************************************
!?FU(H3_Mod_Check_Skill_Level);
x1 - hero id, x2 - return master rank, x3 - return GM rank, x4 - skill id
!#VA(heroId:x) (masterLvl:x) (gmLvl:x) (skillId:x);
!!VRx2:S0; !!VRx3:S0;

!!SN:Mi^acm_SkillNames_ArrayId^/(skillId)/?(skillName:z);
!!VR(masterLvl):Si^H3_%(skillName)_0_Hero%(heroId)^;
!!VR(gmLvl):Si^H3_%(skillName)_1_Hero%(heroId)^;

!?FU(H3_Mod_Set_Skill_ExtraLevel);
x1 - hero id, x2 - master rank, x3 - GM rank, x4 - skill id
!#VA(heroId:x) (masterLvl:x) (gmLvl:x) (skillId:x);
!!SN:Mi^acm_SkillNames_ArrayId^/(skillId)/?(skillName:z);
!!VRi^H3_%(skillName)_0_Hero%(heroId)^:S(masterLvl);
!!VRi^H3_%(skillName)_1_Hero%(heroId)^:S(gmLvl);

********************************************************************************
!?FU(AC_Set_SS_Description);
!!HEx1:Sx16/?(nativeLevel:y);

!!if&(nativeLevel)>0;
  !!FU(H3_Mod_Check_Skill_Level):Px1/?(masterLvl:y)/?(gmLvl:y)/x16;
  !!if&(masterLvl)/(gmLvl);
    !!VR(strInd:y):Sx16*3 +189700 +2;
    !!VR(strInd)&x16=(SKILL_FIRST_AID):+2;
      !!el&(masterLvl);
    !!VR(strInd:y):Sx16*3 +189700 +1;
    !!VR(strInd)&x16=(SKILL_FIRST_AID):+2;
  !!el;
    !!VR(strInd:y):Sx16*3 +189502;
  !!en;
  !!SN:H^secskill^/x16/3/z(strInd);
!!en;


********************************************************************************
!?FU(H3_Mod_Skill_Loop10);
!!VRx16:Sx2;
!!HEx1:Sx16/?(nativeLevel:y);

!!if&(nativeLevel)>=3;
  !!FU(H3_Mod_Check_Skill_Level):Px1/?(masterLvl:y)/?(gmLvl:y)/x16;

  !!if&(gmLvl)=0;    
    !!VR(strInd:y):Sx16*3 +189701 +(masterLvl);
    !!VR(strInd)&x16=(SKILL_FIRST_AID):+2;
    !!SN:H^secskill^/x16/3/z(strInd);
  !!en;
!!en;


********************************************************************************
!?FU(Set_SS_Skill_Name_and_Text);       [At gamestart]

SET Skill Names
!!VR(strInd:y):S199100;
!!re i/0/(SEC_SKILL_LAST);
  !!SN:H^secskill^/i/0/z(strInd);
  !!VR(strInd):+1;
!!en;

SET Skill Descriptions
!!VR(strInd):S189500;
!!re i/0/(SEC_SKILL_LAST);
  !!re j/(SKILL_BASIC)/(SKILL_EXPERT);
    !!SN:H^secskill^/i/j/z(strInd);                 [Pathfinding]
    !!VR(strInd):+1;
  !!en;
!!en;

********************************************************************************

!?FU(OnHeroGainLevel);
!!HE(CURRENT_HERO):N?(hero:y);
!!FU(acm_AdjustLevelUpPrimarySkills):P(hero); [Adjust Primary Skills for different classes]
!!FU(Set_SS_Skill_Name_and_Text)&(ERM_FLAG_IS_HUMAN):P; [Reset Skill Descriptions to show correct name in level up Screen]

; Set new skill descriptions to display in level-up dialog
!!re i/0/(SEC_SKILL_LAST);
  !!HE(hero):Si/?y50;                   [get hero skill level]
  !!SN:W^ACM_SSkill_%i^/y50;            [Save skill level in variable]
  !!FU(H3_Mod_Skill_Loop10):P(hero)/i;
!!en;

!!FU(acm_BackupAndPrepareSecSkillsForLevelUp):P(hero);
!!FU(acm_RecalcClassPoints):P(hero);

!?FU(OnAfterHeroGainLevel);
!#VA(hero:x);
!!FU(acm_RestoreSecSkillsAndApplyDetectedUpgrades):P(hero);
!!FU(acm_RecalcClassPoints):P(hero);

!?FU(OnGameEnter);
!!VRi^acm_isGameStarted^:S(TRUE); [Activate First Click on Adventure Map activates Dialouge  [Works only after game start]

!?FU(H3_Mod_Assign_Level_UP);

*!IF:M^Now Assign runs with x2 %X2 and x4 %X4  and x1 %X1^;

!!SN&x2=0/x4=0:W^H3_Pathfinding_0_Hero%X1^/1;
!!SN&x2=1/x4=0:W^H3_Pathfinding_1_Hero%X1^/1;
!!SN&x2=0/x4=1:W^H3_Archery_0_Hero%X1^/1;
!!SN&x2=1/x4=1:W^H3_Archery_1_Hero%X1^/1;
!!SN&x2=0/x4=2:W^H3_Logistics_0_Hero%X1^/1;
!!SN&x2=1/x4=2:W^H3_Logistics_1_Hero%X1^/1;
!!SN&x2=0/x4=3:W^H3_Scouting_0_Hero%X1^/1;
!!SN&x2=1/x4=3:W^H3_Scouting_1_Hero%X1^/1;
!!SN&x2=0/x4=4:W^H3_Diplomacy_0_Hero%X1^/1;
!!SN&x2=1/x4=4:W^H3_Diplomacy_1_Hero%X1^/1;
!!SN&x2=0/x4=5:W^H3_Nobility_0_Hero%X1^/1;
!!SN&x2=1/x4=5:W^H3_Nobility_1_Hero%X1^/1;
!!SN&x2=0/x4=6:W^H3_Leadership_0_Hero%X1^/1;
!!SN&x2=1/x4=6:W^H3_Leadership_1_Hero%X1^/1;
!!SN&x2=0/x4=7:W^H3_Wisdom_0_Hero%X1^/1;
!!SN&x2=1/x4=7:W^H3_Wisdom_1_Hero%X1^/1;
!!SN&x2=0/x4=8:W^H3_Mysticism_0_Hero%X1^/1;
!!SN&x2=1/x4=8:W^H3_Mysticism_1_Hero%X1^/1;
!!SN&x2=0/x4=9:W^H3_Luck_0_Hero%X1^/1;
!!SN&x2=1/x4=9:W^H3_Luck_1_Hero%X1^/1;
!!SN&x2=0/x4=10:W^H3_Ballistics_0_Hero%X1^/1;
!!SN&x2=1/x4=10:W^H3_Ballistics_1_Hero%X1^/1;
!!SN&x2=0/x4=11:W^H3_Eagle Eye_0_Hero%X1^/1;
!!SN&x2=1/x4=11:W^H3_Eagle Eye_1_Hero%X1^/1;
!!SN&x2=0/x4=12:W^H3_Necromancy_0_Hero%X1^/1;
!!SN&x2=1/x4=12:W^H3_Necromancy_1_Hero%X1^/1;
!!SN&x2=0/x4=13:W^H3_Estates_0_Hero%X1^/1;
!!SN&x2=1/x4=13:W^H3_Estates_1_Hero%X1^/1;
!!SN&x2=0/x4=14:W^H3_Fire Magic_0_Hero%X1^/1;
!!SN&x2=1/x4=14:W^H3_Fire Magic_1_Hero%X1^/1;
!!SN&x2=0/x4=15:W^H3_Air Magic_0_Hero%X1^/1;
!!SN&x2=1/x4=15:W^H3_Air Magic_1_Hero%X1^/1;
!!SN&x2=0/x4=16:W^H3_Water Magic_0_Hero%X1^/1;
!!SN&x2=1/x4=16:W^H3_Water Magic_1_Hero%X1^/1;
!!SN&x2=0/x4=17:W^H3_Earth Magic_0_Hero%X1^/1;
!!SN&x2=1/x4=17:W^H3_Earth Magic_1_Hero%X1^/1;
!!SN&x2=0/x4=18:W^H3_Scholar_0_Hero%X1^/1;
!!SN&x2=1/x4=18:W^H3_Scholar_1_Hero%X1^/1;
!!SN&x2=0/x4=19:W^H3_Tactics_0_Hero%X1^/1;
!!SN&x2=1/x4=19:W^H3_Tactics_1_Hero%X1^/1;
!!SN&x2=0/x4=20:W^H3_Artillery_0_Hero%X1^/1;
!!SN&x2=1/x4=20:W^H3_Artillery_1_Hero%X1^/1;
!!SN&x2=0/x4=21:W^H3_Learning_0_Hero%X1^/1;
!!SN&x2=1/x4=21:W^H3_Learning_1_Hero%X1^/1;
!!SN&x2=0/x4=22:W^H3_Offense_0_Hero%X1^/1;
!!SN&x2=1/x4=22:W^H3_Offense_1_Hero%X1^/1;
!!SN&x2=0/x4=23:W^H3_Armorer_0_Hero%X1^/1;
!!SN&x2=1/x4=23:W^H3_Armorer_1_Hero%X1^/1;
!!SN&x2=0/x4=24:W^H3_Intelligence_0_Hero%X1^/1;
!!SN&x2=1/x4=24:W^H3_Intelligence_1_Hero%X1^/1;
!!SN&x2=0/x4=25:W^H3_Sorcery_0_Hero%X1^/1;
!!SN&x2=1/x4=25:W^H3_Sorcery_1_Hero%X1^/1;
!!SN&x2=0/x4=26:W^H3_Resistance_0_Hero%X1^/1;
!!SN&x2=1/x4=26:W^H3_Resistance_1_Hero%X1^/1;
!!SN&x2=0/x4=27:W^H3_First Aid_0_Hero%X1^/1;
!!SN&x2=1/x4=27:W^H3_First Aid_1_Hero%X1^/1;

********************************************************************************
!?FU(acm_SyncSkillsNativeAndExtraLevels);
; Ensures, that if any native skill is not on expert level, it loses master/grandmaster levels too
!#VA(hero:x);

!!re i/(SEC_SKILL_FIRST)/(SEC_SKILL_LAST);
  !!HE(hero):Si/?(skillLevel:y);
  !!co&(skillLevel)=(SKILL_EXPERT);
  !!SN:Vi^acm_SkillNames_ArrayId^/i/?(skillName:z);
!!en;

************************Adjust Primary Skills when level up*********************
Fixes the Primary skill level up for Mage Class after level 10. Now they keep higher chance to gain Spell Power and Knowledge
!?FU(acm_AdjustLevelUpPrimarySkills);

!!FU(Valid_Adventurer_Hero):Px1/?y60;   [Call Function to Check if Adventurer Hero]
!!FU&y60=1:E;                           [Not for those Magic Heroes because they are Adventurer]

!!HEx1:E?y10/?y11/1;                    [Get Level]
!!FU&y11<15:E;                          [Exit if level is smaller then 15]
!!HEx1:B2/?y2;                          [Get Class]
!!VRy3:Sy2 %2;
!!if&y3=1;                              [If Mage class]
  !!HL:S?y1/?y50/?y50;                  [Get Primary Skill in y1 and dont change the Secondary Skills]
  !!VRy5:S0R2;                          [Coin Flip 33% to change]
  !!VRy6:S2R1;                          [Flip for Spell Power or Knowledge]
  !!VRy1&y1=0/y5=1:Sy6;                 [If Attack change with 50% chance to Spell Power or Knowledge]
  !!VRy1&y1=1/y5=1:Sy6;                 [If Defense change with 50% chance to Spell Power or Knowledge]
  !!VRy10:S0R3;
  !!VRy1&y6=3/y10=3:S2;                 [If Knowledge was rolled there is a 25% chance that Knowledge gets converted to Spell Power]
  !!HL:Sy1/?y50/?y50;                   [Get Primary Skill in y1 and dont change the Secondary Skills]
!!en;

****************** ADVANCED LEVELS MASTER DIALOGUE *****************************

!?FU(acm_ShowClassPromotionDlg)&(ERM_FLAG_IS_HUMAN)/i^acm_isGameStarted^;
!#VA(hero:x);
!#VA(warriorPoints:x);                  [Optional. If not specified, points will be recalculated]
!#VA(magePoints:x);                     [Optional. If not specified, points will be recalculated]
!#VA(adventurerPoints:x);               [Optional. If not specified, points will be recalculated]

!!HE(hero):O?y1;                        [Checke Hero Owner]
!!OW:Iy1/?y1;                           [AI/Human        1 : AI        0 : Human]
!!FU&y1=1:E;                            [Exit if AI or player Killed]

!!FU:A?k;

!!if&k>=(@adventurerPoints);
  !!VRy10:S(warriorPoints);
  !!VRy20:S(magePoints);
  !!VRy30:S(adventurerPoints);
!!el;
  !!FU(acm_RecalcClassPoints):P(hero)/?y10/?y20/?y30; [Return value for class points from current hero]
!!en;

!!DL266:N^adv_clas.txt^;                [parse dialogue]
!!HE(hero):B2/?y2 R2/?y99 B0/?z4;       [class? / sex?]
!!SN:T^AC_Misc.New Level^/?z-1 Iz-1/?z-1;
!!DL266:A1/3/z-1/1;                     [update text for hero name]
!!SN:T^AC_Misc.Bonus_Level^/?z-2;
!!DL266:A2/3/z-2/1;                     [update text for hero name]

!!SN:W^Adept_Level_Global_Value^/?y90;
!!SN:W^Expert_Level_Global_Value^/?y91;
!!SN:W^Master_Level_Global_Value^/?y92; [Read out global values for Master rank]
!!SN:W^Grandmaster_Level_Global_Value^/?y93; [Read out global values for GM rank]

!!VRy70:S0;
*Decide which Class has highest points*
!!VRy70&y10>y20/y10>y30:S1;             [Warrior]
!!VRy70&y20>y10/y20>y30:S2;             [Mage]
!!VRy70&y30>y20/y30>y10:S3;             [Adventurer]
!!VRy70&y20>=y92/y30>=y92:S6;           [Druid]
!!VRy70&y10>=y92/y20>=y92:S5;           [Battlemage]
!!VRy70&y10>=y92/y30>=y92:S4;           [Hunter]

!!SN&y10>y20/y10>y30:T^AC_Misc.Warrior^/?z-7; [Warrior and Mage]
!!SN&y20>y10/y20>y30:T^AC_Misc.Mage^/?z-7; [Mage and Adventurer]
!!SN&y30>y20/y30>y10:T^AC_Misc.Adventurer^/?z-7; [Adventurer and Warrior]

!!SN&y10>=y92/y20>=y92:T^AC_Misc.Battlemage^/?z-7; [Warrior and Mage, Battlemage]
!!SN&y20>=y92/y30>=y92:T^AC_Misc.Druid^/?z-7; [Mage and Adventurer, Druid]
!!SN&y10>=y92/y30>=y92:T^AC_Misc.Hunter^/?z-7; [Adventurer and Warrior, Hunter]

!!SN|y10>=y90/y20>=y90/y30>=y90:T^AC_Misc.Adept^/?z9; [Get correct level tag]
!!SN|y10>=y91/y20>=y91/y30>=y91:T^AC_Misc.Expert^/?z9;
!!SN|y10>=y92/y20>=y92/y30>=y92:T^AC_Misc.Master^/?z9;
!!SN|y10>=y93/y20>=y93/y30>=y93:T^AC_Misc.Grandmaster^/?z9;

!!VRz9|y70=4/y70=5/y70=6:S^^;           [for Hybrid class delete Master/Grandmaster tag]
!!VRz-5:S^%Z9 %Z-7^;                    [set z-7 to combination of rank and class]

!!DL266:A4/3/z-5/1;                     [show correct level name]

* set advanced levels picture
!!HEx1:B2/?y2  R2/?y99;                 [class?]
!!VRz-4&y99=0:S^m^; !!VRz-4&y99=1:S^w^; [Set for female or male]

* set advanced level skills and pictures
!!SN:W^Classic_Skin_Mod^/?y50;          [Check if Skin Option activated]

!!if&y70=1/y10>=y92/y10<y93;            [For Master Warrior]
!!VRy95:S1;                             [Set to Master Training I 1]
!!VRy96:S36;                            [Set to Critical Hit I 36]
!!VRz-7:S^skill%Y95.pcx^; !!VRz-7&y50=1:S^skill%Y95C.pcx^; [Set z-7 to correct name]
!!VRz-8:S^skill%Y96.pcx^; !!VRz-8&y50=1:S^skill%Y96C.pcx^; [Set z-8 to correct name]
!!DL266:A50/11/z-7/1;                   [Show picture number 50]
!!DL266:A51/11/z-8/1;                   [Show picture number 51]
!!SN:W^Master_Picture^/?y25;
!!VRz-3:S^MWar%Y25%Z-4.pcx^;            [level pcx name]
!!DL266:A19/11/z-3/1;                   [show big picture]
!!VRz-5:Sz189586;
!!DL266:A3/3/z-5/1;                     [show correct skill text what can be leveled]
!!if&y50=0;
  !!SN:T^AC_Misc.M_Warrior_Skill_1^/?z20;
  !!SN:T^AC_Misc.M_Warrior_Skill_2^/?z21;
  !!DL266:A60/3/z20/1;
  !!DL266:A61/3/z21/1;
!!en;
!!en;

!!if&y70=1/y10>=y93;                    [For Grandmaster Warrior]
!!VRy95:S5;                             [Set to Master Training II 1 (Elite Soldier)]
!!VRy96:S80;                            [Set to Critical Hit II 80]
!!VRy97:S44;                            [Set to Endure Pain 44]
!!VRy98:S52;                            [Set to Commanders 52]
!!VRz-7:S^skill%Y95.pcx^; !!VRz-7&y50=1:S^skill%Y95C.pcx^; [Set z-7 to correct name]
!!VRz-8:S^skill%Y96.pcx^; !!VRz-8&y50=1:S^skill%Y96C.pcx^; [Set z-8 to correct name]
!!VRz-9:S^skill%Y97.pcx^; !!VRz-9&y50=1:S^skill%Y97C.pcx^; [Set z-9 to correct name]
!!VRz-10:S^skill%Y98.pcx^; !!VRz-10&y50=1:S^skill%Y98C.pcx^; [Set z-10 to correct name]
!!DL266:A50/11/z-7/1;
!!DL266:A51/11/z-8/1;
!!DL266:A52/11/z-9/1;
!!DL266:A53/11/z-10/1;
!!SN:W^Grandmaster_Picture^/?y25;
!!VRz-3:S^GMWar%Y25%Z-4.pcx^;           [level pcx name]
!!DL266:A19/11/z-3/1;                   [show big picture]
!!VRz-5:Sz189587;
!!DL266:A3/3/z-5/1;                     [show correct skill text what can be leveled]
!!if&y50=0;
  !!SN:T^AC_Misc.GM_Warrior_Skill_1^/?z20;
  !!SN:T^AC_Misc.GM_Warrior_Skill_2^/?z21;
  !!SN:T^AC_Misc.GM_Warrior_Skill_3^/?z22;
  !!SN:T^AC_Misc.GM_Warrior_Skill_4^/?z23;
  !!DL266:A60/3/z20/1;
  !!DL266:A61/3/z21/1;
  !!DL266:A62/3/z22/1;
  !!DL266:A63/3/z23/1;
!!en;
!!en;

!!if&y70=2/y20>=y92/y20<y93;            [For Master Mage]
!!VRy95:S53;                            [Set to Master Power 53 (Extra Cast I)]
!!VRy96:S70;                            [Set to Elemental Resistance 70]
!!VRz-7:S^skill%Y95.pcx^; !!VRz-7&y50=1:S^skill%Y95C.pcx^; [Set z-7 to correct name]
!!VRz-8:S^skill%Y96.pcx^; !!VRz-8&y50=1:S^skill%Y96C.pcx^; [Set z-8 to correct name]
!!DL266:A50/11/z-7/1;
!!DL266:A51/11/z-8/1;
!!SN:W^Master_Picture^/?y25;
!!VRz-3:S^MMage%Y25%Z-4.pcx^;           [level pcx name]
!!DL266:A19/11/z-3/1;                   [show big picture]
!!VRz-5:Sz189589;
!!DL266:A3/3/z-5/1;                     [show correct skill text what can be leveled]
!!if&y50=0;
  !!SN:T^AC_Misc.M_Mage_Skill_1^/?z20;
  !!SN:T^AC_Misc.M_Mage_Skill_2^/?z21;
  !!DL266:A60/3/z20/1;
  !!DL266:A61/3/z21/1;
!!en;
!!en;

!!if&y70=2/y20>=y93;                    [For GrandMaster Mage]
!!VRy95:S56;                            [Set to Spell Braiding 53 (Extra Cast II)]
!!VRy96:S70;                            [Set to Elemental Resistance 70]
!!VRy97:S47;                            [Set to Arkane Prophet 47]
!!VRy98:S55;                            [Set to Channeling 24]
!!VRz-7:S^skill%Y95.pcx^; !!VRz-7&y50=1:S^skill%Y95C.pcx^; [Set z-7 to correct name]
!!VRz-8:S^skill%Y96.pcx^; !!VRz-8&y50=1:S^skill%Y96C.pcx^; [Set z-8 to correct name]
!!VRz-9:S^skill%Y97.pcx^; !!VRz-9&y50=1:S^skill%Y97C.pcx^; [Set z-9 to correct name]
!!VRz-10:S^skill%Y98.pcx^; !!VRz-10&y50=1:S^skill%Y98C.pcx^; [Set z-10 to correct name]
!!DL266:A50/11/z-7/1;
!!DL266:A51/11/z-8/1;
!!DL266:A52/11/z-9/1;
!!DL266:A53/11/z-10/1;
!!SN:W^Grandmaster_Picture^/?y25;
!!VRz-3:S^GMMage%Y25%Z-4.pcx^;          [level pcx name]
!!DL266:A19/11/z-3/1;                   [show big picture]
!!VRz-5:Sz189590;
!!DL266:A3/3/z-5/1;                     [show correct skill text what can be leveled]
!!if&y50=0;
  !!SN:T^AC_Misc.GM_Mage_Skill_1^/?z20;
  !!SN:T^AC_Misc.GM_Mage_Skill_2^/?z21;
  !!SN:T^AC_Misc.GM_Mage_Skill_3^/?z22;
  !!SN:T^AC_Misc.GM_Mage_Skill_4^/?z23;
  !!DL266:A60/3/z20/1;
  !!DL266:A61/3/z21/1;
  !!DL266:A62/3/z22/1;
  !!DL266:A63/3/z23/1;
!!en;
!!en;

!!if&y70=3/y30>=y92/y30<y93;            [For Master Adventurer]
!!VRy95:S50;                            [Set to War Path I 50]
!!VRy96:S58;                            [Set to Horsemaster 58 (Lord)]
!!VRz-7:S^skill%Y95.pcx^; !!VRz-7&y50=1:S^skill%Y95C.pcx^; [Set z-7 to correct name]
!!VRz-8:S^skill%Y96.pcx^; !!VRz-8&y50=1:S^skill%Y96C.pcx^; [Set z-8 to correct name]
!!DL266:A50/11/z-7/1;
!!DL266:A51/11/z-8/1;
!!SN:W^Master_Picture^/?y25;
!!VRz-3:S^MAdv%Y25%Z-4.pcx^;            [level pcx name]
!!DL266:A19/11/z-3/1;                   [show big picture]
!!VRz-5:Sz189592;
!!DL266:A3/3/z-5/1;                     [show correct skill text what can be leveled]
!!if&y50=0;
  !!SN:T^AC_Misc.M_Adv_Skill_1^/?z20;
  !!SN:T^AC_Misc.M_Adv_Skill_2^/?z21;
  !!DL266:A60/3/z20/1;
  !!DL266:A61/3/z21/1;
!!en;
!!en;

!!if&y70=3/y30>=y93;                    [For GrandMaster Adventurer]
!!VRy95:S81;                            [Set to War Path II 50]
!!VRy96:S11;                            [Set to Benediction 2 (Landlord)]
!!VRy97:S49;                            [Set to Strength in Numbers 49]
!!VRy98:S43;                            [Set to Coordinated Attack 43]
!!VRz-7:S^skill%Y95.pcx^; !!VRz-7&y50=1:S^skill%Y95C.pcx^; [Set z-7 to correct name]
!!VRz-8:S^skill%Y96.pcx^; !!VRz-8&y50=1:S^skill%Y96C.pcx^; [Set z-8 to correct name]
!!VRz-9:S^skill%Y97.pcx^; !!VRz-9&y50=1:S^skill%Y97C.pcx^; [Set z-9 to correct name]
!!VRz-10:S^skill%Y98.pcx^; !!VRz-10&y50=1:S^skill%Y98C.pcx^; [Set z-10 to correct name]
!!DL266:A50/11/z-7/1;
!!DL266:A51/11/z-8/1;
!!DL266:A52/11/z-9/1;
!!DL266:A53/11/z-10/1;
!!SN:W^Grandmaster_Picture^/?y25;
!!VRz-3:S^GMAdv%Y25%Z-4.pcx^;           [level pcx name]
!!DL266:A19/11/z-3/1;                   [show big picture]
!!VRz-5:Sz189593;
!!DL266:A3/3/z-5/1;                     [show correct skill text what can be leveled]
!!if&y50=0;
  !!SN:T^AC_Misc.GM_Adv_Skill_1^/?z20;
  !!SN:T^AC_Misc.GM_Adv_Skill_2^/?z21;
  !!SN:T^AC_Misc.GM_Adv_Skill_3^/?z22;
  !!SN:T^AC_Misc.GM_Adv_Skill_4^/?z23;
  !!DL266:A60/3/z20/1;
  !!DL266:A61/3/z21/1;
  !!DL266:A62/3/z22/1;
  !!DL266:A63/3/z23/1;
!!en;
!!en;

!!if&y70=4;                             [For Hunter]
!!VRy95:S1;                             [Set to Master Training I 1]
!!VRy96:S50;                            [Set to War Path 50]
!!VRy97:S10;                            [Set to Rapid Shot 10]
!!VRy98:S21;                            [Set to Irresistable Magic 21 (Magic Block)]
!!VRz-7:S^skill%Y95.pcx^; !!VRz-7&y50=1:S^skill%Y95C.pcx^; [Set z-7 to correct name]
!!VRz-8:S^skill%Y96.pcx^; !!VRz-8&y50=1:S^skill%Y96C.pcx^; [Set z-8 to correct name]
!!VRz-9:S^skill%Y97.pcx^; !!VRz-9&y50=1:S^skill%Y97C.pcx^; [Set z-9 to correct name]
!!VRz-10:S^skill%Y98.pcx^; !!VRz-10&y50=1:S^skill%Y98C.pcx^; [Set z-10 to correct name]
!!DL266:A50/11/z-7/1;
!!DL266:A51/11/z-8/1;
!!DL266:A52/11/z-9/1;
!!DL266:A53/11/z-10/1;
!!SN:W^Grandmaster_Picture^/?y25;
!!VRz-3:S^Hunter%Y25%Z-4.pcx^;          [level pcx name]
!!DL266:A19/11/z-3/1;                   [show big picture]
!!VRz-5:Sz189596;
!!DL266:A3/3/z-5/1;                     [show correct skill text what can be leveled]
!!if&y50=0;
  !!SN:T^AC_Misc.Hunter_Skill_1^/?z20;
  !!SN:T^AC_Misc.Hunter_Skill_2^/?z21;
  !!SN:T^AC_Misc.Hunter_Skill_3^/?z22;
  !!SN:T^AC_Misc.Hunter_Skill_4^/?z23;
  !!DL266:A60/3/z20/1;
  !!DL266:A61/3/z21/1;
  !!DL266:A62/3/z22/1;
  !!DL266:A63/3/z23/1;
!!en;
!!en;

!!if&y70=5;                             [For Battlemage]
!!VRy95:S53;                            [Set to Master Power 53]
!!VRy96:S1;                             [Set to Master Training 1]
!!VRy97:S75;                            [Set to Precast 75]
!!VRy98:S37;                            [Set to Intimidation (Warcry)]
!!VRz-7:S^skill%Y95.pcx^; !!VRz-7&y50=1:S^skill%Y95C.pcx^; [Set z-7 to correct name]
!!VRz-8:S^skill%Y96.pcx^; !!VRz-8&y50=1:S^skill%Y96C.pcx^; [Set z-8 to correct name]
!!VRz-9:S^skill%Y97.pcx^; !!VRz-9&y50=1:S^skill%Y97C.pcx^; [Set z-9 to correct name]
!!VRz-10:S^skill%Y98.pcx^; !!VRz-10&y50=1:S^skill%Y98C.pcx^; [Set z-10 to correct name]^;]
!!DL266:A50/11/z-7/1;
!!DL266:A51/11/z-8/1;
!!DL266:A52/11/z-9/1;
!!DL266:A53/11/z-10/1;
!!SN:W^Grandmaster_Picture^/?y25;
!!VRz-3:S^BM%Y25%Z-4.pcx^;              [level pcx name]
!!DL266:A19/11/z-3/1;                   [show big picture]
!!VRz-5:Sz189595;
!!DL266:A3/3/z-5/1;                     [show correct skill text what can be leveled]
!!if&y50=0;
  !!SN:T^AC_Misc.Battlemage_Skill_1^/?z20;
  !!SN:T^AC_Misc.Battlemage_Skill_2^/?z21;
  !!SN:T^AC_Misc.Battlemage_Skill_3^/?z22;
  !!SN:T^AC_Misc.Battlemage_Skill_4^/?z23;
  !!DL266:A60/3/z20/1;
  !!DL266:A61/3/z21/1;
  !!DL266:A62/3/z22/1;
  !!DL266:A63/3/z23/1;
!!en;
!!en;

!!if&y70=6;                             [For Druid]
!!VRy95:S53;                            [Set to Master Power 53]
!!VRy96:S63;                            [Set to Herbalism 63 (Natrual Healer)]
!!VRy97:S68;                            [Set to Ethereal 68 (Stone/Hard Skin)]
!!VRy98:S61;                            [Set to Concentration 61 (replaces War Path)]
!!VRz-7:S^skill%Y95.pcx^; !!VRz-7&y50=1:S^skill%Y95C.pcx^; [Set z-7 to correct name]
!!VRz-8:S^skill%Y96.pcx^; !!VRz-8&y50=1:S^skill%Y96C.pcx^; [Set z-8 to correct name]
!!VRz-9:S^skill%Y97.pcx^; !!VRz-9&y50=1:S^skill%Y97C.pcx^; [Set z-9 to correct name]
!!VRz-10:S^skill%Y98.pcx^; !!VRz-10&y50=1:S^skill%Y98C.pcx^; [Set z-10 to correct name]
!!DL266:A50/11/z-7/1;
!!DL266:A51/11/z-8/1;
!!DL266:A52/11/z-9/1;
!!DL266:A53/11/z-10/1;
!!SN:W^Grandmaster_Picture^/?y25;
!!VRz-3:S^Druid%Y25%Z-4.pcx^;           [level pcx name]
!!DL266:A19/11/z-3/1;                   [show big picture]
!!VRz-5:Sz189597;
!!DL266:A3/3/z-5/1;                     [show correct skill text what can be leveled]
!!if&y50=0;
  !!SN:T^AC_Misc.Druid_Skill_1^/?z20;
  !!SN:T^AC_Misc.Druid_Skill_2^/?z21;
  !!SN:T^AC_Misc.Druid_Skill_3^/?z22;
  !!SN:T^AC_Misc.Druid_Skill_4^/?z23;
  !!DL266:A60/3/z20/1;
  !!DL266:A61/3/z21/1;
  !!DL266:A62/3/z22/1;
  !!DL266:A63/3/z23/1;
!!en;
!!en;

!!VRz-3&x1=152:S^Roland.pcx^;           [Special Heroes get Special Pictures]
!!VRz-3&x1=146:S^Catherin.pcx^;         [Special Heroes get Special Pictures]
!!VRz-3&x1=74:S^Sandro.pcx^;            [Special Heroes get Special Pictures]
!!DL266|x1=152/x1=146/x1=74:A19/11/z-3/1;[show big picture]

!!VRz-9:S^ULTIMATEARTIFACT.wav^;
!!SN:Pz-9;                              [play quest sound before showing dialogue]
!!DL266:S;                              [show dialogue]

Close Dialouge
!?DL&v998=266/v999=30722/v1000=13;
!!DL:C1;


!#VRy1:S1R9; !#VRy2:S1R5;               [Set Random Class Picture on Map start]
!#SN:W^Master_Picture^/y1;
!#SN:W^Grandmaster_Picture^/y2;


--------------------------------------------------------------------------------
************************* HERO SCREEN CLICK DIALOGUE ***************
!?FU(acm_Dlg_HeroClass_Prepare);
!!HE-1:N?y1;
!!FU(acm_RecalcClassPoints):Py1/?y10/?y20/?y30; [Return value for class points from current hero]

!!SN:W^Adept_Level_Global_Value^/?y90;
!!SN:W^Expert_Level_Global_Value^/?y91;
!!SN:W^Master_Level_Global_Value^/?y92; [Read out global values for Master rank]
!!SN:W^Grandmaster_Level_Global_Value^/?y93; [Read out global values for GM rank]

!!if&y10<y92/y20<y92/y30<y92;
  !!SN:T^AC_Misc.No_advance^/?z1;
  !!IF:M1/z1;
  !!CM:R0;
  !!FU:E;                               [If no requirements met Exit Fkt]
!!en;

!!CM:R0;

* PREPARE ADVANCED LEVELS DIALOGUE
!!UN:C7505216/1/2;                      [before DLG ini - remove shadow]

!!SN:F^PluginExists^/^10sskills^;       [Check for 10 SSkill Plugin]
!!DL667&v1=0:N^Her_Scre.txt^;
!!DL667&v1=1:N^Her_Scre2.txt^;          [load different dl if playing with 10skills plugin]

!!HEy1:B0/?z-1;                         [name of hero]
!!HEy1:Ed/?y5;                          [level of hero]
!!HEy1:B2/?y2 N?y3 O?y14;               [class of hero  / hero number /owner]

* set class name for level text box

!!SN&y2=0:T^AC_Misc.Class_Knight^/?z-7;
!!SN&y2=1:T^AC_Misc.Class_Cleric^/?z-7;
!!SN&y2=2:T^AC_Misc.Class_Ranger^/?z-7;
!!SN&y2=3:T^AC_Misc.Class_Druid^/?z-7;
!!SN&y2=4:T^AC_Misc.Class_Alchemist^/?z-7;
!!SN&y2=5:T^AC_Misc.Class_Wizard^/?z-7;

!!SN&y2=6:T^AC_Misc.Class_Demoniac^/?z-7;
!!SN&y2=7:T^AC_Misc.Class_Heretic^/?z-7;
!!SN&y2=8:T^AC_Misc.Class_Death Knight^/?z-7;
!!SN&y2=9:T^AC_Misc.Class_Necromancer^/?z-7;
!!SN&y2=10:T^AC_Misc.Class_Warlock^/?z-7;
!!SN&y2=11:T^AC_Misc.Class_Overlord^/?z-7;

!!SN&y2=12:T^AC_Misc.Class_Barbarian^/?z-7;
!!SN&y2=13:T^AC_Misc.Class_Battle Mage^/?z-7;
!!SN&y2=14:T^AC_Misc.Class_Beastmaster^/?z-7;
!!SN&y2=15:T^AC_Misc.Class_Witch^/?z-7;
!!SN&y2=16:T^AC_Misc.Class_Planeswalker^/?z-7;
!!SN&y2=17:T^AC_Misc.Class_Elementalist^/?z-7;

!!SN:T^AC_Misc.HS_Level^/?z-2 Iz-2/?z-2;


!!VRy70:S0;
*Decide which Class has highest points*
!!VRy70&y10>y20/y10>y30:S1;             [Warrior]
!!VRy70&y20>y10/y20>y30:S2;             [Mage]
!!VRy70&y30>y20/y30>y10:S3;             [Adventurer]
!!VRy70&y20>=y92/y30>=y92:S6;           [Druid]
!!VRy70&y10>=y92/y20>=y92:S5;           [Battlemage]
!!VRy70&y10>=y92/y30>=y92:S4;           [Hunter]

!!SN&y10>y20/y10>y30:T^AC_Misc.Warrior^/?z-7; [Warrior and Mage]
!!SN&y20>y10/y20>y30:T^AC_Misc.Mage^/?z-7; [Mage and Adventurer]
!!SN&y30>y20/y30>y10:T^AC_Misc.Adventurer^/?z-7; [Adventurer and Warrior]

!!SN&y10>=y92/y20>=y92:T^AC_Misc.Battlemage^/?z-7; [Warrior and Mage, Battlemage]
!!SN&y20>=y92/y30>=y92:T^AC_Misc.Druid^/?z-7; [Mage and Adventurer, Druid]
!!SN&y10>=y92/y30>=y92:T^AC_Misc.Hunter^/?z-7; [Adventurer and Warrior, Hunter]

!!SN|y10>=y90/y20>=y90/y30>=y90:T^AC_Misc.Adept^/?z9; [Get correct level tag]
!!SN|y10>=y91/y20>=y91/y30>=y91:T^AC_Misc.Expert^/?z9;
!!SN|y10>=y92/y20>=y92/y30>=y92:T^AC_Misc.Master^/?z9;
!!SN|y10>=y93/y20>=y93/y30>=y93:T^AC_Misc.Grandmaster^/?z9;

!!VRz9|y70=4/y70=5/y70=6:S^^;           [for Hybrid class delete Master/Grandmaster tag]
!!VRz-5:S^%Z9 %Z-7^;                    [set z-7 to combination of rank and class]
!!DL667:A20/3/z-5/1;                    [show correct level name]

* set advanced levels picture
!!HEy1:B2/?y2  R2/?y99;                 [class?]
!!VRz-4&y99=0:S^m^; !!VRz-4&y99=1:S^w^; [Set for female or male]

!!SN&y10>=y93:T^AC_Misc.Grandmaster^/?z6; !!SN&y10<y93:T^AC_Misc.Master^/?z6; !!SN&y10<y92:T^AC_Misc.Expert^/?z6; !!SN&y10<y91:T^AC_Misc.Adept^/?z6;
!!SN&y20>=y93:T^AC_Misc.Grandmaster^/?z7; !!SN&y20<y93:T^AC_Misc.Master^/?z7; !!SN&y20<y92:T^AC_Misc.Expert^/?z7; !!SN&y20<y91:T^AC_Misc.Adept^/?z7;
!!SN&y30>=y93:T^AC_Misc.Grandmaster^/?z8; !!SN&y30<y93:T^AC_Misc.Master^/?z8; !!SN&y30<y92:T^AC_Misc.Expert^/?z8; !!SN&y30<y91:T^AC_Misc.Adept^/?z8;
!!SN:T^AC_Misc.Warrior^/?z3;
!!SN:T^AC_Misc.Mage^/?z4;
!!SN:T^AC_Misc.Adventurer^/?z5;

!!FU(acm_RecalcClassPoints):Py1/?m/?n/?p/(TRUE);
!!VRz-6:S^%Z6 {~r}%Z3 %m{~}
%Z7 {~DodgerBlue}%Z4 %n{~}
%Z8 {~LimeGreen}%Z5 %p{~}^;
!!DL667:A33/3/z-6/1;                    [show class points under big picture]

!!VRz-4&y99=0:S^m^; !!VRz-4&y99=1:S^w^; [Set for female or male]

* set advanced level skills and pictures
!!SN:W^Classic_Skin_Mod^/?y50;          [Check if Skin Option activated]

!!if&y70=1/y10>=y92/y10<y93;            [For Master Warrior]
  !!VRy95:S1;                           [Set to Master Training I 1]
  !!VRy96:S36;                          [Set to Critical Hit I 36]
  !!VRz-7:S^skill%Y95.pcx^; !!VRz-7&y50=1:S^skill%Y95C.pcx^; [Set z-7 to correct name]
  !!VRz-8:S^skill%Y96.pcx^; !!VRz-8&y50=1:S^skill%Y96C.pcx^; [Set z-8 to correct name]
  !!DL667:A50/11/z-7/1;                 [Show picture number 50]
  !!DL667:A51/11/z-8/1;                 [Show picture number 51]
  !!SN:W^Master_Picture^/?y25;
  !!VRz-3:S^MWar%Y25%Z-4.pcx^;          [level pcx name]
  !!DL667:A19/11/z-3/1;                 [show big picture]
  !!VRz-5:Sz189586;
  !!DL667:A3/3/z-5/1;                   [show correct skill text what can be leveled]
  !!if&y50=0;
    !!SN:T^AC_Misc.M_Warrior_Skill_1^/?z20;
    !!SN:T^AC_Misc.M_Warrior_Skill_2^/?z21;
    !!DL667:A60/3/z20/1;
    !!DL667:A61/3/z21/1;
  !!en;
!!en;

!!if&y70=1/y10>=y93;                    [For Grandmaster Warrior]
  !!VRy95:S5;                           [Set to Master Training II 1 (Elite Soldier)]
  !!VRy96:S80;                          [Set to Critical Hit II 80]
  !!VRy97:S44;                          [Set to Endure Pain 44]
  !!VRy98:S52;                          [Set to Commanders 52]
  !!VRz-7:S^skill%Y95.pcx^; !!VRz-7&y50=1:S^skill%Y95C.pcx^; [Set z-7 to correct name]
  !!VRz-8:S^skill%Y96.pcx^; !!VRz-8&y50=1:S^skill%Y96C.pcx^; [Set z-8 to correct name]
  !!VRz-9:S^skill%Y97.pcx^; !!VRz-9&y50=1:S^skill%Y97C.pcx^; [Set z-9 to correct name]
  !!VRz-10:S^skill%Y98.pcx^; !!VRz-10&y50=1:S^skill%Y98C.pcx^; [Set z-10 to correct name]
  !!DL667:A50/11/z-7/1;
  !!DL667:A51/11/z-8/1;
  !!DL667:A52/11/z-9/1;
  !!DL667:A53/11/z-10/1;
  !!SN:W^Grandmaster_Picture^/?y25;
  !!VRz-3:S^GMWar%Y25%Z-4.pcx^;         [level pcx name]
  !!DL667:A19/11/z-3/1;                 [show big picture]
  !!VRz-5:Sz189587;
  !!DL667:A3/3/z-5/1;                   [show correct skill text what can be leveled]
  !!if&y50=0;
    !!SN:T^AC_Misc.GM_Warrior_Skill_1^/?z20;
    !!SN:T^AC_Misc.GM_Warrior_Skill_2^/?z21;
    !!SN:T^AC_Misc.GM_Warrior_Skill_3^/?z22;
    !!SN:T^AC_Misc.GM_Warrior_Skill_4^/?z23;
    !!DL667:A60/3/z20/1;
    !!DL667:A61/3/z21/1;
    !!DL667:A62/3/z22/1;
    !!DL667:A63/3/z23/1;
  !!en;
!!en;

!!if&y70=2/y20>=y92/y20<y93;            [For Master Mage]
  !!VRy95:S53;                          [Set to Master Power 53 (Extra Cast I)]
  !!VRy96:S70;                          [Set to Elemental Resistance 70]
  !!VRz-7:S^skill%Y95.pcx^; !!VRz-7&y50=1:S^skill%Y95C.pcx^; [Set z-7 to correct name]
  !!VRz-8:S^skill%Y96.pcx^; !!VRz-8&y50=1:S^skill%Y96C.pcx^; [Set z-8 to correct name]
  !!DL667:A50/11/z-7/1;
  !!DL667:A51/11/z-8/1;
  !!SN:W^Master_Picture^/?y25;
  !!VRz-3:S^MMage%Y25%Z-4.pcx^;         [level pcx name]
  !!DL667:A19/11/z-3/1;                 [show big picture]
  !!VRz-5:Sz189589;
  !!DL667:A3/3/z-5/1;                   [show correct skill text what can be leveled]
  !!if&y50=0;
    !!SN:T^AC_Misc.M_Mage_Skill_1^/?z20;
    !!SN:T^AC_Misc.M_Mage_Skill_2^/?z21;
    !!DL667:A60/3/z20/1;
    !!DL667:A61/3/z21/1;
  !!en;
!!en;

!!if&y70=2/y20>=y93;                    [For GrandMaster Mage]
  !!VRy95:S56;                          [Set to Spell Braiding 53 (Extra Cast II)]
  !!VRy96:S70;                          [Set to Elemental Resistance 70]
  !!VRy97:S47;                          [Set to Arkane Prophet 47]
  !!VRy98:S55;                          [Set to Channeling 24]
  !!VRz-7:S^skill%Y95.pcx^; !!VRz-7&y50=1:S^skill%Y95C.pcx^; [Set z-7 to correct name]
  !!VRz-8:S^skill%Y96.pcx^; !!VRz-8&y50=1:S^skill%Y96C.pcx^; [Set z-8 to correct name]
  !!VRz-9:S^skill%Y97.pcx^; !!VRz-9&y50=1:S^skill%Y97C.pcx^; [Set z-9 to correct name]
  !!VRz-10:S^skill%Y98.pcx^; !!VRz-10&y50=1:S^skill%Y98C.pcx^; [Set z-10 to correct name]
  !!DL667:A50/11/z-7/1;
  !!DL667:A51/11/z-8/1;
  !!DL667:A52/11/z-9/1;
  !!DL667:A53/11/z-10/1;
  !!SN:W^Grandmaster_Picture^/?y25;
  !!VRz-3:S^GMMage%Y25%Z-4.pcx^;        [level pcx name]
  !!DL667:A19/11/z-3/1;                 [show big picture]
  !!VRz-5:Sz189590;
  !!DL667:A3/3/z-5/1;                   [show correct skill text what can be leveled]
  !!if&y50=0;
    !!SN:T^AC_Misc.GM_Mage_Skill_1^/?z20;
    !!SN:T^AC_Misc.GM_Mage_Skill_2^/?z21;
    !!SN:T^AC_Misc.GM_Mage_Skill_3^/?z22;
    !!SN:T^AC_Misc.GM_Mage_Skill_4^/?z23;
    !!DL667:A60/3/z20/1;
    !!DL667:A61/3/z21/1;
    !!DL667:A62/3/z22/1;
    !!DL667:A63/3/z23/1;
  !!en;
!!en;

!!if&y70=3/y30>=y92/y30<y93;            [For Master Adventurer]
  !!VRy95:S50;                          [Set to War Path I 50]
  !!VRy96:S58;                          [Set to Horsemaster 58 (Lord)]
  !!VRz-7:S^skill%Y95.pcx^; !!VRz-7&y50=1:S^skill%Y95C.pcx^; [Set z-7 to correct name]
  !!VRz-8:S^skill%Y96.pcx^; !!VRz-8&y50=1:S^skill%Y96C.pcx^; [Set z-8 to correct name]
  !!DL667:A50/11/z-7/1;
  !!DL667:A51/11/z-8/1;
  !!SN:W^Master_Picture^/?y25;
  !!VRz-3:S^MAdv%Y25%Z-4.pcx^;          [level pcx name]
  !!DL667:A19/11/z-3/1;                 [show big picture]
  !!VRz-5:Sz189592;
  !!DL667:A3/3/z-5/1;                   [show correct skill text what can be leveled]
  !!if&y50=0;
    !!SN:T^AC_Misc.M_Adv_Skill_1^/?z20;
    !!SN:T^AC_Misc.M_Adv_Skill_2^/?z21;
    !!DL667:A60/3/z20/1;
    !!DL667:A61/3/z21/1;
  !!en;
!!en;

!!if&y70=3/y30>=y93;                    [For GrandMaster Adventurer]
  !!VRy95:S81;                          [Set to War Path II 50]
  !!VRy96:S11;                          [Set to Benediction 2 (Landlord)]
  !!VRy97:S49;                          [Set to Strength in Numbers 49]
  !!VRy98:S43;                          [Set to Coordinated Attack 43]
  !!VRz-7:S^skill%Y95.pcx^; !!VRz-7&y50=1:S^skill%Y95C.pcx^; [Set z-7 to correct name]
  !!VRz-8:S^skill%Y96.pcx^; !!VRz-8&y50=1:S^skill%Y96C.pcx^; [Set z-8 to correct name]
  !!VRz-9:S^skill%Y97.pcx^; !!VRz-9&y50=1:S^skill%Y97C.pcx^; [Set z-9 to correct name]
  !!VRz-10:S^skill%Y98.pcx^; !!VRz-10&y50=1:S^skill%Y98C.pcx^; [Set z-10 to correct name]
  !!DL667:A50/11/z-7/1;
  !!DL667:A51/11/z-8/1;
  !!DL667:A52/11/z-9/1;
  !!DL667:A53/11/z-10/1;
  !!SN:W^Grandmaster_Picture^/?y25;
  !!VRz-3:S^GMAdv%Y25%Z-4.pcx^;         [level pcx name]
  !!DL667:A19/11/z-3/1;                 [show big picture]
  !!VRz-5:Sz189593;
  !!DL667:A3/3/z-5/1;                   [show correct skill text what can be leveled]
  !!if&y50=0;
    !!SN:T^AC_Misc.GM_Adv_Skill_1^/?z20;
    !!SN:T^AC_Misc.GM_Adv_Skill_2^/?z21;
    !!SN:T^AC_Misc.GM_Adv_Skill_3^/?z22;
    !!SN:T^AC_Misc.GM_Adv_Skill_4^/?z23;
    !!DL667:A60/3/z20/1;
    !!DL667:A61/3/z21/1;
    !!DL667:A62/3/z22/1;
    !!DL667:A63/3/z23/1;
  !!en;
!!en;

!!if&y70=4;                             [For Hunter]
  !!VRy95:S1;                           [Set to Master Training I 1]
  !!VRy96:S50;                          [Set to War Path 50]
  !!VRy97:S10;                          [Set to Rapid Shot 10]
  !!VRy98:S21;                          [Set to Irresistable Magic 21 (Magic Block)]
  !!VRz-7:S^skill%Y95.pcx^; !!VRz-7&y50=1:S^skill%Y95C.pcx^; [Set z-7 to correct name]
  !!VRz-8:S^skill%Y96.pcx^; !!VRz-8&y50=1:S^skill%Y96C.pcx^; [Set z-8 to correct name]
  !!VRz-9:S^skill%Y97.pcx^; !!VRz-9&y50=1:S^skill%Y97C.pcx^; [Set z-9 to correct name]
  !!VRz-10:S^skill%Y98.pcx^; !!VRz-10&y50=1:S^skill%Y98C.pcx^; [Set z-10 to correct name]
  !!DL667:A50/11/z-7/1;
  !!DL667:A51/11/z-8/1;
  !!DL667:A52/11/z-9/1;
  !!DL667:A53/11/z-10/1;
  !!SN:W^Grandmaster_Picture^/?y25;
  !!VRz-3:S^Hunter%Y25%Z-4.pcx^;        [level pcx name]
  !!DL667:A19/11/z-3/1;                 [show big picture]
  !!VRz-5:Sz189596;
  !!DL667:A3/3/z-5/1;                   [show correct skill text what can be leveled]
  !!if&y50=0;
    !!SN:T^AC_Misc.Hunter_Skill_1^/?z20;
    !!SN:T^AC_Misc.Hunter_Skill_2^/?z21;
    !!SN:T^AC_Misc.Hunter_Skill_3^/?z22;
    !!SN:T^AC_Misc.Hunter_Skill_4^/?z23;
    !!DL667:A60/3/z20/1;
    !!DL667:A61/3/z21/1;
    !!DL667:A62/3/z22/1;
    !!DL667:A63/3/z23/1;
  !!en;
!!en;

!!if&y70=5;                             [For Battlemage]
  !!VRy95:S53;                          [Set to Master Power 53]
  !!VRy96:S1;                           [Set to Master Training 1]
  !!VRy97:S75;                          [Set to Precast 75]
  !!VRy98:S37;                          [Set to Intimidation (Warcry)]
  !!VRz-7:S^skill%Y95.pcx^; !!VRz-7&y50=1:S^skill%Y95C.pcx^; [Set z-7 to correct name]
  !!VRz-8:S^skill%Y96.pcx^; !!VRz-8&y50=1:S^skill%Y96C.pcx^; [Set z-8 to correct name]
  !!VRz-9:S^skill%Y97.pcx^; !!VRz-9&y50=1:S^skill%Y97C.pcx^; [Set z-9 to correct name]
  !!VRz-10:S^skill%Y98.pcx^; !!VRz-10&y50=1:S^skill%Y98C.pcx^; [Set z-10 to correct name]^;]
  !!DL667:A50/11/z-7/1;
  !!DL667:A51/11/z-8/1;
  !!DL667:A52/11/z-9/1;
  !!DL667:A53/11/z-10/1;
  !!SN:W^Grandmaster_Picture^/?y25;
  !!VRz-3:S^BM%Y25%Z-4.pcx^;            [level pcx name]
  !!DL667:A19/11/z-3/1;                 [show big picture]
  !!VRz-5:Sz189595;
  !!DL667:A3/3/z-5/1;                   [show correct skill text what can be leveled]
  !!if&y50=0;
    !!SN:T^AC_Misc.Battlemage_Skill_1^/?z20;
    !!SN:T^AC_Misc.Battlemage_Skill_2^/?z21;
    !!SN:T^AC_Misc.Battlemage_Skill_3^/?z22;
    !!SN:T^AC_Misc.Battlemage_Skill_4^/?z23;
    !!DL667:A60/3/z20/1;
    !!DL667:A61/3/z21/1;
    !!DL667:A62/3/z22/1;
    !!DL667:A63/3/z23/1;
  !!en;
!!en;

!!if&y70=6;                             [For Druid]
  !!VRy95:S53;                          [Set to Master Power 53]
  !!VRy96:S63;                          [Set to Herbalism 63 (Natrual Healer)]
  !!VRy97:S68;                          [Set to Ethereal 68 (Stone/Hard Skin)]
  !!VRy98:S61;                          [Set to Concentration 61 (replaces War Path)]
  !!VRz-7:S^skill%Y95.pcx^; !!VRz-7&y50=1:S^skill%Y95C.pcx^; [Set z-7 to correct name]
  !!VRz-8:S^skill%Y96.pcx^; !!VRz-8&y50=1:S^skill%Y96C.pcx^; [Set z-8 to correct name]
  !!VRz-9:S^skill%Y97.pcx^; !!VRz-9&y50=1:S^skill%Y97C.pcx^; [Set z-9 to correct name]
  !!VRz-10:S^skill%Y98.pcx^; !!VRz-10&y50=1:S^skill%Y98C.pcx^; [Set z-10 to correct name]
  !!DL667:A50/11/z-7/1;
  !!DL667:A51/11/z-8/1;
  !!DL667:A52/11/z-9/1;
  !!DL667:A53/11/z-10/1;
  !!SN:W^Grandmaster_Picture^/?y25;
  !!VRz-3:S^Druid%Y25%Z-4.pcx^;         [level pcx name]
  !!DL667:A19/11/z-3/1;                 [show big picture]
  !!VRz-5:Sz189597;
  !!DL667:A3/3/z-5/1;                   [show correct skill text what can be leveled]
  !!if&y50=0;
    !!SN:T^AC_Misc.Druid_Skill_1^/?z20;
    !!SN:T^AC_Misc.Druid_Skill_2^/?z21;
    !!SN:T^AC_Misc.Druid_Skill_3^/?z22;
    !!SN:T^AC_Misc.Druid_Skill_4^/?z23;
    !!DL667:A60/3/z20/1;
    !!DL667:A61/3/z21/1;
    !!DL667:A62/3/z22/1;
    !!DL667:A63/3/z23/1;
  !!en;
!!en;

!#VA(usedY[5]:y);
!!FU(H3Dlg_GetCurrentDlg):P?(heroDlg:y);
!!FU(DL_FindById):P667/?(customDlg:y);
!!UN:C(customDlg)/4/?(customDlg);

!!FU(acm_DlgItemSize):P45/?(width:y)/?(height:y)/(heroDlg) P45/(width)/(height)/(customDlg);
!!FU(acm_DlgItemPosition):P45/?(x:y)/?(y:y)/(heroDlg) P45/(x)/(y)/(customDlg);

!!VRz-3&y1=152:S^Roland.pcx^;           [Special Heroes get Special Pictures]
!!VRz-3&y1=146:S^Catherin.pcx^;        [Special Heroes get Special Pictures]
!!VRz-3&y1=74:S^Sandro.pcx^;            [Special Heroes get Special Pictures]
!!DL667|y1=152/y1=146/y1=74:A19/11/z-3/1;[show big picture]

!!UN:R3/-1;                             [redraw hero screen]
!!DL667:S;                              [show dialogue]
!!UN:C7505216/1/18;                     [after dlgClose - restore shadow]
!!UN:R3/-1;                             [redraw hero screen]


**** CLICK ON CANCEL BUTTON [FLAG], DO NOTHING

!?DL&v998=667/v999=30722/v1000=13;
!!DL:C1;                                [end dialogue immedietly]


--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
********  SHOW RIGHT CLICK INFORMATION WHEN CLICKED ON SKILL AND CLASS PICTURE *********
!?DL&v1000=14;
!!if|v998=667/v998=266;
  !!if|v999=50/v999=51/v999=52/v999=53/v999=19;
    !!VRz-6:S^^;                            [clear]
    * set-up skill text description
    *
    !!HE-1:N?y1;
    !!FU(acm_RecalcClassPoints):Py1/?y10/?y20/?y30; [Return value for class points from current hero]

    !!SN:W^Adept_Level_Global_Value^/?y90;
    !!SN:W^Expert_Level_Global_Value^/?y91;
    !!SN:W^Master_Level_Global_Value^/?y92; [Read out global values for Master rank]
    !!SN:W^Grandmaster_Level_Global_Value^/?y93; [Read out global values for GM rank]

    !!FU&y10<y92/y20<y92/y30<y92:E;         [If no requirements met Exit Fkt]

    !!VRy70:S0;
    *Decide which Class has highest points*
    !!VRy70&y10>y20/y10>y30:S1;             [Warrior]
    !!VRy70&y20>y10/y20>y30:S2;             [Mage]
    !!VRy70&y30>y20/y30>y10:S3;             [Adventurer]
    !!VRy70&y20>=y92/y30>=y92:S6;           [Druid]
    !!VRy70&y10>=y92/y20>=y92:S5;           [Battlemage]
    !!VRy70&y10>=y92/y30>=y92:S4;           [Hunter]

  * set advanced level skills and pictures

    !!if&y70=1/y10>=y92/y10<y93;           [For Master Warrior]
      !!SN&v999=50:T^AC_Misc.Master_Training^/?z-6; [Get Description of first Bonus]
      !!IF&v999=50:M1/4/^%Z-6^;               [Show Description of first Bonus when RClick]
      !!SN&v999=51:T^AC_Misc.Critical_Hit_1^/?z-6; [Get Description of second Bonus]
      !!IF&v999=51:M1/4/^%Z-6^;               [Show Description of second Bonus when RClick]
      !!SN&v999=19:T^AC_Misc.Warrior_Description^/?z-6; [Get Description of Class]
      !!IF&v999=19:M1/4/^%Z-6^;               [Show Description of Class when RClick]
    !!en;

    !!if&y70=1/y10>=y93;                   [For Grandmaster Warrior]
      !!SN&v999=50:T^AC_Misc.Elite_Soldier^/?z-6;
      !!IF&v999=50:M1/4/^%Z-6^;
      !!SN&v999=51:T^AC_Misc.Critical_Hit_2^/?z-6;
      !!IF&v999=51:M1/4/^%Z-6^;
      !!SN&v999=52:T^AC_Misc.Endure_Retaliation^/?z-6;
      !!IF&v999=52:M1/4/^%Z-6^;
      !!SN&v999=53:T^AC_Misc.Commander_1^/?z-6;
      !!IF&v999=53:M1/4/^%Z-6^;
      !!SN&v999=19:T^AC_Misc.Warrior_Description^/?z-6;
      !!IF&v999=19:M1/4/^%Z-6^;
    !!en;

    !!if&y70=2/y20>=y92/y20<y93;           [For Master Mage]
      !!SN&v999=50:T^AC_Misc.Extra_Cast_1^/?z-6;
      !!IF&v999=50:M1/4/^%Z-6^;
      !!SN&v999=51:T^AC_Misc.Elemental_Resistance_1^/?z-6;
      !!IF&v999=51:M1/4/^%Z-6^;
      !!SN&v999=19:T^AC_Misc.Mage_Description^/?z-6;
      !!IF&v999=19:M1/4/^%Z-6^;
    !!en;

    !!if&y70=2/y20>=y93;                   [For GrandMaster Mage]
      !!SN&v999=50:T^AC_Misc.Extra_Cast_2^/?z-6;
      !!IF&v999=50:M1/4/^%Z-6^;
      !!SN&v999=51:T^AC_Misc.Elemental_Resistance_1^/?z-6;
      !!IF&v999=51:M1/4/^%Z-6^;
      !!SN&v999=52:T^AC_Misc.Arkane_Prophet^/?z-6;
      !!IF&v999=52:M1/4/^%Z-6^;
      !!SN&v999=53:T^AC_Misc.Channeling^/?z-6;
      !!IF&v999=53:M1/4/^%Z-6^;
      !!SN&v999=19:T^AC_Misc.Mage_Description^/?z-6;
      !!IF&v999=19:M1/4/^%Z-6^;
    !!en;

    !!if&y70=3/y30>=y92/y30<y93;           [For Master Adventurer]
      !!SN&v999=50:T^AC_Misc.Plunder_1^/?z-6;
      !!IF&v999=50:M1/4/^%Z-6^;
      !!SN&v999=51:T^AC_Misc.Horsemaster^/?z-6;
      !!IF&v999=51:M1/4/^%Z-6^;
      !!SN&v999=19:T^AC_Misc.Adventurer_Description^/?z-6;
      !!IF&v999=19:M1/4/^%Z-6^;
    !!en;

    !!if&y70=3/y30>=y93;                   [For GrandMaster Adventurer]
      !!SN&v999=50:T^AC_Misc.Plunder_2^/?z-6;
      !!IF&v999=50:M1/4/^%Z-6^;
      !!SN&v999=51:T^AC_Misc.Landlord_1^/?z-6;
      !!IF&v999=51:M1/4/^%Z-6^;
      !!SN&v999=52:T^AC_Misc.Strength_Numbers^/?z-6;
      !!IF&v999=52:M1/4/^%Z-6^;
      !!SN&v999=53:T^AC_Misc.Coordinated_Attack^/?z-6;
      !!IF&v999=53:M1/4/^%Z-6^;
      !!SN&v999=19:T^AC_Misc.Adventurer_Description^/?z-6;
      !!IF&v999=19:M1/4/^%Z-6^;
    !!en;

    !!if&y70=4;                            [For Hunter]
      !!SN&v999=50:T^AC_Misc.Master_Training^/?z-6;
      !!IF&v999=50:M1/4/^%Z-6^;
      !!SN&v999=51:T^AC_Misc.Plunder_1^/?z-6;
      !!IF&v999=51:M1/4/^%Z-6^;
      !!SN&v999=52:T^AC_Misc.First_Shot^/?z-6;
      !!IF&v999=52:M1/4/^%Z-6^;
      !!SN&v999=53:T^AC_Misc.Magic_Block^/?z-6;
      !!IF&v999=53:M1/4/^%Z-6^;
      !!SN&v999=19:T^AC_Misc.Hunter_Description^/?z-6;
      !!IF&v999=19:M1/4/^%Z-6^;
    !!en;

    !!if&y70=5;                            [For Battlemage]
      !!SN&v999=50:T^AC_Misc.Extra_Cast_1^/?z-6;
      !!IF&v999=50:M1/4/^%Z-6^;
      !!SN&v999=51:T^AC_Misc.Master_Training^/?z-6;
      !!IF&v999=51:M1/4/^%Z-6^;
      !!SN&v999=52:T^AC_Misc.Precast^/?z-6;
      !!IF&v999=52:M1/4/^%Z-6^;
      !!SN&v999=53:T^AC_Misc.Intimidation^/?z-6;
      !!IF&v999=53:M1/4/^%Z-6^;
      !!SN&v999=19:T^AC_Misc.Battlemage_Description^/?z-6;
      !!IF&v999=19:M1/4/^%Z-6^;
    !!en;

    !!if&y70=6;                            [For Druid]
      !!SN&v999=50:T^AC_Misc.Extra_Cast_1^/?z-6;
      !!IF&v999=50:M1/4/^%Z-6^;
      !!SN&v999=51:T^AC_Misc.Natural_Healer^/?z-6;
      !!IF&v999=51:M1/4/^%Z-6^;
      !!SN&v999=52:T^AC_Misc.Natural_Resistance^/?z-6;
      !!IF&v999=52:M1/4/^%Z-6^;
      !!SN&v999=53:T^AC_Misc.Concentration^/?z-6;
      !!IF&v999=53:M1/4/^%Z-6^;
      !!SN&v999=19:T^AC_Misc.Druid_Description^/?z-6;
      !!IF&v999=19:M1/4/^%Z-6^;
    !!en;

  !!en;
!!en;

--------------------------------------------------------------------------------

* for summoning dialogue
*!VRy-23&x1=1:S10 +x16; *!VRy-24&x1=1:S2 +x16;
*!DL672&x1=1:Ay-23/3/z-9/1;             [set def and textbox for slot 1-7]
*!DL672&x1=1:Ay-24/4/y-22/1;

* for dark ritual dialogue
*!VRy-23&x1=2:S10 +x16; *!VRy-24&x1=2:S2 +x16;
*!DL540&x1=2:Ay-23/3/z-9/1;             [set def and textbox for slot 1-7]
*!DL540&x1=2:Ay-24/4/y-22/1;

******************END ADVANCED LEVELS MASTER DIALOGUE *****************************



                Improved Secondary Skill Section



********************************************************************************
** Initialization Code

!?PI;
**Global Skill Balancing**

!!FU(SetSecSkillPercent):P2/1/15;       [Set Skillvalue to 15% for Basic Logistics]
!!FU(SetSecSkillPercent):P2/2/20;       [Set Skillvalue to 20% for Advanced Logistics]
!!FU(SetSecSkillPercent):P2/3/25;       [Set Skillvalue to 25% for Expert Logistics]

!!FU(SetSecSkillPercent):P5/1/1;        [Set Skillvalue to 1% for Basic Navigation]
!!FU(SetSecSkillPercent):P5/2/1;        [Set Skillvalue to 1% for Advanced Navigation]
!!FU(SetSecSkillPercent):P5/3/1;        [Set Skillvalue to 1% for Expert Navigation]

!!FU(SetSecSkillPercent):P11/1/50;      [Set Skillvalue to 50% for Basic Eagle Eye]
!!FU(SetSecSkillPercent):P11/2/65;      [Set Skillvalue to 65% for Advanced Eagle Eye]
!!FU(SetSecSkillPercent):P11/3/75;      [Set Skillvalue to 75% for Expert Eagle Eye]

!!FU(SetSecSkillPercent):P21/1/20;      [Set Skillvalue to 20% for Basic Learning]
!!FU(SetSecSkillPercent):P21/2/30;      [Set Skillvalue to 30% for Advanced Learning]
!!FU(SetSecSkillPercent):P21/3/40;      [Set Skillvalue to 40% for Expert Learning]

!!FU(SetSecSkillPercent):P8/1/0;        [Set Skillvalue to 0% for Basic Mystic]
!!FU(SetSecSkillPercent):P8/2/0;        [Set Skillvalue to 0% for Advanced Mystic]
!!FU(SetSecSkillPercent):P8/3/0;        [Set Skillvalue to 0% for Expert Mystic]

*Remember all Necro value is devided by two, so its actually 5/10/15%*
!!FU(SetSecSkillPercent):P12/1/10;      [Set Skillvalue to 5% for Basic Necromancy]
!!FU(SetSecSkillPercent):P12/2/20;      [Set Skillvalue to 10% for Advanced Necromancy]
!!FU(SetSecSkillPercent):P12/3/30;      [Set Skillvalue to 15% for Expert Necromancy]

!!FU(SetSecSkillPercent):P24/1/25;      [Set Skillvalue to 25% for Basic Intelligence]
!!FU(SetSecSkillPercent):P24/2/50;      [Set Skillvalue to 50% for Advanced Intelligence]
!!FU(SetSecSkillPercent):P24/3/75;      [Set Skillvalue to 75% for Expert Intelligence]

!!FU(SetSecSkillPercent):P25/1/10;      [Set Skillvalue to 10% for Basic Sorcery]
!!FU(SetSecSkillPercent):P25/2/20;      [Set Skillvalue to 20% for Advanced Sorcery]
!!FU(SetSecSkillPercent):P25/3/30;      [Set Skillvalue to 30% for Expert Sorcery]

!!FU(SetSecSkillPercent):P26/1/10;      [Set Skillvalue to 10% for Basic Resistance]
!!FU(SetSecSkillPercent):P26/2/15;      [Set Skillvalue to 15% for Advanced Resistance]
!!FU(SetSecSkillPercent):P26/3/20;      [Set Skillvalue to 20% for Expert Resistance]

*!SN:W^H3_Hero%X1_Crit_Chance^/0;
*!SN:W^H3_Hero%X1_Crit_Damage^/0;


************************Reset Variables Section*********************************
!?FU(OnAfterBattleUniversal);

*!SN:W^Leadership_Current_battle_round^/-1;
*!SN:W^Leadership_Stack_had_Moral^/-1;

!?FU(OnBattleRegeneratePhase);          [Reset Attacking Stacks Function]

*!SN:W^Leadership_Attacking_Stack^/-1;
!!SN:W^Brute_Attacking_Stack^/-1;
!!SN:W^Temple_G_Attacking_Stack^/-1;
!!SN:W^Paladin_Attacking_Stack^/-1;
!!SN:W^Shaman_Attacking_Stack^/-1;
!!SN:W^Shaman1_Attacking_Stack^/-1;
!!SN:W^Holiness_Attacking_Stack^/-1;
!!SN:W^Warrior_Crit_Attacking_Stack^/-1;
!!SN:W^Will_Attacking_Stack^/-1;
!!SN:W^Cherry_Attacking_Stack^/-1;
!!SN:W^Blackshard_Attacking_Stack^/-1;
!!SN:W^Flail_Attacking_Stack^/-1;
!!SN:W^Tongue_Attacking_Stack^/-1;
!!SN:W^DragonSet_Attacking_Stack^/-1;
!!SN:W^Oger_Attacking_Stack^/-1;
*!SN:W^Commander_Kill_Attacking_Stack^/-1;
!!SN:W^Damage_Counter_Attacking_Stack^/-1;
!!SN:W^Vampire_Class_Attacking_Stack^/-1;
!!SN:W^FireMage_Attacking_Stack^/-1;
!!SN:W^Vampire_Cowl_Attacking_Stack^/-1;
!!SN:W^Dragonslayer1_Attacking_Stack^/-1;
!!SN:W^Dragonslayer2_Attacking_Stack^/-1;
!!SN:W^Com_Paladin_Attacking_Stack^/-1;
!!SN:W^Com_FighterMage_Attacking_Stack^/-1;


!?BF;

!!BH0:N?y88;                            [Attacking Hero]
!!BH1:N?y89;                            [Defending Hero]

!!SN&y88>=0:W^Master_Mage_Hero%Y88^/?y4;
!!SN&y89>=0:W^Master_Mage_Hero%Y89^/?y5;

!!SN&y88>=0:W^Grandmaster_Mage_Hero%Y88^/?y6;
!!SN&y89>=0:W^Grandmaster_Mage_Hero%Y89^/?y7;

!!SN&y4=1:W^Master_Mage_Extra_Cast_att^/1; [Set Extra Cast Att Variable to 1]
!!SN&y5=1:W^Master_Mage_Extra_Cast_def^/1; [Set Extra Cast Def Variable to 1]

!!SN&y6=1:W^Master_Mage_Extra_Cast_att^/0; [Disable Extra cast if already Grandmaster]
!!SN&y7=1:W^Master_Mage_Extra_Cast_def^/0; [Disable Extra cast if already Grandmaster]


********************************************************************************



                       MASTER/GRANDMASTER SKILLS



********************************************************************************


************************Pathfinding*********************************************
*+1 Speed in first Battle Round (Master) and bonus movement on all terrain (Grandmaster)

!?FU(OnAfterTacticsPhase); [Moved timing from OnCombatRound to OnAfterTacticsPhase to have correct move order in battle]

!!SN:W^Pathfinding_Speed_Bonus1^/?y1;
!!FU&y1=1:E;
!!SN:W^Pathfinding_Speed_Bonus1^/1;     [To run only once]

!!BH0:N?y1;                             [Attacker]
!!HEy1:S0/?y10;                         [Checke ob der Held Pathfinding hat und Speichere in y10]

!!VRy48:S0;                             [Initialise to zero]
!!HEy1:X?y21/?y22/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!if&y22=0/y21=0;                      [if Pathfinding]
!!HEy1:E?y46/?y47/1;                    [Check hero Level]
!!VRy48:Sy47:15+1;
!!en;
!!VRy50:S1+y48;                         [Speed Bonus]

!!SN:W^H3_Pathfinding_0_Hero%Y1^/?y11;  [Checke ob der Held Master Pathfinding hat und Speichere in y11]
!!DO(AC_Function_2)/0/20/1&y10>0:P1/y50;

!!BH1:N?y1;                             [Defender]
!!FU&y1<0:E;
!!HEy1:S0/?y10;                         [Checke ob der Held Pathfinding hat und Speichere in y10]

!!VRy48:S0;                             [Initialise to zero]
!!HEy1:X?y21/?y22/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!if&y22=0/y21=0;                      [if Pathfinding]
!!HEy1:E?y46/?y47/1;                    [Check hero Level]
!!VRy48:Sy47:15+1;
!!en;
!!VRy50:S1+y48;                         [Speed Bonus]

!!SN:W^H3_Pathfinding_0_Hero%Y1^/?y11;  [Checke ob der Held Master Pathfinding hat und Speichere in y11]
!!DO(AC_Function_2)/21/41/1&y10>0:P1/y50;


!?FU(OnCombatRound)&v997=1;
!!SN:W^Pathfinding_Speed_Bonus2^/?y1;
!!FU&y1=1:E;
!!SN:W^Pathfinding_Speed_Bonus2^/1;     [To run only once]

!!BH0:N?y1;                             [Attacker]
!!HEy1:S0/?y10;                         [Checke ob der Held Pathfinding hat und Speichere in y10]

!!VRy48:S0;                             [Initialise to zero]
!!HEy1:X?y21/?y22/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!if&y22=0/y21=0;                      [if Pathfinding]
!!HEy1:E?y46/?y47/1;                    [Check hero Level]
!!VRy48:Sy47:15+1;
!!en;
!!VRy50:S1+y48*-1;                      [Speed Bonus]

!!SN:W^H3_Pathfinding_0_Hero%Y1^/?y11;  [Checke ob der Held Master Pathfinding hat und Speichere in y11]
!!DO(AC_Function_2)/0/20/1&y10>0:P2/y50;

!!BH1:N?y1;                             [Defender]
!!FU&y1<0:E;
!!HEy1:S0/?y10;                         [Checke ob der Held Pathfinding hat und Speichere in y10]

!!VRy48:S0;                             [Initialise to zero]
!!HEy1:X?y21/?y22/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!if&y22=0/y21=0;                      [if Pathfinding]
!!HEy1:E?y46/?y47/1;                    [Check hero Level]
!!VRy48:Sy47:15+1;
!!en;
!!VRy50:S1+y48*-1;                      [Speed Bonus]

!!SN:W^H3_Pathfinding_0_Hero%Y1^/?y11;  [Checke ob der Held Master Pathfinding hat und Speichere in y11]
!!DO(AC_Function_2)/21/41/1&y10>0:P2/y50;

!?FU(OnBeforeBattleUniversal);          [At Battle Begin]
!!SN:W^Pathfinding_Speed_Bonus1^/0;     [Reset]
!!SN:W^Pathfinding_Speed_Bonus2^/0;     [Reset]

!?FU(AC_Function_2);
!!BMx16:T?y1;
!!FU|y1=145/y1=146/y1=147/y1=148/y1=149:E;
!!BMx16&x1=1:Sdx2;
*!VRx2&x1=2:*-1;
!!BMx16&x1=2:Sdx2;


!?FU(OnEveryDay)&i^timerIsAi^=0/i^timerOnce^=1;
!!FU:E;                                 [Disabled]
!!DO(AC_Function_3)/0/155/1:P;          [loop through heroes]

!?FU(AC_Function_3);
!!HEx16:O?y1;                           [Checke Hero Owner]
!!FU&y1=-1:E;                           [Exit if none]
!!HEx16:S0/?y10;                        [Checke ob der Held Pathfinding hat und Speichere in y10]
!!FU&y10<3:E;
!!SN:W^H3_Pathfinding_0_Hero%X16^/?y11; [Checke ob der Held Grandmaster Pathfinding hat und Speichere in y11]
!!SN:W^H3_Pathfinding_1_Hero%X16^/?y12; [Checke ob der Held Grandmaster Pathfinding hat und Speichere in y11]

!!HEx16&y10=3/y11=1:Wd100/1;            [Add little Bonus Movement 5%]
!!HEx16&y10=3/y12=1:Wd100/1;            [Add little Bonus Movement 5%]

!!HEx16:X?y21/?y22/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!if&y22=0/y21=0;                       [if Pathfinding]
  !!HEx16:E?y46/?y47/1;                 [Check hero Level]
  !!VRy48:Sy47*10;
  !!HEx16:Wdy48/1;                      [Add little Bonus Movement dependant on Level]
!!en;

*Pathfinding Master and Grandmaster Bonus reduces penalty for carriying slow troops in army.

Creature speed   Base movement

3                 1500
4                 1560
5                 1630
6                 1700
7                 1760
8                 1830
9                 1900 Base Movement is 1900 Points
10                1960
11 or more        2000

*?FU(OnEveryDay)&i^timerIsAi^=0/i^timerOnce^=1; [Trigger on every day once]
; Replaced by Archer's implementation
!?FU(OnEveryDay)&i^timerIsAi^=0; [Trigger on every day once]
!!FU:E;

!!DO(AC_Function_135)/0/155/1:P;        [loop all heroes]

!?FU(AC_Function_135);
!!HEx16:O?y1;                           [Checke Hero Owner]
!!FU&y1=-1:E;                           [Exit if none]
!!HEx16:S0/?y10;                        [Check if hero has Pathfinding and save result in y10]
!!FU&y10<(SKILL_EXPERT):E;

!!FU(ACM_GetPathfindingBonusMovementPoints):Px16/?y21;

!!HEx16:Wdy21/1;                        [Add Bonus Movement to hero]
!!HEx16:W?y20/1;                        [Get current movementpoints]
!!HEx16:Gy20/1;                         [Set maximum movement points]
!!SN:W^ACM_Total_add_movement_%X16^/y20;

!?FU(ACM_GetPathfindingBonusMovementPoints);
!#VA(hero:x) (result:x);

!!VR(result):S0;

!!VRy11:Si^H3_Pathfinding_0_Hero%(hero)^;
!!VRy12:Si^H3_Pathfinding_1_Hero%(hero)^;
!!FU&y11<>(TRUE)/y12<>(TRUE):E;

!!HE(hero):C0/0/?y2/?y32; !!MA&y32<>0:Sy2/?y22; [Check Creatures in Hero Army and Get Speed of First Creature]
!!HE(hero):C0/1/?y3/?y33; !!MA&y33<>0:Sy3/?y23; [second slot]
!!HE(hero):C0/2/?y4/?y34; !!MA&y34<>0:Sy4/?y24; [...]
!!HE(hero):C0/3/?y5/?y35; !!MA&y35<>0:Sy5/?y25; [...]
!!HE(hero):C0/4/?y6/?y36; !!MA&y36<>0:Sy6/?y26; [...]
!!HE(hero):C0/5/?y7/?y37; !!MA&y37<>0:Sy7/?y27; [...]
!!HE(hero):C0/6/?y8/?y38; !!MA&y38<>0:Sy8/?y28; [...]

!!if&y11=1/y12=0;                     [if Master Pathfinding Eliminates 50% of Penalty]
  !!VR(result)|y28=8/y27=8/y26=8/y25=8/y24=8/y23=8/y22=8:S35; [+30 Movement Penalty if lowest speed is 8]
  !!VR(result)|y28=7/y27=7/y26=7/y25=7/y24=7/y23=7/y22=7:S70; [+70 Movement Penalty if lowest speed is 7]
  !!VR(result)|y28=6/y27=6/y26=6/y25=6/y24=6/y23=6/y22=6:S100; [+100 Movement Penalty if lowest speed is 6]
  !!VR(result)|y28=5/y27=5/y26=5/y25=5/y24=5/y23=5/y22=5:S135; [+135 Movement Penalty if lowest speed is 5]
  !!VR(result)|y28=4/y27=4/y26=4/y25=4/y24=4/y23=4/y22=4:S170; [+170 Movement Penalty if lowest speed is 4]
  !!VR(result)|y28=3/y27=3/y26=3/y25=3/y24=3/y23=3/y22=3:S200; [+200 Movement Penalty if lowest speed is 3]

!!el&y11=1/y12=1;                       [if Grandmaster Pathfinding Eliminates 100% of Penalty]
  !!VR(result)|y28=8/y27=8/y26=8/y25=8/y24=8/y23=8/y22=8:S70; [+70 Movement Penalty if lowest speed is 8]
  !!VR(result)|y28=7/y27=7/y26=7/y25=7/y24=7/y23=7/y22=7:S140; [+140 Movement Penalty if lowest speed is 7]
  !!VR(result)|y28=6/y27=6/y26=6/y25=6/y24=6/y23=6/y22=6:S200; [+200 Movement Penalty if lowest speed is 6]
  !!VR(result)|y28=5/y27=5/y26=5/y25=5/y24=5/y23=5/y22=5:S270; [+270 Movement Penalty if lowest speed is 5]
  !!VR(result)|y28=4/y27=4/y26=4/y25=4/y24=4/y23=4/y22=4:S340; [+340 Movement Penalty if lowest speed is 4]
  !!VR(result)|y28=3/y27=3/y26=3/y25=3/y24=3/y23=3/y22=3:S400; [+400 Movement Penalty if lowest speed is 3]   
!!en;


*fix for showing correct maximum movement points for heroes if they were changed by my scripts
*?FU(OnGameEnter)&i^timerDay^=1;
*!IF:M^Now^;
*!re i/0/155;
*!HEi:G?y20/1;                          [get max movement points]
*!SN:W^ACM_Total_add_movement_%i^/y20;  [reset variable at end of turn]
*!en;

*?FU(WOG_EndOfTurn)&i^timerOnce^=1;
*!re i/0/155;
*!HEi:G?y20/1;                          [get max movement points]
*!SN:W^ACM_Total_add_movement_%i^/y20;  [reset variable at end of turn]
*!en;

*?FU(OnCloseHeroScreen)&i^timerDay^>1;  [set max movement points when closing hero screen]
*!HE-1:N?y1;                            [Get hero ID]
*!SN:W^ACM_Total_add_movement_%Y1^/?y20;
*!HEy1:Gy20/1;                          [Set maximum movement points]


!?CM5;                                  [Left Click on Adventure Screen to change pathfinding value]
!!CM:S?v3; !!FU&v3<>12:E;

!!OW:C?y1;                              [Get current player]
!!OW:Ay1/?y1;                           [Get active Hero]
!!FU&y1=-1:E;                           [Exit if none]
!!HEy1:S0/?y10;                         [Get pathfinding skill]

**Set all to normal expert value (100 means no penalty)
!!FU(PathfindingValues):P3/3/100;       [Snow]
!!FU(PathfindingValues):P4/3/100;       [Swamp]
!!FU(PathfindingValues):P5/3/100;       [Rough]
!!FU(PathfindingValues):P7/3/100;       [Lava]

!!FU&y10<3:E;                           [Exit if not at least expert]

** if pathfinding specialists decrease movement on these terrains by 1 point per 2 levels
!!HEy1:X?y21/?y22/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!if&y22=0/y21=0;                       [if Pathfinding]
!!HEy1:E?y46/?y47/1;                    [Check hero Level]
!!VRy48:Sy47:2;                         [5 + Half level of Hero]
!!VRy5:S95-y48;
!!FU(PathfindingValues):P3/3/y5;        [Snow]
!!FU(PathfindingValues):P4/3/y5;        [Swamp]
!!FU(PathfindingValues):P5/3/y5;        [Rough]
!!FU(PathfindingValues):P7/3/y5;        [Lava]
!!en;

; Cost of terrain movement with Pathfinding skill
!?FU(PathfindingValues);
; x1 - terrain , x2 - skill level, x3 - cost of movement in points
!!FU|x1<0/x1>12/x2<0/x2>3/x3<0:E;
!!VRx1:*16; !!VRx2:*4; !!VRy1:S6546704 +x1 +x2; !!UN:Cy1/4/x3;

00    Dirt
01    Sand
02    Grass
03    Snow
04    Swamp
05    Rough
06    Underground
07    Lava
08    Water
09    Rock
10 - dirt road,
11 - gravel road,
12 - cobblestone road)

************************Archery*************************************************
**Master Archery increases the damage done by range attacking creatures by 65% and eliminates obstacle penalty.
**Grandmaster Archery increases the damage done by range attacking creatures by 75% and eliminates range and obstacle penalty.
** See below for Code



************************Logistics***********************************************
*+1 Speed in first Battle Round at Master +1 Speed in Combat at Grandmaster

!?FU(OnBeforeBattleUniversal);          [At Battle Begin]

!!SN:W^Logistics_Speed_Bonus1^/0;       [Reset]
!!SN:W^Logistics_Speed_Bonus2^/0;       [Reset]


!?FU(OnAfterTacticsPhase);              [Moved timing from OnCombatRound to OnAfterTacticsPhase to have correct move order in battle]
!!SN:W^Logistics_Speed_Bonus1^/?y1;
!!FU&y1=1:E;
!!SN:W^Logistics_Speed_Bonus1^/1;       [To run only once]

!!BH0:N?y1;                             [Attacker]
!!HEy1:S2/?y10;                         [Checke ob der Held Logistics hat und Speichere in y10]
!!SN:W^H3_Logistics_0_Hero%Y1^/?y11;    [Checke ob der Held Master Logistics hat und Speichere in y11]
!!DO(AC_Function_4)/0/20/1&y10=3/y11=1:P1;
*!SN:W^H3_Logistics_1_Hero%Y1^/?y11;    [Checke ob der Held Grandmaster Logistics hat und Speichere in y11]
*!DO(AC_Function_4)/0/20/1&y10=3/y11=1:P1;

!!BH1:N?y1;                             [Defender]
!!FU&y1<0:E;
!!HEy1:S2/?y10;                         [Checke ob der Held Logistics hat und Speichere in y10]
!!SN:W^H3_Logistics_0_Hero%Y1^/?y11;    [Checke ob der Held Master Logistics hat und Speichere in y11]
!!DO(AC_Function_4)/21/41/1&y10=3/y11=1:P1;
*!SN:W^H3_Logistics_1_Hero%Y1^/?y11;    [Checke ob der Held Grandmaster Logistics hat und Speichere in y11]
*!DO(AC_Function_4)/21/41/1&y10=3/y11=1:P1;


!?FU(OnCombatRound)&v997=1;
!!SN:W^Logistics_Speed_Bonus2^/?y1;
!!FU&y1=1:E;
!!SN:W^Logistics_Speed_Bonus2^/1;       [To run only once]

!!BH0:N?y1;                             [Attacker]
!!HEy1:S2/?y10;                         [Checke ob der Held Logistics hat und Speichere in y10]
!!SN:W^H3_Logistics_0_Hero%Y1^/?y11;    [Checke ob der Held Master Logistics hat und Speichere in y11]
!!SN:W^H3_Logistics_1_Hero%Y1^/?y12;    [Checke ob der Held Master Logistics hat und Speichere in y12]
!!DO(AC_Function_4)/0/20/1&y10=3/y11=1/y12=0:P2;

!!BH1:N?y1;                             [Defender]
!!FU&y1<0:E;
!!HEy1:S2/?y10;                         [Checke ob der Held Logistics hat und Speichere in y10]
!!SN:W^H3_Logistics_0_Hero%Y1^/?y11;    [Checke ob der Held Master Logistics hat und Speichere in y11]
!!SN:W^H3_Logistics_1_Hero%Y1^/?y12;    [Checke ob der Held Master Logistics hat und Speichere in y12]
!!DO(AC_Function_4)/21/41/1&y10=3/y11=1/y12=0:P2;

!?FU(AC_Function_4);
!!BMx16:T?y1;
!!BMx16:N?y2;
!!FU|y1=145/y1=146/y1=147/y1=148/y1=149:E;
!!if&y2>0;
!!BMx16&x1=1:Sd1;
*!BMx16&x1=2:S?y4;
*!VRy4&y4>=1/x1=2:-1;
*!BMx16&x1=2/y4>=1:Sy4;
!!BMx16&x1=2:Sd-1;
!!en;


*?FU(OnEveryDay)&i^timerIsAi^=0/i^timerOnce^=1;
; Replaced by Archer's implementation
!?FU(OnEveryDay)&i^timerIsAi^=0;
!!FU:E;

!!DO(AC_Function_5)/0/155/1:P;          [loop thru heroes]

!?FU(AC_Function_5);
!!HEx16:O?y1;                           [Checke Hero Owner]
!!FU&y1=-1:E;                           [Exit if none]
!!HEx16:S2/?y10;                        [Checke ob der Held Logistics hat und Speichere in y10]
!!FU&y10<3:E;
!!SN:W^H3_Logistics_0_Hero%X16^/?y11;   [Checke ob der Held Master Logistics hat und Speichere in y11]
!!SN:W^H3_Logistics_1_Hero%X16^/?y12;   [Checke ob der Held Grandmaster Logistics hat und Speichere in y11]
!!HEx16&y10=3/y11=1:Wd100/1;            [Add little Bonus Movement corresponds to +30% in total] - Archer: Perry, they are not the same :P
!!HEx16&y10=3/y12=1:Wd150/1;            [Add little Bonus Movement corresponds to +35% in total]
!!HEx16:W?y20/1;                        [Get current movementpoints]
!!HEx16:Gy20/1;                         [Set maximum movement points]
!!SN:W^ACM_Total_add_movement_%X16^/y20;


!?HM-1&1000;                            [More Movement on Water]
!!FU:E;                                 [Disabled for now]
!!HE-1:N?y1 O?y2 S2/?y3;                [get #, owner of  and scouting skill]
!!FU&y3=0:E;                            [exit if not logistics]
!!OW:C?y4;                              [get current player]
!!FU&y2<>y4:E;                          [exit if not current player's hero]
!!OW:Iy4/?y88;
!!FU&y88=1:E;                           [Exit if AI]
!!TRv998/v999/v1000:T?y10/d/d/d/d/d/d/d;[v998,v999,v1000 = x,y and level of the point of destination.]
*!IF:L^%V998 %V999 %V1000  und Land Type is %Y10^;


// Manage all the movement points events, including Ammo Cart, Pathfinding and Logistics
; by Archer30
; Warning: Only using the hook way prevent you from losing max movement points when opening hero screen
!?FU(ACM_CreateERMHook);
!#VA(setHook:x);

!!SN:E(setHook)/1/5132006/(ACM_OnSetHeroMovementPoints); [Trigger on getting the final result of initial movement points] 4E4E1B

; Add in extra movement points when movement points is updated
!?FU(ACM_OnSetHeroMovementPoints);
!#VA(hook:x);

; Get hero id
!!UN:C(hook)/(STRUCT_HOOK_CONTEXT_EBX)/(UNC_INT)/?(heroStruct:y);
!!UN:C(heroStruct)/26/(UNC_INT)/?(heroId:y);

; Get current movement points
!!UN:C(hook)/(STRUCT_HOOK_CONTEXT_EBP)/4/?(ebp:y);
!!UN:C(ebp)/8/4/?(currMp:y);

// Pathfinding
!!if&(currMp)<1900;
  ; Ensure the MP is 1700/1900 for M/GM
  !!HE(heroId):S(SKILL_PATHFINDING)/?(level:y);

  !!if&(level)>=(SKILL_EXPERT);
    !!if&i^H3_Pathfinding_0_Hero%(heroId)^/i^H3_Pathfinding_1_Hero%(heroId)^<>(TRUE);
      !!VR(currMp):F1700/(INT_MAX);
    !!el&i^H3_Pathfinding_0_Hero%(heroId)^/i^H3_Pathfinding_1_Hero%(heroId)^;
      !!VR(currMp):F1900/(INT_MAX);
    !!en;
  !!en;
!!en;

// Ammo Cart enhancement
; +100 MP
!!if&i^Ammo_Supply_%(heroId)^;
  !!HE(heroId):A2/(ART_AMMO_CART)/?(has:y)/?(equipped:y);
  !!VR(currMp)&(equipped)>0:+100;
!!en;

!!UN:C(ebp)/8/4/(currMp);

// M/GM Logistics
; +100/250 MP for M/GM
!!HE(heroId):S(SKILL_LOGISTICS)/?(level:y);

!!if&(level)>=(SKILL_EXPERT)/i^H3_Logistics_0_Hero%(heroId)^;
  !!if&i^H3_Logistics_1_Hero%(heroId)^<>(TRUE);
    !!VR(logisticsFloat:e):S30 :100;
  !!el;
    !!VR(logisticsFloat):S35 :100;
  !!en;

  !!SN:X?t X(logisticsFloat) X?(logisticsInt:y) Xt;
  !!UN:C(ebp)/-4/4/(logisticsInt);

  !!SN:X?t/0;
  !!UN:C(hook)/(STRUCT_HOOK_CONTEXT_RET)/4/5132018;
!!en;


************************Scouting************************************************
**Master Scouting Master Scouting allows your hero to see 7 squares further into the shroud. **Also, your hero is able to discover hidden treasures and other stuff.
**Grandmaster Scouting **Grandmaster Scouting allows your hero to see 8 squares further into the shroud. Also, your hero is able to discover hidden treasures and other stuff.
*Chance for Random encounter
*[Reveal Extra 2 Radius at Week Start]

; Arcerh30's new implementation
!?FU(ACM_CreateERMHook);
!#VA(setHook:x);

!!SN:E(setHook)/1/5128949/(ACM_OnGetScoutingSkillMultiplier); 4E42F5

!?FU(ACM_OnGetScoutingSkillMultiplier);
!#VA(hook:x);

!!UN:C(hook)/(STRUCT_HOOK_CONTEXT_ECX)/4/?(level:y);

!!if&(level)>=(SKILL_EXPERT);
  !!UN:C(hook)/(STRUCT_HOOK_CONTEXT_ESI)/4/?(heroStruct:y);
  !!UN:C(heroStruct)/26/4/?(heroId:y);

  !!if&i^H3_Scouting_0_Hero%(heroId)^;
    !!if&i^H3_Scouting_1_Hero%(heroId)^=(FALSE);
      !!UN:C(hook)/(STRUCT_HOOK_CONTEXT_EBX)/4/9;
    !!el;
      !!UN:C(hook)/(STRUCT_HOOK_CONTEXT_EBX)/4/10;
    !!en;

    !!SN:X?t/0;
    !!UN:C(hook)/(STRUCT_HOOK_CONTEXT_RET)/4/5128956;
  !!en;
!!en;

; Replaced by Archer30's new implementation as it doesn't do what the in-game description says
!?FU(OnEveryDay)&i^timerIsAi^=0/i^timerOnce^=1/i^timerDay^>1/i^timerWeekDay^=1; [Trigger each monday to reveal extra 2 Radius at Week Start]
!!FU:E;

!!DO(AC_Function_6)/0/155/1:P;          [loop through heroes]

!?FU(AC_Function_6);
!!HEx16:O?y1;                           [Checke Hero Owner]
!!FU&y1=-1:E;                           [Exit if none]
!!HEx16:S3/?y10;                        [Checke ob der Held Scouting hat und Speichere in y10]
!!SN:W^H3_Scouting_1_Hero%X16^/?y12;    [Checke ob der Held Grandmaster Scouting hat und Speichere in y11]

!!if&y10=3/y12=1;                       [Check current player, Abort if not the same]
  !!HEx16:P?y20/?y21/?y22;              [get hero x/y/level]
  !!HEx16:O?y2;
  !!UN:Sy20/y21/y22/y2/12;              [Reveal 2 Extra Radius with GrandMaster Scouting at Week Start]
  !!UN:R1;                              [redraw screen]
!!en;

**Hint: With Expert Scouting the radius is 8


** start of movement trigger
!?HM-1;                                 [continue if scouting is enabled]

!!HE-1:N?y1 O?y2 S3/?y3;                [get #, owner of  and scouting skill]
!!OW:C?y30 Iy30/?y40 Gy30/?y50;         [get current player and if human player is sitting in front of the screen]
!!FU&y2<>y30:E;                         [exit if not current player's hero]
*!FU&y40=0/y50=0:E;                     [Exit if not correct human player]
!!SN:W^Scouting_Event_Chance_%Y1^/0;    [reset scouting chance]
!!FU(Count_Set_Pieces_2)&y1>=0/y1<=155/y2>=0:Py1/0/0/0/0/?y90; [Count class Set Pieces function X6]
!!HEy1&y1>=0:A2/101/0/?y91;             [101 Pendant of Second Sight]
!!VRy3&y90>=2/y3=0:S1;                  [Activate Scouting Bonus if Adventurer Class Set equipped]
!!VRy3&y91=1/y3=0:S1;                   [Activate Scouting Bonus if Pendant of Second Sight]
!!FU&y3=0:E;                            [exit if not Scouting]

!!HEy1:X?y21/?y22/?y23/?y24/?y25/?y26/?y27; [Check Hero Speciality]
!!VRy50:S0; !!VRy50&y21=0/y22=3:S1;     [Set y50 to 1 if special]

!!SN:W^H3_Scouting_0_Hero%Y1^/?y11;     [Checke ob der Held Master Scouting hat und Speichere in y11]
!!SN:W^H3_Scouting_1_Hero%Y1^/?y12;     [Checke ob der Held Grandmaster Scouting hat und Speichere in y12]

!!HEy1:E?y15/?y16/1;                    [Get Hero Level]
!!VRy17:Sy16:10+1;                      [+1 Scouting Radius per 10 hero levels]
!!VRy10:S5;
!!VRy10&y3=1:+1;                        [Basic +1]
!!VRy10&y3=2:+1;                        [Advanced +1]
!!VRy10&y3=3:+1;                        [Expert +1]
!!VRy10&y3=3/y11=1/y12=0:+1;            [Reveal 1 Extra Radius with Master Scouting]
!!VRy10&y3=3/y11=1/y12=1:+1;            [Reveal 2 Extra Radius with GrandMaster Scouting]
*!VRy10&y21=0/y22=3:+y17;               [Reveal Extra Radius with Specialist Scouting]
!!UN&1000/999:Sv998/v999/v1000/y2/y10;  [Reveal total]

!!VRy5:S0;
!!VRy30&y3=1:S925;                      [Basic]
!!VRy30&y3=2:S875;                      [Advanced]
!!VRy30&y3=3:S825;                      [Expert]
!!VRy30&y3=3/y11=1/y12=0:S800;          [Master]
!!VRy30&y3=3/y11=1/y12=1:S750;          [Grandmaster]

!!if&y21=0/y22=3;                       [Scouting Specialists]
  !!VRy75:Sy16*4;                       [4 times hero level]
  !!VRy30:-75 -y75;                     [Increased chance for Scouting Specialists ~0,5% higher + increases for each level]
!!en;

!!VRy30&y90>=2:-100;                    [If Adventurer Class Set increases chance ~0,5% higher]
!!VRy30&y91=1:-75;                      [Pendant of Second Sight increases chance ~0,5% higher]

!!VRy5&y3=1:Ty30;                       [set random roll to 3.0% (14/470)]
!!VRy5&y3=2:Ty30;                       [set random roll to 3.2% (14/430)]
!!VRy5&y3=3:Ty30;                       [set random roll to 3.5% (14/400)]
!!SN:W^Scouting_Event_Chance_%Y1^/y30;  [save scouting chance]

!!VRy60:S0R1;                           [Random Coinflip Generator]
!!VRy5&y5=15/y60=0:S5;                  [Only 50% chance to get an artifact]
!!VRy5&y5=16/y60=0:S5;                  [Only 50% chance to get an spell]

*code for new scouting event
!!HEy1:A2/52/?y40/?y43 A2/53/?y40/?y44; [Check for Spyglas and Speculum]
!!VRy42:S17;                            [Range of events from 1 to 17, also number of events]
!!VRy42|y43>0/y44>0:S18;                [If any of the spyglasses equipped extend range of events to 18]
!!VRy70:S0+y43+y44;                     [count variable to hold number of equipped spyglasses]
!!if&y42=18/y5=18;                      [If new event roll]
  !!VRy71:S1R3;                         [lower the chance the get ACM rewards as it can be very strong]
  !!FU&y71>y70:E;                       [Exit if roll not successful round about 50% chance to succeed]
!!en; 

*!VRy5:S18; ** TEST**

!!TRv998/v999/v1000:T?y65 E?y66 P?y67;  [Get terrain type]
!!FU&y65=8/y5=11:E;                     [Exit for fights events on water]
!!FU&y65=8/y5=12:E;                     [Exit for fights on water]
!!FU&y65=8/y5=13:E;                     [Exit for fights on water]
!!FU|y66=0/y67=0:E;                     [Exit if the position is not passable, or is a yellow square]

!!FU(Improved_Scouting_Bonus)&y1>=0/y1<=155/y3>=0/y5<=y42:Py1/y3/y2/y5/y50; [do scouting function - and pass Hero Number/Scouting SkillLevel/Owner/RandomRoll/Specialist status y50]
** end of movement trigger


!?FU(Improved_Scouting_Bonus);
** function for scouting    x1=hero number   x2=scouting  x3=Hero Owner  x4=Encouter  x5=Specialist

!!HEx1:B0/?z700;                        [get hero's name]
!!HEx1:R2/?y1;                          [get hero's sex]
!!VRz701&y1=0:Sz199130;
!!VRz701&y1=1:Sz199131;
!!VRz702&y1=0:Sz199132;
!!VRz702&y1=1:Sz199133;
!!VRz703&y1=0:Sz199134;
!!VRz703&y1=1:Sz199135;
!!HEx1:P?y80/?y81/?y82;                 [get hero's position]
!!VRy3:S11 +x2;                         [set scouting picture]

!!if&x4=1;                              [1= 20 Spell Points]
  !!VRy1:S10R10;
  !!VRy1&x5=1:+5;
  !!IF&1000/999:Q2/20/y3/35/y1/1/z199136;        
  !!HEx1:Idy1/1;                        [give 20 spell points] changed]
!!en;

!!if&x4=2;                              [2= Gold]
  !!HEx1:E?y5/?y6/1;                    [get hero's level]
  !!VRy60:S1Ry6*200+500R1000;
  !!VRy60&x5=1:+1000;
  !!IF&1000/999:Q2/20/y3/6/y60/1/z199137;        
  !!OW:Rx3/6/dy60;                      [give gold]
  !!SN:W^Total_Scouting_Gold_%X1^/dy60; [gained gold from scouting event]
!!en;

!!if&x4=3;                              [3=  small resources]
  !!VRy61:S0R5;                         [random resource 0 to 5]
  !!VRy60:S1R3;                         [random quantity 1 to 3]
  !!VRy60&x5=1:+2;
  !!VRy60&y61=0:*3:2;                   [double for wood]
  !!VRy60&y61=2:*3:2;                   [double for ore]
  !!IF&1000/999:Q2/20/y3/y61/y60/1/z199138;
  !!OW:Rx3/y61/dy60;                    [give the resources]
!!en;

!!if&x4=4;                              [4= large resources]
  !!VRy61:S0R5;                         [random resource 0 to 5]
  !!VRy60:S3R5;                         [random quantity 4 to 6]
  !!VRy60&x5=1:+2;
  !!VRy60&y61=0:*3:2;                   [double for wood]
  !!VRy60&y61=2:*3:2;                   [double for ore]
  !!IF&1000/999:Q2/20/y3/y61/y60/1/z199139;     
  !!OW:Rx3/y61/dy60;                    [give resources]
!!en;

!!if|x4=5/x4=17;                        [Event 5 and 17 are free creatures]
  !!FU(pick_a_monster):P?y4;            [Creatures joining the hero army]
  !!VRy1:S0R2;
  !!VRy1&-1000:S2;                      [computer player always gets creatures from own faction to avoid littering his army]
    !!if&y1=2;
      !!HEx1:B2/?y1;                    [Get faction]
      !!VRy4|y1=0/y1=1:S0R13;           [Castle]
      !!VRy4|y1=2/y1=3:S14R13;
      !!VRy4|y1=4/y1=5:S28R13;
      !!VRy4|y1=6/y1=7:S42R13;
      !!VRy4|y1=8/y1=9:S56R13;
      !!VRy4|y1=10/y1=11:S70R13;
      !!VRy4|y1=12/y1=13:S84R13;
      !!VRy4|y1=14/y1=15:S97R13;
      !!VRy4|y1=16/y1=17:S112R13;       [Conflux]
      !!VRy4|y4=122/y4=124:S127;
      !!VRy6:S0R6;                      [Generate random slot]
      !!HEx1:C0/y6/?y40/?y5;            [Check creature slot]
      !!VRy4&y40>=0/y5>0:Sy40;          [Change monster to one of the hereos army]
      !!if|y4=-1/y5=0;
        !!VRy6:S0R6;                    [Generate random slot]
        !!HEx1&1000/999:C0/y6/?y40/?y5; [Check creature slot]
        !!VRy4&y40>=0/y5>0:Sy40;        [Change monster to one of the hereos army]
      !!en;
    !!en;

  !!VRy1:S0R2;
  !!VRy4&x1=48/y1=1:S46;                [HS1]
  !!VRy4&x1=48/y1=2:S47;
  !!VRy2:S84R13;
  !!VRy4&x1=109/y1=1:Sy2;               [HS2]
  !!VRy4&x1=109/y1=2:Sy2;

  !!MA:Gy4/?y60;                        [get 1 weeks production]
  !!VRy60:Sy60 R2;                      [**]
  !!MA:Ly4/?y5;                         [Get Level of Monster]
  !!if&i^timerDay^<30;
  !!VRy4|y4=132/y4=133/y4=134/y4=135:S137; [OP Dragons cannot be found in first 14 days and are set to Sharpshooters instead]
  !!en;
  !!VRy4&y5=6/i^timerDay^<20:S137;      [Level 7 creatures cannot be found in first two weeks gets changes to Sharpshooters]
  !!VRy4&y5=5/i^timerDay^<8:S138;       [Level 6 creatures cannot be found in first week gets changes to Halflings]

  !!UN:N3/z704/y4/0;                    [refresh get monster name]
  !!UN:N3/z705/y4/1;                    [refresh get monsters name]
  !!IF&y60=1/999:Q2/20/y3/1/z199140;
  !!IF&y60>1/999:Q2/20/y3/1/z199141;
  !!HEx1&1000/999:Cy4/y60/-1/0/-1/0/-1/0/-1/0/-1/0/-1/0; [give creatures]
!!en;

!!if&x4=6;                              [6= +1moral]
  !!IF&1000/999:Q2/20/y3/14/1/1/z199142;         
  !!HEx1:R0/d1;                         [+1 morale]
!!en;

!!if&x4=7;
  !!IF&1000/999:Q2/20/y3/11/1/1/z199143;[7=+1luck]
  !!HEx1:R1/d1;                         [+1 luck]
!!en;

!!if&x4=8;                              [8= experience]
  !!HEx1:E?y5/?y6/1;                    [get hero's level]
  !!VRy60:Sy6*150R500;                  [(level + 0-20) x 50]
  !!VRy60&x5=1:Sy60R1000;               [Specialist]
  !!VRy60&y6>15:*2; !!VRy60&y6>22:*2; !!VRy60&y6>42:*2; !!VRy60&y6>50:*2; [Increase Exp with level so it doesnt get useless]
  !!IF&1000/999:Q2/20/y3/17/y60/1/z199144;       
  !!HEx1:Edy60;                         [give experience]
  !!en;

!!if&x4=9;                              [9= increase movement]
  !!IF&1000/999:Q2/20/y3/22/21/1/z199145;       
  !!HEx1:Wd400/1;                       [increase movement]
!!en;

!!if&x4=10;                             [area 10= reveal area]
  !!IF&1000/999:Q2/20/y3/24/21/1/z199146;
  !!VRy60:S3 *x2 +10;                   
  !!VRy60&x5=1:+3;
  !!UN&1000/999:Sy80/y81/y82/x3/y60;    [reveal area]
!!en;

!!if|x4=11/x4=12/x4=13;                 [12 = fight monsters]
  !!FU&-1000:E;                         [Exit if not human]
  !!FU(pick_a_monster):P?y4;            [call function to pick monster]
  !!MA:Hy4/?y60;                        [get AdvMapH]
  !!HEx1:E?y90/?y91/1;
  !!HEx1:F?y92/?y93/?y94/?y95;
  !!VRy78:Sy4;
  !!VRy78:%14;

  !!VRy45&y78<15:S1R1;
  !!VRy45&y78<12:S2R1;
  !!VRy45&y78<10:S4R2;
  !!VRy45&y78<5:S7R2;

  !!VRy5:Sy91 *y92 *y45;                [Level*Attack from Hero]
  !!VRy5::3;                            [a third of number of creatures to fight]
  !!VRy5&y5<50:S25R50;
  !!VRy47:Sy5;
  !!IF&1000/999:Q2/20/y3/21/y4/2/z199147;
  !!SN&2:W^Scouting_Fight_Trigger^/1;
  !!SN&-2:W^Scouting_Fight_Trigger^/0;
  !!HEx1&2/999:Ty80/y81/y82/y4/y5 O?o;  [fight monsters]
  !!if&o=(NO_OWNER);
    !!HEx1:P?y1/?y2/?y3 Z?y4;
    !!UN:Cy4/7/1/y1 Cy4/9/1/y1 Cy4/10/1/y3;
    !!FU:E;
  !!en;
  !!UN&2/999:R1;
!!en;

!!if&x4=14;                             [14=  Give Mithril]
  !!UN:P36/?v1;                         [Check if Mithril script is enabled: v1]
  !!FU&v1=0:E;                          [Exit if Mithril is not enabled]
  !!VRy61:S7;                           [random resource 6 to 7]
  !!VRy60:S1;                           [random quantity 1 to 1]
  !!VRy60&x5=1:+1;
  !!IF&1000/999:Q2/20/y3/y61/y60/1/z199149;
  !!OW:Rx3/y61/dy60;                    [give the resources]
!!en;

!!if&x4=15;                             [15=  Give Artifact]
  !!VRy1:S0R2;
  !!UN|y1=0/y1=1:J6/2/?y2;              [get a random Treasure artifact  2/3 chance]
  !!UN&y1=2:J6/4/?y2;                   [get a random Minor artifact  1/3 chance]
  !!IF&1000/999:Q2/20/y3/8/y2/1/z199150;
  !!HEx1:Ay2;                           [Give Artifact]
!!en;

!!if&x4=16;                             [16=  Teach Spell]
  !!HEx1:A2/0/d/?y15;                   [Check for Spell Book]
  !!FU&y15=0:E;                         [Exit if no Spell Book]
  !!FU(ACM_GenerateRandomSpell):P1/4/x1/?y-99; [Function to generate a random level 1-4 spell which skips banned spells]
  !!if&y-99>=0/y-99<=69;                [Valid Spell]
    !!HEx1:S7/?y14;                     [7 Wisdom]
    !!SSy-99:L?y5;                      [Spell Level]
    !!FU&y5=5/y14<3:E;                  [Exit if Wisdom level not high enough]
    !!FU&y5=4/y14<2:E;
    !!FU&y5=3/y14<1:E;
    !!IF&1000/999:Q2/20/y3/9/y-99/1/z199151;
    !!HEx1:My-99/1;                     [Give Spell]
  !!en;
!!en;

!!if&x4=18;                             [18=  Give ACM Reward]
  !!VRy31:S1R5;                         [currently there are 4 special rewards]
  !!VRz5&y31=1:S^%T(AC_Misc.Magic_Strength)^;
  !!VRz5&y31=2:S^%T(AC_Misc.Spell_Damage)^;
  !!VRz5&y31=3:S^%T(AC_Misc.Spell_Crit_Chance)^;
  !!VRz5&y31=4:S^%T(AC_Misc.Spell_Crit_Damage)^;
  !!VRz5&y31=5:S^%T(AC_Misc.Physical_Crit_Chance)^;
  !!VRz5&y31=6:S^%T(AC_Misc.Physical_Crit_Damage)^;

  !!SN&y31=1:W^ACM_Reward_Magic_Strength_%X1^/d2; [Add Bonus stat to hero]
  !!SN&y31=2:W^ACM_Reward_Spell_Damage_%X1^/d2; [...]
  !!SN&y31=3:W^ACM_Reward_Spell_Crit_Chance_%X1^/d1; [...]
  !!SN&y31=4:W^ACM_Reward_Spell_Crit_Damage_%X1^/d2; [...]
  !!SN&y31=5:W^ACM_Reward_Physical_Crit_Chance_%X1^/d1; [...]
  !!SN&y31=6:W^ACM_Reward_Physical_Crit_Damage_%X1^/d2; [...]
  !!SN:T^AC_Misc.scouting_reward^/?z-9 Iz-9/?z-9;
  !!IF&1000/999:Q2/20/y3/1/^%Z-9^;
!!en;

!!UN&1000/999:R1 R2;                    [redraw hero screen]


*** Generate Random Spell Number by Archer30 ***
!?FU(ACM_GenerateRandomSpell);
!#VA(minLevel:x) (maxLevel:x) (hero:x) (spell:x);

!!VR(spell):S(NO_SPELL);
!!FU(NewIntArray):P?(spellList:y);

!!re i/(SPELL_FIRST)/(SPELL_LAST_WOG);
  !!HE(hero):M=i/1;

  !!if&-1;
    !!SSi:L?(level:y);

    !!if&(level)>=(minLevel)/(level)<=(maxLevel);
      !!UN:J0/i/?(isDisabled:y);
      !!FU(Array_Push)&(isDisabled)<>(TRUE):P(spellList)/i;
    !!en;
  !!en;
!!en;

!!SN:M(spellList)/?(size:y);

!!if&(size)>0;
  !!VR(random:y):R0/1/(size) -1;
  !!SN:M(spellList)/(random)/?(spell);
!!en;


!?FU(OnAfterBattleUniversal);

!!SN:W^Scouting_Fight_Trigger^/?y1;
!!SN:W^Scouting_Fight_Trigger^/0;       [Reset Trigger]
!!FU&y1<>1:E;

!!BA:H0/?y1;                            [Attacker Hero Number]
!!FU&y1<0:E;                            [Exit if no Hero]
!!HEy1:O?y2;                            [get owner of this hero]
!!SN:W^Hero_Attacker_Owner0^/?y3;       [Check Owner Before Fight]

!!FU&y2<>y3:E;                          [Prevent to give Bonus if retreat]
!!FU&y2=-1:E;

!!VRy96:S1R4;
!!SN&y96=2:T^AC_Misc.Scout_Attack1^/?z-9 Iz-9/?z-9;
!!SN&y96=3:T^AC_Misc.Scout_Defense1^/?z-9 Iz-9/?z-9;
!!SN&y96=4:T^AC_Misc.Scout_SP1^/?z-9 Iz-9/?z-9;
!!SN&y96=5:T^AC_Misc.Scout_Knowledge1^/?z-9 Iz-9/?z-9;

!!IF&y96=2/1000/999:Q2/31/1/1^%Z-9^;
!!HEy1&y96=2:Fd1/d/d/d;
!!IF&y96=3/1000/999:Q2/32/1/1^%Z-9^;
!!HEy1&y96=3:Fd/d1/d/d;
!!IF&y96=4/1000/999:Q2/33/1/1^%Z-9^;
!!HEy1&y96=4:Fd/d/d1/d;
!!IF&y96=5/1000/999:Q2/34/1/1^%Z-9^;
!!HEy1&y96=5:Fd/d/d/d1;

!!UN&1000/999:R1;                       [redraw hero screen]
!!SN:W^Scouting_Fight_Trigger^/0;


** function to pick a monster
; by Archer30
!?FU(pick_a_monster);
!#VA(mon:x);                            [Return the random monster ID]
!#VA(minLevel:x);                       [Optional. Min Monster level, including the level specified]
!#VA(maxLevel:x);                       [Optional. Man Monster level, including the level specified]
!#VA(maxFightValue:x);                  [Optional. Max fight value allowed, including the value specified]

!!FU:A?(numArgs:y);

!!if&(numArgs)<3;
  !!VR(minLevel):S(MON_MIN_LEVEL);
  !!VR(maxLevel):S(MON_MAX_LEVEL);
!!en;

!!MA&(numArgs)<4:F(MON_BLOOD_DRAGON)/?(maxFightValue); [by default the max fight value is not greater than or equal to Blood Dragon's]

!!VR(mon):S(NO_MON);
!!FU(GetMaxMonsterId):P?(lastMon:y);

!!re i;
  !!VR(randMon:y):R0/(MON_FIRST)/(lastMon);
  ; Skip invalid monsters
  !!co|(randMon)=(MON_NOT_USED_1)/(randMon)=(MON_NOT_USED_2)/(randMon)=(MON_NOT_USED_3)/(randMon)=(MON_NOT_USED_4);
  !!co&(randMon)>=(MON_CATAPULT)/(randMon)<=(MON_ARROW_TOWERS);
  !!co&(randMon)>=(MON_EMISSARY_OF_WAR)/(randMon)<=(MON_EMISSARY_OF_LORE);
  !!co&(randMon)>=(MON_COMMANDER_FIRST_A)/(randMon)<=(MON_COMMANDER_LAST_D);

  ; Check if the monster is allowed to spawn
  !!MA:H(randMon)/?(advMapHigh:y);
  !!co&(advMapHigh)<=0;

  ; Check if the level and fight value are ideal
  !!MA:L(randMon)/?(level:y);

  !!if&(level)>=(minLevel)/(level)<=(maxLevel);
    !!MA:F(randMon)/?(fightValue:y);

    !!if&(fightValue)>0/(fightValue)<(maxFightValue);
      !!VR(mon):S(randMon);

      !!SN:H^monname^/(mon)/0/?z704;    [get monster name]
      !!SN:H^monname^/(mon)/1/?z705;    [get monsters name]

      !!br;
    !!en;
  !!en;
!!en;


***************************Diplomacy********************************************
*Chance to increase Stack Size of Hero after every fight*
*Chance and Amount of creatures that join your army is based on Diplo Skill and Artifacts

!#SN:W^ACM_Diplomacy_Price_Default^/200;[Default price for creatures is 200 percent]
!#SN:W^ACM_Diplomacy_Price_Old_Diplo^/250; 


!?FU(OnGameEnter)&i^timerDay^=1;        [At gamestart]

!!UN:U54/-1/?y2;
!!VRv2:S-1;
!!SN:W^acm_Classic_Diplomacy^/?y1;      [If class Diplo option is enabled dont set monsters to agressive]
!!DO(ACM_Monster_Agression)/1/y2/1&y1=0:P; [Loop through all monsters on the map]

!?FU(ACM_Monster_Agression);

!!VRv2&x16=1:S-1;
!!UN:U54/-1/-1/2;
!!MOv2/v3/v4:R?y1/1;                    [Get the Agression for all Monsters]
!!FU&y1=0:E;                            [Exit]
!!MOv2/v3/v4:R10/1;                     [Set all Monster to never Join at Map Start]

!?FU(OnAfterBattleUniversal);           [After Combat]

!!BA:H0/?y1;                            [Attacker Hero Number]
!!FU&y1<0:E;

!!HEy1:O?y25;                           [Check hero owner]
!!OW:C?y26;                             [Check current player]
!!FU&y25<>y26:E;                        [Abort if not the same]
!!FU&y25=-1:E;                          [Exit if not the same as before fight]

!!HEy1:S4/?y10;                         [Check Diplomacy]
!!FU&y10=0:E;                           [Exit if not]

!!FU(Calc_Diplomacy_values):Py1/?y4/?y40/?y80;

!!VRy21:S0R100; 
!!FU&y21>y4:E;                          [Exit if y4 smaller random R100 Roll] 

!!SN:W^H3_Diplomacy_Creature^/-1;
!!SN:W^H3_Diplomacy_Creature_Anzahl^/-1;

!!SN:W^H3_Diplomacy_0_Hero%Y1^/?y11;
!!SN:W^H3_Diplomacy_1_Hero%Y1^/?y12;

!!VRy90:S0;
[:loop50]; loop is label name inside current trigger
!!VRy90:+1;
!!VRy20:S0R6;
!!FU(H3_Diplomacy_Growth):Py1/y20;      [Choose a stack from hero creatures]
!!FU&y90=100:E;                         [Exit complete Function if no Creature can be found]
!!SN:W^H3_Diplomacy_Creature^/?y5;
!!SN:W^H3_Diplomacy_Creature_Anzahl^/?y6;
!!SN|y5=-1/y6=-1:G[loop50];

!!UN:N3/2/y5/1;                         [Get Monster Name in z1]
!!MA:Cy5/6/?y22;                        [Get the gold cost of that creature]
!!MA:Cy5/0/?y90; !!MA:Cy5/1/?y91; !!MA:Cy5/2/?y92; !!MA:Cy5/3/?y93; !!MA:Cy5/4/?y94; !!MA:Cy5/5/?y95;; [get resource cost of that creature]

!!VRy23:S2Ry40+100;                     [Range 2% til y40% for amount of joiners]
!!VRy3:Sy6*y23:100-y6;                  [Calculate y23% of Creatures]
!!VRy3&y3=0:S1;                         [At least one monster will ask to join]
!!VRy3&y3>1000:S1000;                   [Never more than 1000 monsters will join]

!!VRy98:S0;                             [Initialize Res cost to zero]
!!VRy98&y90>0:Sy90*y3; !!VRy98&y91>0:Sy91*y3; !!VRy98&y92>0:Sy92*y3; !!VRy98&y93>0:Sy93*y3; !!VRy98&y94>0:Sy94*y3; !!VRy98&y95>0:Sy95*y3; [Check if one res is required]
!!VRy99:S(NO_RES);
!!VRy99&y90>0:S0; !!VRy99&y91>0:S1; !!VRy99&y92>0:S2; !!VRy99&y93>0:S3; !!VRy99&y94>0:S4; !!VRy99&y95>0:S5; [;]

!!MA:Ly5/?y70;                          [Get creature level]
!!VRy3&y70<=4/y3<=1:S2R2;               [If Monster level 5 and below 2 set to 2-4 to avoid very low amount of joiners]
!!VRy3&y70<=3/y3<=2:S3R3;               [If Monster level 3 and 4 and below 4 set to 3-6]
!!VRy3&y70<=1/y3<=5:S5R5;               [If Monster level 1 and 2 and below 6 set to 5-10]

!!VRy22:*y3;                            [Total Hiring Costs]
!!VRy22&y22<1:S2000000000;              [Set to 2 Billions in case of overflow]
!!SN:W^acm_Classic_Diplomacy^/?y97;
!!SN:W^ACM_Diplomacy_Price_Default^/?y58;
!!SN:W^ACM_Diplomacy_Price_Old_Diplo^/?y59;
!!VRy22&y97=0:*y58:100;                 [Increase costs by +100%]
!!VRy22&y97=1:*y59:100;                 [Increase costs by +150% if original Diplo is also enabled]

!!VRy22:*y80:100;                       [Calc new gold costs]
!!VRy98:*y80:100;                       [Calc new resources costs]
!!VRy22&y22<1:S1;                       [So costs can never be negative]

!!SN&y98=0:T^AC_Misc.Diplomacy 1^/?z4/^gold^/y22/^value^/y3;
!!SN&y98>0:T^AC_Misc.Diplomacy 3^/?z4/^gold^/y22/^value^/y3/^amount^/y98/^type^/y99;
!!SN:Iz4/?z4;
!!IF&1000/999:Q2/21/y5/2/z4;            [show message to human player only]
!!IF&-1000:V2/1;                        [For AI players always accept by setting Flag 2 true]

!!if&2;                                 [if presses Yes by human]
  !!OW:Ry25/6/?y27;                     [Check players Gold]

  !!if&y99>(NO_RES);
    !!OW:Ry25/y99/?y30;                 [Check players Res]
  !!el;
    !!VRy30:S(INT_MAX);
  !!en;

  !!VRy28:Sy22*-1;                      [Make Gold amount negative]
  !!VRy31:Sy98*-1;                      [Make Res amount negative]

  !!if&y22<y27/y98<y30;
    !!OW:Ry25/6/dy28;                   [Substract amount from player]
    !!OW&y99>(NO_RES):Ry25/y99/dy31;    [Substract amount from player]
    !!HEy1&1000:C0/y20/d/dy3/0/0;       [Add creatures to Hero Army for human]
    !!HEy1&-1000:C0/y20/d/dy3/0/0;      [Add creatures to Hero Army for AI without choice]
    !!UN&1000:R2;                       [Refresh res bar]
  !!el&1000;
    !!SN:T^AC_Misc.Diplomacy 2^/?z4 Iz4/?z4;
    !!IF:Q1/(PIC_TYPE_MONEY)/1500/(MSG_TYPE_MES)/^%z4^; [show message]
    !!OW:Ry25/6/d1500;             [Add gold to player]
    !!UN:R2;
  !!en;
!!en;


!?FU(H3_Diplomacy_Growth);

!!HEx1:C0/x2/?y1/?y2;
!!FU|y2<2/y1<0:E;                       [Exit if stack only 1 or no creature found]

; Exit if the creature cannot be generated (is unique)
!!MA:Hy1/?y30;
!!FU&y30<=0:E;

!!SN:W^H3_Diplomacy_Creature^/y1;       
!!SN:W^H3_Diplomacy_Creature_Anzahl^/y2;


!?FU(Calc_Diplomacy_values);
x1=hero, x2=returns chance to attract, x3=returns number of creatures, x4=returns hiring costs

!!HEx1:S4/?y10;                         [Check Diplomacy]
!!SN:W^H3_Diplomacy_0_Hero%X1^/?y11;    [Checke ob der Held Master Diplomacy hat und Speichere in y11]
!!SN:W^H3_Diplomacy_1_Hero%X1^/?y12;    [Checke ob der Held Grandmaster Diplomacy hat und Speichere in y12]

!!VRy4&y10=1:S20; !!VRy4&y10=2:S24; !!VRy4&y10=3:S28; !!VRy4&y10=3/y11=1/y12=0:S32; !!VRy4&y10=3/y11=1/y12=1:S35; [Chance to join]

!!HEx1:A2/66/?y49/?y66;
!!HEx1:A2/67/?y49/?y67; !!VRy4&y67=1:+10;[67 Diplomat's Ring    +10% chance to attract]
!!HEx1:A2/68/?y49/?y68;

!!VRy4&y66=1/y67=1/y68=1:+10;           [Double Bonus if complete Set (+20%)]

!!HEx1:X?y61/?y62/?y63/?y64/?y65/?y56/?y57; [Check Hero Diplo Speciality]
!!if&y61=0/y62=4;                       [if Diplomacy]
  !!HEx1:E?y46/?y47/1;                  [Check hero Level]
  !!VRy48:Sy47:4+1;                     [Chance to attract]
  !!VRy49:Sy47:10+1;                    [Number of creatures]
  !!VRy50:Sy47:2+1;                     [Reduced hiring costs]
  !!VRy4:+y48;                          [Add chance to attract if Diplo Speciality]
!!en;
!!VRx2:Sy4;                             [Return value]

!!VRy40:S5;                             [initial max 5% growth]
!!VRy40&y68=1:+2;                       [+2% growth if Ambassador's Sash]
!!VRy40&y66=1/y67=1/y68=1:+2;           [+2% growth if complete set]
!!VRy40&y61=0/y62=4:+y49;               [+y49% growth if specialist]
!!VRx3:Sy40;                            [Return value]

!!VRy80:S100;
!!VRy80&y61=0/y62=4:-y50;               [Reduce hiring cost by speciality]
!!VRy80&y66=1:-15;                      [Reduce hiring cost by artifact (15%)]
!!VRy80&y66=1/y67=1/y68=1:-15;          [Reduce hiring cost by artifact -(15%) if set complete]
!!VRx4:Sy80;                            [Return value]


!?FU(OnHeroScreenMouseClick);
*Show current values for diplomacy skill. Needs to be changed and move to different location.
!!HE-1:N?y1;                            [Get current Hero]
!!HEy1:S4/?y2;                          [Check Diplomacy Skill]
!!FU&y2=0:E;

!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v6<>512/v5<>14:E;                  [If not Necromancy Icon Clicked Exit]

!!if|v3=512/v3=0;                       [if right or left click]
  !!if|v4=79/v4=80/v4=81/v4=82/v4=83/v4=84/v4=85/v4=86/v4=501/v4=504;
    !!VRv4:-78;                         [To hit correct Secondary Skill ID]
    !!FU|v4<0/v4>8:E;
    !!HEy1:Sv4/?y5/1;
    !!FU&y5<>4:E;                       [Exit if no Diplomacy]

    !!CM:R0;

    !!FU(Calc_Diplomacy_values):Py1/?y48/?y49/?y50;
    !!SN:W^ACM_Diplomacy_Price_Default^/?y30;
    !!SN:W^ACM_Diplomacy_Price_Old_Diplo^/?y40; 
    !!SN:W^acm_Classic_Diplomacy^/?y97;
    !!VRy49:+2;                         [Range of joiners is a value between 2% and y49]
    !!VRy60:S100-y50;
    !!VRy35&y97=0:Sy30-y60;
    !!VRy35&y97=1:Sy40-y60;
    !!SN:T^AC_Misc.Diplomacy_4^/?z1 Iz1/?z1;
    !!IF:M^%Z1^;
  !!en;
!!en;


***************************Navigation*******************************************
*+1 to all primary skills at Bas Adv  when in battle
*+2 to all primary skills at expert  when in battle
*+2 Master
*+3 GM

!?BF&1000;                              [Combat Start]

!!FU:E;                                 [Disabled and Replaced by Nobility]
!!BA:H0/?y1;                            [Attacker]
!!HEy1:S5/?y3;                          [Navigation]
!!SN:W^H3_Navigation_0_Hero%Y1^/?y11;   [Checke ob der Held Master Navigation hat und Speichere in y11]
!!SN:W^H3_Navigation_1_Hero%Y1^/?y12;   [Checke ob der Held Grandmaster Navigation hat und Speichere in y12]
!!VRy4&y3=1:S1; !!VRy4&y3=2:S1; !!VRy4&y3=3:S2; !!VRy4&y3=3/y11=1:S2; !!VRy4&y3=3/y12=1:S3;
!!DO(AC_Function_7)/0/20/1&y3>0:Py4;

!!BA:H1/?y4;                            [Defender]
!!FU&y4<0:E;                            [Exit if no Navigation]
!!HEy4:S5/?y3;                          [Navigation]

!!SN:W^H3_Navigation_0_Hero%Y4^/?y11;   [Checke ob der Held Master Navigation hat und Speichere in y11]
!!SN:W^H3_Navigation_1_Hero%Y4^/?y12;   [Checke ob der Held Grandmaster Navigation hat und Speichere in y12]

!!VRy4&y3=1:S1; !!VRy4&y3=2:S1; !!VRy4&y3=3:S2; !!VRy4&y3=3/y11=1:S2; !!VRy4&y3=3/y12=1:S3;
!!DO(AC_Function_7)/21/41/1&y3>0:Py4;

!?FU(AC_Function_7);                    [increase Units Stats]

!!BMx16:Adx1;
!!BMx16:Ddx1;


*-------------------------------Leadership------------------------------------------*
*Master Leadership +4 Morale, GrandMaster +5 Morale
**Deal Extra damage in the Current Battle Round if Stack Had Moral
; New implementation with OnStackToStackDamage for displaying correct damage on mouse hint
; by Archer30
!?FU(OnStackToStackDamage_Quit);
!#VA(atkStack:x) (defStack:x) (finalDmgConst:x) (finalDmg:x) (basicDmg:x) (dmgBonus:x) (isDistant:x) (distanceArg:x) (isTheoretical:x);

!!BM(atkStack):F?(monFlags:y);
!!VR(isMorale:y):S(monFlags) &(MON_FLAG_MORALE);

!!if&(isMorale);
  !!FU(ACM_GetActualStackSide):P(atkStack)/?(side:y);

  !!if&i^battle_hero_%(side)^>(NO_HERO);
    !!VR(hero:y):Si^battle_hero_%(side)^;
    !!HE(hero):S(SKILL_LEADERSHIP)/?(level:y);

    !!if&(level)>=(SKILL_EXPERT)/i^H3_Leadership_0_Hero%(hero)^;
      !!if&i^H3_Leadership_1_Hero%(hero)^=0;
        !!VR(finalDmgNew:y):S(finalDmg) *11 :10; [Archer30: It's recommended to calculate the final damage based on finalDmgConst]
      !!el;
        !!VR(finalDmgNew):S(finalDmg) *5 :4;
      !!en;

      !!if&(finalDmgNew)>(finalDmg);
        !!if&i^battle_isVisible^/(isTheoretical)<>(TRUE);
          !!VR(finalDmgDiff:y):S(finalDmgNew) -(finalDmg);
          !!VR(type:y):Si^H3_Leadership_1_Hero%(hero)^+1;
          !!SN:T^AC_Misc.Leadership %(type)^/?(msg:z)/^damage^/(finalDmgDiff);
          !!MM:S(msg);
        !!en;

        !!VR(finalDmg):S(finalDmgNew);
      !!en;
    !!en;
  !!en;
!!en;

; Replaced by Archer30's new implementation as it's been reported dealing extra damage even when the stack had no morale
!?MF1;                                  [*Physical Combat *]
!!FU:E;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676;[Only run when melee or shooting damage]

!!MF:W?y80;
!!FU&y80>0:E;

!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]

!!BG:A?y1;
!!if&y1=6|y1=7;

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Leadership_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]

!!SN:W^Leadership_Attacking_Stack^/y4;

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;
!!HEy99:S6/?y81;                        [Checke current hero Leadership hat]
!!SN:W^H3_Leadership_0_Hero%Y99^/?y11;  [Checke ob der Held Master Leadership hat und Speichere in y11]
!!SN:W^H3_Leadership_1_Hero%Y99^/?y12;  [Checke ob der Held Grandmaster Leadership hat und Speichere in y12]
!!FU|y81<3/y11=0:E;                     [Exit if not Expert Leadership]

!!SN:W^Leadership_Current_battle_round^/?y3;
!!SN:W^Leadership_Stack_had_Moral^/?y51;

!!if&y3=v997/y1=y51;
!!MF:F?y6;
!!VRy7&y11=1/y12=0:Sy6 *110:100;        [10% Extra Damage]
!!VRy7&y11=1/y12=1:Sy6 *125:100;        [25% Extra Damage]
!!MF:Fy7;
!!VRy8:Sy7 -y6;

!!BA:Q?f;
!!SN&y11=1/y12=0:T^AC_Misc.Leadership 1^/?z-1/^damage^/y8;
!!SN&y11=1/y12=1:T^AC_Misc.Leadership 2^/?z-1/^damage^/y8;
!!MM&i^battle_isVisible^:Sz-1;
!!SN:W^Leadership_Current_battle_round^/-1;
!!SN:W^Leadership_Stack_had_Moral^/-1;
!!en;
!!en;
!!en;

!?BG0;
!!FU:E;

!!BG:N?y1;                              [attacking stack]
!!BMy1:I?y2;                            [Side index as for heroes (0:left, 1:right)]
!!BG:Q?y40;

!!if&y2=y40;                            [so it only works for attacking not defending]
!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;
!!HEy99:S6/?y81;                        [Checke current hero Leadership hat]
!!SN:W^H3_Leadership_0_Hero%Y99^/?y11;  [Checke ob der Held Master Leadership hat und Speichere in y11]
!!SN:W^H3_Leadership_1_Hero%Y99^/?y12;  [Checke ob der Held Grandmaster Leadership hat und Speichere in y11]
!!FU|y81<3/y11=0:E;

!!BMy1:F?i;                             [read flags]
!!VRi:&16777216;                        [just look at moral bit]
!!SN&i>0:W^Leadership_Stack_had_Moral^/y1; [Save stack number]
!!SN&i>0:W^Leadership_Current_battle_round^/v997; [Save current battle round]
!!en;


**************************Mysticism*********************************************
**Master Adds 15 Points
**GrandMaster Adds 25 Points per Round and 10% of max spell points regeneration

*Handels all Spell Point Regeneration aswell*

!?FU(OnEveryDay)&i^timerOnce^=1/i^timerIsAi^=0;
!!DO(AC_Function_8)/0/155/1:P;          [loop thru heroes]

!?FU(AC_Function_8);
*** Spell Point bonus ***
x2= returns amount of spell points that get regenerate per day
!!VRx16&x3=1:Sx1;                       [Set x16 to hero ID]
!!HEx16:O?y1;                           [Checke Hero Owner]
!!FU&y1=-1:E;                           [Exit if none]

!!HEx16:S8/?y1;                         [Check level of Mysticism]

!!SN:W^H3_Mysticism_0_Hero%X16^/?y11;   [Checke ob der Held Master Mysticism hat und Speichere in y11]
!!SN:W^H3_Mysticism_1_Hero%X16^/?y12;   [Checke ob der Held Grandmaster Mysticism hat und Speichere in y12]
!!SN:W^H3_Intelligence_0_Hero%X16^/?y21;[Checke ob der Held Master Mysticism hat und Speichere in y11]
!!SN:W^H3_Intelligence_1_Hero%X16^/?y22;[Checke ob der Held Grandmaster Mysticism hat und Speichere in y12]

!!FU(Intelligence_Set_Spell_Points)&x16>=0/x16<=155:Px16/0/?y5/1; [Return Max possible spell points for left Hero in y5]

!!HEx16:I?y7/1;                         [get current spell points]

**Set regen Rate**
!!VRy8:S0;
!!VRy8&y1=1:S5;                         [Basic]
!!VRy8&y1=2:S10;                        [Advanced]
!!VRy8&y1=3/y11=0/y12=0:S15;            [Expert]
!!VRy8&y1=3/y11=1/y12=0:S20;            [Master Mysticism]
!!VRy8&y1=3/y11=1/y12=1:S25;            [Grandmaster Mysticism]

!!VRy6:Sy5;
!!VRy6&y1=1:*105:100-y5;                [Calc 5% of total Hero Spell Points]
!!VRy6&y1=2:*106:100-y5;                [Calc 6% of total Hero Spell Points]
!!VRy6&y1=3/y11=0/y12=0:*107:100-y5;    [Calc 7% of total Hero Spell Points]
!!VRy6&y1=3/y11=1/y12=0:*108:100-y5;    [Calc 8% of total Hero Spell Points]
!!VRy6&y1=3/y11=1/y12=1:*110:100-y5;    [Calc 10% of total Hero Spell Points]

!!VRy8&y1>0:+y6;                        [Add percentage bases spell points regeneration]

!!HEx16:A2/73/?y70/?y72;                [73 Charm of Mana]
!!VRy8&y72=1:+3;
!!HEx16:A2/74/?y70/?y72;                [74 Talisman of Mana]
!!VRy8&y72=1:+4;
!!HEx16:A2/75/?y70/?y72;                [75 Mystic Orb of Mana]
!!VRy8&y72=1:+5;
!!HEx16:A2/138/?y70/?y72;               [138 Wizard's Well]
!!if&y72=1;
  !!VRy8:+194;                          [gives 200 SP in total]
  !!VRy40:Sy5;                          [Set max spell points to y40]
  !!VRy40:*120:100-y5;                  [Calc 20% of total Hero Spell Points]
  !!VRy8:+y40;                          [Add percentage bases spell points regeneration]
!!en;

!!VRy8:+1;                              [All Heroes regenerate 2 spell points daily, instead of just 1]

**Add regen if Specialists
!!HEx16:X?y50/?y51/?y60/?y60/?y60/?y60/?y60; [Check Hero Speciality]
!!HEx16:E?y52/?y53/1;                   [Get Level of Hero]
!!VRy54:Sy53:2;                         [Half level]
!!VRy8&y50=0/y51=8:+y54;                [Add Spell Points for Mysticism Specialists  Dont know why they need -1?]
*!IF:M^Current Spell Points %Y7 Add %Y8 and Speciality gives %Y54^;
**

!!if&x3=1/x4=1;                         [Total amount of regenerated SP and not fake amount]
  !!HEx16:A2/73/?y70/?y72;              [73 Charm of Mana]
  !!VRy8&y72=1:+1;
  !!HEx16:A2/74/?y70/?y72;              [74 Talisman of Mana]
  !!VRy8&y72=1:+2;
  !!HEx16:A2/75/?y70/?y72;              [75 Mystic Orb of Mana]
  !!VRy8&y72=1:+3;
  !!HEx16:A2/138/?y70/?y72;  
  !!VRy8&y72=1:+6;                      [why? looks like WW gives 6 sp always?]

  !!VRx2:Sy8+1;                         [Set x8 to reg points so function can return it, value +1 because of base reg]
!!en;

!!VRy9:Sy8;
!!VRy9&y1>0:+1;                         [+1 extra spell point in case the hero has Mysticism]
!!VRy8:+y7;                             [add current spell points]
!!VRy9&y8>y5:Sy5 -y7;                   [if under normal max now, but over after, set to normal after]
!!VRy9&y7>=y5|y8<0:S0;                  [if result is normal max, or negative, set to zero]
!!HEx16&x4=0:Idy9/1;                    [Add hero spell points  Changed]


************************Luck****************************************************
**Chance for Bonus Luck before Battles
**Changed how Luck works, now 5 is max, after that damage increases, also negative Luck up to -5
Taken from Algor Era Scripts
** M/GM Luck gives +4/5 Luck

!?FU(OnHeroScreenMouseClick)|i^mouse_action^=(MOUSE_LMB_PRESSED)/i^mouse_action^=(MOUSE_RMB_PRESSED);           [Luck click]
!!CM:F?v3 I?v4 T?v6;                    [where we click and click subtype]
!!FU|v4<>117/v6<>512:E;                 [If not Luck Icon Clicked Exit]

!!if|v3=512/v3=0;                         [if right or left click]
  !!HE-1:N?y1;                            [Get current hero # 9 Luck]
  !!FU(Get_Luck_Moral):Py1/9/?y10;
  !!HEy1:R1/?y9;
  !!VRy10:+y9;                            [plus temporarily modifier]
  !!SN:W^H3_Luck_0_Hero%Y1^/?y11;         [Checke ob der Held Master Luck hat und Speichere in y11]
  !!SN:W^H3_Luck_1_Hero%Y1^/?y12;         [Checke ob der Held Grandmaster Luck hat und Speichere in y12]
  !!VRy10&y11=1:-1;                       [compensate temporarily modifier to display correct value]
  !!VRy10&y12=1:-1;                       [compensate temporarily modifier to display correct value]
  !!VRy5&y10<=5:S150;                     [50% damage with Luck up to 5]
  !!VRy8:Sy10-5;
  !!VRy5&y8>0:S10*y8+150;
  !!HEy1:S9/?y3;
  !!VRy20&y3=0:S0; !!VRy20&y3=1:S10; !!VRy20&y3=2:S15; !!VRy20&y3=3/y11=0/y12=0:S20; !!VRy20&y3=3/y11=1/y12=0:S25; !!VRy20&y3=3/y11=1/y12=1:S30; [Increase +10-30% Luck damage per Skill]
  !!VRy5:+y20;
  !!HEy1:X?y23/?y24/?y25/?y25/?y25/?y25/?y25; [Check Hero Speciality]

  !!if&y23=0/y24=9;                       [If Luck Specialists]
    !!HEy1:E?y47/?y48/1;                  [Get Hero Level]
    !!VRy5:+10+y48;                       [Add 10 plus 1 percent per level Luck damage]
  !!en;

  !!VRy6&y10=0:S0; !!VRy6|y10=1/y10=-1:S4; !!VRy6|y10=2/y10=-2:S7; !!VRy6|y10=3/y10=-3:S10; !!VRy6|y10=4/y10=-4:S12; !!VRy6|y10>=5/y10<=-5:S15; [Set Luck Strike Chance]
  !!FU(Count_Set_Pieces):Py1/0/0/0/0/?y95;[Check for The Adventures Fidelity]

  !!if&y95=4;
    !!VRy6&y10=6:S16; !!VRy6&y10=7:S17; !!VRy6&y10=8:S18; !!VRy6&y10=9:S19; !!VRy6&y10=10:S20; !!VRy6&y10=11:S21; !!VRy6&y10=12:S22; !!VRy6&y10=13:S23; !!VRy6&y10=14:S24; !!VRy6&y10>=15:S25; [Set Luck Strike Chance]
  !!en;
  !!VRy7:Sy10;                            [Set luck]
  *!IF:M^Current Luck is %Y10 and Temp is %Y9  and y7 is %Y7^;
  !!SN&y10>0:T^AC_Misc.Luck_Positive^/?z2/^damage^/y5/^chance^/y6/^value^/y7;
  !!SN&y10=0:T^AC_Misc.Luck_Neutral^/?z2/^damage^/y5/^chance^/y6/^value^/y7;
  !!SN&y10<0:T^AC_Misc.Luck_Negative^/?z2/^damage^/y5/^chance^/y6/^value^/y7;

  !!VRy30:S(MSG_TYPE_MES);
  !!VRy30&i^mouse_action^=(MOUSE_RMB_PRESSED):S(MSG_TYPE_POPUP);

  !!IF&y10>0:Q1/11/0/y30/z2;                [show description for Hero Speciality when right click]
  !!IF&y10=0:Q1/12/0/y30/z2;                [show description for Hero Speciality when right click]
  !!IF&y10<0:Q1/13/0/y30/z2;                [show description for Hero Speciality when right click]
  !!CM:R0;                                [disable standard reaction]
!!en;

!?FU(OnHeroScreenMouseClick);           [Morale Icon click]

!!FU:E;                                 [Disable Morale]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>116/v6<>512/v5=13:E;           [If not Luck Icon Clicked Exit]
!!if|v3=512/v3=0;                       [if right or left click]
!!HE-1:N?y1;                            [Get current hero]
!!FU(Get_Luck_Moral):Py1/6/?y10;
!!HEy1:R0/?y9;
!!VRy10:+y9;                            [plus temporarily modifier]
!!VRy5&y10<=6:S100;                     [100% damage with Morale up to 6]
!!VRy8:Sy10-6;
!!VRy5&y8>0:S10*y8+150;
!!VRy6:S3*y10;                          [3% chance per point of Morale]
!!VRy7:Sy10;                            [Set Morale]

!!SN&y10>0:T^AC_Misc.Morale_Positive^/?z2/^damage^/y5/^chance^/y6/^value^/y7;
!!SN&y10=0:T^AC_Misc.Morale_Neutral^/?z2/^damage^/y5/^chance^/y6/^value^/y7;
!!SN&y10<0:T^AC_Misc.Morale_Negative^/?z2/^damage^/y5/^chance^/y6/^value^/y7;
!!IF&y10>0:Q1/14/0/4/z2;                [show description for Hero Speciality when right click]
!!IF&y10=0:Q1/15/0/4/z2;                [show description for Hero Speciality when right click]
!!IF&y10<0:Q1/16/0/4/z2;                [show description for Hero Speciality when right click]
!!CM:R0;                                [disable standard reaction]
!!en;

!?FU(Get_Luck_Moral);
*x1=Hero Number, x2=Luck9 or Moral6, x3=Returns value
!!VRy10:S0; !!VRy11:S0; !!VRy12:S0; !!VRy13:S0; !!VRy14:S0; !!VRy15:S0; !!VRy16:S0; !!VRy17:S0; !!VRy18:S0; !!VRy19:S0; !!VRy20:S0;

!!if&x2=9;                              [Luck skill ID]
  !!VRx3:S0;
  !!HEx1:S9/?y10;                       [get Luck secondary skill]
  !!SN:W^H3_Luck_0_Hero%X1^/?y11;       [Checke ob der Held Master Luck hat und Speichere in y11]
  !!SN:W^H3_Luck_1_Hero%X1^/?y12;       [Checke ob der Held Grandmaster Luck hat und Speichere in y12]

  *check artifacts that give Luck
  !!HEx1:A2/45/?y13/?y14;
  !!HEx1:A2/46/?y13/?y15;
  !!HEx1:A2/47/?y13/?y16;
  !!HEx1:A2/48/?y13/?y17;
  !!HEx1:A2/108/?y13/?y18; !!VRy18&y18=1:S3;
  !!HEx1:A2/243/?y13/?y19; !!VRy19&y19=1:S2;
  !!HEx1:A2/246/?y13/?y20; !!VRy20&y20=1:S3; 


  *check for Spirit Guardian that gives +2 Luck
  !!UN:U98/-1/?y2;                      [Get the Number of total Towns on the map in y2]
  !!VRv2:S-1;                           [Search Index]
  !!re i/1/y2;                          [loop towns]
    !!UN:U98/-1/-1/2;                   [Get Coordinates of Town]
    !!OBv2/v3/v4:U?y3;                  [Get Subtype]
    !!OBv2/v3/v4:T?y4;                  [Get Type ID]
    !!CAv2/v3/v4&y4=98/y3=1:O?y6;
    !!CAv2/v3/v4&y4=98/y3=1:B3/26;
    !!HEx1:O?y7;                        [get owner]
    !!VRy21:S0;
    !!VRy21&y4=98/y3=1/1/y6=y7:S2;      [increase luck by 2 if building was found]
    !!if&y4=98/y3=1/1/y6=y7;
     !!br;                              [Stop searching]
    !!en;
  !!en;

  !!VRx3:+y10+y11+y12+y14+y15+y16+y17+y18; [add up total luck and return value in x3]
  !!VRx3:+y19+y20+y21;
!!en;


!!if&x2=6; Leadership skill ID
  !!VRx3:S0;
  !!HEx1:S6/?y10;
  !!SN:W^H3_Leadership_0_Hero%Y1^/?y11;   [Checke ob der Held Master Moral hat und Speichere in y11]
  !!SN:W^H3_Leadership_1_Hero%Y1^/?y12;   [Checke ob der Held Grandmaster Moral hat und Speichere in y12]

  !!HEx1:A2/45/?y13/?y14;
  !!HEx1:A2/49/?y13/?y15;
  !!HEx1:A2/50/?y13/?y16;
  !!HEx1:A2/51/?y13/?y17;
  !!HEx1:A2/108/?y13/?y18;
  !!VRx3:+y10+y11+y12+y14+y15+y16+y17+y18+y18+y18;
!!en;


!?FU(OnAfterBattleUniversal);
*Master/Grandmaser Luck/Morale gives +4/5

!!BA:H0/?y1;
!!if&y1>=0/y1<=155;
!!SN:W^H3_Luck_0_Hero%Y1^/?y11;         [Checke ob der Held Master Luck hat und Speichere in y11]
!!SN:W^H3_Luck_1_Hero%Y1^/?y12;         [Checke ob der Held Grandmaster Luck hat und Speichere in y12]
!!HEy1&y11=1:R1/d1;                     [+1 Luck]
!!HEy1&y12=1:R1/d1;                     [+1 Luck]

!!SN:W^H3_Leadership_0_Hero%Y1^/?y11;   [Checke ob der Held Master Moral hat und Speichere in y11]
!!SN:W^H3_Leadership_1_Hero%Y1^/?y12;   [Checke ob der Held Grandmaster Moral hat und Speichere in y12]
!!HEy1&y11=1:R0/d1;                     [+1 Moral]
!!HEy1&y12=1:R0/d1;                     [+1 Moral]
!!en;

!!BA:H1/?y1;
!!if&y1>=0/y1<=155;
!!SN:W^H3_Luck_0_Hero%Y1^/?y11;         [Checke ob der Held Master Luck hat und Speichere in y11]
!!SN:W^H3_Luck_1_Hero%Y1^/?y12;         [Checke ob der Held Grandmaster Luck hat und Speichere in y12]
!!HEy1&y11=1:R1/d1;                     [+1 Luck]
!!HEy1&y12=1:R1/d1;                     [+1 Luck]

!!SN:W^H3_Leadership_0_Hero%Y1^/?y11;   [Checke ob der Held Master Moral hat und Speichere in y11]
!!SN:W^H3_Leadership_1_Hero%Y1^/?y12;   [Checke ob der Held Grandmaster Moral hat und Speichere in y12]
!!HEy1&y11=1:R0/d1;                     [+1 Moral]
!!HEy1&y12=1:R0/d1;                     [+1 Moral]
!!en;


 ***************************************************************************************************
* SN:W^Att_Luck_Type^/0;
* SN:W^Ret_Luck_Type^/0;
* SN:W^ATT_LUCK_BONUS_FACTOR^/0;
* SN:W^RET_LUCK_BONUS_FACTOR^/0;
*     0 not active, + good luck, - bad luck
* +/- 1 shoot animation pending
* +/- 2 melee animation pending
* +/- 3 done animation

!#SN:W^X_Luck2_On^/1;

*==============================================================================*

*==============================================================================*
; Archer30: Note that triggering Good Luck may result in damage overflow (lacking value check before MF:D/F multiplication).
; Also, some physical attacks may happen outside of BG phases, which completley skip luck definition here.
!?BG0;

!!SN:W^Att_Luck_Type^/0;
!!SN:W^Ret_Luck_Type^/0;
!!SN:W^ATT_LUCK_BONUS_FACTOR^/0;
!!SN:W^RET_LUCK_BONUS_FACTOR^/0;

!!BG:A?y71 N?y72 E?y82;
!!FU|y72<0/y72>41:E;                    [Exit if not a valid stack]
!!BMy72:N?y76 T?y77;

!!FU|y71<6/y71>7:E;
!!FU|y76<1/y77<0:E;
!!FU|y77=145/y77=147/y77=148/y77=149:E; [Exit for Warmachines]

*!IF&y82<0:M^Error: luck BG0 ActionType=%y71 ActionStack=%y72 (TargetStack=%y82)<0^;
!!FU&y82<0:E;

!!BMy72:G213/?y2/?t;
!!BMy82:G213/?y3/?t;

!!FU&y2=0/y3=0:E;

!!BMy72:G213/0/?t;
!!BMy82:G213/0/?t;

!!VRy12:S0R999;
!!VRy13:S0R999;

!!SN:W^ATT_LUCK_BONUS_FACTOR^/150;
!!SN:W^RET_LUCK_BONUS_FACTOR^/150;
!!VRy22:Sy2*50;
!!VRy23:Sy3*50;
!!VRy22&y2<0:*-1;
!!VRy23&y3<0:*-1;

!!if&i^Advanced_Classes_Mod_Active^>0;
!!FU(Calc_ACM_Luck_Prob_And_Factor):Py72/y2/?y22/?i^ATT_LUCK_BONUS_FACTOR^;
!!FU(Calc_ACM_Luck_Prob_And_Factor):Py82/y3/?y23/?i^RET_LUCK_BONUS_FACTOR^;
!!en;

!!if&y2>0/y12<y22;                      [Case_Attack_Good_Luck]
    !!if&y71=6;
        !!SN:W^Att_Luck_Type^/2;
    !!el&y71=7;
        !!FU(Show_Good_Luck):Py72;
        !!SN:W^Att_Luck_Type^/3;
    !!en;
!!el&y2<0/y12<y22;                      [Case_Attack_Bad_Luck]
    !!if&y71=6;
        !!SN:W^Att_Luck_Type^/-2;
    !!el&y71=7;
        !!FU(Show_Bad_Luck):Py72;
        !!SN:W^Att_Luck_Type^/-3;
    !!en;
!!en;

!!if&y3>0/y13<y23;                     [Case_Retaliation_Good_Luck]
!!SN&y71=6:W^Ret_Luck_Type^/2;
!!SN&y71=7:W^Ret_Luck_Type^/1;
!!el&y3<0/y13<y23;                     [Case_Retaliation_Bad_Luck]
!!SN&y71=6:W^Ret_Luck_Type^/-2;
!!SN&y71=7:W^Ret_Luck_Type^/-1;
!!en;


!?MF1;
!!UN:C42149568/4/?y20;
!!FU|y20=4458589/y20=4460149/y20=4460621/y20=4461137/y20=4610404/y20=4627096/y20=5902442:E;

!!SN:W^Att_Luck_Type^/?y10;
!!SN:W^Ret_Luck_Type^/?y11;
!!FU&y10=0/y11=0:E;

!!BG:N?y72 E?y82;
!!FU|y72<0/y72>41:E;                    [Exit if not a valid stack]
!!MF:N?y97;

!!if&y97<>y72;                          [Case_Attack]
!!if&y10=2;                             [good strike pending animation]
  !!FU(Show_Good_Luck):Py72;
  !!VRy10:S3;
!!en;
!!if&y10=3;                             [good luck done animation]
  !!MF:D?y1 F?y2;
  !!VRy1:*i^ATT_LUCK_BONUS_FACTOR^ :100;
  !!VRy2:*i^ATT_LUCK_BONUS_FACTOR^ :100;
  !!MF:Dy1 Fy2;
!!en;

!!if&y10=-2;                            [bad strike pending animation]
  !!FU(Show_Bad_Luck):Py72;
  !!VRy10:S-3;
!!en;
!!if&y10=-3;                            [bad luck done animation]
  !!MF:D?y1 F?y2;
  !!VRy1::2;
  !!VRy2::2;
  !!VRy1&y1<1:S1;
  !!VRy2&y2<1:S1;
  !!MF:Dy1 Fy2;
!!en;
!!en;

!!if&y97=y72;                           [Case_Retaliation]
!!if&y11=2;                             [good strike pending animation]
  !!FU(Show_Good_Luck):Py82;
  !!VRy10:S-3;
!!en;
!!if&y11=3;                             [good luck done animation]
  !!MF:D?y1 F?y2;
  !!VRy1:*i^RET_LUCK_BONUS_FACTOR^ :100;
  !!VRy2:*i^RET_LUCK_BONUS_FACTOR^ :100;
  !!MF:Dy1 Fy2;
!!en;

!!if&y11=-2;                            [bad strike pending animation]
  !!FU(Show_Bad_Luck):Py82;
  !!VRy11:S-3;
!!en;
!!if&y11=-3;                            [bad luck done animation]
  !!MF:D?y1 F?y2;
  !!VRy1::2;
  !!VRy2::2;
  !!VRy1&y1<1:S1;
  !!VRy2&y2<1:S1;
  !!MF:Dy1 Fy2;
!!en;
!!en;

!?FU(Calc_ACM_Luck_Prob_And_Factor);

!!BMx1:I?y1;!!BHy1:N?y40;
!!VRy2:Sx2;

*Calc Prob
!!VRy5:S0;
!!VRy5|y2=1/y2=-1:S40; !!VRy5|y2=2/y2=-2:S70; !!VRy5|y2=3/y2=-3:S100; !!VRy5|y2=4/y2=-4:S125; !!VRy5|y2>=5/y2<=-5:S150;
!!FU(Count_Set_Pieces):Py40/0/0/0/0/?y95;[Check for The Adventures Fidelity, removes the Luck cap and allows endless scaling]
!!if&y95=4;
!!VRy5&y2=6:S160; !!VRy5&y2=7:S170; !!VRy5&y2=8:S180; !!VRy5&y2=9:S190; !!VRy5&y2=10:S200; !!VRy5&y2=11:S210; !!VRy5&y2=12:S220; !!VRy5&y2=13:S230; !!VRy5&y2=14:S240; !!VRy5&y2>=15:S250; [Set Luck Strike Chance]
!!en;
!!VRx3:Sy5;

*Calc Factor
!!VRy10:S0;
!!if&y2>0;
  !!VRy10&y2<=5:S150;                   [50% damage with Luck up to 5]
  !!VRy10&y2=6:S160; !!VRy10&y2=7:S170; !!VRy10&y2=8:S180; !!VRy10&y2=9:S190; !!VRy10&y2>=10:S200;

  !!if&y40>=0/y40<=155;
    !!HEy40:S9/?y3;
    !!SN:W^H3_Luck_0_Hero%Y40^/?y11;    [Checke ob der Held Master Luck hat und Speichere in y11]
    !!SN:W^H3_Luck_1_Hero%Y40^/?y12;    [Checke ob der Held Grandmaster Luck hat und Speichere in y12]
    !!VRy20&y3=0:S0; !!VRy20&y3=1:S10; !!VRy20&y3=2:S15; !!VRy20&y3=3/y11=0/y12=0:S20; !!VRy20&y3=3/y11=1/y12=0:S25; !!VRy20&y3=3/y11=1/y12=1:S30; [Increase +10% Luck damage per Skill of Luck]
    !!VRy10:+y20;
    !!HEy40:X?y23/?y24/?y25/?y25/?y25/?y25/?y25; [Check Hero Speciality]
    !!if&y23=0/y24=9;                   [If Luck Specialists]
      !!HEy40:E?y47/?y48/1;             [Get Hero Level]
      !!VRy10:+10+y48;                  [Add 10 plus 1 percent per level Luck damage]
    !!en;
  !!en;
!!en;
!!VRx4:Sy10;


!?FU(Show_Good_Luck)&i^battle_isVisible^;
!!if&x1>=0/x1<=41;
  !!VRz1:S^GOODLUCK^;
  !!SN:Pz1;
  !!BMx1:V18 T?y7;
  !!UN:N3/2/y7/1;
  !!SN:T^AC_Misc.Goodluck^/?z3;
  !!BU:Mz3;
!!en;

!?FU(Show_Bad_Luck)&i^battle_isVisible^;
!!if&x1>=0/x1<=41;
  !!VRz1:S^Misfort^;
  !!SN:Pz1;
  !!BMx1:V48 T?y7;
  !!UN:N3/2/y7/1;
  !!SN:T^AC_Misc.Badluck^/?z3;
  !!BU:Mz3;
!!en;


***************
!?FU(OnBeforeBattleUniversal);          [Combat Start]
!!FU:E;                                 [Disabled]
!!BA:H0/?y1;
!!FU(Improved_Luck_Bonus0):Py1/1;

!!BA:H1/?y2;                            [Defending Hero]
!!FU(Improved_Luck_Bonus0)&y2>=0:Py2/2;


!?FU(Improved_Luck_Bonus0);

!!HEx1:S9/?y33;                         [Check for Luck Skill]
!!HEx1:E?y39/?y40/1;                    [Check Hero Level]

!!SN:W^H3_Luck_0_Hero%X1^/?y11;         [Checke ob der Held Master Luck hat und Speichere in y11]
!!SN:W^H3_Luck_1_Hero%X1^/?y12;         [Checke ob der Held Grandmaster Luck hat und Speichere in y12]


!!if&y33>0;
!!VRy10&y33=1:S1R25;                    [Basic]
!!VRy10&y33=2:S1R22;                    [Advanced]
!!VRy10&y33=3/y11=0/y12=0:S1R20;        [Expert]
!!VRy10&y33=3/y11=1/y12=0:S1R17;        [Master]
!!VRy10&y33=3/y11=1/y12=1:S1R15;        [GrandMaster]

!!FU&y10>2:E;                           [Exit Chance is ca 10% for a Bonus]

!!VRy11&y10=1:S1R3;  !!SN&y10=1:T^AC_Misc.Scout_Attack^/?z-1;
!!VRy11&y10=2:S1R3;  !!SN&y10=2:T^AC_Misc.Scout_Defense^/?z-1;
!!VRy11&y10=3:S3R4;  !!SN&y10=3:T^AC_Misc.Scout_Health^/?z-1;
!!VRy11&y10=4:S1R1;  !!SN&y10=4:T^AC_Misc.Scout_Speed^/?z-1;

!!VRy40&y10=1|y10=2::10;                [Divide Hero level trough 10 to get more bonus with higher level]
!!VRy40&y10=3::7;
!!VRy40&y10=4::20;                      [Reduce for Speed]
!!VRy11:+y40;


!!HEx1:B0/?z-10;                        [get hero name]
!!HEx1:O?y88;
!!OW:Iy88/?y89;                         [Check for AI Player so it only humans see the message]

!!SN:T^AC_Misc.Luck Bonus^/?z4 Iz4/?z4;
!!IF&1000/999/y89=0:M^%Z4^;

!!SN&x2=1:W^Prepare_For_Battle_Att^/y10;[Activate Battle Flag Attacker]
!!SN&x2=2:W^Prepare_For_Battle_Def^/y10;[Activate Battle Flag Defender]
!!SN:W^Prepare_For_Battle_Bonus^/y11;   [Save Bonus]
!!en;


!?BF;                                   [Combat Start]

!!SN:W^Prepare_For_Battle_Att^/?y80;
!!DO(AC_Function_9)/0/20/1&y80>0:Py80;

!!SN:W^Prepare_For_Battle_Def^/?y80;
!!DO(AC_Function_9)/21/41/1&y80>0:Py80;

!!SN:W^Prepare_For_Battle_Att^/0;
!!SN:W^Prepare_For_Battle_Def^/0;
!!SN:W^Prepare_For_Battle_Bonus^/0;


!?FU(AC_Function_9);                    [increase Units Stats]
!!BMx16:T?y1 N?y2; !!FU&y2=0:E;
!!FU|y1=145/y1=146/y1=147/y1=148/y1=149:E; [Execlude Warmachines]
!!SN:W^Prepare_For_Battle_Bonus^/?y10;

!!if&x1=1;                              [Attack]
  !!BMx16:Ady10;
!!en;

!!if&x1=2;                              [Defense]
  !!BMx16:Ddy10;
!!en;

!!if&x1=3;                              [Health]
  !!VRy10:+100;
  !!BMx16:H?y1;
  !!BMx16:N?y20;                          [Hit Points of stack: y2]
  !!FU&y20=0:E;                           [Exit if zero health]
  !!VRy2:Sy1*y10:100;
  !!VRy2&y2=y1:+1;                        [Min +1HP for low level troops]
  !!BMx16:Hy2;
!!en;

!!if&x1=4;                              [Speed]
  !!BMx16:Sdy10;
!!en;


************************Ballistics**********************************************
*Doubles the HP of all War Machines and increases the damage of Ranged Attacks
*+4 Attack in a Siege
*+6 Attack Master
*+8 Attack GM

!?FU(OnCombatRound)&v997=0;             [On First Visible combat round. Trigger goes later to give Bonus when WM are already summoned in the CB]

!!BA:S?y1;
!!BA:H0/?y2;                            [Attacker]
!!HEy2:S10/?y3;                         [Ballistics]

!!SN:W^H3_Ballistics_0_Hero%Y2^/?y11;   [Checke ob der Held Master Ballistics hat und Speichere in y11]
!!SN:W^H3_Ballistics_1_Hero%Y2^/?y12;   [Checke ob der Held Grandmaster Ballistics hat und Speichere in y12]

!!VRy10&y3=1:S2; !!VRy10&y3=2:S3; !!VRy10&y3=3/y11=0/y12=0:S4; !!VRy10&y3=3/y11=1/y12=0:S6; !!VRy10&y3=3/y11=1/y12=1:S8;

!!DO(AC_Function_10)/0/20/1&y3>0:Py10/y1;[Pass Attack Bonus and Siege state]

!!BA:H1/?y4;                            [Defender]
!!FU&y4<0:E;
!!HEy4:S10/?y3;                         [Ballistics]

!!SN:W^H3_Ballistics_0_Hero%Y4^/?y11;   [Checke ob der Held Master Ballistics hat und Speichere in y11]
!!SN:W^H3_Ballistics_1_Hero%Y4^/?y12;   [Checke ob der Held Grandmaster Ballistics hat und Speichere in y12]

!!VRy10&y3=1:S2; !!VRy10&y3=2:S3; !!VRy10&y3=3/y11=0/y12=0:S4; !!VRy10&y3=3/y11=1/y12=0:S6; !!VRy10&y3=3/y11=1/y12=1:S8;
!!DO(AC_Function_10)/21/41/1&y3>0:Py10/y1;

!?FU(AC_Function_10);                   [increase Units Stats]
!!BMx16:T?y1;
!!if|y1=145/y1=146/y1=147/y1=148;
  !!BMx16:H?y2;
  !!BMx16:N?y20;                        [Creature Number y20]
  !!if&y20>0;
    !!VRy2&x1=2:*3:2;                   [50%HP for Basic]
    !!VRy2&x1=3:*7:4;                   [75%HP for A]
    !!VRy2&x1=4:*2;                     [100%HP for E]
    !!VRy2&x1=6:*5:2;                   [150%HP for Master]
    !!VRy2&x1=8:*3;                     [200%HP for Grandmaster]
    !!BMx16:Hy2;
  !!en;
!!en;
!!BMx16&x2=1:Adx1;                      [Give Attack to Monsters]

!!BMx16:F?i;                            [Give damage to Shooters]
!!VRi:&4;                               [Check for Shooter]
!!if&i>0;
  !!BMx16|x1=2/x1=3:U2/d1;              [1 Max Damage Basic/Advanced every fight]
  !!BMx16|x1=4/x1=6:U2/d2;              [2 Max Damage at Expert every fight]
  !!BMx16&x1=8:U2/d3;                   [3 Max Damage at GM every fight]
!!en;

!?FU(OnBattleRegeneratePhase);

!!FU:E;                                 [Disabled until better Solution found]
!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]
!!SN:X?y1;
!!BMy1:I?y2;
!!UN:C7734719/4/171;                    [Restore (mon=171) No Obstacle Penalty]
!!UN:C7724390/4/171;                    [Restore (mon=171) No Range Penalty]
!!BA:Hy2/?y2;                           [Attacker]
!!FU&y2<0:E;
!!HEy2:S10/?y3;                         [Ballistics]
!!SN:W^H3_Ballistics_0_Hero%Y2^/?y11;   [Checke ob der Held Master Ballistics hat und Speichere in y11]
!!FU|y3<3/y11=0:E;                      [Exit if no Ballistics]
!!SN:W^H3_Ballistics_1_Hero%Y2^/?y12;   [Checke ob der Held Grandmaster Ballistics hat und Speichere in y12]

!!BMy1:T?y2;
!!BMy1:F?i;
!!VRi:&4;
!!if&i>0/y12=1;                         [if Shooter and Grandmaster Ballistics]
!!UN:C7734719/4/y2;                     [No Obstacle Penalty]
!!UN:C7724390/4/y2;                     [No Range Penalty]
!!en;

!!if&i>0/y12=0;                         [if no Shooter Restore]
!!UN:C7734719/4/171;                    [Restore (mon=171) No Obstacle Penalty]
!!UN:C7724390/4/171;                    [Restore (mon=171) No Range Penalty]
!!en;


************************Eagle Eye***********************************************
**Learn spell up to 5th level directly in combat and gain 1 Spell Power when learning spells**

Vision of the Eagle: If the skill is granted by the Set and not the actual skill, you gain only percentage of the complete set but the chance to learn
!?BG0&1000;

!!SN:W^Eagle_Eye_Spell_0^/0;
!!BG:A?y1;                              [Aktion in y1 Must be Hero Cast]
!!FU&y1<>1:E;                           [Exit if not Hero cast]

!!BG:Q?y1;                              [Get Battle Side]
!!VRy1:-1*-1;
!!BA:Hy1/?y99;                          [Get Hero]
!!FU&y99=-2:E;                          [Exit if no Hero]

!!HEy99:S11/?y10;                       [11 Eagle Eye]
!!FU(Count_Set_Pieces_2):Py99/0/0/0/0/0/?y20; [Count Vision of the Eagle Set Pieces]
!!FU&y10=0/y20<3:E;                     [If set is complete and hero has no EE skill give basic Eagle Eye Skill]

!!HEy99:A2/(ART_META_SPELLBOOK)/?y30/?y31; [Get spell book]
!!FU&y31<=0:E;                          [Exit if no spell book]

!!SN:W^H3_Eagle Eye_0_Hero%Y99^/?y11;
!!SN:W^H3_Eagle Eye_1_Hero%Y99^/?y12;
!!VRy40:S0;
!!VRy40&y10=1:S50; !!VRy40&y10=2:S65; !!VRy40&y10=3/y11=0/y12=0:S75; !!VRy40&y10=3/y11=1/y12=0:S85; !!VRy40&y10=3/y11=1/y12=1:S100; [Set Eagle Eye chance]
!!HEy99:A2/63/?y29/?y30; !!VRy40&y30=1:+15; [Bird of Perception]
!!HEy99:A2/64/?y29/?y30; !!VRy40&y30=1:+20; [Stoic Watchman]
!!HEy99:A2/65/?y29/?y30; !!VRy40&y30=1:+25; [Emblem of Cognizance]
!!VRy50:S0R100;                         [Create random number]

!!FU&y50>y40:E;                         [Exit if roll fails]
!!HEy99:S7/?y14;                        [7 Wisdom]
!!BG:S?y4;                              [Spell Number]
!!if&y4>=10/y4<=69;                     [Valid Spell]
  !!SSy4:L?y5;                          [Spell Level]
  !!FU&y5=5/y14<3:E;                    [Exit if Wisdom level not high enough]
  !!FU&y5=4/y14<2:E;
  !!FU&y5=3/y14<1:E;
  !!HEy99:My4/?y7;                      [Check if Hero already knows the spell]
  !!SN:W^Hero%Y99_Spell%Y4_Specialists^/?y8; [Check saved spells before battle]
  !!if&y7=0/y8=0;                       [If Hero doesnt know the spell and also not currently just unlearned]
    !!HEy99:My4/1;                      [Give Hero the new spell]
    !!SN:W^Hero%Y99_Spell%Y4_Specialists^/1; [Fix for Sorcery or Elemental Specialists]
    !!SN&y1=0:W^Attacker_Spell%Y4_Temp_Learned^/1; [Save Spell for Battle replay case]
    !!SN&y1=1:W^Defender_Spell%Y4_Temp_Learned^/1; [Save Spell for Battle replay case]
    !!SN:W^Eagle_Eye_Spell_0^/y4;
  !!en;
!!en;


!?BG1&1000;                             [After Battle Action Trigger for Eagle Eye]

!!SN:W^Eagle_Eye_Spell_0^/?y1;          [Exit if flag is zero]
!!FU&y1=0:E;
!!BG:Q?y2;
!!VRy2:-1*-1;                           [Get opposing hero]
!!BHy2:N?y2;
!!FU&y2<0:E;                            [Exit if no Hero]
!!HEy2:B0/?z1;                          [get hero's name]

!!HEy2:O?y3;                            [Checke Hero Owner]
!!FU&y3=-1:E;                           [Exit if no owner]
!!OW:Iy3/?y3;                           [AI/Human]
!!FU&y3=1:E;                            [Exit if Human or player Killed to prevent Eagle Eye Message]

!!HEy2:S11/?y50;                        [11 Eagle Eye]
!!FU(Count_Set_Pieces_2):Py2/0/0/0/0/0/?y20; [Count Vision of the Eagle Set Pieces]
!!VRy40:S1;                             [1 SP]
!!VRy40&y20=3/y50>0:S2;                 [2 SP with full set]
!!VRy40&y20=3/y50=0:S1;                 [Give only 1 SP with only set equipped]

!!if&i^battle_isVisible^;
  !!SN:T^AC_Misc.Eagle_Eye_Spell^/?z3/^value^/y40; !!SN:Iz3/?z3;
  !!IF:Q1/9/y1/1/z3;                    [Show spell learning screen for hero]
!!en;
!!HEy2:Fd/d/?y1/d;                      [Check Hero Spell Power]
!!HEy2&y1<99:Fd/d/dy40/d;               [Gain +1 Spell Power for every successfull EE proc]


!?FU(OnBeforeBattleUniversal);
*reset Eagle Eye variables
!!re i/9/69;                            [loop trough all spells]
  !!SN:W^Attacker_Spell%i_Temp_Learned^/0; [reset spell variable to zero]
  !!SN:W^Defender_Spell%i_Temp_Learned^/0; [reset spell variable to zero]
!!en;

!?FU(OnBattleReplay);
*During battle replay unlearn all spells that were learned with Eagle Eye in previous battle
!!re i/9/69;                            [loop trough all spells]
!!SN:W^Attacker_Spell%i_Temp_Learned^/?y1; [Get saved spell ID]
!!if&y1>0;  
  !!BH0:N?y2;                           [Get attacking hero number]  
  !!HEy2:Mi/0;                          [Unlearned spell that was learned by Eagle Eye]
  !!SN:W^Attacker_Spell%i_Temp_Learned^/0; [reset spell variable to zero]
!!en;
!!en;

!!re i/9/69;                            [loop trough all spells]
!!SN:W^Defender_Spell%i_Temp_Learned^/?y1; [Get saved spell ID]
!!if&y1>0;  
  !!BH1:N?y2;                           [Get attacking hero number]  
  !!HEy2:Mi/0;                          [Unlearned spell that was learned by Eagle Eye]
  !!SN:W^Defender_Spell%i_Temp_Learned^/0; [reset spell variable to zero]
!!en;
!!en;


******************
*Eagle Eye deals damage before combat based on the hero spell power, also known as Magic Artillery
!?FU(OnBattleStackObtainsTurn);
!!SN:W^Magic_Artillery_Shoot_Flag^/?y1;    
!!FU&y1=1:E;

!!BA:Q?f;                               [Check for quick battle]
!!BA:H0/?y1;                            [get attacking hero #]
!!HEy1:S11/?y8;                         [check EE]
!!BA:H1/?y10;                           [get defending hero #]
!!HEy10&y10>=0:A2/65/?y22/?y23 B0/?z1;  [Check defender for Emblem of Cognizance, this prevents the damage from EE]
!!if&i^battle_isVisible^/y23=1/y8>0; 
  !!SN:T^AC_Misc.Magic_Artillery_Prot^/?z2/^name^/z1 Iz2/?z2;
  !!BU:Mz2;
  !!SN:W^Magic_Artillery_Shoot_Flag^/1; [reset var after action]
!!en;
!!FU(Magic_Artillery_Shoot1)&y8>0/y23=0:P0/y1; [shoot something - attacker if defender does not have artifact]

!!BA:H1/?y1;                            [get defending hero #]
!!FU&y1<0:E;
!!HEy1:S11/?y8;                         [see if defending hero has Eagle Eye]
!!BA:H0/?y10;                           [get defending hero #]
!!HEy10&y10>=0:A2/65/?y22/?y23 B0/?z1;  [Check defender for Emblem of Cognizance, this prevents the damage from EE]
!!if&i^battle_isVisible^/y23=1/y8>0;
  !!SN:T^AC_Misc.Magic_Artillery_Prot^/?z2/^name^/z1 Iz2/?z2;
  !!BU:Mz2;
  !!SN:W^Magic_Artillery_Shoot_Flag^/1; [reset var after action]
!!en;
!!FU(Magic_Artillery_Shoot1)&y8>0/y23=0:P1/y1; [shoot something - defender if attacker does not have artifact]


** function to handle Magic Artillery, skill level y1
!?FU(Magic_Artillery_Shoot1);

!!HEx2:A2/5/?y7/?y8 A2/63/?y20/?y21 A2/64/?y22/?y23 A2/65/?y24/?y25 E?y3/?y4/1 S11/?y1 F?y9/?y10/?y11/?y12; [check for Ammo Cart, Watchman, Emblem, Bird, get hero's level, eagle eye level, heroes spell power]
!!HEx2:B0/?z1;                          [Get Hero Name]

!!SN:W^H3_Eagle Eye_0_Hero%X2^/?y31;    [Checke ob der Held Master Eagle Eye hat und Speichere in y11]
!!SN:W^H3_Eagle Eye_1_Hero%X2^/?y32;    [Checke ob der Held Grandmaster Eagle Eye hat und Speichere in y12]

!!VRy5:S1;                              [set multiplier to 1]
!!VRy5&y1>0:+y1;                        [Eagle eye skill lvl bonus +3 at expert]
!!VRy5&y31=1:+1;                        [Damage Boost at Master]
!!VRy5&y32=1:+1;                        [Damage Boost at GrandMaster]
!!VRy5&y8>0:+1;                         [ammo cart bonus]
*!VRy5&y25>0:+1;                        [Emblem bonus]
!!VRy5&y23>0:+1;                        [Watchman bonus]
!!VRy5&y21>0:+1;                        [Bird bonus]
!!VRy5&y21>0/y23>0/y25>0:+3;            [Complete Eagle Eye set adds additional +300% Bonus]

!!VRy11:*4;                             [Spell Power times four]
!!VRy3:S1R49 +y11 *y5;                  [Magic_Artillery damage: (1-50 + spell power*4) x bonus multiplier]

!!VRy30:S1 +y11 *y5;                    [Min Damage]
!!VRy31:S50  +y11 *y5;                  [Max Damage]
!!SN:W^EagleEye_Low_Damage_Hero%X2^/y30;[Save Low Damage to display it in Bonus List]
!!SN:W^EagleEye_High_Damage_Hero%X2^/y31;[Save High Damage to display it in Bonus List]
!!FU&x3=1:E;                            [Exit here to not run the actual shooting fkt]

!!FU(ACM_Generate_Random_Stack):Px1/?y40;[return a random enemy stack to shoot]

!!if&y40>=0/y40<=41;                    [If enemy stack is valid]
  !!BMy40:Ky3;                          [apply damage to the target]

  !!if&i^battle_isVisible^;
    !!VRz5:S^mag_ray.wav^;              [load sound file]
    !!SN:Pz5;                           [Play Sound]
    !!BMy40:V49;                        [Play animation]
    !!SN:T^AC_Misc.Magic Artillery 1^/?z4/^damage^/y3 Iz4/?z4;
    !!BU:Mz4;                           [print line in battlelog]
  !!en;

  !!SN:W^Magic_Artillery_Shoot_Flag^/1; [reset var after action]

  !!FU(ACM_DrawActionPlay):P;           [update creature animation to avoid using BU R, which can lead to crash]
  !!FU(ACM_ExecutePhoenixResurrection):P;[Revive the stack (if it's a phoenix) in case it's killed]
!!en;


!?FU(ACM_Generate_Random_Stack);
**x1=current side(0-1)
**x2=random enemy stack
!!VRx2:S(NO_STACK);				   
!!VRv8:C0/0/0;
!!DO(ACM_Generate_Random_Stack_0)/21/41/1&x1=0:P-1;     
!!DO(ACM_Generate_Random_Stack_0)/0/20/1&x1=1:P-1;
!!FU&v8<1:E;
!!VRy1:S1 Rv8;
!!VRy1&y1>v8:Sv8;
!!DO(ACM_Generate_Random_Stack_0)/21/41/1&x1=0:P-2/y1; 
!!DO(ACM_Generate_Random_Stack_0)/0/20/1&x1=1:P-2/y1;
!!FU&v10<0:E;
!!VRx2:Sv10;
!!VRv8:C0/0/0;

!?FU(ACM_Generate_Random_Stack_0)&x1=-1;
!!BMx16:T?y10 N?y11;
!!FU&y10>144/y10<150:E;  exclude war machines
!!FU|y10=124/y11<1:E;
!!VRv8:+1;

!?FU(ACM_Generate_Random_Stack_0)&x1=-2;
!!BMx16:T?y10 N?y11;
!!FU&y10>144/y10<150:E;
!!FU|y10=124/y11<1:E;
!!FU&v9=x2:E;
!!VRv9:+1;
!!VRv10:Sx16;


***********************Alternative Necromancy***************************************
**Master Ressurects 20%
**Grandmaster Ressurects 25%
** And Nekropolis Creature Specialists get little chance to ressurect their creature after battle
!?FU(ACM_OnResetHero);
!#VA(hero:x);

!!VRi^H3_Necromancy_Choice_%(hero)^:S0;

!?FU(OnHeroScreenMouseClick)&i^Alternative_Necromancy_Mod^/i^mouse_action^=(MOUSE_LMB_PRESSED);

!!HE-1:N?y1;                            [Get current Hero]
!!HEy1:S12/?y2;                         [Check Necromancy Skill]
!!FU&y2=0:E;

!!CM:I?v4;               [where we click and click subtype]

!!if|v4=79/v4=80/v4=81/v4=82/v4=83/v4=84/v4=85/v4=86/v4=501/v4=504;
  !!VRv4:-78;                         [To hit correct Secondary Skill ID]
  !!FU|v4<0/v4>8:E;
  !!HEy1:Sv4/?y5/1;
  !!FU&y5<>12:E;                      [Exit if no Necromancy]

  !!FU(ACM_GetDefaultNecromancyMon):P(CURRENT_HERO)/?y30;
  !!SN:H^monname^/y30/1/?z30;
  !!SN:T^AC_Misc.Necromancy_Text^/?z1;[set text in header]
  !!SN:T^AC_Misc.Necromancy_Creature_1^/?z2/^mon^/z30; [default monster]
  !!SN:T^AC_Misc.Necromancy_Creature_3^/?z3; [58] Walking Dead]
  !!SN:T^AC_Misc.Necromancy_Creature_5^/?z4; [60] Wight]
  !!SN:T^AC_Misc.Necromancy_Creature_15^/?z5; [62] Vampires]
  !!SN:T^AC_Misc.Necromancy_Creature_16^/?z6; [64] Liches]
  !!SN:T^AC_Misc.Necromancy_Creature_17^/?z7; [66  Black Knight]

  ; Set default option based on the current selection
  !!VRy32:S0;
  !!FU(ACM_FixAlternativeNecromancyChoice):Py1;
  !!VRy31:Si^H3_Necromancy_Choice_%y1^;

  !!if&y31=0;
    !!VRy32:S1;
  !!el&y31=(MON_WALKING_DEAD);
    !!VRy32:S2;
  !!el&y31=(MON_WIGHT);
    !!VRy32:S4;
  !!el&y31=(MON_VAMPIRE);
    !!VRy32:S8;
  !!el&y31=(MON_LICH);
    !!VRy32:S16;
  !!el&y31=(MON_BLACK_KNIGHT);
    !!VRy32:S32;
  !!en;

  !!IF:G1/3/y32/1/2/3/4/5/6/7/^%T(era.buttons.cancel)^/0/0/0/0/;[Show Choice Dialouge]

  !!CM:R0;                            [Disable standard reaction]

  !!SN&v3=1:W^H3_Necromancy_Choice_%y1^/0;
  !!SN&v3=2:W^H3_Necromancy_Choice_%y1^/(MON_WALKING_DEAD);
  !!SN&v3=4:W^H3_Necromancy_Choice_%y1^/(MON_WIGHT);
  !!SN&v3=8:W^H3_Necromancy_Choice_%y1^/(MON_VAMPIRE);
  !!SN&v3=16:W^H3_Necromancy_Choice_%y1^/(MON_LICH);
  !!SN&v3=32:W^H3_Necromancy_Choice_%y1^/(MON_BLACK_KNIGHT);

  !!FU(ACM_FixAlternativeNecromancyChoice):Py1;
!!en;


!?FU(ACM_FixAlternativeNecromancyChoice);
!#VA(hero:x);

!!VR(monType:y):S0;
!!HE(hero):S(SKILL_NECROMANCY)/?(level:y);

!!if&(level)>=(SKILL_EXPERT);
  ; Expert
  !!if&i^H3_Necromancy_Choice_%(hero)^=(MON_WALKING_DEAD);
    !!VR(monType):S(MON_WALKING_DEAD);
  ; Master
  !!el&i^H3_Necromancy_Choice_%(hero)^=(MON_WIGHT);
    !!VR(monType)&i^H3_Necromancy_0_Hero%(hero)^:S(MON_WIGHT);
  ; Grandmaster
  !!el&i^H3_Necromancy_Choice_%(hero)^>(MON_WIGHT);
    !!VR(monType)&i^H3_Necromancy_0_Hero%(hero)^/i^H3_Necromancy_1_Hero%(hero)^:Si^H3_Necromancy_Choice_%(hero)^;
  !!en;
!!en;

!!VRi^H3_Necromancy_Choice_%(hero)^:S(monType);


!?FU(ACM_GetDefaultNecromancyMon);
!#VA(hero:x) (result:x);

!!VR(result):S(MON_SKELETON);
!!FU&(hero)<=(NO_HERO):E;                        [Exit if no hero]

!!HE(hero):A2/(ART_CLOAK_OF_THE_UNDEAD_KING)/?(has:y)/?(equipped:y);

!!if&(equipped)>0;
  !!HE(hero):S(SKILL_NECROMANCY)/?(level:y);
  
  !!if&(level)=(SKILL_BASIC);
    !!VR(result):S(MON_WALKING_DEAD);
  !!el&(level)=(SKILL_ADVANCED);
    !!VR(result):S(MON_WIGHT);
  !!el;
    !!VR(result):S(MON_LICH);
  !!en;
!!en;


// Change the type of Necromancy creature for Alternative Necromancy
; Archer30
!?FU(ACM_OnDetermineNecromancyMon);     [Also works for AI]
!#VA(hook:x);

!!UN:C(hook)/(STRUCT_HOOK_CONTEXT_ECX)/(UNC_INT)/?(heroStruct:y) C(heroStruct)/26/(UNC_INT)/?(hero:y);
!!FU&(hero)<(NO_HERO):E;                [fail safe]

; Change Necromancy raising monster only if it's been set other than Skeletons
; This means if it's set to Skeletons from the dialog, Cloak of Undead King will work as usual
; Check if it is really eligible for Alternative Necromancy
!!FU(ACM_FixAlternativeNecromancyChoice)&i^H3_Necromancy_Choice_%(hero)^>0:P(hero);

; If it really does, implement the change
; Don't merge this with the upper part!
!!if&i^H3_Necromancy_Choice_%(hero)^>0;
  !!SN:X?t/(FALSE);
  !!UN:C(hook)/(STRUCT_HOOK_CONTEXT_EAX)/(UNC_INT)/i^H3_Necromancy_Choice_%(hero)^;
  !!UN:C(hook)/(STRUCT_HOOK_CONTEXT_RET)/(UNC_INT)/5127998;
!!en;


!?FU(OnBeforeBattleUniversal);

*Cloak of the Undead King raises TUM creatures if mod is active
*!SN:W^Typhon_Third_Upgrade_Mod_Active^/?y99; [Check for Third Upgrade Mod]
*!if&y99=1;
  *!UN:C5127967/4/222;                  [Liches]
  *!UN:C5127978/4/261;                  [Spectre]
  *!UN:C5127987/4/330;                  [Ghoul]
*!en;

*!BA:H0/?y1;                            [Attacker]
*!HEy1:O?y2;                            [Check hero owner]
*!OW:C?y3;                              [Check current player]
*!FU&y2<>y3:E;                          [Abort if not the same]

*!HEy1:S12/?y10;                        [Check for Necromancy]
*!SN:W^H3_Necromancy_0_Hero%Y1^/?y11;   [Checke ob der Held Master Necromancy hat und Speichere in y11]
*!SN:W^H3_Necromancy_1_Hero%Y1^/?y12;   [Checke ob der Held Grandmaster Necromancy hat und Speichere in y12]

*!FU(SetSecSkillPercent):P12/3/30;      [Set Skillvalue to 15% for Expert Necromancy]
*!FU(SetSecSkillPercent)&y10=3/y11=1/y12=0:P12/3/34;      [Set Skillvalue to 17% for Master Necromancy]
*!FU(SetSecSkillPercent)&y10=3/y11=1/y12=1:P12/3/40;      [Set Skillvalue to 20% for Grandmaster Necromancy]

*!if&y99=1;                             [If TUM enabled] Test
  *!FU(SetSecSkillPercent):P12/3/15;    [Set Skillvalue to 15% for Expert Necromancy]
  *!FU(SetSecSkillPercent)&y10=3/y11=1/y12=0:P12/3/17; [Set Skillvalue to 17% for Master Necromancy]
  *!FU(SetSecSkillPercent)&y10=3/y11=1/y12=1:P12/3/20; [Set Skillvalue to 20% for Grandmaster Necromancy]
*!en;

*!UN:C5127994/4/56;                     [Always set to skeletons before every fight]
*!HEy1:C0/0/?y21/?y32;                  [Check Heros army slot 1]
*!HEy1:C0/1/?y31/?y33;
*!HEy1:C0/2/?y41/?y34;
*!HEy1:C0/3/?y51/?y35;
*!HEy1:C0/4/?y61/?y36;
*!HEy1:C0/5/?y71/?y37;
*!HEy1:C0/6/?y81/?y38;

*!UN|y21=57/y31=57/y41=57/y51=57/y61=57/y71=57/y81=57:C5127994/4/57; [Set to Skeleton Warriors if Hero has them in the Army]
*!SN:W^Typhon_Third_Upgrade_Mod_Active^/?y99; [Check for Third Upgrade Mod]
*!if&y99=1;
  *!UN|y21=220/y31=220/y41=220/y51=220/y61=220/y71=220/y81=220:C5127994/4/220; [Set to Skeleton Knights if Hero has them in the Army]
*!en;
Till here Normal Necromancy
***************************
*!SN:W^Alternative_Necromancy_Mod^/?y90;[Check for Necromancy Option]
*!FU&y90=0:E;

*!UN:C5127994/4/56;                     [Always set to skeletons before every fight]
*!HEy1:C0/0/?y21/?y32;                  [Check Heros army slot 1]
*!HEy1:C0/1/?y31/?y33;
*!HEy1:C0/2/?y41/?y34;
*!HEy1:C0/3/?y51/?y35;
*!HEy1:C0/4/?y61/?y36;
*!HEy1:C0/5/?y71/?y37;
*!HEy1:C0/6/?y81/?y38;

*!SN:W^H3_Necromancy_Choice_%Y1^/?y50;
*!if&y50>=0/y50<221;
  *!UN&y10=3/y50=58:C5127994/4/58;      [Set to Walking Dead if Expert]
  *!UN&y10=3/y11=1/y50=60:C5127994/4/60;[Set to Wight if Master]
  *!UN&y10=3/y11=1/y12=1/y50=62:C5127994/4/62; [Set to Vampire if GrandMaster]
  *!UN&y10=3/y11=1/y12=1/y50=64:C5127994/4/64; [Set to Lich if GrandMaster]
  *!UN&y10=3/y11=1/y12=1/y50=66:C5127994/4/66; [Set to Black Knights if GrandMaster]

  *!FU(SetSecSkillPercent)&y10=3/y50=58:P12/3/20; [Set Skillvalue to 10% for Zombies]
  *!FU(SetSecSkillPercent)&y10=3/y11=1/y50=60:P12/3/14; [Set Skillvalue to 7% for Wights]
  *!FU(SetSecSkillPercent)&y10=3/y11=1/y12=1/y50=62:P12/3/4; [Set Skillvalue to 2% for Vampires]
  *!FU(SetSecSkillPercent)&y10=3/y11=1/y12=1/y50=64:P12/3/4; [Set Skillvalue to 2% for Liches]
  *!FU(SetSecSkillPercent)&y10=3/y11=1/y12=1/y50=66:P12/3/2; [Set Skillvalue to 1% for Black Knights]

  *!if&y99=1;                           [If TUM enabled] Test
    *!FU(SetSecSkillPercent)&y10=3/y50=58:P12/3/10; [Set Skillvalue to 10% for Zombies]
    *!FU(SetSecSkillPercent)&y10=3/y11=1/y50=60:P12/3/7; [Set Skillvalue to 7% for Wights]
    *!FU(SetSecSkillPercent)&y10=3/y11=1/y12=1/y50=62:P12/3/2; [Set Skillvalue to 2% for Vampires]
    *!FU(SetSecSkillPercent)&y10=3/y11=1/y12=1/y50=64:P12/3/2; [Set Skillvalue to 2% for Liches]
    *!FU(SetSecSkillPercent)&y10=3/y11=1/y12=1/y50=66:P12/3/1; [Set Skillvalue to 1% for Black Knights]
  *!en;  
*!en;

*!if|y50=56/y50=0;
  *!UN|y21=57/y31=57/y41=57/y51=57/y61=57/y71=57/y81=57:C5127994/4/57; [Set to Skeleton Warriors if Hero has them in the Army]

  *!SN:W^Typhon_Third_Upgrade_Mod_Active^/?y99; [Check for Third Upgrade Mod]
  *!if&y99=1;
    *!UN|y21=220/y31=220/y41=220/y51=220/y61=220/y71=220/y81=220:C5127994/4/220; [Set to Skeleton Knights if Hero has them in the Army]
  *!en;
*!en;

*!if&y10=3/y50=58;
  *!UN|y21=59/y31=59/y41=59/y51=59/y61=59/y71=59/y81=59:C5127994/4/59; [Set to Zombies if Hero has them in the Army]

  *!SN:W^Typhon_Third_Upgrade_Mod_Active^/?y99; [Check for Third Upgrade Mod]
  *!if&y99=1;
    *!UN|y21=329/y31=329/y41=329/y51=329/y61=329/y71=329/y81=329:C5127994/4/329; [Set to Ghoul if Hero has them in the Army]
  *!en;
*!en;

*!if&y10=3/y11=1/y50=60;
  *!UN|y21=61/y31=61/y41=61/y51=61/y61=61/y71=61/y81=61:C5127994/4/61; [Set to Wraith if Hero has them in the Army]

  *!SN:W^Typhon_Third_Upgrade_Mod_Active^/?y99; [Check for Third Upgrade Mod]
  *!if&y99=1;
    *!UN|y21=261/y31=261/y41=261/y51=261/y61=261/y71=261/y81=261:C5127994/4/261; [Set to Spectres if Hero has them in the Army]
  *!en;
*!en;

*!if&y10=3/y11=1/y12=1/y50=62;
  *!UN|y21=63/y31=63/y41=63/y51=63/y61=63/y71=63/y81=63:C5127994/4/63; [Set to Vampire Lords if Hero has them in the Army]

  *!SN:W^Typhon_Third_Upgrade_Mod_Active^/?y99; [Check for Third Upgrade Mod]
  *!if&y99=1;
    *!UN|y21=221/y31=221/y41=221/y51=221/y61=221/y71=221/y81=221:C5127994/4/221; [Set to Nepharatus if Hero has them in the Army]
  *!en;
*!en;

*!if&y10=3/y11=1/y12=1/y50=64;
  *!UN|y21=65/y31=65/y41=65/y51=65/y61=65/y71=65/y81=65:C5127994/4/65; [Set to Power Lich if Hero has them in the Army]

  *!SN:W^Typhon_Third_Upgrade_Mod_Active^/?y99; [Check for Third Upgrade Mod]
  *!if&y99=1;
    *!UN|y21=222/y31=222/y41=222/y51=222/y61=222/y71=222/y81=222:C5127994/4/222; [Set to Ancient Lich if Hero has them in the Army]
  *!en;
*!en;

*!if&y10=3/y11=1/y12=1/y50=66;
  *!UN|y21=67/y31=67/y41=67/y51=67/y61=67/y71=67/y81=67:C5127994/4/67; [Set to Dread Knight if Hero has them in the Army]

  *!SN:W^Typhon_Third_Upgrade_Mod_Active^/?y99; [Check for Third Upgrade Mod]
  *!if&y99=1;
    *!UN|y21=223/y31=223/y41=223/y51=223/y61=223/y71=223/y81=223:C5127994/4/223; [Set to Bad Ass Dread Knights if Hero has them in the Army]
  *!en;
*!en;

*!FU:E;
*!VRy20:S0R100;
*!UN&y1=68/y20<5:C5127994/4/67;         [For Tamika change to Dread Knights with 10% chance]
*!UN&y1=67/y20<5:C5127994/4/61;         [For Charna change to Wraith with 10% chance]
*!UN&y1=66/y20<5:C5127994/4/65;         [For Moandor change to Power Liches with 10% chance]
*!UN&y1=65/y20<5:C5127994/4/63;         [For Vokial change to Vampire Lords with 10% chance]
*!UN&y1=64/y20<5:C5127994/4/59;         [For Straker change to Zombies with 10% chance]
*!UN&y1=150/y20<10:C5127994/4/67;       [For Lord Haart change to Dread Knights with 33% chance]
*!UN&y1=78/y20<3:C5127994/4/154;        [For Vidomina change to ******** with 4% chance]


***************************Estates**********************************************
**Increases the Gold amount to plus 2000 at Grandmaster and increases the reward from resources piles
!?FU(OnGameEnter);
!!UN:C6547996/4/250;                    [Basic]
!!UN:C6548000/4/500;                    [Advanced]
!!UN:C6548004/4/750;                    [Expert]

!?FU(ACM_CreateERMHook);
!#VA(setHook:x);

!!SN:E(setHook)/1/5129755/(ACM_OnHeroGetGoldIncome); 4E461B

!?FU(ACM_UnsetERMHook);
!#VA(unsetHook:x);

!!SN:E(unsetHook)/1/5129755/(WOG_OnHeroGetGoldIncome); 4E461B

!?FU(ACM_OnHeroGetGoldIncome);
!#VA(hook:x);

!!UN:C(hook)/(STRUCT_HOOK_CONTEXT_EAX)/4/?(skillLvl:y);
!!FU&(skillLvl)<=(SKILL_NOT_LEARNED):E;

!!VR(offset:y):S(skillLvl) *(SIZEOF_INT);
!!UN:C6547992/(offset:y)/4/?(gold:y); 63EA18

!!UN:C(hook)/(STRUCT_HOOK_CONTEXT_ESI)/4/?(hero:y) C(hero)/26/4/?(heroId:y);

!!if&(skillLvl)>=(SKILL_EXPERT);
  !!if&i^H3_Estates_0_Hero%(heroId)^=1/i^H3_Estates_1_Hero%(heroId)^=0;
    !!VR(gold):+250;
  !!el&i^H3_Estates_0_Hero%(heroId)^=1/i^H3_Estates_1_Hero%(heroId)^=1;
    !!VR(gold):+1250;
  !!en;
!!en;

!!HE(heroId):X?(specType:y)/?(specSkill:y); better use this way so far as game uses __int64 (rax => eax+ [ebp-8])

!!if&(specType)=0/(specSkill)=(SKILL_ESTATES);
  !!HE(heroId):E?(exp:y)/?(level:y)/1;
  !!VR(specGold:y):S(gold) *(level) *5 :100;
  !!VR(gold):+(specGold);
!!en;

; Compatibility with WoG Scripts
; Here we copy the part from WoG Scripts, but it won't be executed twice as we jumped over later
!!if&i^wog_estates_ignore_native_calculation^=0; [Adds bonus from scripts]
  !!if&i^wog_203_enabled^;              [Estates I]
    !!FU(WOG_203_Hero_GetEstatesIBonus):P(heroId)/(skillLvl)/?(result:y); [if hero has estates, is in use and it's that hero's owner's turn, continue in function 7005 - if enabled]
    !!VR(gold):+(result);
  !!en;

  !!if&i^wog_191_enabled^;              [Estates II]
    !!FU(WOG_191_Hero_GetEstatesIIBonus):P(heroId)/(skillLvl)/?(result);
    !!VR(gold):+(result);
  !!en;
!!en;

!!UN:C(hook)/(STRUCT_HOOK_CONTEXT_EAX)/4/(gold:y);
!!SN:X?t/0;
!!UN:C(hook)/(STRUCT_HOOK_CONTEXT_RET)/4/5129831; // now return directly to the +350 gold 4E4667


!?FU(OnAfterBattleUniversal)&1000;

!!BA:H0/?y1;                            [Attacker]
!!HEy1:S13/?y11;                        [Check Estates]
!!if&y11>0;
!!HEy1:O?y3;                            [get owner of this hero]
!!HEy1:E?y6/?y7/1;                      [get level of this hero]

!!SN:W^H3_Estates_0_Hero%Y1^/?y12;      [Checke ob der Held Master Estates hat und Speichere in y11]
!!SN:W^H3_Estates_1_Hero%Y1^/?y13;      [Checke ob der Held Grandmaster Estates hat und Speichere in y12]

!!VRy7&y11=1::10;                       [Basic]
!!VRy7&y11=2::10;                       [Advanced]
!!VRy7&y11=3/y12=0/y13=0::10 +1;        [Expert]
!!VRy7&y11=3/y12=1/y13=0::10 +2;        [Master]
!!VRy7&y11=3/y12=1/y13=1::10 +3;        [Grandmaster]

!!VRy10:S0R8;
!!VRy10&y10=7:S6;                       [~11% Increased chance to get Gold after Combat   (22% in total)]
!!FU&y10=8:E;                           [Small chance to find nothing]

!!UN:P36/?v1;                           [Check if Mithril script is enabled: v1]
!!VRy30:S0R100;
!!VRy10&y30<4/v1=1:S7;                  [<4% chance to change to Mithril]
!!VRy11&y10=7/v1=1:S1;                  [Set to 1]

!!VRy11&y10<6/y11=1:S1 +y7;             [Basic]
!!VRy11&y10=6/y11=1:Sy7*250+R300;

!!VRy11&y10<6/y11=2:S1R1 +y7;           [Advanced]
!!VRy11&y10=6/y11=2:Sy7*250+R400;

!!VRy11&y10<6/y11=3:S0R2 +y7;           [Expert]
!!VRy11&y10=6/y11=3:Sy7*250+R250;

!!OW:Ry3/y10/dy11;                      [Add resources to player]
!!SN&y10=6:W^Total_Estate_Gold_%Y1^/dy11;[gained gold from Estate skill]

!!HEy1:B0/?z-10;                        [get hero name]
!!SN:T^AC_Misc.Estates Bonus^/?z-9;

!!OW&y3<>-1:Iy3/?y4 C?y20/?y21;         [get AI (1) or human (0) and active player and interacting player]
!!VRy5:S0;                              [assume AI]
!!VRy5&y3<>-1/y4=0:S1;                  [human if has owner and that owner is human]
!!if&y3=y20/y3=y21;
  !!IF&y5=1:Q2/y10/y11/1/z-9;           [If Bonus Show Picture]
  !!UN&y5=1:R2;
!!en;
!!en;


*********************Fire Air Water Earth Magic*********************************
!?MR1;                                  [*Magical Combat Improvements*]

!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>1:E;

!!BG:S?y2;
!!FU&y2<=9|y2>69:E;

!!BG:Q?y1;
!!BHy1:N?y99;                           [Current Hero Number]
!!FU&y99<0:E;

!!MR:F?y14;
!!FU&y14=0:E;
!!BG:S?y19;                             [y19 now contains spell number]

!!if&y1=999;                            [Test Disabled]
  !!FU(MSR_Determine_Spell_Type)&y19>=10/y19<=69:Py19/?y20/?y21/?y22; [y22 Returns the Magic School of the Spell that was Cast  1Air  2Earth  4Fire  8Water   15Magic Arrow; y20 holds spell level; y21 type]

  !!SN:W^H3_Fire Magic_0_Hero%Y99^/?y10;[Fire Magic Bonus handling]
  !!SN:W^H3_Fire Magic_1_Hero%Y99^/?y11;
  !!HEy99:S14/?y3;
  !!VRy14&y22=4/y3=3/y10=1/y11=0:*110:100; [+10% Damage]
  !!VRy14&y22=4/y3=3/y10=1/y11=1:*125:100; [+25% Damage]

  !!SN:W^H3_Air Magic_0_Hero%Y99^/?y10; [Air Magic Bonus handling]
  !!SN:W^H3_Air Magic_1_Hero%Y99^/?y11;
  !!HEy99:S15/?y3;
  !!VRy14&y22=1/y3=3/y10=1/y11=0:*110:100;[+10% Damage]
  !!VRy14&y22=1/y3=3/y10=1/y11=1:*125:100;[+25% Damage]

  !!SN:W^H3_Water Magic_0_Hero%Y99^/?y10; [Water Magic Bonus handling]
  !!SN:W^H3_Water Magic_1_Hero%Y99^/?y11;
  !!HEy99:S16/?y3;
  !!VRy14&y22=8/y3=3/y10=1/y11=0:*110:100;[+10% Damage]
  !!VRy14&y22=8/y3=3/y10=1/y11=1:*125:100;[+25% Damage]

  !!SN:W^H3_Earth Magic_0_Hero%Y99^/?y10; [Earth Magic Bonus handling]
  !!SN:W^H3_Earth Magic_1_Hero%Y99^/?y11;
  !!HEy99:S17/?y3;
  !!VRy14&y22=2/y3=3/y10=1/y11=0:*110:100;[+10% Damage]
  !!VRy14&y22=2/y3=3/y10=1/y11=1:*125:100;[+25% Damage]

  **Intelligence Spell Damage Section**                                           [Intelligence Bonus handling]
  !!HEy99:S24/?y3;
  !!if&y3=100;                           [Disabled for now]
  !!SN:W^H3_Intelligence_0_Hero%Y99^/?y10;
  !!SN:W^H3_Intelligence_1_Hero%Y99^/?y11;

  !!HEy99:I?y4/1;
  !!VRy4&y3=1::5;                         [Basic       Add 20% of SP]
  !!VRy4&y3=2::3;                         [Advanced    Add 33% of SP]
  !!VRy4&y3=3/y10=0/y11=0::2;             [Expert      Add 50% of SP]
  !!VRy4&y3=3/y10=1/y11=0::4*3;           [Master      Add 75% of SP]
  !!VRy4&y3=3/y10=1/y11=1:Sy4;            [Grandmaster Add 100% of SP]

  !!VRy14:Sy14 +y4;                       [Add Current Spell Points to Magic Damage]
  !!en;
!!en;
**Mysticism and Intelligence Specialists Section
!!SN:W^Specialists_SP_Damage_increase^/?y1; [Save Spell Number]
!!if&y1=1;
  !!SN:W^Specialists_SP_Damage_spell_bonus^/?y5;
  !!VRy14:*y5:100;                       [Add Specialist Spell Damage]
  *!SN:W^Specialists_SP_Damage_increase^/0;
  !!MR:Fy14;
!!en;

*************************Resistance*********************************************
!?MR1;                                  [*Magical Combat Improvements*]
*reduces spell and crit magic damage*

!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>1:E;

!!BG:S?y2;
!!FU&y2<=9|y2>69:E;

!!BG:Q?y1;
!!VRy1:-1 *-1;
!!BA:Hy1/?y99;
!!FU&y99<0:E;

!!HEy99:S26/?y3;
!!SN:W^H3_Resistance_0_Hero%Y99^/?y10;
!!SN:W^H3_Resistance_1_Hero%Y99^/?y11;

!!MR:F?y6 N?y60;                        [Get damage and creature number that took magic damage]
!!BMy60&y60>=0/y60<=41:T?y61;           [Get Creature type]
!!FU|y61=174/y61=175/y61=176/y61=177/y61=178/y61=179/y61=180/y61=181/y61=182:E; Exit for attacker commanders
!!FU|y61=183/y61=184/y61=185/y61=186/y61=187/y61=188/y61=189/y61=190/y61=191:E; Exit for defender commanders
*commanders Magic resistance golem type is handeled separatley (ACM_Calc_Commander_Magic_Resistance)

!!if&y3>0/y6>0;                         [Resistance bonus handling]
  !!VRy4:S1;
  !!VRy4&y3=1:*10 *y6 :100;             [10% Damage Red   at Basic]
  !!VRy4&y3=2:*15 *y6 :100;             [15% Damage Red   at Advanced]
  !!VRy4&y3=3/y10=0/y11=0:*20 *y6 :100; [20% Damage Red   at Expert]
  !!VRy4&y3=3/y10=1/y11=0:*25 *y6 :100; [25% Damage Red   at Master]
  !!VRy4&y3=3/y10=1/y11=1:*30 *y6 :100; [30% Damage Red   at Grandmaster]
  !!VRy6:Sy6 -y4;
  !!MR&y6>0:Fy6;                        [Apply reduced damage]  
!!en;


************************Warfare (Tactics)***************************************
*+1 Speed in first Battle Round at Expert +3Att/Def
*+2 Speed in Combat at Grandmaster +4Att/Def +1max dmg

; Disable Tactics button from hero screen by Archer30
!?FU(OnGameEnter)&i^Tactics_enabled^<>(TRUE);
!!UN:C5120034/1/235; 4E2022

; Compatibility with Secondary Skills Scrolling mod
; Because Perry didn't want to introduce additional erm script, we have to use SN:Q here :(
; This script must be executed earlier than Secondary Skills Scrolling mod (era - secondary skills scrolling.erm)
!?FU(sss_CheckIfTacticsDeploymentIsEnabled)&i^Tactics_enabled^<>(TRUE);
!#VA(result:x);

!!VR(result):S(FALSE);
!!SN:Q;

!?FU(OnAfterTacticsPhase); [Moved timing from OnCombatRound to OnAfterTacticsPhase to have correct move order in battle]
!!BH0:N?y1;                             [Attacker]
!!HEy1:S19/?y3;                         [Checke ob der Held Tactics hat und Speichere in y10]

!!SN:W^H3_Tactics_0_Hero%Y1^/?y11;      [Checke ob der Held Master Tactics hat und Speichere in y11]
!!SN:W^H3_Tactics_1_Hero%Y1^/?y12;      [Checke ob der Held Grandmaster Tactics hat und Speichere in y12]

!!VRy9&y3=1:S1;                         [y9 sets Attack and Defense]
!!VRy9&y3=2:S1;
!!VRy9&y3=3:S2;
!!VRy9&y3=3/y11=1/y12=0:S3;
!!VRy9&y3=3/y11=1/y12=1:S4;

!!VRy10&y3=1:S0;
!!VRy10&y3=2:S1;                        [y10 Sets Speed ]
!!VRy10&y3=3:S1;
!!VRy10&y3=3/y11=1/y12=0:S2;
!!VRy10&y3=3/y11=1/y12=1:S2;

!!VRy13&y3=3/y11=1/y12=1:S1;            [y13 sets damage +1 max Damage]

!!if&y3>0;

!!SN:W^Zulu_Mod_On^/?y79;               [Check for Zulu Mod Active]

!!if&y79=0;
!!if|y1=131/y1=118;
!!HEy1:E?y40/?y41/1;                    [If Hero Lacus/Gerwulf or Warfare Specialist]
!!VRy42:Sy41:7;                         [Every 7 hero Levels]
!!VRy9:+y42;
!!VRy13&y41>=10:+1;                     [+1 Damage at Level 10]
!!VRy10&y41>=20:+1;                     [+1 Speed at Level 20]
!!en;
!!en;

!!if&y79=1;
!!if|y1=131;
!!HEy1:E?y40/?y41/1;                    [If Hero Lacus/Gerwulf or Warfare Specialist]
!!VRy42:Sy41:7;                         [Every 7 hero Levels]
!!VRy9:+y42;
!!VRy13&y41>=10:+1;                     [+1 Damage at Level 10]
!!VRy10&y41>=20:+1;                     [+1 Speed at Level 20]
!!en;
!!en;

!!en;

!!DO(AC_Function_13)/0/20/1&y3>0:Py9/y10/y13;


!!BH1:N?y1;                             [Defender]
!!FU&y1<0:E;
!!HEy1:S19/?y3;                         [Checke ob der Held Tactics hat und Speichere in y10]
!!SN:W^H3_Tactics_0_Hero%Y1^/?y11;      [Checke ob der Held Master Tactics hat und Speichere in y11]
!!SN:W^H3_Tactics_1_Hero%Y1^/?y12;      [Checke ob der Held Grandmaster Tactics hat und Speichere in y12]

!!VRy9&y3=1:S1;                         [y9 Sets Speed y10 sets Attack and Defense]
!!VRy9&y3=2:S1;
!!VRy9&y3=3:S2;
!!VRy9&y3=3/y11=1/y12=0:S3;
!!VRy9&y3=3/y11=1/y12=1:S4;

!!VRy10&y3=1:S0;
!!VRy10&y3=2:S1;                        [y10 Sets Speed ]
!!VRy10&y3=3:S1;
!!VRy10&y3=3/y11=1/y12=0:S2;
!!VRy10&y3=3/y11=1/y12=1:S2;

!!VRy13&y3=3/y11=1/y12=1:S1;            [y13 sets damage +1 max Damage]

!!SN:W^Zulu_Mod_On^/?y79;               [Check for Zulu Mod Active]

!!if&y79=0;
!!if&y3>0;
!!if|y1=131/y1=118;
!!HEy1:E?y40/?y41/1;                    [If Hero Lacus/Gerwulf or Warfare Specialist]
!!VRy42:Sy41:7;                         [Every 7 hero Levels]
!!VRy9:+y42;
!!VRy13&y41>=10:+1;                     [+1 Damage at Level 10]
!!VRy10&y41>=20:+1;                     [+1 Speed at Level 20]
!!en;
!!en;
!!en;

!!if&y79=1;
!!if&y3>0;
!!if|y1=131;
!!HEy1:E?y40/?y41/1;                    [If Hero Lacus/Gerwulf or Warfare Specialist]
!!VRy42:Sy41:7;                         [Every 7 hero Levels]
!!VRy9:+y42;
!!VRy13&y41>=10:+1;                     [+1 Damage at Level 10]
!!VRy10&y41>=20:+1;                     [+1 Speed at Level 20]
!!en;
!!en;
!!en;

!!DO(AC_Function_13)/21/41/1&y3>0:Py9/y10/y13;

!?FU(AC_Function_13);
!!BMx16:T?y1 N?y2;
!!FU|y1=145/y1=146/y1=147/y1=148/y1=149/y2=0:E; [Execlude Warmachines and no stacks]
!!BMx16:Sdx2;                           [Speed]
!!BMx16:Adx1;                           [Attack]
!!BMx16:Ddx1;                           [Defense]
!!BMx16&x3=1:U2/d1;                     [Max Damage]


************************Artillery***********************************************
*Shoots enemy before combat and gives +50/100/150/250/500 HP to Ballista WM
*New script by Daemon because my old one was no longer working with Mixed Neutral :/

; Restore BM:B value before showing battle results
!?FU(OnSetupBattlefield);
!!FU(ACM_ResetArtilleryVariables):P;

!?FU(ACM_ResetArtilleryVariables);
!!re i/(BATTLE_LEFT)/(BATTLE_RIGHT);
  !!VRi^acm_artillery_Stack_%i^:S(NO_STACK);
  !!VRi^acm_artillery_Type_%i^:S(NO_MON);
  !!VRi^acm_artillery_Num_%i^:S0;
!!en;

!?FU(ACM_CreateERMHook);
!#VA(setHook:x);

!!SN:E(setHook)/1/4681149/(ACM_OnBeforeBattleResult);

!?FU(ACM_OnBeforeBattleResult);
!#VA(hook:x);

!!UN:C(hook)/(STRUCT_HOOK_CONTEXT_EBP)/4/?(ebp:y);
!!UN:C(ebp)/8/4/?(winnerSide:y);

!!if&i^acm_artillery_Stack_%(winnerSide)^>(NO_STACK);
  !!BMi^acm_artillery_Stack_%(winnerSide)^:T?(type:y);

  !!if&(type)=i^acm_artillery_Type_%(winnerSide)^;
    !!BMi^acm_artillery_Stack_%(winnerSide)^:B?(initNum:y);
    !!BMi^acm_artillery_Stack_%(winnerSide)^&(initNum)<i^acm_artillery_Num_%(winnerSide)^:Bi^acm_artillery_Num_%(winnerSide)^;
  !!en;

  !!FU(ACM_ResetArtilleryVariables):P;
!!en;

; Ballista shoots
; Archer30: FU(OnAfterTacticsPhase) triggers even without Tactics phase btw
!?FU(OnAfterTacticsPhase);
** artillery
!!BU:T?t;                               [Check if Tactics phase]
!!if&t;
  !!FU(ACM_KillWithArtillery):P;        [if tactiv phase run script]
*!el;  
  *!VRi^ACM_Artillery_Shoot^:S1;        [set flag to true]
!!en;

!?FU(OnCombatRound)&v997=0;
!!FU(ACM_KillWithArtillery):P;          [On the first visible combat round run script]
!!VRi^ACM_Artillery_Shoot^:S(FALSE);    [remove flag so it runs only once]

!?FU(OnStackToStackDamage)&i^ACM_Artillery_Damage^;
!!VRx4:Si^ACM_Artillery_Damage^;
!!VRi^ACM_Artillery_Damage^:S(FALSE);    [set flag to false after first damage was inflicted]

!?FU(ACM_KillWithArtillery);

!!re (side:y)/0/i^battle_hero_vs_hero^;  
  !!VR(oppSide:y):S1 -(side);
  !!VR(oppHero:y):Si^battle_hero_%(oppSide:y)^;
  !!if&(oppHero)<>(NO_HERO);
    !!HE(oppHero):A2/(ART_EMBLEM_OF_COGNIZANCE)/d/?(hasEmbleme:y);  
    !!co&(hasEmbleme);
  !!en;

  !!HEi^battle_hero_%(side:y)^:A2/(ART_BALLISTA)/?y99/?(ballistas:y) S(SKILL_ARTILLERY)/?(artilleryLvl:y) A2/142/d/?(goldenArrow:y);[get if hero has ballista in backpack]
  
  !!if&(ballistas:y)/(artilleryLvl:y)>(SKILL_NOT_LEARNED);                                                   [if ballista is present and hero has Artillery skill]

    !!VR(startInd:y):S(side) *(BATTLE_STACKS_PER_SIDE);
    !!VR(endInd:y):S(startInd) +20;
    *!co;
    !!re i/(startInd:y)/(endInd);
      !!BMi:N?n T?t;
      !!if&t=(MON_BALLISTA)/n>0;
        !!VR(shootNums:y):S1;
        !!VR(shootNums:y)&(goldenArrow:y):+1;

        !!FU(ACM_Generate_Random_Stack):P(side)/?(targetStackId:y);                                                        [return a random enemy stack to shoot]
        
        !!if&(targetStackId)<>(NO_STACK);
          ; Store the original stack info to be restored later before battle result screen
          !!VRi^acm_artillery_Stack_%(side)^:S(targetStackId);
          !!BM(targetStackId):T?i^acm_artillery_Type_%(side)^;
          !!BM(targetStackId):N?i^acm_artillery_Num_%(side)^;

          !!UN:C(COMBAT_MANAGER)/4/?(cmbMgr:y);

          !#VA(patch[5]:y);
          !!re j/0/4;                                                                                                      [ skip double damage bonus message]
            !!UN:C4470304/j/1/?(patch[j]) C4470304/j/1/(OPCODE_NOP_1); 
          !!en;

          !!BMi:Z?(ballistaStack:y);
          !!BM(targetStackId):Z?(targetStack:y) N?n P?p;    
        
          !!UN:C(ballistaStack)/248/4/?(ballistaSideIndex:y);
          !!UN:C(targetStack)/248/4/?(targetStackSideIndex:y);
          !#VA(stored[5]:y);
          !!UN:C(cmbMgr)/68/4/?(stored[0]) C(cmbMgr)/78520/4/?(stored[1]) C(cmbMgr)/78524/4/?(stored[2]) C(cmbMgr)/78528/4/?(stored[3]) C(cmbMgr)/78536/4/?(stored[4]);                                                           [set combat target pos]
          !!UN:C(cmbMgr)/68/4/p C(cmbMgr)/78520/4/(side) C(cmbMgr)/78524/4/(side) C(cmbMgr)/78528/4/(side) C(cmbMgr)/78536/4/(ballistaStack); 

          !!UN:C(ballistaStack:y)/16/4/(oppSide) C(ballistaStack:y)/20/4/(targetStackSideIndex) C(ballistaStack:y)/28/4/p; [set stack target]
          !!BMi:U3/?(storedShots:y) U3/1 G(BMG_FIELD_MORALE)/?(storedMorale:y)/d G(BMG_FIELD_MORALE)/0/d G(BMG_FIELD_LUCK)/?(storedLuck:y)/d G(BMG_FIELD_LUCK)/0/d;                [get morale shots and luck]
          !!VR(newNum:y):Sn;
          !!re k/1/(shootNums);

            !!FU(acm_Hero_GetArtilleryMinMaxDamage):Pi^battle_hero_%(side:y)^/?(minDamage:y)/?(maxDamage:y);               [get back damage from ACM script]
            !!VR(damage:y):R0/(minDamage)/(maxDamage);
            !!VRi^ACM_Artillery_Damage^:S(damage:y);

            !!SN:E4453920/2/(ballistaStack:y)/(targetStack:y);                                                             [shoot stack to stack]
            !!BM(targetStackId):N?(newNum:y);
            !!br&(newNum)<1;
          !!en;
          !!BM(targetStackId):N?(newNum:y);                                                                                [get number of stack that was target]
          !!VR(lost:y):Sn -(newNum:y);                                                                                     [reduce number and set new number at battle start]
          !!BM(targetStackId):Bd-(lost:y);

          !!BMi:U3/(storedShots) G(BMG_FIELD_MORALE)/(storedMorale:y)/d G(BMG_FIELD_LUCK)/(storedLuck:y)/d;                                            [set back luck/morale]
          !!re j/0/4;
            !!UN:C4470304/j/1/(patch[j]);                                                                              [ restore double damage bonus message]
          !!en;
          !!VRi^ACM_Artillery_Shoot^:S0;                                                                                   [set flag to zero]
          restore combatManager data
          !!UN:C(cmbMgr)/68/4/(stored[0]) C(cmbMgr)/78520/4/(stored[1]) C(cmbMgr)/78524/4/(stored[2]) C(cmbMgr)/78528/4/(stored[3]) C(cmbMgr)/78536/4/(stored[4]);                                                           [set combat target pos]

          !!SN:E4607072/2/(cmbMgr:y)/0;                                                                                    [find next stack to act start battle]

          !!br;                                                                                                            [break finding ballista loop]
        !!en;

      !!en;

    !!en;
  !!en;
!!en;


*selects target to be shot with Artillery
!?FU(ACM_SelectBestTarget);

!!VRy1:Sx1 *21;
!!VRy2:Sy1 +20;
!!VRx3:S-1;
!!VRy3:S0;
!!VRy4:S0;

!!re i/y1/y2;  
  !!BMi:N?y5 H?y6 T?y7;
  !!FU|y7=145/y7=146/y7=147/y7=148/y7=149:E; [Exit for Warmachines]
  !!if&y7>-1/y5>1/y6>0;
    !!MA:Fy7/?y8;
    !!VRy9:Sy5 -1;
    !!VRy10:Sx2 :y6 F0/y9;
    !!VRy11:Sy10 *y8;

    ; Store the values if killing at least one
    !!if&y10>0/y11>y3;
      !!VRx3:Si;
      !!VRy3:Sy11;
      !!VRy4:Sy10;
    !!en;
  !!en;
!!en;


************************Artillery***********************************************
** function to handle artillery, hero v7020, skill level y1
!?FU(acm_Hero_GetArtilleryMinMaxDamage);
!#VA(heroId:x) (minDamage:x) (maxDamage:x);
!#VA(arts[4]:y);
!!VR(arts[0]):C(ART_AMMO_CART)/(ART_SPECULUM)/(ART_SPYGLASS)/(ART_GOLD_TOWER_ARROW);
!!HE(heroId:x):E?y99/?l/1 S(SKILL_ARTILLERY)/?(skillLvl:y) F?(heroAtk:y)/?y99/?y99/?y99 X?(specType:y)/?(specSubtype:y); [ get hero's level, artillery level, Attack from Hero]

!!VR(multiplier:y):S1 +(skillLvl:y);    [artillery bonus]

!!VR(multiplier:y)&i^H3_Artillery_0_Hero%(heroId)^=1:+1; [Master bonus]
!!VR(multiplier:y)&i^H3_Artillery_1_Hero%(heroId)^=1:+1; [Grandmaster bonus]
!!re i/0/(arts[SIZE])/1/-1;
  !!HE(heroId):A2/(arts[i])/?y99/?(equipped:y); [check for Ammo Cart, Speculum, Spyglass, Ballista Arrow bonus]
  !!VR(multiplier)&(equipped):+1;
!!en;

!!VR(heroAtk:y):*3;                     [attack bonus]
!!VRl:*2;                               [Hero Level times 2]
!!VR(multiplier:y)|(specType)=1/(specSubtype)=(MON_BALLISTA):+1; [if Artillery Specialist Hero]

;[Artillery damage: (1-50 + hero level*2+ hero attack*3) x bonus multiplier]
!!VR(minDamage):S1 +l +(heroAtk:y) *(multiplier:y); [Min Damage]
!!VR(maxDamage):S50 +l +(heroAtk:y) *(multiplier:y); [Max Damage]
** end of function


** function to check one stack for monsters to shoot.
Replaced by Daemons code
!?FU(AC_Function_14);                   [x1=slot#   x2=slot    x3=damage]

!!VRy40:Sx3;                            [Set damage to y40 to later print the number in the text]
!!HEv7020:B0/?z1;                       [get hero's name]
!!VRy4:Sx2 %7;                          [get an actual slot number]
!!BA&x1=1:M1/y4/?y5/?y6;                [get y5 type and y6 qty in slot of defender]
!!BA&x1=2:M0/y4/?y5/?y6;                [get y5 type and y6 qty in slot of attacker]
!!IF:V2/0;                              [assume not shooting this stack]
!!SN:W^First_Aid_Heal_Slot^/?y50;       [7 = slot not found]
!!IF&y50=7/y6>1:V2/1;                   [shoot if haven't yet and more than 1 monster]
!!VRy50&2:Sy4;                          [note we found a slot]
!!MA&y5>-1:Py5/?y7;                     [get hit points of monster type y5]
!!VRx3&2/y7>0::y7;                      [divide damage by hit points per monster to get monsters killed]
!!VRx3&2/x3>y6:Sy6;                     [never kill entire stack]
!!VRx3&2/x3=y6:-1;                      [broken into two lines since it didn't work as one]
!!VRy6&2/x3>0:-x3;                      [kill some monsters]
!!BA&2/x1=1/x3>0:M1/y4/?y5/y6;          [store the new monster qty for defender]
!!BA&2/x1=2/x3>0:M0/y4/?y5/y6;          [store the new monster qty for attacker]
!!VRy1&2/x3>0:Sx3 *y7;                  [monsters x hit points]

!!SN&1000/2/x3>1:T^AC_Misc.Artillery 2^/?z4 Iz4/?z4;
!!IF&1000/999/2/x3>1:Q2/21/y5/1/z4;

!!SN&1000/2/x3=1:T^AC_Misc.Artillery 1^/?z4 Iz4/?z4;
!!IF&1000/999/2/x3=1:Q2/21/y5/1/z4;
!!HEv7020&2/x3>0:Edx3;                  [give experience]
!!VRx16&2/x3>0:S6;                      [Exit if killed]
!!VRx2:+1;                              [next slot]
** end of function

!?FU(OnCombatRound)&v997=0;
gives +50/100/150/250/500 HP to Ballista WM
!!BA:H0/?y2;                            [Attacker]
!!HEy2:S20/?y3;                         [Artillery]
!!SN:W^H3_Artillery_0_Hero%Y2^/?y11;    [Checke ob der Held Master Artillery hat und Speichere in y11]
!!SN:W^H3_Artillery_1_Hero%Y2^/?y12;    [Checke ob der Held Grandmaster Artillery hat und Speichere in y12]
!!VRy10&y3=1:S50; !!VRy10&y3=2:S100; !!VRy10&y3=3/y11=0/y12=0:S150; !!VRy10&y3=3/y11=1/y12=0:S250; !!VRy10&y3=3/y11=1/y12=1:S500;
!!DO(AC_Function_29)/0/20/1&y3>0:Py10;

!!BA:H1/?y4;                            [Defender]
!!FU&y4<0:E;
!!HEy4:S20/?y3;                         [Artillery]
!!SN:W^H3_Artillery_0_Hero%Y4^/?y11;    [Checke ob der Held Master Artillery hat und Speichere in y11]
!!SN:W^H3_Artillery_1_Hero%Y4^/?y12;    [Checke ob der Held Grandmaster Artillery hat und Speichere in y12]
!!VRy10&y3=1:S50; !!VRy10&y3=2:S100; !!VRy10&y3=3/y11=0/y12=0:S150; !!VRy10&y3=3/y11=1/y12=0:S250; !!VRy10&y3=3/y11=1/y12=1:S500;
!!DO(AC_Function_29)/21/41/1&y3>0:Py10;

!?FU(AC_Function_29);                   [increase Units Stats]
!!BMx16:T?y1;
!!if&y1=146;
  !!BMx16:N?y20;                        [Creature Number y20]
  !!FU&y20=0:E;                         [Exit if zero]
  !!BMx16:Hdx1;                         [Add fix HP to Ballista]
!!en;


******************Artillery gets additional shots in combat*******************************
*function to give extra attacks/shots to creatures from different sources
!?BG0;                                  [Trigger to handle extra shoots and additional strikes]

!!SN:W^007.AttackA.Times^/0;            [reset flag](or reset it at BG1]
!!SN:W^007.ShootA.Times^/0;             [reset flag](or reset it at BG1]

!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]

!!BG:A?y1 N?y2 E?y3;
!!BMy2:T?y4;

* Master and Grandmaster Artillery
!!if&y4=146/y1=7;                       [If Ballista and a Ranged Attack]
  !!BMy2:I?y5;                          [get stack side]
  !!BA:Hy5/?y6;                         [Current Hero]
  !!FU&y6<0:E;                          [Exit if none]
  !!HEy6:S20/?y10;                      [Check for Artillery]
  !!SN:W^H3_Artillery_0_Hero%Y6^/?y71;  [Checke ob der Held Master Artillery hat und Speichere in y71]
  !!SN:W^H3_Artillery_1_Hero%Y6^/?y72;  [Checke ob der Held Grandmaster Artillery hat und Speichere in y72]
  !!HEy6:X?y81/?y82/?y83/?y84/?y85/?y86/?y87 A2/142/d/?y8; [Check Hero Speciality and hero has a 142 Gold Tower Arrow]
  !!SN&y10=3/y71=1:W^007.ShootA.Times^/d1; [Add 1 shot for Master]
  !!SN&y10=3/y72=1:W^007.ShootA.Times^/d1; [Add 1 shot for Grandmaster]
  !!SN&y8=1:W^007.ShootA.Times^/d1;     [Add 1 shot for Gold Tower Arrow]

  * Artillery Specialists
  6 Christian 54 Pyre 81 Arlach 97 Gurnisson
  !!if|y6=6/y6=97/y6=54/y6=81;
    !!HEy6:E?y86/?y87/1;
    !!SN:W^007.ShootA.Times^/d1;        [Add 1 Artillery Specialist]
    !!SN&y87>=20:W^007.ShootA.Times^/d1;[Add 1 Artillery Specialist above level 20]
    !!SN&y87>=40:W^007.ShootA.Times^/d1;[Add 1 Artillery Specialist above level 40]
    !!SN&y87>=60:W^007.ShootA.Times^/d1;[Add 1 Artillery Specialist above level 60]
    !!SN&y87>=80:W^007.ShootA.Times^/d1;[Add 1 Artillery Specialist above level 80]
    !!SN&y87>=100:W^007.ShootA.Times^/d1;[Add 1 Artillery Specialist above level 100]
  !!en;

  *Ballista Upgrade at Blacksmith can give +1 Shot
  !!SN:W^Ballista_Add_Shots_%Y6^/?y11;
  !!SN&y11=1:W^007.ShootA.Times^/d1;    [Add 1 Artillery Shot for Upgrade]

  !!SN:W^007.ShootA.Times^/?y50;        [get number of shots]
  !!VRy50:+1;
  !!VRy50&y10=3:+1;
  !!SN:W^Total_Ballista_Shots^/y50;     [save number of total shots to display on right click]
!!en;



* Commander Specialists can get chance for extra Strike or due to Commander Masteries
!!if&y4>=174/y4<=191;                   [If Commander and A melee Attack]
  !!if|y1=6/y1=7;                       [If melee or Shoot]
    !!BMy2:I?y5;
    !!BA:Hy5/?y6;                       [Current Hero]
    !!FU&y6<0:E;                        [Exit if none]

    !!if|y6=36/y6=105/y6=128;           [Pasis, Vey, Torosar]
      !!VRy50:S0R3;
      *!SN:W^com_extra_strike_chance_%Y6^/?y51; [Get chance for extra strike]
      *!SN&y50=3/y1=6:W^007.AttackA.Times^/d1; [add one strike if success] Disabled because of new mastery
      *!SN&y50=3/y1=7:W^007.ShootA.Times^/d1; [add one strike if success]
    !!en;

    !!FU(Check_Com_Masteries):Py6/?y40/0/0/?y21; [Pass Hero Number and return if Commander Mastery is enabled and return current commander class]

    *Commander Fighter Mage Class
    !!SN&y5=0:W^Att_Com_Fighter_Mage_Cast^/?y20; [check how many times the commander has cast this fight]
    !!SN&y5=1:W^Def_Com_Fighter_Mage_Cast^/?y20;
    !!if&y21=2/y20>0;                   [If Fighter Mage class and has a cast counter]
      !!VRy22:S0;
      !!VRy22&y20=1:S1; !!VRy22&y20=2:S3; !!VRy22&y20=3:S6; !!VRy22&y20=4:S10; !!VRy22&y20=5:S15; !!VRy22&y20=6:S19; !!VRy22&y20>=7:S24; [determine number of extra strikes]

      !!re i/1/y22;                     [loop sets number of extra strikes]
        !!SN&y1=6:W^007.AttackA.Times^/d1; [add one strike if success]
        !!SN&y1=7:W^007.ShootA.Times^/d1;[add one strike if success]
      !!en;
    !!en;

    *Fighter, Ranger and Scout
    !!VRy50:S0R2;                       [Coin Flip 33% chance]    
    !!SN:W^Commander_Fighter_%Y6^/?y41; [Check Commander Class]
    !!SN:W^Commander_Ranger_%Y6^/?y42;  [Check Commander Class]
    !!SN&y50=1/y1=6/y41=1/y40=1:W^007.AttackA.Times^/d1; [add one strike if success]
    !!SN&y50=1/y1=7/y42=1/y40=1:W^007.ShootA.Times^/d1; [add one strike if success]
    !!SN:W^Commander_%Y6_Ancient_Fighter^/?y41; [Check for Ancient commander Fighter passive]
    !!SN:W^Commander_%Y6_Ancient_Ranger^/?y42; [Check for Ancient commander Ranger passive]
    !!SN:W^Commander_%Y6_Ancient_Scout^/?y43; [Check for Ancient commander Scout passive]    
    !!SN&y50=1/y1=6/y41=1:W^007.AttackA.Times^/d1; [add one strike if success]
    !!SN&y50=1/y1=7/y42=1:W^007.ShootA.Times^/d1; [add one strike if success]
    !!SN&y50=1/y1=6/y43=1:W^007.AttackA.Times^/d1; [add one strike if success]
    !!SN&y50=1/y1=7/y43=1:W^007.ShootA.Times^/d1; [add one strike if success]

    !!VRy50:S0R3;                       [Coin Flip 25% chance]
    !!SN:W^Commander_Dragonslayer_%Y6^/?y44; [Check Commander Class]
    !!SN:W^Commander_Paladin_%Y6^/?y45;[Check Commander Class]
    !!SN&y50=1/y1=6/y44=1:W^007.AttackA.Times^/d1; [add one strike if success]
    !!SN&y50=1/y1=6/y45=1:W^007.AttackA.Times^/d1; [add one strike if success]
    !!SN&y50=1/y1=7/y44=1:W^007.ShootA.Times^/d1; [add one strike if success]
    !!SN&y50=1/y1=7/y45=1:W^007.ShootA.Times^/d1; [add one strike if success]

    !!SN:W^Commander_Scout_%Y6^/?y43;   [Check Commander Class]
    !!SN&y43=1/y1=6/y40=1:W^007.AttackA.Times^/d1; [add one attack for Scout and Mastery enabled]
    !!SN&y43=1/y1=7/y40=1:W^007.ShootA.Times^/d1; [add one attack for Scout and Mastery enabled]

    !!SN:W^Commander_Prospector_%Y6^/?y43;   [Check Commander Class]
    !!SN&y43=1/y1=6:W^007.AttackA.Times^/d1; [add one attack for Prospector]
    !!SN&y43=1/y1=7:W^007.ShootA.Times^/d1; [add one attack for Prospector]
    !!SN&y43=1/y1=6/y40=1:W^007.AttackA.Times^/d1; [add one attack for Prospector and Mastery enabled]
    !!SN&y43=1/y1=7/y40=1:W^007.ShootA.Times^/d1; [add one attack for Prospector and Mastery enabled]

    !!SN:W^Commander_Lancer_%Y6^/?y43;   [Check Commander Class]
    !!SN&y43=1/y1=6/y40=1:W^007.AttackA.Times^/d1; [add one attack for Lancer and Mastery enabled]
    !!SN&y43=1/y1=7/y40=1:W^007.ShootA.Times^/d1; [add one attack for Lancer and Mastery enabled]
  !!en;
!!en;

*Archdevil Set Suite
!!BMy2:I?y5;                            [Get Side and Type]
!!BA:Hy5/?y6;                           [Current Hero]
!!if&y6>=0/y6<=155;                     [if valid hero]
  !!FU|y6<0/y4=147/y4=148/y4=149/y4=145:E; [Exit if no Hero or Warmachine]
  !!FU(Count_Set_Pieces):Py6/0/0/0/0/0/0/0/0/0/0/0/?y94; [Count Set Pieces Archdevil Set Suite]
  !!if&y94=5;
    !!VRy50:S0R3;                       [25% chance for extra Strike]
    !!SN&y50=3/y1=6:W^007.AttackA.Times^/d1; [add one strike if success]
    !!SN&y50=3/y1=7:W^007.ShootA.Times^/d1; [add one strike if success]
  !!en;
!!en;


********************HOOK_CODE******************************
!?FU(OnStartOrLoad);

!!SN:L^EraPlugins\erm_hooker.era^/?y1;
!!FU&y1=0:E;

!!SN:Ay1/^SetHook^/?y2;
!!SN:Ey2/1/7381311/(AC_Function_130);   [hook at <after metee_attack>]
!!SN:Ey2/1/4456346/(AC_Function_131);   [hook at <after shoot>]
!!SN:Ey2/1/4718431/(ACM_OnHeroMove);

!?FU(ACM_OnHeroMove);
!!UN:Cx1/(STRUCT_HOOK_CONTEXT_ESI)/4/?(activeHeroPtr:y);
!!if&(activeHeroPtr)=0;
  !!SN:X?y99/0;
  !!UN:Cx1/(STRUCT_HOOK_CONTEXT_RET)/4/4721255;
!!en;

!?FU(AC_Function_131);                  [extra_shoot]
!!SN:X?y1/1;                            [edi]
!!SN:W^007.ShootA.Times^/?y30;
!!SN:W^007.ShootA.Times^/0;
!!FU&y30<1:E;
!!VRy2:Sy1+4;                           [esi]
!!UN:Cy2/4/?y10;                        [A_STACK]
!!VRy3:Sy1+16;                          [ebx]
!!UN:Cy3/4/?y20;                        [D_STACK]
!!VRy11:Sy10+52;                        [8#]
!!VRy12:Sy10+76;
!!VRy13:Sy10+656;
!!VRy14:Sy10+688;
!!VRy15:Sy10+704;
!!VRy16:Sy10+216;
!!VRy21:Sy20+52;
!!VRy22:Sy20+76;
!!UN:Cy11/4/?y31;                       [BM:T]16#]
!!UN:Cy12/4/?y32;                       [BM:N]
!!UN:Cy13/4/?y33;                       [BM:G62]
!!UN:Cy14/4/?y34;                       [BM:G70]
!!UN:Cy15/4/?y35;                       [BM:G74]
!!UN:Cy16/4/?y36;                       [BM:U3]
!!UN:Cy21/4/?y41;                       [BM:T]
!!UN:Cy22/4/?y42;                       [BM:N]
!!FU|y31<0/y32<1/y41<0/y42<1/y33>0/y34>0/y35>0/y36<1:E;
!!SN:E4453920/2/y10/y20;
!!VRy30:-1;
!!SN&y30>0:G16;


!?FU(AC_Function_130);                  [extra_metee_attack]
!!SN:X?y1/1;                            [edi]
!!SN:W^007.AttackA.Times^/?y30;
!!SN:W^007.AttackA.Times^/0;
!!FU&y30<1:E;
!!UN:Cy1/4/?y10;                        [y10=A_STACK]
!!VRy2:Sy1+8;
!!UN:Cy2/4/?y3;                         [y3=ebp]
!!VRy4:Sy3+8;                           [ebp+8]
!!UN:Cy4/4/?y5;                         [y5=[ebp+08]
!!VRy6:Sy1+4;
!!UN:Cy6/4/?y20;                        [y20=D_STACK]10#]
!!VRy11:Sy10+52;                        [11#]
!!VRy12:Sy10+76;
!!VRy13:Sy10+656;
!!VRy14:Sy10+688;
!!VRy15:Sy10+704;
!!VRy21:Sy20+52;
!!VRy22:Sy20+76;
!!UN:Cy11/4/?y31;                       [18#]
!!UN:Cy12/4/?y32;
!!UN:Cy13/4/?y33;
!!UN:Cy14/4/?y34;
!!UN:Cy15/4/?y35;
!!UN:Cy21/4/?y41;
!!UN:Cy22/4/?y42;
!!FU|y31<0/y32<1/y41<0/y42<1/y33>0/y34>0/y35>0:E;
!!SN:E4461360/2/y10/y20/y5;
!!VRy30:-1;
!!SN&y30>0:G18;



************************Learning************************************************
** Primary Skill Bonus at level Up  100% Success At Grandmaster Level +100% XP Gain

!?HL-1;                                 [Level up trigger for learning]
!!FU:E;                                 [Replaced by new mechanic see code below]

!!HE-1:N?y1;
!!HEy1:S21/?y3;                         [get Learning level]
!!FU&y3<0:E;

!!SN:W^H3_Learning_0_Hero%Y1^/?y11;     [Checke ob der Held Master Learning hat und Speichere in y11]
!!SN:W^H3_Learning_1_Hero%Y1^/?y12;     [Checke ob der Held Grandmaster Learning hat und Speichere in y12]

!!VRy2&y3=0:S0;
!!VRy2&y3=1:S25;                        [convert bonus to percentage - 20, 35, 50]
!!VRy2&y3=2:S30;
!!VRy2&y3=3:S35;
!!VRy2&y3=3/y11=1/y12=0:S40;
!!VRy2&y3=3/y11=1/y12=1:S50;

!!VRy3:S0R100;                          [roll percentile dice...]
!!FU(AC_Function_24)&y1>=0/y1<=155/y3<y2:Py1/0; [handle learning bonus]

**Second Chance for Learning Specialists
!!VRy3:S0R250;                          [roll percentile dice...]
!!HEy1:X?y23/?y24/?y25/?y26/?y27/?y28/?y29; [Check Hero Speciality]
!!FU(AC_Function_24)&y1>=0/y1<=155/y3<y2/y23=0/y24=21:Py1/1; [handle learning bonus for Learning Specialists]
** End of level up trigger for learning

!?FU(AC_Function_24);                   [Function to give learning bonus to hero -1]
!!HEx1:S21/?y40;                        [get Learning level]
!!FU&y40=0:E;

!!if&y40>0;
  !!VRy1:S0R3;                            [random primary skill]
  !!VRy2:S31 +y1;                         [picture of skill]
  !!HEx1&y1=0:Fd1/d/d/d;                  [give appropriate bonus]
  !!HEx1&y1=1:Fd/d1/d/d;
  !!HEx1&y1=2:Fd/d/d1/d;
  !!HEx1&y1=3:Fd/d/d/d1;
  !!HEx1:B0/?z-10;                        [get hero name]

  !!SN&x2=0:T^AC_Misc.Learning 1^/?z-9;
  !!SN&x2=1:T^AC_Misc.Learning 2^/?z-9;

  !!HEx1:O?y3;                            [get owner of this hero]
  !!OW&y3<>-1:Iy3/?y4;                    [get AI (1) or human (0)]
  !!VRy5:S(FALSE);                        [assume AI]
  !!VRy5&y3<>-1/y4=0:S(TRUE);             [human if has owner and that owner is human]

  !!IF&y5/(ERM_FLAG_IS_HUMAN)/i^acm_isGameStarted^:Q2/y2/1/1/z-9; [Message Works only after game start]
!!en;


***Learning Taken from Algors Archievement mod******************
!?OB51;  !!FU(AC_Function_133):P3;      [51  Mercenary Camp]
!?OB23;  !!FU(AC_Function_133):P1;      [23  Marletto Tower]
!?OB61;  !!FU(AC_Function_133):P4;      [61 Star Axis]
!?OB32;  !!FU(AC_Function_133):P2;      [32 Garden of Revelation]
!?OB47;  !!FU(AC_Function_133):P8;      [47 School of Magic]
!?OB107; !!FU(AC_Function_133):P9;      [107  School of War]
!?OB4;   !!FU(AC_Function_133):P7;      [4  Arena]
!?OB41;  !!FU(AC_Function_133):P6;      [41 Library of Enlightenment]


!?FU(AC_Function_133);
!!HE-1:Vx1/?y1; !!SN:W^AC_Learning_Var^/y1; [save objects of this type visited by the hero]

!$OB51;  !!FU(AC_Function_132):P3;
!$OB23;  !!FU(AC_Function_132):P1;
!$OB61;  !!FU(AC_Function_132):P4;
!$OB32;  !!FU(AC_Function_132):P2;
!$OB47;  !!FU(AC_Function_132):P8;
!$OB107; !!FU(AC_Function_132):P9;
!$OB4;   !!FU(AC_Function_132):P7;
!$OB41;  !!FU(AC_Function_132):P6;


!?FU(AC_Function_132);

!!HE-1:Vx1/?y1; !!SN:W^AC_Learning_Var^/?y2; [getting objects of this type visited by the hero]
!!FU&y1=y2:E;                           [Exit if not the same]
!!HE-1:N?y77 B0/?z1 O?y4; !!FU&y4<0:E;  [Exit if no owner]
!!OW:C?y4 Iy4/?y5;                      [get if AI or Human]

!!HEy77:S21/?y3;                        [21  Learning]
!!FU&y3=0:E;
!!SN:W^H3_Learning_0_Hero%Y77^/?y11;    [Checke ob der Held Master Learning hat und Speichere in y11]
!!SN:W^H3_Learning_1_Hero%Y77^/?y12;    [Checke ob der Held Grandmaster Learning hat und Speichere in y12]

!!VRy2&y3=0:S0;
!!VRy2&y3=1:S25;                        [convert bonus to percentage - 20, 35, 50]
!!VRy2&y3=2:S28;
!!VRy2&y3=3:S33;
!!VRy2&y3=3/y11=1/y12=0:S35;
!!VRy2&y3=3/y11=1/y12=1:S40;

!!VRy1:S0R100;                          [calc chance]
!!HEy77:X?y23/?y24/?y25/?y26/?y27/?y28/?y29; [Check Hero Speciality]
!!VRy2&y23=0/y24=21:+15;                [+15% increased chance for learning specialist]

!!if&y1<y2;
  !!VRy1:S31 R3;
  !!VRy1|x1=1:S32; !!VRy1|x1=2:S34; !!VRy1|x1=3:S31; !!VRy1|x1=4:S33; !!VRy1|x1=7/x1=9:S31R1; !!VRy1|x1=8:S33R1;
  !!HEy77&y1=31:Fd1/d/d/d;
  !!HEy77&y1=32:Fd/d1/d/d;
  !!HEy77&y1=33:Fd/d/d1/d;
  !!HEy77&y1=34:Fd/d/d/d1;
    !!if&y5=0;
      !!SN:T^AC_Misc.Learning 3^/?z2/^HeroName^/z1;
      !!IF&1000/999:Q1/y1/1/1/2;
    !!en;
!!en;


**Set Learning Level for Master and Grandmaster
!?HM-1;                                 [Trigger for Hero Movement]
!!HE-1:N?y1;
!!HEy1:S21/?y10;                        [get Learning level]
!!FU&y10<3:E;

!!SN:W^H3_Learning_0_Hero%Y1^/?y11;     [Checke ob der Held Master Learning hat und Speichere in y11]
!!SN:W^H3_Learning_1_Hero%Y1^/?y12;     [Checke ob der Held Grandmaster Learning hat und Speichere in y12]
!!FU(SetSecSkillPercent)&y10=3/y11=0/y12=0:P21/3/40; [Set Skillvalue to 40% for Expert Learning]
!!FU(SetSecSkillPercent)&y10=3/y11=1/y12=0:P21/3/60; [Set Skillvalue to 60% for Master Learning]
!!FU(SetSecSkillPercent)&y10=3/y11=1/y12=1:P21/3/75; [Set Skillvalue to 75% for Grandmaster Learning]


************************First Aid **********************************************
*Heal after Combat and +HP of Creatures*

!?FU(OnBeforeBattleUniversal)&1000;     [Continue trigger if any skills are enabled]

** first aid
!!VRv7040:C0/0/0/0/0/0/0;               [no creatures to resurrect after battle attacker]
!!VRv7047:C0/0/0/0/0/0/0;               [no creatures to resurrect after battle defender]
!!BA:M0/0/?y1/?v7040;                   [save qty in each of attacking hero's slots for after battle]
!!BA:M0/1/?y2/?v7041;                   [to determine qty lost for first aid skill]
!!BA:M0/2/?y3/?v7042;
!!BA:M0/3/?y4/?v7043;
!!BA:M0/4/?y5/?v7044;
!!BA:M0/5/?y6/?v7045;
!!BA:M0/6/?y7/?v7046;
!!BA:M1/0/?y8/?v7047;                   [save qty in each of defending hero's slots for after battle]
!!BA:M1/1/?y9/?v7048;                   [to determine qty lost for first aid skill]
!!BA:M1/2/?y10/?v7049;
!!BA:M1/3/?y11/?v7050;
!!BA:M1/4/?y12/?v7051;
!!BA:M1/5/?y13/?v7052;
!!BA:M1/6/?y14/?v7053;

!!SN:W^FirstAid_Slot_0_Creature^/y1;    [Save attacker creature ID by slot]
!!SN:W^FirstAid_Slot_1_Creature^/y2;
!!SN:W^FirstAid_Slot_2_Creature^/y3;
!!SN:W^FirstAid_Slot_3_Creature^/y4;
!!SN:W^FirstAid_Slot_4_Creature^/y5;
!!SN:W^FirstAid_Slot_5_Creature^/y6;
!!SN:W^FirstAid_Slot_6_Creature^/y7;


** start of battle end trigger
!?FU(OnAfterBattleUniversal)&1000;      [Continue trigger if any skills are enabled]
** first aid
!!BA:H0/?v7020;                         [get attacking hero #]
!!HEv7020&v7020>-1:O?v7021;             [get attacking hero's owner]

!!if&v7020>=0/v7021>=0;
  !!HEv7020:A2/6/?y7/?y8 S27/?y9;       [see if attacking hero has a First Aid Tent and SS]
  !!FU(Improved_FirstAid_Bonus)&y8>0/y9>0:P1/0; [handle first aid tent for attacker]

  !!HEv7020:E?y47/?y48/1;               [Check hero Level]
  !!HEv7020:X?y21/?y22/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality First Aid]
  !!FU(Improved_FirstAid_Bonus)&y8>0/y9>0/y21=0/y22=27/y48>=20:P1/0; [handle first aid tent for attacker, heal one additional time of First Aid Specialists if hero level 20]

  !!SN:W^Master_Mage_Hero%V7020^/?y11;
  !!SN:W^Master_Adventurer_Hero%V7020^/?y12;
  !!FU(Improved_FirstAid_Bonus)&y11=1/y12=1:P1/1; [handle first aid tent for attacker do second time if Druid, no tent required]
!!en;

!!BA:H1/?v7020;                         [get defending hero #]
!!FU&v7020<0:E;                         [Exit if no defending Hero]
!!HEv7020:O?v7021;                      [get defending hero's owner]
!!if&v7020>=0/v7021>=0;
  !!HEv7020:A2/6/?y7/?y8 S27/?y9;       [see if defending hero has a First Aid Tent and SS]
  !!FU(Improved_FirstAid_Bonus)&y8>0/y9>0:P2/0; [handle first aid tent for defender]

  !!HEv7020:E?y47/?y48/1;               [Check hero Level]
  !!HEv7020:X?y21/?y22/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality First Aid]
  !!FU(Improved_FirstAid_Bonus)&y8>0/y9>0/y21=0/y22=27/y48>=20:P2/0; [handle first aid tent for attacker, heal one additional time of First Aid Specialists if hero level 20]

  !!SN:W^Master_Mage_Hero%V7020^/?y11;
  !!SN:W^Master_Adventurer_Hero%V7020^/?y12;
  !!FU(Improved_FirstAid_Bonus)&y11=1/y12=1:P2/1; [handle first aid tent for defender do second time if Druid, no tent required]
!!en;

** function to handle first aid tent
!?FU(Improved_FirstAid_Bonus);          [y1= HP   y2=slot y9= first aid]

!!HEv7020:A2/5/?y7/?y8 E?y3/?y4/1 S27/?y9; [check for Ammo Cart, get hero's level, first aid level]
!!VRy9&x2=1:S3;                         [For Druids Set as Expert First Aid]

!!SN:W^H3_First Aid_0_Hero%V7020^/?y11; [Checke ob der Held Master Offense hat und Speichere in y11]
!!SN:W^H3_First Aid_1_Hero%V7020^/?y12; [Checke ob der Held Grandmaster Offense hat und Speichere in y12]

!!VRy5:S1;                              [set multiplier to 1]
!!VRy5&y8>0:+1;                         [ammo cart bonus]
!!VRy5:+y9;                             [first aid bonus]
!!VRy4:*2;                              [Hero Level*2]
!!VRy5&y11=1:+1;                        [Master Bonus]
!!VRy5&y12=1:+1;                        [Grandmaster Bonus]
!!HEv7020:X?y21/?y22/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality First Aid]
!!VRy5&y21=0/y22=27:+1;                 [+1 Modifier if First Aid Specialist]

!!VRy1:S5R35+y4*y5;                     [first aid tent heal: (5-40 + hero level*2) x bonus multiplier]

!!VRy30:S5 +y4*y5;                      [Min Damage]
!!VRy31:S40 +y4*y5;                     [Max Damage]
!!SN:W^Heal_After_Fight_Low_Hero%V7020^/y30; [Save Low Damage to display it in Bonus List]
!!SN:W^Heal_After_Fight_High_Hero%V7020^/y31; [Save High Damage to display it in Bonus List]
!!FU&x3=1:E;                            [Exit here to not run the actual fkt]

!!VRy2:S0R6;                            [random slot # to start search from]
!!SN:W^First_Aid_Heal_Slot^/7;          [7 = slot not found]
!!DO(AC_Function_15)/0/6/1:Px1/y1/y2/x2;[heal next slot with >= 1 monster killed, x2 holds if Druid Heal 1-Yes 0-No]
** end of function

** function to find slot where at least 1 cr was lost
!?FU(AC_Function_15);                   [x1=filter x2=hp healed  x3=slot]

!!VRy4:Sx3 %7;                          [get an actual slot number]
!!BA&x1=1:M0/y4/?y5/?y6;                [get y5 type and y6 qty in slot y3 :attacker]
!!BA&x1=2:M1/y4/?y5/?y6;                [get y5 type and y6 qty in slot y3 :defender]
!!VRy1&x1=1:S7040 +y4;                  [get variable # of previous qty :attacker]
!!VRy1&x1=2:S7047 +y4;                  [get variable # of previous qty :defender]
!!VRy7:Svy1;                            [get previous qty]
!!VRy7:-y6;                             [subtract current qty to get qty lost]
!!SN:W^First_Aid_Heal_Slot^/?y50;       [7 = slot not found]

!!SN:W^FirstAid_Slot_%Y4_Creature^/?y60;[get creature ID by slot from before combat and compare with current slot ID]
!!FU(Improved_FirstAid_Bonus2)&y50=7/y7>0/y6>0/y5=y60:Px1/x2/x3/y4/y5/y6/y7/x4; [try to heal stack if some lost but some left x4 holds if Druid Heal 1-Yes 0-No]
!!VRx3:+1;                              [next slot]
** end of function

** function to heal a stack
!?FU(Improved_FirstAid_Bonus2);

!!HEv7020:B0/?z1 O?y1;                  [get hero's name and owner]
!!OW:C?y3/?y4;                          [get current player and interacting player]
!!MA:Px5/?y8;                           [get hit points of monster x5 into y8]
!!FU|x5<0/y8<1:E;                       [exit if invalid value]
!!VRy5:Sx2;                             [# of hit points to heal]
!!VRy5::y8;                             [divided by monster hit points, rounded down, equals # to save]
!!VRy5&y5>x7:Sx7;                       [can't save more than qty that died]
!!BA&x1=1/y5>0:M0/x4/?x5/dy5;           [restore y5 creatures attacker]
!!BA&x1=2/y5>0:M1/x4/?x5/dy5;           [restore y5 creatures defender]
!!SN&y5=1/x8=0:T^AC_Misc.First Aid 1^/?z-9 Iz-9/?z-9; [get text file]
!!SN&y5>1/x8=0:T^AC_Misc.First Aid 2^/?z-9 Iz-9/?z-9;
!!SN&y5=1/x8=1:T^AC_Misc.First Aid 3^/?z-9 Iz-9/?z-9;
!!SN&y5>1/x8=1:T^AC_Misc.First Aid 3^/?z-9 Iz-9/?z-9;

!!if&y1=y3/y1=y4;                       [if hero owner is current player and interacting player. So only he sees the message after battle]
  !!IF&y5=1/x8=0:Q2/21/x5/1/z-9;        [show message for First Aid]
  !!IF&y5>1/x8=0:Q2/21/x5/1/z-9;
  !!IF&y5=1/x8=1:Q2/21/x5/1/z-9;        [show message for Natural Healer]
  !!IF&y5>1/x8=1:Q2/21/x5/1/z-9;
  !!UN:R1;                              [redraw screen to show revived creatures]
!!en;
!!SN&y5>0:W^First_Aid_Heal_Slot^/x4;    [note that we healed a stack if we did]
** end of function

**Health Bonus
!?BF;
*Give health to units based on First Aid Skill level

!!BH0:N?y1;                             [Attacker]
!!HEy1:S27/?y3;                         [Check for First Aid]

!!SN:W^H3_First Aid_0_Hero%Y1^/?y11;    [Checke ob der Held Master Tactics hat und Speichere in y11]
!!SN:W^H3_First Aid_1_Hero%Y1^/?y12;    [Checke ob der Held Grandmaster Tactics hat und Speichere in y12]

!!VRy10&y3=1:S1;
!!VRy10&y3=2:S2;                        [y9 Sets Speed y10 sets Attack and Defense]
!!VRy10&y3=3:S3;
!!VRy10&y3=3/y11=1/y12=0:S4;
!!VRy10&y3=3/y11=1/y12=1:S5;

!!DO(AC_Function_16)/0/20/1&y3>0:Py10/y1;

!!BH1:N?y1;                             [Defender]
!!FU&y1<0:E;
!!HEy1:S27/?y3;                         [Check for First Aid]
!!FU&y3=0:E;                            [Exit if no Hero]

!!SN:W^H3_First Aid_0_Hero%Y1^/?y11;    [Checke ob der Held Master First Aid hat und Speichere in y11]
!!SN:W^H3_First Aid_1_Hero%Y1^/?y12;    [Checke ob der Held Grandmaster First Aid hat und Speichere in y12]

!!VRy10&y3=1:S1;
!!VRy10&y3=2:S2;                        [y9 Sets Speed y10 sets Attack and Defense]
!!VRy10&y3=3:S3;
!!VRy10&y3=3/y11=1/y12=0:S4;
!!VRy10&y3=3/y11=1/y12=1:S5;

!!DO(AC_Function_16)/21/41/1&y3>0:Py10/y1;

!?FU(AC_Function_16);

!!VRy10:S0;
!!VRy10&x1=1:S102;                      [2% at basic]
!!VRy10&x1=2:S104;                      [4% at advanced]
!!VRy10&x1=3:S106;                      [6% at expert]
!!VRy10&x1=4:S108;                      [8% at master]
!!VRy10&x1=5:S110;                      [10% at grandmaster]

!!HEx2&x2>=0:X?y11/?y12 E?y46/?y47/1;   [Check Hero Speciality]
!!if&y12=27/y11=0;                      [if First Aid specialist]
  !!HEy6:E?y46/?y47/1;                  [Check hero Level]
  !!VRy47:*1+10;                        [level +10]
  !!VRy48:Sy47:15+1;                    [HP increase]
  !!VRy10:+y48;                         [add value to y10 for total HP increase]
!!en;

!!BMx16:H?y1;
!!BMx16:N?y20;                          [Creature Number y20]
!!BMx16:T?y21;                          [Creature Number y20]
!!FU|y20=0/y21=145/y21=146/y21=147/y21=148/y21=149:E; [Exit if zero or Warmachines]
!!VRy2:Sy1*y10:100;
!!VRy2&y2=y1:+1;                        [Min +1HP for low level troops]
!!BMx16:Hy2;

*-------------------------------First Aid Tent---------------------------------*
*Heal in and during Comabt*

!?FU(OnBattleRegeneratePhase);
** First Aid Tent Mod**
**When First Aid Tents turn decrease HP of unit that has already lost some stacks by 1 to avoid First Aid tent skipping turn
!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]

!!SN:X?y1;                              [Event parameter]
!!BMy1:I?y2;                            [Acting Side Monster]
!!BA:Hy2/?y4;                           [Current Hero]
!!FU&y4<0:E;                            [Exit if none]
!!BMy1:T?y3;                            [Get Creature Number]
!!DO(AC_Function_26)/0/20/1&y3=147/y2=0:P; [Left Side and First Aid Tent]
!!DO(AC_Function_26)/21/41/1&y3=147/y2=1:P; [Right Side and First Aid Tent]


!?FU(AC_Function_26);
!!BMx16:N?y1 H?y2 L?y3 B?y4;            [Get monsters stats]
!!BMx16:F?y5;                           [get flag]
!!VRy5:&12582912;                       [Check for Clone Spell]
!!FU&y5>0:E;                            [Exit if Clone because they cannot be healed]
!!if&y3=0/y1<>y4;                       [if creature amount is not the same as before battle]
!!BMx16:L1;                             [Only Reduce HP of creatures that has lost some units and is not full HP and are not cloned]
!!en;

!?FU(OnBeforeBattleUniversal);
!!SN:W^Improved_Tent^/-1;
!?FU(OnBeforeBattleUniversal);
!!SN:W^Improved_Tent^/-1;


!?BG0;
*First Aid Tent Turn, get clicked target
!!BG:H?y1;
!!FU&y1=-1:E;
!!SN:W^Tent_Herbalism_%Y1^/?y20;
!!HEy1:S27/?y2;                         [Checke ob der First Aid hat]

!!BG:A?y5 E?y3 N?y4;
!!BMy4:T?y4;
!!SN&y5=11/y4=147/y2>0:W^Improved_Tent^/y3; [Sets Healed Target to Improved Tent if First Aid Skill]

!!if&y5=11/y4=147/y3>=0/y3<=42/y20=1;  [If action is Heal and Valid Target and Upgrade Bought]
    !!FU(AC_ResetSpellFromStack):Py3/42;[42 Curse]
    !!FU(AC_ResetSpellFromStack):Py3/52;[52 My3sfortune]
    !!FU(AC_ResetSpellFromStack):Py3/45;[45 Weakness]
    !!FU(AC_ResetSpellFromStack):Py3/54;[54 Slow]
    !!FU(AC_ResetSpellFromStack):Py3/50;[50 Sorrow]
    !!FU(AC_ResetSpellFromStack):Py3/52;[52 My3sfortune]
    !!FU(AC_ResetSpellFromStack):Py3/62;[62 Bly3nd]
    !!FU(AC_ResetSpellFromStack):Py3/59;[59 Berserk]
    !!FU(AC_ResetSpellFromStack):Py3/60;[60 Hypnoty3ze]
    !!FU(AC_ResetSpellFromStack):Py3/61;[61 Forgetfulness]
    !!FU(AC_ResetSpellFromStack):Py3/70;[Stone]
    !!FU(AC_ResetSpellFromStack):Py3/71;[Poy3son]
    !!FU(AC_ResetSpellFromStack):Py3/72;[By3nd]
    !!FU(AC_ResetSpellFromStack):Py3/73;[Dy3sease]
    !!FU(AC_ResetSpellFromStack):Py3/74;[Paralyze]
    !!FU(AC_ResetSpellFromStack):Py3/75;[Age]
!!en;


!?FU(OnBattleStackObtainsTurn);

!!SN:W^Improved_Tent^/?y1;
!!FU&y1=-1:E;
!!SN:W^Improved_Tent^/-1;
!!BA:Q?y2;
!!FU&y2=1:E;                            [Exit in Quick Combat]
!!BMy1:I?y2 I?y4;
!!BA:Hy2/?y2;                           [Attacker]
!!FU&y2<0:E;
!!HEy2:S27/?y3;                         [Checke ob der First Aid hat]
!!FU&y3=0:E;

!!SN&y4=0:W^Tent_Capacity_Att^/?y5;
!!SN&y4=1:W^Tent_Capacity_Def^/?y5;
!!SN&y4=0/y5<0:W^Tent_Capacity_Att^/0;
!!SN&y4=1/y5<0:W^Tent_Capacity_Def^/0;
!!VRy5&y5<0:S0;

!!FU(AC_Function_35)&y5>0:Py1/y3/y5/0/y2; [The function only runs if enough Heal capacity is left]
!!SN:W^Improved_Tent^/-1;

!!SN:W^Tent_Number_Att^/?y2;            [Set new heal capacity for Tent]
!!if&y2>=0/y2<=20/y4=0;
!!SN:W^Tent_Capacity_Att^/?y10;
*!BMy2:U1/y10 U2/y10;                   [Set Tent damage]
!!en;

!!SN:W^Tent_Number_Def^/?y2;
!!if&y2>=21/y2<=41/y4=1;
!!SN:W^Tent_Capacity_Def^/?y10;
*!BMy2:U1/y10 U2/y10;                   [Set Tent damage]
!!en;

!!FU&y5=0:E;
!!BA:Q?f;
!!BU&i^battle_isVisible^:R;


!?FU(AC_Function_35);                   [*Restore HP of Healed creatures*]
x1=Stack, x2=First Aid Skill Level, x3=Heal Capacity, x4= 0 out of combat x4= 1 in combat, x5=Hero ID

!!FU&x5<0:E;                            [Exit if no valid hero ID]
!!HEx5:X?y81/?y82/?y83/?y84/?y85/?y86/?y87; [Check Hero Speciality]
!!HEx5:E?y73/?y74/1;
!!VRy75&y74<25:Sy74*10;                 [10 times the Hero Level additional heal before hero level 25]
!!VRy75&y74>=25:Sy74*15;                [15 times the Hero Level additional heal after hero level 25]

!!SN:W^H3_First Aid_0_Hero%X5^/?y71;    [Checke ob der Held Master First Aid hat und Speichere in y71]
!!SN:W^H3_First Aid_1_Hero%X5^/?y72;    [Checke ob der Held Grandmaster First Aid hat und Speichere in y72]

!!VRy10&x2=0:S20;                       [Set Heal for None]
!!VRy10&x2=1:S30 +y75;                  [Set Heal for Basic]
!!VRy10&x2=2:S50 +y75;                  [Set Heal for Advanced]
!!VRy10&x2=3/y71=0/y72=0:S75 +y75;      [Set Heal for Expert]
!!VRy10&x2=3/y71=1/y72=0:S150 +y75;     [Set Heal for Master]
!!VRy10&x2=3/y71=1/y72=1:S250 +y75;     [Set Heal for Grandmaster]

!!VRy76&y81=0/y82=27:S110+y74;          [Specialists have increased Heal 110%+HLvL%]
!!VRy10&y81=0/y82=27:*y76:100;          [multiply heal with 110 + Hero Level]

!!COx5:D?y40;                           [Check if Commander of Hero is still alive]
!!COx5:T?y41;                           [Check if Commander Type]
!!SN:W^ACM_Com_%X5_Passive_2^/?y70;     [Check for 2Supporter ability]
!!VRy40&y70=1:S0; !!VRy41&y70=1:S1;     [bypass check with ability]

!!if&y40=0/y41=1;                       [If Commander alive and is a Hierophant]
  !!FU(Check_Com_Masteries):Px5/0/0/0/0/0/0/0/0/0/0/?y65; [Pass Hero Number and return Passive Modifier]
  !!COx5:X2/?y42;                       [Get Commander Level]
  !!VRy43:Sy42*5*y65:100;               [Multiply level of Commander with 5 and then with passive modifier]
  !!VRy10:+y43;                         [Add level*5 HP to heal for the First Aid Tent]
!!en;

!!SN:W^Tent_Improved_%X5^/?y70;
!!if&y70=1;                             [If WM upgrade bought]
  !!VRy10:*125:100;                     [Increase Heal Amount by 25%]
!!en;

!!VRy70:Sy10:2;
!!SN:W^Heal_InCombat_Low_Hero%X5^/y70;  [Save Low Heal to display it in Bonus List]
!!SN:W^Heal_InCombat_High_Hero%X5^/y10; [Save High Heal to display it in Bonus List]

!!if&x4=0;                              [This part only runs in combat]
; Exit if the current number is greater than the initial (possible with scripts)
  !!BMx1:I?y60;                         [Acting Side Monster]
  !!BA:Hy60/?y61;                       [Current Hero]
  !!SN:W^H3_First Aid_0_Hero%X5^/?y71;  [Checke ob der Held Master First Aid hat und Speichere in y71]
  !!SN:W^H3_First Aid_1_Hero%X5^/?y72;  [Checke ob der Held Grandmaster First Aid hat und Speichere in y72]
  !!BMx1:N?y1 B?y4;
  !!FU&y1>y4:E;  
  !!BMx1:H?y2 L?y3;                     [Get Battle Monsters parameters]
  !!FU&y4=0:E;
  !!FU&y2=0:E;
  !!FU&y1=y4/y3=0:E;                    [Exit if monster was not damaged]
!!en;

!!FU&x4=1:E;                            [Exit here to not run the actual fkt]

!!VRy10::2; !!VRy10:Sy10Ry10;           [Divide Heal trough 2 and Set range to half + R(half)]

*!VRy10:S1000; Test set heal to 1000

!!SN&i^battle_isVisible^:T^AC_Misc.Battle Heal^/?z2/^Heal^/y10;
!!BU&i^battle_isVisible^:Mz2;

!!VRy20:Sy10*-1;
!!SN&y60=0:W^Tent_Capacity_Att^/dy20;
!!SN&y60=1:W^Tent_Capacity_Def^/dy20;
!!SN&y60=0:W^Tent_Capacity_Att^/?y21;
!!SN&y60=1:W^Tent_Capacity_Def^/?y21;
!!SN&y60=0/y21<=0:W^Tent_Capacity_Att^/0;
!!SN&y60=1/y21<=0:W^Tent_Capacity_Def^/0;

!!VRy12:Sy10 %y2;                       [Divide Amount of Heal durch HP]
!!VRy15:Sy3;                            [Set to lost life]
!!VRy15:Sy15-y12;                       [Lost life - difference from Heal]
!!VRy16:Sy15;
!!VRy11:Sy10:y2;                        [Number of possible Revives]

!!if&y12>=y3;                           [Calc correct rest life]
!!VRy16:*-1;
!!VRy17:Sy2;
!!VRy17:-y16;
!!VRy16:Sy17;
!!VRy11:+1;                             [Add 1 creature for correct rest life]
!!en;

!!VRy6:Sy1+y11;                         [Total Number after attack]
!!VRy40:Sy6-1;
!!VRy16&y6>y4:S0;                       [Fix for Commander, Set lost life to zero if could heal more than 1 stack above maximum]
!!VRy6&y6>=y4:Sy4;                      [Set Number Cannot be more than before fight]

!!SN:W^Tent_Overheal_%X5^/?y80;        [Overheal gives chance to additional raise troops when you heal them, over the current limit]
!!BMx1:N?y8 B?y9 T?y50 H?y17 G4/?y18/?y19; [Check Monster Parameters and for Disguise]
!!BMx1:Ny6 Ly16;                        [Heal happens Set Number and apply rest life]
*!IF:L^y8 is %Y8 and y9 is %Y9 und y80 is %Y80 Disguse %Y18 und %Y19^;

!!if&y80=1/y8<y9/y19=0;                 [If below number as before fight, no Henchman and no Commander]
!!if|y50<174/y50>191;
  !!MA:Ly50/?y11;                       [Get Monster Level]
  !!VRy13:S0; !!VRy13&y11=0:S6; !!VRy13&y11=1:S5; !!VRy13&y11=2:S4; !!VRy13&y11=3:S3; !!VRy13&y11=4:S2; !!VRy13&y11=5:S1; !!VRy13&y11=6:S1; [Number of possible revices based on creature level]
  !!VRy15:S0R99;
  !!VRy16&y11=0:S80; !!VRy16&y11=1:S75; !!VRy16&y11=2:S70; !!VRy16&y11=3:S65; !!VRy16&y11=4:S63; !!VRy16&y11=5:S58; !!VRy16&y11=6:S35; [Chance for Overheal to work in percent]

  !!SN&y60=0:W^Tent_Capacity_Att^/?y21; [Get current Heal capacity]
  !!SN&y60=1:W^Tent_Capacity_Def^/?y21;
  !!if&y16>y15/y21>0;                   [If roll successfull and still heal capacity left]
    !!BMx1:Ndy13 Bdy13;                 [Add One Extra Creature if already full and roll is successfull]
    !!VRy20:Sy13*y17+100*-1;            [Get total HP over overheald creatures +100HP as Heal Capacity]
    !!SN&y60=0:W^Tent_Capacity_Att^/dy20;[Substract Resurrected Amount from current capacity]
    !!SN&y60=1:W^Tent_Capacity_Def^/dy20;
    !!SN&y60=0:W^Tent_Capacity_Att^/?y21;
    !!SN&y60=1:W^Tent_Capacity_Def^/?y21;
    !!SN&y60=0/y21<=0:W^Tent_Capacity_Att^/0; [If below zero set zero]
    !!SN&y60=1/y21<=0:W^Tent_Capacity_Def^/0;

    !!if&i^battle_isVisible^/y13>0;
      !!SN:T^AC_Warmachine.Tent_Overheal^/?z1/^num^/y13;
      !!BU:Mz1;
    !!en;
  !!en;
    *!IF:M^%Y8 %Y9 %Y10 Number:%Y13 Chance:%Y16 Roll:%Y15
    New Capacity is %Y21 and deduceted amount is %Y20^;
!!en;
!!en;

!!if&i^battle_isVisible^/y21<=0;
  !!VRz2:S^^;
  !!HEi^battle_hero_%y60^&i^battle_hero_%y60^>(NO_HERO):B0/?z2;
  !!SN:H^monname^/(MON_FIRST_AID_TENT)/0/?z3;
  !!SN:T^AC_Warmachine.Tent_Depleted^/?z1/^hero^/z2/^tent^/z3;
  !!MM:Sz1;
!!en;

!!BU&i^battle_isVisible^:R;

!!SN:W^Tent_Gold_Gain_%X5^/?y1;
!!SN&y1=1/y60=0:W^Total_Healed_Amount_Att^/dy10; [Save value for attacker]
!!SN&y1=1/y60=1:W^Total_Healed_Amount_Def^/dy10; [Save value for defender]


!?FU(OnAfterBattleUniversal);
; Archer30: Here we show the after battle msg for the defending player (who's not the turn owner)
; Is it safe?
!!OW:C?y31/?y32;

!!BA:O?y1/?y20;                         [Check both Owners after Battle]
!!SN:W^Hero_Attacker_Owner0^/?y10;      [check saved owner]
!!if&y1=y10;                            [run if the same]
  !!BA:H0/?y2;                          [get battle hero]
  !!HEy2:O?y30;                         [Get Hero Owner]

  !!if&y30=y32;
    !!HEy2:A2/6/?y5/?y6;                  [check 6  First Aid Tent]
    !!SN:W^Tent_Gold_Gain_%Y2^/?y3;       [check upgarde]
    !!SN:W^Total_Healed_Amount_Att^/?y4;  [check healed amount]
    !!VRy4:*3;                            [3 times the amount heal in gold]
    !!OW&y6=1/y3=1/y4>0:Ry1/6/dy4;        [Give gold to player if He has First Aid Tent and Upgrade Bought]
    !!SN&y6=1/y3=1/y4>0:T^AC_Misc.Treatment_Text^/?z1;
    !!IF&y6=1/y3=1/y4>0:Q2/36/y4/1/z1;    [If Bonus Show Picture]
    !!SN&y6=1/y3=1/y4>0/y30>=0:W^Total_Treatment_Gold_%Y2^/dy4; [add gained gold]
  !!en;
!!en;

!!BA:H1/?y2;                            [Defender]
!!FU|y2<0/y20<0:E;

!!SN:W^Hero_Defender_Owner0^/?y30;
!!if&y20=y30;
  !!HEy2:O?y30;                         [Get Hero Owner]

  !!if&y30=y32;
    !!HEy2:A2/6/?y5/?y6;                  [6  First Aid Tent]
    !!SN:W^Tent_Gold_Gain_%Y2^/?y3;
    !!SN:W^Total_Healed_Amount_Def^/?y4;  [check healed amount]
    !!VRy4:*3;                            [3 times the amount heal in gold]
    !!OW&y6=1/y3=1/y4>0:Ry20/6/dy4;       [Give gold to player if He has First Aid Tent and Upgrade Bought]
    !!SN&y6=1/y3=1/y4>0:T^AC_Misc.Treatment_Text^/?z1;
    !!IF&y6=1/y3=1/y4>0:Q2/36/y4/1/z1;    [If Bonus Show Picture]
    !!SN&y6=1/y3=1/y4>0/y30>=0:W^Total_Treatment_Gold_%Y2^/dy4; [add gained gold]
  !!en;
!!en;


!?FU(OnCombatRound)&v997=0;
*function for calculation of total Heal Capacity for attacker and defender

!!SN:W^Total_Healed_Amount_Att^/0;      [Reset value before any fight]
!!SN:W^Total_Healed_Amount_Def^/0;
!!SN:W^Tent_Number_Att^/-1;
!!SN:W^Tent_Number_Def^/-1;
!!SN:W^Tent_Capacity_Att^/0;
!!SN:W^Tent_Capacity_Def^/0;
!!SN:W^Army_Att^/1;
!!SN:W^Army_Def^/1;

!!DO(AC_Function_27)/0/41/1:P2;

!!BA:H0/?y1;                            [Attacker Hero]
!!HEy1:S27/?y3;                         [Checke ob der First Aid hat]
!!SN:W^H3_First Aid_0_Hero%Y1^/?y30;    [Checke ob der Held Master First Aid hat und Speichere in y30]
!!SN:W^H3_First Aid_1_Hero%Y1^/?y31;    [Checke ob der Held Grandmaster First Aid hat und Speichere in y31]
!!VRy5:S0;
!!VRy5&y3=1:S50; !!VRy5&y3=2:S150; !!VRy5&y3=3/y30=0/y31=0:S250; !!VRy5&y3=3/y30=1/y31=0:S400; !!VRy5&y3=3/y30=1/y31=1:S800;

!!SN:W^Army_Att^/?y10;
!!SN:W^Tent_Number_Att^/?y2;
!!if&y2>=0/y2<=20;
  !!VRy10::50 +y5;                      [Take 2% of total army strength + bonus based on First Aid level]
  !!SN:W^Tent_Capacity_Upgrade_%Y1^/?y11;[For Blacksmith Upgrade at +500 capacity to heal]
  !!if&y11=1;
    !!VRy10:+500;                       [Add +500 flat capacity from upgradae]
    !!VRy10:*110:100;                   [Add +10% capacity from upgradae]
  !!en;
  !!COy1:D?y50;                         [Get Commander Alive]
  !!COy1:T?y51;                         [Get Commander Type]
  !!VRy53:S0;
  !!SN:W^ACM_Com_%Y1_Passive_2^/?y70;   [Check for 2Supporter ability]
  !!VRy50&y70=1:S0; !!VRy51&y70=1:S1;   [bypass check with ability]
  !!if&y50=0/y51=1;                     [If Alive and Hierophant]
    !!FU(Check_Com_Masteries):Py1/0/0/0/0/0/0/0/0/0/0/?y65; [Pass Hero Number and return Passive Modifier]
    !!COy1:X2/?y52;                     [Get Commander Level]
    !!VRy53:Sy52*30*y65:100;            [30*Commander Level to Capacity multiply with passive modifier]
  !!en;
  !!VRy10:+y53;                         [Add Bonus Capacity from Commander]
  !!SN:W^Tent_Capacity_Att^/y10;        [Set Heal Capacity]
  !!SN:W^Tent_Capacity_Att_Hero%Y1^/y10;[Save HC from hero to show in bonus list]
  *!BMy2:U1/y10 U2/y10;                 [Set Tent damage]
!!en;

!!BA:H1/?y1;                            [Defender Hero]
!!if&y1>0;
  !!HEy1:S27/?y3;                       [Checke ob der First Aid hat]
  !!SN:W^H3_First Aid_0_Hero%Y1^/?y30;  [Checke ob der Held Master First Aid hat und Speichere in y30]
  !!SN:W^H3_First Aid_1_Hero%Y1^/?y31;  [Checke ob der Held Grandmaster First Aid hat und Speichere in y31]
  !!VRy5:S0;
  !!VRy5&y3=1:S50; !!VRy5&y3=2:S150; !!VRy5&y3=3/y30=0/y31=0:S250; !!VRy5&y3=3/y30=1/y31=0:S400; !!VRy5&y3=3/y30=1/y31=1:S800;

  !!SN:W^Army_Def^/?y10;
  !!SN:W^Tent_Number_Def^/?y2;
  !!if&y2>=21/y2<=41;
    !!VRy10::50 +y5;                    [Take 2% of total army strength + bonus based on First Aid level]
    !!SN:W^Tent_Capacity_Upgrade_%Y1^/?y11; [For Blacksmith Upgrade at +500 capacity to heal]
    !!if&y11=1;
      !!VRy10:+500;                     [Add +500 flat capacity from upgradae]
      !!VRy10:*110:100;                 [Add +10% capacity from upgradae]
    !!en;
    !!COy1:D?y50;                       [Get Commander Alive]
    !!COy1:T?y51;                       [Get Commander Type]
    !!VRy53:S0;
    !!SN:W^ACM_Com_%Y1_Passive_2^/?y70; [Check for 2Supporter ability]
    !!VRy50&y70=1:S0; !!VRy51&y70=1:S1; [bypass check with ability]
    !!if&y50=0/y51=1;                   [If Alive and Hierophant]
      !!FU(Check_Com_Masteries):Py1/0/0/0/0/0/0/0/0/0/0/?y65; [Pass Hero Number and return Passive Modifier]
      !!COy1:X2/?y52;                   [Get Commander Level]
      !!VRy53:Sy52*30*y65:100;          [30*Commander Level to Capacity multiply with passive modifier]
    !!en;
    !!VRy10:+y53;                       [Add Bonus Capacity from Commander]
    !!SN:W^Tent_Capacity_Def^/y10;      [Set Heal Capacity]
    !!SN:W^Tent_Capacity_Def_Hero%Y1^/y10; [Save HC from hero to show in bonus list]
    *!BMy2:U1/y10 U2/y10;               [Set Tent damage]
  !!en;
!!en;


!?FU(AC_Function_27);                   [increase Units Stats]
!!BMx16:T?y1 N?y2 H?y3;
!!if&x1=2;
  !!BMx16|y1=146/y1=147/y1=148:N1 B1;   [Set all Warmachines to 1]
  !!SN&x16<=20/y1=147:W^Tent_Number_Att^/x16;
  !!SN&x16>20/y1=147:W^Tent_Number_Def^/x16;
!!en;

!!FU|y1=146/y1=147/y1=148/y1=149:E;     [Dont count Warmachines to total army strength]
!!if&y2>0;                              [calc total Army Strength]
  !!VRy10:Sy2*y3;                       [Number times HP to get amount of Health]
  !!SN&x16<=20:W^Army_Att^/dy10;
  !!SN&x16>=21:W^Army_Def^/dy10;
!!en;


!?MM0;
!!FU:E; Disabled and replaced by new code
*Fix for showing zero damage when tents turn on right click
!!MM:D?y1;
!!if&y1>=0/y1<=186;
  !!BU:Ey1/?y2;
  !!if&y2>=0/y2<=41;
    !!BMy2:T?y3;
    !!FU&y3<>147:E;    
    !!BMy2:I?y4;
    !!SN&y4=0:W^Tent_Capacity_Att^/?y5;
    !!SN&y4=1:W^Tent_Capacity_Def^/?y5;
    !!BMy2&y4=0:U1/y5 U2/y5;
    !!BMy2&y4=1:U1/y5 U2/y5;
  !!en;
!!en;


!?FU(AC_AC_ResetSpellFromStack);
; x1 - stack id
; x2 - spell id
!!UN:C6919200/4/?y10;
!!VRy1:Sx1 *1352 +21708 +y10;
!!SN:E4473392/2/y1/x2;


**************************Scholar***********************************************
**Restores 3,4,5,7,10 Spell Points when heroes meets once per day and hero
**Grandmaster Scholar allows to teach 5th level spells

Before the interaction of the hero with the hero
!?FU(OnBeforeHeroInteraction)&1000;
!!SN:X?y1/?y2;                          [the number of the initiator hero, the number of the target hero.]

!!HEy1:O?y5;                            [Get Hero Owner]
!!HEy2:O?y6;
!!FU&y5<>y6:E;                          [Exit if heroes not from the same player]

!!VRy60:Si^timerDay^;
!!SN:W^H3_Scholar_H1%Y1_H2%Y2^/?y10;
!!FU&y10=y60:E;                         [Exit if they have already met today]
!!SN:W^H3_Scholar_H1%Y2_H2%Y1^/?y10;
!!FU&y10=y60:E;                         [Exit if they have already met today]

!!HEy1:S18/?y5;                         [Get Scholar Level]
!!HEy2:S18/?y6;
!!FU&y5=0/y6=0:E;                       [Exit if no hero has Scholar]

!!SN:W^H3_Scholar_0_Hero%Y1^/?y11;      [Checke ob der Held Master Scholar hat und Speichere in y11]
!!SN:W^H3_Scholar_1_Hero%Y1^/?y12;      [Checke ob der Held Grandmaster Scholar hat und Speichere in y12]
!!SN:W^H3_Scholar_0_Hero%Y2^/?y13;      [Checke ob der Held Master Scholar hat und Speichere in y11]
!!SN:W^H3_Scholar_1_Hero%Y2^/?y14;      [Checke ob der Held Grandmaster Scholar hat und Speichere in y12]

!!VRy7:S0;                              [Determine highest Scholar Level]
!!VRy7&y5=1:S3; !!VRy7&y5=2:S4; !!VRy7&y5=3:S5; !!VRy7&y11=1:S7; !!VRy7&y12=1:S10;
!!VRy7&y6=1/y7<3:S3; !!VRy7&y6=2/y7<4:S4; !!VRy7&y6=3/y7<5:S5; !!VRy7&y13=1/y7<7:S7; !!VRy7&y14=1/y7<10:S10;

!!HEy1:X?y40/?y41/?y42/?y43/?y44/?y45/?y46; [Scholar Specialist Handling + HeroLvl:5+1 extra SP regeneration]
!!HEy1&y40=0/y41=18:E?y47/?y48/1;       [Check hero Level]
!!VRy48&y40=0/y41=18::5+1;
!!VRy7&y40=0/y41=18:+y48;
!!HEy2:X?y40/?y41/?y42/?y43/?y44/?y45/?y46;
!!HEy2&y40=0/y41=18:E?y47/?y48/1;
!!VRy48&y40=0/y41=18::5+1;
!!VRy7&y40=0/y41=18:+y48;

!!FU(Intelligence_Set_Spell_Points)&y1>=0/y1<=155:Py1/0/?y30/1; [Return Max possible spell points for left Hero]
*!IF:M^Left %Y1 and Right %Y2 and recovered Mana is %Y7 and Max SP are %Y30^;
!!HEy1:I?y8/1;
!!VRy30&y8>y30:Sy8;                     [If Mana is already over Max just set to same value again]
!!VRy8:+y7;                             [Add SP to reg to current Mana]
!!HEy1&y8<=y30:Idy7/1;
!!HEy1&y8>=y30:Iy30/1;

!!FU(Intelligence_Set_Spell_Points)&y2>=0/y2<=155:Py2/0/?y30/1;
!!HEy2:I?y8/1;
!!VRy30&y8>y30:Sy8;                     [If Mana is already over Max just set to same value again]
!!VRy8:+y7;
!!HEy2&y8<=y30:Idy7/1;
!!HEy2&y8>=y30:Iy30/1;

!!SN:W^H3_Scholar_H1%Y1_H2%Y2^/y60;     [Set Flag so it can only happen once]
!!SN:W^H3_Scholar_H1%Y2_H2%Y1^/y60;


*Grandmaster Scholar allows to teach 5th level spells*
; by Archer30
!?FU(ACM_CreateERMHook);
!#VA(setHook:x);

!!SN:E(setHook)/1/4859479/(ACM_OnScholarTeachSpells); 4A25E2

!?FU(ACM_OnScholarTeachSpells);
!#VA(hook:x);

; Get the max scholar level between 2 heroes
!!UN:C(hook)/(STRUCT_HOOK_CONTEXT_ESI)/4/?(maxLevel:y);

; If the max scholar is Expert, check if Grandmaster Scholar is learned by any of the heroes
!!if&(maxLevel)=(SKILL_EXPERT);
  !!UN:C(hook)/(STRUCT_HOOK_CONTEXT_EDI)/4/?(heroStruct1:y);
  !!UN:C(heroStruct1)/26/4/?(heroId1:y);
  !!HE(heroId1):S(SKILL_SCHOLAR)/?(level1:y);

  !!if&(level1)>=(SKILL_EXPERT)/i^H3_Scholar_0_Hero%(heroId1)^/i^H3_Scholar_1_Hero%(heroId1)^;
    !!UN:C(hook)/(STRUCT_HOOK_CONTEXT_ESI)/4/4; [Set Scholar level as +1 (a.k.a. 4)]

    !!FU:E;
  !!en;

  !!UN:C(hook)/(STRUCT_HOOK_CONTEXT_EBX)/4/?(heroStruct2:y);
  !!UN:C(heroStruct2)/26/4/?(heroId2:y);
  !!HE(heroId2):S(SKILL_SCHOLAR)/?(level2:y);

  !!if&(level2)>=(SKILL_EXPERT)/i^H3_Scholar_0_Hero%(heroId2)^/i^H3_Scholar_1_Hero%(heroId2)^;
    !!UN:C(hook)/(STRUCT_HOOK_CONTEXT_ESI)/4/4;
  !!en;
!!en;

******************Sorcery Offense Armorer Archery*******************************
[Set Secondary Skill Percents]
!?FU(OnOpenHeroScreen);                 [Open Hero Screen Trigger  to Adjust Sorcery Spell Damage when clicked on Book]
!!HE-1:N?y1;
!!FU(Switch_Secondary_Skill_Level)&y1>=0/y1<=155:Py1/y1; [Pass Hero Number]

**Set Correct Values for New Offense for Attacking and Retaliation
!?FU(OnCombatRound)&v997=0;             [On First visible combat round]
!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]
!!BG:Q?y1;                              [Get current attacking side]
!!BA:Hy1/?y2;                           [Get current hero]
!!VRy1:-1 *-1;                          [Get opposing hero]
!!BA:Hy1/?y3;
!!FU(Switch_Secondary_Skill_Level)&y2>=0/y2<=155:Py2/y3; [Pass Hero Number]

!?FU(OnBattleRegeneratePhase);          [Set Secondary Skill Percents in Battle]
!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]
!!SN:X?y1/?y2/0;                        [get who moves]
!!VRy2:Sy1:21;                          [get side]
!!BHy2:N?y1;                            [get owner of current side]
!!VRy2:-1 *-1;
!!BHy2:N?y3;                            [get owner of other side]
!!FU(Switch_Secondary_Skill_Level)&y1>=0/y1<=155:Py1/y3; [Pass Hero Number]

!?FU(ACM_Event_AfterMeeleDamage);
!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]
!!BG:Q?y1;
!!VRy1:-1 *-1;
!!BA:Hy1/?y2;
!!VRy1:-1 *-1;
!!BA:Hy1/?y3;
!!FU(Switch_Secondary_Skill_Level)&y2>=0/y2<=155:Py2/y3; [Pass Hero Number]
!!FU(Switch_Secondary_Skill_Level)&y2=-2:Py3/y3; [Pass Hero Number in case no enemy hero]


!?FU(OnStartOrLoad);                  
!!SN:L^EraPlugins\erm_hooker.era^/?y1;
!!FU&y1=0:E;                                   
!!SN:Ay1/^SetHook^/?y2;                 
!!SN:Ey2/1/4462998/(ACM_Event_AfterMeeleDamage);


!?FU(Switch_Secondary_Skill_Level);

!!HEx1:S1/?y10;                         [Check for Archery]
!!SN:W^H3_Archery_0_Hero%X1^/?y11;      [Checke ob der Held Master Archery hat und Speichere in y11]
!!SN:W^H3_Archery_1_Hero%X1^/?y12;      [Checke ob der Held Grandmaster Archery hat und Speichere in y12]
!!FU(SetSecSkillPercent)&y10=3/y11=1/y12=0:P1/3/65; [SS Werte skill Setzten      [Set Skillvalue to 65% for Master]
!!FU(SetSecSkillPercent)&y10=3/y11=1/y12=1:P1/3/75; [SS Werte skill Setzten      [Set Skillvalue to 75% for GrandMaster]
!!FU(SetSecSkillPercent)&y11=0/y12=0:P1/3/50; [SS Werte skill Setzten            [Set back to normal Expert value 50% if no improvement]

*!if&x2>=0/x2<=155;                     Game values are ignored, calculation happens in EE script
  *!HEx2:S11/?y10;                        [Check for Eagle Eye]
  *!SN:W^H3_Eagle Eye_0_Hero%X2^/?y11;    [Checke ob der Held Master Eagle Eye hat und Speichere in y11]
  *!SN:W^H3_Eagle Eye_1_Hero%X2^/?y12;    [Checke ob der Held Grandmaster Eagle Eye hat und Speichere in y12]
  *!FU(SetSecSkillPercent)&y10=3/y11=1/y12=0:P11/3/85; [SS Werte skill Setzten     [Set Skillvalue to 85% for Master]
  *!FU(SetSecSkillPercent)&y10=3/y11=1/y12=1:P11/3/100; [SS Werte skill Setzten    [Set Skillvalue to 100% for GrandMaster]
  *!FU(SetSecSkillPercent)&y11=0/y12=0:P11/3/75; [SS Werte skill Setzten           [Set back to normal Expert value 75% if no improvement]
*!en;

!!HEx1:S22/?y10;                        [Check for Offense]
!!SN:W^H3_Offense_0_Hero%X1^/?y11;      [Checke ob der Held Master Offense hat und Speichere in y11]
!!SN:W^H3_Offense_1_Hero%X1^/?y12;      [Checke ob der Held Grandmaster Offense hat und Speichere in y12]
!!FU(SetSecSkillPercent)&y10=3/y11=1/y12=0:P22/3/35; [SS Werte skill Setzten     [Set Skillvalue to 35% for Master]
!!FU(SetSecSkillPercent)&y10=3/y11=1/y12=1:P22/3/40; [SS Werte skill Setzten     [Set Skillvalue to 40% for GrandMaster]
!!FU(SetSecSkillPercent)&y11=0/y12=0:P22/3/30; [SS Werte skill Setzten           [Set back to normal Expert value 30% if no improvement]

!!if&x2>=0/x2<=155;
  !!HEx2:S23/?y10;                        [Check for Armorer]
  !!SN:W^H3_Armorer_0_Hero%X2^/?y11;      [Checke ob der Held Master Armorer hat und Speichere in y11]
  !!SN:W^H3_Armorer_1_Hero%X2^/?y12;      [Checke ob der Held Grandmaster Armorer hat und Speichere in y12]
  !!FU(SetSecSkillPercent)&y10=3/y11=1/y12=0:P23/3/20; [SS Werte skill Setzten     [Set Skillvalue to 20% for Master]
  !!FU(SetSecSkillPercent)&y10=3/y11=1/y12=1:P23/3/25; [SS Werte skill Setzten     [Set Skillvalue to 25% for GrandMaster]
  !!FU(SetSecSkillPercent)&y11=0/y12=0:P23/3/15; [SS Werte skill Setzten           [Set back to normal Expert value 15% if no improvement]
!!en;

!!HEx1:S24/?y10;                         [Get Intelligence level]
!!SN:W^H3_Intelligence_0_Hero%X1^/?y11; [Checke ob der Held Master Intelligence hat und Speichere in y11]
!!SN:W^H3_Intelligence_1_Hero%X1^/?y12; [Checke ob der Held Grandmaster Intelligence hat und Speichere in y12]
!!FU(SetSecSkillPercent)&y10=3/y11=1/y12=0:P24/3/100; [SS Werte skill Setzten     [Set Skillvalue to 100% for Master]
!!FU(SetSecSkillPercent)&y10=3/y11=1/y12=1:P24/3/125; [SS Werte skill Setzten     [Set Skillvalue to 125% for GrandMaster]
!!FU(SetSecSkillPercent)&y11=0/y12=0:P24/3/75; [SS Werte skill Setzten           [Set back to normal Expert value 75% if no improvement]

!!HEx1:S25/?y10;                        [Check for Sorcery]
!!SN:W^H3_Sorcery_0_Hero%X1^/?y11;      [Checke ob der Held Master Sorcery hat und Speichere in y11]
!!SN:W^H3_Sorcery_1_Hero%X1^/?y12;      [Checke ob der Held Grandmaster Sorcery hat und Speichere in y12]
!!FU(SetSecSkillPercent)&y10=3/y11=1/y12=0:P25/3/40; [SS Werte skill Setzten     [Set Skillvalue to 40% for Master]
!!FU(SetSecSkillPercent)&y10=3/y11=1/y12=1:P25/3/50; [SS Werte skill Setzten     [Set Skillvalue to 50% for GrandMaster]
!!FU(SetSecSkillPercent)&y11=0/y12=0:P25/3/30; [SS Werte skill Setzten           [Set back to normal Expert value 30% if no improvement]

!!if&x2>=0/x2<=155;
  !!HEx2:S26/?y10;                        [Check for Resistance]
  !!SN:W^H3_Resistance_0_Hero%X2^/?y11;   [Checke ob der Held Master Resistance hat und Speichere in y11]
  !!SN:W^H3_Resistance_1_Hero%X2^/?y12;   [Checke ob der Held Grandmaster Resistance hat und Speichere in y12]
  !!FU(SetSecSkillPercent)&y10=3/y11=1/y12=0:P26/3/25; [SS Werte skill Setzten     [Set Skillvalue to 25% for Master]
  !!FU(SetSecSkillPercent)&y10=3/y11=1/y12=1:P26/3/30; [SS Werte skill Setzten     [Set Skillvalue to 30% for GrandMaster]
  !!FU(SetSecSkillPercent)&y11=0/y12=0:P26/3/20; [SS Werte skill Setzten           [Set back to normal Expert value 20% if no improvement]
!!en;


**************************Intelligence******************************************
**Increase max Spell Points to 125% at GM and regenerates Heroes Mana when in Towns*

// New implementation
; By Archer30
!?FU(ACM_CreateERMHook);
!#VA(setHook:x);

!!SN:E(setHook)/1/5131057/(ACM_OnGetIntelligencePower); 4E4B31

!?FU(ACM_OnGetIntelligencePower);
!#VA(hook:x);

!!UN:C(hook)/(STRUCT_HOOK_CONTEXT_EAX)/1/?(intLvl:y);

!!if&(intLvl)>=(SKILL_EXPERT);
  !!UN:C(hook)/(STRUCT_HOOK_CONTEXT_ECX)/4/?(heroStruct:y);
  !!UN:C(heroStruct)/26/4/?(heroId:y);

  !!if&i^H3_Intelligence_0_Hero%(heroId)^;
    !!if&i^H3_Intelligence_1_Hero%(heroId)^<>(TRUE);
      !!VR(intPowerFloat:e):S1;
    !!el;
      !!VR(intPowerFloat):S5 :4;
    !!en;

    !!SN:X?t X(intPowerFloat) X?(intPower:y) Xt;
    !!UN:C(hook)/(STRUCT_HOOK_CONTEXT_EBP)/4/?(ebp:y);
    !!UN:C(ebp)/-4/4/(intPower);

    !!SN:X?t/0;
    !!UN:C(hook)/(STRUCT_HOOK_CONTEXT_RET)/4/5131069; 4E4B3D
  !!en;
!!en;

; Replaced by Archer's script. It has problem showing correct spell points in the battle (non-hero screen)
!?FU(OnEveryDay)&i^timerIsAi^=0;
!!FU:E;

!!UN:P787/?y1;                          [Check if New Mana Regeneration System option is active]
!!FU&y1=1:E;                            [Exit if it is enabled]
!!UN:U98/-1/?y1;                        [Get tower coordinates to y1]
!!DO(AC_Function_17)/1/y1/1&y1>0:P;     [Loop all Towns]

!?FU(AC_Function_17);
!!UN:U98/-1/x16/1;                      [Get the index of the tower coordinates to x16]
!!CA1:G?y10;                            [Mage Guilt Built]
!!FU&y10=0:E;
!!VRy20:Si^timerWeek^;                  [Put Current Week in Y20]

!!CA1:H0/?y2;                           [Check the garrison hero number]
!!if&y2>=0;
  !!CA1:T?y50;                          [Get town type]
  !!VRy51:S0;
  !!CA1&y50=5:B3/21;                    [Special Building Built]
  !!SN:W^Mana_Vortex_Hero%Y2_Week_%Y20^/?y3; [So it only works once per Week]
  !!FU(Hero_Intelligence_Loop)&y2>=0/y2<=155:Py2;
  *!VRy51&-1/y50=5/y3=1:S0;             [Set to zero if no Mana Vortex]
  *!VRy51&1/y50=5/y3=0:S1;
  !!FU(Intelligence_Set_Spell_Points)&y2>=0/y2<=155:Py2/y51/0/0; [If y51=1 Means Double Spell Points and x4=0 means Set]
  !!SN&y3=0:W^Mana_Vortex_Hero%Y2_Week_%Y20^/1;
!!en;

!!CA1:H1/?y2;                           [Check the visiting hero number]
!!FU&y2=-1:E;                           [Exit if no Hero]
!!CA1&y2>=0:T?y50;                      [Get Town type]
!!VRy51:S0;
!!CA1&y50=5/y2>=0:B3/21;                [Check Special Building Built]
!!SN:W^Mana_Vortex_Hero%Y2_Week_%Y20^/?y3; [So it only works once per Week]
!!FU(Hero_Intelligence_Loop)&y2>=0/y2<=155:Py2;
*!VRy51&-1/y50=5/y3=1:S0;
*!VRy51&1/y50=5/y3=0:S1;
!!FU(Intelligence_Set_Spell_Points)&y2>=0/y2<=155:Py2/y51/0/0; [If y51=1 Means Double Spell Points and x4=0 means Set]
!!SN&y3=0:W^Mana_Vortex_Hero%Y2_Week_%Y20^/1;


!?FU(Intelligence_Set_Spell_Points);
x1=Hero Id,  x2=1 double Spell Points   x3=Returns Max Spell Points   x4=1 to only check and not set SP 0 means Set
x5=Current Spell Points

!!HEx1:S24/?y6;                         [Get Intelligence level]
!!HEx1:E?y47/?y48/1;                    [Get Hero level]
!!VRy5:S0;

!!HEx1:F?y33/?y34/?y35/?y5;             [get knowledge of hero]
!!VRy7:Sy5*10;                          [multiply with 10 and save for later :)]
!!VRy5:*10;                             [multiply with 10]

!!SN:W^H3_Intelligence_0_Hero%X1^/?y11; [Checke ob der Held Master Intelligence hat und Speichere in y11]
!!SN:W^H3_Intelligence_1_Hero%X1^/?y12; [Checke ob der Held Grandmaster Intelligence hat und Speichere in y12]

!!VRy5&y6=3/y11=1/y12=1:*9:4;           [125% if Grandmaster Intelligence is present]
!!VRy5&y6=3/y11=1/y12=0:*8:4;           [100% if Master Intelligence is present]
!!VRy5&y6=3/y11=0/y12=0:*7:4;           [75% if Expert Intelligence is present]
!!VRy5&y6=2:*6:4;                       [50% if Advanced Intelligence is present]
!!VRy5&y6=1:*5:4;                       [25% if Basic Intelligence is present]

!!HEx1:X?y50/?y51/d/d/d/d/d;            [Check Hero Speciality]
!!if&y50=0/y51=24;                      [Handle Intelligence Specialists]
  !!FU(Skill_Value_Database):Px1/24/y48/?y71; [Pass Hero Number, Skill, Hero Level, Return Value]
  !!VRy8&y6=3/y11=1/y12=1:S125;
  !!VRy8&y6=3/y11=1/y12=0:S100;
  !!VRy8&y6=3/y11=0/y12=0:S75;
  !!VRy8&y6=2:S50;
  !!VRy8&y6=1:S25;
  !!VRy8:+y71+100;                      [Add Level Increase +Intelligence percents and than multiply the value with base Spell Points]
  !!VRy5:Sy7*y8:100;                    [Calc Increases Spell Points Value]
!!en;

!!VRy5&x2=1:*2;                         [outdated and now handeled by game]

!!HEx1:I?y6/1;                          [Check Hero Spell Points]
!!VRx3:Sy5;                             [Set Max possible Spell Points to return in x3]
!!HEx1&y5>y6/x4=0:Iy5/1;                [Set hero spell points to Max only if smaller than current SP]
!!VRx5:Sy6;                             [Returns current spell points]


!?FU(OnOpenTownScreen);
!!FU:E;

!!CA-1:H1/?y1;                           [Check the visiting hero number]
!!FU(Hero_Intelligence_Loop)&y1>=0/y1<=155:Py1;


!?FU(OnOpenHeroScreen);                 [Open Hero Screen to Show Correct Max Spell Points]
!!FU:E;

!!HE-1:N?y1;
!!FU(Hero_Intelligence_Loop)&y1>=0/y1<=155:Py1;


!?FU(OnCloseHeroScreen);
!!FU:E;

!!FU(SetSecSkillPercent):P24/3/75;      [SS Werte skill Setzten]


!?FU(Hero_Intelligence_Loop);
!!HEx1:S24/?y10;                        [Check for Intelligence]
!!FU&y10<3:E;
!!SN:W^H3_Intelligence_0_Hero%X1^/?y11; [Checke ob der Held Master Intelligence hat und Speichere in y11]
!!SN:W^H3_Intelligence_1_Hero%X1^/?y12; [Checke ob der Held Grandmaster Intelligence hat und Speichere in y12]
!!FU(SetSecSkillPercent)&y10=3/y11=1/y12=0:P24/3/100; [SS Werte skill Setzten]
!!FU(SetSecSkillPercent)&y10=3/y11=1/y12=1:P24/3/125; [SS Werte skill Setzten]
!!FU(SetSecSkillPercent)&y10=3/y11=0/y12=0:P24/3/75; [SS Werte skill Setzten]


!?OB98/5&1000;                          [Visit Dungeon Town]
!!FU:E;

!!HE-1:N?y1;
!!FU(Hero_Intelligence_Loop)&y1>=0/y1<=155:Py1;
!!CAv998/v999/v1000:B3/21;              [Special Building Built]
!!VRy20:Si^timerWeek^;                  [Put Current Week in Y20]
!!SN&1:W^Mana_Vortex_Hero%Y1_Week_%Y20^/1;


!?OB49&1000;                            [Visit Magic Well]
!!FU:E;

!!UN:P787/?y1;                          [Check if New Mana Regeneration System option is active]
!!FU&y1=1:E;                            [Exit if it is enabled]
!!HE-1:N?y1;
!!FU(Intelligence_Set_Spell_Points)&y1>=0/y1<=155:Py1/0;


!$OB48&1000;                            [Visit Magic Spring]
!!FU:E;

!!HE-1:N?y1;
!!VRy2:Si^timerWeek^;
!!SN:W^Magic_Spring_Hero%Y1_Week_%Y2^/?y3; [So it only works once per Week]
!!FU(Intelligence_Set_Spell_Points)&y1>=0/y1<=155/y3=0:Py1/1; [If x2=1 Means Double Spell Points Once a Week]
!!SN&y3=0:W^Magic_Spring_Hero%Y1_Week_%Y2^/1;


*Show amount of regenerated spell points when clicking SP icon in Hero screen
!?FU(OnHeroScreenMouseClick);           [click in hero window]

!!CM:I?y1 S?y2 F?y8;                    [y1/y2 - place/flags/type of click]
!!FU&y1<>109/y1<>113/y1<>120:E;         [exit if click is not on mana]

!!CM:H?y3/?y4;                          [y3/y4 - left/right heroes]
!!FU(AC_Function_8):Py3/?y6/1/1;        [loop thru heroes]
!!HEy3:B0/?z1 I?y7/1;                   [z1/y7 - hero name/mana]
!!SN:T^AC_Misc.Spell_Points_hero_screen^/?z2/^hero^/z1/^regenSp^/y6;

!!IF&y2=(MOUSE_LMB_PRESSED)/y8=0:M^%Z2^;                 [output LKM message (released, no modifiers)]
!!IF&y2=(MOUSE_RMB_PRESSED):M0/4/^%Z2^;                  [output PKM message]
!!CM:R0;                                [disable standard click action]


*Show amount of regenerated spell points when clicking SP icon in two Hero meeting screen
!?FU(OnHeroesMeetScreenMouseClick)|i^mouse_item^=113/i^mouse_item^=83/i^mouse_item^=114/i^mouse_item^=84;

!!CM:R0;                                [disable standard click action]
!!CM:H?y1/?y2;

!!if|i^mouse_item^=113/i^mouse_item^=83;
  !!VRy3:Sy1;
!!el|i^mouse_item^=114/i^mouse_item^=84;
  !!VRy3:Sy2;
!!en;

!!FU(AC_Function_8):Py3/?y6/1/1;        [loop thru heroes]
!!HEy3:B0/?z1 I?y7/1;                   [z1/y7 - hero name/mana]
!!SN:T^AC_Misc.Spell_Points_hero_screen^/?z2/^hero^/z1/^regenSp^/y6;

!!if&i^mouse_action^=(MOUSE_LMB_PRESSED);
  !!IF:M^%Z2^;                          [output LKM message (released, no modifiers)]
!!el&i^mouse_action^=(MOUSE_RMB_PRESSED);
  !!IF:M0/(MSG_TYPE_POPUP)^%Z2^;        [output PCM message]
!!en;


**************************Nobility**********************************************
**Once a Week if a Hero with Nobility visits a Castle additional Creatures can he hired
!?FU(OnEveryDay)&i^timerOnce^=1/i^timerDay^>0/i^timerWeekDay^=1/i^timerIsAi^=0;

!!DO(AC_Function_18)/0/155/1:P;


!?HM-1;
!!HE-1:N?y1;
!!SN:W^H3_Nobility_Hero%Y1_Active^/?y2;
!!SN&y2=2:W^H3_Nobility_Hero%Y1_Active^/1;

!?FU(AC_Function_18);
!!HEx16:O?y1;                           [Checke Hero Owner]
!!FU&y1=-1:E;                           [Exit if none]
!!SN:W^H3_Nobility_Hero%X16_Active^/1;  [Set Nobility flag active for that hero]

!?CM1&1000/i^mouse_action^=(MOUSE_LMB_PRESSED)/i^mouse_item^<=147; [Town Screen Trigger. 147 - background of the town]
!!CA-1:H1/?y5;                          [town Visitor]
!!FU(Hero_Nobility_Loop)&y5>=0/y5<=155:Py5; [Jump to Nobility Function]
!!CA-1:H0/?y5;                          [town garrison]
!!FU(Hero_Nobility_Loop)&y5>=0/y5<=155:Py5; [Jump to Nobility Function]

!?FU(Hero_Nobility_Loop);

!!SN:W^H3_Nobility_Hero%X1_Active^/?y1;
!!FU&y1=0:E;                            [Exit so it only happens once per week]

!!HEx1:S5/?y10;                         [Check for Nobility]
!!FU&y10=0:E;                           [Exit if no Nobility]

!!if&y1=2/x2=0;
  !!CM:I?y2 F?y3;
  !!if&y3=512;
    !!VRy1|y2=7/y2=8/y2=9:S1;           [Fort Citadel Castle]
    !!SN&y1=1:W^H3_Nobility_Hero%X1_Active^/1;
    !!FU&y1=2:E;
  !!en;
!!en;

!!FU&y1<>1:E;

!!SN:W^H3_Nobility_0_Hero%X1^/?y11;     [Checke ob der Held Master Nobility hat und Speichere in y11]
!!SN:W^H3_Nobility_1_Hero%X1^/?y12;     [Checke ob der Held Grandmaster Nobility hat und Speichere in y12]

*Level 1*                      *Level 2*                      *Level 3*                      *Level 4*                     *Level 5*                     *Level 6*                     *Level 7*
!!VRy21&y10=1:S6;              !!VRy22&y10=1:S4;              !!VRy23&y10=1:S3;              !!VRy24&y10=1:S2;             !!VRy25&y10=1:S1;             !!VRy26&y10=1:S0;             !!VRy27&y10=1:S0; [Basic]
!!VRy21&y10=2:S9;              !!VRy22&y10=2:S5;              !!VRy23&y10=2:S4;              !!VRy24&y10=2:S3;             !!VRy25&y10=2:S2;             !!VRy26&y10=2:S1;             !!VRy27&y10=2:S0; [Advanced]
!!VRy21&y10=3/y11=0/y12=0:S14; !!VRy22&y10=3/y11=0/y12=0:S6;  !!VRy23&y10=3/y11=0/y12=0:S5;  !!VRy24&y10=3/y11=0/y12=0:S4; !!VRy25&y10=3/y11=0/y12=0:S3; !!VRy26&y10=3/y11=0/y12=0:S2; !!VRy27&y10=3/y11=0/y12=0:S1; [Expert]
!!VRy21&y10=3/y11=1/y12=0:S20; !!VRy22&y10=3/y11=1/y12=0:S10; !!VRy23&y10=3/y11=1/y12=0:S6;  !!VRy24&y10=3/y11=1/y12=0:S5; !!VRy25&y10=3/y11=1/y12=0:S4; !!VRy26&y10=3/y11=1/y12=0:S3; !!VRy27&y10=3/y11=1/y12=0:S1; [Master]
!!VRy21&y10=3/y11=1/y12=1:S25; !!VRy22&y10=3/y11=1/y12=1:S15; !!VRy23&y10=3/y11=1/y12=1:S10; !!VRy24&y10=3/y11=1/y12=1:S8; !!VRy25&y10=3/y11=1/y12=1:S6; !!VRy26&y10=3/y11=1/y12=1:S4; !!VRy27&y10=3/y11=1/y12=1:S2; [Grandmaster]
**Y21 bis Y27  is level 1 til 7

!!HEx1:X?y40/?y41/?y42/?y43/?y44/?y45/?y46; [Check Hero Speciality]
!!if&y40=0/y41=5;                       [If Nobility Specialist]
!!HEx1:E?y47/?y48/1;                    [Check hero Level]
!!VRy48:*3 +100;                        [3% extra Growth per Hero Level]
!!VRy21:*y48:100; !!VRy22:*y48:100; !!VRy23:*y48:100; !!VRy24:*y48:100; !!VRy25:*y48:100; !!VRy26:*y48:100; !!VRy27:*y48:100;
!!en;

!!HEx1:A2/66/?y49/?y66;
!!HEx1:A2/67/?y49/?y67;
!!HEx1:A2/68/?y49/?y68;
!!VRy33&y66=1/y67=1/y68=1:S1;           [Double Bonus if complete Set]

!!if&y68=1;                             [If Ambassador's Sash equipped]
!!VRy21:+6; !!VRy22:+5; !!VRy23:+4; !!VRy24:+3; !!VRy25:+2; !!VRy26:+1; !!VRy27:+0;
!!if&y33=1;                             [If complete Set]
!!VRy21:+6; !!VRy22:+5; !!VRy23:+4; !!VRy24:+3; !!VRy25:+2; !!VRy26:+1; !!VRy27:+1;
!!en;
!!en;

!!VRy1:S1;
[:loopTownDwellings]
!!VRy2:S20 +y1;                         [Set town dwelling vars]
!!VRy3:S30 +y1;                         [y31-y37 will contain info about whether corresponding town dwelling is built, upgraded or not]
!!VRy4:S37 -1 +y1;
!!VRy5:S30 -1 +y1;
!!VRyy3:S-1;
!!CA-1:B3/y4;
!!VRyy3&1:S1;
!!CA-1&-1:B3/y5;
!!VRyy3&1/yy3<>1:S0;                    [0 for unupgraded, 1 for upgraded, -1 means dwelling not built]
!!VRyy2&yy3=-1:S0;                      [no dwelling - no creatures]

!!VRy4:S40 +y1;                         [prepare vars for showing monsters]
!!VRy5:S50 +y1;
!!VRyy4:S-1;
!!VRyy5:S-1;

!!VRy1:+1;
!!SN&y1<8:G[loopTownDwellings];

!!VRy1:S0;                              [loop iteration]
!!VRy6:S0;                              [number of non-zero monster]
!!CA-1:T?y7;                            [get type of current town]
[:showMonstersAmount]
!!VRy2:S21 +y1;
!!VRy3:S31 +y1;
!!VRy4:S41 +y6;                         [y41-y47 will contain amount and type of monsters to display]
!!VRy5:S51 +y6;                         [y51-y57 will contain either 21 or -1. 21 is monster picture message type for IF:N]
!!UN&yy2<>0:Ty7/y1/yy3/?y8;             [get monster type of #y1 dwelling]
!!VRyy4&yy2<>0:S65536 *yy2 +y8;
!!VRyy5&yy2<>0:S21;

!!VRy6&yy2<>0:+1;
!!VRy1:+1;
!!SN&y1<7:G[showMonstersAmount];
!!VRy1:Sy6;                             [we will save number of non-zero monster, as we need it later for nobility fail message]
!!HEx1:B0/?z-1;

!!CA(CURRENT_TOWN):U?(townId:y);

!!if&i^tum_8thDwell_%(townId)^;
  !#VA(usedY[70]:y);                    [Don't place this at the start of the function, it would corrupt IF:N dlg monster numbers for some reason]

  !!if|i^tum_reborn_on^/i^tum_full_on^;
    !!FU(eighth_SetOrGet8thMonByTownId):P(townId)/?(mon:y)/?(qty:y);
  !!el;
    !!FU(eighth_SetOrGet8thMon):P(townId)/?(mon:y)/?(qty:y)/(TRUE); [Legacy]
  !!en;

  !!MA:L(mon)/?(level:y);

  !!VR(index:y):S(level) +21;
  !!VR(picSubtype:y):S65536 *y(index) +(mon);

  !!VRy6&y(index):+1;
!!en;

; Display msg if nothing to increase (no dwelling built)
; Disabled by Archer30 as it seems to be annoying
*!SN&y6=0:T^AC_Misc.Nobility Town Fail^/?z2 Iz2/?z2;
*!IF&y6=0/999:Mz2;

!!SN&y6=0:W^H3_Nobility_Hero%X1_Active^/2;
!!FU&y6=0:E;                            [exit if no creatures to add]

!!if&y6>0;
  !!SN:T^AC_Misc.Nobility Town^/?z2 Iz2/?z2;

  !!if&999;
    ; Compatibility with 8th mon (from TUM)
    !!if&i^tum_8thDwell_%(townId)^;
      !!IF:Ny51/y41/y52/y42/y53/y43/y54/y44/y55/y45/y56/y46/y57/y47/(PIC_TYPE_MONSTER)/(picSubtype);
    !!el;
      !!IF:Ny51/y41/y52/y42/y53/y43/y54/y44/y55/y45/y56/y46/y57/y47;
    !!en;

    !!IF:N2/z2/?y2;
  !!en;
!!en;

!!if&y2=0;
  !!SN:W^H3_Nobility_Hero%X1_Active^/2;
  !!FU:E;                            [Exit if press no]
!!en;

!!SN:W^H3_Nobility_Hero%X1_Active^/0;

!!re i/(ARMY_SLOT_FIRST)/(ARMY_SLOT_LAST);
  !!VR(numInd:y):S21 +i;
  !!VR(isUpgInd:y):S31 +i;

  !!CA(CURRENT_TOWN)&y(isUpgInd)=1:M1/i/d/dy(numInd); [Upg dwelling]
  !!CA(CURRENT_TOWN)&y(isUpgInd)=0:M1/i/dy(numInd)/d; [Non-upg dwelling]
!!en;

; Compatibility with 8th mon (from TUM)
!!if&i^tum_8thDwell_%(townId)^;
  !!if|i^tum_reborn_on^/i^tum_full_on^;
    !!FU(eighth_SetOrGet8thMonByTownId):P(townId)/(mon)/dy(index);
  !!el;
    !!VR(qty):+y(index);
    !!FU(eighth_SetOrGet8thMon):P(townId)/(mon)/(qty)/(FALSE); [Legacy]
  !!en;
!!en;

!!SN:D;                                 [Added SN:D command. It's used to redraw hero, heroes meeting, adventure map and town screens.]

*Make AI use of Nobility. Procs everytime per one week if AI walks in town
!?HM-1&-1000;
!!HE-1:N?y1;

!!SN:W^H3_Nobility_Hero%Y1_Active^/?y2; [Check flag]
!!FU&y2=0:E;                            [Exit so it only happens once per week]

!!HEy1:S5/?y10;                         [Check for Nobility]
!!FU&y10=0:E;                           [Exit if no Nobility]
!!SN:W^H3_Nobility_0_Hero%Y1^/?y11;     [Checke ob der Held Master Nobility hat und Speichere in y11]
!!SN:W^H3_Nobility_1_Hero%Y1^/?y12;     [Checke ob der Held Grandmaster Nobility hat und Speichere in y12]
!!HEy1:P?y5/?y6/?y7;                    [Get where hero sits]
!!OBy5/y6/y7:T?y8;                      [Get type of Object]
!!FU&y8<>98:E;                          [Exit if the destination is not a town]

*Level 1*                      *Level 2*                      *Level 3*                      *Level 4*                     *Level 5*                     *Level 6*                     *Level 7*
!!VRy21&y10=1:S6;              !!VRy22&y10=1:S4;              !!VRy23&y10=1:S3;              !!VRy24&y10=1:S2;             !!VRy25&y10=1:S1;             !!VRy26&y10=1:S0;             !!VRy27&y10=1:S0; [Basic]
!!VRy21&y10=2:S9;              !!VRy22&y10=2:S5;              !!VRy23&y10=2:S4;              !!VRy24&y10=2:S3;             !!VRy25&y10=2:S2;             !!VRy26&y10=2:S1;             !!VRy27&y10=2:S0; [Advanced]
!!VRy21&y10=3/y11=0/y12=0:S14; !!VRy22&y10=3/y11=0/y12=0:S6;  !!VRy23&y10=3/y11=0/y12=0:S5;  !!VRy24&y10=3/y11=0/y12=0:S4; !!VRy25&y10=3/y11=0/y12=0:S3; !!VRy26&y10=3/y11=0/y12=0:S2; !!VRy27&y10=3/y11=0/y12=0:S1; [Expert]
!!VRy21&y10=3/y11=1/y12=0:S20; !!VRy22&y10=3/y11=1/y12=0:S10; !!VRy23&y10=3/y11=1/y12=0:S6;  !!VRy24&y10=3/y11=1/y12=0:S5; !!VRy25&y10=3/y11=1/y12=0:S4; !!VRy26&y10=3/y11=1/y12=0:S3; !!VRy27&y10=3/y11=1/y12=0:S1; [Master]
!!VRy21&y10=3/y11=1/y12=1:S25; !!VRy22&y10=3/y11=1/y12=1:S15; !!VRy23&y10=3/y11=1/y12=1:S10; !!VRy24&y10=3/y11=1/y12=1:S8; !!VRy25&y10=3/y11=1/y12=1:S6; !!VRy26&y10=3/y11=1/y12=1:S4; !!VRy27&y10=3/y11=1/y12=1:S2; [Grandmaster]

!!CAy5/y6/y7:O?y3;                      [Check Town owner]
!!OW&y3>=0:Iy3/?y4;                     [Check if AI (1)]
!!if&y3>=0/y4=1;                        [If town has a owner and is from AI 1]
!!SN:W^H3_Nobility_Hero%Y1_Active^/0;   [Set flag to zero so it doesnt happen more than once per week]

  !!CAy5/y6/y7:B3/37;                   [Check for Level 1 building]
  !!CAy5/y6/y7&1:M1/0/d0/dy21;
  !!CAy5/y6/y7&-1:B3/30;                [dwelling 1]
  !!CAy5/y6/y7&1:M1/0/dy21/d0;

  !!CAy5/y6/y7:B3/38;                   [Check for Level 2 building]
  !!CAy5/y6/y7&1:M1/1/d0/dy22;
  !!CAy5/y6/y7&-1:B3/31;                [dwelling 2]
  !!CAy5/y6/y7&1:M1/1/dy22/d0;

  !!CAy5/y6/y7:B3/39;                   [Check for Level 3 building]
  !!CAy5/y6/y7&1:M1/2/d0/dy23;
  !!CAy5/y6/y7&-1:B3/32;                [dwelling 3]
  !!CAy5/y6/y7&1:M1/2/dy23/d0;

  !!CAy5/y6/y7:B3/40;                   [Check for Level 4 building]
  !!CAy5/y6/y7&1:M1/3/d0/dy24;
  !!CAy5/y6/y7&-1:B3/33;                [dwelling 4]
  !!CAy5/y6/y7&1:M1/3/dy24/d0;

  !!CAy5/y6/y7:B3/41;                   [Check for Level 5 building]
  !!CAy5/y6/y7&1:M1/4/d0/dy25;
  !!CAy5/y6/y7&-1:B3/34;                [dwelling 5]
  !!CAy5/y6/y7&1:M1/4/dy25/d0;

  !!CAy5/y6/y7:B3/42;                   [Check for Level 6 building]
  !!CAy5/y6/y7&1:M1/5/d0/dy26;
  !!CAy5/y6/y7&-1:B3/35;                [dwelling 6]
  !!CAy5/y6/y7&1:M1/5/dy26/d0;

  !!CAy5/y6/y7:B3/43;                   [Check for Level 7 building]
  !!CAy5/y6/y7&1:M1/6/d0/dy27;
  !!CAy5/y6/y7&-1:B3/36;                [dwelling 7]
  !!CAy5/y6/y7&1:M1/6/dy27/d0;
!!en;


****************************************************************************************************
Treasure Chest Enhancement with Advanced Nobility skill
!?OB101;                                [Object Trigger for Treasure chests]

!!SN:W^Advanced_Classes_Mod_Active^/?y1;
!!FU&y1<>1:E;                           [Exit if Sorcery script isn't enabled]
!!HE-1:N?y10;
!!HE-1:S5/?v5;
!!OB998:U?v2;                           [v2=0 for standard chest, v2>0 for new chest types, v2>6 for Power Stones]
!!FU&v2>6:E;                            [Exit if it's a Power Stone]
!!VRv3:S0;
!!UN&v2>0:Bv2/?v3;                      [v3=0 if standard operation, v3=1 if advanced (scripted)]
!!CH998&v2>0/v3=0/-875:S?v4;            [Check if chest has an artifact or not]
!!CH998&v2=0/-875:S?v4;

!!FU25539&v5>0/v3=0/v4=0/-875:Pv5/y10;  [Pass Nobility Skill Level and Hero Number]


!?FU25539;                              [Start of Function 5026 - Treasure Chest Enhancement with Advanced Nobility skill]

!!CHv998/v999/v1000:B?y1;               [Get value of treasure chest (y1)]
!!OB998&1000:M-1/1/0;                   [Disable chest object message for human player]

!!HEx2:A2/66/?y49/?y66;
!!HEx2:A2/67/?y49/?y67;
!!HEx2:A2/68/?y49/?y68;
!!VRy33&y66=1/y67=1/y68=1:S1;           [Double Bonus if complete Set]

!!SN:W^H3_Nobility_1_Hero%X2^/?y10;     [If Hero has Grandmaster Nobility increase value further]

 [Increase value of chest by 1 for Advanced Nobility, by 2 for Expert Nobility]
!!VRy1&y67=1:+1;                        [Increase Value with Diplomats Ring]
!!VRy1&y33=1:+1;                        [Increase Value with complete Set]
!!VRy1&y10=1:+1;                        [Increase Value with Grandmaster Nobility]

!!VRy1&x1=1:+1;
!!VRy1&x1=2:+1;
!!VRy1&x1=3:+2;

!!VRy4&y67=1:+1;                        [Increase Value with Diplomats Ring]
!!VRy4&x1=1:S500;
!!VRy4&x1=2:S500;
!!VRy4&x1=3:S1000;
!!VRy4&y10=1:S1500;

!!VRy1&y1>15:S15;  [If value of y1 is greater than 15, set it to 15]
!!CHv998/v999/v1000:By1;  [Set new value of chest]
!!IF:W-1;
!!VRy1&w64=3:*2;  [If hero has Adventure Cave "Treasure" skill (w64=3), double y1]
!!VRy1&y1>15:S15;  [If value of y1 is greater than 15, set it to 15]
!!VRy2:Sy1 *500;  [Set y2 to 500 x y1 for gold display purposes]
!!VRy3:Sy2 -500;  [Set y3 to y2 - 500 for experience display purposes]
!!VRz1&x1=2:Sz198781;  [Set z1 to "Advanced" or "Expert" depending on skill level]
!!VRz1&x1=3:Sz198782;
!!IF&1000:Q2/6/y2/17/y3/7/z198783;  [Display chest message with choice of gold or experience]


********************************************************************************

                       CLASS BONUS HANDLING

Master Warrior         : 15% max Damage
Grandmaster Warrior    : Half Damage for Retaliation, Critical Strike I

Master Mage            : 1 extra cast, Spell Resistance
Grandmaster Mage       : 1 extra cast per battle round, Spell Resistance, Arcane Prophet, Magic Pierce

Master Adventurer      : Plunder Bonus movement after every fight or pick up
Grandmaster Adventurer : +3% creature growth per Week

Battlemage             : Pre-Cast, cast amplified spell at battle start, Warcry Spell reduced HP of enemies, 15% max Damage, 1 extra Cast

Hunter                 : First Shot Ability, Magic Block, Bonus Movement after every fight, 10% max Damage Bonus

Druid                  : Heals two squads after combat, Flat Damage Block, 1 extra Cast, Bonus Movement after every fight, Transfer Spells to next combat

***************************Master Warrior***************************************
*Increase Damage by 15% in Combat* for Master and +20% for Grandmaster

!?BF;                                   [Combat Start]

!!BA:H0/?y1;                            [Attacker]
!!SN:W^Master_Warrior_Hero%Y1^/?y4;
!!SN:W^Grandmaster_Warrior_Hero%Y1^/?y7;
!!SN:W^Master_Mage_Hero%Y1^/?y5;        [Battlemages cannot get this bonus]
!!SN:W^Master_Adventurer_Hero%Y1^/?y6;
!!FU(Count_Set_Pieces_2):Py1/0/0/0/?y90;[Count Warrior Set Pieces function X5]          [Count Set Pieces function]
!!VRy10:S100;                           [Normal Damage]
!!VRy10&y4=1:S115;                      [+15% damage increase for Master Warrior]
!!VRy10&y7=1:S120;                      [+20% damage increase for Grandmaster Warrior]
!!VRy10&y6=1/y4=1:S110;                 [10% damage increase for Hunter]
!!VRy10&y5=1/y4=1:S110;                 [10% damage increase for Battlemages]
!!VRy10&y90>=2:+5;                      [+5% damage increase for Warrior Set]
!!DO(AC_Function_19)/0/20/1&y10>100:Py10;

!!BA:H1/?y2;                            [Defender]
!!FU&y2<0:E;                            [Exit if no Hero]
!!SN:W^Master_Warrior_Hero%Y2^/?y4;
!!SN:W^Grandmaster_Warrior_Hero%Y2^/?y7;
!!SN:W^Master_Mage_Hero%Y2^/?y5;        [Battlemages cannot get this bonus]
!!SN:W^Master_Adventurer_Hero%Y2^/?y6;
!!FU(Count_Set_Pieces_2):Py2/0/0/0/?y90;[Count Warrior Set Pieces function X5]          [Count Set Pieces function]
!!VRy10:S100;                           [Normal Damage]
!!VRy10&y4=1:S115;                      [+15% damage increase for Master Warrior]
!!VRy10&y7=1:S120;                      [+20% damage increase for Grandmaster Warrior]
!!VRy10&y6=1/y4=1:S110;                 [10% damage increase for Hunter]
!!VRy10&y5=1/y4=1:S110;                 [10% damage increase for Battlemages]
!!VRy10&y90>=2:+5;                      [+5% damage increase for Warrior Set]
!!DO(AC_Function_19)/21/41/1&y10>100:Py10;

!?FU(AC_Function_19);                   [increase Units Stats]

!!BMx16:U2/?y1;                         [Get Max Damage]
!!FU&y1<=0:E;                           [Exit if no Damage]
!!VRy2:Sy1*x1:100;                      [Increase Damage by 10% or at least +1]
!!VRy2&y1=y2:+1;
!!BMx16:U2/y2;                          [Set Max Damage]

************************Grandmaster Warriors************************************
*Retaliations do only 50% damage* *20% chance for more damage with Critical Strike*

!?MF1;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4456676;           [Only run when melee or strikes all round]

!!MF:W?y80;
!!FU&y80>0:E;
!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>6:E;                           [Exit if not melee attack]
!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!if&y4=y1;
  !!BMy1:I?y5;                          [Side index as for heroes (0:left, 1:right)]
  !!BA:Hy5/?y99;                        [get hero number]
  !!SN:W^Grandmaster_Warrior_Hero%Y99^/?y2;
  !!FU&y2=0:E;
  !!MF:F?y6;                            [damage dealt]
  !!VRy10:Sy6:2;                        [Only Half damage]
  !!MF:Fy10;                            [set new damage]
  !!VRz-1:S^CRUSDFND.wav^;              [find block sound]
  !!SN&i^battle_isVisible^:Pz-1;        [play block sound]
  !!SN:T^AC_Misc.Damage Avoid^/?z-1/^damage1^/y10;
  !!BU&i^battle_isVisible^:Mz-1;
!!en;
!!en;


**************************************Critical Hit**************************************************
!?MF1;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676;[Only run when melee or shooting damage]

!!MF:W?y80;
!!FU&y80>0:E;

!!BG:A?y1;                              [Aktion in y1]
!!if&y1=6;                              [If melee attack]
  !!BG:N?y1;                            [Attacking Stack]
  !!MF:N?y4;                            [damage receiving stack]

  !!SN:W^Warrior_Crit_Attacking_Stack^/?y50;
  !!VRy1&y4=y1/y50>=0/y50<=41:Sy50;     [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
  !!SN:W^Warrior_Crit_Attacking_Stack^/y4;

  !!BMy1:I?y5;                          [Side index as for heroes (0:left, 1:right)]
  !!BA:Hy5/?y99;
  !!FU&y99<0:E;                         [Exit if no Hero]
  !!FU(ACM_Calc_Physical_Crit):Py99/?y20/?y30; [Pass Hero and return crit damage and crit chance]

  !!VRy80:S0R100;                       [Generate Random value]

  !!if&y20>y80;                         [decide chance for critical hit]
    !!MF:F?y6;                          [damage dealt]
    !!VRy10:Sy6*y30:100;                [If crit deal Bonus Damage]

    !!if&y10>y6;                        [If the crit damamg is greater than the original (overflow check)]
      !!MF:Fy10;                        [Apply new damage]

      !!if&i^battle_isVisible^;
        !!VRy11:Sy10-y6;                [Total Bonus Damage]
        !!SN:P^slayer^;                 [play slayer sound]
        !!SN:T^AC_Misc.Critical Hit^/?z-1/^damage2^/y11;
        !!BU:Mz-1;
      !!en;
    !!en;
  !!en;
!!en;
!!en;


!?FU(ACM_Calc_Physical_Crit);
x1=Hero level, x2 returns crit chance, x3 returns crit damage

!!VRy20:S0;                             [Crit Chance initialize to zero]
!!VRy30:S120;                           [Crit Damage initialize to 120, meaning 20% more damage for crits]

!!SN:W^Master_Warrior_Hero%X1^/?y2;
!!SN:W^Grandmaster_Warrior_Hero%X1^/?y3;
!!SN:W^Master_Mage_Hero%X1^/?y4;
!!SN:W^Master_Adventurer_Hero%X1^/?y5;

!!VRy20&y2=1:+10;                       [+10% Crit chance with Master Warrior]
!!VRy20&y3=1:+10;                       [+10% Crit chance with Grandmaster Warrior]

*!VRy20&y4=1/y2=1:-10;                  [No additional crit chance for Battlemage classes]
*!VRy20&y5=1/y2=1:-10;                  [No additional crit chance for Hunter classes]

!!FU(Count_Set_Pieces_2):Px1/0/0/0/?y90;[Count Set Pieces function X5]   [Count Set Pieces function]
!!if&y90=3;
  !!SN:W^Warrior_Set_Count_Hero%X1^/?y40;[+1%  if Battle won with Set equipped and value smaller Hero Level]
  !!VRy40::3;                           [plus value/3 to add crit chance and damage if warrior set complete]
  !!VRy20:+y40;
  !!VRy30:+y40;
!!en;                

!!HEx1:A2/7/?y35/?y81;
!!VRy20&y81=1:+5;                       [Wenn der 7 Centaur Axe getragen wird plus +5% Crit Chance]
!!HEx1:A2/48/?y35/?y81;
!!VRy20&y81=1:+3;                       [Wenn der Ladybird of Luck getragen wird plus +3% Crit Chance]
!!HEx1:A2/46/?y35/?y81;
!!VRy20&y81=1:+3;                       [Wenn der 46 Clover of Fortune getragen wird plus +3% Crit Chance]
!!FU(Count_Set_Pieces):Px1/0/0/0/0/?y81;[Check for The Adventures Fidelity]
!!VRy20&y81>=3:+5;                      [Wenn der The Adventures Fidelity getragen wird plus +5% physical Crit Chance]

!!SN:W^ACM_Reward_Physical_Crit_Chance_%X1^/?y2;
!!VRy20:+y2;                            [Add ACM Bonus Rewards]
!!SN:W^ACM_Reward_Physical_Crit_Damage_%X1^/?y2;   
!!VRy30:+y2;                            [Add ACM Bonus Rewards]

!!VRx2:Sy20;                            [Return Crit chance]
!!VRx3:Sy30;                            [Return Crit damage]


***********************************
*Grandmaster Warriors Buff Commander and Henchmens by +20%

!?FU(OnAfterTacticsPhase); [On First visible combat round]

!!BA:H0/?y1;
!!SN:W^Grandmaster_Warrior_Hero%Y1^/?y2;[Attacker]

!!if&y2=1;
  !!re i/0/10;
  !!BMi:T?y3 P?y4;                      [Get Creature Type and Position]
    !!if&y3>=174/y3<=182|y4=20;         [If Commander or Henchmen found for Attacker]
    !!VRy10:S120;                       [Coefficient for parameter increase  20%]
    !!BMi:A?y5; !!VRy5:*y10:100; !!BMi:Ay5; [Set Attack]
    !!BMi:D?y5; !!VRy5:*y10:100; !!BMi:Dy5; [Set Defense]
    !!BMi:H?y5; !!VRy5:*y10:100; !!BMi:Hy5; [Set Health]
    !!BMi:U1/?y5 U2/?y6; !!VRy5:*y10:100; !!VRy6:*y10:100; !!BMi:U1/y5 U2/y6; [Set Min+Max Damage]
    !!BMi:S?y5; !!VRy5:*y10:100; !!BMi:Sy5; [add Speed]
    !!en;
  !!en;
!!en;


!!BA:H1/?y1; !!FU&y1<0:E;               [Exit if no Defending Hero]
!!SN:W^Grandmaster_Warrior_Hero%Y1^/?y2;[Defender]

!!if&y2=1;
  !!re i/21/31;
  !!BMi:T?y3 P?y4;                      [Get Creature Type and Position]
    !!if&y3>=183/y3<=191|y4=30;         [If Commander or Henchmen found for Defender]
    !!VRy10:S120;                       [Coefficient for parameter increase 20%]
    !!BMi:A?y5; !!VRy5:*y10:100; !!BMi:Ay5; [Set Attack]
    !!BMi:D?y5; !!VRy5:*y10:100; !!BMi:Dy5; [Set Defense]
    !!BMi:H?y5; !!VRy5:*y10:100; !!BMi:Hy5; [Set Health]
    !!BMi:U1/?y5 U2/?y6; !!VRy5:*y10:100; !!VRy6:*y10:100; !!BMi:U1/y5 U2/y6; [Set Min+Max Damage]
    !!BMi:S?y5; !!VRy5:*y10:100; !!BMi:Sy5; [add Speed]
    !!en;
  !!en;
!!en;


***************************Master Mage******************************************
*1 extra cast per combat*

!?BG1;                                  [1 extra cast per combat for Master Mages]

!!BG:Q?y1;                              [Fix for Double Cast]
!!BH0:N?y88;                            [Attacking Hero]
!!BH1:N?y89;                            [Defending Hero]

!!SN&y1=0:W^Master_Mage_Hero%Y88^/?y4;
!!SN&y1=0:W^Grandmaster_Mage_Hero%Y88^/?y5;

!!SN&y1=1:W^Master_Mage_Hero%Y89^/?y4;
!!SN&y1=1:W^Grandmaster_Mage_Hero%Y89^/?y5;


!!if&y4=1/y5=0;                        [Only Runs when Master Mage and not Grandmaster]
!!SN&y1=0:W^Master_Mage_Extra_Cast_att^/?y2;
!!SN&y1=1:W^Master_Mage_Extra_Cast_def^/?y2;
!!FU&y2=0:E;
!!BHy1:M?y3;
!!FU&y3=0:E;
!!BHy1:M0;

!!SN&y1=0:W^Magic_Specialists_%V997_Cast_Count_Att^/d1;
!!SN&y1=1:W^Magic_Specialists_%V997_Cast_Count_Def^/d1;

!!BA:Q?f;
!!VRz-1&1000:S^FORTUNE^;
!!SN&i^battle_isVisible^:Pz-1;
!!SN&1000:T^AC_Misc.Master Mage Extra Cast^/?z-1;
!!BU&i^battle_isVisible^:Mz-1;
!!SN&y1=0:W^Master_Mage_Extra_Cast_att^/0;
!!SN&y1=1:W^Master_Mage_Extra_Cast_def^/0;
!!en;


************************Grandmaster Mages***************************************
*1 extra cast per battle round*

!?BR;

!!BA:H0/?y20;                           [check attacker]
!!if&y20>=0;
!!SN:W^Grandmaster_Mage_Hero%Y20^/?y10;
!!SN&y10=1:W^Double_Cast_Attacker^/1;
!!en;

!!BA:H1/?y21;                           [check defender]
!!if&y21>=0;
!!SN:W^Grandmaster_Mage_Hero%Y21^/?y11;
!!SN&y11=1:W^Double_Cast_Defender^/1;
!!en;


!?BG1;                                  [1 extra cast per battle round]

!!BG:S?y11;                             [y11 now contains spell number]
!!FU|y11<10/y11>69:E;

!!BG:Q?y1;                              [Current attacking side]
!!BH0:N?y88;                            [Attacking Hero]
!!BH1:N?y89;                            [Defending Hero]

!!SN&y88>=0/y1=0:W^Double_Cast_Attacker^/?y4;
!!SN&y89>=0/y1=1:W^Double_Cast_Defender^/?y4;
!!FU&y4=0:E;

!!BHy1:M?y3;
!!FU&y3=0:E;
!!BHy1:M0;                              [Renable Spellbook]

!!SN&y1=0:W^Magic_Specialists_%V997_Cast_Count_Att^/d1;
!!SN&y1=1:W^Magic_Specialists_%V997_Cast_Count_Def^/d1;

!!SN:T^AC_Misc.Grandmaster Mage Extra Cast^/?z-1;
!!BA:Q?f;
!!BU&i^battle_isVisible^:Mz-1;
!!VRz1&i^battle_isVisible^/1000:S^FORTUNE^;
!!SN&i^battle_isVisible^/1000:Pz1;
!!SN&y88>=0/y1=0:W^Double_Cast_Attacker^/0;
!!SN&y89>=0/y1=1:W^Double_Cast_Defender^/0;


!?FU(OnAfterBattleUniversal);           [Reset after Combat]
!!SN:W^Double_Cast_Attacker^/0;
!!SN:W^Double_Cast_Defender^/0;
!!SN:W^Master_Mage_Extra_Cast_att^/0;
!!SN:W^Master_Mage_Extra_Cast_def^/0;


********************************************************************************
Arcane Prophet Grandmaster Mage ability
Randomly before battle a spell is choosen that will deal significantly more damage during the combat

!?FU(OnBeforeBattleUniversal);

!!BA:H0/?y1;                            [get attacking hero #]
!!SN:W^Grandmaster_Mage_Hero%Y1^/?y11;
!!FU(Mage_Skill_Fkt_1)&y11=1:Py1/1;     [wenn mysticism beim angreifer vorhanden dann reiche x1=10 an function (Mystik_Skill_Fkt_0) weiter]

!!BA:H1/?y2;                            [get defending hero #]
!!FU&y2=-2:E;                           [Exit if no defending Hero]
!!SN:W^Grandmaster_Mage_Hero%Y2^/?y11;
!!FU(Mage_Skill_Fkt_1)&y11=1:Py2/1;     [wenn mysticism beim angreifer vorhanden dann reiche x1=10 an function (Mystik_Skill_Fkt_0) weiter]


!?FU(OnBattlefieldVisible); 

!!BA:H0/?y1;                            [get attacking hero #]
!!SN:W^Grandmaster_Mage_Hero%Y1^/?y11;
!!FU(Mage_Skill_Fkt_1)&y11=1:Py1/2;     [wenn mysticism beim angreifer vorhanden dann reiche x1=10 an function (Mystik_Skill_Fkt_0) weiter]

!!BA:H1/?y2;                            [get defending hero #]
!!FU&y2=-2:E;                           [Exit if no defending Hero]
!!SN:W^Grandmaster_Mage_Hero%Y2^/?y11;
!!FU(Mage_Skill_Fkt_1)&y11=1:Py2/2;     [wenn mysticism beim angreifer vorhanden dann reiche x1=10 an function (Mystik_Skill_Fkt_0) weiter]


!?FU(Mage_Skill_Fkt_1);
!!HEx1:A2/73/?y2/?y3 A2/74/?y4/?y5 A2/75/?y6/?y7 S8/?y8 A2/138/?y30/?y31 B0/?z1 O?y32; [check for Charm of Mana, Talisman of Mana, Mystic Orb of Mana, Mysticism skill level, Wizards Well, get hero's name]

!!if&x2=1;                              [Only run before battle start and save variables]
  !!VRy8:S3;                            [Set base chance to 30%]
  !!VRy8&y3=1:+1;                       [Charm of Mana Bonus adds 10% Bonus]
  !!VRy8&y5=1:+2;                       [Talisman of Mana Bonus adds 20% Bonus]
  !!VRy8&y31=1:+3;                      [Wizards Well Bonus adds +30% Chance]
  !!VRy10:S0R10;                        [do coin flip for stronger spell in combat]
  !!FU&y10>y8:E;                        [exit the function  if random value is bigger than chance]
  !!VRy15:S10 R90;                      [Roll for 10% til 100% damage increase]
  !!VRy15&y7=1:+40;                     [check for Mystic Orb of Mana  if yes increase damage +40%]
  !!VRy15&y31=1:+40;                    [check for Wizards Well  if yes increase damage +40%]
  !!VRy20:S15 R8;                       [choose Spell which will deal more dmg]
  !!HEx1:My20/?y22;                     [Check if the hero knows the spell]
  !!FU&y22=0:E;                         [Exit if the hero has not learned the spell]
  !!SN:W^Arcane_Prophet_Spell_%X1^/y20; [Save Spell by Hero ID]
  !!SN:W^Arcane_Prophet_Spell_Damage%X1^/y15; [Save Spell damage by Hero ID]
!!en;

!!OW:Iy32/?y33;                         [Added get if owner is AI]

!!SN:W^Arcane_Prophet_Spell_%X1^/?y20;  [Check Spell by Hero ID]
!!SN:W^Arcane_Prophet_Spell_Damage%X1^/?y15; [Check Spell damage by Hero ID]
!!if&x2=2/y20>0;                        [if a spell was selected]
  !!if&i^battle_isVisible^/y33=0;       [If visible and battle has already started and is not AI]
    !!SN:T^AC_Misc.Arkane Prophet^/?z2/^damage^/y15 Iz2/?z2; [get text string in z2]
    !!IF:Q2/9/y20/1/z2;                 [Show Message]
  !!en;
!!en;

!?FU(OnAfterBattleUniversal);           [Reset Arcane Prophet variables after combat]
!!BA:H0/?y1;                            [get attacking hero #]
!!SN:W^Arcane_Prophet_Spell_%Y1^/0;     [reset variable after combat]
!!SN:W^Arcane_Prophet_Spell_Damage%Y1^/0;[reset variable after combat]
!!BA:H1/?y1;                            [get defending hero #]
!!SN:W^Arcane_Prophet_Spell_%Y1^/0;     [reset variable after combat]
!!SN:W^Arcane_Prophet_Spell_Damage%Y1^/0;[reset variable after combat]


*************************Elemental Resistance*******************************************************
*Mages get a Natural_Resistance against elemental spells -20% damage from spells
!?MR1;                                  [*Magical Combat Improvements*]

!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>1:E;

!!BG:S?y2;
!!FU&y2<=9|y2>69:E;
!!BG:Q?y1;
!!VRy1:-1 *-1;
!!BA:Hy1/?y99;
!!FU&y99<0:E;
!!SN:W^Master_Mage_Hero%Y99^/?y11;
!!SN:W^Master_Adventurer_Hero%Y99^/?y12;
!!SN:W^Master_Warrior_Hero%Y99^/?y13;

!!MR:F?y6;
!!if&y6>0/y11=1/y12=0/y13=0;            [Resistance bonus handling, run only for Mages and not for Battlemages or Druids]
  !!VRy6:*80:100;
  !!MR&y6>0:Fy6;                        [Apply Reduced damage]
!!en;


*************************Pierce Resistance*******************************************************
*Mages pierce 15% of Dwarv type resistance GM pierce 25%
That breakes immunities and allows to apply spells to creatures that are usually immune.

!?MR2;                                  [Magic Resistance Trigger]
; Exit if not hero cast
!!BG:A?(action:y);
!!FU&(action)<>(BATTLE_ACTION_HERO_CAST):E;

; Exit if friendly spell
!!MR:S?(spell:y);
!!SS(spell):O?(spellType:y);
!!FU&(spellType)=1:E;

; Exit if the target is the same side as the caster
!!MR:N?(targetStack:y);                 [Get Creature Number]
!!BM(targetStack):I?(side:y); 
!!FU&(side)=i^battle_acting_side^:E;

; Exit for War Machines
!!BM(targetStack):T?(type:y);           [Get Creature Type]
!!FU&(type)>=145/(type)<=149:E;         [Exit for Warmachines]

; Exit if Forgetfullness and the receiver can't shoot
!!if&(spell)=(SPELL_FORGETFULNESS);
  !!BM(targetStack):F?(flags:y);
  !!VR(canShoot:y):S(flags) &(MON_FLAG_SHOOTER);
  !!FU&(canShoot)=0:E;
!!en;

; Get caster hero Id
!!VR(hero:y):Si^battle_hero_%i(battle_acting_side)^;
!!FU&(hero)=(NO_HERO):E;

; Exit if can't reduce spell resistance
!!FU(ACM_Calc_Magic_Pierce):P(hero:y)/?(pierceRate:y);   [Pass hero number and return pierce value]
!!FU&(pierceRate)=0:E;

!!MR:F?(resistance:y);                  [Get temporarily MR of Creature]
!!VR(resistance):+(pierceRate) F0/100;[Reduce MR by value and make sure it cannot be negative]
!!MR:F(resistance);                     [Apply decreased resistance chance to that stack temporarily]


!?FU(ACM_Calc_Magic_Pierce);
x1=hero number, x2=returns value

!!VRy20:S0;                             [Initialize to zero]
!!HEx1:A2/141/?y30/?y87 A2/150/?y30/?y88;[Check artifacts 141 Magic Wand 150 Pendant of Sorcery]
!!VRy20&y87=1:+5;
!!VRy20&y88=1:+10;
!!FU(Count_Set_Pieces):Px1/0/?y89;      [Count Set Pieces function, check for Elemental Unity full set bonus]
!!VRy20&y89=4:+5;
!!SN:W^Master_Mage_Hero%X1^/?y11;       [Check for Master Mage]
!!SN:W^Grandmaster_Mage_Hero%X1^/?y12;  [Check for GM Mage]
!!VRy20&y11=1/y12=0:+15; 
!!VRy20&y11=1/y12=1:+25;                [Reduce by Master 15% and 25% for GM]

!!VRy20:*-1;                            [Make negative]
!!VRx2:Sy20;                            [return value]


************************Master Adventurer***************************************
**Plunder Ability No movement cost for picking fights resources and other stuff
**Druids no longer get the ability

!?HM-1;                                 [Hero Movement]
!!HE-1:N?y1; !!FU&y1<0:E;
!!SN:W^Master_Adventurer_Hero%Y1^/?y2;
!!SN:W^Master_Mage_Hero%Y1^/?y3;
!!if&y2=1/y3=0;
!!HEy1:W?y4/1;
!!SN:W^Hero%Y1_Movement^/y4;
!!en;

!?CM5;                                  [When Map Clicked for fix with pickung up Resources]
!!CM:S?v3; !!FU&v3<>12:E;

!!OW:C?y1;                              [Get current player]
!!OW:Ay1/?y1;                           [Get active Hero]
!!FU&y1=-1:E;                           [Exit if none]

!!FU&y1<0/y1>=155:E;
!!SN:W^Master_Adventurer_Hero%Y1^/?y2;
!!SN:W^Master_Mage_Hero%Y1^/?y3;
!!if&y2=1/y3=0;
!!HEy1:W?y4/1;
!!SN:W^Hero%Y1_Movement^/y4;
!!en;

!?OB5;                                  [5 Artifact]
!!HE-1:N?y1;
!!FU(Plunder_Ability)&y1>=0/y1<=155:Py1;

!?OB12;                                 [12 Campfire]
!!HE-1:N?y1;
!!FU(Plunder_Ability)&y1>=0/y1<=155:Py1;

!?OB53;                                 [53 Mine]
!!HE-1:N?y1;
!!FU(Plunder_Ability)&y1>=0/y1<=155:Py1;

!?OB54;                                 [54 Monster]
!!HE-1:N?y1;
!!SN:W^Grandmaster_Adventurer_Hero%Y1^/?y2; [Only works for Grandmaster]
!!FU(Plunder_Ability)&y1>=0/y1<=155/y2=1:Py1;

!?OB79;                                 [79 Resource]
!!HE-1:N?y1;
!!FU(Plunder_Ability)&y1>=0/y1<=155:Py1;

!?OB101;                                [101 Treasure Chest]
!!HE-1:N?y1;
!!FU(Plunder_Ability)&y1>=0/y1<=155:Py1;

!?OB16;                                 [16 Creature Bank]
!!HE-1:N?y1;
!!FU(Plunder_Ability)&y1>=0/y1<=155:Py1;

!?FU(Plunder_Ability);
!!SN:W^Master_Adventurer_Hero%X1^/?y2;
!!SN:W^Master_Mage_Hero%X1^/?y3;

!!VRy1:S0R150; !!FU&y1>50:E;            [Works only in 33% of all cases. Yes big nerf lol.]

!!if&y2=1/y3=0;
  !!HEx1:W?y5/1;                        [Check current movement]
  !!SN:W^Hero%X1_Movement^/?y4;         [Check saved movement from last move]
  !!VRy6:Sy4-y5;
  !!HEx1&y4>y5/y6<150:Wy4/1;            [Restore movement from last move only if it is bigger than current]
  !!if&y6>=150;
    !!VRy6::2; !!VRy4:-y6;
    !!HEx1&y4>y5:Wy4/1;                 [Restore movement from last move only if it is bigger than current]
  !!en;
!!en;


!?FU(OnAfterBattleUniversal)&1000;      [At Battle End]

!!FU:E;                                 [Disabled for now]
!!HE-1:N?y1;                            [Hero Number]
!!FU&y1<0:E;                            [exit if no active hero]

!!HEy1:O?y9;                            [get owner of this hero]
!!FU&y9=-1:E;                           [Exit if no Owner]
!!SN:W^Hero_Attacker_Owner0^/?y5;
!!SN:W^Master_Adventurer_Hero%Y1^/?y2;

!!if&y2=1/y5=y9;
!!VRy3:S200;
!!HEy1:Wdy3/1;                          [give calculated free Movement Points]
!!IF&1000/999:M^{~Green}Master Adventurer Bonus{~}

You find a shortcut out of the battlefield (+%Y3 movement points)^;
!!en;



!?OB12; Campfire
!!FU:E; Test
!!FR998:B?y1/?y2;
!!IF:L^%Y1 and %Y2^;
!!VRy2:*2;
!!IF:L^%Y1 and Neu: %Y2^;
!!FR998:By1/y2;


*******************Master and Grandmaster Adventurer****************************
*Taking Cities gives Gold at Master level
*Taking Cities at Grandmaster Level immiditaly increases the number of creatures to hire in that city

!?OB98;                                 [Trigger when visiting a town]

!!CA998:O?y1;                           [check town owner]
!!if&y1<0;                              [If Neutral Town]
!!HE-1:N?y1;                            [get current hero ID]
!!HEy1:O?y2;                            [get hero owner]
!!SN:W^Master_Adventurer_Hero%Y1^/?y20;
!!SN:W^Master_Warrior_Hero%Y1^/?y21;
!!SN:W^Master_Mage_Hero%Y1^/?y22;
!!if&y20=1/y21=0/y22=0;                 [If Master Adventurer and not Hybrid Class]
  !!CA998:H0/?y3 H1/?y4 M2/0/?y5/d M2/1/?y6/d M2/2/?y7/d M2/3/?y8/d M2/4/?y9/d M2/5/?y10/d M2/6/?y11/d;
  !!FU(Town_Plunder)&y3=-1/y4=-1/y5=-1/y6=-1/y7=-1/y8=-1/y9=-1/y10=-1/y11=-1:Py1/y2/v998/v999/v1000;
!!en;
!!en;

!!CA998:O?y1;                           [check town owner]
!!FU&y1<0:E;                            [If Town under controll]
!!HE-1:O?y2;                            [get hero owner]
!!OW:Ty1/?y3 Ty2/?y4; 
!!FU&y3=y4:E;                           [exit if it is your own town]
!!HE-1:N?y1;                            [get the current hero ID]
!!SN:W^Master_Adventurer_Hero%Y1^/?y20;
!!SN:W^Master_Warrior_Hero%Y1^/?y21;
!!SN:W^Master_Mage_Hero%Y1^/?y22;
!!if&y20=1/y21=0/y22=0;                 [If Master Adventurer and not Hybrid Class]
  !!CA998:H0/?y3 H1/?y4 M2/0/?y5/d M2/1/?y6/d M2/2/?y7/d M2/3/?y8/d M2/4/?y9/d M2/5/?y10/d M2/6/?y11/d;
  !!FU(Town_Plunder)&y3=-1/y4=-1/y5=-1/y6=-1/y7=-1/y8=-1/y9=-1/y10=-1/y11=-1:Py1/y2/v998/v999/v1000;
!!en;


!?FU(OnAfterBattleUniversal);

!!BA:H0/?y1;
!!SN:W^Master_Adventurer_Hero%Y1^/?y20;
!!SN:W^Master_Warrior_Hero%Y1^/?y21;
!!SN:W^Master_Mage_Hero%Y1^/?y22;
!!if&y20=1/y21=0/y22=0;                 [If Master Adventurer and not Hybrid Class]
!!BA:S?y80;
!!FU&y80=0:E;                           [Exit if no Siege]
!!HEy1:O?y2;
!!BA:P?y11/?y12/?y13;
!!TRy11/y12/y13:E?y4;
!!FU&y4=1:E;
!!OBy11/y12/y13:T?y3;
!!FU&y3<>98:E;
!!FU(Town_Plunder)&y2>=0/y1>=0:Py1/y2/y11/y12/y13; [if the attacking hero is alive, the city was not neutral and fell, we transfer resources]
!!en;

!?FU(Town_Plunder);
x1=Hero Number
x2=Hero Owner
x3-x5=Town Coordinates

!!VRy99:Sc;                             [Get Current Day in y99]
!!SN:W^Town_Plunder_%X3_%X4_%X5_Cooldown^/?y98; [set this town to current gameday]
!!FU&y99<y98:E;                         [Exit if plunder would happen on the same town within two weeks]

!!SN:W^Grandmaster_Adventurer_Hero%X1^/?y20;
!!VRy15:S8000;                          [Set Golf Bonus for Master Adventurer]
!!VRy15&y20=1:S15000;                   [Set Golf Bonus for Grandmaster Adventurer]

; Show message if the conqueror is the interacting player (don't use &1000 here)
!!OW:C?y31/?y32;

!!if&x2=y32;
  !!SN:T^AC_Misc.Town_Plunder^/?z1/^gold^/y15;
  !!IF:M1/z1;                           [show message]
!!en;

!!OW:Rx2/6/dy15;                        [increase players resources]

!!VRy99:+14;                            [Add two weeks cooldown]
!!SN:W^Town_Plunder_%X3_%X4_%X5_Cooldown^/y99; [set this town to current gameday]

*Level 1*                      *Level 2*                      *Level 3*                      *Level 4*                     *Level 5*                     *Level 6*                     *Level 7*
!!VRy21:S40; !!VRy22:S30; !!VRy23:S25; !!VRy24:S20; !!VRy25:S15; !!VRy26:S10; !!VRy27:S2; [Master]

!!if&y20=1;                             [if Grandmaster]
!!VRy21:S80; !!VRy22:S40; !!VRy23:S35; !!VRy24:S30; !!VRy25:S25; !!VRy26:S15; !!VRy27:S4; [Grandmaster]
!!en;
**Y21 bis Y27  is level 1 til 7

!!CAx3/x4/x5:B3/37;                     [Upg dwelling 1]
!!CAx3/x4/x5&1:M1/0/d0/dy21;
!!CAx3/x4/x5&-1:B3/30;                  [dwelling 1]
!!CAx3/x4/x5&1:M1/0/dy21/d0;

!!CAx3/x4/x5:B3/38;                     [Upg dwelling 2]
!!CAx3/x4/x5&1:M1/1/d0/dy22;
!!CAx3/x4/x5&-1:B3/31;                  [dwelling 2]
!!CAx3/x4/x5&1:M1/1/dy22/d0;

!!CAx3/x4/x5:B3/39;                     [Upg dwelling 3]
!!CAx3/x4/x5&1:M1/2/d0/dy23;
!!CAx3/x4/x5&-1:B3/32;                  [dwelling 3]
!!CAx3/x4/x5&1:M1/2/dy23/d0;

!!CAx3/x4/x5:B3/40;                     [Upg dwelling 4]
!!CAx3/x4/x5&1:M1/3/d0/dy24;
!!CAx3/x4/x5&-1:B3/33;                  [dwelling 4]
!!CAx3/x4/x5&1:M1/3/dy24/d0;

!!CAx3/x4/x5:B3/41;                     [Upg dwelling 5]
!!CAx3/x4/x5&1:M1/4/d0/dy25;
!!CAx3/x4/x5&-1:B3/34;                  [dwelling 5]
!!CAx3/x4/x5&1:M1/4/dy25/d0;

!!CAx3/x4/x5:B3/42;                     [Upg dwelling 6]
!!CAx3/x4/x5&1:M1/5/d0/dy26;
!!CAx3/x4/x5&-1:B3/35;                  [dwelling 6]
!!CAx3/x4/x5&1:M1/5/dy26/d0;

!!CAx3/x4/x5:B3/43;                     [Upg  dwelling 7]
!!CAx3/x4/x5&1:M1/6/d0/dy27;
!!CAx3/x4/x5&-1:B3/36;                  [dwelling 7]
!!CAx3/x4/x5&1:M1/6/dy27/d0;

!!SN&1000:D;                            [Added SN:D command. It's used to redraw hero, heroes meeting, adventure map and town screens.]


************************Grandmaster Adventurer**********************************
*+3% Creature Growth per Week*

!?FU(OnEveryDay)&i^timerDay^>1/i^timerWeekDay^=1;
!!OW:C?y1;
!!DO(AC_Function_20)/0/155/1:Py1;

!?FU(AC_Function_20);
!!HEx16:O?y1;                           [Checke Hero Owner]
!!FU&y1=-1:E;                           [Exit if none]
!!HEx16:O?y1;                           [check hero owner]
!!FU&y1<>x1:E;                          [exit if not current player]
!!SN:W^Master_Adventurer_Hero%X16^/?y10;
!!SN:W^Grandmaster_Adventurer_Hero%X16^/?y11;
!!DO(AC_Function_21)/0/6/1&y10=1/y11=1:Px16/3; [Pass Hero and Skilllevel]

!?FU(AC_Function_21);
!!HEx1:C0/x16/?y1/?y2;                  [Get hero creatures]
!!FU|y2<1/y1<0:E;                       [Exit if no creature in slot]
!!FU(Count_Set_Pieces_2):Px1/0/0/0/0/?y92; [Check for  Sets]
!!SN&y92=3:W^Adventurer_Set_Count_Hero%X1^/?y10;
!!MA:Ly1/?y20;                          [get monster level]
!!VRy10&y92=3::20;                      [+1% per 20 hero Levels]
!!VRy11:S103;                           [3%Growth  at Grandmaster]
!!VRy11&y92=3:+y10;                     [+ Set Bonus if equipped]
!!VRy3:Sy2 *y11 :100 -y2;

*set max cap to limit growth*
!!VRy21:S25; !!VRy22:S15; !!VRy23:S10; !!VRy24:S8; !!VRy25:S6; !!VRy26:S4; !!VRy27:S1;

!!if&y10=1;                            [With 1% set bonus]
!!VRy21:S30; !!VRy22:S20; !!VRy23:S14; !!VRy24:S11; !!VRy25:S8; !!VRy26:S6; !!VRy27:S1;
!!en;

!!if&y10=2;                            [With 2% set bonus]
!!VRy21:S40; !!VRy22:S25; !!VRy23:S18; !!VRy24:S14; !!VRy25:S10; !!VRy26:S8; !!VRy27:S2;
!!en;

!!if&y10=3;                            [With 3% set bonus]
!!VRy21:S50; !!VRy22:S30; !!VRy23:S21; !!VRy24:S17; !!VRy25:S12; !!VRy26:S10; !!VRy27:S2;
!!en;

!!if&y10=4;                            [With 4% set bonus]
!!VRy21:S60; !!VRy22:S35; !!VRy23:S25; !!VRy24:S20; !!VRy25:S15; !!VRy26:S12; !!VRy27:S3;
!!en;

!!if&y10=5;                            [With 5% set bonus]
!!VRy21:S70; !!VRy22:S40; !!VRy23:S30; !!VRy24:S25; !!VRy25:S20; !!VRy26:S15; !!VRy27:S4;
!!en;

!!VRy3&y20=0/y3>y21:Sy21;               [For level 1]
!!VRy3&y20=1/y3>y22:Sy22;               [For level 2]
!!VRy3&y20=2/y3>y23:Sy23;               [For level 3]
!!VRy3&y20=3/y3>y24:Sy24;               [For level 4]
!!VRy3&y20=4/y3>y25:Sy25;               [For level 5]
!!VRy3&y20=5/y3>y26:Sy26;               [For level 6]
!!VRy3&y20=6/y3>y27:Sy27;               [For level 7]
!!HEx1:C0/x16/d/dy3/0/0;                [Add Monsters to army]

!!SN&y20=0:W^Grand_Adv_%X1_Creature_LvL_1^/dy3; [Save creature growths]
!!SN&y20=1:W^Grand_Adv_%X1_Creature_LvL_2^/dy3;
!!SN&y20=2:W^Grand_Adv_%X1_Creature_LvL_3^/dy3;
!!SN&y20=3:W^Grand_Adv_%X1_Creature_LvL_4^/dy3;
!!SN&y20=4:W^Grand_Adv_%X1_Creature_LvL_5^/dy3;
!!SN&y20=5:W^Grand_Adv_%X1_Creature_LvL_6^/dy3;
!!SN&y20=6:W^Grand_Adv_%X1_Creature_LvL_7^/dy3;


!?CM2&1000;                             [Hero Interface]
!!CM:F?y1 I?y2 S?y3;
!!FU|y1<>512/y2<>0/y3<>14:E;            [right-click empty space in hero screen]
!!HE-1:N?y4;                            [get hero number]
*!FU(ACM_Select_Commander_Role):Py4;    Testing code
!!SN:W^Grandmaster_Adventurer_Hero%Y4^/?y1; [check if grandmaster adventurere]
!!FU&y1=0:E;                            [Exit if no GM Adv]

!!SN:W^Grand_Adv_%Y4_Creature_LvL_1^/?y10; [get creature growths from variable in y10]
!!SN:W^Grand_Adv_%Y4_Creature_LvL_2^/?y11;
!!SN:W^Grand_Adv_%Y4_Creature_LvL_3^/?y12;
!!SN:W^Grand_Adv_%Y4_Creature_LvL_4^/?y13;
!!SN:W^Grand_Adv_%Y4_Creature_LvL_5^/?y14;
!!SN:W^Grand_Adv_%Y4_Creature_LvL_6^/?y15;
!!SN:W^Grand_Adv_%Y4_Creature_LvL_7^/?y16; [get creature growths for level 7 from variable in y16]

show message text how many creatures have been gathered in total per level
!!IF:M^{Grandmaster Adventurer Creature Bonus}

Level 1 units: %Y10
Level 2 units: %Y11
Level 3 units: %Y12
Level 4 units: %Y13
Level 5 units: %Y14
Level 6 units: %Y15
Level 7 units: %Y16
^;


!?BF&1000;                              [Combat Start]

!!FU:E;
!!BA:H0/?y1;                            [Attacker]
!!SN:W^Grandmaster_Adventurer_Hero%Y1^/?y11;
!!if&y11=1;
!!HEy1:S1/?y12 S22/?y13 S23/?y14;
!!SN&y12<=2:W^Att_Grandmaster_Adventurer_Archery^/y12; !!HEy1&y12<=2:S1/2;
!!SN&y13<=2:W^Att_Grandmaster_Adventurer_Offense^/y13; !!HEy1&y13<=2:S22/2;
!!SN&y14<=2:W^Att_Grandmaster_Adventurer_Armorer^/y14; !!HEy1&y14<=2:S23/2;
!!en;

!!BA:H1/?y1;                            [Defender]
!!FU&y1<0:E;                            [Exit if no Hero]
!!SN:W^Grandmaster_Adventurer_Hero%Y1^/?y11;
!!if&y11=1;
!!HEy1:S1/?y12 S22/?y13 S23/?y14;
!!SN&y12<=2:W^Def_Grandmaster_Adventurer_Archery^/y12; !!HEy1&y12<=2:S1/2;
!!SN&y13<=2:W^Def_Grandmaster_Adventurer_Offense^/y13; !!HEy1&y13<=2:S22/2;
!!SN&y14<=2:W^Def_Grandmaster_Adventurer_Armorer^/y14; !!HEy1&y14<=2:S23/2;
!!en;


!?BG1&1000;                             [After Combat Restore orignal Skills]

!!FU:E;
!!BU:C?y1;                              [Check if combat has ended this round]
!!FU&y1=0:E;

!!BA:H0/?y1;                            [Attacker]
!!SN:W^Grandmaster_Adventurer_Hero%Y1^/?y11;
!!if&y11=1;
!!HEy1:S1/?y22 S22/?y33 S23/?y44;
!!SN:W^Att_Grandmaster_Adventurer_Archery^/?y12; !!HEy1&y22<=2:S1/y12;
!!SN:W^Att_Grandmaster_Adventurer_Offense^/?y13; !!HEy1&y33<=2:S22/y13;
!!SN:W^Att_Grandmaster_Adventurer_Armorer^/?y14; !!HEy1&y44<=2:S23/y14;
!!en;

!!BA:H1/?y1;                            [Defender]
!!FU&y1<0:E;                            [Exit if no Hero]
!!SN:W^Grandmaster_Adventurer_Hero%Y1^/?y11;
!!if&y11=1;
!!HEy1:S1/?y12 S22/?y13 S23/?y14;
!!SN&y12<=2:W^Def_Grandmaster_Adventurer_Archery^/y12; !!HEy1&y12<=2:S1/2;
!!SN&y13<=2:W^Def_Grandmaster_Adventurer_Offense^/y13; !!HEy1&y13<=2:S22/2;
!!SN&y14<=2:W^Def_Grandmaster_Adventurer_Armorer^/y14; !!HEy1&y14<=2:S23/2;
!!en;


**********************************************
*Coordinated Attacks provide +1 true damage for each unit in the stack only melee attacks*

!?MF1;                                  [before stack takes physical damage]

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676;[Only run when melee or shooting damage]
!!MF:W?y80;
!!FU&y80>0:E;

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Coordinated_Attacking_Stack^/?y50;[call stack from OnBattleRegeneratePhase]
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
!!SN:W^Coordinated_Attacking_Stack^/y4; [Save damage receiving stack for this attack]

!!BMy1:I?y98;

!!BA:Hy98/?y99;
!!FU&y99<0:E;
!!SN:W^Grandmaster_Adventurer_Hero%Y99^/?y12;
!!FU&y12=0:E;

!!BMy1:N?y6;                            [how many monsters in attacking stack?]
!!FU&y6=1:E;                            [With only 1 stack there is no coordination]
!!MF:F?y4;
!!VRy5:Sy4+y6;
*!MF:Fy5;                               [deal new updated damage]

!!BA:Q?f;
!!SN:T^AC_Misc.Coordinated_Damage^/?z-1/^damage^/y6;
!!BU&i^battle_isVisible^:Mz-1;
!!en;



*********************************Battlemage*************************************
**Precast ability* Cast a random damage spell from your book at the enemy at combat start
**Warcry at the beginning of battle reduces enemy HP by some %

!?FU(OnBattleRegeneratePhase);

!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]
!!SN:X?y1;                              [Event parameter]
!!BMy1:I?y2;                            [Acting Side Monster]
!!SN&y2=0:W^Battlemage_Precast_0^/?y6;
!!SN&y2=1:W^Battlemage_Precast_1^/?y6;
!!FU&y6=1:E;
!!BA:Hy2/?y4;                           [Current Hero]
!!FU&y4<0:E;                            [Exit if none]
!!VRy40:S0;
!!VRy40&y2=0:S21; !!VRy40&y2=1:S0;      [Set creatures to search for target]
!!SN:W^Master_Warrior_Hero%Y4^/?y9;
!!SN:W^Master_Mage_Hero%Y4^/?y10;
!!FU|y9=0/y10=0:E;                      [Exit if no Battlemage]
!!HEy4:A2/0/?y15/?y14;
!!FU&y14=0:E;                           [Exit if no Spellbook]
!!HEy4:I?y30/1;                         [Get Spell Points]
!!BA:Q?f;                               [Check for Quick Battle]

!!VRy99:S50;
[:find_spell]
!!VRy11:S15R8;
!!VRy11&y11=26:S17;                     [If Armageddon Set Lightning Strike]
!!VRy11&y11=19:S21;                     [If Chain Lightning Set Fireball]
!!VRy11&y11=20:S16;                     [If Frost Ring Set Ice Bolt]
!!HEy4:My11/?y12;
!!VRy99:-1;
!!SN&y12=0/y99>0:G[find_spell];         [Loop until a spell found]
!!FU&y99=0:E;                           [Exit if the Hero knows no Spell]

!!VRy50:S0;
[:find_target]
!!VRy50:+1;
!!VRy10:Sy40R6;                         [Seach attacker or defender]
!!BMy10:P?y5 N?y6 T?y7 I?y8; 
!!FU&y50=100:E;                         [Exit if no valid Target can be found]
!!SN|y6=0/y7=145/y7=146/y7=147/y7=148/y7=149:G[find_target]; [Loop]
!!BHy2:Cy11/y5/3/1;                     [Cast Spell at Target]
!!BHy2:M0;                              [Reenable Spell Book after cast]

!!SN&y2=0:W^Battlemage_Precast_0^/1;
!!SN&y2=1:W^Battlemage_Precast_1^/1;
!!HEy4:Iy30/1;                          [Reset Spell Points]


!?FU(OnAfterBattleUniversal);
!!SN:W^Battlemage_Precast_0^/0;
!!SN:W^Battlemage_Precast_1^/0;

!?MR1;
!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]
!!BG:Q?y2;                              [Event parameter]
!!SN&y2=0:W^Battlemage_Precast_0^/?y6;
!!SN&y2=1:W^Battlemage_Precast_1^/?y6;
!!FU&y6=1:E;
!!BA:Hy2/?y4;                           [Current Hero]
!!FU&y4<0:E;                            [Exit if none]
!!SN:W^Master_Warrior_Hero%Y4^/?y9;
!!SN:W^Master_Mage_Hero%Y4^/?y10;
!!FU|y9=0/y10=0:E;                      [Exit if no Battlemage]
!!MR:F?y10;
!!VRy10:*3;                             [Tripple Damage from Precast]
!!MR:Fy10;

                            
!?FU(OnCombatRound)&v997=0;             [Warcry Reduce HP by 10%]

!!BA:H0/?y1 Q?f;                        [Attacker]
!!SN:W^Master_Warrior_Hero%Y1^/?y9;
!!SN:W^Master_Mage_Hero%Y1^/?y10;
!!if&y9=1/y10=1;
  !!HEy1:B0/?z2;                        [get hero name]
  !!DO(AC_Function_38)/21/41/1:P90;     [Run if Battlemage]
  !!SN:T^AC_Misc.Warcry ability^/?z1/^damage^/10/^name^/z2;
  !!BU&i^battle_isVisible^:Mz1;         [Show Message in Battlelog]
!!en;

!!BA:H1/?y1;                            [Defender]
!!FU&y1<0:E;
!!SN:W^Master_Warrior_Hero%Y1^/?y9;
!!SN:W^Master_Mage_Hero%Y1^/?y10;
!!if&y9=1/y10=1;
  !!HEy1:B0/?z2;                        [get hero name]
  !!DO(AC_Function_38)/0/20/1:P90;      [Run if Battlemage]
  !!SN:T^AC_Misc.Warcry ability^/?z1/^damage^/10/^name^/z2;
  !!BU&i^battle_isVisible^:Mz1;         [Show Message in Battlelog]
!!en;

!?FU(AC_Function_38);                   [decrease Units Stats]
!!BMx16:T?y1 N?y20;
!!FU|y1=145/y1=146/y1=147/y1=148/y1=149/y20=0:E;
!!BMx16:H?y2;                           [Get HP]
!!VRy2:*x1:100;                         [Reduce HP]
!!BMx16&y2>0:Hy2;                       [Set new HP]


*********************************Hunter*****************************************
**First Shoot   and 50% MR, in the First Round**
Ranged units get +50 speed to act first in battle
!?FU(OnCombatRound)&v997=0;             [Changed Trigger]

!!BA:H0/?y1 Q?f;                        [Attacker]
!!SN:W^Master_Warrior_Hero%Y1^/?y9;
!!SN:W^Master_Adventurer_Hero%Y1^/?y10;
!!if&y9=1/y10=1;
  !!HEy1:B0/?z2;                        [get hero name]
  !!SN:T^AC_Misc.First Shot^/?z1/^name^/z2;
  !!BU&i^battle_isVisible^:Mz1;         [Show Message in Battlelog]
!!en;

!!BA:H1/?y1;                            [Defender]
!!FU&y1<0:E;
!!SN:W^Master_Warrior_Hero%Y1^/?y9;
!!SN:W^Master_Adventurer_Hero%Y1^/?y10;
!!if&y9=1/y10=1;
  !!HEy1:B0/?z2;                        [get hero name]
  !!SN:T^AC_Misc.First Shot^/?z1/^name^/z2;
  !!BU&i^battle_isVisible^:Mz1;         [Show Message in Battlelog]
!!en;


!?FU(OnAfterTacticsPhase); [Moved timing from OnCombatRound to OnAfterTacticsPhase to have correct move order in battle]
!!SN:W^Hunter_Speed_Bonus1^/?y1;
!!FU&y1=1:E;
!!SN:W^Hunter_Speed_Bonus1^/1;          [To run only once]

!!BA:H0/?y1 Q?f;                        [Attacker]
!!SN:W^Master_Warrior_Hero%Y1^/?y9;
!!SN:W^Master_Adventurer_Hero%Y1^/?y10;
!!if&y9=1/y10=1;  
  !!HEy1:B0/?z2;                        [get hero name]
  !!DO(AC_Function_22)/0/20/1:P1;
!!en;

!!BA:H1/?y1;                            [Defender]
!!FU&y1<0:E;
!!SN:W^Master_Warrior_Hero%Y1^/?y9;
!!SN:W^Master_Adventurer_Hero%Y1^/?y10;
!!if&y9=1/y10=1;
  !!HEy1:B0/?z2;                        [get hero name]
  !!DO(AC_Function_22)/21/41/1:P1;
!!en;

!?FU(OnCombatRound)&v997=1;
!!SN:W^Hunter_Speed_Bonus2^/?y1;
!!FU&y1=1:E;
!!SN:W^Hunter_Speed_Bonus2^/1;          [To run only once]

!!BH0:N?y1;                             [Attacker]
!!VRy11:S0;
!!SN:W^Master_Warrior_Hero%Y1^/?y9;
!!SN:W^Master_Adventurer_Hero%Y1^/?y10;
!!VRy11&y9=1/y10=1:S1;
!!DO(AC_Function_22)/0/20/1&y11=1:P2;

!!BH1:N?y1;                             [Defender]
!!FU&y1<0:E;
!!VRy11:S0;
!!SN:W^Master_Warrior_Hero%Y1^/?y9;
!!SN:W^Master_Adventurer_Hero%Y1^/?y10;
!!VRy11&y9=1/y10=1:S1;
!!DO(AC_Function_22)/21/41/1&y11=1:P2;

!?FU(OnBeforeBattleUniversal);          [Before Battle]
!!SN:W^Hunter_Speed_Bonus1^/0;          [Reset]
!!SN:W^Hunter_Speed_Bonus2^/0;          [Reset]

!?FU(AC_Function_22);
!!BMx16:T?y1;
!!FU|y1=145/y1=146/y1=147/y1=148/y1=149:E; [Exit for Warmachines]
!!FU|y1=174/y1=175/y1=176/y1=177/y1=178/y1=179/y1=180/y1=181/y1=182:E; [Exit for commanders]
!!FU|y1=183/y1=184/y1=185/y1=186/y1=187/y1=188/y1=189/y1=190/y1=191:E;
!!BMx16:F?i;                            [Give Pepp to Shooters]
!!VRi:&4;                               [Check for Shooter]
!!BMx16&x1=1/i>0:Sd50;
!!BMx16&x1=2/i>0:Sd-50;

Hunter gets +50% MR in first Battle Round, also works for AI
!?MR2;                                  [Magic Resistance Trigger]
!!if&v997=0;                            [Only in First Battleround]
  !!MR:N?y1;                            [Get Creature Number]
  !!BMy1:I?y2;                          [Get Creature Side]
  !!BG:H?y50;                           [Get Casting Hero]
  !!BA:Hy2/?y4;                         [Get Hero Number of creature side]
  !!FU&y4<0:E;
  !!SN:W^Master_Warrior_Hero%Y4^/?y11;
  !!SN:W^Master_Adventurer_Hero%Y4^/?y12;
  !!FU|y50=y4/y11=0/y12=0:E;            [Exit for beneficial spells, meaning same hero or no Hunter]
  !!MR:Fd50;                            [Grant +50% MR temporarily immune]
  !!SN:W^Total_MR2_Value^/d50;
!!en;


*********************************Druid*****************************************
**Flat Damage Block 4*Hero Level, Heal Squad look in First Aid Section

!?MF1;                                  [*Physical Combat *]

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676;[Only run when melee or shooting damage]

!!MF:W?y80;
!!FU&y80>0:E;

!!BG:A?y1;
!!if|y1=6/y1=7;                         [Attack or Shoot]

!!MF:N?y4;                              [damage receiving stack]
!!BMy4:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;                           [Exit if no Hero]
!!BMy4:F?y78;                           [read flags]
!!VRy78:&4194304;                       [just look summoned bit]
!!FU&y78>0:E;                           [Exit if cloned or summoned]
!!SN:W^Master_Mage_Hero%Y99^/?y9;
!!SN:W^Master_Adventurer_Hero%Y99^/?y10;
!!FU|y9=0/y10=0:E;                      [Exit if not Expert Druid]
!!HEy99:E?y20/?y21/1;

!!MF:F?y6;                              [Damage Dealt]
!!VRy8:Sy21*4 F0/y6;                    [Shield Strength 4*Hero Level]

!!if&i^battle_isVisible^;
  !!HEy99:B0/?z3;
  !!SN:T^AC_Misc.Natural Resistance^/?z2/^name^/z3/^damage^/y8;
  !!MM:Sz2;
!!en;

!!if&y8>=y6;
  !!SN&i^battle_isVisible^:P^CRUSDFND^; [play block sound]
  !!MF:E0;
  !!MF:F0;

!!el;                                   [do if damage is bigger than shield]
  !!VRy7:Sy6-y8;
  !!MF:Fy7;
!!en;

!!en;
!!en;

*********************************Druid*****************************************
Druid can transfer spells (buffs) on his troops to the next combat
The chance is random and can happen for max 3 stacks. The duration of the transfered buff is up to two rounds

!?PI;
!!DO(Remember_Spells_Fkt_0)/0/155/1:P;  [Set all Hero Vars to -1 at game start]


!?FU(OnAfterBattleUniversal)&1000;

!!BH0:N?y10;                            [Save Attacking Hero]
!!SN:W^Master_Mage_Hero%Y10^/?y40;
!!SN:W^Master_Adventurer_Hero%Y10^/?y41;
!!VRy15&y40=1/y41=1:S1;
!!HEy10:O?y30;                          [Check Side]
!!SN:W^RememberSpells_Attacker_Owner_Start^/?y31;
!!if&y30=y31/y15>0;
!!DO(Remember_Spells_Fkt_1)/0/8/1:Py10/1;[Save for Attacker Side]
!!SN:W^Hero%Y10_Number_Saved_Side0^/y10;[Activator/Save Hero Numer]
!!en;


!!BH1:N?y11;                            [Save Defending Hero]
!!FU&y11<0:E;                           [Exit if none]
!!SN:W^Master_Mage_Hero%Y11^/?y40;
!!SN:W^Master_Adventurer_Hero%Y11^/?y41;
!!VRy16&y40=1/y41=1:S1;
!!HEy11:O?y34;
!!SN:W^RememberSpells_Defender_Owner_Start^/?y32;
!!if&y34=y32/y16>0;
!!DO(Remember_Spells_Fkt_1)/21/29/1:Py11/2; [Save for Defender Side]
!!SN:W^Hero%Y11_Number_Saved_Side1^/y11;[Activator/Save Hero Numer]
!!en;

********************************************************************************
!?FU(Remember_Spells_Fkt_1);

!!VRx16&x2=1:S0R7;                      [Chose Random Stack Attacker]
!!VRx16&x2=2:S21R7;                     [Chose Random Stack Defender]
!!SN:W^Creature_Numerator1^/?y20;
!!VRx16&x2=1/y20=x16:S0R7;              [Reroll if same number Attacker]
!!VRx16&x2=2/y20=x16:S21R7;             [Reroll if same number Defender]
!!SN:W^Creature_Numerator1^/x16;
!!SN:W^Remember_Spells_Counter0^/?y5;
!!VRy5:+1;
!!SN&y5=1:W^Creature_Stack_Choice1^/x16;
!!SN&y5=2:W^Creature_Stack_Choice2^/x16;
!!SN&y5=3:W^Creature_Stack_Choice3^/x16;[Stop if three Stacks were choosen]
!!VRx16&y5=3/x2=1:S8;
!!VRx16&y5=3/x2=2:S29;
!!DO(Remember_Spells_Fkt_2)/27/58/1:Px1;[Run Loop throug all Spells with heronumber]
!!SN:W^Remember_Spells_Counter0^/y5;

********************************************************************************
!?FU(Remember_Spells_Fkt_2);

!!SN:W^Creature_Numerator1^/?y3;
!!if&x16<>35/x16<>37/x16<>38/x16<>39/x16<>40/x16<>42/x16<>45/x16<>47/x16<>50/x16<>52/x16<>54; [Skip beneficial spells]
!!if&y3>=0/y3<=41;
  !!BMy3:Gx16/?y1/?y2;                  [check for active spells Duration Y1 and Power Y2 and Type Y3]
  !!BMy3:T?y4;
  !!SN:W^Hero%X1_Monster%Y3_Spell%X16_Duration^/y1; [Save in Var]
  !!SN:W^Hero%X1_Monster%Y3_Spell%X16_Power^/y2; [Save in Var]
  !!SN:W^Hero%X1_Monster%Y3_Spell%X16_Type^/y4; [Save in Var]
!!en;
!!en;

********************************************************************************
!?FU(OnBattleReplay);                   [Reset variables for Druid Concentration Perk]
!!BH0:N?y10;
!!SN:W^Hero%Y10_Number_Saved_Side0_Replay^/?y1;
!!SN:W^Hero%Y10_Number_Saved_Side0^/y1;
!!SN:W^Hero%Y10_Number_Saved_Side1_Replay^/?y1;
!!SN:W^Hero%Y10_Number_Saved_Side1^/y1;

!!BH1:N?y11;
!!SN&y11>=0:W^Hero%Y11_Number_Saved_Side0_Replay^/?y1;
!!SN&y11>=0:W^Hero%Y11_Number_Saved_Side0^/y1;
!!SN&y11>=0:W^Hero%Y11_Number_Saved_Side1_Replay^/?y1;
!!SN&y11>=0:W^Hero%Y11_Number_Saved_Side1^/y1;

!!SN:W^Remember_Spells_Counter0_Replay^/?y1; [Set Counter to zero]
!!SN:W^Remember_Spells_Counter0^/y1;    [Set Counter to zero]


**Battle Start Handling**
!?FU(OnCombatRound)&v997=0;
!!BU:T?y99;                             [Check battle has tactics phase]
!!VRy99&y99=1:S3;                       [Set duration of spells in new combat round with tactics]
!!VRy99&y99=0:S2;

!!SN:W^Remember_Spells_Counter0^/?y1;   [Set Counter to zero]
!!SN:W^Remember_Spells_Counter0_Replay^/y1; [Set Counter to zero]
!!SN:W^Remember_Spells_Counter0^/0;     [Set Counter to zero]

!!BH0:N?y10;
!!HEy10:O?y30;
!!SN:W^RememberSpells_Attacker_Owner_Start^/y30;
!!BH1:N?y11;
!!HEy11&y11>=0:O?y31;
!!SN&y11>=0:W^RememberSpells_Defender_Owner_Start^/y31;

!!SN:W^Hero%Y10_Number_Saved_Side0^/?y1;
!!SN:W^Hero%Y10_Number_Saved_Side0_Replay^/y1;
!!if&y1>=0;
!!SN:W^Master_Mage_Hero%Y10^/?y40;
!!SN:W^Master_Adventurer_Hero%Y10^/?y41;
!!VRy12&y40=1/y41=1:S3;
!!DO(Remember_Spells_Fkt_3)/0/8/1&y1=y10:Py1/1/y12/y99; [Buff Attacker]
!!SN:W^Hero%Y10_Number_Saved_Side0^/-1;
!!SN:W^Hero%Y10_Number_Saved_Side1^/-1;
!!en;

!!SN:W^Hero%Y10_Number_Saved_Side1^/?y1;
!!SN:W^Hero%Y10_Number_Saved_Side1_Replay^/y1;
!!if&y1>=0;
!!SN:W^Master_Mage_Hero%Y10^/?y40;
!!SN:W^Master_Adventurer_Hero%Y10^/?y41;
!!VRy12&y40=1/y41=1:S3;
!!DO(Remember_Spells_Fkt_3)/0/8/1&y1=y10:Py1/2/y12/y99; [Buff Attacker]
!!SN:W^Hero%Y10_Number_Saved_Side0^/-1;
!!SN:W^Hero%Y10_Number_Saved_Side1^/-1;
!!en;

!!SN&y11>=0:W^Hero%Y11_Number_Saved_Side0^/?y1;
!!SN&y11>=0:W^Hero%Y11_Number_Saved_Side0_Replay^/y1;
!!if&y1>=0;
!!SN:W^Master_Mage_Hero%Y11^/?y40;
!!SN:W^Master_Adventurer_Hero%Y11^/?y41;
!!VRy12&y40=1/y41=1:S3;
!!DO(Remember_Spells_Fkt_3)/21/29/1&y1=y11:Py1/3/y12/y99; [Buff Defender]
!!SN:W^Hero%Y11_Number_Saved_Side0^/-1;
!!SN:W^Hero%Y11_Number_Saved_Side1^/-1;
!!en;

!!SN&y11>=0:W^Hero%Y11_Number_Saved_Side1^/?y1;
!!SN&y11>=0:W^Hero%Y11_Number_Saved_Side1_Replay^/?y1;
!!if&y1>=0;
!!SN:W^Master_Mage_Hero%Y11^/?y40;
!!SN:W^Master_Adventurer_Hero%Y11^/?y41;
!!VRy12&y40=1/y41=1:S3;
!!DO(Remember_Spells_Fkt_3)/21/29/1&y1=y11:Py1/4/y12/y99; [Buff Defender]
!!SN:W^Hero%Y11_Number_Saved_Side0^/-1;
!!SN:W^Hero%Y11_Number_Saved_Side1^/-1;
!!en;


**Choose the correct hero and side**
!?FU(Remember_Spells_Fkt_3);

!!if&x2=1;
!!SN:W^Creature_Numerator1^/x16;
!!DO(Remember_Spells_Fkt_4)/27/58/1:Px1/1/x3/x4;
!!en;

!!if&x2=2;
!!VRy1:Sx16;
!!VRy1:+21;
!!SN:W^Creature_Numerator1^/y1;
!!DO(Remember_Spells_Fkt_4)/27/58/1:Px1/2/x3/x4;
!!en;

!!if&x2=4;
!!SN:W^Creature_Numerator1^/x16;
!!DO(Remember_Spells_Fkt_4)/27/58/1:Px1/3/x3/x4;
!!en;

!!if&x2=3;
!!VRy1:Sx16;
!!VRy1:-21;
!!SN:W^Creature_Numerator1^/y1;
!!DO(Remember_Spells_Fkt_4)/27/58/1:Px1/4/x3/x4;
!!en;


!?FU(Remember_Spells_Fkt_4);

!!if&x2=1;                             [Attacker 1]
!!SN:W^Creature_Numerator1^/?y3;
!!if&y3>=0/y3<=41;
!!BMy3:N?y20;                           [Check Number]
!!BMy3:T?y21;                           [Check crreature Type]
!!if&x16<>35/x16<>37/x16<>38/x16<>39/x16<>40/x16<>42/x16<>45/x16<>47/x16<>50/x16<>52/x16<>54;
!!SN:W^Hero%X1_Monster%Y3_Spell%X16_Duration^/?y1;
!!SN:W^Hero%X1_Monster%Y3_Spell%X16_Power^/?y2;
!!SN:W^Hero%X1_Monster%Y3_Spell%X16_Type^/?y4;
!!if&y20>0/y4=y21/y1>0/y1<100;         [Meet right conditions Buff duration must be smaller than 100]
!!SN:W^Creature_Stack_Choice1^/?y10;
!!SN:W^Creature_Stack_Choice2^/?y11;
!!SN:W^Creature_Stack_Choice3^/?y12;
!!if|y3=y10/y3=y11/y3=y12;
!!BMy3:Mx16/x4/y2;                      [Apply spells]
!!VRz-1:S^PRAYER.wav^;                  [Play prayer sound if at least one stack transferd buffs]
!!SN&^battle_isVisible^:Pz-1;
!!en;
!!en;
!!en;
!!en;
!!en;

!!if&x2=2;                             [Attacker 2]
!!SN:W^Creature_Numerator1^/?y3;
!!if&y3>=0/y3<=41;
!!if&x16<>35/x16<>37/x16<>38/x16<>39/x16<>40/x16<>42/x16<>45/x16<>47/x16<>50/x16<>52/x16<>54;
!!SN:W^Hero%X1_Monster%Y3_Spell%X16_Duration^/?y1;
!!SN:W^Hero%X1_Monster%Y3_Spell%X16_Power^/?y2;
!!SN:W^Hero%X1_Monster%Y3_Spell%X16_Type^/?y4;
!!VRy3:-21;
!!BMy3:N?y20;
!!BMy3:T?y21;
!!if&y20>0/y4=y21/y1>0/y1<100;
!!SN:W^Creature_Stack_Choice1^/?y10; !!VRy10:-21;
!!SN:W^Creature_Stack_Choice2^/?y11; !!VRy11:-21;
!!SN:W^Creature_Stack_Choice3^/?y12; !!VRy12:-21;
!!if|y3=y10/y3=y11/y3=y12;
!!BMy3:Mx16/x4/y2;                      [Apply spells]
!!VRz-1:S^PRAYER.wav^;
!!SN&^battle_isVisible^:Pz-1;
!!en;
!!en;
!!en;
!!en;
!!en;

!!if&x2=3;                             [Defender 1]
!!SN:W^Creature_Numerator1^/?y3;
!!if&y3>=0/y3<=41;
!!BMy3:N?y20;
!!BMy3:T?y21;
!!if&x16<>35/x16<>37/x16<>38/x16<>39/x16<>40/x16<>42/x16<>45/x16<>47/x16<>50/x16<>52/x16<>54;
!!SN:W^Hero%X1_Monster%Y3_Spell%X16_Duration^/?y1;
!!SN:W^Hero%X1_Monster%Y3_Spell%X16_Power^/?y2;
!!SN:W^Hero%X1_Monster%Y3_Spell%X16_Type^/?y4;
!!if&y20>0/y4=y21/y1>0/y1<100;
!!SN:W^Creature_Stack_Choice1^/?y10;
!!SN:W^Creature_Stack_Choice2^/?y11;
!!SN:W^Creature_Stack_Choice3^/?y12;
!!if|y3=y10/y3=y11/y3=y12;
!!BMy3:Mx16/x4/y2;                      [Apply spells]
!!VRz-1:S^PRAYER.wav^;
!!SN&^battle_isVisible^:Pz-1;
!!en;
!!en;
!!en;
!!en;
!!en;

!!if&x2=4;                             [Defender 2]
!!SN:W^Creature_Numerator1^/?y3;
!!if&y3>=0/y3<=41;
!!if&x16<>35/x16<>37/x16<>38/x16<>39/x16<>40/x16<>42/x16<>45/x16<>47/x16<>50/x16<>52/x16<>54;
!!SN:W^Hero%X1_Monster%Y3_Spell%X16_Duration^/?y1;
!!SN:W^Hero%X1_Monster%Y3_Spell%X16_Power^/?y2;
!!SN:W^Hero%X1_Monster%Y3_Spell%X16_Type^/?y4;
!!VRy3:+21;
!!BMy3:N?y20;
!!BMy3:T?y21;
!!if&y20>0/y4=y21/y1>0/y1<100;
!!SN:W^Creature_Stack_Choice1^/?y10; !!VRy10:+21;
!!SN:W^Creature_Stack_Choice2^/?y11; !!VRy11:+21;
!!SN:W^Creature_Stack_Choice3^/?y12; !!VRy12:+21;
!!if|y3=y10/y3=y11/y3=y12;
!!BMy3:Mx16/x4/y2;                      [Apply spells]
!!VRz-1:S^PRAYER.wav^;
!!SN&^battle_isVisible^:Pz-1;
!!en;
!!en;
!!en;
!!en;
!!en;


!?FU(Remember_Spells_Fkt_0);
!!SN:W^Hero%X16_Number_Saved_Side0^/-1;
!!SN:W^Hero%X16_Number_Saved_Side1^/-1;



********************************************************************************


                      Starting Commander/Heroes changes Section


********************************************************************************
!?PI;
*!DO(AC_Function_25)/0/155/1:P;         [loop through heroes]
Disabled because it confuses people

!?FU(AC_Function_25);

!!SN:W^Zulu_Mod_On^/?y79; Check for Zulu Mod Active
!!if&y79=0;
!!if|x16=127/x16=8/x16=106/x16=123/x16=4/x16=122/x16=6/x16=54/x16=65/x16=81/x16=130;
;Tiva
;Rion, Dessa, Verdish
;Lord Haart, Voy
;Christian, Torosar, Pyre, Vokial, Arlach, Gerwulf, Pasis, Ignissa

!!VRy11|x16=127:S0;                     [Commander Paladin]
!!VRy11|x16=8/x16=106/x16=123:S1;       [Commander Hierophant]
!!VRy11|x16=4/x16=122:S5;               [Commander Brute]
!!VRy11|x16=6/x16=36/x16=54/x16=65/x16=81/x16=130:S6; [Commander Ogre Leader]

!!COx16:E0;                             [Remove Commander]
!!COx16:Ty11;                           [Set new Commander type]
!!COx16:E1;                             [Enable Commander]
!!COx16:D0;                             [Alive Commander]
!!en;
!!en;

!!SN:W^Zulu_Mod_On^/?y79; Check for Zulu Mod Active
!!if&y79=1;
!!if|x16=127/x16=8/x16=106/x16=123/x16=4/x16=122/x16=6/x16=54/x16=65/x16=81;
;Tiva
;Rion, Dessa, Verdish
;Lord Haart, Voy
;Christian, Torosar, Pyre, Vokial, Arlach, Gerwulf, Pasis, Ignissa

!!VRy11|x16=127:S0;                     [Commander Paladin]
!!VRy11|x16=8/x16=106/x16=123:S1;       [Commander Hierophant]
!!VRy11|x16=4/x16=122:S5;               [Commander Brute]
!!VRy11|x16=6/x16=36/x16=54/x16=65/x16=81/x16=130:S6; [Commander Ogre Leader]

!!COx16:E0;                             [Remove Commander]
!!COx16:Ty11;                           [Set new Commander type]
!!COx16:E1;                             [Enable Commander]
!!COx16:D0;                             [Alive Commander]
!!en;
!!en;


********************************************************************************

Change Heroes Speciali Descriptions

********************************************************************************


!?CM2&1000;                             [Show Correct Info for Wisdom Specialists]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]
!!if|v3=512/v3=0;                       [if right or left click]
!!HE-1:N?y6;                            [Get current hero #]
!!HEy6:X?y11/?y12/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!HEy6:B0/?z-1;
!!if&y12=7/y11=0;                       [if Wisdom]
!!HEy6:E?y47/?y48/1;                    [Check hero Level]
!!VRy48:*1;                             [3% extra Growth per Hero Level]

!!SN:T^AC_Misc.Wisdom Specialist^/?z2; !!SN:Iz2/?z2;
!!FU(ACM_GetDialogMessageType):Pi^mouse_action^/?y30;
!!IF:Q1/20/26/y30/z2;                     [show description for Hero Speciality when right click]
!!CM:R0;                                [disable standard reaction]
!!en;
!!en;


!?CM2&1000;                             [Show Correct Info for Scholar Specialists]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]
!!if|v3=512/v3=0;                       [if right or left click]
!!HE-1:N?y6;                            [Get current hero #]
!!HEy6:B0/?z-1;
!!HEy6:X?y11/?y12/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!if&y12=18/y11=0;                     [if Scholar]
!!HEy6:E?y47/?y48/1;                    [Check hero Level]
!!VRy48::5+1;

!!SN:T^AC_Misc.Scholar Specialist^/?z2; !!SN:Iz2/?z2;
!!FU(ACM_GetDialogMessageType):Pi^mouse_action^/?y30;
!!IF:Q1/20/59/y30/z2;                     [show description for Hero Speciality when right click]
!!CM:R0;                                [disable standard reaction]
!!en;
!!en;


!?CM2&1000;                             [Show Correct Info for Pathfinding Specialists]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]
!!if|v3=512/v3=0;                       [if right or left click]
!!HE-1:N?y6;                            [Get current hero #]
!!HEy6:B0/?z-1;
!!HEy6:X?y11/?y12/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!if&y12=0/y11=0;                      [if Pathfinding]
!!HEy6:E?y46/?y48/1;                    [Check hero Level]
!!VRy49:Sy48:2 +5;
!!VRy47:Sy48:15+1;

!!SN:T^AC_Misc.Pathfinding Specialist^/?z2; !!SN:Iz2/?z2;
!!FU(ACM_GetDialogMessageType):Pi^mouse_action^/?y30;
!!IF:Q1/20/5/y30/z2;                      [show description for Hero Speciality when right click]
!!CM:R0;                                [disable standard reaction]
!!en;
!!en;


!?CM2&1000;                             [Show Correct Info for Learning Specialists]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]
!!if|v3=512/v3=0;                       [if right or left click]
!!HE-1:N?y6;                            [Get current hero #]
!!HEy6:B0/?z-1;
!!HEy6:X?y11/?y12/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!if&y12=21/y11=0;                      [if Learning]

!!HEy6:R2/?y75;
!!HEy6:E?y47/?y48/1;                    [Check hero Level]

!!FU(Skill_Value_Database):Py6/y12/y48/?y71; [Pass Hero Number, Skill, Hero Level, Return Value]

!!SN&y75=0:T^AC_Misc.his^/?z-5;
!!SN&y75=1:T^AC_Misc.her^/?z-5;

!!SN:T^AC_Misc.Learning Specialist^/?z2; !!SN:Iz2/?z2;
!!FU(ACM_GetDialogMessageType):Pi^mouse_action^/?y30;
!!IF:Q1/20/68/y30/z2;                     [show description for Hero Speciality when right click]
!!CM:R0;                                [disable standard reaction]
!!en;
!!en;



!?CM2&1000;                             [Show Correct Info for Crit Damage Specialists]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]
!!if|v3=512/v3=0;                       [if right or left click]
!!HE-1:N?y6;                            [Get current hero #]
!!HEy6:B0/?z-1;
!!HEy6:X?y11/?y12/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!if&y12=57/y11=3;                     [if Crit Damage]
!!HEy6:E?y46/?y47/1;                    [Check hero Level]

!!SN:T^AC_Misc.Crit Damage Specialist^/?z2; !!SN:Iz2/?z2;
!!FU(ACM_GetDialogMessageType):Pi^mouse_action^/?y30;
!!IF:Q1/9/57/y30/z2;                      [show description for Hero Speciality when right click]
!!CM:R0;                                [disable standard reaction]
!!en;
!!en;



!?CM2&1000;                             [Show Correct Info for Firebird Specialists]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]

!!if|v3=512/v3=0;                       [if right or left click]
!!HE-1:N?y6;                            [Get current hero #]
!!HEy6:B0/?z-1;
!!HEy6:X?y11/?y12/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!if&y6=130;                            [if Firebird/Ignissa]
!!CM:R0;                                [disable standard reaction]
!!HEy6:E?y46/?y47/1;                    [Check hero Level]
!!VRy47:*2-52;                          [current bonus, starts at -50 HP]

!!SN:T^AC_Misc.Firebird Specialist^/?z2; !!SN:Iz2/?z2;
!!FU(ACM_GetDialogMessageType):Pi^mouse_action^/?y30;
!!IF:Q1/21/130/y30/z2;                    [show description for Hero Speciality when right click]
!!en;
!!en;


!?CM2&1000;                             [Show Correct Info for First Aid Specialists]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]

!!if|v3=512/v3=0;                       [if right or left click]
!!HE-1:N?y6;                            [Get current hero #]
!!HEy6:B0/?z-1;
!!HEy6:X?y11/?y12/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!if&y12=27/y11=0;                      [if First Aid]
!!HEy6:E?y46/?y47/1;                    [Check hero Level]
!!VRy47:*1+10;
!!VRy48:Sy47:15+1;                      [HP increase]

!!SN:T^AC_Misc.First Aid Specialist^/?z2; !!SN:Iz2/?z2;
!!FU(ACM_GetDialogMessageType):Pi^mouse_action^/?y30;
!!IF:Q1/20/86/y30/z2;                     [show description for Hero Speciality when right click]
!!CM:R0;                                [disable standard reaction]
!!en;
!!en;


!?CM2&1000;                             [Show Correct Info for Estate Specialists]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]
!!if|v3=512/v3=0;                       [if right or left click]
!!HE-1:N?y6;                            [Get current hero #]
!!HEy6:B0/?z-1;
!!HEy6:X?y11/?y12/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!if&y12=13/y11=0;                      [if Estates]
!!HEy6:E?y47/?y48/1;                    [Check hero Level]

!!FU(Skill_Value_Database):Py6/y12/y48/?y71; [Pass Hero Number, Skill, Hero Level, Return Value]
!!VRy50:Sy48:10+1;                      [Give +1 +Level/10 extra resources per day]
!!SN:T^AC_Misc.Estates Specialist^/?z2; !!SN:Iz2/?z2;
!!FU(ACM_GetDialogMessageType):Pi^mouse_action^/?y30;

!!IF:Q1/20/44/y30/z2;                     [show description for Hero Speciality when right click]
!!CM:R0;                                [disable standard reaction]
!!en;
!!en;


!?CM2&1000;                             [Show Correct Info for Diplomacy Specialists]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]
!!if|v3=512/v3=0;                       [if right or left click]
!!HE-1:N?y6;                            [Get current hero #]
!!HEy6:X?y11/?y12/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!if&y12=4/y11=0;                       [if Diplomacy]
!!CM:R0;                                [disable standard reaction]
!!HEy6:E?y46/?y47/1;                    [Check hero Level]
!!VRy48:Sy47:4+1;
!!VRy49:Sy47:10+1;
!!VRy50:Sy47:2+1;
!!HEy6:B0/?z-1;

!!SN:T^AC_Misc.Diplomacy Specialist^/?z2; !!SN:Iz2/?z2;
!!FU(ACM_GetDialogMessageType):Pi^mouse_action^/?y30;
!!IF:Q1/20/17/y30/z2;                     [show description for Hero Speciality when right click]
!!en;
!!en;


!?CM2&1000;                             [Show Correct Info for Nobility Specialists]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]
!!if|v3=512/v3=0;                       [if right or left click]
!!HE-1:N?y6;                            [Get current hero #]
!!HEy6:X?y11/?y12/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!if&y12=5/y11=0;                       [if Nobility]
!!CM:R0;                                [disable standard reaction]
!!HEy6:E?y47/?y48/1;                    [Check hero Level]
!!VRy48:*3;                             [3% extra Growth per Hero Level]
!!HEy6:B0/?z-1;

!!SN:T^AC_Misc.Nobility Specialist^/?z2; !!SN:Iz2/?z2;
!!FU(ACM_GetDialogMessageType):Pi^mouse_action^/?y30;
!!IF:Q1/20/20/y30/z2;                     [show description for Hero Speciality when right click]
!!en;
!!en;


!?CM2&1000;                             [Show Correct Info for Artillery Specialists]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]
!!if|v3=512/v3=0;                       [if right or left click]
!!HE-1:N?y6;                            [Get current hero #]
!!FU&y6=118:E;                          [Gerwulf is now Warfare Specialist]
!!if|y6=6/y6=97/y6=54/y6=81/y6=118;     [if Artillery]
!!CM:R0;                                [disable standard reaction]
!!HEy6:E?y47/?y48/1;                    [Check hero Level]
!!VRy48:Sy48:20+1;                      [Extra Shots]
!!HEy6:B0/?z-1;

!!SN:T^AC_Misc.Artillery Specialist^/?z2; !!SN:Iz2/?z2;
!!FU(ACM_GetDialogMessageType):Pi^mouse_action^/?y30;
!!IF:Q1/20/65/y30/z2;                     [show description for Hero Speciality when right click]
!!en;
!!en;


!?CM2&1000;                             [Show Correct Info for Warfare Specialists]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]
!!if|v3=512/v3=0;                       [if right or left click]
!!HE-1:N?y6;                            [Get current hero #]

!!SN:W^Zulu_Mod_On^/?y79;
!!if&y79=0;
  !!if|y6=131/y6=118;                   [if Warfare]
    !!CM:R0;                            [disable standard reaction]
    !!HEy6:E?y40/?y41/1;                [If Hero Lacus/Gerwulf or Warfare Specialist]
    !!VRy42:Sy41:7;                     [Every 7 hero Levels]
    !!VRy9:+y42;
    !!VRy13&y41>=10:+1;                 [+1 Damage at Level 10]
    !!VRy10&y41>=20:+1;                 [+1 Speed at Level 20]
    !!HEy6:B0/?z-1;

    !!SN:T^AC_Misc.Warfare Specialist^/?z2; !!SN:Iz2/?z2;
    !!FU(ACM_GetDialogMessageType):Pi^mouse_action^/?y30;
    !!IF:Q1/20/62/y30/z2;                 [show description for Hero Speciality when right click]
  !!en;
!!en;

!!SN:W^Zulu_Mod_On^/?y79;
!!if&y79=1;
  !!if|y6=131;                          [if Warfare]
    !!CM:R0;                            [disable standard reaction]
    !!HEy6:E?y40/?y41/1;                [If Hero Lacus/Gerwulf or Warfare Specialist]
    !!VRy42:Sy41:7;                     [Every 7 hero Levels]
    !!VRy9:+y42;
    !!VRy13&y41>=10:+1;                 [+1 Damage at Level 10]
    !!VRy10&y41>=20:+1;                 [+1 Speed at Level 20]
    !!HEy6:B0/?z-1;

    !!SN:T^AC_Misc.Warfare Specialist^/?z2; !!SN:Iz2/?z2;
    !!FU(ACM_GetDialogMessageType):Pi^mouse_action^/?y30;
    !!IF:Q1/20/62/y30/z2;                 [show description for Hero Speciality when right click]
  !!en;
!!en;
!!en;


*!if&i^Zulu_Mod_On^=0;
  *!if&y6=129;                         [if 129 Thunar]
    *!CM:R0;                            [disable standard reaction]
    *!HEy6:B0/?z-1;
    *!SN:T^AC_Misc.Summoning Earth Specialist^/?z2; *!SN:Iz2/?z2;
    *!IF:Q1/9/67/4/z2;                  [show description for Hero Speciality when right click]
  *!en;
*!en;


!?CM2&1000;                             [Show Correct Info for Summoner Specialists]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]
!!if|v3=512/v3=0;                       [if right or left click]
  !!HE-1:N?y6;                          [Get current hero #]
  !!if&i^Zulu_Mod_On^=0;
    !!if|y6=88/y6=129;                  [if 129 Thunar or Alamar]
      !!CM:R0;                          [disable standard reaction]
      !!HEy6:B0/?z-1;                   [Get hero name]
      !!HEy6:E?y40/?y41/1;              [Get Hero level]

      !!VRy42:S25; !!VRy43:Sy41*3; !!VRy42:+y43; [Set value to show 25+3*H_Lvl]
      !!SN:T^AC_Misc.Summoning Earth Specialist^/?z2/^Health^/y42; !!SN:Iz2/?z2;
      !!FU(ACM_GetDialogMessageType):Pi^mouse_action^/?y30;
      !!IF&y6=88:Q1/9/69/y30/z2;          [show description for Hero Speciality when right click]
      !!IF&y6=129:Q1/9/67/y30/z2;         [show description for Hero Speciality when right click]
    !!en;
  !!en;

  !!if&y6=25;                           [if 25 Uland]
    !!CM:R0;                            [disable standard reaction]
    !!HEy6:B0/?z-1;
    !!SN:T^AC_Misc.Cure Specialist^/?z2; !!SN:Iz2/?z2;
    !!FU(ACM_GetDialogMessageType):Pi^mouse_action^/?y30;
    !!IF:Q1/9/37/y30/z2;                  [show description for Hero Speciality when right click]
  !!en;

  !!if&y6=40;                           [if 40 Astral]
    !!CM:R0;                            [disable standard reaction]
    !!HEy6:B0/?z-1;
    !!SN:T^AC_Misc.Hypnotize Specialist^/?z2; !!SN:Iz2/?z2;
    !!FU(ACM_GetDialogMessageType):Pi^mouse_action^/?y30;
    !!IF:Q1/9/60/y30/z2;                  [show description for Hero Speciality when right click]
  !!en;
!!en;


!?FU(ACM_GetDialogMessageType);
!#VA(mouseAction:x) (msgType:x);

!!if|(mouseAction)=(MOUSE_LMB_PRESSED)/(MOUSE_LMB_RELEASED);
  !!VR(msgType):S(MSG_TYPE_MES);
!!el;
  !!VR(msgType):S(MSG_TYPE_POPUP);
!!en;


!?BG0&1000;
!!FU:E;                                 [Disabled]
!!if&i^Zulu_Mod_On^=0;
  !!BG:H?y1;                            [Current attacking side]
  !!BG:A?y2;
  !!BG:S?y3;                            [y2 now contains spell number]
  !!SN&y1=129/y2=1/y3=67:W^Thunar_Has_Cast_Summon^/1;
!!en;


!?FU(OnAfterBattleUniversal)&1000;
!!HE129:O?y1;
!!SN&y1=-1:W^Thunar_Has_Cast_Summon^/0;
!!FU&y1=-1:E;                           [Exit if Thunar died in that fight]
!!SN:W^Thunar_Has_Cast_Summon^/?y1;
!!if&y1=1;
  !!SN:W^Thunar_Has_Cast_Summon^/0;
  !!HE129:F?y10/?y11/?y12/?y13;
  !!VRy5:Sy12:7+R3+1;
  !!HE129&1000:C2/113/y5/1;             [Add creatures to Hero Army]
  !!UN&1000:R1;
!!en;

!?CM2&1000;                             [Show Correct Info for ordanary Secondary Skill Specialists]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]
!!if|v3=512/v3=0;                       [if right or left click]
!!HE-1:N?y6;                            [Get current hero #]
!!HEy6:X?y11/?y12/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!FU&y11<>0:E;
!!if|y12=1/y12=2/y12=3/y12=6/y12=9/y12=10/y12=12/y12=22/y12=23/y12=24/y12=26; [Exceptions for heroes who have other specialities]
!!CM:R0;                                [disable standard reaction]

!!SN&y12=1:T^AC_Misc.Archery^/?z-3;
!!SN&y12=2:T^AC_Misc.Logistics^/?z-3;
!!SN&y12=3:T^AC_Misc.Scouting^/?z-3;
!!SN&y12=6:T^AC_Misc.Leadership^/?z-3;
!!SN&y12=9:T^AC_Misc.Luck^/?z-3;
!!SN&y12=10:T^AC_Misc.Ballistics^/?z-3;
!!SN&y12=12:T^AC_Misc.Necromancy^/?z-3;
!!SN&y12=13:T^AC_Misc.Estates^/?z-3;
!!SN&y12=19:T^AC_Misc.Warfare^/?z-3;
!!SN&y12=22:T^AC_Misc.Offense^/?z-3;
!!SN&y12=23:T^AC_Misc.Armorer^/?z-3;
!!SN&y12=24:T^AC_Misc.Intelligence^/?z-3;
!!SN&y12=26:T^AC_Misc.Resistance^/?z-3;

!!HEy6:R2/?y75;
!!HEy6:B0/?z-1;
!!HEy6:E?y47/?y48/1;                    [Check hero Level]

!!FU(Skill_Value_Database):Py6/y12/y48/?y71; [Pass Hero Number, Skill, Hero Level, Return Value]

!!SN&y75=0:T^AC_Misc.his^/?z-5;
!!SN&y75=1:T^AC_Misc.her^/?z-5;

!!SN:T^AC_Misc.Specialist 1^/?z2;       [The rest]

!!VRy49:Sy48*4+75;                      [Scouting Specialist]
!!SN&y12=3:T^AC_Misc.Specialist 2^/?z2/^bonus^/y49; [Scouting]

!!SN&y12=24:T^AC_Misc.Specialist 3^/?z2;[Intelligence]

!!VRy49:Sy48+10;
!!SN&y6=127:T^AC_Misc.Luck_Specialists^/?z2; [Luck]

!!SN:Iz2/?z2;
!!FU(ACM_GetDialogMessageType):Pi^mouse_action^/?y30;
!!IF:M1/y30/z2;
!!en;
!!en;


!?CM2&1000;                             [Show Correct Info for Gold Secondary Skill Specialists]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]
!!if|v3=512/v3=0;                       [if right or left click]
!!HE-1:N?y6;                            [Get current hero #]

!!SN:W^Zulu_Mod_On^/?y79;
!!if&y79=0;
!!if|y6=15/y6=47/y6=143/y6=18/y6=52/y6=79; [Caitlin, Aine, Grindan, Jenova, Octavia, Nagash]
!!CM:R0;                                [disable standard reaction]

!!HEy6:R2/?y70;
!!HEy6:B0/?z-1;
!!HEy6:E?y47/?y48/1;                    [Check hero Level]
!!VRy50:Sy48:10+1;
!!SN:T^AC_Misc.Economy Specialist^/?z2; !!SN:Iz2/?z2;
!!FU(ACM_GetDialogMessageType):Pi^mouse_action^/?y30;
!!IF:M1/y30/z2;
!!en;
!!en;

!!SN:W^Zulu_Mod_On^/?y79;
!!if&y79=1;
!!if|y6=15/y6=47/y6=18/y6=52;           [Caitlin, Aine, Grindan, Jenova, Octavia,]
!!CM:R0;                                [disable standard reaction]
!!HEy6:R2/?y70;
!!HEy6:B0/?z-1;
!!HEy6:E?y47/?y48/1;                    [Check hero Level]
!!VRy50:Sy48:10+1;
!!SN:T^AC_Misc.Economy Specialist^/?z2; !!SN:Iz2/?z2;
!!FU(ACM_GetDialogMessageType):Pi^mouse_action^/?y30;
!!IF:M1/y30/z2;
!!en;
!!en;
!!en;


!?CM2&1000;                             [Show Correct Info for Commander Specialists]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]
!!if|v3=512/v3=0;                       [if right or left click]
  !!HE-1:N?y6;                          [Get current hero #]
  !!HEy6:X?y11/?y12/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
  !!FU&y11<>3:E;                        [Changed to spell to prevent default bonus to these creatures]

  !!if|y6=4/y6=36/y6=105/y6=128;        [Lord Haart, Torosar, Vey, Pasis]
    !!CM:R0;                            [disable standard reaction]
    !!HEy6:E?y47/?y48/1;                [Check hero Level]
    !!HEy6:R2/?y70;
    !!HEy6:B0/?z-1;
    !!VRy50:Sy48:20+1;                  [+1 Speed per 20 level]

    !!if&y6=4;                          [Lord Haart has increased regeneration ability]
      !!VRy53:Sy48:2+5;                 [additional regeneration]
    !!en;

    !!if&y6=36;                         [Torosar has increased chance to block physical damage]
      !!VRy54:Sy48:2+30 F30/100;        [chance to block]
      !!VRy53:Sy48:2+50 F50/95;         [damage block]
    !!en;

    !!if&y6=105;                        [Vey has increased strikes all around damage]
      !!VRy53:Sy48*2+73;                [surround damage]
    !!en;    

    !!if&y6=128;                        [Pasis has increased max kill counter]
      !!VRy53:Sy48;                     [kill count]
    !!en;

    *!VRy51:Sy48*3:2 +3;                [+1,5% Damage per Level]
    *!VRy52:Sy48+4;                     [+1% per Health per Level +4%]
    !!SN&y6=4:T^AC_Misc.Commander Specialist_1^/?z2; !!SN:Iz2/?z2; [Lord Haart]
    !!SN&y6=36:T^AC_Misc.Commander Specialist_2^/?z2; !!SN:Iz2/?z2; [Torosar]
    !!SN&y6=105:T^AC_Misc.Commander Specialist_3^/?z2; !!SN:Iz2/?z2; [Vey]
    !!SN&y6=128:T^AC_Misc.Commander Specialist_4^/?z2; !!SN:Iz2/?z2;
    !!FU(ACM_GetDialogMessageType):Pi^mouse_action^/?y30; [Pasis]
    !!IF:M1/y30/z2;
  !!en;
!!en;


!?CM2&1000;                             [Show Correct Info for Creature Specialists]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]
!!if|v3=512/v3=0;                       [if right or left click]
!!HE-1:N?y6;                            [Get current hero #]
!!HEy6:X?y11/?y12/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!FU&y11<>1:E;
!!FU|y12=130/y12=146:E;                 [Exceptions for heroes who have other specialities]

!!SN:W^Zulu_Mod_On^/?y79;
!!if&y79=0;
!!FU|y6=36/y6=48/y6=105/y6=128:E;       [Exceptions for heroes who have other specialities]
!!en;

!!if&y79=1;
!!FU|y6=36/y6=48/y6=105:E;              [Exceptions for heroes who have other specialities]
!!en;

!!CM:R0;                                [disable standard reaction]
!!HEy6:R2/?y70;
!!HEy6:B0/?z-1;
!!HEy6:E?y47/?y48/1;                    [Check hero Level]
!!SN&y70=0:T^AC_Misc.his^/?z-5;
!!SN&y70=1:T^AC_Misc.her^/?z-5;

!!SN:W^Typhon_Third_Upgrade_Mod_Active^/?y1; [Check for Third Upgrade Mod]
!!FU(Set_Creature_Upgrades_TUM)&y1=1:Py12/y6/?y16/?y17;
!!FU(Set_Creature_Upgrades_ACM)&y1=0:Py12/y6/?y16/?y17;

!!UN:N3/z-3/y12/1;                      [Normal Creature]
!!UN:N3/z-4/y16/1;                      [First Upgrade]
!!UN&y1=1:N3/z-6/y17/1;                 [Second Upgrade]

!!MA:Ly12/?y14;                         [Get creature level]
!!FU(ACM_GetSpecMonsterStats):Py6/y12/?y50/?y53/?y51/?y52;

!!SN&y1=0:T^AC_Misc.Creature Specialist_0^/?z1/^level^/y14/^attack^/y50/^defense^/y53/^damage^/y51/^health^/y52; !!SN:Iz1/?z1; [Change text if Necessary]
!!SN&y1=1:T^AC_Misc.Creature Specialist_1^/?z1/^level^/y14/^attack^/y50/^defense^/y53/^damage^/y51/^health^/y52; !!SN:Iz1/?z1; [Change Text if TUM is active]
!!FU(ACM_GetDialogMessageType):Pi^mouse_action^/?y30;
!!IF:M1/y30/z1;
!!en;

!?FU(ACM_GetNativeMonSpecBonus);
!#VA(heroLevel:x) (mon:x) (bonusAtk:x) (bonusDef:x);

!!MA:L(mon)/?(monLevel:y) A(mon)/?(attack:y) D(mon)/?(defense:y);
!!VR(monLevel):+1;
!!VR(heroLevelFloat:e):S(heroLevel);
!!VR(monLevelFloat:e):S(monLevel);

!!VR(bonusFloat:e):S1 :20;
!!VR(totalBonusFloat:e):S(heroLevelFloat) :(monLevelFloat) *(bonusFloat);

!!VR(attackFloat:e):S(attack);
!!VR(bonusAtkFloat:e):S(totalBonusFloat) *(attackFloat);

!!VR(defenseFloat:e):S(defense);
!!VR(bonusDefFloat:e):S(totalBonusFloat) *(defenseFloat);

!!VR(bonusAtk):S(bonusAtkFloat) +1;
!!VR(bonusDef):S(bonusDefFloat) +1;


*Extension Heroes improved Specialists Description
!?CM2;                                  [Show Correct Info for Artillery Specialists]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]
!!if|v3=512/v3=0;                       [if right or left click]
!!HE-1:N?y6;                            [Get current hero #]
!!if|y6=144/y6=147/y6=148/y6=151/y6=153;[if extension hero]
!!CM:R0;                                [disable standard reaction]
!!HEy6:B0/?z-1;
!!SN&y6=144:T^AC_Misc.SirMullich_Specialist^/?z2; !!SN:Iz2/?z2;
!!SN&y6=147:T^AC_Misc.Dracon_Specialist^/?z2; !!SN:Iz2/?z2;
!!SN&y6=148:T^AC_Misc.Gelu_Specialist^/?z2; !!SN:Iz2/?z2;
!!SN|y6=151/y6=153:T^AC_Misc.Mutare_Specialist^/?z2; !!SN:Iz2/?z2;
!!FU(ACM_GetDialogMessageType):Pi^mouse_action^/?y30;
!!IF:M1/y30/z2;                           [show description for Hero Speciality when right click]
!!en;
!!en;


********************************************************************************




***********************Creature Specialists Buff in combat**********************


; Unset hook - for TUM compatibility
!?FU(ACM_UnsetERMHook);
!#VA(unsetHook:x);

!!SN:E(unsetHook)/1/5137685/(tum_Hero_GetSpecMonster); 4E6515

!?FU(ACM_CreateERMHook);
!#VA(setHook:x);

!!SN:E(setHook)/1/5137685/(ACM_Hero_GetSpecMonster); [Manage addtional monster if TUM is enabled] 4E6515
!!SN&i^Typhon_Third_Upgrade_Mod_Active^/i^tum_full_on^<>(TRUE)/i^tum_reborn_on^<>(TRUE):E(setHook)/1/5137595/(tum_Hero_GetSpecMonster_BeforeMonIdCheck); [Archer: This function ideally should be placed in TUM]

; Archer: This function ideally should be placed in TUM [Legacy]
!?FU(tum_Hero_GetSpecMonster_BeforeMonIdCheck)&i^tum_full_on^<>(TRUE)/i^tum_reborn_on^<>(TRUE);
!#VA(hook:x);

!!UN:C(hook)/(STRUCT_HOOK_CONTEXT_EBP)/4/?(ebp:y) C(ebp)/8/4/?(mon:y);
!!FU&(mon)<(MON_SUPREME_ARCHANGEL):E;

!!MA:O(mon)/?(townType:y);
!!FU&(townType)=(NO_TOWN):E;

!!MA:L(mon)/?(level:y);

!!if|i^tum_reborn_on^/i^tum_newTowns_on^/i^tum_full_on^;
  !!FU(tum_GetMonstersInTown):P(townType)/(level)/?(basicMon:y)/?(upgMon:y)/?(thirdUpgMon:y); 
!!el;
  !!FU(tum_GetTownMon):P(townType)/(level)/?(basicMon:y)/?(upgMon)/?(thirdUpgMon); [legacy]
!!en;

!!if&(mon)=(thirdUpgMon);
  !!UN:C(ebp)/8/4/(basicMon);
!!el;
  !!UN:P300/?(fourthUpgOn:y);

  !!if&(fourthUpgOn);
    !!MA:U(thirdUpgMon)/?(fourthUpgMon:y);
    !!UN&(mon)=(fourthUpgMon)C(ebp)/8/4/(basicMon);
  !!en;
!!en;

!?FU(ACM_GetSpecMonsterStats);
!#VA(heroId:x) (monId:x) (attack:x) (defense:x) (damage:x) (bonusHp:x);

!!MA:L(monId)/?(monLvl:y);
!!HE(heroId):E?t/?(level:y)/1;          [Check hero Level]
!!VR(level):F1/(INT_MAX);               [Fix the value fetched in case it's buggy]

!!VR(divider:y)&(monLvl)=0:S16;
!!VR(divider)&(monLvl)=1:S15; 
!!VR(divider)&(monLvl)=2:S13; 
!!VR(divider)&(monLvl)=3:S12; 
!!VR(divider)&(monLvl)=4:S10; 
!!VR(divider)&(monLvl)=5:S7; 
!!VR(divider)&(monLvl)=6:S5;

!!VR(attack):S(level):7 +1;             [Attack and Defense per 7 Level]
!!VR(defense):S(attack);
!!VR(damage):S(level):(divider);        [Damage per Level]
!!VR(bonusHp):S(level)+9;               [+1% per Health per Level +9%]

; Add in native bonuses (approximate calculation)
!!FU(ACM_GetNativeMonSpecBonus):P(level)/(monId)/?(bonusAtk:y)/?(bonusDef:y);
!!VR(attack):+(bonusAtk);
!!VR(defense):+(bonusDef);

; The script doesn't deal with War Machines as we don't need the stats to show in non-combat creature dlg
!?FU(ACM_Hero_GetSpecMonster);
!#VA(hook:x);

!!UN:C(hook)/(STRUCT_HOOK_CONTEXT_EBP)/4/?(ebp:y) C(ebp)/-4/4/?(hero:y) C(hero)/26/4/?(heroId:y);
!!HE(heroId):X?t/?(monId:y);

!!UN:C(hook)/(STRUCT_HOOK_CONTEXT_ESI)/4/?(monPtr:y);

; General (except for Firebirds and war machines)
!!if&(monId)<>(MON_FIREBIRD)/(monId)<>(MON_BALLISTA);
  !!UN:C(monPtr)/76/4/?(currHp:y);
  !!FU(ACM_GetSpecMonsterStats):P(heroId)/(monId)/?(attack:y)/?(defense:y)/?(damage:y)/?(bonusHp:y);
  !!UN:C(hook)/(STRUCT_HOOK_CONTEXT_EBP)/4/?(ebp:y) C(ebp)/8/4/?(monId:y);
  !!UN:C(monPtr)/84/4/d(attack) C(monPtr)/88/4/d(defense); [edit min/max damage]
  !!VR(newHp:e):S(currHp) :100 *(bonusHp);
  !!VR(hp:y):S(newHp);
  !!UN:C(monPtr)/76/4/d(hp); edit hp
  !!UN:C(monPtr)/92/4/d(damage) C(monPtr)/96/4/d(damage); [edit min/max damage]

  ; Skip all the native bonuses except for speed
  !!SN:X?t/0;
  !!UN:C(hook)/(STRUCT_HOOK_CONTEXT_RET)/4/5137895; 4E65E7

; Ignissa
!!el&(monId)=(MON_FIREBIRD);
  !!HE(heroId):E?t/?(level:y)/1;        [Check hero level]
  !!VR(level):F1/(INT_MAX);             [Fix the value fetched in case it's buggy]

  !!VR(bonusHp):S(level) *2 -52;
  !!UN:C(monPtr)/76/4/d(bonusHp);

  ; Skip all the native bonuses
  !!SN:X?t/0;
  !!UN:C(hook)/(STRUCT_HOOK_CONTEXT_RET)/4/5137898; 4E65EA
!!en;

; The following code is Replaced by Archer's script
!?BF;
!!FU:E;

!!BH0:N?y1;                             [Attacker]
!!FU(AC_Function_31)&y1>=0/y1<=155:Py1/1;

!!BH1:N?y1;                             [Defender]
!!FU(AC_Function_31)&y1>=0/y1<=155:Py1/2;

!?FU(AC_Function_31);
!!HEx1:X?y11/?y12/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!FU&y11<>1:E;                          [Exit if no Creature Specialist]
!!FU|y12=130/y12=146/y12>=174:E;        [Exceptions for heroes who have other specialities] Firebirds, Ballista and Commanders]

!!HEx1:E?y47/?y48/1;                    [Check hero Level]
!!MA:Ly12/?y14;
!!VRy60&y14=0:S16; !!VRy60&y14=1:S15; !!VRy60&y14=2:S13; !!VRy60&y14=3:S12; !!VRy60&y14=4:S10; !!VRy60&y14=5:S7; !!VRy60&y14=6:S5;

!!SN:W^Typhon_Third_Upgrade_Mod_Active^/?y1; [Check for Third Upgrade Mod]
!!FU(Set_Creature_Upgrades_TUM)&y1=1:Py12/x1/?y13/?y14;
!!FU(Set_Creature_Upgrades_ACM)&y1=0:Py12/x1/?y13/?y14;

!!VRy50:Sy48:7+1;                       [Attack and Defense per 7 Level]
!!VRy51:Sy48:y60;                       [Damage per Level]
!!VRy52:Sy48+9 +100;                    [+1% per Health per Level +9%]
!!DO(AC_Function_30)/0/20/1&x2=1:Py12/y13/y50/y52/y51/y14; [Pass Creature, Upgraded Creature, Att/Def, Health and Damage]
!!DO(AC_Function_30)/21/41/1&x2=2:Py12/y13/y50/y52/y51/y14; [Pass Creature, Upgraded Creature, Att/Def, Health and Damage]


!?FU(AC_Function_30);
!!BMx16:T?y1;

!!if|y1=x1/y1=x2/y1=x6;                 [If Special Creature or Upgraded Creature is found increase stats]
  !!BMx16:Adx3;                         [Attack]
  !!BMx16:Ddx3;                         [Defense]
  !!BMx16:H?y2; !!VRy2:*x4:100;         [Get Health]
  !!BMx16:Hy2;
  !!BMx16:U1/dx5 U2/dx5;                [Min+Max Damage]
!!en;

********************************************************************************
x1=Creature, x2=Hero Number, x3 Returns first upgrade, x4 Returns second upgrade
!?FU(Set_Creature_Upgrades_TUM);
!#VA(mon:x) (hero:x) (upgMon:x) (thirdUpgMon:x);

!!if&(mon)<>(MON_BALLISTA);
  !!MA:O(mon)/?(townType:y) L(mon)/?(level:y);

  !!if|i^tum_reborn_on^/i^tum_newTowns_on^/i^tum_full_on^;
    !!FU(tum_GetMonstersInTown):P(townType)/(level)/?(basicMon:y)/?(upgMon)/?(thirdUpgMon); 
  !!el;
    !!FU(tum_GetTownMon):P(townType)/(level)/?(basicMon:y)/?(upgMon)/?(thirdUpgMon); [legacy]
  !!en;

  *!FU(tum_GetMonstersInTown):P(townType)/(level)/?(basicMon:y)/?(upgMon)/?(thirdUpgMon); 
!!el;
  !!VR(upgMon):S(MON_FIRST_AID_TENT);
  !!VR(thirdUpgMon):S(MON_AMMO_CART);
!!en;


!?FU(Set_Creature_Upgrades_ACM);
x1=Creature, x2=Hero Number, x3 Returns first upgrade, x4 Returns second upgrade

!!VRx3:Sx1+1;                           [Normal Upgraded Version]

*--Table for Third Upgrade Mod
Need to expand and edit here for every faction

*--Fix for Confluxers
!!VRx3|x2=133/x2=129:S125;              [Erdamon or Thunar Magma Element]
!!VRx3|x2=134/x2=130:S129;              [Fiur or Ignissa]
!!VRx3|x2=135/x2=131:S123;              [Kalt or Lacus]
!!VRx3|x2=128/x2=132:S121;              [Pasis or Monere]
!!VRx3|x2=141/x2=129:S127;              [Aenian]

*******************Buff Commanders Firebirds Ballistas**************************
!?BF;

!!BH0:N?y1;                             [Attacker]
!!FU(AC_Function_32)&y1>=0/y1<=155:Py1/1;

!!BH1:N?y1;                             [Defender]
!!FU(AC_Function_32)&y1>=0/y1<=155:Py1/2;

!?FU(AC_Function_32);
!!HEx1:X?y11/?y12/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]

!!HEx1:E?y47/?y48/1;                    [Check hero Level]
!!MA:Ly12/?y14;

!!if&y12=146/y11=1;                     [If Ballista]
  !!VRy51:Sy48:8;                       [1 Damage per 8 Level  Ballista]
  !!VRy13:S999;                         [Upgraded Version]
  !!DO(AC_Function_30)/0/20/1&x2=1:Py12/y13/0/100/y51; [Pass Creature, Upgraded Creature, Att/Def, Health and Damage]
  !!DO(AC_Function_30)/21/41/1&x2=2:Py12/y13/0/100/y51; [Pass Creature, Upgraded Creature, Att/Def, Health and Damage]
!!en;

*!if|x1=36/x1=105/x1=128;               [If any Commander]
  *!VRy51:Sy48 +109;                    [10%+ 1% HP per Level]
  *!VRy52:Sy48*2 +103;                  [2% Damage per Level]
  *!VRy53:Sy48:10+1;                    [+1 Speed for 10 Heroes Levels]
  *!VRy13:S999;                         [Upgraded Version]
  *!DO(AC_Function_33)/0/20/1&x2=1:Py12/y13/y53/y51/y52; [Pass Creature, Upgraded Creature, Att/Def, Health and Damage]
  *!DO(AC_Function_33)/21/41/1&x2=2:Py12/y13/y53/y51/y52; [Pass Creature, Upgraded Creature, Att/Def, Health and Damage]
*!en;

; Replaced by Archer's script
*!if&x1=130;                            [If Firebird or Phoenix Ignissa Hero ID is 130]
  *!VRy12:S130;
  *!VRy51:Sy48*2-52 F1/(INT_MAX);       [2 HP per Level starts with negative offset]
  *!VRy13:Sy12+1;                       [Upgraded Version]
  *!DO(AC_Function_34)/0/20/1&x2=1:Py12/y13/0/y51/0; [Pass Creature, Upgraded Creature, Att/Def, Health and Damage]
  *!DO(AC_Function_34)/21/41/1&x2=2:Py12/y13/0/y51/0; [Pass Creature, Upgraded Creature, Att/Def, Health and Damage]
*!en;


!?FU(AC_Function_33);

!!BMx16:T?y1;
!!if&y1>=174/y1<=191;                   [If Special Creature or Upgraded Creature is found increase stats]
!!BMx16:H?y2; !!VRy2:*x4:100;           [Get Health]
!!BMx16:Hy2;                            [Set Health]
!!BMx16:U1/?y3 U2/?y4; !!VRy3:*x5:100; !!VRy4:*x5:100;
!!BMx16:U1/y3 U2/y4;                    [Min+Max Damage]
!!BMx16:Sdx3;                           [add Speed]
!!en;

!?FU(AC_Function_34);
130 Firebird
131 Phoenix 
158 Sacred Phoenix
252 Devine Phoenix 
!!BMx16:T?y1 H?y2;                      [Get type and health]
!!if|y1=130/y1=131/y1=158/y1=252;       [If Special Creature or Upgraded Creature is found increase stats]
!!BMx16&y2>50:Hdx4;                     [Set Health]
!!en;

********************************************************************************
!?FU(OnEveryDay)&i^timerDay^>1/i^timerWeekDay^=1/i^timerIsAi^=0; [Trigger each monday]
!!SN:W^Zulu_Mod_On^/?y79;
!!FU&y79=1:E;
!!FU(AC_Function_47):P130;              [pass 130 Ignissa +1 Firebird per Week starting from level 5]


!?FU(AC_Function_47);
!!HEx1:O?y2 E?y10/?y11/1;               [Check hero owner and experience]
!!FU&y11<5:E;                           [Exit if below level 5]
!!OW:C?y3;                              [Check current player]
!!FU&y2<>y3:E;                          [Abort if not the same]
!!HEx1:C2/130/1/1;                      [give 1 Firebird to Ignissa]

*!HEx1&i^timerDay^=1:C0/0/118/10;       [Change starting Army of Ignissa to pixis]
*!HEx1&i^timerDay^=1:C0/1/-1/-1;


********************************************************************************
**Gold and Estate Specialists give + random resources daily
!?FU(OnEveryDay)&i^timerOnce^=1/i^timerDay^>1/i^timerIsAi^=0; [Trigger each day]
Caitlin, Aine, Grindan, Jenova, Octavia, (Damacon removed), Sephinroth

!!VRy10:S0R5;

!!HE15:O?y1;                            [Checke Hero Owner]
!!if&y1>=0;
!!HE15:E?y47/?y48/1;                    [Check Hero Level]
!!VRy50:Sy48:10+1;                      [Give +1 +Level/10]
!!OW:Ry1/y10/dy50;                      [Add random resource to player]
!!en;

!!HE47:O?y1;                            [Checke Hero Owner]
!!if&y1>=0;
!!HE47:E?y47/?y48/1;                    [Check Hero Level]
!!VRy50:Sy48:10+1;                      [Give +1 +Level/10]
!!OW:Ry1/y10/dy50;                      [Add random resource to player]
!!en;

!!HE143:O?y1;                           [Checke Hero Owner]
!!if&y1>=0;
!!HE143:E?y47/?y48/1;                   [Check Hero Level]
!!VRy50:Sy48:10+1;                      [Give +1 +Level/10]
!!OW:Ry1/y10/dy50;                      [Add random resource to player]
!!en;

!!HE18:O?y1;                            [Checke Hero Owner]
!!if&y1>=0;
!!HE18:E?y47/?y48/1;                    [Check Hero Level]
!!VRy50:Sy48:10+1;                      [Give +1 +Level/10]
!!OW:Ry1/y10/dy50;                      [Add random resource to player]
!!en;

!!HE52:O?y1;                            [Checke Hero Owner]
!!if&y1>=0;
!!HE52:E?y47/?y48/1;                    [Check Hero Level]
!!VRy50:Sy48:10+1;                      [Give +1 +Level/10]
!!OW:Ry1/y10/dy50;                      [Add random resource to player]
!!en;

!!HE84:O?y1;                            [Checke Hero Owner]
!!if&y1>=100;                           [Disabled and Made Medusa Specialist]
!!HE84:E?y47/?y48/1;                    [Check Hero Level]
!!VRy50:Sy48:10+1;                      [Give +1 +Level/10]
!!OW:Ry1/y10/dy50;                      [Add random resource to player]
!!en;

!!HE94:O?y1;                            [Checke Hero Owner]
!!if&y1>=0;
!!HE94:E?y47/?y48/1;                    [Check Hero Level]
!!VRy50:Sy48:10+1;                      [Give +1 +Level/10]
!!OW:Ry1/y10/dy50;                      [Add random resource to player]
!!en;

!!UN:R2;                                [Redraw Screen to show ne value of gold]

****************************************************************************************************



                                        Commander Section




***************************Nekropolis Soul Eater****************************************************                           
!?FU(OnStackToStackDamage);             [Killed enemies get reanimated as Skeletons/Warriors during combat]

!!FU&x9=1:E;                            [exit in theoretical]
!!VRy1:S6;                              [set to melee as default]
!!VRy1&x8=1:S7;                         [set to range if distance attack]
!!SN:W^Commander_Aktion^/y1;            [Save if Melee6 or Shooting7]
!!BMx1:T?y2 I?y3;                       [Creature Type and Side index as for heroes (0:left, 1:right)]
!!BA:Hy3/?y5; !!FU&y5<0:E;              [Get hero by side and exit if none]
!!if&y2>=174/y2<=191;                   [if any commander]
  !!SN:W^ACM_Com_%Y5_Passive_5^/?y70;   [Check for 2Supporter ability]
  !!if|y2=178/y2=187/y70=1;             [if Soul Eater]
    !!BMx1:H?y4;                        [Current Hit Points of Soul Eater]
    !!BMx2:N?y5;                        [Number of Attacked Stack]
    !!BMx2:H?y6;                        [Health of Attacked Stack]
    !!SN:W^Soul_Eater_Target^/x2;
    !!SN:W^Soul_Eater_Target_Stacksize^/y5;
    !!SN:W^Soul_Eater_Stack^/x1;
  !!en;
!!en;


!?BG1;                                  [Killed enemies get reanimated as Skeletons during combat]

!!SN:W^Soul_Eater_Target^/?y3;          [Readout Var]
!!SN:W^Soul_Eater_Stack^/?y4;
!!SN:W^Soul_Eater_Target_Stacksize^/?y5;
!!SN:W^Soul_Eater_Target^/-1;           [Reset Var]
!!SN:W^Soul_Eater_Target_Stacksize^/-1;
!!SN:W^Soul_Eater_Stack^/-1;

!!FU|y3<0/y5<1/y4=-1:E;
!!BMy4:N?y4;
!!FU&y4=0:E;
!!BMy3:N?y6;                            [Current Number of Monster]
!!BMy3:B?y7;                            [Number of Monster at Battle Start]

!!VRy8:Sy5-y6;                          [Get Killed Monsters in that Attack]
!!FU&y8=0:E;                            [Exit if no Kill]

!!BG:H?y50;
!!VRy8::5;                              [Revive 20% + Passive]
!!SN:W^Commander_Aktion^/?y30;          [Check if Melee or Shooting]
!!VRy8&y30=7/y8>0::2;                   [Half effect if it was shooting]
!!FU(Check_Com_Masteries):Py50/0/0/0/0/0/0/0/0/0/0/?y43; [Pass Hero Number and return Passive Modifier]
!!VRy8:*y43:100;                        [Add passive modifier]
!!VRy8&y8=0:S1;                         [Revive mind one if there was a kill]

!!VRy90:S0;

!!SN:W^Typhon_Third_Upgrade_Mod_Active^/?y99; [Check for Third Upgrade Mod]
!!if&y99=1;                             [If Third Upgrade Mod is enabled also check for Skeleton Knights]
  !!FU(GetUpgradedMonster):P(MON_SKELETON_WARRIOR)/?y30;

  [:loop2];
  !!VRy10:S0R7;                         [Generate Random Stack number]
  !!BMy10:T?y11 N?y12 O?y13;            [Get Monster type, number and army slot id] - skipping henchmen here!
  !!VRy90:+1;                           [increase loop counter]
  !!VRy11&y90=40:Sy30;                  [Terminate Loop if no Skeleton Warrior 57 found]
  !!VRy12&y90=40:S1;                    [set value to terminate loop]
  !!VRy13&y90=40:S0;
  !!SN|y11<>y30/y12=0/y13<(ARMY_SLOT_FIRST):G[loop2]; [Loop until Skeleton Knight found]

  !!if&y90=40/y11=y30;                  [If no Skeleton Knight found look for Skeletons 57]
  !!VRy90:S0;
    [:loop];
    !!VRy10:S0R7;
    !!BMy10:T?y11 N?y12 O?y13;
    !!VRy90:+1;
    !!VRy11&y90=40:S57;                 [Terminate Loop if no Skeleton Warrior 57 found]
    !!VRy12&y90=40:S1;
    !!VRy13&y90=40:S0;
    !!SN|y11<>57/y12=0/y13<(ARMY_SLOT_FIRST):G[loop];   [Loop until Skeleton Warrior found]
  !!en;

  !!if&y90=40/y11=57;                   [If no Skeleton Warrior found look for Skeletons 56]
    !!VRy91:S0;
    [:loop1];
    !!VRy10:S0R7;
    !!BMy10:T?y11 N?y12 O?y13;
    !!VRy91:+1;
    !!FU&y91=40:E;                      [Exit complete Function if no Valid Creature can be found]
    !!SN|y11<>56/y12=0/y13<(ARMY_SLOT_FIRST):G[loop1];  [Loop until Skeleton found]
  !!en;


  !!if|y11=56/y11=57/y11=y30;
    !!BMy10:Ndy8 Bdy8;

    !!if&i^battle_isVisible^;
      !!VRz-1:S^ANIMDEAD^;
      !!SN:Pz-1;
      
      !!BMy10:V4;
      !!SN:T^AC_Misc.Soul_Eater_raise^/?z1/^amount^/y8;
      !!BU:Mz1;                         [Show Message in battle log]
    !!en;
  !!en;

  !!FU:E;
!!en;

[:loop];
!!VRy10:S0R7;
!!BMy10:T?y11 N?y12 O?y13;
!!VRy90:+1;
!!VRy11&y90=40:S57;                     [Terminate Loop if no Skeleton Warrior 57 found]
!!VRy12&y90=40:S1;
!!VRy13&y90=40:S0;
!!SN|y11<>57/y12=0/y13<(ARMY_SLOT_FIRST):G[loop]; [Loop until Skeleton Warrior found]

!!if&y90=40/y11=57;                     [If no Skeleton Warrior found look for Skeletons 56]
  !!VRy91:S0;
  [:loop1];
  !!VRy10:S0R7;
  !!BMy10:T?y11 N?y12 O?y13;
  !!VRy91:+1;
  !!FU&y91=40:E;                        [Exit complete Function if no Valid Creature can be found]
  !!SN|y11<>56/y12=0/y13<(ARMY_SLOT_FIRST):G[loop1];    [Loop until Skeleton found which is not a henchman]
!!en;

!!if|y11=56/y11=57;
  !!BMy10:Ndy8 Bdy8;

  !!if&i^battle_isVisible^;
    !!VRz-1:S^ANIMDEAD^;
    !!SN:Pz-1;
    
    !!BMy10:V4;
    !!SN:T^AC_Misc.Soul_Eater_raise^/?z1/^amount^/y8;
    !!BU:Mz1;                           [Show Message in battle log]
  !!en;
!!en;


*******************************
Animate Dead from Soul Eater gets influenced by Spell Modifier from Commander
!?BG0;                                  [Killed enemies get reanimated as Skeletons/Warriors during combat]
!!SN:W^Soul_Eater_Animated^/-1;         [Reset variable]

!!BG:A?y1; Action
!!if&y1=10;                             [If Cast]
  !!BG:H?y5;
  !!FU&y5<0:E;                          [Exit if no Hero]
  !!BG:N?y1;                            [Attacking Stack]
  !!BMy1:T?y2 I?y40;                    [Creature Type and side]
  !!if|y2=178/y2=187;                   [if Soul Eater]
    !!BG:E?y30;                         [Destination Target Stack]
    !!if&y30>=0/y30<=41;

      !!BMy30:N?y1 H?y2 L?y3 B?y4 I?y6; [Get Battle Monsters parameters]
      !!FU&y1=y4/y3=0:E;                [Exit if monster was not damaged]
      !!if&y6=y40;
        !!SN:W^Soul_Eater_Animated^/y30; Save parameters for BG1 trigger
        !!SN:W^Soul_Eater_Animated_N^/y1;
        !!SN:W^Soul_Eater_Animated_H^/y2;
        !!SN:W^Soul_Eater_Animated_L^/y3;
        !!SN:W^Soul_Eater_Animated_B^/y4;
        !!SN:W^Soul_Eater_Animated_Hero^/y5;
      !!en;     
    !!en;    
  !!en;
!!en;


!?BG1;                                  [Change Stats of animated creature]
!!SN:W^Soul_Eater_Animated^/?y30; !!FU&y30=-1:E;
!!SN:W^Soul_Eater_Animated_Hero^/?y5;
!!FU(Calc_Soul_Eater_Animate_Amount):Py5/?y10; [Calc Heal Amount]

!!SN:W^Soul_Eater_Animated_N^/?y1;
!!SN:W^Soul_Eater_Animated_H^/?y2;
!!SN:W^Soul_Eater_Animated_L^/?y3;
!!SN:W^Soul_Eater_Animated_B^/?y4;
*!VRy10:S1000;                          [Test set heal to 1000]

!!VRy12:Sy10 %y2;                       [Divide Amount of Heal durch HP]
!!VRy15:Sy3;                            [Set to lost life]
!!VRy15:Sy15-y12;                       [Lost life - difference from Heal]
!!VRy16:Sy15;                           [Save value in y16]
!!VRy11:Sy10:y2;                        [Number of possible Revives]

!!if&y12>=y3;                           [Calc correct rest life]
  !!VRy16:*-1;
  !!VRy17:Sy2;
  !!VRy17:-y16;
  !!VRy16:Sy17;
  !!VRy11:+1;                           [Add 1 creature for correct rest life]
!!en;

!!VRy6:Sy1+y11;                         [Total Number after attack]
!!VRy40:Sy6-1;
!!VRy16&y6>y4:S0;                       [Fix for Commander, Set lost life to zero if could heal more than 1 stack above maximum]
!!VRy6&y6>=y4:Sy4;                      [Set Number Cannot be more than before fight]
!!BMy30:Ny6 Ly16;                       [Heal happens Set Number and apply rest life]

!!SN:W^Soul_Eater_Animated^/-1;         [Reset variable]


 !?FU(Calc_Soul_Eater_Animate_Amount);
 x1=Hero Number, x2=returns Heal Amount

!!COx1:X2/?y2 S4/?y3;                   [Get Commander Level and Magic Level]
!!FU(Check_Com_Masteries):Px1/0/0/0/0/0/0/0/0/0/?y80; [Pass Hero Number and return Spell Damage Modifier]

!!VRy10:S85;                            [No Commander Magic]
!!VRy10&y3=1:S100;                      [Basic Commander Magic]
!!VRy10&y3=2:S150;                      [Advanced Commander Magic]
!!VRy10&y3=3:S200;                      [Expert Commander Magic]
!!VRy10&y3=4:S250;                      [Master Commander Magic]
!!VRy10&y3=5:S350;                      [Grandmaster Magic]
!!VRy10:*y80:100;                       [Multiply with commander spell modifier]
!!VRx2:Sy10;                            [Return heal amount in x2]


***************************Hierophant and Ogre Leader***************************
!?FU(OnCombatRound)&v997=0;             [Increases HP of First Aid Tent or Ballista by +10 per Level]

!!BA:H0/?y1;                            [Attacker]
!!COy1:D?y10;                           [Get Commander Alive]
!!COy1:T?y11;                           [Get Commander Type]
!!if&y10=0;                             [If Alive]
  !!FU(Check_Com_Masteries):Py1/0/0/0/0/0/0/0/0/0/0/?y21; [Pass Hero Number and return Passive Modifier]
  !!COy1:X2/?y12;                       [Get Commander Level]
  !!VRy13:Sy12*15*y21:100;              [15*Commander Level to HP]
  !!VRy14:Sy12:6*y21:100;               [Commander Level/6 to Min+Max Damage]
  !!SN:W^ACM_Com_%Y1_Passive_2^/?y70;   [Check for 2Supporter ability]
  !!VRy11&y70=1:S1;                     [bypass check with ability]
  !!DO(AC_Function_39)/0/10/1&y11=1:P147/y13; [Hierophant pass 147 for First Aid Tent and Commander Level]
  !!SN:W^ACM_Com_%Y1_Passive_7^/?y70;   [Check for 2Supporter ability]
  !!VRy11&y70=1:S6;                     [bypass check with ability]
  !!DO(AC_Function_39)/0/10/1&y11=6:P146/y13/y14; [Ogre Leader pass 146 for Ballista and Commander Level]
!!en;

!!BA:H1/?y1;                            [Defender]
  !!FU&y1<0:E;
  !!COy1:D?y10;                         [Get Commander Alive]
  !!COy1:T?y11;                         [Get Commander Type]
  !!if&y10=0;                           [If Alive ]
  !!FU(Check_Com_Masteries):Py1/0/0/0/0/0/0/0/0/0/0/?y21; [Pass Hero Number and return Passive Modifier]
  !!COy1:X2/?y12;                       [Get Commander Level]
  !!VRy13:Sy12*15*y21:100;              [15*Commander Level to HP]
  !!VRy14:Sy12:6*y21:100;               [Commander Level/6 to Min+Max Damage]
  !!SN:W^ACM_Com_%Y1_Passive_2^/?y70;   [Check for 2Supporter ability]
  !!VRy11&y70=1:S1;                     [bypass check with ability]
  !!DO(AC_Function_39)/21/31/1&y11=1:P147/y13; [Hierophant pass 147 for First Aid Tent and Commander Level]
  !!SN:W^ACM_Com_%Y1_Passive_7^/?y70;   [Check for 2Supporter ability]
  !!VRy11&y70=1:S6;                     [bypass check with ability]
  !!DO(AC_Function_39)/21/31/1&y11=6:P146/y13/y14; [Ogre Leader pass 146 for Ballista and Commander Level]
!!en;


!?FU(AC_Function_39);                   [increase Units Stats]

!!BMx16:T?y1;
!!if&y1=x1;
!!BMx16:N?y2;                           [Creature Number y20]
!!FU&y2=0:E;                            [Exit if zero]
!!BMx16:Hdx2;                           [Add fix HP to Ballista or First Aid Tent]
!!BMx16&x1=146:U1/dx3 U2/dx3;           [Min+Max Damage add only for Ballista]
!!en;

***************************Hierophantr***************************
!?BG0;                                  [Hierophant Shield Cast will block 1 time damage fixed amount]

!!BG:A?y1;
!!FU&y1<>10:E;                          [Exit if No Creature Cast]
!!BG:N?y1;                              [Attacking Stack Commander]
!!BMy1:T?y2;
!!if|y2=175/y2=184;                     [if Hierophant]
!!BG:S?y2 E?y4;                         [Spell and Destination Poistion]
!!FU&y4=-1:E;                           [Exit if no Monster there]
!!if&y2=-1/y4>=0/y4<=41;
!!BG:H?y5;                              [Get Hero]
!!FU&y5<0:E;                            [Exit if no Hero]
!!COy5:X2/?y6;                          [Get Commander Level]
!!COy5:S4/?y7;                          [Get Magic Level of Commander]
!!SN:W^Hierophantr_Shield_Cast%Y4^/y4;
!!en;
!!en;

!?MF1;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676;[Only run when melee or shooting damage]

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Shield_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
!!BMy1:I?y2;                            [Side index as for heroes (0:left, 1:right)]
!!VRy2:-1 *-1;
!!SN:W^Shield_Attacking_Stack^/y4;
!!SN:W^Hierophantr_Shield_Cast%Y4^/?y3; [Check if Spell was actually cast by Hero]
!!FU&y3=-1:E;
!!FU&y4<>y3:E;                          [Exit if this creature was not blessed with Hierophant Shield Cast]

!!BMy4:G27/?y13/?y14;                   [check for Shield Duration]
!!FU&y13=0:E;                           [Exit if no Shield or no more Shield Blocks left]

!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Shield_Attacking_Stack^/y4;
!!BMy4:F?y78;                           [read flags]
!!VRy78:&4194304;                       [just look summoned bit]
!!FU&y78>0:E;                           [Exit if cloned or summoned]

!!BMy4:I?y5 N?y75 H?y76;                [Side index as for heroes (0:left, 1:right) number and health of attacked creature]
!!VRy77:Sy75*y76*1:100;                 [get total HP of stack and calc 1%]
!!BA:Hy5/?y99;
!!FU(Check_Com_Masteries):Py99/0/0/0/0/0/0/0/0/0/?y80; [Pass Hero Number and return Spell Damage Modifier]

!!COy99:X2/?y60;                        [Get Commander Level]
!!COy99:S4/?y70;                        [Get Magic Level of Commander]
!!VRy71:Sy70*y60*2;                     [calc shield base value]
!!VRy10:S50+y77+y71*y80:100;            [calculate total shield value]

!!BA:Q?f;
!!MF:F?y8;                              [damage dealt]
!!if&y8>y10;                            [do if damage is bigger than shield]
  !!VRy12:Sy6-y10;
  !!VRy9:Sy8-y10;
  !!VRz-1:S^CRUSDFND.wav^;              [find block sound]
  !!SN&i^battle_isVisible^:Pz-1;        [play block sound]
  !!MF:Fy9;
  !!SN:T^AC_Misc.Shield block^/?z-1/^damage^/y10;
  !!BU:Mz-1;

!!el;                                   [do if damage is smaller than shield]
  !!VRy12:Sy6-y10;
  !!VRz-1:S^CRUSDFND.wav^;              [find block sound]
  !!SN&i^battle_isVisible^:Pz-1;        [play block sound]
  !!VRy9:Sy8;
  !!MF:E0;
  !!MF:F0;
  !!SN:T^AC_Misc.Shield block^/?z-1/^damage^/y8;
  !!BU:Mz-1;
!!en;

!!SN:W^Hierophantr_Shield_Cast%Y4^/-1;
!!en;

!?FU(OnBeforeBattleUniversal);

!!re y1/0/41;
!!SN:W^Hierophantr_Shield_Cast%Y1^/-1;
!!en;


***************************Ogre Leader***************************
!?BG0;                                  [Ogre Leader casting Bloodlust will add fixed amount of damage to attacks]

!!BG:A?y1;
!!FU&y1<>10:E;                          [Exit if No Creature Cast]
!!BG:N?y1;                              [Attacking Stack Commander]
!!BMy1:T?y2;
!!if|y2=180/y2=189;                     [if Ogre]
!!BG:S?y2 E?y4;                         [Spell and Destination Poistion]
!!FU&y4=-1:E;                           [Exit if no Monster there]
!!if&y2=-1/y4>=0/y4<=41;
!!BG:H?y5;                              [Get Hero]
!!FU&y5<0:E;                            [Exit if no Hero]
!!COy5:X2/?y6;                          [Get Commander Level]
!!COy5:S4/?y7;                          [Get Magic Level of Commander]
!!SN:W^Oger_Leader_Cast%Y4^/y4;
!!en;
!!en;

!?MF1;
!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4456676;           [Only run when melee or strikes around damage]

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Oger_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
!!SN:W^Oger_Attacking_Stack^/y4;
!!BMy1:I?y2;                            [Side index as for heroes (0:left, 1:right)]
!!SN:W^Oger_Leader_Cast%Y1^/?y3;
!!FU&y3=-1:E;
!!FU&y3<>y1:E;                          [Exit if this creature was not cast with Ogre Leader Bloodlust Cast]
!!BMy1:G43/?y13/?y14;                   [check for Bloodlust Duration]
!!FU&y13=0:E;
!!BMy1:I?y5; 
!!BA:Hy5/?y99;
!!FU&y99<0:E;
!!FU(Check_Com_Masteries):Py99/0/0/0/0/0/0/0/0/0/?y80; [Pass Hero Number and return Spell Damage Modifier]

!!MF:F?y4 N?y69;                        [original damage]
!!BMy69:N?y75 H?y76;                    [Side index as for heroes (0:left, 1:right) number and health of attacked creature]
!!VRy77:Sy75*y76*2:100;                 [get total HP of stack and calc 2%]

!!COy99:X2/?y60;                        [Get Commander Level]
!!COy99:S4/?y70;                        [Get Magic Level of Commander]
!!VRy71:Sy70*y60*3;                     [calc base value]
!!VRy23:S50+y77+y71*y80:100;            [calculate damage value 50 plus Clvl*MLvL*3 +2% of total HP from attacked stack]
!!VRy6:Sy23;
!!VRy5:Sy6+y4;
*!MF:Fy5;                               [deal new updated damage]

!!SN:T^AC_Misc.Oger_Damage^/?z-1/^damage^/y6;
!!BU:Mz-1;
!!SN:W^Oger_Leader_Cast%Y1^/-1;
!!en;


!?FU(OnBeforeBattleUniversal);

!!re y1/0/41;
!!SN:W^Oger_Leader_Cast%Y1^/-1;
!!en;


***************************Succubus charming************************************
!?BG0;                                  [Charms enemies in combat by casting hypno when attacking]

!!BG:A?y1;
!!FU&y1<>6:E;                           [Exit if not Melee Attack]
!!BG:H?y5;
!!BG:H?y66;
!!FU&y5<0:E;                            [Exit if no Hero]
!!BG:N?y1;                              [Attacking Stack]
!!BMy1:T?y2;                            [Creature Type]
!!if&y2>=174/y2<=191;                   [if any commander]
  !!SN:W^ACM_Com_%Y5_Passive_4^/?y70;     [Check for 2Supporter ability]
  !!if|y2=177/y2=186/y70=1;               [if Succubus]
    !!COy5:X2/?y30;                         [Get Commander Level]
    !!BG:E?y3;                              [Destination Poistion]
    !!FU&y3=-1:E;                           [Exit if no Monster there]
    !!FU(Check_Com_Masteries):Py5/0/0/0/0/0/0/0/0/0/0/?y80; [Pass Hero Number and return Passive Modifier]
    !!BMy3:F?y10;                           [Get Monster Flag]
    !!VRy10:&1024;                          [1024 Mind Spell Immunity]
    !!FU&y10>0:E;                           [Exit if creature is Mind Immune]
    !!BMy3:G34/?y11/?y12;                   [34 Anti-Magic]
    !!FU|y11>0/y12>0:E;                     [Exit if Anti Magic]
    !!BMy1:H?y4;                            [Current Hit Points of Succubus]
    !!BMy3:N?y5;                            [Number of Attacked Stack]
    !!BMy3:H?y6;                            [Health of Attacked Stack]
    !!VRy7:Sy5*y6;                          [Get total life of attacked Stack]
    !!VRy31:Sy30*75;
    !!VRy4:+y31*y80:100;                    [Succubus life +75*Level times the hit points of Succubus * Passive Mod]
    !!SN:W^Succubus_Charm_Value_%Y66^/y4;   [Save the value to show it in bonus list]
    !!BMy3&y7<y4:M60/2/3;                   [If value is lower apply hypno to stack]
  !!en;
!!en;

***************************Temple Guardian**************************************
!?MF1;                                  [Regs +2(+3 ....) Mana with every Attack for the Hero]

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676;[Only run when melee or shooting damage]
!!MF:W?y80;
!!FU&y80>0:E;

!!BG:A?y1;
!!if|y1=6/y1=7;
!!BG:H?y5;
*!FU&y5<0:E;                            [Exit if no Hero]
!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Temple_G_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
!!SN:W^Temple_G_Attacking_Stack^/y4;
!!BMy1:T?y2;                            [Creature Type]
!!if&y2>=174/y2<=191;                   [if any commander]
!!SN:W^ACM_Com_%Y5_Passive_3^/?y70;     [Check for 2Supporter ability]
!!if|y2=176/y2=185/y70=1;               [if Temple Guardian]
  !!COy5:X2/?y30;                       [Get Commander Level]
  !!VRy31&y30<20:S2; !!VRy31&y30>=20:S3; !!VRy31&y30>=35:S4; !!VRy31&y30>=50:S6; [Increase reward with level 20 and 35 and 50]
  !!FU(Check_Com_Masteries):Py5/0/0/0/0/0/0/0/0/0/0/?y43; [Pass Hero Number and return Passive Modifier]
  !!VRy31:*y43:100;                     [Modifier for Passive]
  !!BG:E?y3;                            [Destination Poistion]
  !!FU&y3=-1:E;                         [Exit if no Monster there]
  !!FU(Intelligence_Set_Spell_Points):Py5/0/?y32/1; [Return Number of Max Possible Spell Points for the Hero]
  !!HEy5:I?y33/1;                       [Give extra Mana Per Attack to hero]
  !!VRy35:Sy33+y31;                     [Value of current spell points + the ones from attacks]
  !!HEy5&y32>y35:Idy31/1;               [Give extra Mana Per Attack to hero]
  !!HEy5&y35>=y32:Iy33/1;               [Set Spell Points to Max if value would be greater after adding]
  !!FU&y35>=y32:E;                      [Exit to prevent showing Message if no Spell Points were added]
  !!BA:Q?f;
  !!SN&i^battle_isVisible^:T^AC_Misc.Temple Guardian^/?z1/^points^/y31;
  !!BU&i^battle_isVisible^:Mz1;
!!en;
!!en;
!!en;
!!en;


***************************Brute************************************************
!?MF1;                                  [Gives Physical Damage dealt in Gold after Combat]

!!UN:C42149568/4/?y40;                  [Get Physical Damage type]
!!if|y40=4462398/y40=4455011/y40=4456676;[Only run when melee, shooting damage or Strike all around damage]
  !!BG:A?y1;
  !!if|y1=6/y1=7;
  !!SN:W^Commander_Aktion^/y1;          [Save if Melee6 or Shooting7]
  !!BG:N?y1;                            [Attacking Stack]
  !!MF:N?y4;                            [damage receiving stack]
  !!SN:W^Brute_Attacking_Stack^/?y50;
  !!VRy1&y4=y1/y50>=0/y50<=41:Sy50;     [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
  !!SN:W^Brute_Attacking_Stack^/y4;
  !!BMy1:T?y2 I?y12;                    [Creature Type and side]
  !!if&y2>=174/y2<=191;                 [if any commander]
  !!VRy5:Si^battle_hero_%y12^;          [Get hero]
  !!FU&y5=(NO_HERO):E;

  !!SN:W^ACM_Com_%y5_Passive_6^/?y70;   [Check for 2Supporter ability]
  !!if|y2=179/y2=188/y70=1;             [if Brute]

  ; Exit if the additional gold is full this battle
  !!VRz2:S^Att^;
  !!VRz3:S^Def^;
  !!VRj:S2 +y12;
  !!VRy33:Si^Brute_Gold_%zj^;
  !!FU&y33>=1000000:E;                  [max at 1 million]

  !!HEy5&y5>=0:O?y56;                   [Get Hero Color]
  !!OW:Iy56/?y57;                       [Get if AI or Human}]
  !!SN&y57=0:W^Message_Flag^/1;         [Set Flag if Human Player]
  !!COy5:X2/?y30;                       [Get Commander Level]
  !!BG:E?y3;                            [Destination Poistion]
  !!FU&y3=-1:E;                         [Exit if no Monster there]
  !!BMy4:N?y55;                         [Number of Attacked Stack]
  !!BMy4:H?y6 L?y40;                    [Health of Attacked Stack]
  !!VRy7:Sy55*y6 -y40;                  [Get total life of attacked Stack]
  !!FU&y7<=0:E;

  !!MF:F?y10;
  !!FU&y10<=0:E;                        [damage dealt and exit if none]

  !!VRy10&y10>y7:Sy7;                   [Get the lower value between y10 and y7]

  !!VRy10:*80:100;                      [Reduce Gold Gain to 80 as default value]
  !!VRy10&y40=4456676:*80:100;          [Reduce Gold Gain when Strikes All Enemies around is active]

  !!SN:W^Commander_Aktion^/?y50;        [Check if Melee or Shooting]
  !!FU(Check_Com_Masteries):Py5/0/0/0/0/0/0/0/0/0/0/?y43; [Pass Hero Number and return Passive Modifier]
  !!VRy10:*y43:100;                     [Increase Gold gain by passive modifier]

  !!VRy11:Sy33 +y10 F0/1000000;         [max at 1 million]
  !!FU&y33>=y11:E;                      [Exit if the previous value is greater than the new one (overflow)]

  !!VRi^Brute_Gold_%zj^:Sy11;

  !!SN&i^battle_isVisible^:T^AC_Misc.Brute^/?z1/^gold^/y11;
  !!BU&i^battle_isVisible^:Mz1;
  !!en;
  !!en;
  !!en;
!!en;

!?MR1;                                  [Gives Magical Damage dealt in Gold after Combat]

!!BG:A?y1;
!!FU&y1<>10:E;
!!BG:N?y1;                              [Current Stack]
!!BMy1:T?y2 I?y12;                      [Creature Type and side]
!!if|y2=179/y2=188;                     [if Brute]

  ; Exit if the additional gold is full this battle
  !!VRz2:S^Att^;
  !!VRz3:S^Def^;
  !!VRj:S2 +y12;
  !!VRy33:Si^Brute_Gold_%zj^;
  !!FU&y33>=1000000:E;                  [max at 1 million]

  !!BG:H?y5;                            [Get Hero]
  !!HEy5&y5>=0:O?y56;                   [Get Hero Color]
  !!OW:Iy56/?y57;                       [Get if AI or Human}]
  !!SN&y57=0:W^Message_Flag^/1;         [Set Flag if Human Player]
  !!BG:E?y3;                            [Destination Poistion Monster Stack]
  !!FU&y3=-1:E;                         [Exit if no Monster there]
  !!BMy3:N?y9;                          [Number of Attacked Stack]
  !!BMy3:H?y6 L?y40;                    [Health of Attacked Stack]
  !!VRy7:Sy9*y6 -y40;                   [Get total life of attacked Stack]
  !!FU&y7<=0:E;

  !!FU(ACM_Calc_Commander_Spell_damage):Py5/?y10/15/1/y3; [Pass Hero Number and return spell damage in y20, Pass Spell Number and Battle State 1=In Fight, 0=No Fight, TargetCreature]
  !!FU&y10<=0:E;                        [damage dealt and exit if none]

  !!VRy10&y10>y7:Sy7;                   [Get the lower value between y10 and y7]

  !!FU(Check_Com_Masteries):Py5/0/0/0/0/0/0/0/0/0/0/?y43; [Pass Hero Number and return Passive Modifier]
  !!VRy10:*y43:100;                     [Increase Gold gain by passive modifier]

  !!VRy11:Sy33 +y10 F0/1000000;         [max at 1 million]
  !!FU&y33>=y11:E;                      [Exit if the previous value is greater than the new one (overflow)]

  !!VRi^Brute_Gold_%zj^:Sy11;

  !!SN&i^battle_isVisible^:T^AC_Misc.Brute^/?z1/^gold^/y11;
  !!BU&i^battle_isVisible^:Mz1;
!!en;


!?FU(OnAfterBattleUniversal);

!!BA:H0/?y1;                            [Attacker Hero Number]
!!FU(Brute_Gold_Passive_msg):Py1/0;
!!BA:H1/?y1;                            [Defender Hero Number]
!!FU(Brute_Gold_Passive_msg)&y1>=0:Py1/1;


!?FU(Brute_Gold_Passive_msg);
!!SN&x2=0:W^Brute_Gold_Att^/?y2;        [Check if Gold was generated for Attacker this combat]
!!SN&x2=1:W^Brute_Gold_Def^/?y2;        [Check if Gold was generated for Defender this combat]
!!FU|x1<0/y2=0:E;                       [Exit if no hero of no gold was generated]
!!HEx1:O?y25;                           [Check hero owner]
!!OW:C?y26;                             [Check current player]
*!FU&y25<>y26:E;                        [Abort if not the same]
!!COx1:D?y4;                            [Check if Commander of Hero is still alive]
!!FU&y4=1:E;                            [Exit if hes not]
!!if&y4=0;                              [If commander alive]
  !!SN:T^AC_Misc.Gained Gold^/?z1/^gold^/y2;
  !!SN:W^Message_Flag^/?y20;            [Set Flag if Human Player]
  !!IF&1000/y20=1/999/y25=y26:M^%Z1^;   [Display text to humans and if value is bigger zero]
  !!OW:Ry25/6/dy2;                      [Add gold to current player]
  !!UN&1000/y25=y26:R2;                 [Redraw Screen to show new value of gold]
  !!SN:W^Total_Brut_Com_Gold_%X1^/dy2;  [gained gold from Brute Commander]
!!en;

!?FU(OnBeforeBattleUniversal);
!!SN:W^Message_Flag^/0;                 [Set Flag if Human Player]


***************************Paladin**********************************************
!?BG0;                                  [Paladin Cure cast can gives chance to Resurrect. Chance to fail for higher creature levels. Chance can be increased with commander Spell Modifier]

!!BG:A?y1; !!FU&y1<>10:E;               [Exit if No Creature Cast]
!!BG:N?y1;                              [Attacking Stack Commander]
!!BMy1:T?y2;
!!if|y2=174/y2=183;                     [if Paladin]
!!BG:S?y2 E?y4;                         [Spell and Destination Poistion]
!!FU&y4=-1:E;                           [Exit if no Monster there]
!!if&y2=-1/y4>=0/y4<=41;
  !!BG:H?y5;                            [Get Hero]
  !!FU&y5<0:E;                          [Exit if no Hero]
  !!FU(Check_Com_Masteries):Py5/0/0/0/0/0/0/0/0/0/?y50; [Pass Hero Number and return Spell Modifier]
  !!COy5:X2/?y6;                        [Get Commander Level]
  !!COy5:S4/?y7;                        [Get Magic Level of Commander]
  !!BMy4:N?y8 B?y9;                     [Get Monster Number current and Battle Start]
  !!FU&y8>=y9:E;                        [Exit if no monsters died so far]
  !!BMy4:T?y10;
  !!MA:Ly10/?y11;                       [Get Monster Level]
  !!VRy13:S0; !!VRy13&y11=0:S7; !!VRy13&y11=1:S6; !!VRy13&y11=2:S5; !!VRy13&y11=3:S4; !!VRy13&y11=4:S3; !!VRy13&y11=5:S2; !!VRy13&y11=6:S1; [Number of possible revives based on creature level]
  !!VRy15:S0R99;
  !!VRy16&y11=0:S85; !!VRy16&y11=1:S82; !!VRy16&y11=2:S80; !!VRy16&y11=3:S78; !!VRy16&y11=4:S75; !!VRy16&y11=5:S65; !!VRy16&y11=6:S45; [Chance possible revives based on creature level]
  !!VRy51:Sy50-100:4;                   [Convert Spell Modifier to 25% effectiveness, so a +140% would mean +10% increased chance for the heal spell to work]
  !!VRy16:+y51;                         [Add percentage to initial chance]
  !!FU&y15>y16:E;                       [Exit if Roll not successfull]
  !!VRy12:Sy8+y13;                      [Add number to current number]
  !!VRy12&y12>=y9:Sy9;                  [Cannot grow more than to begin of the fight]
  !!BMy4:Ny12;                          [Set new number of monsters]
!!en;
!!en;


!?MF1;                                  [Gives Damage dealt in Experience to Hero after Combat]

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676;[Only run when melee or shooting damage]
!!MF:W?y80;
!!FU&y80>0:E;

!!BG:A?y1;
!!if|y1=6/y1=7;
  !!SN:W^Commander_Aktion^/y1;          [Save if Melee6 or Shooting7]
  !!BG:N?y1;                            [Attacking Stack]
  !!MF:N?y4;                            [damage receiving stack]
  !!SN:W^Paladin_Attacking_Stack^/?y50;
  !!VRy1&y4=y1/y50>=0/y50<=41:Sy50;     [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
  !!SN:W^Paladin_Attacking_Stack^/y4;
  !!BMy1:T?y2 I?y12;                    [Creature Type and side]
  !!if&y2>=174/y2<=191;                 [if any commander]
  !!VRy60:Si^battle_hero_%y12^;         [get hero]
  !!FU&y60=(NO_HERO):E;

  !!SN:W^ACM_Com_%Y60_Passive_1^/?y70;  [Check for 2Supporter ability]
  !!if|y2=174/y2=183/y70=1;             [if Paladin]
    !!HEy60&y60>=0:O?y56;               [Get Hero Color]
    !!OW:Iy56/?y57;                     [Get if AI or Human}]
    !!SN&y57=0:W^Message_Flag^/1;       [Set Flag if Human Player]
    !!COy60:X2/?y30;                    [Get Commander Level]
    !!BG:E?y3;                          [Destination Poistion]
    !!FU&y3=-1:E;                       [Exit if no Monster there]
    !!BMy4:N?y5;                        [Number of Attacked Stack]
    !!BMy4:H?y6 L?y40;                  [Health of Attacked Stack]
    !!VRy7:Sy5*y6 -y40;                 [Get total life of attacked Stack]
    !!FU&y7<=0:E;

    !!MF:F?y10;                         [damage dealt]
    !!FU&y10<=0:E;

    !!VRy10&y10>y7:Sy7;                 [Get the lower value between y10 and y7]

    !!SN:W^Commander_Aktion^/?y50;      [Check if Melee or Shooting]
    !!VRy10&y50=7::2;                   [Half effect if shooting]

    !!VRz2:S^Att^;
    !!VRz3:S^Def^;

    ; Exit if the addtional exp is full this battle
    !!VRj:S2 +y12;
    !!VRy33:Si^Paladin_Experience_%zj^;
    !!FU&y33>=10000000:E;               [max at 10 million]

    !!FU(Check_Com_Masteries):Py60/0/0/0/0/0/0/0/0/0/0/?y45; [Pass Hero Number and return Passive Modifier]
    ; Here we use float number to prevent overflow
    !!VRe1:Sy30 *5 +200 :100;           [Increase Experience gain with 5% for each Commander level +100%]
    !!VRe2:Sy45 :100;                   [Add potential Passive Bonus from Commander Classes like Supporter]
    !!VRe3:Sy10 *e1 *e2;
    !!VRy10:Se3;

    !!VRy11:Sy33 +y10 F0/10000000;      [max at 10 million]
    !!FU&y33>=y11:E;                    [Exit if the previous value is greater than the new one (overflow)]

    !!VRi^Paladin_Experience_%zj^:Sy11;

    !!SN&i^battle_isVisible^:T^AC_Misc.Paladin 2^/?z1/^Experience^/y11;
    !!BU&i^battle_isVisible^:Mz1;       [Show Message in battle log]
  !!en;
  !!en;
!!en;
!!en;


!?FU(OnAfterBattleUniversal);

!!BA:H0/?y1;                            [Attacker Hero Number]
!!FU(Paladin_Experience_Passive_msg):Py1/0;
!!BA:H1/?y1;                            [Defender Hero Number]
!!FU(Paladin_Experience_Passive_msg)&y1>=0:Py1/1;

!?FU(Paladin_Experience_Passive_msg);
!!SN&x2=0:W^Paladin_Experience_Att^/?y2;[Check if Gold was generated for Attacker this combat]
!!SN&x2=1:W^Paladin_Experience_Def^/?y2;[Check if Gold was generated for Defender this combat]
!!FU|x1<0/y2=0:E;                       [Exit if no hero of no gold was generated]
!!HEx1:O?y25;                           [Check hero owner]
!!OW:C?y26;                             [Check current player]
*!FU&y25<>y26:E;                        [Abort if not the same]
!!COx1:D?y4;                            [Check if Commander of Hero is still alive]
!!FU&y4=1:E;                            [Exit if hes not]
!!if&y4=0;                              [If commander alive]
  !!SN:T^AC_Misc.Paladin^/?z1/^Experience^/y2;
  !!SN:W^Message_Flag^/?y20;            [Set Flag if Human Player]
  !!IF&1000/y20=1/999/y25=y26:M^%Z1^;   [Display text to humans and if value is bigger zero]
  !!HEx1:Edy2;                          [Add Experience to current player]
!!en;


***************************Shaman***********************************************
*Chance for Crushing Blow! Will Reduce Att/Def or Speed if successful hit of lvl 7 and 8
!?MF1&1000;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676;[Only run when melee or shooting damage]
!!MF:W?y80;
!!FU&y80>0:E;

!!BG:A?y1;                              [Aktion in y1]
!!if&y1=6|y1=7;                         [Attack or Shoot]

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!BG:H?y5;
!!SN:W^Shaman_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
!!SN:W^Shaman_Attacking_Stack^/y4;
!!if&y4>=0/y4<=41;
!!BA:Q?f;
!!BMy1:T?y2;                            [Creature Type]
!!if&y2>=174/y2<=191;                   [if any commander]
!!SN:W^ACM_Com_%Y5_Passive_8^/?y70;     [Check for 2Supporter ability]
!!if|y2=181/y2=190/y70=1;               [if Shaman]
  !!BG:H?y5;
  !!COy5:X2/?y31;                       [Get Commander Level]
  !!VRy32:Sy31:2;                       [Half commander level]
  !!BG:E?y3;                            [Destination Poistion]
  !!FU&y3=-1:E;                         [Exit if no Monster there]

  !!FU(Check_Com_Masteries):Py5/0/0/0/0/0/0/0/0/0/0/?y45; [Pass Hero Number and return Passive Modifier]
  !!VRy10:S0R99;
  !!VRy11:Sy32+40*y45:100;              [Chance for Crushing Blow is Com_level/2 +40% * passive modifier]
  !!if&y10<y11;
    !!BMy4&i^battle_isVisible^:V14;                [Show crusing animation]
    !!VRy30:S0R6;
    !!VRy40:S2; !!VRy40&y31>=30:S3;  !!VRy40&y31>=45:S4; !!VRy40&y31>=55:S5; !!VRy40:*-1; [+1 increased reduction per 10 level]
    !!VRy41:S1; !!VRy41&y31>=25:S2;  !!VRy41:*-1;
    !!BMy4|y30=0/y30=3/y30=4/y30=6:Ady40;[Attack -x]
    !!BMy4|y30=1/y30=3/y30=5/y30=6:Ddy40;[Defense -x]
    !!BMy4|y30=2/y30=4/y30=5/y30=6:Sdy41;[Speed -x]

    !!BMy4:A?y20; !!VRy20&y20<=1:S1; !!BMy4:Ay20;
    !!BMy4:D?y21; !!VRy21&y21<=1:S1; !!BMy4:Dy21;
    !!BMy4:S?y22; !!VRy22&y22<=3:S3; !!BMy4:Sy22; [Cannot recude below 3 speed]

    !!VRz-1&1000:S^DWRFDFND^;
    !!SN&i^battle_isVisible^:Pz-1;
  !!en;
!!en;
!!en;
!!en;
!!en;
!!en;


!?FU(OnCombatRound)&v997=0;
*Remove Shaman Native ability to gain 150% of heroes att/def and make it scalable with passive modifier
New mechanic:
Shaman gains 125% of Heroes attack, this values gets modified by commanders passive value
!!BA:H0/?y1;
!!re i/0/10;
  !!BMi:T?y2;                             [Creature Type]
  !!SN:W^ACM_Com_%Y1_Passive_8^/?y70;     [Check for 2Supporter ability]
  !!VRy2&y70=1:S181;                      [bypass check if ability is active]
  !!FU(Set_Shaman_Prim_Stats)&y2=181/y1>=0/y1<=155:Py1/i; [if Shaman and valid Hero]
!!en;

!!BA:H1/?y1;
!!re i/21/31;
  !!BMi:T?y2;                             [Creature Type]
  !!SN:W^ACM_Com_%Y1_Passive_8^/?y70;     [Check for 2Supporter ability]
  !!VRy2&y70=1:S190;                      [bypass check if ability is active]
  !!FU(Set_Shaman_Prim_Stats)&y2=190/y1>=0/y1<=155:Py1/i; [if Shaman and valid Hero]
!!en;

!?FU(Set_Shaman_Prim_Stats);

!!HEx1:F?y10/?y11/d/d;                  [Get Attack and Defense of the Hero]
!!VRy10&y10>0::2;                       [Divide Attack with 2 to get +50% bonus]
!!VRy11&y11>0::2;                       [Divide Attack with 2 to get +50% bonus]
!!BMx2:A?y30 D?y31;                     [Get Parameters of the Commander]
!!VRy30:-y10;                           [reduce commander stats by  value]
!!VRy31:-y11;
!!BMx2:Ay30 Dy31;                       [Set new Parameters of the Commander]

!!FU(Check_Com_Masteries):Px1/0/0/0/0/0/0/0/0/0/0/?y45; [Pass Hero Number and return Passive Modifier]
!!VRy50:S25*y45:100+100;                [Base the increase of Hero parameters is 125% that value gets modified by passive]
!!BMx2:A?y30 D?y31;                     [Get Parameters of the Commander]
!!HEx1:F?y10/?y11/d/d;                  [Get Attack and Defense of the Hero]
!!VRy20:Sy10*y50:100-y10;               [Calc difference from heroes stats]
!!VRy21:Sy11*y50:100-y11;
!!BMx2:Ady20 Ddy21;                     [Set new Parameters of the Commander]


!?BG0;                                  [Before Shaman Cast BattleAction]
*Shamans Haste spell scales with Spell Modifier. Adds additional undispellable speed based on Spell Mod, stackable.
!!BG:A?y1; !!FU&y1<>10:E;               [Exit if No Creature Cast]
!!BG:N?y1;                              [Attacking Stack Commander]
!!BMy1:T?y2;                            [Get Creature Type]
!!if|y2=181/y2=190;                     [if Shaman]
  !!BG:S?y2 E?y4;                       [Spell and Destination Poistion]
  !!FU&y4=-1:E;                         [Exit if no Monster there]
  !!if&y2=-1/y4>=0/y4<=41;
    !!BG:H?y5;                          [Get Hero]
    !!FU&y5<0:E;                        [Exit if no Hero]
    !!FU(Check_Com_Masteries):Py5/0/0/0/0/0/0/0/0/0/?y50; [Pass Hero Number and return Spell Modifier]
    !!VRy60:S0; !!VRy60&y50>=125:S1; !!VRy60&y50>=175:S2; !!VRy60&y50>=250:S3; !!VRy60&y50>=350:S4; !!VRy60&y50>=500:S5; [Set Speed Bonus]
    !!BMy4:Sdy60;                       [Add Speed Bonus to Battle Stack]
  !!en;
!!en;


**************************************Vampire*******************************************************
; Replaced by Archer's implementation
*Vampire Commander Class heals 25% with melee attacks
!?MF1;
!!FU:E;

*Vampire Commander Class heals 25% with melee attacks
!!UN:C42149568/4/?y10;                  [Physical Damage]
!!if|y10=4462398/y10=4456676;           [Only run when melee or Strikes all round]
  !!BG:A?y1; !!FU&y1<>6:E;              [Exit if not melee]
  !!BG:N?y1;                            [Attacking Stack]
  !!MF:N?y4;                            [damage receiving stack]
  !!SN:W^Vampire_Class_Attacking_Stack^/?y50;
  !!VRy1&y4=y1/y50>=0/y50<=41:Sy50;     [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
  !!SN:W^Vampire_Class_Attacking_Stack^/y4;
  !!BMy4:F?y36;                         [Get Flag of damage receiving stack]
  !!VRy36:&16;                          [Check Alive bit of creature]
  !!FU&y36=0:E;                         [Exit if no alive stack]
  !!BMy1:T?y2 H?y6 L?y7;                [Creature Type]
  !!if&y2>=174/y2<=191;                 [if any commander]
    !!BG:H?y5;                          [Get Hero]
    !!MF:F?y3;                          [Get damage]
    !!FU(Check_Com_Masteries):Py5/?y70/0/0/?y71; [Get commander class modifier from function]
    !!FU|y5<0/y71<>19/y3<=0/y7=0:E;     [Exit if no Hero or not a Vampire Commander or no damage dealt, or no hitpoints lost]
    !!COy5:X2/?y31;                     [Get Commander Level]
    !!BMy4:N?y10 H?y11 L?y12;           [Creature Type]
    !!VRy13:Sy10*y11-y12;               [Calc total HP of attacked Stack]
    !!VRy3&y3>y13:Sy13;                 [Damage cannot be more than complete HP of stack]
    !!VRy3::4;                          [Get 25% of the damage dealt]
    *!VRy3&y70=1::2;                    [Get 50% of the damage dealt if Mastery is enabled]
    !!VRy7:-y3;                         [Rest life - damage is means heal]
    !!VRy7&y7<0:S0;                     [Set rest live to 0, that means stack is fully healed]
    !!BMy1:Ly7;                         [Apply drain life animation on Commander Stack]
    !!BMy1&i^battle_isVisible^:V74;     [Show leech animation on stack]
    !!VRz1&1000:S^DRAINLIF^;
    !!SN&i^battle_isVisible^:Pz1;       [Play leech sound]
  !!en;
!!en;


*************************************Fire Mage******************************************************
Fire Mage Commander class script, cast Fireball with attacks. Scales as 8 times Spell Power.
*Trigger Spell at attack position after damage animation for melee attacks*
; Friendly units are immune to Fire Ball casted by Fire Mage, while hostile units are vulnerable (piecing spell immunity)

; Archer30's new implementation
!?FU(ACM_OnAfterMelee);
!#VA(atkStack:x) (defStack:x);
!#VA(usedY[62]:y);

!!BM(atkStack):N?(atkNum:y);
!!BM(defStack):N?(defNum:y);
!!FU|(atkNum)<=0/(defNum)<=0:E;

; Exit if not commander
!!BM(atkStack):T?(atkType:y);
!!FU|(atkType)<(MON_COMMANDER_FIRST_A)/(atkType)>(MON_COMMANDER_LAST_D):E;

; Exit if no hero
!!BM(atkStack):I?(atkSide:y);
!!FU&i^battle_hero_%(atkSide)^=(NO_HERO):E;

!!VR(hero:y):Si^battle_hero_%(atkSide)^;

; Exit if not Fire Mage
!!FU(Check_Com_Masteries):P(hero)/?y51/?y52/?y53/?y54/0/0/0/0/0/?y55; [Pass Hero Number and return Class and Spell Damage modifier]
!!SN:W^Commander_%(hero)_Ancient_FireMage^/?y90;  
!!VRy54&y90=1:S9;                       [Check for Ancient Fire Mage and set active]
!!FU&y54<>9:E;                          [Exit if commander class is not Fire Mage]  

; Determine the spell
!!VRy21&y51=0:S21; !!VRy56&y51=0:S60;   [Set Spell to Fireball]
!!VRy21&y51=1:S22; !!VRy56&y51=1:S90;   [Set Spell to Inferno if Mastery is enabled]

!!BM(defStack):P?y3;
!!HE(hero):F?y60/?y60/?y61/?y60;        [Get Spell Power from hero]
!!HE(hero):A2/81/?y60/?y62;             [Check 81 Orb of Tempestuous Fire]

!!FU(H3_Calc_Normal_Spell_Damage):P(hero)/?y59/?y58/1/y21/0; [Pass Hero Number and Give Back Damage in y59 and Extra Damage Option and Spell Number]
!!SSy21:E3/?y57;                        [get extra spell damage]
!!VRy59&y62=1:+25;                      [Add 25% damage when Orb of Tempestuous Fire is equipped]
!!VRy8:S8*y61*y59:100*y55:100-y56;      [Damage is 8*Spell Power from Hero, +%Hero Spell Damage +%CommanderSpell Damage - base spell offset for clean calculation]
!!VRy8&y8<0:S0;                         [Value cannot be below zero to prevent negative damage, it will apply base damage instead]

!!SSy21:E3/y8;                          [set new damage for Fireball to also show damage when hitting several targets]

; Cast the spell
!!VRi^acm_fireMageSpell^:Sy21;
!!VRi^acm_fireMageStack^:Sy2;
!!FU(ACM_GetActualStackSide):Py2/?i^acm_fireMageSide^;

!!BMy2:Cy21/y3/3/3/0;                   [Cast Expert Spell at Stack Position]

!!VRi^acm_fireMageSpell^:S0;
!!VRi^acm_fireMageStack^:S0;
!!VRi^acm_fireMageSide^:S0;

!!SSy21:E3/y57;                         [Revert damage to value from before]

; Increase kill count with 1/3 chance
!!if&y52<y53;
  !!VR(random:y):R0/0/2;                [Generate Random Number]
  !!SN&(random)=0:W^Commander_Kill_Counter_%(hero)^/d1; [Increase counter by one with each attack and 33% chance]
!!en;


; Replaced by Archer's new implementation
!?MF1;
!!FU:E;

!!UN:C42149568/4/?y10;                  [Physical Damage]
!!if&y10=4462398;                       [Only run when melee]
  !!BG:A?y1; !!FU&y1<>6:E;              [Exit if not melee]
  !!BG:N?y1;                            [Attacking Stack]
  !!MF:N?y4;                            [damage receiving stack]
  !!SN:W^FireMage_Attacking_Stack^/?y50;
  !!VRy1&y4=y1/y50>=0/y50<=41:Sy50;     [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
  !!SN:W^FireMage_Attacking_Stack^/y4;
!!en;


!?FU(ACM_Event_AfterMeeleDamage);
!!FU:E;

!!SN:W^FireMage_Attacking_Stack^/?y4;

!!BG:A?y1 N?y2 D?y3 E?y6 H?y50;       [action type, Attacking stack number, Destination Poistion and Hero]
!!BMy6&y6>=0:F?y22; !!VRy22:&1; !!VRy3&y22>0:+1; [For 2hex creatures increase hex position by +1]
!!FU|y1<>6/y50<0:E;                   [Exit if no melee attack or no monster at position or no Hero]
!!HEy50:F?y60/?y60/?y61/?y60;         [Get Spell Power from hero]
!!FU(Check_Com_Masteries):Py50/?y51/?y52/?y53/?y54/0/0/0/0/0/?y55; [Pass Hero Number and return Class and Spell Damage modifier]
!!SN:W^Commander_%Y50_Ancient_FireMage^/?y90;  
!!VRy54&y90=1:S9;                     [Check for Ancient Fire Mage and set active]
!!FU&y54<>9:E;                        [Exit if commander class is not Fire Mage]  
!!VRy21&y51=0:S21; !!VRy56&y51=0:S60; [Set Spell to Fireball]
!!VRy21&y51=1:S22; !!VRy56&y51=1:S90; [Set Spell to Inferno if Mastery is enabled]
!!if&y4=y2/y6>=0;                     [If Attacking=Receiving means retaliation, so switch to target stack and position]
  !!BMy4:P?y20;                       [Stack Position ]
  !!VRy3:Sy20;                        [Switch Position]
  !!VRy2:Sy6;                         [Switch Stack]
!!en;
!!BMy2:T?y5 N?y7;                     [Creature Type and number]
!!if&y5>=174/y5<=191;                 [If any commander]
  !!if&y1=6/y3>=0/y3<=186/y4<>y2;
      !!FU(H3_Calc_Normal_Spell_Damage):Py50/?y99/?y98/1/y21/0; [Pass Hero Number and Give Back Damage in y99 and Extra Damage Option and Spell Number]
      !!SSy21:E3/?y57;                [get extra spell damage]
      !!VRy8:S8*y61*y99:100*y55:100-y56; [Damage is 8*Spell Power from Hero, +%Hero Spell Damage +%CommanderSpell Damage - base spell offset for clean calculation]
      !!VRy8&y8<0:S0;                 [Value cannot be below zero to prevent negative damage, it will apply base damage instead]
      !!SSy21:E3/y8;                  [set new damage for Fireball to also show damage when hitting several targets]

      ; Archer30's new implementation
      !!VRi^acm_fireMageSpell^:Sy21;
      !!VRi^acm_fireMageStack^:Sy2;
      !!FU(ACM_GetActualStackSide):Py2/?i^acm_fireMageSide^;

      !!BMy2:Cy21/y3/3/3/0;           [Cast Expert Spell at Stack Position]

      !!VRi^acm_fireMageSpell^:S0;
      !!VRi^acm_fireMageStack^:S0;
      !!VRi^acm_fireMageSide^:S0;

      !!SSy21:E3/y57;                 [Revert damage to value from before]
      !!VRy85:S0R2;                   [Generate Random Number]
      !!SN&y85=0/y52<y53:W^Commander_Kill_Counter_%Y50^/d1; [Increase counter by one with each attack and 33% chance]
  !!en;
!!en;

; Archer30's new implementation
!?FU(OnDwarfMagicResistance_Quit)&i^acm_fireMageSpell^;
!!MR:S?(spell:y);
!!FU&(spell)<>i^acm_fireMageSpell^:E;

!!MR:N?(stack:y);
!!BM(stack):I?(side:y);

!!if|(stack)=i^acm_fireMageStack^/(side)=i^acm_fireMageSide^;
  !!MR:F100;
!!el;
  !!MR:F0;
!!en;

; Replaced by Archer30's new implementation
!?MR2;                                  [Magogs Fireball-Cast that comes with Stack Expierence doesnt damage own troops]
!!FU:E;

*When attacking with Fire Mage make own units immune vs damage*
!!SN:W^Magog_Fireball_Enable^/?y1;
!!FU&y1=0:E;
!!BG:A?y1;                              [Aktion in y1]
!!BG:Q?y55;
!!if|y1=7/y1=6:;                        [if ranged or melee attack]
  !!MR:S?y2 F?y3;

  !!if&y2=21:;                          [if Fireball]
    !!MR:N?y10;
    !!BMy10:I?y11;
    !!MR&y11=y55:F100;                  [Disable Magic damage for attacker side from Fireball]
  !!en:;

  !!if&y2=22:;                          [if Inferno]
    !!MR:N?y10;
    !!BMy10:I?y11;
    !!MR&y11=y55:F100;                  [Disable Magic damage for attacker side from Fireball]
  !!en;
!!en;

// Disable Magog's friendly fire
; Archer30: Hi Perry you know that this script has nothing to do with Fire Mage, right?
!?FU(OnAfterErmInstructions);
!!SN:W^Magog_Fireball_Enable^/1;        [Quick Fix to Make Fire Mage Immune because Magog script got disaled in Assembly update]

!?MF1&i^Magog_Fireball_Enable^;
; Note: This script won't work if Magog's are able to retaliate in range (due to using i^battle_acting_side^ to check shooting side)
!!MF:N?y4;                              [Get defending stack number]
!!BG:E?y30;
!!FU&y4=y30:E;

!!BMy4:I?y6;                            [Get defending stack side]
!!UN:C42149568/4/?y10;                  [Judgement basis (028326c0)]
!!MF&y10=4454752/i^battle_acting_side^=y6:E0; [Disable taking damage if Magog Fireball and own team]

****************************************************************************************************


****************************************************************************************************
*Select Commander Class after the first kill and increase kill counter
; Here we use OnAfterAttackHook to fix in some situation, the attacked stack is not killed as they have the Block/Reflect ability, but still grants klll count
; Note that even if the targeted stack can rebirth, killing them will grant you a kill count even if they rebirth later on
; by Archer30
!?FU(ACM_OnBeforeMelee);                [OnBeforeMelee + OnMonsterPhysicalDamage to deal with Strike all Around/Breath]
!#VA(atkStack:x) (defStack:x);

; Exit if the attacking stack is killed
!!BM(atkStack):N?(atkNum:y);
!!FU&(atkNum)<=0:E;

; Exit if not a commander
!!BM(atkStack):T?(atkType:y);
!!FU|(atkType)<(MON_COMMANDER_FIRST_A)/(atkType)>(MON_COMMANDER_LAST_D):E;

; Exit if the commander does not belong to a hero
!!BM(atkStack):I?(atkSide:y);
!!FU&i^battle_hero_%(atkSide)^=(NO_HERO):E;

!!SN:Mi^acm_commanderMeleeList^;
!!FU(NewIntArray):P?i^acm_commanderMeleeList^/(M_TEMP);

!?FU(OnMonsterPhysicalDamage)&i^acm_commanderMeleeList^;
!!MF:N?(defStack:y);
!!FU(Array_Push):Pi^acm_commanderMeleeList^/(defStack);

!?FU(ACM_OnAfterMelee)&i^acm_commanderMeleeList^;
!#VA(atkStack:x) (defStack:x);

; Exit if the attacking stack is killed
!!BM(atkStack):N?(atkNum:y);

!!if&(atkNum)>0;
  ; Get the total kill count from a melee attack
  !!VR(killCount:y):S0;
  !!SN:Mi^acm_commanderMeleeList^/?(size:y);

  !!re i/0/(size)/1/-1;
    !!SN:Mi^acm_commanderMeleeList^/i/?(targetStack:y);
    !!BM(targetStack):N?(targetNum:y);
    !!VR(killCount)&(targetNum)<=0:+1;
  !!en;

  ; Kill
  !!if&(killCount)>0;
    !!BM(atkStack):I?(atkSide:y);

    !!re j/1/(killCount);
      !!FU(ACM_Com_Kill_Counter_Fkt):Pi^battle_hero_%(atkSide)^; [If any commander go to kill count adder function]
    !!en;
  !!en;
!!en;

!!SN:Mi^acm_commanderMeleeList^;
!!VRi^acm_commanderMeleeList^:S0;

!?FU(ACM_OnAfterShoot);
!#VA(atkStack:x) (defStack:x);

; Exit if the attacked stack is alive
!!BM(defStack):N?(defNum:y);
!!FU&(defNum)>0:E;

; Exit if the attacking stack is killed
!!BM(atkStack):N?(atkNum:y);
!!FU&(atkNum)<=0:E;

; Exit if not a commander
!!BM(atkStack):T?(atkType:y);
!!FU|(atkType)<(MON_COMMANDER_FIRST_A)/(atkType)>(MON_COMMANDER_LAST_D):E;

; Exit if the commander does not belong to a hero
!!BM(atkStack):I?(atkSide:y);
!!FU&i^battle_hero_%(atkSide)^=(NO_HERO):E;

; Kill
!!FU(ACM_Com_Kill_Counter_Fkt):Pi^battle_hero_%(atkSide)^; [If any commander go to kill count adder function]


; Replaced by Archer's implementation
!?MF1;
!!FU:E;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676;[Only run when melee or shooting damage or Strikes all enemys around]
  !!BG:A?y1;                            [Aktion in y1]
  !!if&y1=6|y1=7;                       [Attack or Shoot]
    !!BG:N?y1;                          [Attacking Stack]
    !!MF:N?y4;                          [damage receiving stack]
    !!SN:W^Commander_Kill_Attacking_Stack^/?y50;
    !!VRy1&y4=y1/y50>=0/y50<=41:Sy50;   [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
    !!SN:W^Commander_Kill_Attacking_Stack^/y4;
    !!BMy1:T?y2 I?y40;                  [Creature Type]
    !!MF:F?y3;                          [Get damage]
    !!BG:H?y10;                         [Get current hero]
    !!FU|y3<=0/y10<0:E;                 [Exit if Zero damage or no hero]
    !!BMy4:N?y5 H?y6 L?y7;              [Get Number and Life of attacked Stack and lost Hitpoints]
    !!VRy5:*y6-y7;                      [Get total Life of attacked stack]
    !!FU&y5>y3:E;                       [Exit if not enough damage was dealt]
    !!FU(ACM_Com_Kill_Counter_Fkt)&y2>=174/y2<=191:Py10; [If any commander go to kill count adder function]
  !!en;
!!en;


!?FU(Apply_Commander_Kill_Bonus);
*Apply Kill Count Bonus, recude casts by 1 for all commanders and reduce battlestats of commander to only 25% of hero prim stats*

!!BMx16:T?y1 I?y2 N?y20;                [Creature Type]
!!BHy2:N?y10;                           [Hero Number]
!!FU|y20=0/y10<0:E;                     [Exit if no creature or Hero]

!!if&y1>=174/y1<=191;                   [if any commander]
  
  !!BMx16:E?y20;                        [get casts]
  !!VRy20&y20>0:-1;                     [Reduce casts by 1 for all commanders, so you need at least 1 point in Magic to be able to cast]
  !!BMx16:Ey20;                         [Set new casts for commander]

  !!SN:W^acm_Weak_Commanders^/?y99;     [Check for Weak Commander Option]
  !!if&y99=1;
    !!HEy10:F?y40/?y41/?y42/?y43;       [Get Prim stats from Hero for Weak Commander Option]
    !!VRy50&y40>0:Sy40:4 *-1; !!VRy40:Sy40+y50 *-1; [Calc 25% of the Prim stats from Hero]
    !!VRy51&y41>0:Sy41:4 *-1; !!VRy41:Sy41+y51 *-1;
    !!BMx16:Ady40 Ddy41 H?y42 U1/?y43 U2/?y44; [Reduce Attack and Defense of Commander to only 25% from Hero stats]
  !!en;

  !!FU(ACM_MP_Sync_Commander_Classes):Py10; [Send potential change about commander class to other players computer]
  !!BMx16:A?y30 D?y31 S?y32 U1/?y33 U2/?y34 H?y35 F?y36; [Get Parameters of the Commander]
  !!FU(Check_Com_Masteries):Py10/?y15/0/0/?y50/?y60/?y61/?y62/?y63/?y64/0/0/0/?y65; [Get commander class modifier from function]

*Adjust parameters of Commander according to his choosen class*
  !!VRy30:*y60:100;                     [Increase Attack]
  !!VRy31:*y61:100;                     [Increase Defense]
  !!VRy32:*y64:100+y65;                 [Increase Speed + constant modifier]
  !!VRy33:*y62:100;                     [Increase Min Damage]
  !!VRy34:*y62:100;                     [Increase Max Damage]
  !!VRy35:*y63:100;                     [Increase Health]

  !!if|y50=2/y50=12/y50=22/y50=18;      [Commander Ranger, Sniper, Marksman, Lich] 
    !!VRy36:|4;                         [Set shooting bit if commander is ranger]
    !!BMx16:Fy36;                       [set flags]
    !!BMx16:U3/24;                      [set shots]
  !!en; 

  !!if|y50=4/y50=14/y50=24;             [If Caster, Arch Mage or Warden]
    !!BMx16:Ed1;                        [Commander Caster gets +1 Cast]
  !!en;

  !!if|y50=8/y50=18/y50=28;             [Commander Vampire, Lich or Necromant]
    !!VRy36:|262144;                    [Set Undead bit if commander is Vampire]
    !!BMx16:Fy36;                       [set flags]
    !!BMx16:F?y36;                      [Get flags]
    !!VRy36:|131072;                    [Set No Morale bit if commander is Vampire]
    !!BMx16:Fy36;                       [set flags]
  !!en;  

  !!if&y50=9;                           [Commander Fire Mage]
    !!VRy36:&-524289;                   [Remove Strikes All Enemies around flag]
    !!BMx16:Fy36;                       [set flags]
    !!BMx16:F?y36;                      [Get flags]
    !!VRy36:&-5;                        [Remove shooting bit if commander is FM]
    !!BMx16:Fy36;                       [set flags]
    !!BMx16:U3/0;                       [set zero shots]
  !!en;

  !!if&y50=16/y15=1;                    [Commander King and Mastery enabled]
    !!VRy36:|131072;                    [Set Neutral Morale Flag]
    !!BMx16:Fy36;                       [set flags]
    *!MA:X174/?i;
    *!VRi:|131072;
    *!MA:X174/i;
  !!en;  

  !!BMx16:Ay30 Dy31 Sy32 U1/y33 U2/y34 Hy35; [Set Parameters of the Commander]
!!en;


*When opening the commander dialouge set more corerct values depending on commander class and modifiers 
!?CO0;                                  [When opening the commander screen]

!!HE-1:N?y5; !!FU&y5<0:E;               [Get current hero number]
!!re i/0/6;
  !!CO-1:Pi/?y1;
  !!SN:W^ACM_Commander_Stats_%i^/y1;    [Save all commander attributes]
!!en;

!!COy5:P0/?y10 P1/?y20 P2/?y30 P3/?y40 P4/?y50 P5/?y60 P6/?y70;
!!COy5:S0/?y11 S1/?y21 S2/?y31 S3/?y41 S4/?y51 S5/?y61 S6/?y71;

!!FU(Check_Com_Masteries)&y5>=0/y5<=155:Py5/0/0/0/0/?y80/?y81/?y82/?y83/?y84/0/0/0/?y85; [Get commander class modifier from function]
  !!VRy10:*y80:100;                     [Increase Attack]
  !!VRy20:*y81:100;                     [Increase Defense]
  !!VRy30:*y83:100;                     [Increase Health]
  !!VRy60:*y84:100+y85;                 [Increase Speed + constant modifier]
  !!VRy40:*y82:100;                     [Increase Max Damage]
!!FU(ACM_Calc_Commander_Magic_Resistance)&y5>=0/y5<=155:Py5/d/?y70; [Get value of Magic Resistance Golem and Dwarf type]

!!VRy70&y71=1:-5;                       [Basic Fix strange offsets from native MR]
!!VRy70&y71=2:-10;                      [Advanced]
!!VRy70&y71=3:-15;                      [Expert]
!!VRy70&y71=4:-25;                      [Master]
!!VRy70&y71=5:-35;                      [Grandmaster]
!!COy5:P0/y10 P1/y20 P2/y30 P3/y40 P4/y50 P5/y60 P6/y70; [Set new values]


!?CO1;                                  [When clsoing the commander screen]
!!re i/0/6;  
  !!SN:W^ACM_Commander_Stats_%i^/?y1;   [Restore all commander attributes]
  !!CO-1:Pi/y1;
!!en;


UNC hacks to change commanders attributes per skill at game start. Attack and Defense values are reduced.
!?FU(OnGameEnter);

*#UN:C7772929/(UNC_INT)/7;              [Set commander Attack basic value to 7]
*#UN:C7772939/(UNC_INT)/7;              [Set commander Defense basic value to 7]

*Attack
!!VR(offset:y):S0;
!!UN:C8002440/(offset)/(UNC_INT)/3;     [Change Basic Attack to +3 (8)]

!!VR(offset:y):+4;
!!UN:C8002440/(offset)/(UNC_INT)/7;     [Change Advanced Attack to +7 (12)]

!!VR(offset:y):+4;
!!UN:C8002440/(offset)/(UNC_INT)/12;    [Change Expert Attack to +12 (17)]

!!VR(offset:y):+4;
!!UN:C8002440/(offset)/(UNC_INT)/18;    [Change Master Attack to +18 (23)]

!!VR(offset:y):+4;
!!UN:C8002440/(offset)/(UNC_INT)/25;    [Change GM Attack to +25 (30)]

*Defense
!!VR(offset:y):S5*(UNC_INT);
!!UN:C8002440/(offset)/(UNC_INT)/3;     [Change Basic Defense to +3]

!!VR(offset:y):+4;
!!UN:C8002440/(offset)/(UNC_INT)/7;     [Change Advanced Defense to +7]

!!VR(offset:y):+4;
!!UN:C8002440/(offset)/(UNC_INT)/12;    [Change Expert Defense to +12]

!!VR(offset:y):+4;
!!UN:C8002440/(offset)/(UNC_INT)/18;    [Change Master Defense to +18]

!!VR(offset:y):+4;
!!UN:C8002440/(offset)/(UNC_INT)/25;    [Change GM Defense to +25]


*Magic Resistance
!!VR(offset:y):S30*(UNC_INT);
!!UN:C8002440/(offset)/(UNC_INT)/5;     [Change Basic Magic Resistance to +5]

!!VR(offset:y):+4;
!!UN:C8002440/(offset)/(UNC_INT)/10;    [Change Advanced Magic Resistance to +10]

!!VR(offset:y):+4;
!!UN:C8002440/(offset)/(UNC_INT)/15;    [Change Expert Magic Resistance to +15]

!!VR(offset:y):+4;
!!UN:C8002440/(offset)/(UNC_INT)/25;    [Change Master Magic Resistance to +30]

!!VR(offset:y):+4;
!!UN:C8002440/(offset)/(UNC_INT)/35;    [Change GM Magic Resistance to +35]


****************************************************************************************************
*Commander set casting damage when using their spells*
*casting with commander costs the Hero 2+1*Spell Point for each rank of Magic
*Damage is set and can be increased by hero and artifacts*

!?MR1;

!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>10:E;                          [Exit if no creature cast]

!!BG:N?y1;                              [Attacking Stack]
!!BMy1:T?y2;                            [Creature Type]
!!if&y2>=174/y2<=191;                   [if any commander]
  !!BG:H?y50;                           [Get Hero Number]
  !!FU&y50<0:E;                         [Exit if no Hero]
  !!COy50:S4/?y60 X2/?y40;              [Get Magic Level and Level of Commander]
  !!VRy60:+2;                           [Spell Point cost magic com level +2]
  !!MR:S?y2 N?y5;                       [Get spell number and Creature number which took magic damage]
  
  !!BG:Q?y4;                            [get current acting side]
  !!BA:Hy4/?y4;                         [get current hero]
  !!FU&y4<=0:E;                         [Exit if no Hero]
  !!BG:Q?y30;
  !!VRy30:-1 *-1;                       [Get opposing side]
  !!BA:Hy30/?y31;                       [Enemy Hero to check for enemy Resistance]
  !!FU(ACM_Calc_Commander_Spell_damage):Py50/?y20/y2/1/y5/0/?y60/y31; [Pass Hero Number and return spell damage in y20, Pass Spell Number and Battle State 1=In Fight, 0=No Fight, TargetCreature, pass enemy hero]
  !!MR:N?y5;                            [Get Creature number which took magic damage]
  !!BG:Q?y13;
  !!BMy5:I?y12;                         [Monster side]
  !!if&y13<>y12;                        [if not the same side]
    !!if&y5>=0/y5<=41;                  [If valid creature number]
      !!FU(H3_Calc_Crit_Chance_and_Damage):Py4/?y16/?y99/1/y31/y2/y5; [Pass Hero Number/Returns Crit chance/Crit damage/Battle State /Enemy Hero(y31) /Spell/Target]
      !!VRy9:S0R99;                     [y9 chance to crit (0..99)]
      !!FU(Check_Com_Masteries):Py4/?y70/0/0/?y71; [Get commander class modifier from function]
      !!if&y70=1;                       [If Mastery enabled]
        !!VRy16&y71=4:+15;              [+15% crit chance if Mastery enabled for Caster Commander +15% from the hero makes +30% in total]
        !!VRy16&y71=4:+10;              [+10% crit chance if Mastery enabled for Arch Mage Commander +10% from the hero makes +20% in total]
      !!en;
      !!SN:W^Commander_%Y4_Ancient_Caster^/?y98;      
      !!VRy16&y98=1:+15;                [+15% crit chance if Ancient Caster Commander and +15% from the hero makes +30% in total]

      !!if&y9<y16;                      [if spell hits critical]
        !!VRy20:*y99:100;               [Calc new spell damage based on crit value]        
        !!MR:Fy20;                      [apply new damage]        
        !!BMy5&i^battle_isVisible^:V82; [show crit animation]
      !!en;
    !!en;
  !!en;
  *********   
  !!MR&y9>=y16:Fy20;                    [Set new spell damage if it wasnt a critical hit]    
  !!VRy60:*-1;                          [Negative]
  !!SN:W^Cast_Hit_Counter^/?y75;        [check cast counter for this spell. Multi hitting spells will reduce spell points only once]
  !!HEy50&y75=0:Idy60/1;                [Reduce Spell Points for every level of Magic from Commander +2]
  !!HEy50:I?y11/1;                      [Check Spell Points again]
  !!SN:W^Cast_Hit_Counter^/d1;          [increase counter by one]
  !!HEy50&y11<=0:I0/1;                  [Set Spell Points to zero if negative]

*In this code Commander gets kill count if kill happened with Magic Damage
*Currently disabled because now all spells have a chance to generate kill count
  !!VRy10:Sy50; !!VRy4:Sy5;             [Switch variables to make the code below work]
  !!BG:N?y1;                            [Attacking Stack]
  !!BMy1:T?y2;                          [Creature Type]
  !!BMy4:N?y5 H?y6 L?y7;                [Get Number and Life of attacked Stack and lost Hitpoints]
  !!VRy5:*y6-y7;                        [Get total Life of attacked stack]
  !!FU&y5>y20:E;                        [Exit if not enough damage was dealt]
  *!FU(ACM_Com_Kill_Counter_Fkt)&y2>=174/y2<=191:Py10; [If any commander go to kill count adder function]
!!en;

!?FU(OnBattleRegeneratePhase);
!!SN:W^Cast_Hit_Counter^/0;             [reset var]


Any cast can increase the kill counter with 50% chance
!?FU(OnBeforeBattleAction);
!!SN:W^ACM_BG_Commander_Cast^/-1;       [Reset Var]
!!SN:W^ACM_BG_Commander_Cast_Hero^/-1;  [Reset Var]

!!VRy1:S0R100; !!FU&y1>50:E;            [50% chance to get a kill count per cast]
!!BG:A?y1;                              [battle action]
!!FU&y1<>10:E;                          [Exit if not creature cast]
!!BG:S?y1 Q?y2 N?y3 H?y5;               [get stack paramters]
!!BMy3:T?y4 I?y6;                       [Get Monster Type]
!!if&y1=-1/y5>=0/y4=>174/y4<=191;       [If any commander casted a spell]
  !!FU(Check_Com_Masteries):Py5/0/?y50/?y97/?y98/0/0/0/0/0/?y51; [Get commander kill count and max kill count and spell efficiency]  
  !!FU&y98=0:E;                         [If commander has no class this cast cannot trigger class selection. Must perform a manual kill]
  *!FU|y4=176/y4=185:E;                 [Temple  Guardian]
  *!FU|y4=177/y4=186:E;                 [Succubus]
  *!FU|y4=179/y4=188:E;                 [Brute]
  !!SN&y4=>174/y4<=191:W^ACM_BG_Commander_Cast^/y3; [Set flag to trigger in BG1]
  !!SN&y4=>174/y4<=191:W^ACM_BG_Commander_Cast_Hero^/y5; [Set flag to trigger in BG1]
!!en;

!?FU(OnBattleActionEnd);
!!SN:W^ACM_BG_Commander_Cast^/?y1; !!FU&y1<0:E; [Check for Scan and exit if no summoning was cast]
!!SN:W^ACM_BG_Commander_Cast_Hero^/?y10; !!FU&y10<0:E; [Check for Scan and exit if no summoning was cast]
!!BMy1:T?y2;                            [Creature Type]
!!FU(ACM_Com_Kill_Counter_Fkt)&y2>=174/y2<=191:Py10; [If any commander go to kill count adder function]


*********************************************************
Any cast sets commander spells scaling for Warden class
!?FU(OnBeforeBattleAction);
!!SN:W^ACM_BG_Commander_Cast_Scaling^/-1;       [Reset Var]
!!SN:W^ACM_BG_Commander_Cast_Hero_Scaling^/-1;  [Reset Var]
!!BG:A?y1;                              [battle action]
!!FU&y1<>10:E;                          [Exit if not creature cast]
!!BG:S?y1 Q?y2 N?y3 H?y5;               [get stack paramters]
!!BMy3:T?y4 I?y6;                       [Get Monster Type]
!!if&y1=-1/y5>=0/y4=>174/y4<=191;       [If any commander casted a spell]
  !!FU(Check_Com_Masteries):Py5/0/?y50/?y97/?y98/0/0/0/0/0/?y51; [Get commander kill count and max kill count and spell efficiency]
  !!FU(Commander_Spells_Scaling):Py5/y51/0; [Pass hero ID, Spell modifier, and 0 means save spells.]  
  !!SN&y4=>174/y4<=191:W^ACM_BG_Commander_Cast_Scaling^/y3; [Set flag to trigger in BG1]
  !!SN&y4=>174/y4<=191:W^ACM_BG_Commander_Cast_Hero_Scaling^/y5; [Set flag to trigger in BG1]
!!en;

*Restores default spell values after commander casts
!?FU(OnBattleActionEnd);
!!SN:W^ACM_BG_Commander_Cast_Scaling^/?y1; !!FU&y1<0:E; [Check for Scan and exit if no summoning was cast]
!!SN:W^ACM_BG_Commander_Cast_Hero_Scaling^/?y10; !!FU&y10<0:E; [Check for Scan and exit if no summoning was cast]
!!BMy1:T?y2;                            [Creature Type]
!!FU(Commander_Spells_Scaling)&y2>=174/y2<=191:P0/0/1; Pass hero ID, Spell modifier, and 0 means save spells.


*This functions saves are restores current spell values and sets new scaling based on spell efficiency
!?FU(Commander_Spells_Scaling);
x1=Hero ID, x2=Spell Modifier, x3=0 means save and set, x3=1 means restore

!!if&x3=0;                              [Save Spell values]
  *!IF:M^Now Save^;
  !!SS27:E1/?y20; !!SN:W^Com_Spell_Scaling_27_1^/y20; [27  Shield]
  !!SS27:E2/?y20; !!SN:W^Com_Spell_Scaling_27_2^/y20; [27  Shield]
  !!SS27:E3/?y20; !!SN:W^Com_Spell_Scaling_27_3^/y20; [27  Shield]
  !!VRy21:Sx2:5 -100 *-1; !!VRy21:F20/80; !!SS27:E1/y21; !!SS27:E2/y21; !!SS27:E3/y21;

  !!SS28:E1/?y20; !!SN:W^Com_Spell_Scaling_28_1^/y20; [28  Air Shield]
  !!SS28:E2/?y20; !!SN:W^Com_Spell_Scaling_28_2^/y20; [28  Air Shield]
  !!SS28:E3/?y20; !!SN:W^Com_Spell_Scaling_28_3^/y20; [28  Air Shield]
  !!VRy21:Sx2:5 -100 *-1; !!VRy21:F20/80; !!SS28:E1/y21; !!SS28:E2/y21; !!SS28:E3/y21;

  !!SS29:E1/?y20; !!SN:W^Com_Spell_Scaling_29_1^/y20; [29  Fire Shield]
  !!SS29:E2/?y20; !!SN:W^Com_Spell_Scaling_29_2^/y20; [29  Fire Shield]
  !!SS29:E3/?y20; !!SN:W^Com_Spell_Scaling_29_3^/y20; [29  Fire Shield]
  !!VRy21:Sx2:10 +8; !!VRy21:F2/100; !!SS29:E1/y21; !!SS29:E2/y21; !!SS29:E3/y21;

  !!SS38:P?y20; !!SN:W^Com_Spell_Scaling_38_0^/y20; [38  Resurrection]
  !!SS38:E1/?y20; !!SN:W^Com_Spell_Scaling_38_1^/y20; [38  Resurrection]
  !!SS38:E2/?y20; !!SN:W^Com_Spell_Scaling_38_2^/y20; [38  Resurrection]
  !!SS38:E3/?y20; !!SN:W^Com_Spell_Scaling_38_3^/y20; [38  Resurrection]
  !!VRy21:Sx2*10; !!SS38:P0; !!SS38:E1/y21; !!SS38:E2/y21; !!SS38:E3/y21;

  !!SS39:P?y20; !!SN:W^Com_Spell_Scaling_39_0^/y20; [39  Animate Dead]
  !!SS39:E1/?y20; !!SN:W^Com_Spell_Scaling_39_1^/y20; [39  Animate Dead]
  !!SS39:E2/?y20; !!SN:W^Com_Spell_Scaling_39_2^/y20; [39  Animate Dead]
  !!SS39:E3/?y20; !!SN:W^Com_Spell_Scaling_39_3^/y20; [39  Animate Dead]
  !!VRy21:Sx2*10; !!SS39:P0; !!SS39:E1/y21; !!SS39:E2/y21; !!SS39:E3/y21;

  !!SS48:E1/?y20; !!SN:W^Com_Spell_Scaling_48_1^/y20; [48  Prayer]
  !!SS48:E2/?y20; !!SN:W^Com_Spell_Scaling_48_2^/y20; [48  Prayer]
  !!SS48:E3/?y20; !!SN:W^Com_Spell_Scaling_48_3^/y20; [48  Prayer]
  !!VRy21:Sx2:40; !!VRy21:F2/100; !!SS48:E1/y21; !!SS48:E2/y21; !!SS48:E3/y21;

  !!SS53:E1/?y20; !!SN:W^Com_Spell_Scaling_53_1^/y20; [53  Haste]
  !!SS53:E2/?y20; !!SN:W^Com_Spell_Scaling_53_2^/y20; [53  Haste]
  !!SS53:E3/?y20; !!SN:W^Com_Spell_Scaling_53_3^/y20; [53  Haste]
  !!VRy21:Sx2:30; !!VRy21:F2/100; !!SS53:E1/y21; !!SS53:E2/y21; !!SS53:E3/y21;

  !!SS54:E1/?y20; !!SN:W^Com_Spell_Scaling_54_1^/y20; [54  Slow]
  !!SS54:E2/?y20; !!SN:W^Com_Spell_Scaling_54_2^/y20; [54  Slow]
  !!SS54:E3/?y20; !!SN:W^Com_Spell_Scaling_54_3^/y20; [54  Slow]
  !!VRy21:Sx2:4 -100 *-1; !!VRy21:F20/90; !!SS54:E1/y21; !!SS54:E2/y21; !!SS54:E3/y21;

  !!SS60:P?y20; !!SN:W^Com_Spell_Scaling_60_0^/y20; [60  Hypnotize]
  !!SS60:E1/?y20; !!SN:W^Com_Spell_Scaling_60_1^/y20; [60  Hypnotize]
  !!SS60:E2/?y20; !!SN:W^Com_Spell_Scaling_60_2^/y20; [60  Hypnotize]
  !!SS60:E3/?y20; !!SN:W^Com_Spell_Scaling_60_3^/y20; [60  Hypnotize]
  !!VRy21:Sx2*20; !!SS60:P0; !!SS60:E1/y21; !!SS60:E2/y21; !!SS60:E3/y21;

  *!SS66:E3/?y20; *!SN:W^Com_Spell_Scaling_66^/y20; [66  Fire Elemental]
  *!VRy21:Sx2*20; *!SS66:P100; *!SS66:E1/100; *!SS66:E2/100; *!SS66:E3/100;
  
!!en;

!!if&x3=1;                              [Restore Spell values]
  *!IF:M^Now Restore^;
  !!SN:W^Com_Spell_Scaling_27_1^/?y20; !!SS27:E1/y20; [27  Shield]
  !!SN:W^Com_Spell_Scaling_27_2^/?y20; !!SS27:E2/y20; [27  Shield]
  !!SN:W^Com_Spell_Scaling_27_3^/?y20; !!SS27:E3/y20; [27  Shield]

  !!SN:W^Com_Spell_Scaling_28_1^/?y20; !!SS28:E1/y20; [28  Air Shield]
  !!SN:W^Com_Spell_Scaling_28_2^/?y20; !!SS28:E2/y20; [28  Air Shield]
  !!SN:W^Com_Spell_Scaling_28_3^/?y20; !!SS28:E3/y20; [28  Air Shield]

  !!SN:W^Com_Spell_Scaling_29_1^/?y20; !!SS29:E1/y20; [29  Fire Shield]
  !!SN:W^Com_Spell_Scaling_29_2^/?y20; !!SS29:E2/y20; [29  Fire Shield]
  !!SN:W^Com_Spell_Scaling_29_3^/?y20; !!SS29:E3/y20; [29  Fire Shield]

  !!SN:W^Com_Spell_Scaling_38_0^/?y20; !!SS38:Py20; [38  Resurrection]
  !!SN:W^Com_Spell_Scaling_38_1^/?y20; !!SS38:E1/y20; [38  Resurrection]
  !!SN:W^Com_Spell_Scaling_38_2^/?y20; !!SS38:E2/y20; [38  Resurrection]
  !!SN:W^Com_Spell_Scaling_38_3^/?y20; !!SS38:E3/y20; [38  Resurrection]

  !!SN:W^Com_Spell_Scaling_39_0^/?y20; !!SS39:Py20; [39  Animate Dead]
  !!SN:W^Com_Spell_Scaling_39_1^/?y20; !!SS39:E1/y20; [39  Animate Dead]
  !!SN:W^Com_Spell_Scaling_39_2^/?y20; !!SS39:E2/y20; [39  Animate Dead]
  !!SN:W^Com_Spell_Scaling_39_3^/?y20; !!SS39:E3/y20; [39  Animate Dead]

  !!SN:W^Com_Spell_Scaling_48_1^/?y20; !!SS48:E1/y20; [48  Prayer]
  !!SN:W^Com_Spell_Scaling_48_2^/?y20; !!SS48:E2/y20; [48  Prayer]
  !!SN:W^Com_Spell_Scaling_48_3^/?y20; !!SS48:E3/y20; [48  Prayer]

  !!SN:W^Com_Spell_Scaling_53_1^/?y20; !!SS53:E1/y20; [53  Haste]
  !!SN:W^Com_Spell_Scaling_53_2^/?y20; !!SS53:E2/y20; [53  Haste]
  !!SN:W^Com_Spell_Scaling_53_3^/?y20; !!SS53:E3/y20; [53  Haste]

  !!SN:W^Com_Spell_Scaling_54_1^/?y20; !!SS54:E1/y20; [54  Slow]
  !!SN:W^Com_Spell_Scaling_54_2^/?y20; !!SS54:E2/y20; [54  Slow]
  !!SN:W^Com_Spell_Scaling_54_3^/?y20; !!SS54:E3/y20; [54  Slow]

  !!SN:W^Com_Spell_Scaling_60_0^/?y20; !!SS60:Py20; [60  Hypnotize]
  !!SN:W^Com_Spell_Scaling_60_1^/?y20; !!SS60:E1/y20; [60  Hypnotize]
  !!SN:W^Com_Spell_Scaling_60_2^/?y20; !!SS60:E2/y20; [60  Hypnotize]
  !!SN:W^Com_Spell_Scaling_60_3^/?y20; !!SS60:E3/y20; [60  Hypnotize]

  *!SN:W^Com_Spell_Scaling_66^/?y20; *!SS66:E3/y20; [66  Fire Elemental]
!!en;


*This function adds kill count stacks during combat for your commander
!?FU(ACM_Com_Kill_Counter_Fkt);
x1=hero ID

!!HEx1:O?y12;                           [Get Hero owner]
!!OW&y12>=0:Iy12/?y13; !!FU&y13<>0:E;   [Get if AI(1) or Human(0) and exit if no human]
!!FU(Check_Com_Masteries):Px1/0/?y50/?y97/?y98; [Get commander kill count and max kill count] y50 - kill count, y98 - class
!!SN:W^Commander_Round_Counter^/?y11;
!!FU|y11>=4/y97<=y50:E;                 [Exit so increase cannot happen more than 4 times per combat and not above the maximum boost level]
!!VRz1:S^MAGCHDRN^;
!!SN&i^battle_isVisible^:Pz1;           [Play leach sound]
!!SN:W^Commander_Round_Counter^/d1;
!!SN:W^Commander_Kill_Counter_%X1^/d1;  [Increase counter by one if kill happened]
!!FU(Ancient_Commander_Stat_Counter)&y98=29:Px1/y50; [Call fct to determine and add random stats to Ancient commander. Pass Hero ID]
!!FU(ACM_Select_Commander_Role)&y50=0/y98=0:Px1; [Call DL to select Commander class on first kill. Pass current hero-y10]
!!FU(ACM_Select_Commander_Role_Upg)&y50=29/y98>0/y98<10:Px1; [Open second choice for upgrade class and only if it just has base class]


fct to determine and add random stats to Ancient commander
!?FU(Ancient_Commander_Stat_Counter);
x1=heroID, x2=Kill Count 

!!VRy2&x2<=100:S2;                      [below 100 kill count add 2 random stats]
!!VRy2&x2>100:S4;                       [above 100 kill count add 4 random stats]

!!VRy1:S1R7;                            [Generate a random roll to determine the stat that gets added]
!!SN&y1=1:W^Ancient_Commander_Attack_%X1^/dy2; [Add Attack]
!!SN&y1=2:W^Ancient_Commander_Defense_%X1^/dy2; [Add Defense]
!!SN&y1=3:W^Ancient_Commander_Damage_%X1^/dy2; [Add Damage]
!!SN&y1=4:W^Ancient_Commander_Health_%X1^/dy2; [Add Health]
!!SN&y1=5:W^Ancient_Commander_Speed_%X1^/dy2; [Add Speed]
!!SN&y1=6:W^Ancient_Commander_SpellDmg_%X1^/dy2; [Add SpellDmg]
!!SN&y1=7:W^Ancient_Commander_Passive_%X1^/dy2; [Add Passive]
!!SN&y1=8:W^Ancient_Commander_Aura_%X1^/dy2; [Add Aura]
!!SN:W^Ancient_Commander_Totalbonus_%X1^/dy2; [Add total bonus]


****************************************************************************************************
Astral Spirit new Pacifist ability. Instead of reducing the number of enemy units is will just decrease their HP and Damage
!?FU(OnCombatRound)&v997=0;                                   
!!BA:H0/?y1 Q?f;                        [Attacker]
!!COy1:T?y2 D?y3 E?y4 X2/?y5;           [Get type of Commander, Dead(1) or Alive(0), Level]
!!FU(Check_Com_Masteries):Py1/0/0/0/0/0/0/0/0/0/0/?y45; [Pass Hero Number and return Passive Modifier]
!!VRy45::15-6;                          [+1% reduce per 15% passive modifier]
!!VRy5::4;                              [1% per 4 level]
!!VRy10:S5+y5+y45;                      [Set Amount by which to reduce enemy damage and HP and multiply by passive modifier]
!!VRy10:*-1+100;                        [Substract from 100]
!!SN:W^ACM_Com_%Y1_Passive_9^/?y70;     [Check for 2Supporter ability]
!!VRy2&y70=1:S8;                        [bypass check if ability is active]
!!if&y2=8/y3=0/y4=1;
  !!DO(AC_Function_134)/21/41/1:Py10;   [Run if Astral Spirit is alive]
  !!SN:T^AC_Misc.Pacifist_Ability^/?z1/^damage^/y10;
  !!BU&i^battle_isVisible^:Mz1;
!!en;

!!BA:H1/?y1;                            [Defender]
!!FU&y1<0:E;
!!COy1:T?y2 D?y3 E?y4 X2/?y5;           [Get type of Commander, Dead(1) or Alive(0), Level]
!!FU(Check_Com_Masteries):Py1/0/0/0/0/0/0/0/0/0/0/?y45; [Pass Hero Number and return Passive Modifier]
!!VRy45::15-6;                          [+1% reduce per 15% passive modifier]
!!VRy5::4;                              [1% per 4 level]
!!VRy10:S5+y5+y45;                      [Set Amount by which to reduce enemy damage and HP and multiply by passive modifier]
!!VRy10:*-1+100;                        [Substrac from 100]
!!SN:W^ACM_Com_%Y1_Passive_9^/?y70;     [Check for 2Supporter ability]
!!VRy2&y70=1:S8;                        [bypass check if ability is active]
!!if&y2=8/y3=0/y4=1;
  !!DO(AC_Function_134)/0/20/1:Py10;    [Run if Astral Spirit is alive]
  !!SN:T^AC_Misc.Pacifist_Ability^/?z1/^damage^/y10;
  !!BU&i^battle_isVisible^:Mz1;
!!en;


!?FU(AC_Function_134);                  [decrease Units Stats]
!!BMx16:T?y1 N?y20;
!!FU|y1=145/y1=146/y1=147/y1=148/y1=149/y20=0:E;
!!BMx16:H?y2 U1/?y3 U2/?y4 L?y5;        [Get HP, min and max damage]
!!VRy2&y2>3:*x1:100;                    [Reduce HP]
!!VRy3&y3>2:*x1:100;                    [Reduce Min Dmg]
!!VRy4&y3>3:*x1:100;                    [Reduce Max Dmg]
!!BMx16&y2>0:Hy2;                       [Set new HP and Damage]
!!BMx16&y3>0:U1/y3;                     [Set new HP and Damage]
!!BMx16&y4>0:U2/y4;                     [Set new HP and Damage]

!!if&y5>0;                              [weird fix is necssary if life of stacks was reduced before pacifist ability, because it can reduce life below zero]
  !!BMx16:H?y2 L?y5;                    [Get HP, min and max damage]
  !!VRy5:Sy2-1;
  !!BMx16:Ly5;                          [Set new lost life value]
!!en;


; Summon elemental
Astral Spirit can only summon one Elemental per combat. This Elemental gets stronger with every commander and magic level
!?FU(OnCombatRound)&v997=0;
!!BA:H0/?y1;
!!BA:O?y30/?y20;                        [Get Owner of Defender]
!!OW:Iy20/?y20;                         [Get if AI or Human]

!!COy1:T?y10 X2/?y11 S4/?y12;           [Get Commander Type Level and Magic Level]
!!VRy15:Sy12-1*-1;                      [Calc Magic Level of Commander to reduce actual casts of commander]
!!re i/0/10;
  !!BMi:T?y13;
  !!BMi&y13=182/y12>0/y10=8/y20=0:Edy15;[Set casts to one for humans]
!!en;

!!BA:H1/?y1; !!FU&y1<0:E;
!!COy1:T?y10 X2/?y11 S4/?y12;           [Get Commander Type Level and Magic Level]
!!VRy15:Sy12-1*-1;
!!re i/21/31;
  !!BMi:T?y13;                          [Get creature type]
  !!BMi&y13=191/y12>0/y10=8/y20=0:Edy15;[Set casts to one for humans]
!!en;

!?BG0;
!!SN:W^Scan_Summoned_Air_Element^/-1;   [Reset Var]
!!BG:A?y1;
!!FU&y1<>10:E;                          [Exit if not creature cast]
!!BG:S?y1 Q?y2 N?y3 H?y5;
!!BMy3:T?y4;                            [Get Monster Type]
!!if&y1=-1/y5>=0;                       [If Astral Spirit attacker casted a spell]
  !!SN|y4=191/y4=182:W^Scan_Summoned_Air_Element^/y2; [Set Flag 112 Air Elemental]
!!en;

!?FU(OnBattleActionEnd);
!!SN:W^Scan_Summoned_Air_Element^/?y1; !!FU&y1<0:E; [Check for Scan and exit if no summoning was cast]
!!BG:H?y50;
!!COy50:X2/?y40 S4/?y60;                [Get Commander Level and Magic Level of Commander]
!!FU(Check_Com_Masteries):Py50/0/0/0/0/0/0/0/0/0/?y41; [Get commander class Spell Damage modifier from function]
!!FU(Astral_Spirit_Calc_Air_Element):Py40/y60/y41/?y30/?y31/?y32/y50; [Pass values and return Health and Damage of Element]

!!re i/0/186;                           [Loop Battlefield]
  !!BU:Ei/?y10;                         [Get Stack Number at Position]
  !!if&y10>0/y10<42;                    [If valid Stack]
    !!BMy10:T?y11 F?y12 N?y13 G69/?y14/?y15 I?y16; !!VRy12:&4194304; [Check Monster Type and Summon Bit]
    !!BMy10&y11=112/y12>0/y14=0/y16=y1:N1 Hy30 U1/y31 U2/y32 S7 M69/99/3; [Set attributes of summoned Air Elemental]    
    !!if&y11=112/y12>0/y14=0/y16=y1;    [Exit Loop]
      !!br;                             [Exit Loop when stack was found]
    !!en; 
  !!en;
!!en;


!?FU(Astral_Spirit_Calc_Air_Element);
x1=ComLevel, x2=ComMagicLvl, x3=ComSpellModifier, x4=returns HP, x5=returns min damage, x6=returns max damage, x7=HeroNumber

!!VRy42:Sx1*5;                          [Five times Comm level]
!!VRy42&x1>=30:Sx1*10;                  [Ten times Comm level]
!!VRy42&x1>=50:Sx1*20;                  [Twenty times Comm level]
!!VRy42&x1>=55:Sx1*25;                  [Twentyfive times Comm level]

!!VRx4:S30+y42*x2*x3:100; !!VRx4&x4=0:S1;[Health 30+Com_Level*Magic_Lvl*Spell Modifier]
!!VRx5:S2+x1*x2*x3:150; !!VRx5&x5=0:S1; [Min Damage]
!!VRx6:S8+x1*x2*x3:100; !!VRx6&x6=0:S1; [Max Damage]

*Summoner specialists, they increase HP by 125 +3*HeroLvL.
!!if|x7=88/x7=129;                      [88 Alamar and 129 Thunar]
  !!VRy40:Sx1*3+122;                    [HP increase is 125+3*Herolvl%]
  !!VRx4:*y40:100;                      [Set new total HP value]
!!en;

!!ifx7>=0;                              [Artifact Bonus]
  !!HEx7:A2/143/?i/?y28;                [Check Hero artifact for summoning scroll]
  !!VRx4&y28>0:+1000;                   [If Scroll equipped give +1000HP]
!!en;


****************************************************************************************************
!?FU(ACM_Calc_Commander_Spell_damage);
x1=Hero Number, x2=returns spell damage from commander, x3 Spell Number, x4=In Fight 1  0=No Fight, x5=Target Creature, X6=Crit(1) or No Crit(0)
x7=spell points x8=spell damage modifier, x8=enemy hero

!!COx1:X2/?y40 S4/?y60;                 [Get Commander Level and Magic Level of Commander]
!!HEx1:I?y10/1;                         [Get Hero Spell Points]
!!VRy46:Sy40*1;                         [+1 Base Spell Damage per Commander level]
!!VRy46&y40>20:Sy40*2;                  [+2 Base Spell Damage per Commander level at level 20]
!!VRy46&y40>30:Sy40*3;                  [+3 Base Spell Damage per Commander level at level 30]
!!VRy46&y40>40:Sy40*4;                  [+4 Base Spell Damage per Commander level at level 40]
!!VRy46&y40>45:Sy40*5;                  [+5 Base Spell Damage per Commander level at level 45]
!!VRy46&y40>50:Sy40*6;                  [+6 Base Spell Damage per Commander level at level 50]

*Set base spell damage
!!VRy20:S20; !!VRy20&y60=1:S20; !!VRy20&y60=2:S30; !!VRy20&y60=3:S60; !!VRy20&y60=4:S100; !!VRy20&y60=5:S200; [Set Base damage of cast 20 for basic 200 for GM]
!!VRy20:+y46;                           [Add some more base spell damage with each level]

!!HEx1:S25/?y30;                        [Get sorcery from hero]
!!SN:W^H3_Sorcery_0_Hero%X1^/?y31;
!!SN:W^H3_Sorcery_1_Hero%X1^/?y32;
!!VRy33:S100; !!VRy33&y30=1:S110; !!VRy33&y30=2:S120; !!VRy33&y30=3/y31=0/y32=0:S130; !!VRy33&y30=3/y31=1/y32=0:S140; !!VRy33&y30=3/y31=1/y32=1:S150; [Add Sorcery Damage +10%-50%]
!!VRy20:*y33:100;                       [Calc new Spell Damage enhanced by Sorcery from Hero]

!!FU(H3_Calc_Normal_Spell_Damage):Px1/?y99/?y98/x4/x3/0; [Pass Hero Number and Give Back Damage in y99 and Extra Damage Option, Battle State in x4 and Spell Number]
!!FU(Check_Com_Masteries):Px1/0/0/0/0/0/0/0/0/0/?y41; [Get commander class Spell Damage modifier from function]

!!VRy45:Sy40*1;                         [+1% Base Spell Damage per Commander Level]
!!VRy41:-100;                           [Substract minus 100 so we only add percentage]
!!VRy99:+y41+y45;                       [add percentage spell damage to base damage from commander]
!!VRy20:*y99:100;                       [Set new Spell Damage]

*set the damage scaling of different spells that are cast by the commander
!!VRy50&x3=15:S75; !!VRy51&x3=15:S1;    [Magic Arrow is 75% damage and costs 1 additional spell points]
!!VRy50&x3=16:S90; !!VRy51&x3=16:S2;    [Ice Bolt is 90% damage and costs 2 additional spell points]
!!VRy50&x3=17:S100; !!VRy51&x3=17:S3;   [Lightning Strike is 100% damage and costs 3 additional spell points]
!!VRy50&x3=20:S70; !!VRy51&x3=20:S5;    [Frost Ring is 70% damage and costs 5 additional spell points]
!!VRy50&x3=21:S50; !!VRy51&x3=21:S5;    [Fire Ball is 50% damage and costs 5 additional spell points]
!!VRy50&x3=23:S75; !!VRy51&x3=23:S7;    [Meteor Shower is 75% damage and costs 7 additional spell points]
!!VRy50&x3=22:S70; !!VRy51&x3=22:S7;    [Inferno is 70% damage and costs 7 additional spell points]
!!VRy50&x3=24:S60; !!VRy51&x3=24:S9;    [Death Ripple is 60% damage and costs 9 additional spell points]
!!VRy50&x3=25:S60; !!VRy51&x3=25:S9;    [Destroy Undead is 60% damage and costs 9 additional spell points]
!!VRy50&x3=19:S75; !!VRy51&x3=19:S12;   [Chain Lightning is 75% damage and costs 12 additional spell points]
!!VRy50&x3=18:S140; !!VRy51&x3=18:S15;  [Implosion is 140% damage and costs 15 additional spell points]
!!VRy50&x3=26:S100; !!VRy51&x3=26:S15;  [Armageddon is 100% damage and costs 15 additional spell points]

!!VRy20:*y50:100;                       [Set new Spell Damage with spell ID modifier]
!!VRy60:+y51;                           [Set total Spell Point cost]
!!VRy20&y10<y60::2;                     [If Hero has not enough Mana cast deals only 50% damage. Each level of Commander magic incerases the cost to cast the spell]

!!if&x5>=0/x5<=41/x4=1;                 [if valid stack and in battle]
  !!BMx5:T?y80;                         [get creature type]
  !!VRy20&y80=32:*60:100;               [Stone Golem reduce damage by 40%]
  !!VRy20&y80=33:*40:100;               [Iron Golem reduce damage by 60%]
  !!VRy20&y80=116:*20:100;              [Gold Golem reduce damage by 80%]
  !!VRy20&y80=117:*5:100;               [Diamond Golem reduce damage by 95%]
  32  Stone Golem
  33  Iron Golem 
  116 Gold Golem
  117 Diamond Golem 
!!en;

!!if&x8>=0/x8<=155/x4=1;                [if any enemy hero and in fight]
  !!VRy73:S100;                         [start value is 100]
  !!VRy74:S0;                           [start value is 0]
  !!VRy75:S0;                           [start value is 0]
  !!HEx8:S26/?y70;                      [Checke ob der Held Resistance hat und Speichere in y20]
  !!SN:W^H3_Resistance_0_Hero%X8^/?y71; [Checke ob der Held Master Resistance hat und Speichere in y21]
  !!SN:W^H3_Resistance_1_Hero%X8^/?y72;
  !!VRy73&y70=1/y71=0/y72=0:S90; !!VRy73&y70=2/y71=0/y72=0:S85; !!VRy73&y70=3/y71=0/y72=0:S80; !!VRy73&y70=3/y71=1/y72=0:S75; !!VRy73&y70=3/y71=1/y72=1:S70; [amount of magic resistance]
  !!VRy20:*y73:100;                     [Set new reduced Spell Damage if enemy had resistance]
  !!HEx8:A2/37/?y10/?y15; !!VRy74&y15=1:+50; [37 Quiet Eye of the Dragon -50 flat magic damage]
  !!HEx8:A2/39/?y10/?y15; !!VRy74&y15=1:+50; [39 Dragon Scale Shield -50 flat magic damage]
  !!HEx8:A2/43/?y10/?y15; !!VRy74&y15=1:+50; [43  Necklace of Dragonteeth -50 flat magic damage]
  !!VRy20:-y74;                         [reduce magic damage by flat amount from artifacts]
  !!VRy20&y20<=0:S0;                    [Set zero if value is negative]

  !!VRy75&y70=1/y71=0/y72=0:S10; !!VRy75&y70=2/y71=0/y72=0:S15; !!VRy75&y70=3/y71=0/y72=0:S20; !!VRy75&y70=3/y71=1/y72=0:S25; !!VRy75&y70=3/y71=1/y72=1:S30; [amount of magic resistance]
  !!HEx8:A2/57/?y10/?y15; !!VRy75&y15=1:+10; [57 Garniture of Interference]
  !!HEx8:A2/58/?y10/?y15; !!VRy75&y15=1:+15; [58 Surcoat of Counterpoise]
  !!HEx8:A2/59/?y10/?y15; !!VRy75&y15=1:+20; [59 Boots of Polarity]
  !!VRy76:S0R100;                       [make a random roll]
  !!VRy20&y76<=y75:S0;                  [Set spell damage to zero, that simulates a resistance event]
!!en;

!!VRx2:Sy20;                            [Return Spell Damage]
!!VRx7:Sy60;                            [Return Spell Points]
!!VRx8:Sy50;                            [Return Spell ID modifier]

15  Magic Arrow
16  Ice Bolt
17  Lightning Bolt
18  Implosion
19  Chain Lightning
20  Frost Ring
21  Fireball
22  Inferno
23  Meteor Shower
24  Death Ripple
25  Destroy Undead
26  Armageddon 


*Physical Damage Counter to show in Hero bonus list*
!?MF1;

!!BG:A?y1;                              [Aktion in y1]
!!if&y1=6|y1=7;                         [Attack or Shoot]
  !!BG:N?y1;                            [Attacking Stack]
  !!MF:N?y4;                            [damage receiving stack]
  !!SN:W^Damage_Counter_Attacking_Stack^/?y50;
  !!VRy1&y4=y1/y50>=0/y50<=41:Sy50;     [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
  !!SN:W^Damage_Counter_Attacking_Stack^/y4;

  !!MF:F?y3;                            [Get damage]
  !!FU&y3=0:E;                          [Exit if Zero damage]
  !!BG:H?y10;                           [Get Hero Number]
  !!if&y10>=0/y10<=155;
    !!BMy4:N?y5 H?y6 L?y7;              [Get Number and Life of attacked Stack and lost Hitpoints]
    !!VRy5:*y6-y7;                      [Get total Life of attacked stack]
    !!VRy3&y3>y5:Sy5;                   [Only count the real damage applied]
    !!SN:W^Damage_Counter_Hero_%Y10^/dy3;[Increase damage counter]
    !!SN:W^Damage_Counter_Hero_Temp_%Y10^/dy3; [Increase counter by one if kill happened]
  !!en;
!!en;

*Magic damage counter to show in Hero bonus list*
!?MR1;

!!BG:A?y1;                              [Aktion in y1]
!!if&y1=1;                              [If Hero cast]
  !!MR:N?y4 F?y3;                       [damage receiving stack and get damage]
  !!FU&y3=0:E;                          [Exit if Zero damage]
  !!BG:H?y10;                           [Get Hero Number]
  !!if&y10>=0/y10<=155;
    !!BMy4:N?y5 H?y6 L?y7;              [Get Number and Life of attacked Stack and lost Hitpoints]
    !!VRy5:*y6-y7;                      [Get total Life of attacked stack]
    !!VRy3&y3>y5:Sy5;                   [Only count the real damage applied]
    !!SN:W^Magic_Damage_Counter_Hero_%Y10^/dy3; [Increase damage counter]
    !!SN:W^Magic_Damage_Counter_Hero_Temp_%Y10^/dy3; [Increase counter by one if kill happened]
  !!en;
!!en;


*Reduce casts of all Commanders by -1 so with no Magic Skill they cannot cast
*Apply Commander combat buff
!?FU(OnCombatRound)&v997=0;             [On First visible combat round]
!!re y10/0/155;                         [Reset Temp vars before every fight for every hero]
  !!SN:W^Damage_Counter_Hero_Temp_%Y10^/0;
  !!SN:W^Magic_Damage_Counter_Hero_Temp_%Y10^/0;
!!en;
!!SN:W^Commander_Round_Counter^/0;


!?FU(OnAfterTacticsPhase); [Moved timing from OnCombatRound to OnAfterTacticsPhase to have correct move order in battle]
!!DO(Apply_Commander_Kill_Bonus)/0/41/1:P; [loop through Stacks]

; Restore commander class on Battle Replay
; by Archer30
!?FU(OnSetupBattlefield);
!!VRi^Commander_SavedClass_0^:S0;
!!VRi^Commander_SavedClass_1^:S0;
!!VRi^Commander_SavedKillCount_0^:S0;
!!VRi^Commander_SavedKillCount_1^:S0;

!!re i/(BATTLE_LEFT)/i^battle_hero_vs_hero^;
  !!FU(Check_Com_Masteries):Pi^battle_hero_%i^/0/?i^Commander_SavedKillCount_%i^/?t/?i^Commander_SavedClass_%i^; [Pass Hero Number and return current com class]
!!en;


!?FU(ACM_SetCommanderClass);
!#VA(hero:x) (class:x);

!!HE(hero)&(hero)=(NO_HERO):N?(hero);

!!if&(class)=(ACM_CMD_CLASS_FIGHTER);  !!VRi^Commander_Fighter_%X1^:S1;!!el;  !!VRi^Commander_Fighter_%X1^:S0;!!en;
!!if&(class)=(ACM_CMD_CLASS_RANGER);  !!VRi^Commander_Ranger_%X1^:S1;!!el;  !!VRi^Commander_Ranger_%X1^:S0;!!en;
!!if&(class)=(ACM_CMD_CLASS_DEFENDER);  !!VRi^Commander_Defender_%X1^:S1;!!el;  !!VRi^Commander_Defender_%X1^:S0;!!en;
!!if&(class)=(ACM_CMD_CLASS_CASTER);  !!VRi^Commander_Caster_%X1^:S1;!!el;  !!VRi^Commander_Caster_%X1^:S0;!!en;
!!if&(class)=(ACM_CMD_CLASS_SUPPORTER);  !!VRi^Commander_Supporter_%X1^:S1;!!el;  !!VRi^Commander_Supporter_%X1^:S0;!!en;
!!if&(class)=(ACM_CMD_CLASS_LEADER);  !!VRi^Commander_Leader_%X1^:S1;!!el;  !!VRi^Commander_Leader_%X1^:S0;!!en;
!!if&(class)=(ACM_CMD_CLASS_SCOUT);  !!VRi^Commander_Scout_%X1^:S1;!!el;  !!VRi^Commander_Scout_%X1^:S0;!!en;
!!if&(class)=(ACM_CMD_CLASS_UNDEAD);  !!VRi^Commander_Undead_%X1^:S1;!!el;  !!VRi^Commander_Undead_%X1^:S0;!!en;
!!if&(class)=(ACM_CMD_CLASS_FIREMAGE);  !!VRi^Commander_FireMage_%X1^:S1;!!el;  !!VRi^Commander_FireMage_%X1^:S0;!!en;
!!if&(class)=(ACM_CMD_CLASS_DRAGONSLAYER);  !!VRi^Commander_Dragonslayer_%X1^:S1;!!el;  !!VRi^Commander_Dragonslayer_%X1^:S0;!!en;
!!if&(class)=(ACM_CMD_CLASS_SNIPER);  !!VRi^Commander_Sniper_%X1^:S1;!!el;  !!VRi^Commander_Sniper_%X1^:S0;!!en;
!!if&(class)=(ACM_CMD_CLASS_RETALIATOR);  !!VRi^Commander_Retaliator_%X1^:S1;!!el;  !!VRi^Commander_Retaliator_%X1^:S0;!!en;
!!if&(class)=(ACM_CMD_CLASS_ARCHMAGE);  !!VRi^Commander_ArchMage_%X1^:S1;!!el;  !!VRi^Commander_ArchMage_%X1^:S0;!!en;
!!if&(class)=(ACM_CMD_CLASS_CONSTRUCTOR);  !!VRi^Commander_Constructor_%X1^:S1;!!el;  !!VRi^Commander_Constructor_%X1^:S0;!!en;
!!if&(class)=(ACM_CMD_CLASS_KING);  !!VRi^Commander_King_%X1^:S1;!!el;  !!VRi^Commander_King_%X1^:S0;!!en;
!!if&(class)=(ACM_CMD_CLASS_PROSPECTOR);  !!VRi^Commander_Prospector_%X1^:S1;!!el;  !!VRi^Commander_Prospector_%X1^:S0;!!en;
!!if&(class)=(ACM_CMD_CLASS_LICH);  !!VRi^Commander_Lich_%X1^:S1;!!el;  !!VRi^Commander_Lich_%X1^:S0;!!en;
!!if&(class)=(ACM_CMD_CLASS_VAMPIRE);  !!VRi^Commander_Vampire_%X1^:S1;!!el;  !!VRi^Commander_Vampire_%X1^:S0;!!en;
!!if&(class)=(ACM_CMD_CLASS_PALADIN);  !!VRi^Commander_Paladin_%X1^:S1;!!el;  !!VRi^Commander_Paladin_%X1^:S0;!!en;
!!if&(class)=(ACM_CMD_CLASS_MARKSMAN);  !!VRi^Commander_Marksmen_%X1^:S1;!!el;  !!VRi^Commander_Marksmen_%X1^:S0;!!en;
!!if&(class)=(ACM_CMD_CLASS_AVENGER);  !!VRi^Commander_Avenger_%X1^:S1;!!el;  !!VRi^Commander_Avenger_%X1^:S0;!!en;
!!if&(class)=(ACM_CMD_CLASS_WARDEN);  !!VRi^Commander_Warden_%X1^:S1;!!el;  !!VRi^Commander_Warden_%X1^:S0;!!en;
!!if&(class)=(ACM_CMD_CLASS_ARCANIST);  !!VRi^Commander_Arcanist_%X1^:S1;!!el;  !!VRi^Commander_Arcanist_%X1^:S0;!!en;
!!if&(class)=(ACM_CMD_CLASS_GENERAL);  !!VRi^Commander_General_%X1^:S1;!!el;  !!VRi^Commander_General_%X1^:S0;!!en;
!!if&(class)=(ACM_CMD_CLASS_LANCER);  !!VRi^Commander_Lancer_%X1^:S1;!!el;  !!VRi^Commander_Lancer_%X1^:S0;!!en;
!!if&(class)=(ACM_CMD_CLASS_NECROMANT);  !!VRi^Commander_Necromant_%X1^:S1;!!el;  !!VRi^Commander_Necromant_%X1^:S0;!!en;
!!if&(class)=(ACM_CMD_CLASS_ANCIENT);  !!VRi^Commander_Ancient_%X1^:S1;!!el;  !!VRi^Commander_Ancient_%X1^:S0;!!en;

!?FU(OnBattleReplay);
!!re i/(BATTLE_LEFT)/i^battle_hero_vs_hero^;
  ; Restore commander class
  !!FU(Check_Com_Masteries):Pi^battle_hero_%i^/0/?t/?t/?(class:y);

  !!if&(class)<>i^Commander_SavedClass_%i^;
    !!FU(ACM_SetCommanderClass):Pi^battle_hero_%i^/i^Commander_SavedClass_%i^;
  !!en;

  ; Restore kill count
  !!VR(hero:y):Si^battle_hero_%i^;
  !!VRi^Commander_Kill_Counter_%(hero)^:Si^Commander_SavedKillCount_%i^;
!!en;

!!SN:W^Commander_Round_Counter^/0;      [Reset round counter for max 3 gains per battle]

!!BA:H0/?y1;                            [Attacker]
!!if&y1>=0/y1<=155;
  !!SN:W^Damage_Counter_Hero_%Y1^/?y12;
  !!SN:W^Damage_Counter_Hero_Temp_%Y1^/?y10;

  !!SN:W^Magic_Damage_Counter_Hero_%Y1^/?y14;
  !!SN:W^Magic_Damage_Counter_Hero_Temp_%Y1^/?y15;

  !!VRy12:-y10;                         [Substract temp value from real value]
  !!VRy14:-y15;
  !!SN:W^Damage_Counter_Hero_%Y1^/y12;  [apply new value again]
  !!SN:W^Magic_Damage_Counter_Hero_%Y1^/y14;
!!en;

!!BA:H1/?y1;                            [Defender]
!!if&y1>=0/y1<=155;
  !!SN:W^Damage_Counter_Hero_%Y1^/?y12;
  !!SN:W^Damage_Counter_Hero_Temp_%Y1^/?y10;

  !!SN:W^Magic_Damage_Counter_Hero_%Y1^/?y14;
  !!SN:W^Magic_Damage_Counter_Hero_Temp_%Y1^/?y15;

  !!VRy12:-y10;                         [Substract temp value from real value]
  !!VRy14:-y15;
  !!SN:W^Damage_Counter_Hero_%Y1^/y12;  [apply new value again]
  !!SN:W^Magic_Damage_Counter_Hero_%Y1^/y14;
!!en;


!?FU(ACM_Select_Commander_Role);

!!VRy99:Sx1;                            [y99 holds current Hero ID]
!!HEy99:O?y80;                          [Get hero color]
!!OW:Gy80/?y81;                         [Check if a player IS a player that is sitting before the PC screen]
!!FU&y81=0:E;                           [Exit if not sitting before PC]

!!SN:W^ACM_Commander_Hero_ID^/y99; 
!!DL274:N^Com_Opt.txt^;                 [parse dialogue]

!!VRz1:S^C_Opt1.pcx^; !!DL274:A1/11/z1/1;[Picture of Class]
!!VRz2:S^C_Opt2.pcx^; !!DL274:A2/11/z2/1;
!!VRz3:S^C_Opt3.pcx^; !!DL274:A3/11/z3/1;
!!VRz4:S^C_Opt4.pcx^; !!DL274:A4/11/z4/1;
!!VRz5:S^C_Opt5.pcx^; !!DL274:A5/11/z5/1;
!!VRz6:S^C_Opt6.pcx^; !!DL274:A6/11/z6/1;
!!VRz7:S^C_Opt7.pcx^; !!DL274:A7/11/z7/1;
!!VRz8:S^C_Opt8.pcx^; !!DL274:A8/11/z8/1;
!!VRz9:S^C_Opt9.pcx^; !!DL274:A9/11/z9/1;

!!SN:T^AC_Misc.Commander_Opt_1^/?z20; !!DL274:A20/3/z20/1; [Name of Class]
!!SN:T^AC_Misc.Commander_Opt_2^/?z21; !!DL274:A21/3/z21/1;
!!SN:T^AC_Misc.Commander_Opt_3^/?z22; !!DL274:A22/3/z22/1;
!!SN:T^AC_Misc.Commander_Opt_4^/?z23; !!DL274:A23/3/z23/1;
!!SN:T^AC_Misc.Commander_Opt_5^/?z24; !!DL274:A24/3/z24/1;
!!SN:T^AC_Misc.Commander_Opt_6^/?z25; !!DL274:A25/3/z25/1;
!!SN:T^AC_Misc.Commander_Opt_7^/?z26; !!DL274:A26/3/z26/1;
!!SN:T^AC_Misc.Commander_Opt_8^/?z27; !!DL274:A27/3/z27/1;
!!SN:W^Fire_Mage_Unlocked^/?y50;
!!SN&y50=1:T^AC_Misc.Commander_Opt_9^/?z28; !!SN&y50=0:T^AC_Misc.Commander_Opt_Secret^/?z28; !!DL274:A28/3/z28/1;

!!SN:T^AC_Misc.Commander_Opt_Text^/?z60; !!DL274:A60/3/z60/1; [heading additional game options]

!!SN:T^AC_Misc.Commander_Opt_Hint_1^/?z40; !!DL274:H1/40;
!!SN:T^AC_Misc.Commander_Opt_Hint_2^/?z41; !!DL274:H2/41;
!!SN:T^AC_Misc.Commander_Opt_Hint_3^/?z42; !!DL274:H3/42;
!!SN:T^AC_Misc.Commander_Opt_Hint_4^/?z43; !!DL274:H4/43;
!!SN:T^AC_Misc.Commander_Opt_Hint_5^/?z44; !!DL274:H5/44;
!!SN:T^AC_Misc.Commander_Opt_Hint_6^/?z45; !!DL274:H6/45;
!!SN:T^AC_Misc.Commander_Opt_Hint_7^/?z46; !!DL274:H7/46;
!!SN:T^AC_Misc.Commander_Opt_Hint_8^/?z47; !!DL274:H8/47;
!!SN&y50=1:T^AC_Misc.Commander_Opt_Hint_9^/?z48; !!SN&y50=0:T^AC_Misc.Commander_Opt_Hint_Secret^/?z48; !!DL274:H9/48;

!!SN:T^AC_Misc.Commander_Opt_Hint_Play^/?z61; !!DL274:H30722/61;

!!SN:W^Commander_Fighter_%Y99^/?y1;     [Check if options have already been activated]
!!SN:W^Commander_Ranger_%Y99^/?y2;
!!SN:W^Commander_Defender_%Y99^/?y3;
!!SN:W^Commander_Caster_%Y99^/?y4;
!!SN:W^Commander_Supporter_%Y99^/?y5;
!!SN:W^Commander_Leader_%Y99^/?y6;
!!SN:W^Commander_Scout_%Y99^/?y7;
!!SN:W^Commander_Undead_%Y99^/?y8;
!!SN:W^Commander_FireMage_%Y99^/?y9;
!!DL274:A40/4/y1/1;                     [switch def cardre to 0 or 1]
!!DL274:A41/4/y2/1;
!!DL274:A42/4/y3/1;
!!DL274:A43/4/y4/1;
!!DL274:A44/4/y5/1;
!!DL274:A45/4/y6/1;  
!!DL274:A46/4/y7/1;  
!!DL274:A47/4/y8/1;  
!!DL274:A48/4/y9/1;                     

!!DL274:S;                              [Show Dialogue]


!?DL&v998=274/v999>=1/v999<=11/v1000=14; [right click on the options to show text for upgrade and description]

!!DL275:N^Com_Class.txt^;               [parse dialogue]
!!SN|v999=1:T^AC_Misc.Play_Com_Opt_1^/?z1; [set text for 1st]
!!SN|v999=2:T^AC_Misc.Play_Com_Opt_2^/?z1; [Show Dialogue if Player activated the 10 skills option]
!!SN|v999=3:T^AC_Misc.Play_Com_Opt_3^/?z1;
!!SN|v999=4:T^AC_Misc.Play_Com_Opt_4^/?z1;
!!SN|v999=5:T^AC_Misc.Play_Com_Opt_5^/?z1;
!!SN|v999=6:T^AC_Misc.Play_Com_Opt_6^/?z1;
!!SN|v999=7:T^AC_Misc.Play_Com_Opt_7^/?z1;
!!SN|v999=8:T^AC_Misc.Play_Com_Opt_8^/?z1;
!!SN:W^Fire_Mage_Unlocked^/?y50;
!!SN&v999=9/y50=1:T^AC_Misc.Play_Com_Opt_9^/?z1; !!SN&v999=9/y50=0:T^AC_Misc.Play_Com_Opt_Secret^/?z1; 

!!FU(Check_Com_Masteries):P-1/0/0/0/0/?y90/?y91/?y92/?y93/?y20/?y21/?y22/?y23/?y24/v999/0; [Get commander class modifier from function]
!!FU(Check_Com_Masteries):P-1/0/0/0/0/?y86/?y87/d/d/d/d/d/d/d/v999/1; [Get commander class modifier from function]
!!SN:T^AC_Misc.Bonus_Table_Commander_Class^/?z2; !!SN:Iz2/?z2; [set text for 1st]
!!VRz30:S^^;
!!VRz30&y24>=0:S^+^;
!!SN:T^AC_Misc.Bonus_Table_Commander_ClassII^/?z3; !!SN:Iz3/?z3; [set text for 1st]
!!SN:T^AC_Misc.Commander_Opt_%V999^/?z5;
!!SN&y50=0:T^AC_Misc.Bonus_Table_Secret_Class^/?z5;
!!SN:T^AC_Misc.Bonus_Table_Commander_ClassIII^/?z4; !!SN:Iz4/?z4; [set text for 1st]
!!SN:W^ACM_Commander_Hero_ID^/?y99;
!!FU(Set_Com_Battle_Description):Pv999/y99/0/y22/0/5/0;

!!DL275:A1/3/z1/1; 
!!DL275:A2/3/z2/1;
!!DL275:A3/3/z3/1;
!!DL275:A4/3/z4/1;
!!DL275:A5/3/z11/1;
!!FU(DL_ShowPopup):P275;                [Show Popup DL]


!?DL&v998=274/v999>=40/v999<=48/v1000=13; [LMB on the options icons to activate class]
!!VRz1:S^Button.wav^;
!!SN:Pz1;                               [Play Sound]

!!SN:W^ACM_Commander_Hero_ID^/?y99;
!!SN:W^Commander_Fighter_%Y99^/?y1;     [Check if options have already been activated]
!!SN:W^Commander_Ranger_%Y99^/?y2;
!!SN:W^Commander_Defender_%Y99^/?y3;
!!SN:W^Commander_Caster_%Y99^/?y4;
!!SN:W^Commander_Supporter_%Y99^/?y5;
!!SN:W^Commander_Leader_%Y99^/?y6;
!!SN:W^Commander_Scout_%Y99^/?y7;
!!SN:W^Commander_Undead_%Y99^/?y8;
!!SN:W^Commander_FireMage_%Y99^/?y9;

!!VRy50:Sy1+y2+y3+y4+y5+y6+y7+y8+y9;    [Get number of activated options]

!!if&y50>0;
  !!SN:W^Commander_Fighter_%Y99^/0;     
  !!SN:W^Commander_Ranger_%Y99^/0;
  !!SN:W^Commander_Defender_%Y99^/0;
  !!SN:W^Commander_Caster_%Y99^/0;
  !!SN:W^Commander_Supporter_%Y99^/0;
  !!SN:W^Commander_Leader_%Y99^/0;
  !!SN:W^Commander_Scout_%Y99^/0;
  !!SN:W^Commander_Undead_%Y99^/0;
  !!SN:W^Commander_FireMage_%Y99^/0;
!!en;

!!SN&v999=40/y1=0:W^Commander_Fighter_%Y99^/1; [activate 1st]
!!SN&v999=40/y1=1:W^Commander_Fighter_%Y99^/0; [deactivate first]
!!SN&v999=41/y2=0:W^Commander_Ranger_%Y99^/1;
!!SN&v999=41/y2=1:W^Commander_Ranger_%Y99^/0;
!!SN&v999=42/y3=0:W^Commander_Defender_%Y99^/1;
!!SN&v999=42/y3=1:W^Commander_Defender_%Y99^/0;
!!SN&v999=43/y4=0:W^Commander_Caster_%Y99^/1;
!!SN&v999=43/y4=1:W^Commander_Caster_%Y99^/0;
!!SN&v999=44/y5=0:W^Commander_Supporter_%Y99^/1;
!!SN&v999=44/y5=1:W^Commander_Supporter_%Y99^/0;
!!SN&v999=45/y6=0:W^Commander_Leader_%Y99^/1;
!!SN&v999=45/y6=1:W^Commander_Leader_%Y99^/0;
!!SN&v999=46/y7=0:W^Commander_Scout_%Y99^/1;
!!SN&v999=46/y7=1:W^Commander_Scout_%Y99^/0;
!!SN&v999=47/y8=0:W^Commander_Undead_%Y99^/1;
!!SN&v999=47/y8=1:W^Commander_Undead_%Y99^/0;

!!SN:W^Fire_Mage_Unlocked^/?y50;
!!if&y50=1;                             [You can only toggle this if class is unlocked]
  !!SN&v999=48/y9=0:W^Commander_FireMage_%Y99^/1;
  !!SN&v999=48/y9=1:W^Commander_FireMage_%Y99^/0;
!!en;

!!SN:W^Commander_Fighter_%Y99^/?y1;     [Check if options have already been activated]
!!SN:W^Commander_Ranger_%Y99^/?y2;
!!SN:W^Commander_Defender_%Y99^/?y3;
!!SN:W^Commander_Caster_%Y99^/?y4;
!!SN:W^Commander_Supporter_%Y99^/?y5;
!!SN:W^Commander_Leader_%Y99^/?y6;
!!SN:W^Commander_Scout_%Y99^/?y7;
!!SN:W^Commander_Undead_%Y99^/?y8;
!!SN:W^Commander_FireMage_%Y99^/?y9;

!!DL274:A40/4/y1/1;                     [switch def cardre to 0 or 1]
!!DL274:A41/4/y2/1;
!!DL274:A42/4/y3/1;
!!DL274:A43/4/y4/1;
!!DL274:A44/4/y5/1;
!!DL274:A45/4/y6/1;                     
!!DL274:A46/4/y7/1;                     
!!DL274:A47/4/y8/1;                   
!!DL274:A48/4/y9/1;       

Close Dialouge
!?DL&v998=274/v999=30722/v1000=13;
!!SN:W^ACM_Commander_Hero_ID^/?y99;
!!SN:W^Commander_Fighter_%Y99^/?y1;     [Check if options have already been activated]
!!SN:W^Commander_Ranger_%Y99^/?y2;
!!SN:W^Commander_Defender_%Y99^/?y3;
!!SN:W^Commander_Caster_%Y99^/?y4;
!!SN:W^Commander_Supporter_%Y99^/?y5;
!!SN:W^Commander_Leader_%Y99^/?y6;
!!SN:W^Commander_Scout_%Y99^/?y7;
!!SN:W^Commander_Undead_%Y99^/?y8;
!!SN:W^Commander_FireMage_%Y99^/?y9;

!!VRy50:Sy1+y2+y3+y4+y5+y6+y7+y8+y9;    [Get number of activated options]
!!DL&y50>0:C1;                          [Only close when at least one option was activated]
!!FU(ACM_MP_Sync_Commander_Classes):Py99; [Send potential change about commander class to other players computer]


********************************************************************************
!?FU(OnCombatRound)&v997=0;             [Set all Commander casts for AI to zero. It helps to avoid bugs and AI commander is stronger if he does not casts spells]

!!re i/0/41;                            [Loop all Battlestacks]
!!BMi:T?y3 I?y4;                        [Get Creature Type and Side]
  !!if&y3>=174/y3<=191;                 [If Commander found]
    !!BA:Hy4/?y5;                       [Get Side Hero]
    !!if&y5>=0;
      !!HEy5:O?y6;                      [Get Hero Owner]
      !!OW:Iy6/?y7;                     [Get if AI or Human]
      !!BMi&y7=1:E0;                    [Set casts to zero if AI]
    !!en;
    !!BMi&y5=-2:E0;                     [Set casts to zero]
  !!en;
!!en; 


!?FU(OnBattleStackObtainsTurn);         [Set all Commander casts for AI to zero when deciding battle with quick combat. Even for Human]
!!SN:W^Prevent_Com_Cast_Flag^/?y1;!!FU&y1=1:E;
!!BA:Q?y1;
!!FU(Quick_Battle_Disable_Com_Cast)&y1=1:P;

!!UN:C6919200/4/?y1;                    [y1 - combatmanager]
!!VRy2:Sy1 +78532;                      [y2 - _ptr_ autoCombat]
!!UN:Cy2/1/?y3;                         [y3 - autoCombat status]
!!FU&y3=0:E;                            [Exit in Auto Combat Status 1 means Auto Combat]
!!FU(Quick_Battle_Disable_Com_Cast):P;

!?FU(Quick_Battle_Disable_Com_Cast);
!!re i/0/41;                            [Loop all Battlestacks]
!!BMi:T?y3;                             [Get Creature Type]
  !!if&y3>=174/y3<=191;                 [If Commander found]
    !!BMi:E0;                           [Set casts to zero]
  !!en;
!!en;
!!SN:W^Prevent_Com_Cast_Flag^/1;


!?FU(OnSetupBattlefield);               [Set new Spells to cast for Commander]
!#VA(usedY[10]:y);

!!SN:W^Att_Com_Regeneration_ability^/0;
!!SN:W^Def_Com_Regeneration_ability^/0;
!!SN:W^Att_Com_Block_ability^/0;
!!SN:W^Def_Com_Block_ability^/0;
!!SN:W^Att_Com_Poison_ability^/0;
!!SN:W^Def_Com_Poison_ability^/0;

!!UN:C7783293/1/37;                     [Paladin Cure]
!!UN:C7783311/1/27;                     [Hierophant Shield]
!!UN:C7783329/1/17;                     [Temple Guardian Lightning Strike]
!!UN:C7783347/1/21;                     [Succubus Fire Ball]
!!UN:C7783365/1/39;                     [Soul Eater Animate Dead]
!!UN:C7783383/1/15;                     [Brute Magic Arrow]
!!UN:C7783401/1/43;                     [Ogre Leader Bloodlust]
!!UN:C7783539/1/53;                     [Shaman Haste]
!!UN:C7783554/1/69;                     [Astral Spirit Summon Air Elements]

**Disable Death Stare from Commanders
!!VRv7080:C-1/-1/-1/-1/-1/-1/-1/-1/-1/-1;[initialize variables]
!!BA:H0/?v7083;                         [get hero (commander) number - attacker]
!!BA:H1/?v7085;                         [get hero (commander) number - defender]

; Manage commander abilities
!!VR(commanders[2]:y):Ci^battle_hero_0^/i^battle_hero_1^;

; If there is no hero on the defending side, assumes there is a commander (use -4 for all the commander of the defender's side)
!!if&i^battle_hero_1^=(NO_HERO)/i^battle_owner_1^=(NO_PLAYER);
  !!VR(commanders[1]):S-4;
!!en;

!!re i/(BATTLE_LEFT)/(BATTLE_RIGHT);
  ; Check if there is a commander on the side
  !!if|(commanders[i])>(NO_HERO)/(commanders[i])=-4;
    !!CO(commanders[i]):B0/?(abilities:y);

    !!if&(abilities);                   [If the ability is not 0, it means there is a commander]
      !!VR(sideStr:z):S^Att^;
      !!VR(sideStr)&i=(BATTLE_RIGHT):S^Def^;

      !!CO(commanders[i]):B1/8/?i^%(sideStr)_Com_Block_ability^; [Block]
      !!CO(commanders[i])&i^%(sideStr)_Com_Block_ability^:B1/8/0;

      !!CO(commanders[i]):B1/11/?i^%(sideStr)_Com_Regeneration_ability^; [Regeneration]
      !!CO(commanders[i])&i^%(sideStr)_Com_Regeneration_ability^:B1/11/0;

      !!CO(commanders[i]):B1/12/?i^%(sideStr)_Com_Poison_ability^; [Poison]
      !!CO(commanders[i])&i^%(sideStr)_Com_Poison_ability^:B1/12/0;
    !!en;
  !!en;
!!en;

!!SN:W^Brute_Gold_Att^/0; !!SN:W^Brute_Gold_Def^/0;
!!SN:W^Paladin_Experience_Att^/0; !!SN:W^Paladin_Experience_Def^/0;

!?FU(OnCombatRound)&v997=0;             [On First visible combat round]
!!SN:F^PluginExists^/^amethyst2_4^; [Check for Amethyst]
!!FU&v1=0:E;

!!re i/0/41;
  !!BMi:T?y1;                           [Creature Type]  
  !!BMi|y1=176/y1=185:U4/17;            [if Temple Guardian Attacker/Defender set to Lightning]
  !!BMi|y1=179/y1=188:U4/15;            [if Brute Attacker/Defender set to Magic Arrow]
  !!BMi|y1=180/y1=189:U4/43;            [if Ogre Leader Attacker/Defender set to Bloodlust]
  !!BMi|y1=182/y1=191:U4/69;            [if Astral Spirit Attacker/Defender set to Summon Air]
  !!BMi|y1=177/y1=186:U4/21;            [if Succubus Attacker/Defender set to Fireball]
!!en;

** pre-action trigger **
!?BG0&-998;                             [continue if enabled]

!!BG:N?v7080 A?v7081 E?v7082;           [get current stack, action type, destination stack]
!!BMv7082&v7082>-1:R?v7087;             [get retaliations of target creature stack]
** end of pre-action trigger **

** post-action trigger **
!?BG1&-998;                             [continue if enabled]

!!BMv7080&v7080>-1:T?y3 I?y4;           [get acting monster type and side]
!!BMv7082&v7082>-1:F?y7 P?y8;           [get target's flags, position]
!!VRy10&y3>=174/y3<=191/v7081>=6/v7081<=7/i^Att_Com_Poison_ability^/y4=0:S0R99; [random roll - attacker]
!!VRy11&y3>=174/y3<=191/v7081>=6/v7081<=7/i^Def_Com_Poison_ability^/y4=1:S0R99; [random roll - defender]
!!FU7073&y3>=174/y3<=191/v7081>=6/v7081<=7/i^Att_Com_Poison_ability^/y4=0/y10<50:Py7/y8; [50% cast poison if commander with death stare attacked or shot - attacker]
!!FU7073&y3>=174/y3<=191/v7081>=6/v7081<=7/i^Def_Com_Poison_ability^/y4=1/y11<50:Py7/y8; [50% cast poison if commander with death stare attacked or shot - defender]

**  retaliation attack
!!BMv7082&v7082>-1:T?y3 I?y4 P?y5;      [get target monster type, side, position]
!!BU&v7082>-1:Ey5/?y6;                  [check if target is still alive]

!!BMv7080&v7080>-1:F?y9;                [get flags of attacking creature stack]
!!VRy9&v7080>-1:&65536;                 [check for no retaliation]

!!BMv7080&v7080>-1:F?y7 P?y8;           [get acting creature's flags, position]
!!VRy10&y3>=174/y3<=191/v7081=6/i^Att_Com_Poison_ability^/v7087>0/y4=0/y6>-1/y9=0:S0R99; [random roll - attacker]
!!VRy11&y3>=174/y3<=191/v7081=6/i^Def_Com_Poison_ability^/v7087>0/y4=1/y6>-1/y9=0:S0R99; [random roll - defender]
!!FU7073&y3>=174/y3<=191/v7081=6/i^Att_Com_Poison_ability^/v7087>0/y4=0/y10<50/y6>-1/y9=0:Py7/y8; [50% cast poison if commander with death stare retaliates - attacker]
!!FU7073&y3>=174/y3<=191/v7081=6/i^Def_Com_Poison_ability^/v7087>0/y4=1/y11<50/y6>-1/y9=0:Py7/y8; [50% cast poison if commander with death stare retaliates - defender]

!!BU:C?y1;                              [check for end of battle]
!!COv7083&v7083>-1/i^Att_Com_Poison_ability^/y1=1:B1/12/1; [restore death stare - attacker]
!!COv7085&v7085>-1/i^Def_Com_Poison_ability^/y1=1:B1/12/1; [restore death stare - defender]

** end of post-action trigger **
!?FU7073;
!!VRx1:&16;                             [just check alive bit]
!!BG:N?y1;                              [get current stack #]
!!BMy1&x1=16:C71/x2/1/3/1;              [if target is alive have current stack cast poison]
** end of function **


**Fix for Casting Commanders**
For Brute, Temple Guardian  and Astral Spirit
!?FU(OnBattleRegeneratePhase);
*!FU:E;                                 [Disbaled and replaced by switching actions.erm from xericsin]

!!SN:W^Temple_Guarding_Event^/-1;
!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]

!!SN:X?y1;                              [Event parameter]
!!BMy1:T?y2;                            [Acting Monster Type]
!!BMy1:I?y3;                            [Acting Monster Side]
!!SN|y2=176/y2=185/y2=179/y2=188/y2=182/y2=191:W^Temple_Guarding_Event^/y1;

!?CM4&1000;
*!FU:E;                                 [Disbaled and replaced by switching actions.erm from xericsin]

!!CM:F?y1 I?y2;
!!FU|y1<>512/y2<>2010:E;                [Exit if not rightclick on defend Icon]
!!SN:W^Temple_Guarding_Event^/?y3;
!!FU&y3=-1:E;
!!BMy3:T?y4;                            [Acting Monster Type]
!!if|y4=176/y4=185/y4=179/y4=188/y4=182/y4=191;

!!SN:W^Event_Counter^/?y10;
!!VRy10:%2;

!!if&y10=1;
!!SN:W^Temple_Guarding_Casts^/?y11;
!!BMy3:Ey11;                            [Restore Spells]
!!SN:T^AC_Misc.Spellcasting_Restored^/?z-2;
!!IF&y11>0:M^%Z-2^;
!!SN:W^Event_Counter^/d1;
!!en;

!!if&y10=0;
!!BMy3:E?y5;                            [Save Spells to cast]
!!BMy3:E0;                              [Set Spells to cast to zero]
!!SN:W^Temple_Guarding_Casts^/y5;
!!SN:W^Event_Counter^/d1;
!!en;
!!en;

!?FU(OnBeforeBattleUniversal);
*!FU:E;                                 [Disbaled and replaced by switching actions.erm from xericsin]
!!SN:W^Event_Counter^/0;
!!SN:W^Temple_Guarding_Casts^/0;
**end for casting fix**


*************
Teach AI Commander Classes
At each level up AI will choose com class if none has been selected. Each level up gives random boost to Kill-Count

!?HL-1;
!!HE-1:O?y30;                           [Exit if not AI's hero]
!!OW:Iy30/?y31;
!!FU&y31<>(TRUE):E;

!!HE-1:Ed/?y7/1;                        [Get hero number and level]
!!FU&y7<6:E;                            [Exit below level 5 or above 50]
!!FU&y7>50:E;

!!HE-1:N?y1;

!!FU(Check_Com_Masteries):Py1/0/?y6/?y5/?y2; [Pass Hero Number and return current com class]

!!if&y2=0;                              [If no commander class, assign random class]
  !!VRy3:S1R6;                          [Generate Random number from 1-7]
  !!VRy3&y3=7:S1R6;                     [Roll again if Fire Mage Class was selected to decrease chance of AI having it]
  !!SN&y3=1:W^Commander_Fighter_%Y1^/1; 
  !!SN&y3=2:W^Commander_Ranger_%Y1^/1; 
  !!SN&y3=3:W^Commander_Defender_%Y1^/1;
  !!SN&y3=4:W^Commander_Leader_%Y1^/1; 
  !!SN&y3=5:W^Commander_Scout_%Y1^/1; 
  !!SN&y3=6:W^Commander_Undead_%Y1^/1; 
  !!SN&y3=7:W^Commander_FireMage_%Y1^/1; 
!!en;

!!VRy90:S0R1;
!!if&y2>0/y2<10/y7=20/y6>29/y90=1/y80=0;[if commander has a class and is above level 20 and has more than 29 kill count give a 50% chance to get commander promotion]
  !!VRy3:S11R18;                        [Generate Random number from 11-29]
  !!VRy3&y3=20:S22;                     [Set to Marksmen if invalid class was choosen]
  !!VRy3&y3=14:S12;                     [Set to Sniper if Arch Mage was choosen]
  !!VRy3&y3=24:S28;                     [Set to Necromant if Warden class was choosen]
  !!SN&y3=11:W^Commander_Dragonslayer_%Y1^/1; [select class]
  !!SN&y3=12:W^Commander_Sniper_%Y1^/1; 
  !!SN&y3=13:W^Commander_Retaliator_%Y1^/1; 
  !!SN&y3=14:W^Commander_ArchMage_%Y1^/1; 
  !!SN&y3=15:W^Commander_Constructor_%Y1^/1; 
  !!SN&y3=16:W^Commander_King_%Y1^/1; 
  !!SN&y3=17:W^Commander_Prospector_%Y1^/1;
  !!SN&y3=18:W^Commander_Lich_%Y1^/1;
  !!SN&y3=19:W^Commander_Vampire_%Y1^/1; 

  !!SN&y3=21:W^Commander_Paladin_%Y1^/1; 
  !!SN&y3=22:W^Commander_Marksmen_%Y1^/1; 
  !!SN&y3=23:W^Commander_Avenger_%Y1^/1;
  !!SN&y3=24:W^Commander_Warden_%Y1^/1; 
  !!SN&y3=25:W^Commander_Arcanist_%Y1^/1;
  !!SN&y3=26:W^Commander_General_%Y1^/1; 
  !!SN&y3=27:W^Commander_Lancer_%Y1^/1;
  !!SN&y3=28:W^Commander_Necromant_%Y1^/1; 
  !!SN&y3=29:W^Commander_Ancient_%Y1^/1;

  !!SN:W^Commander_Fighter_%Y1^/0;      [reset other classes]
  !!SN:W^Commander_Ranger_%Y1^/0; 
  !!SN:W^Commander_Defender_%Y1^/0;
  !!SN:W^Commander_Leader_%Y1^/0; 
  !!SN:W^Commander_Scout_%Y1^/0; 
  !!SN:W^Commander_Undead_%Y1^/0; 
  !!SN:W^Commander_FireMage_%Y1^/0;  
!!en;

!!VRy4:S1R5;                            [Generate Random number from 1-6]
!!SN&y2>0:W^Commander_Kill_Counter_%Y1^/dy4; [at each level up add random amount to kill count]
!!SN:W^Commander_Kill_Counter_%Y1^/?y11;[check current kill count]
!!SN&y11>y5:W^Commander_Kill_Counter_%Y1^/y5; [if current kill count is bigger than max kill count set to max]


!?HL-1;
!!FU:E; currently disabled because it can skip promotion screen

!!HE-1:O?y30;                           [Exit if AI's hero]
!!OW:Iy30/?y31;
!!FU&y31:E;

*starting from level 10 and if you have already selected a commander class you will get bonus kill count based on your current com class
!!HE-1:N?y1 E?y4/?y3/1;                 [Get hero number and level]
!!FU&y3<10:E;                           [Exit below level 10]
!!FU(Check_Com_Masteries):Py1/0/?y4/?y5/?y2; [Pass Hero Number and return current com class]
!!SN&y2>0/y4<y5:W^Commander_Kill_Counter_%Y1^/d1; [at each level up add random amount to kill count]


***************************************
!?FU(Skill_Value_Database);
*x1=Hero Number,
*x2=Skill
*x3=Hero Level
*x4=Returned Value
!!HEx1:Sx2/?y10;                        [Check for Basic-Expert Skill Level]
!!FU(H3_Mod_Check_Skill_Level):Px1/?y11/?y12/x2; [Check for M/GM Skill Level]

*Archery
!!if&x2=1;
!!VRy20&y10=1:S10; !!VRy20&y10=2:S25; !!VRy20&y10=3/y11=0/y12=0:S50; !!VRy20&y10=3/y11=1/y12=0:S65; !!VRy20&y10=3/y11=1/y12=1:S75;
!!en;

*Logistics
!!if&x2=2;
!!VRy20&y10=1:S15; !!VRy20&y10=2:S20; !!VRy20&y10=3/y11=0/y12=0:S25; !!VRy20&y10=3/y11=1/y12=0:S30; !!VRy20&y10=3/y11=1/y12=1:S35;
!!en;

*Necromancy
!!if&x2=12;
!!VRy20&y10=1:S5; !!VRy20&y10=2:S10; !!VRy20&y10=3/y11=0/y12=0:S15; !!VRy20&y10=3/y11=1/y12=0:S20; !!VRy20&y10=3/y11=1/y12=1:S25;
!!en;

*Estates
!!if&x2=13;
!!VRy20&y10=1:S250; !!VRy20&y10=2:S500; !!VRy20&y10=3/y11=0/y12=0:S750; !!VRy20&y10=3/y11=1/y12=0:S1000; !!VRy20&y10=3/y11=1/y12=1:S2000;
!!en;

*Learning
!!if&x2=21;
!!VRy20&y10=1:S20; !!VRy20&y10=2:S30; !!VRy20&y10=3/y11=0/y12=0:S40; !!VRy20&y10=3/y11=1/y12=0:S60; !!VRy20&y10=3/y11=1/y12=1:S75;
!!en;

*Offense
!!if&x2=22;
!!VRy20&y10=1:S10; !!VRy20&y10=2:S20; !!VRy20&y10=3/y11=0/y12=0:S30; !!VRy20&y10=3/y11=1/y12=0:S35; !!VRy20&y10=3/y11=1/y12=1:S40;
!!en;

*Armorer
!!if&x2=23;
!!VRy20&y10=1:S5; !!VRy20&y10=2:S10; !!VRy20&y10=3/y11=0/y12=0:S15; !!VRy20&y10=3/y11=1/y12=0:S20; !!VRy20&y10=3/y11=1/y12=1:S25;
!!en;

*Intelligence
!!if&x2=24;
!!VRy20&y10=1:S25; !!VRy20&y10=2:S50; !!VRy20&y10=3/y11=0/y12=0:S75; !!VRy20&y10=3/y11=1/y12=0:S100; !!VRy20&y10=3/y11=1/y12=1:S125;
!!en;

*Sorcery
!!if&x2=25;
!!VRy20&y10=1:S10; !!VRy20&y10=2:S20; !!VRy20&y10=3/y11=0/y12=0:S30; !!VRy20&y10=3/y11=1/y12=0:S40; !!VRy20&y10=3/y11=1/y12=1:S50;
!!en;

*Resistance
!!if&x2=26;
!!VRy20&y10=1:S10; !!VRy20&y10=2:S15; !!VRy20&y10=3/y11=0/y12=0:S20; !!VRy20&y10=3/y11=1/y12=0:S25; !!VRy20&y10=3/y11=1/y12=1:S30;
!!en;

!!VRx4:Sx3*3*y20:100;                   [To give back value with 3% speciality increase]
*!VRx4:Sx3*2*y20:100;                   [To give back value with 2% speciality increase]
!!VRx4&x2=13:Sx3*10*y20:100;            [Make exception 10% for Estate to show correct info in hero spec icon]


********************************************************************************

!?FU(SetSecSkillPercent);               [SS Werte skill Setzten]
; x1 is a skill, x2 is a level (0..3), x3 is a value in objects, for example, 8
!!FU|x1<1/x1=5/x1=7/x1=10/x1>26:E; !!FU&x1>13/x1<21:E; !!FU|x2<0/x2>3:E;
!!VRy1&x1=1:S6547944;  !!VRy1&x1=2:S6548072;  !!VRy1&x1=3:S6547928;  !!VRy1&x1=4:S6548024;
!!VRy1&x1=6:S6547880;  !!VRy1&x1=8:S6547912;  !!VRy1&x1=9:S6547864;  !!VRy1&x1=11:S6548008;
!!VRy1&x1=12:S6547896; !!VRy1&x1=13:S6547992; !!VRy1&x1=21:S6548056; !!VRy1&x1=22:S6547960;
!!VRy1&x1=23:S6547976; !!VRy1&x1=24:S6548104; !!VRy1&x1=25:S6548088; !!VRy1&x1=26:S6548040;
!!VRx2:*4; !!VRy1:+x2; !!VRe1:Sx3:100; !!SN:X?y2 Xe1 X?y3 Xy2; !!UN:Cy1/4/y3;

********************************************************************************

********************************************************************************

                          Adventurer Leveling

This script sets the chance for Adventurer Heroes to gain Secondary Skills and Primary Skill Points
Author: Alf :)
********************************************************************************
!?FU(OnHeroGainLevel)&i^acm_isGameStarted^; [So it only runs after the map has started]
!!HE-1:N?y1;
!!FU(Valid_Adventurer_Hero):Py1/?y60;   [Call Function to Check if Adventurer Hero]
!!FU&y60<>1:E;

!!HL:S?y50/?y2/?y3;                     [Get primary stat, left and right skill numbers. Naturally, if upgrade for a skill is suggested, it will be in left skill.]
 There're multiple situations which can occur during leveling. y2=-2 or y3=-2 means, that both left and right skills are not set by others or this scripts.
If either of them is >-2, this script will not change that.
 We get these situations:
 y2=-2, y3=-2.
 y2>-2, y3=-2.
 y2=-2, y3>-2.
In first case all skills are not set, in second case only left, usually upgrade, skill is changed. Vicer versa for third case.
 Then it all depends on number of upgraded and not upgraded to the expert rank skills. If hero has reached the skill limit, no new skills
will be proposed, hence script only changes attributes. If all hero's skills are upgraded to max (expert), then both skills will be new,
else only right skill will be new. If right or left skills are set, script doesn't change them.

!!if|y2=-2/y3=-2;                                [If right or left is not set, which corresponds to them being set by another script.]
  !!UN:C4881872/1/?y9;                           [Number of skill limit for heroes.]
  !!VRy4&y2>-2:S0;
  !!VRy4&y2=-2:S1;
  !!VRy5&y3>-2:S0;
  !!VRy5&y3=-2:S1;
  !!FU(GetHeroSkillsNumbers):Py1/?y7/?y8;        [y2 is number of hero skills, y3 is number of skills with less than Expert rank.]


  !!if&y7<y9;                                    [Skill limit is not reached]
    !!if&y4=1/y5=1/y8=0;                         [If both skills proposed will be basic rank.]
      !!FU(AdventurerHeroGenerateSkill):Py1/?y2; [First generate one skill with adventurer chances.]
      !!HEy1:Sy2/1;                              [Set this skill to 1 temporarily and let the function roll next skill assuming previous skill is learned.]
      !!FU(AdventurerHeroGenerateSkill):Py1/?y3; [Second skill generation]
      !!HEy1:Sy2/0;                              [Return first skill to not learned state.]
    !!en;

    !!if&y8>0/y5=1;                              [If there're unupgraded skills and right is not set. Left skill is left alone, change only right.]
																					
      !!FU(AdventurerHeroGenerateSkill):Py1/?y3; [Generate skill with adventurer chances.]
    !!en;
    !!if&y8=0/y4=1/y5=0;                         [If right skill is set, left is not and no unupgraded skills. Right skill is left alone, change only left.]
      !!FU(AdventurerHeroGenerateSkill):Py1/?y2; [Generate skill with adventurer chances.]
																				  
    !!en;

    !!HL&y8=0/y4=1:S0/y2/y3;                     [If both skills were not set and all skills are expert or none rank.]
    !!HL|y8>0/y4=0:S0/?y2/y3;                    [If either there's an unupgraded skill or left skill is set]
    !!HL|y8>0/y4=0:S0/y2/y3;                     [Copy left skill state and set right.]
  !!en;

!!en;
!!FU(AdventurerHeroGenerateStat):Py1/?y6;        [All that's left is to generate primary skill i.e. stat.]
!!HL:Sy6/?y2/?y3;
!!HL:Sy6/y2/y3;                                  [Copy left and right skill just to set primary skill.]


!?FU(GetHeroSkillsNumbers);
Calculates how many skills hero learned and how many skills are not upgraded to expert.
x1 - hero id; x2 - return number of skills; x3 - return amount of non expert rank skills.

!!re i/0/(SEC_SKILL_LAST);
  !!HEx1:Si/?(skillLvl:y);
  !!if&(skillLvl);
					 
    !!VRx2:+1;
    !!VRx3&(skillLvl)<3:+1;
  !!en;
!!en;

!?FU(AdventurerHeroGenerateSkill);
Generates id of the skill that current adventurer hero will learn, using custom table for adventurer heroes.
x1 - hero id; x2 - return generated skill.
*!IF:M^hero id %X1^;
!!FU(GetOverallSkillChance):Px1/?y1;
*!IF:M^hero %X1 chance %Y1^;
!!VRy1:-1;                              [Decrease chance since R random from 0 to y1, which gives y1+1 numbers.]
*!IF:M^hero %X1 chance after decr %Y1^;
!!VRy2:S0Ry1;
*!IF:M^random %Y2^;
!!FU(DetermineSkillByChance):Px1/y2/?x2;

!?FU(GetOverallSkillChance);
Calculates sum of chances of available to learn skills.
x1 - hero id; x2 - return sum of skill chances.
!!VRx2:S0;
!!VRy1:S0;                              [Skill id from 0 to 27]
[:loopGetOverallSkillChance]; loop is label name inside current function
!!HEx1&y1<28:Sy1/?y4;
!!VRy3:Sx1:16;                          [Town id for current hero]
!!SN&y4=0:W^AdventurerTown_%Y3_Skill_%Y1_Chance^/?y2;
!!VRx2&y4=0:+y2;
!!VRy1:+1;
!!SN&y1<28:G[loopGetOverallSkillChance];[Loop all skill IDs and sum chances for skills that hero doesn't have.]
*!IF:M^hero %X1 town %Y3^;

!?FU(DetermineSkillByChance);
Determines what skill adventurer will get with current random roll.
x1 - hero id; x2 - random number; x3 - return id of skill that corresponds to that chance.
!!VRy1:S0;                              [Skill id from 0 to 27]
*!IF:M^hero %X1 rand %X2^;
[:loopDetermineSkillByChance]; loop is label name inside current function
!!HEx1&y1<28:Sy1/?y4;
!!VRy3:Sx1:16;                          [Town id for current hero]
!!SN&y4=0:W^AdventurerTown_%Y3_Skill_%Y1_Chance^/?y2; [Only for skills that hero doesn't have]
!!VRx2&y4=0:-y2;
!!VRy1:+1;
!!SN&y1<28/x2>=0:G[loopDetermineSkillByChance]; [Loop all skill IDs, decrease random number until it's negative, which means we have found skill that corresponds to that number.]
!!VRx3&x2<0:Sy1 -1;                     [Decrease by 1 since last loop increased this skill id by 1. Only if random is negative.]
*!IF:M^hero %X1 rand %X2 skl %X3^;

!?FU(AdventurerHeroGenerateStat);
x1 - hero id, x2 - return generated stat.
!!VRy1:S0R99;
!!VRy6:Sx1:16;
!!SN:W^AdventurerTown_%Y6_Stat_0_Chance^/?y2;
!!SN:W^AdventurerTown_%Y6_Stat_1_Chance^/?y3;
!!SN:W^AdventurerTown_%Y6_Stat_2_Chance^/?y4;
!!SN:W^AdventurerTown_%Y6_Stat_3_Chance^/?y5;

!!VRy1:-y2;
!!VRx2&y1<0:S0;
!!FU&y1<0:E;

!!VRy1:-y3;
!!VRx2&y1<0:S1;
!!FU&y1<0:E;

!!VRy1:-y4;
!!VRx2&y1<0:S2;
!!FU&y1<0:E;

!!VRy1:-y5;
!!VRx2&y1<0:S3;
!!FU&y1<0:E;


!?FU(Valid_Adventurer_Hero);
x1=Hero ID, x2 returns yes(1) or no (0)
!!VRy1:S0;                              [List of all Adventurer Heroes]
!!VRy1|x1=3/x1=8/x1=15:S1;              [Sylvia, Rion, Caithlyn]
!!VRy1|x1=23/x1=27/x1=29:S1;            [Kyrre, Gem, Melodia]
!!VRy1|x1=43/x1=47:S1;                  [Daremyth, Ain]
!!VRy1|x1=48/x1=60:S1;                  [Fiona, Calid]
!!VRy1|x1=69/x1=70/x1=78/x1=79:S1;      [Isra, Clavius, Vidomina, Nagash]
!!VRy1|x1=84/x1=85/x1=91/x1=94:S1;      [Damacon, Gunnar, Jeddite, Sephinroth]
!!VRy1|x1=106/x1=109:S1;                [Dessa, Gundula]
!!VRy1|x1=122/x1=123/x1=124:S1;         [Voy, Verdish, Merist]
!!VRy1|x1=142/x1=143:S1;                [Gelare, Grindan]
!!VRx2:Sy1;                             [Returns yes or no in x2]


// Rename Adventurer classes
; by igrik and Archer30
!?FU(OnAfterErmInstructions);
!!FU(NewStrArray):P9/?i^acm_heroClassNames^/(M_STORED);
!!SN:Vi^acm_heroClassNames^/0/^%T(AC_Misc.Adventurer_0)^/^%T(AC_Misc.Adventurer_1)^/^%T(AC_Misc.Adventurer_2)^/^%T(AC_Misc.Adventurer_3)^
  /^%T(AC_Misc.Adventurer_4)^/^%T(AC_Misc.Adventurer_5)^/^%T(AC_Misc.Adventurer_6)^/^%T(AC_Misc.Adventurer_7)^
  /^%T(AC_Misc.Adventurer_8)^;

!?FU(ACM_CreateERMHook);
!#VA(setHook:x);

!!SN:E(setHook)/1/5083661/(ACM_OnSetClassName_1); 4D921D
!!SN:E(setHook)/1/5093760/(ACM_OnSetClassName_2);
!!SN:E(setHook)/1/5094903/(ACM_OnSetClassName_2);
!!SN:E(setHook)/1/5119462/(ACM_OnSetClassName_3);

!?FU(ACM_OnSetClassName_1);
!!SN:X?y1;
!!VRy2:Sy1 +24;
!!FU(ACM_SetClassName):Py2/?y4;
!!FU&y4=(NULL):E;

!!SN:X?y1/0;
!!VRy3:Sy1 +28;
!!UN:Cy3/4/y4;
!!VRy5:Sy1 +32;
!!UN:Cy5/4/5083660; 4D920C

!?FU(ACM_OnSetClassName_2);
!!SN:X?y1;
!!VRy2:Sy1 +24;
!!FU(ACM_SetClassName):Py2/?y4;
!!FU&y4=(NULL):E;

!!VRy3:Sy1 +28;
!!UN:Cy3/4/y4;

!?FU(ACM_OnSetClassName_3);
!!SN:X?y1;
!!VRy2:Sy1 +28;
!!FU(ACM_SetClassName):Py2/?y4;
!!FU&y4=(NULL):E;

!!VRy3:Sy1 +24;
!!UN:Cy3/4/y4;

!?FU(ACM_SetClassName);
!#VA(heroStructPtr:x) (strPtr:x);

!!VR(strPtr):S(NULL);
!!FU&i^acm_heroClassNames^=0:E;

!!UN:C(heroStructPtr)/4/?(heroStruct:y);
!!UN:C(heroStruct)/26/4/?(heroId:y);
!!FU(Valid_Adventurer_Hero):P(heroId)/?(result:y);
!!FU&(result)<>(TRUE):E;

!!HE(heroId):B2/?(heroType:y);
!!VR(townType:y):S(heroType) :2;

!!SN:Mi^acm_heroClassNames^/?(strPtr)/(townType);


!?PI;
  This are instructions that set chances to get primary and secondary skills for new class of heroes - adventurers. Do not change them recklessly (you can).

Castle's Lords
!!SN:W^AdventurerTown_0_Skill_0_Chance^/2; [Pathfinding]
!!SN:W^AdventurerTown_0_Skill_1_Chance^/2; [Archery]
!!SN:W^AdventurerTown_0_Skill_2_Chance^/6; [Logistics]
!!SN:W^AdventurerTown_0_Skill_3_Chance^/6; [Scouting]
!!SN:W^AdventurerTown_0_Skill_4_Chance^/10; [Diplomacy]
!!SN:W^AdventurerTown_0_Skill_5_Chance^/10; [Nobility (Navigation)] 
!!SN:W^AdventurerTown_0_Skill_6_Chance^/6; [Leadership]
!!SN:W^AdventurerTown_0_Skill_7_Chance^/4; [Wisdom]
!!SN:W^AdventurerTown_0_Skill_8_Chance^/2; [Mysticism]
!!SN:W^AdventurerTown_0_Skill_9_Chance^/3; [Luck]
!!SN:W^AdventurerTown_0_Skill_10_Chance^/4; [Ballistics]
!!SN:W^AdventurerTown_0_Skill_11_Chance^/6; [Eagle Eye]
!!SN:W^AdventurerTown_0_Skill_12_Chance^/0; [Necromancy] 
!!SN:W^AdventurerTown_0_Skill_13_Chance^/6; [Estates]
!!SN:W^AdventurerTown_0_Skill_14_Chance^/2; [Fire Magic]
!!SN:W^AdventurerTown_0_Skill_15_Chance^/3; [Air Magic]
!!SN:W^AdventurerTown_0_Skill_16_Chance^/3; [Water Magic]
!!SN:W^AdventurerTown_0_Skill_17_Chance^/2; [Earth Magic]
!!SN:W^AdventurerTown_0_Skill_18_Chance^/1; [Scholar]
!!SN:W^AdventurerTown_0_Skill_19_Chance^/4; [Tactics]
!!SN:W^AdventurerTown_0_Skill_20_Chance^/4; [Artillery]
!!SN:W^AdventurerTown_0_Skill_21_Chance^/6; [Learning]
!!SN:W^AdventurerTown_0_Skill_22_Chance^/3; [Offence]
!!SN:W^AdventurerTown_0_Skill_23_Chance^/4; [Armorer]
!!SN:W^AdventurerTown_0_Skill_24_Chance^/2; [Intelligence]
!!SN:W^AdventurerTown_0_Skill_25_Chance^/2; [Sorcery]
!!SN:W^AdventurerTown_0_Skill_26_Chance^/3; [Resistance]
!!SN:W^AdventurerTown_0_Skill_27_Chance^/6; [First Aid]
!!SN:W^AdventurerTown_0_Stat_0_Chance^/30;
!!SN:W^AdventurerTown_0_Stat_1_Chance^/30;
!!SN:W^AdventurerTown_0_Stat_2_Chance^/20;
!!SN:W^AdventurerTown_0_Stat_3_Chance^/20;

Rampart's Forest Guardians
!!SN:W^AdventurerTown_1_Skill_0_Chance^/3; [Pathfinding]
!!SN:W^AdventurerTown_1_Skill_1_Chance^/5; [Archery]
!!SN:W^AdventurerTown_1_Skill_2_Chance^/9; [Logistics]
!!SN:W^AdventurerTown_1_Skill_3_Chance^/10; [Scouting]
!!SN:W^AdventurerTown_1_Skill_4_Chance^/8; [Diplomacy]
!!SN:W^AdventurerTown_1_Skill_5_Chance^/5; [Nobility (Navigation)]
!!SN:W^AdventurerTown_1_Skill_6_Chance^/2; [Leadership]
!!SN:W^AdventurerTown_1_Skill_7_Chance^/3; [Wisdom]
!!SN:W^AdventurerTown_1_Skill_8_Chance^/4; [Mysticism]
!!SN:W^AdventurerTown_1_Skill_9_Chance^/3; [Luck]
!!SN:W^AdventurerTown_1_Skill_10_Chance^/3; [Ballistics]
!!SN:W^AdventurerTown_1_Skill_11_Chance^/7; [Eagle Eye]
!!SN:W^AdventurerTown_1_Skill_12_Chance^/0; [Necromancy]
!!SN:W^AdventurerTown_1_Skill_13_Chance^/4; [Estates]
!!SN:W^AdventurerTown_1_Skill_14_Chance^/1; [Fire Magic]
!!SN:W^AdventurerTown_1_Skill_15_Chance^/2; [Air Magic]
!!SN:W^AdventurerTown_1_Skill_16_Chance^/3; [Water Magic]
!!SN:W^AdventurerTown_1_Skill_17_Chance^/3; [Earth Magic]
!!SN:W^AdventurerTown_1_Skill_18_Chance^/3; [Scholar]
!!SN:W^AdventurerTown_1_Skill_19_Chance^/4; [Tactics]
!!SN:W^AdventurerTown_1_Skill_20_Chance^/1; [Artillery]
!!SN:W^AdventurerTown_1_Skill_21_Chance^/6; [Learning]
!!SN:W^AdventurerTown_1_Skill_22_Chance^/3; [Offence]
!!SN:W^AdventurerTown_1_Skill_23_Chance^/5; [Armorer]
!!SN:W^AdventurerTown_1_Skill_24_Chance^/2; [Intelligence]
!!SN:W^AdventurerTown_1_Skill_25_Chance^/1; [Sorcery]
!!SN:W^AdventurerTown_1_Skill_26_Chance^/4; [Resistance]
!!SN:W^AdventurerTown_1_Skill_27_Chance^/8; [First Aid]
!!SN:W^AdventurerTown_1_Stat_0_Chance^/25;
!!SN:W^AdventurerTown_1_Stat_1_Chance^/35;
!!SN:W^AdventurerTown_1_Stat_2_Chance^/15;
!!SN:W^AdventurerTown_1_Stat_3_Chance^/25;

Tower's Tundra Nomads
!!SN:W^AdventurerTown_2_Skill_0_Chance^/8; [Pathfinding]
!!SN:W^AdventurerTown_2_Skill_1_Chance^/4; [Archery]
!!SN:W^AdventurerTown_2_Skill_2_Chance^/7; [Logistics]
!!SN:W^AdventurerTown_2_Skill_3_Chance^/3; [Scouting]
!!SN:W^AdventurerTown_2_Skill_4_Chance^/6; [Diplomacy]
!!SN:W^AdventurerTown_2_Skill_5_Chance^/6; [Nobility (Navigation)]
!!SN:W^AdventurerTown_2_Skill_6_Chance^/2; [Leadership]
!!SN:W^AdventurerTown_2_Skill_7_Chance^/5; [Wisdom]
!!SN:W^AdventurerTown_2_Skill_8_Chance^/4; [Mysticism]
!!SN:W^AdventurerTown_2_Skill_9_Chance^/1; [Luck]
!!SN:W^AdventurerTown_2_Skill_10_Chance^/4; [Ballistics]
!!SN:W^AdventurerTown_2_Skill_11_Chance^/6; [Eagle Eye]
!!SN:W^AdventurerTown_2_Skill_12_Chance^/0; [Necromancy]
!!SN:W^AdventurerTown_2_Skill_13_Chance^/6; [Estates]
!!SN:W^AdventurerTown_2_Skill_14_Chance^/2; [Fire Magic]
!!SN:W^AdventurerTown_2_Skill_15_Chance^/5; [Air Magic]
!!SN:W^AdventurerTown_2_Skill_16_Chance^/4; [Water Magic]
!!SN:W^AdventurerTown_2_Skill_17_Chance^/2; [Earth Magic]
!!SN:W^AdventurerTown_2_Skill_18_Chance^/3; [Scholar]
!!SN:W^AdventurerTown_2_Skill_19_Chance^/1; [Tactics]
!!SN:W^AdventurerTown_2_Skill_20_Chance^/1; [Artillery]
!!SN:W^AdventurerTown_2_Skill_21_Chance^/8; [Learning]
!!SN:W^AdventurerTown_2_Skill_22_Chance^/2; [Offence]
!!SN:W^AdventurerTown_2_Skill_23_Chance^/2; [Armorer]
!!SN:W^AdventurerTown_2_Skill_24_Chance^/6; [Intelligence]
!!SN:W^AdventurerTown_2_Skill_25_Chance^/5; [Sorcery]
!!SN:W^AdventurerTown_2_Skill_26_Chance^/4; [Resistance]
!!SN:W^AdventurerTown_2_Skill_27_Chance^/5; [First Aid]
!!SN:W^AdventurerTown_2_Stat_0_Chance^/20;
!!SN:W^AdventurerTown_2_Stat_1_Chance^/15;
!!SN:W^AdventurerTown_2_Stat_2_Chance^/30;
!!SN:W^AdventurerTown_2_Stat_3_Chance^/35;

Inferno's Demon Breeders
!!SN:W^AdventurerTown_3_Skill_0_Chance^/5; [Pathfinding]
!!SN:W^AdventurerTown_3_Skill_1_Chance^/2; [Archery]
!!SN:W^AdventurerTown_3_Skill_2_Chance^/8; [Logistics]
!!SN:W^AdventurerTown_3_Skill_3_Chance^/9; [Scouting]
!!SN:W^AdventurerTown_3_Skill_4_Chance^/10; [Diplomacy]
!!SN:W^AdventurerTown_3_Skill_5_Chance^/7; [Nobility (Navigation)]
!!SN:W^AdventurerTown_3_Skill_6_Chance^/5; [Leadership]
!!SN:W^AdventurerTown_3_Skill_7_Chance^/3; [Wisdom]
!!SN:W^AdventurerTown_3_Skill_8_Chance^/2; [Mysticism]
!!SN:W^AdventurerTown_3_Skill_9_Chance^/1; [Luck]
!!SN:W^AdventurerTown_3_Skill_10_Chance^/6; [Ballistics]
!!SN:W^AdventurerTown_3_Skill_11_Chance^/4; [Eagle Eye]
!!SN:W^AdventurerTown_3_Skill_12_Chance^/2; [Necromancy]
!!SN:W^AdventurerTown_3_Skill_13_Chance^/5; [Estates]
!!SN:W^AdventurerTown_3_Skill_14_Chance^/4; [Fire Magic]
!!SN:W^AdventurerTown_3_Skill_15_Chance^/1; [Air Magic]
!!SN:W^AdventurerTown_3_Skill_16_Chance^/1; [Water Magic]
!!SN:W^AdventurerTown_3_Skill_17_Chance^/3; [Earth Magic]
!!SN:W^AdventurerTown_3_Skill_18_Chance^/1; [Scholar]
!!SN:W^AdventurerTown_3_Skill_19_Chance^/5; [Tactics]
!!SN:W^AdventurerTown_3_Skill_20_Chance^/4; [Artillery]
!!SN:W^AdventurerTown_3_Skill_21_Chance^/5; [Learning]
!!SN:W^AdventurerTown_3_Skill_22_Chance^/6; [Offence]
!!SN:W^AdventurerTown_3_Skill_23_Chance^/4; [Armorer]
!!SN:W^AdventurerTown_3_Skill_24_Chance^/1; [Intelligence]
!!SN:W^AdventurerTown_3_Skill_25_Chance^/2; [Sorcery]
!!SN:W^AdventurerTown_3_Skill_26_Chance^/4; [Resistance]
!!SN:W^AdventurerTown_3_Skill_27_Chance^/2; [First Aid]
!!SN:W^AdventurerTown_3_Stat_0_Chance^/30;
!!SN:W^AdventurerTown_3_Stat_1_Chance^/20;
!!SN:W^AdventurerTown_3_Stat_2_Chance^/30;
!!SN:W^AdventurerTown_3_Stat_3_Chance^/20;

Necropolis's Shadow Stalkers
!!SN:W^AdventurerTown_4_Skill_0_Chance^/3; [Pathfinding]
!!SN:W^AdventurerTown_4_Skill_1_Chance^/4; [Archery]
!!SN:W^AdventurerTown_4_Skill_2_Chance^/10; [Logistics]
!!SN:W^AdventurerTown_4_Skill_3_Chance^/7; [Scouting]
!!SN:W^AdventurerTown_4_Skill_4_Chance^/7; [Diplomacy]
!!SN:W^AdventurerTown_4_Skill_5_Chance^/5; [Nobility (Navigation)]
!!SN:W^AdventurerTown_4_Skill_6_Chance^/0; [Leadership]
!!SN:W^AdventurerTown_4_Skill_7_Chance^/4; [Wisdom]
!!SN:W^AdventurerTown_4_Skill_8_Chance^/4; [Mysticism]
!!SN:W^AdventurerTown_4_Skill_9_Chance^/6; [Luck]
!!SN:W^AdventurerTown_4_Skill_10_Chance^/4; [Ballistics]
!!SN:W^AdventurerTown_4_Skill_11_Chance^/6; [Eagle Eye]
!!SN:W^AdventurerTown_4_Skill_12_Chance^/8; [Necromancy]
!!SN:W^AdventurerTown_4_Skill_13_Chance^/3; [Estates]
!!SN:W^AdventurerTown_4_Skill_14_Chance^/1; [Fire Magic]
!!SN:W^AdventurerTown_4_Skill_15_Chance^/2; [Air Magic]
!!SN:W^AdventurerTown_4_Skill_16_Chance^/1; [Water Magic]
!!SN:W^AdventurerTown_4_Skill_17_Chance^/5; [Earth Magic]
!!SN:W^AdventurerTown_4_Skill_18_Chance^/1; [Scholar]
!!SN:W^AdventurerTown_4_Skill_19_Chance^/2; [Tactics]
!!SN:W^AdventurerTown_4_Skill_20_Chance^/2; [Artillery]
!!SN:W^AdventurerTown_4_Skill_21_Chance^/4; [Learning]
!!SN:W^AdventurerTown_4_Skill_22_Chance^/10; [Offence]
!!SN:W^AdventurerTown_4_Skill_23_Chance^/0; [Armorer]
!!SN:W^AdventurerTown_4_Skill_24_Chance^/2; [Intelligence]
!!SN:W^AdventurerTown_4_Skill_25_Chance^/2; [Sorcery]
!!SN:W^AdventurerTown_4_Skill_26_Chance^/1; [Resistance]
!!SN:W^AdventurerTown_4_Skill_27_Chance^/8; [First Aid]
!!SN:W^AdventurerTown_4_Stat_0_Chance^/50;
!!SN:W^AdventurerTown_4_Stat_1_Chance^/5;
!!SN:W^AdventurerTown_4_Stat_2_Chance^/30;
!!SN:W^AdventurerTown_4_Stat_3_Chance^/15;

Dungeon's Dragon's Treasurers
!!SN:W^AdventurerTown_5_Skill_0_Chance^/4; [Pathfinding]
!!SN:W^AdventurerTown_5_Skill_1_Chance^/1; [Archery]
!!SN:W^AdventurerTown_5_Skill_2_Chance^/6; [Logistics]
!!SN:W^AdventurerTown_5_Skill_3_Chance^/9; [Scouting]
!!SN:W^AdventurerTown_5_Skill_4_Chance^/6; [Diplomacy]
!!SN:W^AdventurerTown_5_Skill_5_Chance^/6; [Nobility (Navigation)]
!!SN:W^AdventurerTown_5_Skill_6_Chance^/5; [Leadership]
!!SN:W^AdventurerTown_5_Skill_7_Chance^/5; [Wisdom]
!!SN:W^AdventurerTown_5_Skill_8_Chance^/2; [Mysticism]
!!SN:W^AdventurerTown_5_Skill_9_Chance^/2; [Luck]
!!SN:W^AdventurerTown_5_Skill_10_Chance^/4; [Ballistics]
!!SN:W^AdventurerTown_5_Skill_11_Chance^/6; [Eagle Eye]
!!SN:W^AdventurerTown_5_Skill_12_Chance^/0; [Necromancy]
!!SN:W^AdventurerTown_5_Skill_13_Chance^/10; [Estates]
!!SN:W^AdventurerTown_5_Skill_14_Chance^/2; [Fire Magic]
!!SN:W^AdventurerTown_5_Skill_15_Chance^/4; [Air Magic]
!!SN:W^AdventurerTown_5_Skill_16_Chance^/2; [Water Magic]
!!SN:W^AdventurerTown_5_Skill_17_Chance^/4; [Earth Magic]
!!SN:W^AdventurerTown_5_Skill_18_Chance^/1; [Scholar]
!!SN:W^AdventurerTown_5_Skill_19_Chance^/6; [Tactics]
!!SN:W^AdventurerTown_5_Skill_20_Chance^/4; [Artillery]
!!SN:W^AdventurerTown_5_Skill_21_Chance^/4; [Learning]
!!SN:W^AdventurerTown_5_Skill_22_Chance^/4; [Offence]
!!SN:W^AdventurerTown_5_Skill_23_Chance^/4; [Armorer]
!!SN:W^AdventurerTown_5_Skill_24_Chance^/1; [Intelligence]
!!SN:W^AdventurerTown_5_Skill_25_Chance^/4; [Sorcery]
!!SN:W^AdventurerTown_5_Skill_26_Chance^/3; [Resistance]
!!SN:W^AdventurerTown_5_Skill_27_Chance^/3; [First Aid]
!!SN:W^AdventurerTown_5_Stat_0_Chance^/30;
!!SN:W^AdventurerTown_5_Stat_1_Chance^/30;
!!SN:W^AdventurerTown_5_Stat_2_Chance^/30;
!!SN:W^AdventurerTown_5_Stat_3_Chance^/10;

Stronghold's Wastelands Hunters
!!SN:W^AdventurerTown_6_Skill_0_Chance^/5; [Pathfinding]
!!SN:W^AdventurerTown_6_Skill_1_Chance^/5; [Archery]
!!SN:W^AdventurerTown_6_Skill_2_Chance^/10; [Logistics]
!!SN:W^AdventurerTown_6_Skill_3_Chance^/8; [Scouting]
!!SN:W^AdventurerTown_6_Skill_4_Chance^/3; [Diplomacy]
!!SN:W^AdventurerTown_6_Skill_5_Chance^/8; [Nobility (Navigation)]
!!SN:W^AdventurerTown_6_Skill_6_Chance^/5; [Leadership]
!!SN:W^AdventurerTown_6_Skill_7_Chance^/2; [Wisdom]
!!SN:W^AdventurerTown_6_Skill_8_Chance^/1; [Mysticism]
!!SN:W^AdventurerTown_6_Skill_9_Chance^/3; [Luck]
!!SN:W^AdventurerTown_6_Skill_10_Chance^/4; [Ballistics]
!!SN:W^AdventurerTown_6_Skill_11_Chance^/4; [Eagle Eye]
!!SN:W^AdventurerTown_6_Skill_12_Chance^/0; [Necromancy]
!!SN:W^AdventurerTown_6_Skill_13_Chance^/8; [Estates]
!!SN:W^AdventurerTown_6_Skill_14_Chance^/3; [Fire Magic]
!!SN:W^AdventurerTown_6_Skill_15_Chance^/3; [Air Magic]
!!SN:W^AdventurerTown_6_Skill_16_Chance^/1; [Water Magic]
!!SN:W^AdventurerTown_6_Skill_17_Chance^/3; [Earth Magic]
!!SN:W^AdventurerTown_6_Skill_18_Chance^/1; [Scholar]
!!SN:W^AdventurerTown_6_Skill_19_Chance^/3; [Tactics]
!!SN:W^AdventurerTown_6_Skill_20_Chance^/6; [Artillery]
!!SN:W^AdventurerTown_6_Skill_21_Chance^/4; [Learning]
!!SN:W^AdventurerTown_6_Skill_22_Chance^/5; [Offence]
!!SN:W^AdventurerTown_6_Skill_23_Chance^/4; [Armorer]
!!SN:W^AdventurerTown_6_Skill_24_Chance^/2; [Intelligence]
!!SN:W^AdventurerTown_6_Skill_25_Chance^/2; [Sorcery]
!!SN:W^AdventurerTown_6_Skill_26_Chance^/5; [Resistance]
!!SN:W^AdventurerTown_6_Skill_27_Chance^/4; [First Aid]
!!SN:W^AdventurerTown_6_Stat_0_Chance^/45;
!!SN:W^AdventurerTown_6_Stat_1_Chance^/25;
!!SN:W^AdventurerTown_6_Stat_2_Chance^/15;
!!SN:W^AdventurerTown_6_Stat_3_Chance^/15;

Fortress's Swamps Foragers
!!SN:W^AdventurerTown_7_Skill_0_Chance^/10; [Pathfinding]
!!SN:W^AdventurerTown_7_Skill_1_Chance^/1; [Archery]
!!SN:W^AdventurerTown_7_Skill_2_Chance^/6; [Logistics]
!!SN:W^AdventurerTown_7_Skill_3_Chance^/7; [Scouting]
!!SN:W^AdventurerTown_7_Skill_4_Chance^/6; [Diplomacy]
!!SN:W^AdventurerTown_7_Skill_5_Chance^/5; [Nobility (Navigation)]
!!SN:W^AdventurerTown_7_Skill_6_Chance^/3; [Leadership]
!!SN:W^AdventurerTown_7_Skill_7_Chance^/4; [Wisdom]
!!SN:W^AdventurerTown_7_Skill_8_Chance^/3; [Mysticism]
!!SN:W^AdventurerTown_7_Skill_9_Chance^/3; [Luck]
!!SN:W^AdventurerTown_7_Skill_10_Chance^/1; [Ballistics]
!!SN:W^AdventurerTown_7_Skill_11_Chance^/9; [Eagle Eye]
!!SN:W^AdventurerTown_7_Skill_12_Chance^/0; [Necromancy]
!!SN:W^AdventurerTown_7_Skill_13_Chance^/5; [Estates]
!!SN:W^AdventurerTown_7_Skill_14_Chance^/2; [Fire Magic]
!!SN:W^AdventurerTown_7_Skill_15_Chance^/2; [Air Magic]
!!SN:W^AdventurerTown_7_Skill_16_Chance^/5; [Water Magic]
!!SN:W^AdventurerTown_7_Skill_17_Chance^/3; [Earth Magic]
!!SN:W^AdventurerTown_7_Skill_18_Chance^/4; [Scholar]
!!SN:W^AdventurerTown_7_Skill_19_Chance^/2; [Tactics]
!!SN:W^AdventurerTown_7_Skill_20_Chance^/1; [Artillery]
!!SN:W^AdventurerTown_7_Skill_21_Chance^/6; [Learning]
!!SN:W^AdventurerTown_7_Skill_22_Chance^/4; [Offence]
!!SN:W^AdventurerTown_7_Skill_23_Chance^/5; [Armorer]
!!SN:W^AdventurerTown_7_Skill_24_Chance^/2; [Intelligence]
!!SN:W^AdventurerTown_7_Skill_25_Chance^/2; [Sorcery]
!!SN:W^AdventurerTown_7_Skill_26_Chance^/3; [Resistance]
!!SN:W^AdventurerTown_7_Skill_27_Chance^/8; [First Aid]
!!SN:W^AdventurerTown_7_Stat_0_Chance^/20;
!!SN:W^AdventurerTown_7_Stat_1_Chance^/35;
!!SN:W^AdventurerTown_7_Stat_2_Chance^/20;
!!SN:W^AdventurerTown_7_Stat_3_Chance^/25;

Conflux's Balancers
!!SN:W^AdventurerTown_8_Skill_0_Chance^/3; [Pathfinding]
!!SN:W^AdventurerTown_8_Skill_1_Chance^/3; [Archery]
!!SN:W^AdventurerTown_8_Skill_2_Chance^/6; [Logistics]
!!SN:W^AdventurerTown_8_Skill_3_Chance^/5; [Scouting]
!!SN:W^AdventurerTown_8_Skill_4_Chance^/6; [Diplomacy]
!!SN:W^AdventurerTown_8_Skill_5_Chance^/6; [Nobility (Navigation)]
!!SN:W^AdventurerTown_8_Skill_6_Chance^/2; [Leadership]
!!SN:W^AdventurerTown_8_Skill_7_Chance^/4; [Wisdom]
!!SN:W^AdventurerTown_8_Skill_8_Chance^/3; [Mysticism]
!!SN:W^AdventurerTown_8_Skill_9_Chance^/1; [Luck]
!!SN:W^AdventurerTown_8_Skill_10_Chance^/3; [Ballistics]
!!SN:W^AdventurerTown_8_Skill_11_Chance^/5; [Eagle Eye]
!!SN:W^AdventurerTown_8_Skill_12_Chance^/3; [Necromancy]
!!SN:W^AdventurerTown_8_Skill_13_Chance^/6; [Estates]
!!SN:W^AdventurerTown_8_Skill_14_Chance^/4; [Fire Magic]
!!SN:W^AdventurerTown_8_Skill_15_Chance^/4; [Air Magic]
!!SN:W^AdventurerTown_8_Skill_16_Chance^/4; [Water Magic]
!!SN:W^AdventurerTown_8_Skill_17_Chance^/4; [Earth Magic]
!!SN:W^AdventurerTown_8_Skill_18_Chance^/3; [Scholar]
!!SN:W^AdventurerTown_8_Skill_19_Chance^/1; [Tactics]
!!SN:W^AdventurerTown_8_Skill_20_Chance^/3; [Artillery]
!!SN:W^AdventurerTown_8_Skill_21_Chance^/9; [Learning]
!!SN:W^AdventurerTown_8_Skill_22_Chance^/4; [Offence]
!!SN:W^AdventurerTown_8_Skill_23_Chance^/4; [Armorer]
!!SN:W^AdventurerTown_8_Skill_24_Chance^/3; [Intelligence]
!!SN:W^AdventurerTown_8_Skill_25_Chance^/4; [Sorcery]
!!SN:W^AdventurerTown_8_Skill_26_Chance^/4; [Resistance]
!!SN:W^AdventurerTown_8_Skill_27_Chance^/5; [First Aid]
!!SN:W^AdventurerTown_8_Stat_0_Chance^/25;
!!SN:W^AdventurerTown_8_Stat_1_Chance^/25;
!!SN:W^AdventurerTown_8_Stat_2_Chance^/25;
!!SN:W^AdventurerTown_8_Stat_3_Chance^/25;


*Fix Battle Plugin by igrik fix
Here all variables should be reset before a repeated fight
!?FU(OnBattleReplay);

!!SN:W^This_Is_Replay_Battle^/1;
*!SN:W^Leadership_Current_battle_round^/-1;
*!SN:W^Leadership_Stack_had_Moral^/-1;
!!SN:W^Pathfinding_Speed_Bonus1^/0;     [Reset]
!!SN:W^Pathfinding_Speed_Bonus2^/0;     [Reset]
!!SN:W^Logistics_Speed_Bonus1^/0;       [Reset]
!!SN:W^Logistics_Speed_Bonus2^/0;       [Reset]
!!SN:W^Improved_Tent^/-1;
!!SN:W^Double_Cast_Attacker^/0;
!!SN:W^Double_Cast_Defender^/0;
!!SN:W^Master_Mage_Extra_Cast_att^/0;
!!SN:W^Master_Mage_Extra_Cast_def^/0;
!!SN:W^Brute_Gold_Att^/0; !!SN:W^Brute_Gold_Def^/0;
!!SN:W^Paladin_Experience_Att^/0; !!SN:W^Paladin_Experience_Def^/0;
!!SN:W^Event_Counter^/0;
!!SN:W^Temple_Guarding_Casts^/0;
!!IF:V761/1;
!!SN:W^Creature Bank visit^/0;
!!SN:W^landmine_var^/0;                 [landmine variable]
!!SN:W^Bers_en^/0;                      [Reset vars before combat]
!!SN:W^Animate_Dead^/0;
!!SN:W^MA_Stack_Number^/-1;
!!SN:W^Improved_Cure^/0;
!!SN:W^Incinerate^/0;                   [Reset Incinerate Damage]

!!re y1/0/41;
  !!SN:W^Ballista_Crippling_Target_%Y1^/0;[ReSet flag that creature has been targetet with ballista]
  !!SN:W^DisruptingRayCastsStack%Y1^/0;
  !!SN:W^DisRayStoneSkinRemoved%Y1^/0;
  !!SN:W^StoneSkinHitsStack%Y1^/0;
  !!SN:W^Burned_Stack_%Y1^/0;             [Reset afterwards]
  !!SN:W^Bless_Strike_Creature%Y1^/0;
  !!SN:W^Precision_Strike_Creature%Y1^/0;
  !!SN:W^ACM_Fire_Shield_Target_%Y1^/0;  [Set Flag active for Fire Shield]
!!en;

!!IF:V936/0;
!!SN:W^Week_Slow_Cast0^/0;              [So only works once per combat]
!!SN:W^Week_Slow_Cast1^/0;
!!SN:W^Week_Haste_Cast0^/0;             [So only works once per combat]
!!SN:W^Week_Haste_Cast1^/0;             [Quick Combat Flag]
!!SN:W^Mage_Spell_Enhancement_0^/0;     [Reset for Attacker]
!!SN:W^Mage_Spell_Enhancement_1^/0;     [Reset for Defender]
!!SN:W^Battlemage_Precast_0^/0;
!!SN:W^Battlemage_Precast_1^/0;
!!SN:W^Hunter_Speed_Bonus1^/0;          [Reset]
!!SN:W^Hunter_Speed_Bonus2^/0;          [Reset]
!!SN:W^Elemental_Set_att^/0;
!!SN:W^Elemental_Set_def^/0;
!!SN:W^Luck_Count_Att^/0;               [Luck Count Attacker reset]
!!SN:W^Luck_Count_Def^/0;               [Luck Count Defender reset]
!!SN:W^Speed_MonsterNumber^/-1;
!!SN:W^Attacker_Eagle_Eye_Spells^/0;    [Reset Spell Count]
!!SN:W^Defender_Eagle_Eye_Spells^/0;
!!VRv9287:S0; !!VRv9288:S0; !!VRv9276:S0; !!VRv9277:S0;
!!VRv9278:S0; !!VRv9279:S0; !!VRv9280:S0; !!VRv9281:S0;
!!VRv9282:S0; !!VRv9283:S0;
!!SN:W^shield_var1^/0; !!SN:W^shield_var2^/0; [shield variable]
!!SN:W^sacrifice_var^/0;                [Reset vars after combat]
!!SN:W^Sorrow_Cast0^/0; !!SN:W^Sorrow_Cast1^/0;
!!SN:W^Force_Field_Cast^/0;             [Set Flag to false after battle Force Field]
!!SN:W^Mirth_Cast0^/0; !!SN:W^Mirth_Cast1^/0;
!!SN:W^Slayer_Cast0^/0; !!SN:W^Slayer_Cast1^/0;
!!SN:W^Mirth_Current_battle_round^/-1;
!!SN:W^Mirth_Stack_had_Moral^/-1;
!!SN:W^Bloodlust_Cast0^/0; !!SN:W^Bloodlust_Cast1^/0;
!!SN:W^Fortune_Cast0^/0; !!SN:W^Fortune_Cast1^/0;
!!SN:W^Prayer_Cast0^/0; !!SN:W^Prayer_Cast1^/0;
!!SN:W^Curse_Cast0^/0; !!SN:W^Curse_Cast1^/0;
!!SN:W^Weakness_Cast0^/0; !!SN:W^Weakness_Cast1^/0;
!!SN:W^Shield_Cast0^/0;   !!SN:W^Shield_Cast1^/0;
!!SN:W^Fire_Shield_Cast0^/0; !!SN:W^Fire_Shield_Cast1^/0;
!!SN:W^Slow_Cast0^/0; !!SN:W^Slow_Cast1^/0;
!!SN:W^Haste_Cast0^/0; !!SN:W^Haste_Cast1^/0;
!!SN:W^Bless_Cast0^/0; !!SN:W^Bless_Cast1^/0;
!!SN:W^Stoneskin_Cast0^/0; !!SN:W^Stoneskin_Cast1^/0;
!!SN:W^Counterstrike_Cast0^/0; !!SN:W^Counterstrike_Cast1^/0;
!!SN:W^Heal_Cast0^/0; !!SN:W^Heal_Cast1^/0;
!!SN:W^Improved_Cure^/0;
!!SN:W^Magic_Mirror_Cast0^/0; !!SN:W^Magic_Mirror_Cast1^/0;
!!SN:W^Air_Shield_Cast0^/0; !!SN:W^Air_Shield_Cast1^/0;
!!SN:W^Animate_Cast0^/0; !!SN:W^Animate_Cast1^/0;
!!SN:W^Improved_Magic_Arrow_Counter^/0;
!!SN:W^Fire_Protection_Cast_0^/0;
!!SN:W^Fire_Protection_Cast_1^/0;
!!SN:W^Water_Protection_Cast_0^/0;
!!SN:W^Water_Protection_Cast_1^/0;
!!SN:W^Earth_Protection_Cast_0^/0;
!!SN:W^Earth_Protection_Cast_1^/0;
!!SN:W^Air_Protection_Cast_0^/0;
!!SN:W^Air_Protection_Cast_1^/0;
!!SN:W^H3_Summon_Fire_0^/0;
!!SN:W^H3_Summon_Fire_1^/0;
!!SN:W^H3_Summon_Earth_0^/0;
!!SN:W^H3_Summon_Earth_1^/0;
!!SN:W^H3_Summon_Water_0^/0;
!!SN:W^H3_Summon_Water_1^/0;
!!SN:W^H3_Summon_Air_0^/0;
!!SN:W^H3_Summon_Air_1^/0;
!!DO(AC_Function_125)/0/41/1&1000:P10;       [Reset Position for Teleport]

!!SN:W^Magic_Week_Number^/?y99;
!!SN&y99=34:W^Magic_Week_34_att^/1;     [Extra Cast Variable Attacker Set 1]
!!SN&y99=34:W^Magic_Week_34_def^/1;     [Extra Cast Variable Defender Set 1]
!!SN&y99=41:W^Magic_Week_41_att^/2;     [Extra Cast Variable Attacker Set 2]
!!SN&y99=41:W^Magic_Week_41_def^/2;     [Extra Cast Variable Defender Set 2]

!!SN:W^Magic_Week_Spell_Element^/0;     [Extra Cast Variable Element Week Reset]
!!SN:W^Stoneskin_Cast00^/0;             [For whole Battle]
!!SN:W^Stoneskin_Cast11^/0;
!!SN:W^Message_Flag^/0;                 [Set Flag if Human Player]
!!SN:W^Summoned_Elemental_Perk^/0;

!!SN:W^Magic_Specialists_Att^/0;        [Reset extra Cast at Battle End]
!!SN:W^Magic_Specialists_Def^/0;
!!SN:W^Sorcery_Specialists_Cast_Counter^/0;
!!SN:W^Elemental_Specialists_Cast_Counter^/0;
!!SN:W^Magic_Specialists_Def_Spells_Saved^/0;
!!SN:W^Magic_Specialists_Att_Spells_Saved^/0;
!!DO(AC_Function_78)/0/99/1:P;          [Reset Cast Counter at Battle End]
!!SN:W^Summoned_Water_Perk_0^/0;        [For Attacker Side 0]
!!SN:W^Summoned_Earth_Perk_0^/0;        [For Attacker Side 0]
!!SN:W^Summoned_Water_Perk_1^/0;        [For Defender Side 1]
!!SN:W^Summoned_Earth_Perk_1^/0;        [For Defender Side 1]

!!SN:W^WM_Maintain_Att_Bal^/0;  !!SN:W^WM_Maintain_Def_Bal^/0;
!!SN:W^WM_Maintain_Att_Ammo^/0; !!SN:W^WM_Maintain_Def_Ammo^/0;
!!SN:W^WM_Maintain_Att_Tent^/0; !!SN:W^WM_Maintain_Def_Tent^/0;
!!SN:W^Att_HP_Army_Value^/0;            [Reset Fight Value]

!!SN:W^Total_Healed_Amount_Att^/0;      [Reset value before any fight]
!!SN:W^Total_Healed_Amount_Def^/0;
!!SN:W^Tent_Number_Att^/-1;
!!SN:W^Tent_Number_Def^/-1;
!!SN:W^Tent_Capacity_Att^/0;
!!SN:W^Tent_Capacity_Def^/0;
!!SN:W^Army_Att^/1;
!!SN:W^Army_Def^/1;
!!SN:W^Hardened_Shield_Block_0^/1;
!!SN:W^Hardened_Shield_Block_1^/1;

!!SN:W^Prevent_Com_Cast_Flag^/0;
!!SN:W^Avenger_Com_Mastery_Flag^/1;
!!SN:W^Magic_Artillery_Shoot_Flag^/0;
!!SN:W^First_Turn_in_Combat^/0;
!!SN:W^Undead_Commander_Revive_Att^/0; [set revive flag attacker]
!!SN:W^Undead_Commander_Revive_Def^/0; [set revive flag defender]
!!SN:W^Lancer_Commander_Distance_Att^/0;
!!SN:W^Lancer_Commander_Distance_Def^/0;


!?FU(OnBeforeBattleUniversal);
!!SN:W^This_Is_Replay_Battle^/0;
!!SN:W^Summoned_Water_Perk_0^/0;        [For Attacker Side 0]
!!SN:W^Summoned_Earth_Perk_0^/0;        [For Attacker Side 0]
!!SN:W^Summoned_Water_Perk_1^/0;        [For Defender Side 1]
!!SN:W^Summoned_Earth_Perk_1^/0;        [For Defender Side 1]
!!SN:W^Hardened_Shield_Block_0^/1;
!!SN:W^Hardened_Shield_Block_1^/1;
!!SN:W^Prevent_Com_Cast_Flag^/0;
!!SN:W^Avenger_Com_Mastery_Flag^/1;
!!SN:W^Magic_Artillery_Shoot_Flag^/0;
!!SN:W^First_Turn_in_Combat^/0;
!!SN:W^Undead_Commander_Revive_Att^/0; [set revive flag attacker]
!!SN:W^Undead_Commander_Revive_Def^/0; [set revive flag defender]
!!SN:W^Lancer_Commander_Distance_Att^/0;
!!SN:W^Lancer_Commander_Distance_Def^/0;


********************************************************************************
** Critical Sorcery v.2.1, a mod by PerryR **
**V-Vars used:
**Z-Vars used:
**Function used:
**Flags used:

!#SN:W^Critical_Sorcery_Mod^/1;         [Critical Sorcery Mod Active]
!#TM51:S1/999/7/255;

*-------------------------------------------------------------------------------
!?MR1&1000;                             [Magic Res Trigger for Crit]

!!BG:H?y1;                              [Determine if AI controlls Hero]
!!HEy1:O?y1;
!!OW:Iy1/?y1;
!!FU&y1=1:E;

!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>1:E;

!!BG:Q?y4;
!!BA:Hy4/?y4;
!!FU&y4<=0:E;                           [Exit if no Hero]

!!BG:Q?y30;
!!VRy30:-1 *-1;
!!BA:Hy30/?y31;                         [Enemy Hero for resistance Calculation]

!!BG:S?y2;                              [Falls Aktion ein Cast ist dann Speichere 1 in y2]
!!FU&y2<=9|y2>69:E;

!!MR:F?y3;                              [Speichere DMG in y3]
!!FU&y3<=0:E;

!!MR:N?y5;                              [return Creature number which took magic damage]

!!BG:Q?y13;
!!BMy5:I?y12;

!!if&y13<>y12;
  !!if&y5>=0/y5<=41;

  !!FU(H3_Calc_Crit_Chance_and_Damage):Py4/?y16/?y99/1/y31/y2/y5; [(Pass Hero Number/Returns Crit chance/Crit damage/Battle State/Enemy Hero/Spell/Target)]

  !!VRy9:S0R99;                           [y9 chance to crit (0..99)]

  !!if&y9<y16;
    !!if|y2=24/y2=25/y2=26;                [Death Ripple, Destroy Undead and Armageddon get -25% crit damage]
      !!VRy99:-25;
    !!en;

    !!VRy3:*y99:100;
    *!IF:M^Returened Crit Chance %Y16 and Damage %Y99  and Random Roll %Y9 and Spell Damage y3 is %Y3^;
    !!MR:Fy3;                               [apply new damage]
    !!BA:Q?f;
    !!BMy5&i^battle_isVisible^:V82;                         [show crit animation]
  !!en;
!!en;
!!en;

********************************************************************************
!?FU(H3_Calc_Normal_Spell_Damage);
x1=Hero Number, x2=Returns Damage, x3=Returns extra damage, x4=Battle or No Battle State, x5=Spell Number, x6=1 show only in Bonus Table
Pass Hero Number and Give Back Damage in y99 and Extra Damage Option and Spell Number

!!VRy99:S100;
!!HEx1:A2/124/?y10/?y11;
!!VRy99&y11=1:+15;                      [Wenn das Spellbinder's Hat getragen wird plus +15% Damage]

!!HEx1:A2/128/?y10/?y16;
!!VRy99&y16=1:+15;                      [Wenn das Armageddon's Blade getragen wird plus +15% Damage]

!!HEx1:A2/106/?y10/?y12;
!!VRy99&y12=1/x5=17:+25;                [Wenn das Pendant of Negativity getragen wird plus +25% Damage auf Lightning Strike und 20% Damage auf Chain Lightning]
!!VRy99&y12=1/x5=19:+20;

!!HEx1:A2/127/?y10/?y13;
!!VRy99&y13=1/x5=21:+35;                [Wenn das Vial of Dragon Blood getragen wird plus +35% Damage auf Fireball und 25% Damage auf Inferno]
!!VRy99&y13=1/x5=22:+25;

!!HEx1:A2/22/?y10/?y14;
!!VRy99&y14=1/x5=16:+30;                [Wenn das Crown of the Supreme Magi getragen wird plus +30% Damage auf Ice Bolt und 30% Damage auf Frost Ring]
!!VRy99&y14=1/x5=20:+30;

!!HEx1:A2/28/?y10/?y15;
!!VRy99&y15=1/x5=23:+30;                [Wenn das Tunic of the Cyclops King getragen wird plus +30% Damage auf Meteor Shower und 20% Damage auf Implosion]
!!VRy99&y15=1/x5=18:+20;

!!HEx1:A2/20/?y10/?y16;
!!VRy99&y16=1/x5=15:+25;                [Wenn der Skull Helmet getragen wird plus +25% Damage auf Magic Arrow]

!!HEx1:A2/26/?y10/?y17;
!!VRy99&y17=1/x5=15:+25;                [Wenn der Rib Cage getragen wird plus +25% Damage auf Magic Arrow]

!!FU(Count_Set_Pieces):Px1/?y90/?y91/?y92/?y93/?y94/?y95/?y96/0/0/0/0/?y33/?y34; [Count Set Pieces function]
!!VRy99&y90=6:+20;                      [If hero wears all 6 Dragon Set pieces + 20% Spell Damage]

!!VRy99&y33>=4/x5=21:+20;               [If hero wears all 5 Archdevil Suite Set pieces + 20% Fire Spell Damage Fireball]
!!VRy99&y33>=4/x5=22:+20;               [If hero wears all 5 Archdevil Suite Set pieces + 20% Fire Spell Damage Inferno]
!!VRy99&y33>=4/x5=26:+20;               [If hero wears all 5 Archdevil Suite Set pieces + 20% Fire Spell Damage Armageddon]
!!VRy99&y33>=4/x5=13:+20;               [If hero wears all 5 Archdevil Suite Set pieces + 20% Fire Spell Damage Firewall]
!!VRy99&y33>=4/x5=11:+20;               [If hero wears all 5 Archdevil Suite Set pieces + 20% Fire Spell Damage Landmine]

!!FU(Count_Set_Pieces_2):Px1/?y47;      [Count Set Pieces function]
!!VRy99&y47>=4/x5=23:+20;               [If hero wears all 4 Battle Mage War Dress Set pieces + 20% Earth Spell Damage Meteor Shower]
!!VRy99&y47>=4/x5=24:+20;               [If hero wears all 4 Battle Mage War Dress Set pieces + 20% Earth Spell Damage Death Ripple]
!!VRy99&y47>=4/x5=18:+20;               [If hero wears all 4 Battle Mage War Dress Set pieces + 20% Earth Spell Damage Implosion]

!!VRy99&y95=6:+20;                      [If hero wears all 6 Priest of the Light Set pieces + 20% Spell Damage]
!!VRy99&y95=6/x5=25:+50;                [If hero wears all 6 Priest of the Light Set pieces + 50% Spell Damage to Destroy Undead]

!!VRy99&y96=6:+20;                      [If hero wears all 6 Priest of the Dark Set pieces + 20% Spell Damage]
!!VRy99&y96=6/x5=24:+50;                [If hero wears all 6 Priest of the Dark Set pieces + 50% Spell Damage to Death Ripple]

!!VRy99&y34=6:+10;                      [If hero wears all 6 Angelic Alliance Set pieces + 10% Spell Damage]

!!VRy99&y91>=3:+10;                     [If hero wears 3/4 Elemental Unity pieces +10%/+15% extra Spell Damage]
!!VRy99&y91=4:+15;

!!if&y94=4/x4=1;                        [The Adventures Fidelity Set is full]
  !!BG:Q?y2;
  !!SN&y2=0:W^Luck_Count_Att^/?y1;      [Luck Count Attacker +1]
  !!SN&y2=1:W^Luck_Count_Def^/?y1;      [Luck Count Attacker +1]
  !!VRy99:+y1;                          [+10% damage per Luck per battle]
!!en;

!!HEx1:A2/76/?y10/?y20;                 [Check for Collar of Conjuring]
!!VRy99&y20=1:+4;
!!HEx1:A2/77/?y10/?y21;                 [Check for Ring of Conjuring]
!!VRy99&y21=1:+6;
!!HEx1:A2/78/?y10/?y22;                 [Check for Cape of Conjuring]
!!VRy99&y22=1:+10;
!!HEx1:A2/139/?y10/?y18;                [Check for Ring of Magi]
!!VRy99&y18=1:+25;                      [+25% Spell damage]

!!SN&y18=1:W^Magi_Set_Count_Hero%X1^/?y19;
!!VRy19&y18=1::3;                       [1% Spell damage for each 3 fights won]
!!VRy99&y18=1:+y19;                     [+1% Spell Damage if Battle won with Ring equipped]

!!SN:W^Grandmaster_Mage_Hero%X1^/?y30;  [Gm Mage Channeling ability If Spell Points are abouve maximum increase damage by +15%]
!!if&y30=1;
  !!FU(Intelligence_Set_Spell_Points):Px1/0/?y31/1; [Return Number of Max Possible Spell Points in y31 for the Hero and only check not set]
  !!HEx1:I?y32/1;                       [Get Current Heroes Spell Points]
  !!VRy33:Sy31*95:100;                  [Get 95% of max spell points]
  !!VRy99&y32>=y33:+15;                 [Increase Spell damage by +15% condition is true]
!!en;

!!if&x6=0;                              [Only Add when not clicking in Hero Screen]
  !!HEx1:X?y23/?y24/?y25/?y25/?y25/?y25/?y25; [Check Hero Speciality for Elemental Specialists]
  !!FU(MSR_Determine_Spell_Type):Px5/0/0/?y22; [y22 Holds Spell School]  [y22 Returns the Magic School of the Spell that was Cast  1Air  2Earth  4Fire  8Water]
  !!if&y23=0;
    !!VRy99&y24=14/y22=4:+15;           [Set Fire Spells to +15% Damage]
    !!VRy99&y24=15/y22=1:+15;           [Set Air Spells to +15% Damage]
    !!VRy99&y24=16/y22=8:+15;           [Set Water Spells to +15% Damage]
    !!VRy99&y24=17/y22=2:+15;           [Set Fire Spells to +15% Damage]
  !!en;

  !!SN:W^H3_Fire Magic_0_Hero%X1^/?y10; [Fire Magic Bonus handling]
  !!SN:W^H3_Fire Magic_1_Hero%X1^/?y11;
  !!HEx1:S14/?y3;
  !!VRy99&y22=4/y3=3/y10=1/y11=0:+10;   [+10% Damage]
  !!VRy99&y22=4/y3=3/y10=1/y11=1:+25;   [+25% Damage]

  !!SN:W^H3_Air Magic_0_Hero%X1^/?y10;  [Air Magic Bonus handling]
  !!SN:W^H3_Air Magic_1_Hero%X1^/?y11;
  !!HEx1:S15/?y3;
  !!VRy99&y22=1/y3=3/y10=1/y11=0:+10;   [+10% Damage]
  !!VRy99&y22=1/y3=3/y10=1/y11=1:+25;   [+25% Damage]

  !!SN:W^H3_Water Magic_0_Hero%X1^/?y10;[Water Magic Bonus handling]
  !!SN:W^H3_Water Magic_1_Hero%X1^/?y11;
  !!HEx1:S16/?y3;
  !!VRy99&y22=8/y3=3/y10=1/y11=0:+10;   [+10% Damage]
  !!VRy99&y22=8/y3=3/y10=1/y11=1:+25;   [+25% Damage]

  !!SN:W^H3_Earth Magic_0_Hero%X1^/?y10;[Earth Magic Bonus handling]
  !!SN:W^H3_Earth Magic_1_Hero%X1^/?y11;
  !!HEx1:S17/?y3;
  !!VRy99&y22=2/y3=3/y10=1/y11=0:+10;   [+10% Damage]
  !!VRy99&y22=2/y3=3/y10=1/y11=1:+25;   [+25% Damage]
!!en;

!!if&x5=15;                             [If Magic Arrow]
  !!SN:W^Magic_Arrow_Hero%X1^/?y40;     [Get amount of upgrades that hero has for his Magic Arrow because of M/GM]
  !!SN:W^Magic_Arrow_dmg_increment^/?y60;[get damage increase per level]
  !!VRy40:*y60;                         [Magic Arrow 2% Bonus damage per kill at M/GM level]
  !!VRy99:+y40;                         [Set increased damage]
!!en;

Spell Trainer Damage Spells
!!SN:W^Spell_Trainer_Mod^/?y1;          [Check for Spell Trainer option]
!!if&y1=1;
  !!SN:W^Damage_Spells_Increment^/?y2;
  !!SN:W^SpellTrainerHero%X1_Spell%X5^/?y10;
  !!VRy10:*y2;                          [Damage Spells Upgrades times Increment]
  !!VRy99:+y10;                         [Set increased damage]
!!en;
******

Arcane Prophet ability
!!SN:W^Arcane_Prophet_Spell_%X1^/?y20; 
!!if&y20=x5/y20>0;
  !!SN:W^Arcane_Prophet_Spell_Damage%X1^/?y15; [Save Spell by Hero ID]
  !!VRy99:+y15;                         [Set increased damage]
!!en;
******

!!SN:W^ACM_Reward_Spell_Damage_%X1^/?y2;[Base gold reward per game month]
!!VRy99:+y2;                            [Add Bonus Spell damage from ACM rewards]

!!VRx2:Sy99;                            [Return Damage increase in x2]
!!VRx3&y91>=3:S1;                       [Set Bonus Damage]


********************************************************************************
!?FU(H3_Calc_Crit_Chance_and_Damage);

!!VRy16:S0;                             [Initialize Crit Chance Y16 to Zero]
!!VRy99:S125;                           [Initialize Crit Damage Y99 to 125]

!!HEx1:S7/?y6;                          [Checke ob der Held Weisheit hat und Speichere in y20]
!!SN:W^H3_Wisdom_0_Hero%X1^/?y20;       [Checke ob der Held Master Leadership hat und Speichere in y21]
!!SN:W^H3_Wisdom_1_Hero%X1^/?y21;
!!VRy16&y6=3/y20=1/y21=0:+5; !!VRy16&y6=3/y20=1/y21=1:+10; [Wisdom Crit Chance]
!!VRy99&y6=3/y20=1/y21=0:+10; !!VRy99&y6=3/y20=1/y21=1:+20; [Wisdom Crit Damage]

!!HEx1:S8/?y6;                          [Checke ob der Held Mystik hat und Speichere in y20]
!!SN:W^H3_Mysticism_0_Hero%X1^/?y20;    [Checke ob der Held Master Mystik hat und Speichere in y21]
!!SN:W^H3_Mysticism_1_Hero%X1^/?y21;
!!VRy16&y6=1/y20=0/y21=0:+3; !!VRy16&y6=2/y20=0/y21=0:+4; !!VRy16&y6=3/y20=0/y21=0:+5; !!VRy16&y6=3/y20=1/y21=0:+7; !!VRy16&y6=3/y20=1/y21=1:+10; [Mysticism Crit Chance]
!!VRy99&y6=1/y20=0/y21=0:+6; !!VRy99&y6=2/y20=0/y21=0:+8; !!VRy99&y6=3/y20=0/y21=0:+10; !!VRy99&y6=3/y20=1/y21=0:+15; !!VRy99&y6=3/y20=1/y21=1:+20; [Mysticism Crit Damage]

!!HEx1:S18/?y6;                         [Checke ob der Held Scholar hat und Speichere in y20]
!!SN:W^H3_Scholar_0_Hero%X1^/?y20;      [Checke ob der Held Master Scholar hat und Speichere in y21]
!!SN:W^H3_Scholar_1_Hero%X1^/?y21;
!!VRy16&y6=1/y20=0/y21=0:+6; !!VRy16&y6=2/y20=0/y21=0:+8; !!VRy16&y6=3/y20=0/y21=0:+10; !!VRy16&y6=3/y20=1/y21=0:+15; !!VRy16&y6=3/y20=1/y21=1:+20; [Scholar Crit Chance]
!!VRy99&y6=1/y20=0/y21=0:+5; !!VRy99&y6=2/y20=0/y21=0:+10; !!VRy99&y6=3/y20=0/y21=0:+15; !!VRy99&y6=3/y20=1/y21=0:+20; !!VRy99&y6=3/y20=1/y21=1:+25; [Scholar Crit Damage]

!!HEx1:S24/?y6;                         [Checke ob der Held Intelligence hat und Speichere in y20]
!!SN:W^H3_Intelligence_0_Hero%X1^/?y20; [Checke ob der Held Master Intelligence hat und Speichere in y21]
!!SN:W^H3_Intelligence_1_Hero%X1^/?y21;
!!VRy16&y6=1/y20=0/y21=0:+1; !!VRy16&y6=2/y20=0/y21=0:+2; !!VRy16&y6=3/y20=0/y21=0:+3; !!VRy16&y6=3/y20=1/y21=0:+4; !!VRy16&y6=3/y20=1/y21=1:+5; [Intelligence Crit Chance]
!!VRy99&y6=1/y20=0/y21=0:+6; !!VRy99&y6=2/y20=0/y21=0:+8; !!VRy99&y6=3/y20=0/y21=0:+10; !!VRy99&y6=3/y20=1/y21=0:+15; !!VRy99&y6=3/y20=1/y21=1:+20; [Intelligence Crit Damage]

!!HEx1:S25/?y6;                         [Checke ob der Held Sorcery hat und Speichere in y20]
!!SN:W^H3_Sorcery_0_Hero%X1^/?y20;      [Checke ob der Held Master Sorcery hat und Speichere in y21]
!!SN:W^H3_Sorcery_1_Hero%X1^/?y21;
!!VRy16&y6=1/y20=0/y21=0:+2; !!VRy16&y6=2/y20=0/y21=0:+4; !!VRy16&y6=3/y20=0/y21=0:+6; !!VRy16&y6=3/y20=1/y21=0:+8; !!VRy16&y6=3/y20=1/y21=1:+10; [Sorcery Crit Chance]
!!VRy99&y6=1/y20=0/y21=0:+5; !!VRy99&y6=2/y20=0/y21=0:+10; !!VRy99&y6=3/y20=0/y21=0:+15; !!VRy99&y6=3/y20=1/y21=0:+20; !!VRy99&y6=3/y20=1/y21=1:+25; [Sorcery Crit Damage]

!!if&x4=1/x5>=0;                        [Calc only when in Fight x4=1 and Valid Enemy Hero]
!!HEx5:S26/?y6;                         [Checke ob der Held Resistance hat und Speichere in y20]
!!SN:W^H3_Resistance_0_Hero%X5^/?y20;   [Checke ob der Held Master Resistance hat und Speichere in y21]
!!SN:W^H3_Resistance_1_Hero%X5^/?y21;
!!VRy99&y6=1/y20=0/y21=0:-10; !!VRy99&y6=2/y20=0/y21=0:-15; !!VRy99&y6=3/y20=0/y21=0:-20; !!VRy99&y6=3/y20=1/y21=0:-25; !!VRy99&y6=3/y20=1/y21=1:-30; [Resistance Crit Damage Reduce]
!!en;

!!HEx1:A2/170/?y10/?y19;
!!VRy16&y19=1:+10;                      [Wenn das Horn of Energy getragen wird plus +10% Crit Chance und +20% Crit Damage]

*!HEx1:A2/166/?y30/?y31;
*!VRy16&y31=1:+10;                      [Wenn das Necklace getragen wird plus +10% Crit Chance]

!!HEx1:A2/86/?y30/?y41;
!!VRy16&y41=1:+5;                       [Wenn das Tome of Fire Magic getragen wird plus +5% Crit Chance]

!!HEx1:A2/87/?y30/?y51;
!!VRy16&y51=1:+5;                       [Wenn das Tome of Air Magic getragen wird plus +5% Crit Chance]

!!HEx1:A2/88/?y30/?y61;
!!VRy16&y61=1:+5;                       [Wenn das Tome of Water Magic getragen wird plus +5% Crit Chance]

!!HEx1:A2/89/?y30/?y71;
!!VRy16&y71=1:+5;                       [Wenn das Tome of Earth Magic getragen wird plus +5% Crit Chance]

!!HEx1:A2/21/?y30/?y72;
!!VRy16&y72=1:+4;                       [Wenn der Helm of Chaos getragen wird plus +4% Crit Chance]

!!HEx1:A2/22/?y30/?y73;
!!VRy16&y73=1:+6;                       [Wenn der Crown of the Surpreme Magi Helm getragen wird plus +6% Crit Chance]

!!HEx1:A2/23/?y30/?y74;
!!VRy16&y74=1:+8;                       [Wenn der Hellstorm Helmet getragen wird plus +8% Crit Chance]

!!HEx1:A2/24/?y30/?y81;
!!VRy16&y81=1:+15;                      [Wenn der Thunder Helmet getragen wird plus +15% Crit Chance]

!!HEx1:A2/48/?y30/?y81;
!!VRy16&y81=1:+3;                       [Wenn der Ladybird of Luck getragen wird plus +3% Crit Chance]

!!HEx1:A2/46/?y30/?y81;
!!VRy16&y81=1:+3;                       [Wenn der 46 Clover of Fortune getragen wird plus +3% Crit Chance]

!!FU(Count_Set_Pieces):Px1/0/0/0/0/?y81;[Check for The Adventures Fidelity]
!!VRy16&y81>=3:+10;                     [Wenn der The Adventures Fidelity getragen wird plus +10% Crit Chance]

!!HEx1:A2/135/?y30/?y81;
!!VRy16&y81=1:+15;                      [Wenn der Titans Thunders getragen wird plus +15% Crit Chance]

!!HEx1:A2/30/?y30/?y91;                 [Wenn der Titan's Cuirass getragen wird plus +20% Crit Damage]

!!HEx1:A2/135/?y30/?y62;                [Wenn der Titans Thunders getragen wird plus +20% Crit Damage]

!!HEx1:A2/27/?y30/?y92;                 [Wenn der Scales of the Greater Basilisk getragen wird plus +5% Crit Damage]

!!HEx1:A2/28/?y30/?y93;                 [Wenn der Tunic of the Cyclops King getragen wird plus +10% Crit Damage]

!!HEx1:A2/29/?y30/?y94;                 [Wenn der Breastplate of Brimstone getragen wird plus +15% Crit Damage]

!!BMx7&x4=1/x7>=0/x7<=42:G19/?y14/?y15; [Check auf Electrik schock der Einheit]
!!VRy16&y14>0:+10;                      [Wenn das Ziel unter Electrik schock steht +10% Crit Chance]

!!SN:W^Magic_Week_Number^/?y95;         [Magic Week Var]
!!VRy16&y95=5:+15;                      [Wenn Magic Week =5 dann +15% Crit Chance]

!!FU(Count_Set_Pieces):Px1/?y90/?y96/?y40/?y41/?y42/?y43/?y44/0/0/0/0/0/?y46; [Count Set Pieces function]
!!VRy16&y90>=4:+10;                     [If hero wears 3 Dragon Set pieces + 10% Crit Chance]

!!VRy16&y43>=4:+5;                      [If hero wears 4 Priest of the Light Set pieces + 5% Crit Chance]

!!VRy16&y46>=4:+5;                      [If hero wears 4 Angelic Alliance Set pieces + 5% Crit Chance]

!!FU(Count_Set_Pieces_2):Px1/0/0/?y82;  [Check for  Sets]
!!if&y82=3;
  !!SN:W^Mage_Set_Count_Hero%X1^/?y83;
  !!VRy83::2;
  !!VRy84:Sy83;                         [Fight divided through 2 then add as crit chance]
  !!VRy16:+y84;                         [Add Crit chance based on bonus from Set if equipped ratio 1:2]
!!en;

!!FU(Check_Com_Masteries):Px1/?y70/0/0/?y71; [Pass Hero Number and return if Commander Mastery is enabled and current class]
!!VRy16&y70=1/y71=4:+15;                [+15% crit chance if Mastery enabled for Caster commander]
!!VRy16&y70=1/y71=14:+10;               [+10% crit chance if Mastery enabled for Arch Mage commander]
!!SN:W^Commander_%X1_Ancient_Caster^/?y1;
!!VRy16&y1=1:+15;                       [+15% crit chance for Ancient Caster commander]

!!if&x4=1;                              [Calc only when in Fight x4=1]
  !!BG:Q?y13;
  !!VRy13:-1 *-1;
  !!BA:Hy13/?y13;                       [Check for valid enemy Hero]
  !!FU(Count_Set_Pieces)&y13>=0:Py13/0/0/0/0/0/0/0/0/?y45; [Count Resistance Set Pieces]

  !!VRy16&y45>=1:-5;                    [If hero wears 1 Resistance Set pieces - 5% Crit Chance]
  !!VRy16&y45>=2:-5;                    [If hero wears 2 Resistance Set pieces - 5% Crit Chance]
  !!VRy16&y45=3:-5;                     [If hero wears 3 Resistance Set pieces - 15% Crit Chance]
!!en;

!!VRy99&y19=1:+20;                      [Crit mit Magic Horn of Energy +20%]
!!VRy99&y92=1:+5;                       [Crit mit Greater Basilisk +5%]
!!VRy99&y46>=4:+5;                      [Crit mit Angelic Alliance +5%]
!!VRy99&y93=1:+10;                      [Crit mit Tunic of the Cyclops King +10%]
!!VRy99&y94=1:+15;                      [Crit mit Breastplate of Brimstone +15%]
!!VRy99&y91=1:+20;                      [Crit mit Titan's Cuirass +20%]
!!VRy99&y62=1:+20;                      [Crit mit Titans Thunders +20%]
!!VRy99&y14>0:+20;                      [Crit mit Electric shock +20%]
!!VRy99&y95=6:+25;                      [Crit mit Magic Week +25%]
!!VRy99&y90>=5:+20;                     [Crit mit 5 Dragon Set Bonus +20%]
!!VRy99&y96>=2:+10;                     [Crit mit 2 Elemetal Unity Bonus +10%]
!!VRy99&y43>=4:+10;                     [Crit mit 4 Priest of the Light Set Bonus +10%]
!!VRy99&y44>=4:+10;                     [Crit mit 4 Priest of the Light Set Bonus +10%]
!!VRy99&y82>=2:+10;                     [Crit mit 2 Mage Class Set Bonus +10%]
!!VRy99&y82=3:+y83;                     [Crit mit 3 Mage Class Set Bonus +Number of Won fights /2]
!!VRy99&y45>=1/x4=1:-5;                 [Crit mit 1 Resistance Set pieces - 5% Crit dmg]
!!VRy99&y45>=2/x4=1:-5;                 [Crit mit 2 Resistance Set pieces - 10% Crit dmg]
!!VRy99&y45=3/x4=1:-10;                 [Crit mit 3 Resistance Set pieces - 20% Crit dmg]

!!HEx1:X?y11/?y12/?y75/?y75/?y75/?y75/?y75; [Check Hero Speciality]
!!if&y12=7/y11=0;                       [if Wisdom Crit Chance]
  !!HEx1:E?y47/?y48/1;                  [Check hero Level]
  !!VRy16:+y48;                         [For Wisdom Specialists Add level to Crit Chance]
  !!VRy16:*3:2;
  !!VRy99:-100:2+100;
  !!VRy99&y16>=100:+y16-100;            [Converts Crit chance above 100% to Crit damage]
!!en;

!!if&y12=18/y11=0;                      [if Scholar]
  !!HEx1:E?y47/?y48/1;                  [Check hero Level]
  !!VRy99:+10;                          [For Scholar Specialists Add +10 to Crit Damage]
  !!VRy16:+10;                          [For Scholar Specialists Add +10 to Crit Chance]
!!en;

!!if&y12=57/y11=3;                      [if Crit Damage]
  !!HEx1:E?y47/?y48/1;                  [Check hero Level]
  !!VRy99:+y48;                         [For Crit damage Specialists Add level to Crit Damage]
  !!VRy99:-100*2+100;
  !!VRy16::2;
!!en;

!!SN:W^ACM_Reward_Spell_Crit_Chance_%X1^/?y2; [Bonus Crit Chance]
!!VRy16:+y2;
!!SN:W^ACM_Reward_Spell_Crit_Damage_%X1^/?y2; [Bonus Crit Damage]
!!VRy99:+y2;                            [Add Bonus Spell damage from ACM rewards]

!!VRx2:Sy16;                            [Return Crit Chance in X2]
!!VRx3:Sy99;                            [Return Crit Damage in X3]


!?FU(H3_Calc_Vanilla_Bonus_Spell_Damage);
x1 - hero id, x2 - spell id, x3 - returns increased damage
!!FU(MSR_Determine_Spell_Type):Px2/0/0/?y1;
!!FU(GetSpellRank):Px1/x2/?y2;
!!HEx1:Fd/d/?y3/d;
!!SSx2:P?y4;
!!SSx2:Ey2/?y5;
!!VRx3:Sy3 *y4 +y5;                     [normal damage]

!!HEx1:S25/?y20;                        [check sorcery]
!!SN:W^H3_Sorcery_0_Hero%X1^/?y21;
!!SN:W^H3_Sorcery_1_Hero%X1^/?y22;
!!VRy6:S100; !!VRy6&y20=1:S110; !!VRy6&y20=2:S120; !!VRy6&y20=3/y21=0/y22=0:S130; !!VRy6&y20=3/y21=1/y22=0:S140; !!VRy6&y20=3/y21=1/y22=1:S150; [Add Sorcery Damage +10%-50%]
!!HEx1:X?y12/d/d/d/d/d/d;               [check sorc speciality or spell speciality]
!!if|y12=0/y12=3;
!!HEx1:X?y99/?y13/d/d/d/d/d;            [check sorc speciality or spell speciality]
!!HEx1:E?y99/?y14/1;
!!if&y12=0/y13=25;
  !!VRy14:*3 +100;
  !!VRy6:-100 *y14 :100 +100;
!!en;
!!if&y12=3/y13=x2/y13<>15/y13<>13;
  !!VRy14:*3 +100;
  !!VRx3: *y14 :100;
!!en;
!!if&y12=3/y13=13;
  !!VRx3: *2;
!!en;
!!if&y12=3/y13=15;
  !!VRx3: *3 /2;
!!en;
!!en;
!!VRx3: *y6 :100;                       [increase by sorcery]

!!HEx1:A2/79/d/?y7;                     [does hero wear Orb of Air]
!!HEx1:A2/80/d/?y8;                     [Earth]
!!HEx1:A2/81/d/?y9;                     [Fire]
!!HEx1:A2/82/d/?y10;                    [Water]
!!VRy11:S0;
!!if&y1=15;
!!VRy11:Sy7+y8+y9+y10;
!!el;
!!VRy11&y1=1:Sy7;
!!VRy11&y1=2:Sy8;
!!VRy11&y1=4:Sy9;
!!VRy11&y1=8:Sy10;
!!en;

!!VRx3&y11>0: *125 :100;                [increase by orbs]


********************************************************************************
!?FU(OnBattlefieldVisible)&1000;        [Combat Start]

!!BA:H0/?y1;
!!FU(Scouting_Set):Py1/1;

!!BA:H1/?y2;                            [Defending Hero]
!!FU(Scouting_Set)&y2>=0:Py2/2;


!?FU(Scouting_Set);

!!HEx1:A2/52/?y30/?y31;                 [Wenn das Spyglass getragen wird]
!!HEx1:A2/53/?y30/?y32;                 [Wenn das Speclum getragen wird]
!!HEx1:S3/?y33;                         [Check for Scouting]
!!HEx1:Ed/?y40/1;                       [Check Hero Level]

!!if&y31=1/y32=1/y33>0;
  !!VRy10:S1R3;

  !!VRy11&y10=1:S1R3;  !!SN&y10=1:T^AC_Misc.Scout_Attack^/?z-1;
  !!VRy11&y10=2:S1R3;  !!SN&y10=2:T^AC_Misc.Scout_Defense^/?z-1;
  !!VRy11&y10=3:S3R4;  !!SN&y10=3:T^AC_Misc.Scout_Health^/?z-1;
  !!VRy11&y10=4:S1R1;  !!SN&y10=4:T^AC_Misc.Scout_Speed^/?z-1;

  !!VRy40&y10=1|y10=2::10;              [Divide Hero level trough 10 to get more bonus with higher level]
  !!VRy40&y10=3::7;
  !!VRy40&y10=4::20;                    [Reduce for Speed]
  !!VRy11:+y40;

  !!HEx1:B0/?z-10;                      [get hero name]
  !!SN:T^AC_Misc.Prepare for Battle^/?z2 Iz2/?z2;
  !!IF:M^%Z2^;

  !!SN&x2=1:W^Prepare_For_Battle_Att^/y10; [Activate Battle Flag Attacker]
  !!SN&x2=2:W^Prepare_For_Battle_Def^/y10; [Activate Battle Flag Defender]
  !!SN:W^Prepare_For_Battle_Bonus^/y11; [Save Bonus]
!!en;


********************************************************************************
!?BF&1000;                              [Combat Start]

!!BH0:N?y1;                             [Attacking Hero]
!!FU(Count_Set_Pieces):Py1/?y90/?y91/?y92/?y93/0/0/0/0/0/0/0/?y94/?y95/?y96; [Count Set Pieces function]
!!VRy98&y92=3:S0R99; !!VRy92&y92=3/y98<50:S4; [50% chance with 3 set pieces]
!!SN&y92=4:W^Elemental_Set_att^/1;      [Extra Cast Attacker from Wizards Knowledge set 1]

!!HEy1:A2/135/?y30/?y31;                [Wenn der Titans Thunder getragen wird run function]
!!DO(AC_Function_58)/0/20/1&y31=1:P0/1;

!!DO(AC_Function_58)/0/20/1&y93=4:P0/4; [Moral Set make Fearless and Give level 1 Units Champion Charge]

!!SN:W^Reworked_Magic_Specialists_Mod^/?y49; [Reworked_Magic_Specialists_Mod]
!!VRy49:S0;
!!if&y49=999;                           [Disabled                [*only run when Magic Specialists Mod is not active to prevent errors]
!!HEy1:S11/?y40;                        [Check for Eagle Eye Skill]
!!DO(AC_Function_61)/10/69/1&y40>0/y96=3:Py1/1; [Count Spells Before Combat Attacker Hero]
!!en;

!!if&y94=100;                           [Disabled (from =5 to 100)                                       [Archdevils Suite]
!!FU(AC_Function_55):P1/?y5;            [return a random stack]
!!BMy5:F?i;                             [read flags]
!!VRi:&32768;                           [just look at waiting bit]
!!VRy50&i>0:S1;
!!FU(AC_Function_58)&y50<>1:Py5/3;      [and give that Stack Double Strike with Stack Exp]
**Add missing check for double later
!!en;

!!if&y95>=5;                            [Angelic Alliance Set]
!!DO(AC_Function_59)/0/20/1&y95=5:P105/1;
!!DO(AC_Function_59)/0/20/1&y95=6:P120/2;
!!en;

*!SN:W^Prepare_For_Battle_Att^/?y80;    [Scouting Set]
*!DO(AC_Function_60)/0/20/1&y80>0:Py80;

!!BH1:N?y2;                             [Defending Hero]

!!if&y2>=0;
!!FU(Count_Set_Pieces):Py2/?y90/?y91/?y92/?y93/0/0/0/0/0/0/0/?y94/?y95/?y96; [Count Set Pieces function]
!!VRy98&y92=3:S0R99; !!VRy92&y92=3/y98<50:S4;
!!SN&y92=4:W^Elemental_Set_def^/1;      [Extra Cast Defender from Wizards Knowledge set 1]

!!HEy2:A2/135/?y30/?y32;                [Wenn der Titans Thunder getragen wird run function]
!!DO(AC_Function_58)/21/41/1&y32=1:P0/1;

!!DO(AC_Function_58)/21/41/1&y93=4:P0/4;[Moral Set make Fearless and Give level 1 Units Champion Charge]

!!if&y49=999;                           [Disabled                [*only run when Magic Specialists Mod is not active to prevent errors]
!!HEy2:S11/?y40;                        [Check for Eagle Eye Skill]
!!DO(AC_Function_61)/10/69/1&y40>0/y96=3:Py2/2; [Count Spells Before Combat Defender Hero]
!!SN:W^Defender_Eagle_Eye_Spells^/?y33;
!!en;

!!if&y94=100;                           [Disabled (from =5 to 100)                                       [Archdevils Suite]
!!FU(AC_Function_55):P0/?y5;            [return a random stack]
!!BMy5:F?i;                             [read flags]
!!VRi:&32768;                           [just look at waiting bit]
!!VRy50&i>0:S1;
*!IF:M^y50 is %Y50^;
!!FU(AC_Function_58)&y50<>1:Py5/3;      [and give that Stack Double Strike with Stack Exp]
**Add missing check for double later
!!en;

!!if&y95>=5;                            [Angelic Alliance Set]
!!DO(AC_Function_59)/21/41/1&y95=5:P105/1;
!!DO(AC_Function_59)/21/41/1&y95=6:P120/2;
!!en;

*!SN:W^Prepare_For_Battle_Def^/?y80;    [Scouting Set]
*!DO(AC_Function_60)/21/41/1&y80>0:Py80;

!!en;

!!BA:O?y10/?y20;                        [Check Owner before Battle]
!!SN:W^Hero_Attacker_Owner0^/y10;       [for Ring of the Magi Set Bonus]

!!BA:H1/?y4;
!!SN&y4<>-2:W^Hero_Defender_Owner0^/y20;

*!SN:W^Prepare_For_Battle_Att^/0;
*!SN:W^Prepare_For_Battle_Def^/0;
*!SN:W^Prepare_For_Battle_Bonus^/0;


********************************************************************************
!?FU(OnAfterBattleUniversal)&1000;      [at end of battle]

!!SN:W^Elemental_Set_att^/0;
!!SN:W^Elemental_Set_def^/0;
!!SN:W^Luck_Count_Att^/0;               [Luck Count Attacker reset]
!!SN:W^Luck_Count_Def^/0;               [Luck Count Defender reset]
!!SN:W^Speed_MonsterNumber^/-1;
!!SN:W^Attacker_Eagle_Eye_Spells^/?y50; [Call Spell Count in Var]
!!SN:W^Defender_Eagle_Eye_Spells^/?y51;
!!SN:W^Attacker_Eagle_Eye_Spells^/0;    [Reset Spell Count]
!!SN:W^Defender_Eagle_Eye_Spells^/0;

!!BA:H0/?y1;                            [Attacking Hero]

!!SN:W^Reworked_Magic_Specialists_Mod^/?y49; [Reworked_Magic_Specialists_Mod]
!!VRy49:S0;
!!if&y49=0;                            [*only run when Magic Specialists Mod is not active to prevent errors]

!!FU(Count_Set_Pieces):Py1/0/0/0/0/0/0/0/0/0/0/0/0/0/?y96; [Count Set Pieces function]
!!HEy1:S11/?y40;                        [Check for Eagle Eye Skill]
!!if&y40>0/y96=999;                    [Disabled and replaced by better code]
****Eagle Eye Set Bonus Attacker
!!DO(AC_Function_61)/10/69/1:Py1/1;     [Count Spells After Combat Attacker Hero]
!!SN:W^Attacker_Eagle_Eye_Spells^/?y10;

!!if&y50<y10;
!!VRy10:-y50;
!!VRy10:S1;
!!HEy1&y10=1:Fd/d/d1/d;                 [give appropriate bonus]
!!HEy1&y10=2:Fd/d/d2/d;                 [give appropriate bonus]
!!HEy1&y10=3:Fd/d/d3/d;                 [give appropriate bonus]
!!HEy1&y10=4:Fd/d/d4/d;                 [give appropriate bonus]
!!HEy1&y10=5:Fd/d/d5/d;                 [give appropriate bonus]
!!HEy1&y10=6:Fd/d/d6/d;                 [give appropriate bonus]
!!HEy1&y10=7:Fd/d/d7/d;                 [give appropriate bonus]
!!HEy1:B0/?z-10;                        [get hero name]

!!SN:T^AC_Misc.Eagle Eye Set^/?z-9 Iz-9/?z-9;
!!HEy1:O?y3;                            [get owner of this hero]
!!OW&y3<>-1:Iy3/?y4;                    [get AI (1) or human (0)]
!!VRy5:S0;                              [assume AI]
!!VRy5&y3<>-1/y4=0:S1;                  [human if has owner and that owner is human]
!!IF&y5=1:Q2/33/y10/1/z-9;              [If Bonus Show Picture]
!!en;
!!en;
!!en;

!!BA:H1/?y2;                            [Defending Hero]
!!if&y2>=0;
!!SN:W^Reworked_Magic_Specialists_Mod^/?y49; [Reworked_Magic_Specialists_Mod]
!!VRy49:S0;
!!if&y49=0;                            [*only run when Magic Specialists Mod is not active to prevent errors]
!!HEy2:S11/?y41;
!!FU(Count_Set_Pieces):Py2/0/0/0/0/0/0/0/0/0/0/0/0/0/?y96; [Count Set Pieces function]
!!if&y41>0/y96=999;                    [Disabled and replaced by better code]
****Eagle Eye Set Bonus Defender
!!DO(AC_Function_61)/10/69/1:Py2/2;     [Count Spells Before Combat Defender Hero]
!!SN:W^Defender_Eagle_Eye_Spells^/?y11;
!!if&y51<y11;
!!VRy11:-y51;
!!VRy11:S1;
!!HEy2&y11=1:Fd/d/d1/d;                 [give appropriate bonus]
!!HEy2&y11=2:Fd/d/d2/d;                 [give appropriate bonus]
!!HEy2&y11=3:Fd/d/d3/d;                 [give appropriate bonus]
!!HEy2&y11=4:Fd/d/d4/d;                 [give appropriate bonus]
!!HEy2&y11=5:Fd/d/d5/d;                 [give appropriate bonus]
!!HEy2&y11=6:Fd/d/d6/d;                 [give appropriate bonus]
!!HEy2&y11=7:Fd/d/d7/d;                 [give appropriate bonus]
!!HEy2:B0/?z-10;                        [get hero name]

!!SN:T^AC_Misc.Eagle Eye Set^/?z-9 Iz-9/?z-9;
!!HEy2:O?y3;                            [get owner of this hero]
!!OW&y3<>-1:Iy3/?y4;                    [get AI (1) or human (0)]
!!VRy5:S0;                              [assume AI]
!!VRy5&y3<>-1/y4=0:S1;                  [human if has owner and that owner is human]
!!IF&y5=1:Q2/33/y11/1/z-9;              [If Bonus Show Picture]
!!en;
!!en;
!!en;
!!en;

!!SN:W^Attacker_Eagle_Eye_Spells^/0;    [Reset Spell Count]
!!SN:W^Defender_Eagle_Eye_Spells^/0;


****Ring of the Magi Set Bonus Attacker
!!HEy1:O?y9;                            [get owner of this hero]
!!SN:W^Hero_Attacker_Owner0^/?y5;
!!HEy1:A2/139/?y10/?y11;                [Check for Ring of the Magi]
!!HEy1:E?y6/?y7/1;                      [get level of this hero]
!!SN&y11=1/y5=y9:W^Magi_Set_Count_Hero%Y1^/?y8; [Check Value Att]
!!SN&y11=1/y5=y9/y8<y7:W^Magi_Set_Count_Hero%Y1^/d+1; [+1% Spell Damage if Battle won with Ring equipped Att  New Capped at Hero Level]


****Cornucopia Set Bonus Attacker
!!HEy1:A2/140/?y10/?y11;                [Check for Cornucopia]
!!if&y11=1;                            [Give Set Bonus if equipped]
!!HEy1:O?y3;                            [get owner of this hero]
!!HEy1:E?y6/?y7/1;                      [get level of this hero]

!!VRy7::10 +1;
!!VRy10:S0R6;
!!VRy11&y10<6:S0R3 +y7;
!!VRy11&y10=6:Sy7*500+1000R1500;
!!OW:Ry3/y10/dy11;

!!HEy1:B0/?z-10;                        [get hero name]
!!SN:T^AC_Misc.Cornucopia Set^/?z-9 Iz-9/?z-9;
!!OW&y3<>-1:Iy3/?y4;                    [get AI (1) or human (0)]
!!VRy5:S0;                              [assume AI]
!!VRy5&y3<>-1/y4=0:S1;                  [human if has owner and that owner is human]
!!IF&y5=1/999:Q2/y10/y11/1/z-9;         [If Bonus Show Picture]
!!UN:R2;
!!en;


****Ring of the Magi Set Bonus Defender
!!BA:H1/?y4;
!!if&y4<>-2;
!!HEy4:A2/139/?y10/?y11;                [Check for Ring of the Magi Defender]
!!SN:W^Hero_Defender_Owner0^/?y20;
!!HEy4:E?y6/?y7/1;                      [get level of this hero]
!!SN&y11=1/y5=y9:W^Magi_Set_Count_Hero%Y4^/?y8; [Check Value Att]
!!SN&y11=1/y20=y2/y8<y7:W^Magi_Set_Count_Hero%Y4^/d+1; [+1% Spell Damage if Battle won with Ring equipped Def]


****Cornucopia Set Bonus Defender
!!HEy4:A2/140/?y10/?y11;                [Check for Cornucopia]
!!if&y11=1;                             [Give Set Bonus if equipped]
!!HEy4:O?y3;                            [get owner of this hero]
!!HEy4:E?y6/?y7/1;                      [get level of this hero]

!!VRy7::10 +1;
!!VRy10:S0R6;
!!VRy11&y10<6:S0R3 +y7;
!!VRy11&y10=6:Sy7*500+1000R1500;
!!OW:Ry3/y10/dy11;

!!HEy4:B0/?z-10;                        [get hero name]
!!SN:T^AC_Misc.Cornucopia Set^/?z-9 Iz-9/?z-9;
!!OW&y3<>-1:Iy3/?y4;                    [get AI (1) or human (0)]
!!VRy5:S0;                              [assume AI]
!!VRy5&y3<>-1/y4=0:S1;                  [human if has owner and that owner is human]
!!IF&y5=1/999:Q2/y10/y11/1/z-9;         [If Bonus Show Picture]
!!UN:R2;
!!en;
!!en;


********************************************************************************
!?FU(OnAfterBattleUniversal)&1000;      [at end of battle]
!!BA:H0/?y2;                            [Attacking Hero]
!!FU&y2<0:E;                            [exit if no active hero]

!!HEy2:O?y1;                            [get owner of this hero]
!!SN:W^Hero_Attacker_Owner0^/?y5;
!!FU&y1=-1/y5<>y1:E;                    [Exit if no Owner or not the same as before the fight]

!!HEy2:E?y3/?y4/1;
!!HEy2:B0/?z-10;
!!FU(Count_Set_Pieces):Py2/0/0/?y92;    [Count Set Pieces function for Books]

!!if&y92=4;
  !!VRy3&y3>=15000000:S15000000;        [Fix for Var overflow]
  !!VRy5:Sy3;
  !!VRy5:*120:100 -y3;
  !!VRy5::100 *5 +1000;
  !!SN:T^AC_Misc.Elemental Set^/?z-9 Iz-9/?z-9;
  !!IF&999:Q1/17/y5/1/z-9;
  !!HEy2:Edy5;                          [Give Experience]
!!en;

!!FU(Count_Set_Pieces_2):Py2/?y93;      [Count Set Pieces function Battle Mage]
!!if&y93=5;
  !!VRy10:S0R100;
  !!if&y10<30;                          [30% Chance]
    !!VRy5:S31R3;
    !!SN:T^AC_Misc.Battle Mages Set^/?z-9 Iz-9/?z-9;
    !!IF&999:Q1/y5/1/1/z-9;
    !!HEy2&y5=31:Fd1/d/d/d;             [give appropriate bonus]
    !!HEy2&y5=32:Fd/d1/d/d;             [give appropriate bonus]
    !!HEy2&y5=33:Fd/d/d1/d;             [give appropriate bonus]
    !!HEy2&y5=34:Fd/d/d/d1;             [give appropriate bonus]
  !!en;
!!en;


******************[Improved Spell Handling Section]*****************************
!?BG0&1000;

!!BG:H?y3;                              [Determine if AI controlls Hero]
!!HEy3:O?y3;
!!OW:Iy3/?y3;
!!FU&y3=1:E;                            [Exit if AI]

!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>1:E;

!!BG:S?y2;                              [Falls Aktion ein Cast ist dann Speichere Spellnummer in y2]
!!FU&y2<=9|y2>69:E;

!!BG:H?y3;
!!if&y3>=0;

!!if&y2=38;
!!FU(Count_Set_Pieces):P-1/0/0/0/0/0/?y95; [Count Set Pieces function]
!!if&y95>=5;                            [If hero wears 5 Priest of the Light Set pieces + 50% Bonus to Resurrection]
!!SN:W^Spell_Change_Flag^/1;
!!SSy2:P?y5;
!!SN:W^Priest_Set_Bonus_Res^/y5;
!!VRy5:*3:2;                            [*+50% Bonus]
!!SSy2:Py5;
!!en;
!!en;

!!if&y2=39;
!!FU(Count_Set_Pieces):P-1/0/0/0/0/0/0/?y96; [Count Set Pieces function]
!!if&y96>=5;                            [If hero wears 5 Priest of the Dark Set pieces + 50% Bonus to Raise Dead]
!!SN:W^Spell_Change_Flag^/1;
!!SSy2:P?y5;
!!SN:W^Dark_Priest_Set_Bonus_Res^/y5;
!!VRy5:*3:2;                            [*+50% Bonus]
!!SSy2:Py5;
!!en;
!!en;

!!if&y2=36;
!!FU(Count_Set_Pieces):P-1/0/0/0/0/0/0/0/0/?y97; [Count Set Pieces function]
!!if&y97=3;                             [If hero wears 3 Resistance Set pieces Set Mass Magic Mirror]
!!SN:W^Spell_Change_Flag^/1;
!!SSy2:F?i;
!!VRi:&-17;                             [remove single target flag]
!!VRi:|64;                              [0x00000040 - has mass version at expert level]
!!SSy2:Fi;
!!en;
!!en;

!!if&y2=48;
!!FU(Count_Set_Pieces):P-1/0/0/0/0/0/0/0/0/0/0/0/0/?y97; [Count Set Pieces function]
!!if&y97>=5;                            [If hero wears 5 Angelic Allinace Set pieces + 50% Bonus to Prayer]
!!SN:W^Spell_Change_Flag^/1;
!!HEy3:S16/?y50;                        [Check Water Magic Level]
!!SSy2:Ey50/?y5;
!!SN:W^Angelic_Alliance_Bonus_Res^/y5;
!!VRy5:+2;                              [*+2 Bonus to Prayer]
!!SSy2:Ey50/y5;
!!en;
!!en;

!!if&y2=43;
!!FU(Count_Set_Pieces_2):P-1/?y47;      [Count Set Pieces function]
!!if&y47>=4;                            [If hero wears 4 Battle Mage War Dress Set pieces + 50% Bonus to Bloodlust]
!!SN:W^Spell_Change_Flag^/1;
!!HEy3:S14/?y50;                        [Check Fire Magic Level]
!!SSy2:Ey50/?y5;
!!SN:W^Battle_Mage_War_Bonus^/y5;
!!VRy5:+4;                              [+4 Bonus to Bloodlust]
!!SSy2:Ey50/y5;
!!en;
!!en;

!!if&y2=53;                             [53  Haste]
  !!HEy3:A2/151/?y18/?y19;              [Check for Boots of Haste]
  !!if&y19=1;
    !!SN:W^Spell_Change_Flag^/1;
    !!HEy3:S15/?y50;                    [Check Air Magic Level]
    !!SSy2:Ey50/?y5;
    !!SN:W^Boots_of_Haste_Bonus^/y5;
    !!VRy5:+2;                          [+2 Bonus to Haste]
    !!SSy2:Ey50/y5;
  !!en;
!!en;

!!if&y2=27;                             [27  Shield]
  !!HEy3:A2/41/?y18/?y19;               [Check for 41 Dragonbone Greaves]
  !!if&y19=1;
    !!SN:W^Spell_Change_Flag^/1;
    !!HEy3:S17/?y50;                    [Check Earth Magic Level]
    !!SSy2:Ey50/?y5;
    !!SN:W^Dragonbone_Greaves_Bonus^/y5;
    !!VRy5:-5;                          [+5% Bonus to Shield]
    !!SSy2:Ey50/y5;
  !!en;
!!en;

!!if&y2=54;                             [54  Slow]
  !!HEy3:A2/56/?y18/?y19;               [Check for 56 Dead Man's Boots]
  !!if&y19=1;
    !!SN:W^Spell_Change_Flag^/1;
    !!HEy3:S17/?y50;                    [Check Earth Magic Level]
    !!SSy2:Ey50/?y5;
    !!SN:W^Dead_Man_Boots_Bonus^/y5;
    !!VRy5:-5;                          [+5% Bonus to Slow]
    !!SSy2:Ey50/y5;
  !!en;
!!en;

!!en;


!?BG1&1000;

!!SN:W^Spell_Change_Flag^/?y1;
!!FU&y1=0:E;

!!BG:S?y2;                              [Falls Aktion ein Cast ist dann Speichere Spellnummer in y2]
!!FU&y2<=9|y2>69:E;

!!BG:H?y3;
!!if&y3>=0;


!!if&y2=38;
!!SN:W^Spell_Change_Flag^/0;            [Reset Flag]
!!SN:W^Priest_Set_Bonus_Res^/?y5;
!!SSy2:P?y5;                            [Restore old Value]
!!VRy5::3*2;
!!SSy2:Py5;                             [Restore old Value]
!!en;

!!if&y2=39;
!!SN:W^Spell_Change_Flag^/0;
!!SN:W^Dark_Priest_Set_Bonus_Res^/?y5;
!!SSy2:P?y5;                            [Restore old Value]
!!VRy5::3*2;
!!SSy2:Py5;                             [Restore old Value]
!!en;

!!if&y2=36;
!!SN:W^Spell_Change_Flag^/0;
!!SN:W^Dark_Priest_Set_Bonus_Res^/?y5;
!!SSy2:F?i;
!!VRi:|17;                              [remove single target flag]
*!VRi:|64;  0x00000040 - has mass version at expert level
!!SSy2:Fi;
!!en;

!!if&y2=48;                            [*Prayer]
!!SN:W^Spell_Change_Flag^/0;
!!SN:W^Angelic_Alliance_Bonus_Res^/?y5;
!!HEy3:S16/?y50;                        [Check Water Magic Level]
!!SSy2:Ey50/?y5;                        [Restore old Value]
!!VRy5:-2;                              [-2 to Prayer]
!!SSy2:Ey50/y5;                         [Restore old Value]
!!en;

!!if&y2=43;                            [*Bloodlust]
!!SN:W^Spell_Change_Flag^/0;
!!SN:W^Battle_Mage_War_Bonus^/?y5;
!!HEy3:S14/?y50;                        [Check Fire Magic Level]
!!SSy2:Ey50/?y5;                        [Restore old Value]
!!VRy5:-4;                              [-4 to Bloodlust]
!!SSy2:Ey50/y5;                         [Restore old Value]
!!en;

!!if&y2=53;                             [*Haste]
!!SN:W^Spell_Change_Flag^/0;
!!SN:W^Boots_of_Haste_Bonus^/?y5;
!!HEy3:S15/?y50;                        [Check Fire Magic Level]
!!SSy2:Ey50/?y5;                        [Restore old Value]
!!VRy5:-2;                              [-2 to Haste]
!!SSy2:Ey50/y5;                         [Restore old Value]
!!en;

!!if&y2=27;                             [*Shield]
!!SN:W^Spell_Change_Flag^/0;
!!SN:W^Dragonbone_Greaves_Bonus^/?y5;
!!HEy3:S17/?y50;                        [Check Earth Magic Level]
!!SSy2:Ey50/?y5;
!!VRy5:+5;                              [+5% Bonus to Shield]
!!SSy2:Ey50/y5;                         [Restore old Value]
!!en;

!!if&y2=54;                             [*Slow]
!!SN:W^Spell_Change_Flag^/0;
!!SN:W^Dead_Man_Boots_Bonus^/?y5;
!!HEy3:S17/?y50;                        [Check Earth Magic Level]
!!SSy2:Ey50/?y5;
!!VRy5:+5;                              [+5% Bonus to Slow]
!!SSy2:Ey50/y5;                         [Restore old Value]
!!en;

!!en;


********************************************************************************
[Start of battle trigger]
!?FU(OnCombatRound)&v997=0/1000;        [Prebuff section, apply spells to creatures]
*!SN:W^Battle_Start_Set_Flag^/1;
!!BA:H0/?y98;
!!FU(Count_Set_Pieces):Py98/0/0/0/0/0/?y95/?y96/?y97/?y71/?y70; [Count Set Pieces function]
!!FU(Count_Set_Pieces_2):Py98/?y48;     [Count Set Pieces function]
!!DO(AC_Function_62)/0/20/1&y48=5:P;    [Pass ]
!!DO(AC_Function_48)/0/20/1&y95=6:P41/50/1; [Pass Bless if complete Priest of Light set equipped X1=Spell X2=Duration X3=Power]
!!DO(AC_Function_48)/21/41/1&y97=4:P71/2/1; [Pass Poison if complete Basilisk Venom Teeth set equipped]
!!DO(AC_Function_48)/21/41/1&y96=6:P42/50/1; [Pass Curse if complete Priest of Dark set equipped]
!!VRy50&y71=3:S30R3;
!!DO(AC_Function_48)/0/20/1&y71=3:Py50/50/1; [Pass Random Basic Protection if complete Resistance set equipped X1=Spell X2=Duration X3=Power]

!!if&y70=3;                             [Pegasus Harness Set]
!!SN:W^Speed_MonsterNumber^/0;
!!DO(AC_Function_49)/0/10/1:P;          [Function to recieve slowest unit in Army]
!!SN:W^Speed_MonsterNumber^/?y10;       [Monster Stack with slowest speed]
!!BMy10&y10>=0:S?y11;
!!VRy11:+5;                             [+5 Speed for slowest Unit]
!!BMy10&y10>=0:Sy11;
!!en;

!!BA:Q?f;
!!VRz-1&y97=4:S^POISON^;
!!SN&y97=4/f=0:Pz-1;                    [Play Poison Sound if not Quick Comabat]

!!BA:H1/?y99;
!!FU&y99<0:E;
!!FU(Count_Set_Pieces):Py99/0/0/0/0/0/?y95/?y96/?y97/?y98/?y75; [Count Set Pieces function]
!!DO(AC_Function_48)/21/41/1&y95=6:P41/50/1; [Pass Bless if complete Priest of Light set equipped X1=Spell X2=Duration X3=Power]
!!DO(AC_Function_48)/0/20/1&y96=6:P71/2/1; [Pass Poison if complete Basilisk Venom Teeth set equipped]
!!DO(AC_Function_48)/21/41/1&y97=4:P42/50/1; [Pass Curse if complete Priest of Light set equipped]
!!VRy50&y98=3:S30R3;
!!DO(AC_Function_48)/21/41/1&y98=3:Py50/50/1; [Pass Random Basic Protection if complete Resistance set equipped X1=Spell X2=Duration X3=Power]

!!if&y75=3;                             [Pegasus Harness Set]
!!SN:W^Speed_MonsterNumber^/0;
!!DO(AC_Function_49)/21/31/1:P;         [Function to recieve slowest unit in Army]
!!SN:W^Speed_MonsterNumber^/?y10;       [Monster Stack with slowest speed]
!!BMy10&y10>=0:S?y11;
!!VRy11:+5;                             [+5 Speed for slowest Unit]
!!BMy10&y10>=0:Sy11;
!!en;


**********
!?FU(AC_Function_48);

!!BMx16:T?y2;                           [Get Monstery Type]
!!FU|y2=146/y2=147/y2=148/y2=149:E;     [Exit for Warmachines or Towers]
!!BMx16:Mx1/x2/x3;                      [Apply Bonus Spell]

**********
!?FU(AC_Function_62);                   [Determine slowest unit fct for Pegasus Harness Set Piece]

!!BMx16:T?y30; !!FU|y30=146/y30=147/y30=148/y30=149:E; [Exit for Warmachines or Towers]
!!if&y30>=0/y30<=196;
!!BMx16:Hd5;
!!en;

**********
!?FU(AC_Function_49);                   [Determine slowest unit fct for Pegasus Harness Set Piece]
!!BMx16:S?y1;
!!BMx16:T?y30;
!!FU|y30=146/y30=147/y30=148/y30=149:E; [Exit for Warmachines or Towers]
!!if&y30>=0/y30<=196;
!!VRy11:Sx16;

!!if&y1>1;
!!VRy2:S0;
!!SN:W^Speed_Monster%X16^/y1;

!!VRy11:-1;
!!SN&y11>=0:W^Speed_Monster%Y11^/?y2;
!!if&y1<=y2;
!!SN:W^Speed_MonsterNumber^/?y20;
!!BMy20:S?y1;
!!BMx16:S?y2;
!!SN&y2<y1:W^Speed_MonsterNumber^/x16;
!!en;
!!en;
!!en;


********************************************************************************


****************************Wizards Knowledge***************************************
!?BG1&1000;                             [1 extra cast per combat for Wizards Knowledge]

!!BG:Q?y1;                              [Fix for Double Cast]
!!SN&y1=0:W^Double_Cast_Attacker^/?y4;  [Current attacking side]
!!SN&y1=1:W^Double_Cast_Defender^/?y4;
!!SN&y1=0:W^Magic_Week_34_att^/?y2;
!!SN&y1=1:W^Magic_Week_34_def^/?y2;
!!SN&y1=0:W^Magic_Week_41_att^/?y3;
!!SN&y1=1:W^Magic_Week_41_def^/?y3;
!!SN:W^Magic_Week_Spell_Element^/?y5;
!!SN&y1=0:W^Master_Mage_Extra_Cast_att^/?y7;
!!SN&y1=1:W^Master_Mage_Extra_Cast_def^/?y7;
!!SN&y1=0:W^Special_Hero_Extra_Cast_Att^/?y8;
!!SN&y1=1:W^Special_Hero_Extra_Cast_Def^/?y8;

!!if&y4=0/y2=0/y3=0/y5=0/y7=0;         [fix with Double Cast mod and Magic Week 34,41 37,38,39,40]
!!SN&y1=0:W^Elemental_Set_att^/?y2;
!!SN&y1=1:W^Elemental_Set_def^/?y2;
!!FU&y2=0:E;
!!BHy1:M?y3;
!!FU&y3=0:E;
!!BHy1:M0;

!!SN&y1=0:W^Magic_Specialists_%V997_Cast_Count_Att^/d1;
!!SN&y1=1:W^Magic_Specialists_%V997_Cast_Count_Def^/d1;

!!BA:Q?f;
!!VRz-1:S^LUCK^;
!!SN&i^battle_isVisible^:Pz-1;
!!SN:T^AC_Misc.Elemental Sets Extra^/?z-1;
!!BU&i^battle_isVisible^:Mz-1;
!!SN&y1=0:W^Elemental_Set_att^/0;
!!SN&y1=1:W^Elemental_Set_def^/0;
!!en;
********************************************************************************
*?BG1&1000;                                                                     [The Champion's Honor Set After Moral re-enable Spell Book]

*!BG:Q?y1;                                                                      [Current attacking side]
*!SN&y1=0:W^Moral_Count_Att^/?y2;
*!SN&y1=1:W^Moral_Count_Def^/?y2;
*!FU&y2=0:E;
*!BHy1:M?y3;
*!FU&y3=0:E;
*!BHy1:M0;
*!VRz1:S^GOODMRLE^;
*!SN:P1;
*!SN&y1=0:W^Moral_Count_Att^/0;
*!SN&y1=1:W^Moral_Count_Def^/0;

********************************************************************************
*?BR&1000;

*!SN:W^Moral_Count_Att^/0;                                                      [Moral Count Attacker reset]
*!SN:W^Moral_Count_Def^/0;                                                      [Moral Count Attacker reset]

********************************************************************************
!?BR&1000/v997<>-1;                     [Reduce Luck and Moral Wizard Set Bonus]
!!FU:E;                                 [replaced code]
!!BA:Q?f;
!!FU&f=1:E;
!!FU(AC_Function_56):P;

!?BG1&1000;
!!FU:E;                                 [replaced code]
!!BA:Q?f;
!!FU&f=1:E;
!!FU(AC_Function_56):P;

!?FU(AC_Function_56);

!!BH0:N?y1;                             [Attacker]
!!FU(Count_Set_Pieces):Py1/?y90/?y91/?y92/?y93/?y94; [Count Set Pieces function]

!!DO(AC_Function_50)/21/41/1&y93>=2:P;  [Moral Set]
!!DO(AC_Function_51)/21/41/1&y93>=3:P;

!!DO(AC_Function_51)/21/41/1&y94>=2:P;  [Luck Set]
!!DO(AC_Function_50)/21/41/1&y94>=3:P;

!!BH1:N?y2;                             [Defender]
!!FU&y2<0:E;
!!FU(Count_Set_Pieces):Py2/?y90/?y91/?y92/?y93/?y94; [Count Set Pieces function]

!!DO(AC_Function_50)/0/20/1&y93>=2:P;
!!DO(AC_Function_51)/0/20/1&y93>=3:P;

!!DO(AC_Function_51)/0/20/1&y94>=2:P;
!!DO(AC_Function_50)/0/20/1&y94>=3:P;

!?FU(AC_Function_51);
!!BMx16:F?y1 N?y3;                      [read flags]
!!VRy1:&16;                             [just look at alive]
!!if&y3>0/y1>0;                         [Exit if no stack or has no morale Flag]
  !!BMx16:G212/?y2/?t;                  [212 Moral]
  !!VRy2:-1;                            [add negative morale to current morale]
  !!VRy2&y2<=-3:S-3;                    [Cannot be more than -3 Morale]
  !!VRy2&y2>=5:S5;                      [Cannot be more than +5 Morale]
  !!BMx16:G212/y2/?t;                   [212 Moral]  
!!en;

!?FU(AC_Function_50);
!!BMx16:N?y3;                           [Get number]                          
!!if&y3>0;                              [Exit if no stack or has no morale Flag]
  !!BMx16:G213/?y2/?t;                  [213 Luck]
  !!VRy2:-1;                            [add negative Luck to current Luck]
  !!VRy2&y2<=-3:S-3;                    [Cannot be more than -3 Luck]
  !!BMx16:G213/y2/?t;                   [213 Luck]  
!!en;

********************************************************************************
Show Bonus Table when clicking on Experience Icon in Hero Screen

!?CM2&1000;                             [Trigger for showing crit chance in hero screen]

!!CM:S?y1 T?y2 I?y3;
!!FU|y1<>14/y2<>512/y3<>119:E;          [When rightclick on Knowledge Icon show Bonus list]
!!CM:R0;

!!FU(ACM_OpenBonusTable):P;

!?FU(ACM_OpenBonusTable);
!!DL89:N^ACMList.txt^;

!!HE-1:N?y4;                            [Get current hero number]
!!SN:W^ACM_Commander_Hero_ID^/y4;       [save hero ID for later]

!!FU(Calc_Magic_Strength):Py4/?y61;     [Get current Magic Strength]

!!FU(H3_Calc_Normal_Spell_Damage):Py4/?y98/?y97/0/0/1; [Pass Hero Number and Give Back Normal Damage in y98 and Extra Damage Option in y97]
!!HEy4:S25/?y1;                         [25 Sorcery]
!!VRy98&y1=1:+10; !!VRy98&y1=2:+20; !!VRy98&y1=3:+30; [Add Sorcery damage bonus to value in list]
!!SN:W^H3_Sorcery_0_Hero%Y4^/?y1; !!VRy98&y1=1:+10;
!!SN:W^H3_Sorcery_1_Hero%Y4^/?y1; !!VRy98&y1=1:+10; 
!!FU(H3_Calc_Crit_Chance_and_Damage):Py4/?y16/?y99/0; [IF 1 at the end it means to in fight 0 means only check]

!!VRy16&y16>=100:S100;                  [Cap Chance at 100%]

!!FU(Count_Set_Pieces_2):Py4/0/0/?y91/?y90/?y92; [Check for  Sets]

!!VRy10:S0;
!!VRy11:S0;
!!VRy12:S0;
!!VRy15:S0;                             [Growth Bonus from Adventurer]

!!HEy4:A2/133/?y50/?y51;
!!VRy15&y51=1:S3;

!!SN&y90=3:W^Warrior_Set_Count_Hero%Y4^/?y10;
!!SN&y91=3:W^Mage_Set_Count_Hero%Y4^/?y11;
!!SN&y92=3:W^Adventurer_Set_Count_Hero%Y4^/?y12;

!!SN:W^Master_Warrior_Hero%Y4^/?y19;
!!SN:W^Master_Mage_Hero%Y4^/?y23;
!!SN:W^Master_Adventurer_Hero%Y4^/?y24;
!!SN:W^Grandmaster_Warrior_Hero%Y4^/?y20;
!!SN:W^Grandmaster_Mage_Hero%Y4^/?y21;
!!SN:W^Grandmaster_Adventurer_Hero%Y4^/?y22;

!!VRy10::3;                             [Bonus from Warrior set is +1crit chance/damage per 3 fights won]
!!VRy11::2;                             [+1% spell crit chance and damage per 2 levels]
!!VRy12::20;                            [+1% Growth per 20 level]
!!VRy15&y22=1:+3;                       [+5% creature growth]
!!VRy15:+y12;                           [+Creature Growth Chance from Set]

!!FU(ACM_Calc_Physical_Crit):Py4/?y13/?y14; [Pass Hero and return crit damage and crit chance]

!!SN:W^Hero_%Y4_Fights_Won^/?y38;       [Fights won]
!!SN:W^Hero_%Y4_Heroes_Killed^/?y39;    [Enemies killed]
!!SN:W^Damage_Counter_Hero_%Y4^/?y40;   [Increase damage counter]
!!SN:W^Magic_Damage_Counter_Hero_%Y4^/?y41; [Increase damage counter]
!!SN:W^Commander_Kill_Counter_%Y4^/?y42;[Get commander kill counter from hero]
!!VRy48:Sy42:2; !!VRy49:Sy42:2;         [Set to halv kill bonus to apply correct bonus]

!!FU(Spell_Trainer_Calc):Py4/?y95/?y96; [Pass Hero Number and return Number of Spell Upgrades and Chance for Spell Upgrade]

!!VRv7020:Sy4;                          [Set var to current hero ID]
!!FU(acm_Hero_GetArtilleryMinMaxDamage):Py4/?y58/?y59;
!!SN:W^Artillery_Low_Damage_Hero%Y4^/?y58; [Save Low Damage to display it in Bonus List]
!!SN:W^Artillery_High_Damage_Hero%Y4^/?y59; [Save High Damage to display it in Bonus List]

!!FU(Magic_Artillery_Shoot1):P0/y4/1;
!!SN:W^EagleEye_Low_Damage_Hero%Y4^/?y62;[Save Low Damage to display it in Bonus List]
!!SN:W^EagleEye_High_Damage_Hero%Y4^/?y63; [Save High Damage to display it in Bonus List]

!!FU(Improved_FirstAid_Bonus):P1/0/1;
!!SN:W^Heal_After_Fight_Low_Hero%Y4^/?y64; [Save Low Damage to display it in Bonus List]
!!SN:W^Heal_After_Fight_High_Hero%Y4^/?y65; [Save High Damage to display it in Bonus List]

!!HEy4:S27/?y80;
!!FU(AC_Function_35):P0/y80/1/1/y4;     [Pass hero]
!!SN:W^Heal_InCombat_Low_Hero%Y4^/?y66; [Save Low Heal to display it in Bonus List]
!!SN:W^Heal_InCombat_High_Hero%Y4^/?y67;[Save High Heal to display it in Bonus List]
!!VRy66&y66=0:S20; !!VRy67&y67=0:S40;

!!SN:W^Tent_Capacity_Att_Hero%Y4^/?y68;
!!SN:W^Scouting_Event_Chance_%Y4^/?y69; [save scouting chance]
!!VRy69&y69=0:S99999999;
!!VRe1:S17:y69*100;


!!HEy4:E?y90/?y91/1;                    [Get Hero level]
!!HEy4:A2/31/?y30/?y81;                 [31  Armor of Wonder]
!!HEy4:A2/25/?y30/?y82;                 [25  Breastplate of Petrified Wood]
!!HEy4:A2/163/?y30/?y83;                [163 Round Shield of Commander]
!!HEy4:A2/37/?y30/?y84;                 [37 Quiet Eye of the Dragon] !!VRy72:S0; !!VRy72&y84=1:+50; [Magic damage]
!!HEy4:A2/39/?y30/?y84;                 [39 Dragon Scale Shield] !!VRy72&y84=1:+50; [Magic damage]
!!HEy4:A2/43/?y30/?y84;                 [43 Necklace of Dragonteeth] !!VRy72&y84=1:+50; [Magic damage]
!!HEy4:A2/97/?y30/?y86;                 [97 Necklace of Swiftness]
!!HEy4:A2/69/?y30/?y87;                 [69 Ring of the Wayfarer]
!!HEy4:A2/99/?y30/?y88;                 [99 Cape of Velocity]
!!HEy4:A2/38/?y30/?y89;                 [38 Red Dragon Flame Tongue]
!!HEy4:A2/81/?y30/?y90;                 [81 Orb of Tempestuous Fire]
!!HEy4:A2/9/?y30/?y92;                  [9 Greater Gnoll's Flail]
!!HEy4:A2/8/?y30/?y93;                  [8 Blackshard of the Dead Knight]
!!HEy4:A2/60/?y30/?y94;                 [60 Bow of Elven Cherrywood]
!!HEy4:A2/141/?y30/?y31 A2/150/?y30/?y32;[141 Magic Wand 150 Pendant of Sorcery]

!!VRy92:Sy91*4;                         [4 times hero level flat damage block for Druid]

!!VRy70:S0; !!VRy70&y81=1:Sy91*2+5; !!VRy70&y83=1:+50; !!VRy70&y23=1/y24=1:+y92; [Range damage]
!!VRy71:S0; !!VRy71&y82=1:Sy91*2; !!VRy71&y83=1:+50; !!VRy71&y23=1/y24=1:+y92; [Melee damage]
!!VRy73:S0; !!VRy73&y86=1:+4; !!VRy73&y87=1:+4; !!VRy73&y86=1/y87=1/y88=1:S15; [Evade]
!!VRy75:S0; !!VRy75&y89=1:Sy91*2+5; !!VRy75&y90=1:*2; [Fire Damage, double with Orb]
!!VRy79:S0; !!VRy79&y89=1:Sy91*2+105; !!VRy79&y90=1:*2; [Fire Damage, double with Orb]
!!VRy76:S0; !!VRy76&y92=1:Sy91*2+30;    [Damage VS Undeads]
!!VRy77:S0; !!VRy77&y93=1:Sy91*2+25;    [Damage VS living units]
!!VRy78:S0; !!VRy78&y94=1:Sy91*4;       [Range damage]

!!FU(ACM_Calc_Magic_Pierce):Py4/?y74;   [Pass hero number and return magic pierce value]

!!COy4:T?y50 N?z10;                     [Get commander type and name]
!!VRy51:S0;
!!COy4:S4/?y43;                         [Get Magic Level of Commander]
!!COy4:X2/?y44;                         [Get Commander Level]

!!SN:T^AC_Misc.Commander_Opt_No_Class^/?z31;
!!VRy90:S100; !!VRy91:S100; !!VRy92:S100; !!VRy93:S100;
!!VRy20:S100; !!VRy21:S100; !!VRy22:S100; !!VRy23:S100;
!!VRy86:S0; !!VRy87:S5;

!!FU(Check_Com_Masteries):Py4/?y25/?y42/?y97/?y1/?y90/?y91/?y92/?y93/?y20/?y21/?y22/?y23/?y24; [Get commander class modifier from function]
!!SN&y1<>0:T^AC_Misc.Commander_Opt_%Y1^/?z31; [select correct text from string]
!!VRy17:Sy97:2;                         [For Mastery you need 50% of max kills]
!!VRy17&y1=29:S100;                     [Show correct value for Ancient commander]
!!FU(ACM_Calc_Commander_Magic_Resistance):Py4/?y86/?y87; [Get value of Magic Resistance Dwarf and Golem type]

!!VRy2&y50=2:S17;                       [Temple Guardian set to Spell ID 17]
!!VRy2&y50=5:S15;                       [Brute set to Spell ID 15]
!!VRy2&y50=3:S21;                       [Succubus set to Spell ID 21]
!!FU(ACM_Calc_Commander_Spell_damage):Py4/?y51/y2/0; [Pass Hero Number and return spell damage in y51, Pass Spell Number and Battle State 1=In Fight, 0=No Fight]

****************************************************************************************************
!!if&y50=0;                             [If Paladin]
  !!SN:T^AC_Misc.Bonus_Table_Paladin^/?z4;
  !!VRy52:Sy44*5+200*y22:100;           [Converts damage to Exp]
  !!VRy54:Sy21-100:4;                   [Convert Spell Modifier to 25% effectiveness, so a +140% would mean +10% increased chance for the heal spell to work]
!!en;

!!if&y50=1;                             [If Hierophant]
  !!SN:T^AC_Misc.Bonus_Table_Hierophant^/?z4;
  !!VRy52:Sy44*15*y22:100;              [Tent Health Bonus]
  !!VRy53:Sy44*5*y22:100;               [Bonus heal from commander]
  !!VRy54:Sy44*30*y22:100;              [Bonus heal capacity from commander]
  !!VRy55:Sy44*y43*2+50*y21:100;        [Shield Power + Spell Modifier]
!!en;

!!if&y50=2;                             [If TempleGuardian]
  !!SN:T^AC_Misc.Bonus_Table_TempleGuardian^/?z4;
  !!VRy52&y44<20:S2; !!VRy52&y44>=20:S3; !!VRy52&y44>=35:S4; !!VRy52&y44>=50:S6; [Mana restored with attacks]
  !!VRy52:*y22:100;                     [Add passive modifier]
!!en;

!!if&y50=3;                             [If Succubus]
  !!SN:T^AC_Misc.Bonus_Table_Succubus^/?z4;
  !!SN:W^Succubus_Charm_Value_%Y4^/?y52;[Save the value to show it in bonus list Succubus life +75*Level times the hit points of Succubus]
!!en;

!!if&y50=5;                             [If Brute]
  !!SN:T^AC_Misc.Bonus_Table_Brute^/?z4;
  !!VRy52:S80*y22:100;                  [Add passive modifier]
!!en;

!!if&y50=4;                             [If SoulEater]
  !!SN:T^AC_Misc.Bonus_Table_SoulEater^/?z4;  
  !!VRy52:S20*y22:100;                  [Rais skellis is 20% Add passive modifier]
  !!FU(Calc_Soul_Eater_Animate_Amount):Py4/?y54; [Get Heal Amount]
!!en;

!!if&y50=6;                             [If OgreLeader]
  !!SN:T^AC_Misc.Bonus_Table_OgreLeader^/?z4;
  !!VRy52:Sy44*10*y22:100;              [Ballista Health Bonus]
  !!VRy53:Sy44:6*y22:100;               [Ballista damage bonus]
  !!VRy54:Sy44*y43*3+50*y21:100;        [Bloodlust Power + Spell Modifier]
!!en;

!!if&y50=7;                             [If Shaman]
  !!SN:T^AC_Misc.Bonus_Table_Shaman^/?z4;
  !!VRy53:S25*y22:100+100;              [Base the increase of Hero parameters is 125% that value gets modified by passive]
  !!VRy52:Sy44:2+40*y22:100;            [Chance to crush Com_Level/2+40%]
  !!VRy54:S0; !!VRy54&y21>=125:S1; !!VRy54&y21>=175:S2; !!VRy54&y21>=250:S3; !!VRy54&y21>=350:S4; !!VRy54&y21>=500:S5; [Set Speed Bonus]
!!en;

!!if&y50=8;                             [If AstralSpirit]
  !!SN:T^AC_Misc.Bonus_Table_AstralSpirit^/?z4;
  !!VRy83:Sy22:15-6;                    [+1% reduce per 15% passive modifier]
  !!VRy82:Sy44:4;                       [1% per 4 level]
  !!VRy52:S5+y83+y82;                   [Set Amount by which to reduce enemy damage and HP and multiply by passive modifier]
  !!FU(Astral_Spirit_Calc_Air_Element):Py44/y43/y21/?y54/0/0/y4; [Pass values and return Health and Damage of Element]
!!en;

!!SN:Iz4/?z4;

!!HEy4:O?y29;                           [Get current Hero Owner]
!!SN:W^Total_Scouting_Gold_%Y4^/?y30;   [gained gold from Scouting Skill]
!!SN:W^Total_Brut_Com_Gold_%Y4^/?y31;   [gained gold from Brute Commanders]
!!SN:W^Total_Battle_Com_Gold_%Y4^/?y32; [gained gold from Battle Commanders]
!!SN:W^Total_Treatment_Gold_%Y4^/?y33;  [gained gold from treatment upgrade]
!!SN:W^Total_Goblin_Gold_%Y4^/?y34;     [gained gold from goblin upgrade]
!!SN:W^Total_Estate_Gold_%Y4^/?y35;     [gained gold from Estate skill]

!!SN:T^AC_Misc.Bonus_Table_Magic^/?z1; !!SN:Iz1/?z1;
!!SN:T^AC_Misc.Bonus_Table_Battle^/?z2; !!SN:Iz2/?z2;
!!SN:T^AC_Misc.Bonus_Table_Skills^/?z3; !!SN:Iz3/?z3;
!!SN:T^AC_Misc.Bonus_Table_Header^/?z5; !!SN:Iz5/?z5;
!!SN:T^AC_Misc.Bonus_Table_Artifacts^/?z6; !!SN:Iz6/?z6;
!!SN:T^AC_Misc.Bonus_Table_Class_Sets^/?z7; !!SN:Iz7/?z7;
!!SN:T^AC_Misc.Bonus_Table_Commander_Class^/?z8; !!SN:Iz8/?z8;
!!VRz30:S^^;
!!VRz30&y24>=0:S^+^;
!!SN:T^AC_Misc.Bonus_Table_Commander_ClassII^/?z9; !!SN:Iz9/?z9;
!!SN:T^AC_Misc.Bonus_Table_Income^/?z15; !!SN:Iz15/?z15;

!!FU(Set_Com_Battle_Description):Py1/y4/y42/y22/y25/5/0/0/?t/2;
x1=commader class (1-29), x2=hero ID, x3=kill count, x4=passive mod, x5=Mastery, x6=speed, x7=Side
!!VRz11&y1=0:S^^;                       [set empty if no class]

!!DL89:A1/3/z1/1;
!!DL89:A2/3/z2/1;
!!DL89:A3/3/z3/1;
!!DL89:A4/3/z4/1;
!!DL89:A5/3/z5/1;
!!DL89:A6/3/z6/1;
!!DL89:A7/3/z7/1;
!!DL89:A8/3/z8/1;
!!DL89:A9/3/z9/1;
!!DL89:A10/3/z11/1;                     [Set text about special ability from new commander classes]
!!DL89:A50/3/z15/1;
!!DL89:A31/3/z31/1;

!!DL89:S1;                              [Show complete Dialogue number 89]


!?DL&v998=89;                           [When Right-Click on red commander text field]
!!FU&i^mouse_item^<>31/i^mouse_item^<>8/i^mouse_item^<>9/i^mouse_item^<>10:E; [Archer: Extended the clickable area so it's more comfortable to click]
!!FU&i^mouse_action^<>(MOUSE_LMB_PRESSED)/i^mouse_action^<>(MOUSE_RMB_PRESSED):E; [Left or right for different features]

!!SN:W^ACM_Commander_Hero_ID^/?y4; 

; Archer30: Left - Archmage and Warden only, change their spells
!!if&i^mouse_action^=(MOUSE_LMB_PRESSED);
  !!FU(Check_Com_Masteries):Py4/?t/?t/?t/?y13; [Pass Hero Number and return commander class]

  !!if|y13=(ACM_CMD_CLASS_ARCHMAGE)/y13=(ACM_CMD_CLASS_WARDEN);
    !!FU(ACM_Select_Com_Spell):Py4/0; [pass hero ID and combat battle status and spell]

    ; Update spell displayed
    !!SN:H^spell^/i^acm_cmdSpell_%y4^/(SPELL_TEXT_NAME)/?z12;
    !!VRz30:S^
^;
    !!SN:T^AC_Misc.Com_Battle_Text_24^/?z11/^spell^/z12/^newLine^/z30;
    !!DL89:A10/3/z11/1;                 [Set text about special ability from new commander classes]

    ; Send the change to other players
    !!IP:D(ANY_PLAYER);
    !!IP:M^acm_cmdSpell_%y4^;
  !!en;

  !!FU:E;
!!en;

; Right- show info
!!DL275:N^Com_Class.txt^;               [parse dialogue]
!!SN:T^AC_Misc.Commander_Opt_Text^/?z1; !!VRy50:S0;

!!SN:W^Commander_Fighter_%Y4^/?y1; !!SN&y1=1:T^AC_Misc.Play_Com_Opt_1^/?z1; !!VRy50&y1=1:S1;      
!!SN:W^Commander_Ranger_%Y4^/?y1; !!SN&y1=1:T^AC_Misc.Play_Com_Opt_2^/?z1; !!VRy50&y1=1:S2;
!!SN:W^Commander_Defender_%Y4^/?y1; !!SN&y1=1:T^AC_Misc.Play_Com_Opt_3^/?z1; !!VRy50&y1=1:S3;
!!SN:W^Commander_Caster_%Y4^/?y1; !!SN&y1=1:T^AC_Misc.Play_Com_Opt_4^/?z1; !!VRy50&y1=1:S4;
!!SN:W^Commander_Supporter_%Y4^/?y1; !!SN&y1=1:T^AC_Misc.Play_Com_Opt_5^/?z1; !!VRy50&y1=1:S5;
!!SN:W^Commander_Leader_%Y4^/?y1; !!SN&y1=1:T^AC_Misc.Play_Com_Opt_6^/?z1; !!VRy50&y1=1:S6;
!!SN:W^Commander_Scout_%Y4^/?y1; !!SN&y1=1:T^AC_Misc.Play_Com_Opt_7^/?z1; !!VRy50&y1=1:S7;
!!SN:W^Commander_Undead_%Y4^/?y1; !!SN&y1=1T^AC_Misc.Play_Com_Opt_8^/?z1; !!VRy50&y1=1:S8;
!!SN:W^Commander_FireMage_%Y4^/?y1; !!SN&y1=1:T^AC_Misc.Play_Com_Opt_9^/?z1; !!VRy50&y1=1:S9;

!!SN:W^Commander_Dragonslayer_%Y4^/?y1; !!SN&y1=1:T^AC_Misc.Play_Com_Opt_11^/?z1; !!VRy50&y1=1:S11; 
!!SN:W^Commander_Sniper_%Y4^/?y1; !!SN&y1=1:T^AC_Misc.Play_Com_Opt_12^/?z1; !!VRy50&y1=1:S12;
!!SN:W^Commander_Retaliator_%Y4^/?y1; !!SN&y1=1:T^AC_Misc.Play_Com_Opt_13^/?z1; !!VRy50&y1=1:S13;
!!SN:W^Commander_ArchMage_%Y4^/?y1; !!SN&y1=1:T^AC_Misc.Play_Com_Opt_14^/?z1; !!VRy50&y1=1:S14;
!!SN:W^Commander_Constructor_%Y4^/?y1; !!SN&y1=1:T^AC_Misc.Play_Com_Opt_15^/?z1; !!VRy50&y1=1:S15;
!!SN:W^Commander_King_%Y4^/?y1; !!SN&y1=1:T^AC_Misc.Play_Com_Opt_16^/?z1; !!VRy50&y1=1:S16;
!!SN:W^Commander_Prospector_%Y4^/?y1; !!SN&y1=1:T^AC_Misc.Play_Com_Opt_17^/?z1; !!VRy50&y1=1:S17;
!!SN:W^Commander_Lich_%Y4^/?y1; !!SN&y1=1:T^AC_Misc.Play_Com_Opt_18^/?z1; !!VRy50&y1=1:S18;
!!SN:W^Commander_Vampire_%Y4^/?y1; !!SN&y1=1:T^AC_Misc.Play_Com_Opt_19^/?z1; !!VRy50&y1=1:S191;

!!SN:W^Commander_Paladin_%Y4^/?y1; !!SN&y1=1:T^AC_Misc.Play_Com_Opt_21^/?z1; !!VRy50&y1=1:S21;
!!SN:W^Commander_Marksmen_%Y4^/?y1; !!SN&y1=1:T^AC_Misc.Play_Com_Opt_22^/?z1; !!VRy50&y1=1:S22; 
!!SN:W^Commander_Avenger_%Y4^/?y1; !!SN&y1=1:T^AC_Misc.Play_Com_Opt_23^/?z1; !!VRy50&y1=1:S23;
!!SN:W^Commander_Warden_%Y4^/?y1; !!SN&y1=1:T^AC_Misc.Play_Com_Opt_24^/?z1; !!VRy50&y1=1:S24;
!!SN:W^Commander_Arcanist_%Y4^/?y1; !!SN&y1=1:T^AC_Misc.Play_Com_Opt_25^/?z1; !!VRy50&y1=1:S25;
!!SN:W^Commander_General_%Y4^/?y1; !!SN&y1=1:T^AC_Misc.Play_Com_Opt_26^/?z1; !!VRy50&y1=1:S26;
!!SN:W^Commander_Lancer_%Y4^/?y1; !!SN&y1=1:T^AC_Misc.Play_Com_Opt_27^/?z1; !!VRy50&y1=1:S27;
!!SN:W^Commander_Necromant_%Y4^/?y1; !!SN&y1=1:T^AC_Misc.Play_Com_Opt_28^/?z1; !!VRy50&y1=1:S28;
!!SN:W^Commander_Ancient_%Y4^/?y1; !!SN&y1=1:T^AC_Misc.Play_Com_Opt_29^/?z1; !!VRy50&y1=1:S29;

!!SN:T^AC_Misc.Commander_Opt_Text^/?z10;
!!SN:T^AC_Misc.Commander_Opt_Expl_Masteries^/?z11;
!!VRz12:S^%Z10
%Z11^;

!!if&z1=z10;
  !!IF:M0/(MSG_TYPE_POPUP)/^%Z12^; 
  !!FU:E;                          [If no class was selected so far show simple text and exit]
!!en;

!!FU(Check_Com_Masteries):P-1/0/0/0/?y40/?y90/?y91/?y92/?y93/?y20/?y21/?y22/?y23/?y24/y50/0; [Get commander class modifier from function]
!!FU(Check_Com_Masteries):P-1/0/0/0/?y40/?y86/?y87/d/d/d/d/d/d/d/y50/1; [Get commander class modifier from function]
!!SN:T^AC_Misc.Bonus_Table_Commander_Class^/?z2; !!SN:Iz2/?z2; [set text for 1st]
!!VRz30:S^^;
!!VRz30&y24>=0:S^+^;
!!SN:T^AC_Misc.Bonus_Table_Commander_ClassII^/?z3; !!SN:Iz3/?z3; [set text for 1st]
!!SN:T^AC_Misc.Commander_Opt_%Y50^/?z5;
!!SN:T^AC_Misc.Bonus_Table_Commander_ClassIII^/?z4; !!SN:Iz4/?z4; [set text for 1st]

!!FU(Set_Com_Battle_Description):Py50/y4/0/y22/0/5/0;
x1=commader class (1-29), x2=hero ID, x3=kill count, x4=passive mod, x5=Mastery, x6=speed, x7=Side

!!if&y40=29;
  !!SN:W^Commander_%Y4_Ancient_Fighter^/?y71; [get commander Mastery for Ancient commander based on his former class]
  !!SN:W^Commander_%Y4_Ancient_Ranger^/?y72;
  !!SN:W^Commander_%Y4_Ancient_Defender^/?y73;
  !!SN:W^Commander_%Y4_Ancient_Caster^/?y74;
  !!SN:W^Commander_%Y4_Ancient_Supporter^/?y75;
  !!SN:W^Commander_%Y4_Ancient_Leader^/?y76;
  !!SN:W^Commander_%Y4_Ancient_Scout^/?y77;
  !!SN:W^Commander_%Y4_Ancient_Undead^/?y78;
  !!SN:W^Commander_%Y4_Ancient_FireMage^/?y79;

  !!SN&y71=1:T^AC_Misc.Ancient_Fighter^/?z20; [get text for commander passive to show in Ancient commander text field]
  !!SN&y72=1:T^AC_Misc.Ancient_Ranger^/?z20;
  !!SN&y73=1:T^AC_Misc.Ancient_Defender^/?z20;
  !!SN&y74=1:T^AC_Misc.Ancient_Caster^/?z20;
  !!SN&y75=1:T^AC_Misc.Ancient_Supporter^/?z20;
  !!SN&y76=1:T^AC_Misc.Ancient_Leader^/?z20;
  !!SN&y77=1:T^AC_Misc.Ancient_Scout^/?z20;
  !!SN&y78=1:T^AC_Misc.Ancient_Undead^/?z20;
  !!SN&y79=1:T^AC_Misc.Ancient_FireMage^/?z20;
!!en;
!!SN:Iz1/?z1;

!!DL275:A1/3/z1/1; 
!!DL275:A2/3/z2/1;
!!DL275:A3/3/z3/1;
!!DL275:A4/3/z4/1;
!!DL275:A5/3/z11/1;
!!FU(DL_ShowPopup):P275;                [Show Popup DL]

!!if&y40=17;                            [If Prospector (former scout class) show additional message how many ressources were generated during fights]
  !!OW:C?y8;
  !!SN:W^Scout_Res_Player_%Y8_Res_0^/?y40; 
  !!SN:W^Scout_Res_Player_%Y8_Res_1^/?y41; 
  !!SN:W^Scout_Res_Player_%Y8_Res_2^/?y42; 
  !!SN:W^Scout_Res_Player_%Y8_Res_3^/?y43; 
  !!SN:W^Scout_Res_Player_%Y8_Res_4^/?y44; 
  !!SN:W^Scout_Res_Player_%Y8_Res_5^/?y45; 
  !!SN:W^Scout_Res_Player_%Y8_Res_6^/?y46; 
  !!SN:T^AC_Misc.Scout_Res_Generation^/?z1; !!SN:Iz1/?z1; [Interpolate String]
  !!IF:M0/4/^%Z1^;                      [show Text]
!!en;

!!if&y40=9;                             [If Fire Mage show damage calculation of Fireball attack]
  !!SN:T^AC_Misc.FireMage_Fireball_Text^/?z1; !!SN:Iz1/?z1; [Interpolate String]
  !!IF:M0/4/^%Z1^;                      [show Text]
!!en;


!?DL&v998=89/v999=4/v1000=14;           [When Right-Click on red commander text field]

!!DL181:N^BonusInfo.txt^;               [parse dialogue]
!!SN:W^ACM_Commander_Hero_ID^/?y4;
!!COy4:T?y50;                           [Get commander type and name]

!!if&y50=0;                             [If Paladin]
  !!SN:T^AC_Misc.Bonus_Name_Paladin^/?z2;
  !!SN:T^AC_Misc.Bonus_Passive_Paladin^/?z3;
  !!SN:T^AC_Misc.Bonus_Spell_Paladin^/?z4;
!!en;

!!if&y50=1;                             [If Hierophant]
  !!SN:T^AC_Misc.Bonus_Name_Hierophant^/?z2;
  !!SN:T^AC_Misc.Bonus_Passive_Hierophant^/?z3;
  !!SN:T^AC_Misc.Bonus_Spell_Hierophant^/?z4;
!!en;

!!if&y50=2;                             [If TempleGuardian]
  !!SN:T^AC_Misc.Bonus_Name_TempleGuardian^/?z2;
  !!SN:T^AC_Misc.Bonus_Passive_TempleGuardian^/?z3;
  !!SN:T^AC_Misc.Bonus_Spell_TempleGuardian^/?z4;                 
!!en;

!!if&y50=3;                             [If Succubus]
  !!SN:T^AC_Misc.Bonus_Name_Succubus^/?z2;
  !!SN:T^AC_Misc.Bonus_Passive_Succubus^/?z3;
  !!SN:T^AC_Misc.Bonus_Spell_Succubus^/?z4;
!!en;

!!if&y50=5;                             [If Brute]
  !!SN:T^AC_Misc.Bonus_Name_Brute^/?z2;
  !!SN:T^AC_Misc.Bonus_Passive_Brute^/?z3;
  !!SN:T^AC_Misc.Bonus_Spell_Brute^/?z4;
!!en;

!!if&y50=4;                             [If SoulEater]
  !!SN:T^AC_Misc.Bonus_Name_SoulEater^/?z2;
  !!SN:T^AC_Misc.Bonus_Passive_SoulEater^/?z3;
  !!SN:T^AC_Misc.Bonus_Spell_SoulEater^/?z4;
!!en;

!!if&y50=6;                             [If OgreLeader]
  !!SN:T^AC_Misc.Bonus_Name_OgreLeader^/?z2;
  !!SN:T^AC_Misc.Bonus_Passive_OgreLeader^/?z3;
  !!SN:T^AC_Misc.Bonus_Spell_OgreLeader^/?z4;
!!en;

!!if&y50=7;                             [If Shaman]
  !!SN:T^AC_Misc.Bonus_Name_Shaman^/?z2;
  !!SN:T^AC_Misc.Bonus_Passive_Shaman^/?z3;
  !!SN:T^AC_Misc.Bonus_Spell_Shaman^/?z4;
!!en;

!!if&y50=8;                             [If AstralSpirit]
  !!SN:T^AC_Misc.Bonus_Name_AstralSpirit^/?z2;
  !!SN:T^AC_Misc.Bonus_Passive_AstralSpirit^/?z3;
  !!SN:T^AC_Misc.Bonus_Spell_AstralSpirit^/?z4;
!!en;

!!DL181:A10/3/z2/1;
!!DL181:A11/3/z3/1;
!!DL181:A12/3/z4/1;
!!FU(DL_ShowPopup):P181;                [Show Popup DL]


!?DL&v998=89/v999=30722/v1000=13;       [When clicking on the close Button]
!!DL:C1;

!?FU(OnBeforeBattleUniversal);
!!IF:V761/1;

!?FU(OnAfterBattleUniversal);
!!IF:V761/0;


********************************************************************************
*Dragon Set*
!?AE1|v998=39/v998=40/v998=41/v998=42/v998=43/v998=44; Equip Artifact  !!FU&761:E;
!!FU(Count_Set_Pieces):P-1/?y90;        [Count Set Pieces function]

!!VRy90:+1;
!!HE-1&y90=3:Fd0/d0/d3/d3;              [With 3 Set pieces Increase spell power +3 wisdom +3]
!!HE-1&y90=4:Fd3/d0/d0/d0;              [With 4 Set pieces Increase attack +3]
!!HE-1&y90=5:Fd0/d3/d0/d0;              [With 5 Set pieces Increase defense +3]
!!HE-1&y90=6:Fd2/d2/d2/d2;              [With 6 Set pieces Increase all +2]

!?AE0|v998=39/v998=40/v998=41/v998=42/v998=43/v998=44; Unequip Artifact !!FU&761:E;
!!FU(Count_Set_Pieces):P-1/?y90;        [Count Set Pieces function]

!!VRy90:-1;
!!HE-1&y90=2:Fd0/d0/d-3/d-3;            [Without 3 Set pieces decrease spell power -3 wisdom -3]
!!HE-1&y90=3:Fd-3/d0/d0/d0;             [With 4 Set pieces Increase attack -3]
!!HE-1&y90=4:Fd0/d-3/d0/d0;             [With 5 Set pieces Increase defense -3]
!!HE-1&y90=5:Fd-2/d-2/d-2/d-2;          [With 6 Set pieces decrease all -2]


*---------------------------------
*Priest of the Light Set*
!?AE1|v998=103/v998=13/v998=22/v998=25/v998=9/v998=98; Equip Artifact !!FU&761:E;
!!FU(Count_Set_Pieces):P-1/?y90/?y91/?y92/?y93/?y94/?y95/?y96; [Count Set Pieces function]

!!VRy95:+1;
!!HE-1&y95=3:Fd0/d0/d2/d2;              [With 3 Set pieces Increase spell power +3 wisdom +3]
!!HE-1&y95=4:Fd0/d0/d0/d0;              [With 4 Set pieces Increase attack +0]
!!HE-1&y95=5:Fd1/d1/d1/d1;              [With 5 Set pieces Increase primary +1]
!!HE-1&y95=6:Fd4/d4/d4/d4;              [With 6 Set pieces Increase all +4]

!?AE0|v998=103/v998=13/v998=22/v998=25/v998=9/v998=98; Unequip Artifact   !!FU&761:E;
!!FU(Count_Set_Pieces):P-1/?y90/?y91/?y92/?y93/?y94/?y95/?y96; [Count Set Pieces function]

!!VRy95:-1;
!!HE-1&y95=2:Fd0/d0/d-2/d-2;            [Without 3 Set pieces decrease spell power -3 wisdom -3]
!!HE-1&y95=3:Fd0/d0/d0/d0;              [With 4 Set pieces Increase attack -0]
!!HE-1&y95=4:Fd-1/d-1/d-1/d-1;          [With 5 Set pieces Increase primary -1]
!!HE-1&y95=5:Fd-4/d-4/d-4/d-4;          [With 6 Set pieces decrease all -4]


*---------------------------------
*Priest of the Dark Set*
!?AE1|v998=104/v998=14/v998=20/v998=26/v998=8/v998=56; Equip Artifact  !!FU&761:E;
!!FU(Count_Set_Pieces):P-1/?y90/?y91/?y92/?y93/?y94/?y95/?y96; [Count Set Pieces function]

!!VRy96:+1;
!!HE-1&y96=3:Fd0/d0/d2/d2;              [With 3 Set pieces Increase spell power +2 wisdom +2]
!!HE-1&y96=4:Fd2/d0/d0/d0;              [With 4 Set pieces Increase attack +2]
!!HE-1&y96=5:Fd1/d1/d1/d1;              [With 5 Set pieces Increase primary +1]
!!HE-1&y96=6:Fd4/d4/d4/d4;              [With 6 Set pieces Increase all +4]

!?AE0|v998=104/v998=14/v998=20/v998=26/v998=8/v998=56; Unequip Artifact   !!FU&761:E;
!!FU(Count_Set_Pieces):P-1/?y90/?y91/?y92/?y93/?y94/?y95/?y96; [Count Set Pieces function]

!!VRy96:-1;
!!HE-1&y96=2:Fd0/d0/d-2/d-2;            [Without 3 Set pieces decrease spell power -2 wisdom -2]
!!HE-1&y96=3:Fd-2/d0/d0/d0;             [With 4 Set pieces Increase attack -2]
!!HE-1&y96=4:Fd-1/d-1/d-1/d-1;          [With 5 Set pieces Increase primary -1]
!!HE-1&y96=5:Fd-4/d-4/d-4/d-4;          [With 6 Set pieces decrease all -4]


*---------------------------------
*Books*
!?AE1|v998=86/v998=87/v998=88/v998=89; Equip Artifact     !!FU&761:E;

!!SN:W^Critical_Sorcery_Book_Fix^/?y1;  [*Necessary if played together with Magic Specialits Mod]
!!FU&y1=1:E;

!!HE-1:A2/86/?y30/?y10;
!!HE-1&v998=86/y10=1:A-86;

!!HE-1:A2/87/?y31/?y11;
!!HE-1&v998=87/y11=1:A-87;

!!HE-1:A2/88/?y32/?y12;
!!HE-1&v998=88/y12=1:A-88;

!!HE-1:A2/89/?y33/?y13;
!!HE-1&v998=89/y13=1:A-89;

!!FU(Count_Set_Pieces):P-1/?y90/?y91/?y92; [Count Set Pieces function]
!!VRy92:+1;


!!HE-1&y92=2/v998=86/y10=1/y30=1:Fd0/d0/d-3/d-3;
!!HE-1&y92=3/v998=86/y10=1/y30=1:Fd0/d0/d-5/d0;
!!HE-1&y92=3/v998=86/y10=1/y30=2:Fd0/d0/d-5/d0;
!!HE-1&y92=2/v998=87/y11=1/y31=1:Fd0/d0/d-3/d-3;
!!HE-1&y92=3/v998=87/y11=1/y31=1:Fd0/d0/d-5/d0;
!!HE-1&y92=3/v998=87/y11=1/y31=2:Fd0/d0/d-5/d0;
!!HE-1&y92=2/v998=88/y12=1/y32=1:Fd0/d0/d-3/d-3;
!!HE-1&y92=3/v998=88/y12=1/y32=1:Fd0/d0/d-5/d0;
!!HE-1&y92=3/v998=88/y12=1/y32=2:Fd0/d0/d-5/d0;
!!HE-1&y92=2/v998=89/y13=1/y33=1:Fd0/d0/d-3/d-3;
!!HE-1&y92=3/v998=89/y13=1/y33=1:Fd0/d0/d-5/d0;
!!HE-1&y92=3/v998=89/y13=1/y33=2:Fd0/d0/d-5/d0;

!!HE-1&y92=2:Fd0/d0/d3/d3;              [With 2 Set pieces Increase spell power +3 wisdom +3]
!!HE-1&y92=3:Fd0/d0/d5/d0;              [With 3 Set pieces Increase power +5]

!!HE-1&v998=86/y10=1:A86;
!!HE-1&v998=87/y11=1:A87;
!!HE-1&v998=88/y12=1:A88;
!!HE-1&v998=89/y13=1:A89;

!!if&y92=4;
*!VRz1:S^raisedead^;
*!SN:Pz1;
!!en;

!?AE0|v998=86/v998=87/v998=88/v998=89; Unequip Artifact   !!FU&761:E;

!!SN:W^Critical_Sorcery_Book_Fix^/?y1;  [*Necessary if played together with Magic Specialits Mod]
!!FU&y1=1:E;

!!FU(Count_Set_Pieces):P-1/?y90/?y91/?y92;

!!VRy92:-1;
!!HE-1&y92=1:Fd0/d0/d-3/d-3;            [With 2 Set pieces Increase spell power +3 wisdom +3]
!!HE-1&y92=2:Fd0/d0/d-5/d0;             [With 3 Set pieces Increase power +5]


*---------------------------------
*Orbs*
*?AE1|v998=79/v998=80/v998=81/v998=82; Equip Artifact      *!FU&761:E;

*!HE-1:A2/79/?y30/?y10;
*!HE-1&v998=79/y10=1:A-79;

*!HE-1:A2/80/?y31/?y11;
*!HE-1&v998=80/y11=1:A-80;

*!HE-1:A2/81/?y32/?y12;
*!HE-1&v998=81/y12=1:A-81;

*!HE-1:A2/82/?y33/?y13;
*!HE-1&v998=82/y13=1:A-82;

*!FU(Count_Set_Pieces):P-1/?y90/?y91/?y92; [Count Set Pieces function]
*!VRy91:+1;

*!HE-1&y91=3/v998=79/y10=1/y30=1:Fd0/d0/d0/d-3;
*!HE-1&y91=4/v998=79/y10=1/y30=1:Fd0/d0/d-5/d0;
*!HE-1&y91=4/v998=79/y10=1/y30=2:Fd0/d0/d-5/d0;
*!HE-1&y91=3/v998=80/y11=1/y31=1:Fd0/d0/d0/d-3;
*!HE-1&y91=4/v998=80/y11=1/y31=1:Fd0/d0/d-5/d0;
*!HE-1&y91=4/v998=80/y11=1/y31=2:Fd0/d0/d-5/d0;
*!HE-1&y91=3/v998=81/y12=1/y32=1:Fd0/d0/d0/d-3;
*!HE-1&y91=4/v998=81/y12=1/y32=1:Fd0/d0/d-5/d0;
*!HE-1&y91=4/v998=81/y12=1/y32=2:Fd0/d0/d-5/d0;
*!HE-1&y91=3/v998=82/y13=1/y33=1:Fd0/d0/d0/d-3;
*!HE-1&y91=4/v998=82/y13=1/y33=1:Fd0/d0/d-5/d0;
*!HE-1&y91=4/v998=82/y13=1/y33=2:Fd0/d0/d-5/d0;

*!HE-1&y91=3:Fd0/d0/d0/d3;
*!HE-1&y91=4:Fd0/d0/d5/d0;

*!HE-1&v998=79/y10=1:A79;
*!HE-1&v998=80/y11=1:A80;
*!HE-1&v998=81/y12=1:A81;
*!HE-1&v998=82/y13=1:A82;

*!SN&y91=4:W^Set_Sound_Orbs^/?y1;
*!SN&y91=4:W^Set_Sound_Orbs^/1;
*!FU(Set_Complete_Sound)&y1=0/y91=4:P;
*!FU(Set_Complete_Sound)&y91=4:P;

*?AE0|v998=79/v998=80/v998=81/v998=82; Unequip Artifact     *!FU&761:E;

*!FU(Count_Set_Pieces):P-1/?y90/?y91/?y92;
*!VRy91:-1;

*!HE-1&y91=2:Fd0/d0/d0/d-3;
*!HE-1&y91=3:Fd0/d0/d-5/d0;

*---------------------------------
*Moral and Luck*
!?AE1&1000; Equip Artifact         !!FU&761:E;

!!if|v998=49/v998=50/v998=51;          [Moral]
!!HE-1:A2/49/?y30/?y10;
!!HE-1&v998=49/y10=1:A-49;

!!HE-1:A2/50/?y31/?y11;
!!HE-1&v998=50/y11=1:A-50;

!!HE-1:A2/51/?y32/?y12;
!!HE-1&v998=51/y12=1:A-51;

!!HE-1&v998=49/y10=1:A49;
!!HE-1&v998=50/y11=1:A50;
!!HE-1&v998=51/y12=1:A51;
!!en;


!!if|v998=45/v998=46/v998=47/v998=48;  [Luck]
!!HE-1:A2/45/?y33/?y10;
!!HE-1&v998=45/y10=1:A-45;

!!HE-1:A2/46/?y30/?y11;
!!HE-1&v998=46/y11=1:A-46;

!!HE-1:A2/47/?y31/?y12;
!!HE-1&v998=47/y12=1:A-47;

!!HE-1:A2/48/?y32/?y13;
!!HE-1&v998=48/y13=1:A-48;

!!HE-1&v998=45/y10=1:A45;
!!HE-1&v998=46/y11=1:A46;
!!HE-1&v998=47/y12=1:A47;
!!HE-1&v998=48/y13=1:A48;
!!en;


!!if|v998=63/v998=64/v998=65;          [Eagle Eye]
!!HE-1:A2/63/?y30/?y10;
!!HE-1&v998=63/y10=1:A-63;

!!HE-1:A2/64/?y31/?y11;
!!HE-1&v998=64/y11=1:A-64;

!!HE-1:A2/65/?y32/?y12;
!!HE-1&v998=65/y12=1:A-65;

!!HE-1&v998=63/y10=1:A63;
!!HE-1&v998=64/y11=1:A64;
!!HE-1&v998=65/y12=1:A65;
!!en;

!?AE1&v998=138; !!FU&761:E;            [Wizards Well]
!!HE-1:Fd/d/d5/d;

*!FU(Set_Complete_Sound):P;

!?AE0&v998=138;               !!FU&761:E;
!!HE-1:Fd/d/d-5/d;



*---------------------------------
*Basilisk Venom Set*
!?AE1|v998=10/v998=15/v998=19/v998=27; Equip Artifact  !!FU&761:E;
!!FU(Count_Set_Pieces):P-1/0/0/0/0/0/0/0/?y90; [Count Set Pieces function X9]

!!VRy90:+1;
!!HE-1&y90=2:Fd0/d0/d0/d2;              [With 2 Set pieces]
!!HE-1&y90=3:Fd2/d2/d2/d2;              [With 3 Set pieces]
!!HE-1&y90=4:Fd3/d3/d3/d3;              [With 4 Set pieces]

*!FU(Set_Complete_Sound)&y90=3:P;

!?AE0|v998=10/v998=15/v998=19/v998=27; Unequip Artifact     !!FU&761:E;
!!FU(Count_Set_Pieces):P-1/0/0/0/0/0/0/0/?y90; [Count Set Pieces function X9]

!!VRy90:-1;
!!HE-1&y90=1:Fd0/d0/d0/d-2;             [Without 2 Set pieces]
!!HE-1&y90=2:Fd-2/d-2/d-2/d-2;          [With 3 Set pieces]
!!HE-1&y90=3:Fd-3/d-3/d-3/d-3;          [With 4 Set pieces]

*---------------------------------
*Titan's Thunder Set*
!?AE1&v998=135; Equip Artifact     !!FU&761:E;

!!HE-1:Fd3/d3/d2/d2;                    [With 4 Set pieces Increase 3 3 2 2]

!?AE0&v998=135; Unequip Artifact   !!FU&761:E;

!!HE-1:Fd-3/d-3/d-2/d-2;                [With 4 Set pieces Decrease 3 3 2 2]

*---------------------------------
*Archdevil Suite Set*
!?AE1|v998=11/v998=17/v998=23/v998=29/v998=101; Equip Artifact  !!FU&761:E;
!!FU(Count_Set_Pieces):P-1/0/0/0/0/0/0/0/0/0/0/0/?y90; [Count Set Pieces function X13]

!!VRy90:+1;
!!HE-1&y90=3:Fd1/d1/d1/d1;              [With 3 Set pieces Increase primary +1]
!!HE-1&y90=4:Fd2/d2/d0/d0;              [With 4 Set pieces Increase attack +2 and defense +2]


!?AE0|v998=11/v998=17/v998=23/v998=29/v998=101; Unequip Artifact    !!FU&761:E;
!!FU(Count_Set_Pieces):P-1/0/0/0/0/0/0/0/0/0/0/0/?y90; [Count Set Pieces function X13]

!!VRy90:-1;
!!HE-1&y90=2:Fd-1/d-1/d-1/d-1;          [With 3 Set pieces Increase primary -1]
!!HE-1&y90=3:Fd-2/d-2/d0/d0;            [With 4 Set pieces Increase attack -2]

*---------------------------------
*Angelic Alliance Set*
!?AE1|v998=31/v998=32/v998=33/v998=34/v998=35/v998=36; !!FU&761:E; [Equip Artifact]
!!FU(Count_Set_Pieces):P-1/0/0/0/0/0/0/0/0/0/0/0/0/?y90; [Count Set Pieces function X14]

!!VRy90:+1;
!!HE-1&y90=6:Fd2/d2/d2/d2;              [With 6 Set pieces Increase all +2]
!!HE-1&y90=5:R0/d1;                     [Add +1 Moral]



!?AE0|v998=31/v998=32/v998=33/v998=34/v998=35/v998=36; !!FU&761:E; [Unequip Artifact]
!!FU(Count_Set_Pieces):P-1/0/0/0/0/0/0/0/0/0/0/0/0/?y90; [Count Set Pieces function X14]

!!VRy90:-1;
!!HE-1&y90=5:Fd-2/d-2/d-2/d-2;          [With 6 Set pieces decrease all -2]
!!HE-1&y90=4:R0/d-1;                    [Reduce +1 Moral]

*---------------------------------
*Battle Mage War Dress Set*
!?AE1|v998=7/v998=16/v998=100/v998=28/v998=21; Equip Artifact  !!FU&761:E;
!!FU(Count_Set_Pieces_2):P-1/?y90;      [Count Set Pieces function X2]

!!VRy90:+1;
!!HE-1&y90=3:Fd2/d2/d/d;                [With 6 Set pieces Increase all +2]
!!HE-1&y90=5:Fd2/d2/d2/d2;

*!FU(Set_Complete_Sound)&y90=5:P;


!?AE0|v998=7/v998=16/v998=100/v998=28/v998=21; Unequip Artifact   !!FU&761:E;
!!FU(Count_Set_Pieces_2):P-1/?y90;      [Count Set Pieces function X2]

!!VRy90:-1;
!!HE-1&y90=2:Fd-2/d-2/d/d;              [With 6 Set pieces decrease all -2]
!!HE-1&y90=4:Fd-2/d-2/d-2/d-2;


*---------------------------------
*Scouting Set*
!?FU(OnEquipArt)|v998=(ART_SPECULUM)/v998=(ART_SPYGLASS);
!!FU(acm_HandleAncientSpyglassHeroPrimarySkills):Pv998/(FALSE);


!?FU(OnUnequipArt)|v998=(ART_SPECULUM)/v998=(ART_SPYGLASS);
!!FU(acm_HandleAncientSpyglassHeroPrimarySkills):Pv998/(TRUE);

!?FU(acm_HandleAncientSpyglassHeroPrimarySkills);
!#VA(handledArt:x) (isUnequip:x);

!!if&(handledArt)=(ART_SPECULUM);
  !!VR(oppositeArt:y):S(ART_SPYGLASS);
!!el;
  !!VR(oppositeArt:y):S(ART_SPECULUM);
!!en;

!!HE-1:A2/(handledArt)/?t/?(handledArtsEquipped:y) A2/(oppositeArt)/?t/?(oppositeArtsEquipped:y);

!!if&(handledArtsEquipped)=0/(oppositeArtsEquipped)/(isUnequip:x)=(FALSE);
  !!HE-1:Fd1/d1/d1/d1;
!!el&(oppositeArtsEquipped)/(handledArtsEquipped)=1/(isUnequip);
  !!HE-1:Fd-1/d-1/d-1/d-1;
!!en;


********************************************************************************
!?FU(Count_Set_Pieces);                 [Count Set Pieces Fkt]
x1=hero number, x2-15 returns set pieces

!!HEx1:A2/41/?y30/?y10;                 [Dragonbone Greaves]
!!HEx1:A2/42/?y30/?y11;                 [Dragon Wing Tabard]
!!HEx1:A2/43/?y30/?y12;                 [Necklace of Dragonteeth]
!!HEx1:A2/44/?y30/?y13;                 [Crown of Dragontooth]
!!HEx1:A2/39/?y30/?y14;                 [Dragon Scale Shield]
!!HEx1:A2/40/?y30/?y15;                 [Dragon Scale Armor]
!!VRy20&y10>0:+1;
!!VRy20&y11>0:+1;
!!VRy20&y12>0:+1;
!!VRy20&y13>0:+1;
!!VRy20&y14>0:+1;
!!VRy20&y15>0:+1;

!!VRx2:Sy20;                            [x2 Dragon Set]
*------------------

!!HEx1:A2/79/?y31/?y10;                 [Orb of Firmament]
!!HEx1:A2/80/?y32/?y11;                 [Orb of Silt]
!!HEx1:A2/81/?y33/?y12;                 [Orb of Tempestous fire]
!!HEx1:A2/82/?y34/?y13;                 [Orb of Driving rain]
!!VRy21&y10>0:+1;
!!VRy21&y11>0:+1;
!!VRy21&y12>0:+1;
!!VRy21&y13>0:+1;

!!VRx3:Sy21;                            [x3 Elementel Unity Set]
*------------------

!!HEx1:A2/86/?y30/?y10;                 [Tome of Fire]
!!HEx1:A2/87/?y30/?y11;                 [Tome of Air]
!!HEx1:A2/88/?y30/?y12;                 [Tome of Water]
!!HEx1:A2/89/?y30/?y13;                 [Tome of Earth]
!!VRy22&y10>0:+1;
!!VRy22&y11>0:+1;
!!VRy22&y12>0:+1;
!!VRy22&y13>0:+1;

!!VRx4:Sy22;                            [x4 Wizards Knowledge Set]
*------------------

!!HEx1:A2/49/?y30/?y10;                 [Badge of Courage]
!!HEx1:A2/50/?y31/?y11;                 [Crest of Valor]
!!HEx1:A2/51/?y32/?y12;                 [Glyph of Gallantry]
!!HEx1:A2/108/?y33/?y13;                [Pendant of Courage]
!!VRy23&y10>0:+1;
!!VRy23&y11>0:+1;
!!VRy23&y12>0:+1;
!!VRy23&y13>0:+1;

!!VRx5:Sy23;                            [x5 The Champion's Honor Set]
*------------------

!!HEx1:A2/45/?y30/?y10;                 [Still Eye of the Dragon]
!!HEx1:A2/46/?y31/?y11;                 [Clover of Fortune]
!!HEx1:A2/47/?y32/?y12;                 [Cards of Prophecy]
!!HEx1:A2/48/?y33/?y13;                 [Ladybird of Luck]
!!VRy24&y10>0:+1;
!!VRy24&y11>0:+1;
!!VRy24&y12>0:+1;
!!VRy24&y13>0:+1;

!!VRx6:Sy24;                            [x6 Adventures Fidelity Set]
*------------------

!!HEx1:A2/103/?y30/?y10;                [Pendant Of Life]
!!HEx1:A2/13/?y30/?y11;                 [Shield of the Dwarven Lords]
!!HEx1:A2/22/?y30/?y12;                 [Crown of the Supreme Magi]
!!HEx1:A2/25/?y30/?y13;                 [Breastplate of Petrified Wood]
!!HEx1:A2/9/?y30/?y14;                  [Greater Gnoll's Flail]
!!HEx1:A2/98/?y30/?y15;                 [Boots of Speed]
!!VRy25&y10>0:+1;
!!VRy25&y11>0:+1;
!!VRy25&y12>0:+1;
!!VRy25&y13>0:+1;
!!VRy25&y14>0:+1;
!!VRy25&y15>0:+1;

!!VRx7:Sy25;                            [x7 Priest of the Light Set]
*------------------

!!HEx1:A2/104/?y30/?y10;                [Pendant Of Death]
!!HEx1:A2/14/?y30/?y11;                 [Shield of the Yawning Dead]
!!HEx1:A2/20/?y30/?y12;                 [Skull Helmet]
!!HEx1:A2/26/?y30/?y13;                 [Rib Cage]
!!HEx1:A2/8/?y30/?y14;                  [Blackshard of the Dead Knight]
!!HEx1:A2/56/?y30/?y15;                 [Dead Man's Boots]
!!VRy26&y10>0:+1;
!!VRy26&y11>0:+1;
!!VRy26&y12>0:+1;
!!VRy26&y13>0:+1;
!!VRy26&y14>0:+1;
!!VRy26&y15>0:+1;

!!VRx8:Sy26;                            [x8 Priest of the Dark Set]
*------------------

!!HEx1:A2/10/?y30/?y10;                 [Ogre's Club of Havoc]
!!HEx1:A2/15/?y30/?y11;                 [Buckler of the Gnoll King]
!!HEx1:A2/19/?y30/?y12;                 [Helm of the Alabaster Unicorn]
!!HEx1:A2/27/?y30/?y13;                 [Scales of the Greater Basilisk]

!!VRy27&y10>0:+1;
!!VRy27&y11>0:+1;
!!VRy27&y12>0:+1;
!!VRy27&y13>0:+1;

!!VRx9:Sy27;                            [x9 Venom Set]
*------------------

!!HEx1:A2/57/?y30/?y10;                 [Garniture of Interference]
!!HEx1:A2/58/?y30/?y11;                 [Surcoat of Counterpoise]
!!HEx1:A2/59/?y30/?y12;                 [Boots of Polarity]


!!VRy28&y10>0:+1;
!!VRy28&y11>0:+1;
!!VRy28&y12>0:+1;


!!VRx10:Sy28;                           [x10 Resistance Set]
*------------------

!!HEx1:A2/97/?y30/?y10;                 [Necklace of Swiftness]
!!HEx1:A2/69/?y30/?y11;                 [Ring of the Wayfarer]
!!HEx1:A2/99/?y30/?y12;                 [Cape of Velocity]


!!VRy29&y10>0:+1;
!!VRy29&y11>0:+1;
!!VRy29&y12>0:+1;


!!VRx11:Sy29;                           [x11 Pegasus Harness]
*------------------

!!HEx1:A2/12/?y30/?y10;                 [Titan's Gladius ]
!!HEx1:A2/18/?y30/?y11;                 [Sentinel's Shield ]
!!HEx1:A2/24/?y30/?y12;                 [Thunder Helmet ]
!!HEx1:A2/30/?y30/?y13;                 [Titan's Cuirass ]

!!VRy40&y10>0:+1;
!!VRy40&y11>0:+1;
!!VRy40&y12>0:+1;
!!VRy40&y13>0:+1;

!!VRx12:Sy40;                           [x12 Titans Thunder]
*------------------

!!HEx1:A2/11/?y30/?y10;                 [Sword of Hellfire]
!!HEx1:A2/17/?y30/?y11;                 [Shield of the Damned]
!!HEx1:A2/23/?y30/?y12;                 [Hellstorm Helmet]
!!HEx1:A2/29/?y30/?y13;                 [Breastplate of Brimstone]
!!HEx1:A2/101/?y30/?y14;                [Pendant of Second Sight]

!!VRy41&y10>0:+1;
!!VRy41&y11>0:+1;
!!VRy41&y12>0:+1;
!!VRy41&y13>0:+1;
!!VRy41&y14>0:+1;

!!VRx13:Sy41;                           [x13 Archdevils Suite Set]
*------------------

!!HEx1:A2/31/?y30/?y10;                 [Armor of Wonder]
!!HEx1:A2/32/?y30/?y11;                 [Sandals of the Saint]
!!HEx1:A2/33/?y30/?y12;                 [Celestial Necklace of Bliss]
!!HEx1:A2/34/?y30/?y13;                 [Lion's Shield of Courage]
!!HEx1:A2/35/?y30/?y14;                 [Sword of Judgement]
!!HEx1:A2/36/?y30/?y15;                 [Helm of Heavenly Enlightenment]
!!VRy42&y10>0:+1;
!!VRy42&y11>0:+1;
!!VRy42&y12>0:+1;
!!VRy42&y13>0:+1;
!!VRy42&y14>0:+1;
!!VRy42&y15>0:+1;

!!VRx14:Sy42;                           [x14 Angelic Alliance Set]
*------------------

!!HEx1:A2/63/?y30/?y10;                 [Garniture of Interference]
!!HEx1:A2/64/?y30/?y11;                 [Surcoat of Counterpoise]
!!HEx1:A2/65/?y30/?y12;                 [Boots of Polarity]


!!VRy43&y10>0:+1;
!!VRy43&y11>0:+1;
!!VRy43&y12>0:+1;


!!VRx15:Sy43;                           [x15 Resistance Set]
*------------------
!?FU(Count_Set_Pieces_2);               [Count Set Pieces]

!!HEx1:A2/7/?y30/?y10;                  [Axe]
!!HEx1:A2/16/?y30/?y11;                 [Ogre]
!!HEx1:A2/100/?y30/?y12;                [Pendant of Dispassion]
!!HEx1:A2/28/?y30/?y13;                 [Tunic of the Cyclops King]
!!HEx1:A2/21/?y30/?y14;                 [Helm of Chaos]

!!VRy42&y10>0:+1;
!!VRy42&y11>0:+1;
!!VRy42&y12>0:+1;
!!VRy42&y13>0:+1;
!!VRy42&y14>0:+1;

!!VRx2:Sy42;                            [x2 Battle Mage War Dress Set]

*------------------
!!HEx1:A2/52/?y30/?y10;                 [Speculum]
!!HEx1:A2/53/?y30/?y11;                 [Spyglass]

!!VRy43&y10>0:+1;
!!VRy43&y11>0:+1;

!!VRx3:Sy43;                            [x3 Scouting Set]

*------------------
!!HEx1:A2/163/?y30/?y10;                [Shield]
!!HEx1:A2/168/?y30/?y11;                [Surcoat]
!!HEx1:A2/165/?y30/?y12;                [Ring]

!!VRy44&y10>0:+1;
!!VRy44&y11>0:+1;
!!VRy44&y12>0:+1;

!!VRx4:Sy44;                            [x4 Warrior Set]

*------------------
!!HEx1:A2/161/?y30/?y10;                [Helmet]
!!HEx1:A2/162/?y30/?y11;                [Sword]
!!HEx1:A2/169/?y30/?y12;                [Boots]

!!VRy45&y10>0:+1;
!!VRy45&y11>0:+1;
!!VRy45&y12>0:+1;

!!VRx5:Sy45;                            [x5 Mage Set]

*------------------
!!HEx1:A2/164/?y30/?y10;                [Horned Ring]
!!HEx1:A2/166/?y30/?y11;                [Neck Broach]
!!HEx1:A2/167/?y30/?y12;                [Armor]

!!VRy46&y10>0:+1;
!!VRy46&y11>0:+1;
!!VRy46&y12>0:+1;

!!VRx6:Sy46;                            [x6 Adventurer Set]

*------------------
!!HEx1:A2/63/?y30/?y10;                 [Bird of Perception]
!!HEx1:A2/64/?y30/?y11;                 [Stoic Watchman]
!!HEx1:A2/65/?y30/?y12;                 [Emblem of Cognizance]

!!VRy47&y10>0:+1;
!!VRy47&y11>0:+1;
!!VRy47&y12>0:+1;

!!VRx7:Sy47;                            [x6 Eagle Eye Set Vision of the Eagle]


*--------------------------------------------------------------------Play Sound when Set completed-------------------------------------------------------------------------*
!?FU(Set_Complete_Sound)&1000;

!!FU:E;
!!SN:W^Set_Sound_Timer^/?y1;
!!SN:W^Play_Sound_Trigger^/?y2;
!!SN:W^Play_Sound_Trigger2^/?y3;
*!IF:M^y1 is %Y1 und y2 is %Y2^;
*!FU|y1=0/y2=0/y3=0:E;
*!VRz1:S^51heroism03.wav^;
!!VRz1:S^DF106c.wav^;
!!SN:Pz1;
*SN:W^Set_Sound_Timer^/0;  Deactivate Sound Trigger
*SN:W^Play_Sound_Trigger^/0;
*SN:W^Play_Sound_Trigger2^/0;

*?TL2;
*SN:W^Set_Sound_Timer^/1; Activate again after 2 seconds

*?AE1; Equip Artifact
*!IF:M^Equip v998 is%V998 und v999 is%V999^;
*SN:W^Play_Sound_Trigger^/1;

*?AE0; Unequip Artifact
*!IF:M^Unequip v998 is%V998 und v999 is%V999^;
*!SN:W^Play_Sound_Trigger^/0;

*?CM2&1000;
*CM:F?v3 I?v4 S?v5; where we click and click subtype
*FU&v5<>12:E;
*SN&v4<40|v4>45:W^Play_Sound_Trigger2^/1;
*SN&v4>=40/v4<=44:W^Play_Sound_Trigger2^/0;

*--------------------------------------------------------------------Give Bonus Extra Abilities----------------------------------------------------------------------------*
!?FU(AC_Function_58);                   [Function for giving extra abilities]

!!BMx16:T?y1;
!!VRy2:Sx16;                            [use stack ID (read below*), I set y2 to current stack number]
!!VRy2:+1*-1;                           [now I add +1 then change to negative  value, we have now number of stack for EA thx Sal]

!!if&y1>=0/y1<=144;

!!if&x2=1;                             [Titans Lightning Cast 25% Chance with Set]
!!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
!!EAy2&y3>=0:By3/1/107/57/25/25/25/25/25/25/25/25/25/25/25; [Battle Monster]
!!en;

!!if&x2=3;                             [Double Strike with Set]
!!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
!!EAy2&y3>=0:By3/1/102/68/1/1/1/1/1/1/1/1/1/1/1; [Battle Monster]
!!en;

!!if&x2=4;                             [Fearless with Moral Set]
!!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
!!EAy2&y3>=0:By3/1/102/102/1/1/1/1/1/1/1/1/1/1/1; [Battle Monster]

!!MA:Ly1/?y5;
!!if&y5=0;                             [If Monster level 1 give Champion Charge]
!!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
!!EAy2&y3>=0:By3/1/102/99/1/1/1/1/1/1/1/1/1/1/1; [Battle Monster]
!!en;
!!en;
!!en;


************************Spell Count Eagle Eye***********************************
!?FU(AC_Function_61);

!!HEx1:Mx16/?y1;
!!SN&y1=1/x2=1:W^Attacker_Eagle_Eye_Spells^/d+1;
!!SN&y1=1/x2=2:W^Defender_Eagle_Eye_Spells^/d+1;


************************Archdevil Suite Pick Random Stack***********************
**FU(AC_Function_55):Px1/?y2;  /0/return a random enemy stack
!?FU(AC_Function_55);
**x1=current side(0-1)
**x2=random enemy stack
!!VRv8:C0/0/0;
!!DO(AC_Function_52)/21/41/1&x1=0:P-1;  [v8]
!!DO(AC_Function_52)/0/20/1&x1=1:P-1;
!!FU&v8<1:E;
!!VRy1:S1Rv8;
!!VRy1&y1>v8:Sv8;
!!DO(AC_Function_52)/21/41/1&x1=0:P-2/y1;[v9v10]
!!DO(AC_Function_52)/0/20/1&x1=1:P-2/y1;
!!FU&v10<0:E;
!!VRx2:Sv10;
!!VRv8:C0/0/0;

!?FU(AC_Function_52)&x1=-1;
!!BMx16:T?y10 N?y11;
!!FU&y10>144/y10<150:E;                 [exclude war machines]
!!FU|y10=124/y11<1:E;
!!VRv8:+1;

!?FU(AC_Function_52)&x1=-2;
!!BMx16:T?y10 N?y11;
!!FU&y10>144/y10<150:E;
!!FU|y10=124/y11<1:E;
!!FU&v9=x2:E;
!!VRv9:+1;
!!VRv10:Sx16;


************************Angelic Alliance Set Piece******************************
!?FU(AC_Function_59);                   [increase HP and Speed]

!!BMx16:T?y1 N?y2; !!FU&y2=0:E;
!!FU|y1=145/y1=146/y1=147/y1=148/y1=149:E; [Execlude Warmachines]
!!BMx16:H?y1;
!!VRy1:*x1:100;
!!BMx16:Hy1 Sdx2;

************************Scouting Set Piece**************************************
!?FU(AC_Function_60);                   [increase Units Stats]
!!BMx16:T?y1 N?y2; !!FU&y2=0:E;
!!FU|y1=145/y1=146/y1=147/y1=148/y1=149:E; [Execlude Warmachines]

!!SN:W^Prepare_For_Battle_Bonus^/?y10;

!!if&x1=1;                             [Attack]
!!BMx16:Ady10;
!!en;

!!if&x1=2;                             [Defense]
!!BMx16:Ddy10;
!!en;

!!if&x1=3;                             [Health]
!!VRy10:+100;
!!BMx16:H?y1;
!!VRy1:*y10:100;
!!BMx16:Hy1;
!!en;

!!if&x1=4;                             [Speed]
!!BMx16:Sdy10;
!!en;



************************Statue of Legion Set Piece******************************
!?FU(OnEveryDay)&i^timerDay^>1/i^timerWeekDay^=1;
!!OW:C?y1;
!!DO(AC_Function_53)/0/155/1:Py1;

!?FU(AC_Function_53);
!!HEx16:O?y1;
!!FU&y1<>x1:E;
!!HEx16:A2/133/?y30/?y10;               [Statue of Legion]
!!DO(AC_Function_54)/0/6/1&y10>0:Px16;

!?FU(AC_Function_54);
!!HEx1:C0/x16/?y1/?y2;
!!FU|y2<1/y1<0:E;
!!MA:Xy1/?y3;
!!VRy3:&16;
!!FU&y3=0:E;
!!VRy3:Sy2 *103 :100 -y2;
!!HEx1:C0/x16/d/dy3/0/0;


****************************************************************************************************



                     New Artifact and Sets Section




****************************************************************************************************
New artifact overview window made by kongsuni. Right-Click the Backpack icon in the hero screen to access it.
Artifacts show description when right clicked
!?FU(OnHeroScreenMouseClick);

!!CM:F?y1 I?y2 S?y3;
!!SN:W^Typhon_Third_Upgrade_Mod_Active^/?y4; [Check for Third Upgrade Mod]
!!if&y1=512/y2=8000/y3=14;
  !!DL570:N^ACM_Arts.txt^;

  !!SN:T^AC_Artifacts.ACM_Set_Table_Name^/?z20;
  !!DL570:A500/3/z20/1;

  !!re i/0/18;
    !!SN:T^AC_Artifacts.Set_Name_%i^/?z30;
    !!VRy30:Si +400;
    !!DL570:Ay30/(DLG_CMD_SET_TEXT)/z30/1;
  !!en;

  !!DL570:S;
!!en;

!?DL&v998=570/v1000=14;                 [Show information about artifact when right clicked]
!!if&v999>(NO_ART)/v999<=(ART_LAST_WOG);[DL Arti ID must match arti ID to work]
  !!SN:H^art^/v999/1/?s^Text^;
  !!IF:M0/4/^%S(Text)^; 
!!en;

!?DL&v998=570/v999=30722/v1000=13;
!!DL:C1;                                [Close Art Table DL]                     


*Issue warning when clicking on Backpack to not assemble/disassemble artifacts with HD Mod functionality
!?FU(OnHeroScreenMouseClick)&i^Backpack_Warning_Flag^/i^mouse_flags^=(NO_MOUSE_FLAGS)/i^mouse_item^=8000;

!!IF:M0/4/^%T(AC_Misc.Backpack_Warning)^;
!!SN:W^Backpack_Warning_Flag^; 

!?FU(OnAfterErmInstructions);
!!SN:W^Backpack_Warning_Flag^/1;


********************************************************************************
*Horn of Magic Energy
!?AE1&v998=170; Equip Artifact 170      !!FU&761:E;
!!HE-1:Fd0/d0/d3/d3;                    [Increase spell power +3 wisdom +3]

!?AE0&v998=170; Unequip Artifact 170    !!FU&761:E;
!!HE-1:Fd0/d0/d-3/d-3;                  [Decrease spell power -3 wisdom -3]

********************************************************************************
*Full Helmet of the commander
!?AE1&v998=161; Equip Artifact 161     !!FU&761:E;
!!HE-1:Fd1/d1/d1/d1;

!?AE0&v998=161; Unequip Artifact 161   !!FU&761:E;
!!HE-1:Fd-1/d-1/d-1/d-1;

*of the commanders artifacts* 161 Helmet, 163 Round Shield, 166 Necklace and combination sets
!?BF;
!!FU:E;                                 [Bonus Moved to Commander attributes table]
!!BA:H0/?y1 H1/?y2;
!!HEy1:A2/161/?y3/?y4 A2/163/?y3/?y5 A2/166/?y3/?y6;
!!FU(Count_Set_Pieces_2):Py1/0/0/?y90/?y91/?y92; [Count Set Pieces function]
!!VRy51:S100; !!VRy51&y4=1:+20; !!VRy51&y5=1:+20; !!VRy51&y6=1:+20; !!VRy51&y90>=2:+20; !!VRy51&y91>=2:+20; !!VRy51&y92>=2:+20;
!!DO(AC_Function_33)/0/20/1&y51>100:P0/0/0/y51/y51; [Pass  Health and Damage]

!!FU&y2<0:E;
!!HEy2:A2/161/?y3/?y4 A2/163/?y3/?y5 A2/166/?y3/?y6;
!!FU(Count_Set_Pieces_2):Py2/0/0/?y90/?y91/?y92; [Count Set Pieces function]
!!VRy51:S100; !!VRy51&y4=1:+20; !!VRy51&y5=1:+20; !!VRy51&y6=1:+20; !!VRy51&y90>=2:+20; !!VRy51&y91>=2:+20; !!VRy51&y92>=2:+20;
!!DO(AC_Function_33)/21/41/1&y51>100:P0/0/0/y51/y51; [Pass  Health and Damage]


********************************************************************************
*Noble Ring of Quicksand 164
!?AE1&v998=164; Equip Artifact 164     !!FU&761:E;
!!HE-1:Fd1/d0/d1/d0;                    [Increase all primary skills by +1]

!?AE0&v998=164; Unequip Artifact 164    !!FU&761:E;
!!HE-1:Fd-1/d0/d-1/d0;                  [Decrease all primary skills by -1]


******************
*of Quicksand modifier
Boots of Quicksand 169
Noble Ring of Quicksand 164
Glittering Surcoat of Quicksand 168
!?BF;
!!BA:H0/?y1 H1/?y2;
!!HEy1:A2/164/?y3/?y4 A2/169/?y3/?y5 A2/168/?y3/?y6;
!!DO(AC_Function_64)/21/41/1&y4=1:P;
!!DO(AC_Function_64)/21/41/1&y5=1:P;
!!DO(AC_Function_64)/21/41/1&y6=1:P;

!!FU&y2<0:E;
!!HEy2:A2/164/?y3/?y4 A2/169/?y3/?y5 A2/168/?y3/?y6;
!!DO(AC_Function_64)/0/20/1&y4=1:P;
!!DO(AC_Function_64)/0/20/1&y5=1:P;
!!DO(AC_Function_64)/0/20/1&y6=1:P;

!?FU(AC_Function_64);
!!BMx16:T?y1;
!!FU|y1=145/y1=146/y1=147/y1=148/y1=149:E; [Execlude Warmachines]
!!BMx16:S?y1;
!!VRy2:Sy1-1;
!!VRy2&y2<1:S1;
!!BMx16:Sy2;

********************************************************************************
*Crystal Ring of Magic 165
!?AE1&v998=165; Equip Artifact 165     !!FU&761:E;
!!HE-1:Fd-1/d-1/d6/d0;

!?AE0&v998=165; Unequip Artifact 165    !!FU&761:E;
!!HE-1:Fd1/d1/d-6/d0;


********************************************************************************
*Boots of Quicksand 169
!?AE1&v998=169; Equip Artifact 169     !!FU&761:E;
!!HE-1:Fd1/d1/d0/d0;

!?AE0&v998=169; Unequip Artifact 169    !!FU&761:E;
!!HE-1:Fd-1/d-1/d0/d0;


********************************************************************************
*Precious Longsword 162 +1 damage for all troops

!?AE1&v998=162; Equip artifact    !!FU&761:E;
!!HE-1:Fd6/d-3/d-3/d-3;

!?AE0&v998=162; Unequip Artifact   !!FU&761:E;
!!HE-1:Fd-6/d3/d3/d3;

!?BF;
!!BA:H0/?y1 H1/?y2;
!!HEy1:A2/162/?y3/?y4;
!!DO(AC_Function_13)/0/20/1&y4=1:P0/0/1;

!!FU&y2<0:E;
!!HEy2:A2/162/?y3/?y4;
!!DO(AC_Function_13)/21/41/1&y4=1:P0/0/1;

********************************************************************************
*Round Shield of the commander 163 +2 defense +50 flat damage block

!?AE1&v998=163; Equip artifact    !!FU&761:E;
!!HE-1:Fd0/d2/d0/d0;

!?AE0&v998=163; Unequip Artifact   !!FU&761:E;
!!HE-1:Fd0/d-2/d0/d0;

!?MF1;                                  [*Physical Combat *]

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]

!!MF:W?y80;
!!FU&y80>0:E;

!!BG:A?y1;
!!if|y1=6/y1=7;                        [Attack or Shoot]

!!MF:N?y4;                              [damage receiving stack]
!!BMy4:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;                           [Exit if no Hero]
!!BMy4:F?y78;                           [read flags]
!!VRy78:&4194304;                       [just look summoned bit]
!!FU&y78>0:E;                           [Exit if cloned or summoned]
!!HEy99:A2/163/?y3/?y4;
!!FU&y4=0:E;                            [Exit if no Shield equipped]
!!MF:F?y6;                              [Damage Dealt]
!!VRy8:S50;                             [Shield Strength 50]

!!if&y8>=y6;
!!MF:E0;
!!MF:F0;
!!en;

!!if&y6>y8;                            [do if damage is bigger than shield]
!!VRy7:Sy6-y8;
!!MF:Fy7;
!!en;
!!en;
!!en;

********************************************************************************
*Kings Necklace of the commander 166

!?AE1&v998=166; Equip artifact    !!FU&761:E;
!!HE-1:Fd1/d1/d1/d1;

!?AE0&v998=166; Unequip Artifact   !!FU&761:E;
!!HE-1:Fd-1/d-1/d-1/d-1;


********************************************************************************
*Glittering Surcoat of Quicksand 168    When equipped, this sparkling Surcoat reduces the speed of all enemies by 1 and gives you +1 Luck and Moral
!?AE1&v998=168; Equip Artifact 168    !!FU&761:E;
!!HE-1:R0/d1;                           [Add +1 Moral]
!!HE-1:R1/d1;                           [Add +1 Luck]

!?AE0&v998=168; Unequip Artifact 168      !!FU&761:E;
!!HE-1:R0/d-1;                          [Remove -1 Moral]
!!HE-1:R1/d-1;                          [Remove -1 Moral]

!?FU(OnAfterBattleUniversal);           [After any battle]
!!BA:H0/?y95;                           [Check who the left hero was]
!!BA:H1/?y96;                           [Check who the right hero was]
!!HEy95:A2/168/?y1/?y2;                 [Check if the left hero still has the Surcoat (he might have lost it in the battle)]
!!HEy96&y96>=0:A2/168/?y3/?y4;          [Do the same for the right hero, but only if it was a hero (and not just creatures)]
!!HEy95&y1>0:R0/d1 R1/d1;               [Give morale and Luck bonuses]
!!HEy96&y3>0/y96>=0:R0/d1 R1/d1;


********************************************************************************
*Royal Armor 167 +10% HP for all

!?AE1&v998=167; Equip artifact    !!FU&761:E;
!!HE-1:Fd-1/d-1/d-1/d-1;

!?AE0&v998=167; Unequip Artifact   !!FU&761:E;
!!HE-1:Fd1/d1/d1/d1;

!?BF;
!!BA:H0/?y98;
!!HEy98:A2/167/?y1/?y10;
!!DO(AC_Function_65)/0/20/1&y10>0:P;

!!BA:H1/?y99;
!!FU&y99<0:E;
!!HEy99:A2/167/?y1/?y10;
!!DO(AC_Function_65)/21/41/1&y10>0:P;

!?FU(AC_Function_65);                   [increase HP by 10%]
!!BMx16:T?y1;
!!FU|y1=145/y1=146/y1=147/y1=148/y1=149:E; [Execlude Warmachines]
!!BMx16:H?y1;
!!VRy1:*110:100;
!!BMx16:Hy1;


********************************************************************************
*After every fight there is a 2% chance for class sets*
*Class Sets cannot be found by Hybrid Classes*
*Finding a class set requires >level 20
*There are certain ways to increase your chance of finding one*

!?FU(OnAfterBattleUniversal)&1000;
!!BA:H0/?y1;
!!HEy1:O?y2;                            [get owner]
!!OW:C?y4/?y5;                          [get current player and interacting player]
!!FU&y2<>y4:E;                          [exit if not current player's hero]
!!OW:Iy4/?y88;
!!FU&y88=1:E;                           [Exit if AI]
!!HEy1:E?y15/?y16/1;                    [Get Hero Level]
!!FU(Class_Artifacts_Reward)&y16>=20:Py1;[Run only if level 20 or higher]


!?FU(Class_Artifacts_Reward);
!!SN:W^Master_Warrior_Hero%X1^/?y10;
!!SN:W^Master_Mage_Hero%X1^/?y11;
!!SN:W^Master_Adventurer_Hero%X1^/?y12;

!!SN:W^Battle_Commander_On^/?y50;       [Check if Battle Commander was active]
!!SN:T^AC_Misc.Class Sets^/?z2;
!!OW:C?y4/?y5;                          [get current player and interacting player]
!!HEx1:A2/47/?y59/?y60 O?y3;            [47 Cards of Prophecy +1 and get current owner]
!!FU(Count_Set_Pieces):Px1/0/0/0/0/?y95;[Check for The Adventures Fidelity]
*Set the class check to true so all sets can be found if full set is worn*

*Warrior
!!if&y10=1/y11=0/y12=0|y95=4;           [Run if only Warrior and no Hybrid Class]
!!SN:W^Grandmaster_Warrior_Hero%X1^/?y20;
!!VRy99:S0R99;                          [Random Roll]
!!VRy99&y20=1:+1;                       [Double Chance for Grandmaster Ranks]
!!VRy99&y50=1:+1;                       [Double Chance if Battle Commander was active]
!!VRy99&y60=1:+1;                       [Extra chance with 47 Cards of Prophecy]

!!SN:W^161_Class_Artifact_Hero%X1^/?y30;[Check if Artifact has already been given to that Hero]
!!if&y99>=98/y30=0;
!!IF&y3=y4/y3=y5:Q2/8/161/1/z2;         [Show Message with Artifact if current player is interacting player]
!!HEx1:A161;                            [Give Artifact to Hero]
!!SN:W^161_Class_Artifact_Hero%X1^/1;   [Set flag to true if Artifact has already been given to that Hero]
!!FU:E;                                 [Exit so only one artifact is given per battle]
!!en;

!!SN:W^162_Class_Artifact_Hero%X1^/?y30;
!!if&y99>=98/y30=0;
!!IF&y3=y4/y3=y5:Q2/8/162/1/z2;         [Show Message with Artifact]
!!HEx1:A162;                            [Give Artifact to Hero]
!!SN:W^162_Class_Artifact_Hero%X1^/1;   [Set flag to true if Artifact has already been given to that Hero]
!!FU:E;                                 [Exit so only one artifact is given per battle]
!!en;

!!SN:W^169_Class_Artifact_Hero%X1^/?y30;
!!if&y99>=98/y30=0;
!!IF&y3=y4/y3=y5:Q2/8/169/1/z2;         [Show Message with Artifact]
!!HEx1:A169;                            [Give Artifact to Hero]
!!SN:W^169_Class_Artifact_Hero%X1^/1;   [Set flag to true if Artifact has already been given to that Hero]
!!FU:E;                                 [Exit so only one artifact is given per battle]
!!en;
!!en;


*Mage
!!if&y10=0/y11=1/y12=0|y95=4;           [Run if only Mage and no Hybrid Class]
!!SN:W^Grandmaster_Mage_Hero%X1^/?y20;
!!VRy99:S0R99;                          [Random Roll]
!!VRy99&y20=1:+1;                       [Double Chance for Grandmaster Ranks]
!!VRy99&y50=1:+1;                       [Double Chance if Battle Commander was active]
!!VRy99&y60=1:+1;                       [Extra chance with 47 Cards of Prophecy]


!!SN:W^163_Class_Artifact_Hero%X1^/?y30;[Check if Artifact has already been given to that Hero]
!!if&y99>=98/y30=0;
!!IF&y3=y4/y3=y5:Q2/8/163/1/z2;         [Show Message with Artifact]
!!HEx1:A163;                            [Give Artifact to Hero]
!!SN:W^163_Class_Artifact_Hero%X1^/1;   [Set flag to true if Artifact has already been given to that Hero]
!!FU:E;
!!en;

!!SN:W^168_Class_Artifact_Hero%X1^/?y30;[Check if Artifact has already been given to that Hero]
!!if&y99>=98/y30=0;
!!IF&y3=y4/y3=y5:Q2/8/168/1/z2;         [Show Message with Artifact]
!!HEx1:A168;                            [Give Artifact to Hero]
!!SN:W^168_Class_Artifact_Hero%X1^/1;   [Set flag to true if Artifact has already been given to that Hero]
!!FU:E;
!!en;

!!SN:W^165_Class_Artifact_Hero%X1^/?y30;[Check if Artifact has already been given to that Hero]
!!if&y99>=98/y30=0;
!!IF&y3=y4/y3=y5:Q2/8/165/1/z2;         [Show Message with Artifact]
!!HEx1:A165;                            [Give Artifact to Hero]
!!SN:W^165_Class_Artifact_Hero%X1^/1;   [Set flag to true if Artifact has already been given to that Hero]
!!FU:E;
!!en;
!!en;


*Adventurer
!!if&y10=0/y11=0/y12=1|y95=4;           [Run if only Adventurer and no Hybrid Class]
!!SN:W^Grandmaster_Adventurer_Hero%X1^/?y20;
!!VRy99:S0R99;                          [Random Roll]
!!VRy99&y20=1:+1;                       [Double Chance for Grandmaster Ranks]
!!VRy99&y50=1:+1;                       [Double Chance if Battle Commander was active]
!!VRy99&y60=1:+1;                       [Extra chance with 47 Cards of Prophecy]

!!SN:W^164_Class_Artifact_Hero%X1^/?y30;[Check if Artifact has already been given to that Hero]
!!if&y99>=98/y30=0;
!!IF&y3=y4/y3=y5:Q2/8/164/1/z2;         [Show Message with Artifact]
!!HEx1:A164;                            [Give Artifact to Hero]
!!SN:W^164_Class_Artifact_Hero%X1^/1;   [Set flag to true if Artifact has already been given to that Hero]
!!FU:E;
!!en;

!!SN:W^166_Class_Artifact_Hero%X1^/?y30;[Check if Artifact has already been given to that Hero]
!!if&y99>=98/y30=0;
!!IF&y3=y4/y3=y5:Q2/8/166/1/z2;         [Show Message with Artifact]
!!HEx1:A166;                            [Give Artifact to Hero]
!!SN:W^166_Class_Artifact_Hero%X1^/1;   [Set flag to true if Artifact has already been given to that Hero]
!!FU:E;
!!en;

!!SN:W^167_Class_Artifact_Hero%X1^/?y30;[Check if Artifact has already been given to that Hero]
!!if&y99>=98/y30=0;
!!IF&y3=y4/y3=y5:Q2/8/167/1/z2;         [Show Message with Artifact]
!!HEx1:A167;                            [Give Artifact to Hero]
!!SN:W^167_Class_Artifact_Hero%X1^/1;   [Set flag to true if Artifact has already been given to that Hero]
!!FU:E;
!!en;
!!en;


*---------------------------------
!?AE1&1000;                             [Equip Artifact]
!!FU&761:E;
!!if|v998=161/v998=162/v998=169;        [*Warrior Set*]
  !!FU(Count_Set_Pieces_2):P-1/0/0/0/?y90; [Count Set Pieces function X5]          [Count Set Pieces function]
  !!VRy90:+1;
  !!HE-1&y90=3:Fd3/d3/d3/d3;
!!en;


!!if|v998=163/v998=168/v998=165;        [*Mage Set*]
  !!FU(Count_Set_Pieces_2):P-1/0/0/?y90;[Count Set Pieces function X4]          [Count Set Pieces function]
  !!HE-1:A2/165/?y30/?y10;
  !!HE-1&v998=165/y10=1:A-165;
  !!HE-1&v998=165/y10=1:Fd1/d1/d-6/d;
  !!VRy90:+1;
  !!HE-1&v998=165/y10=1/y90=3:Fd-3/d-3/d-3/d-3;
  !!HE-1&y90=3:Fd3/d3/d3/d3;
  !!HE-1&v998=165/y10=1:A165;
!!en;


!!if|v998=164/v998=166/v998=167;        [*Adventurer Set*]
  !!FU(Count_Set_Pieces_2):P-1/0/0/0/0/?y90; [Count Set Pieces function X6]          [Count Set Pieces function]
  !!HE-1:A2/164/?y30/?y10;
  !!HE-1&v998=164/y10=1:A-164;
  !!HE-1&v998=164/y10=1:Fd-1/d/d-1/d;
  !!VRy90:+1;
  !!HE-1&v998=164/y10=1/y90=3:Fd-3/d-3/d-3/d-3;  
  !!HE-1&y90=3:Fd3/d3/d3/d3;
  !!HE-1&v998=164/y10=1:A164;
!!en;


!?AE0&1000;                             [Unequip Artifact]
!!FU&761:E;
!!if|v998=161/v998=162/v998=169;        [*Warrior Set*]
  !!FU(Count_Set_Pieces_2):P-1/0/0/0/?y90; [Count Set Pieces function X5]
  !!VRy90:-1;
  !!HE-1&y90=2:Fd-3/d-3/d-3/d-3;
!!en;

!!if|v998=163/v998=168/v998=165;        [*Mage Set*]
  !!FU(Count_Set_Pieces_2):P-1/0/0/?y90;[Count Set Pieces function X4]
  !!VRy90:-1;
  !!HE-1&y90=2:Fd-3/d-3/d-3/d-3;
!!en;

!!if|v998=164/v998=166/v998=167;        [*Adventurer Set*]
  !!FU(Count_Set_Pieces_2):P-1/0/0/0/0/?y90; [Count Set Pieces function X6]
  !!VRy90:-1;  
  !!HE-1&y90=2:Fd-3/d-3/d-3/d-3;
!!en;
*---------------------------------


****************************************
*Rebalance commander artifacts by removing endless scaling and adding diminishing return scaling
!?FU(OnAfterBattleUniversal);
!!BA:H0/?y1;                            [Attacking Hero]
!!HEy1:O?y9;                            [get owner of this hero]
!!SN:W^Hero_Attacker_Owner0^/?y5;       [get owner from before the battle]
!!FU&y5<>y9:E;                          [Exit if Hero Owner Changed after Battle]
!!FU(ACM_Com_Artifacts_Scaling):Py1;    [run function to set battle wins]

!?FU(ACM_Com_Artifacts_Scaling);
!!re i/0/5; 
  !!COx1:A3/i/?y20/?y21;                [Check artifact and battles won in each slot]
  !!SN&y20=146:W^ACM_Com%X1_Artifact_146^/d1; [146 Axe of Smashing]
  !!SN&y20=147:W^ACM_Com%X1_Artifact_147^/d1; [147 Mithril Mail]
  !!SN&y20=148:W^ACM_Com%X1_Artifact_148^/d1; [148 Sword of Sharpness]
  !!SN&y20=149:W^ACM_Com%X1_Artifact_149^/d1; [149 Helm of Immortality]
  !!SN&y20=150:W^ACM_Com%X1_Artifact_150^/d1; [150 Pendant of Sorcery]
  !!SN&y20=151:W^ACM_Com%X1_Artifact_151^/d1; [151 Boots of Haste]
  !!SN&y20=152:W^ACM_Com%X1_Artifact_152^/d1; [152 Bow of Seeking]
  !!SN&y20=153:W^ACM_Com%X1_Artifact_153^/d1; [153 Dragon Eye Ring]
  !!SN&y20=154:W^ACM_Com%X1_Artifact_154^/d1; [154 Hardened Shield]
  !!SN&y20=155:W^ACM_Com%X1_Artifact_155^/d1; [155 Slava's Ring of Power]
!!en;

!!re i/0/5;                             [loop slots]
  !!re t/146/155;                       [loop artifacts]
    !!COx1:A3/i/?y20/?y21;              [Check artifact and battles won in each slot]
    !!SN:W^ACM_Com%X1_Artifact_%t^/?y1; [artifact ID]
    !!VRy1::2;                          [half the bonus from commander artifacts, meaning they basically scale half as good as before]
    !!COx1&y20=t/y1>y21:A3/i/t/y1;      [If saved won battles is greater than current value set to old value]
  !!en;
!!en;
****************************************


!?FU(OnAfterBattleUniversal);
*Increase Class Set counter
!!BA:H0/?y1;                            [Attacking Hero]
!!HEy1:O?y9;                            [get owner of this hero]
!!SN:W^Hero_Attacker_Owner0^/?y5;
!!FU&y5<>y9:E;                          [Exit if Hero Owner Changed after Battle]
!!FU(Count_Set_Pieces_2):Py1/0/0/?y91/?y90/?y92; [Check for  Sets]

!!HEy1:E?y47/?y48/1;                    [Check hero Level]
!!SN&y90=3:W^Warrior_Set_Count_Hero%Y1^/?y10;
!!SN&y90=3/y10<y48:W^Warrior_Set_Count_Hero%Y1^/d+1; [+1%  if Battle won with Set equipped and value smaller Hero Level]

!!SN&y91=3:W^Mage_Set_Count_Hero%Y1^/?y11;
!!SN&y91=3/y11<y48:W^Mage_Set_Count_Hero%Y1^/d+1; [+1%  if Battle won with Set equipped]

!!SN&y92=3:W^Adventurer_Set_Count_Hero%Y1^/?y12;
!!SN&y92=3/y12<y48:W^Adventurer_Set_Count_Hero%Y1^/d+1; [+1%  if Battle won with Set equipped]


!?FU(OnAfterBattleUniversal);
*Ammo Cart provides +3 SP after every combat and 19 Helm of the Alabaster Unicorn also +3
!!BA:H0/?y1;                            [Attacking Hero]
!!HEy1:O?y9;                            [get owner of this hero]
!!SN:W^Hero_Attacker_Owner0^/?y5;
!!FU&y5<>y9:E;                          [Exit if Hero Owner Changed after Battle]
!!HEy1:A2/5/?y3/?y2;                    [Check if the left hero has Ammo Cart]
!!HEy1:A2/19/?y3/?y4;                   [Check if the left hero has 19 Helm of the Alabaster Unicorn ]
!!FU&y2=0/y4=0:E;                       [Exit if no Ammo Cart and no Helm]
!!FU(Intelligence_Set_Spell_Points)&y1>=0/y1<=155:Py1/0/?y30/1; [Return Max possible spell points for left Hero]
!!HEy1:I?y8/1;
!!VRy9:Sy8;
!!SN:W^Ammo_Replensih_SP_%Y1^/?y11;
!!VRy8&y11=1:+5;                        [+5 Spell Points for Ammo Cart Upgrade]
!!HEy1&y8<y30/y11=1:Id5/1;
!!VRy8&y2=1:+3;                         [+3 Spell Points for Ammo Cart]
!!HEy1&y8<y30/y2=1:Id3/1;
!!VRy8&y4=1:+5;                         [+5 Spell Points for Helm]
!!HEy1&y8<y30/y4=1:Id5/1;
!!HEy1&y8>y30:Iy30/1;
!!HEy1&y9>y30:Iy9/1;


*******************************
!?FU(OnEveryDay)&i^timerDay^>1/i^timerWeekDay^=1; [Trigger each monday]
!!OW:C?y1;
!!DO(AC_Function_44)/0/155/1:Py1;       [Pendant of Total recall]

!?FU(AC_Function_44);
!!HEx16:O?y1;
!!FU&y1<>x1:E;
!!HEx16:A2/107/0/?y2;
!!HEx16:B0/?z-1;
!!SN&y2=1/1000:T^AC_Misc.Pendant_of_Recall^/?z-1;
!!IF&y2=1/1000:Q1/17/1000/1^%Z-1^;
!!HEx16&y2=1:Ed1000;                    [give 1000 experience each week]

*******************************
!?FU(OnCombatRound)&v997=0;             [Combat Start]
*Pendant of Dispassion increases damage by 1 of equipped
!!BA:H0/?y2;                            [Attacker]
!!HEy2:A2/100/0/?y3;                    [100 Pendant of Dispassion]
!!DO(AC_Function_41)/0/20/1&y3>0:P;

!!BA:H1/?y4;                            [Defender]
!!FU&y4<0:E;
!!HEy4:A2/100/0/?y3;                    [100 Pendant of Dispassion]
!!DO(AC_Function_41)/21/41/1&y3>0:P;


!?FU(AC_Function_41);                   [increase Units Stats]
!!BMx16:T?y1;
!!FU|y1=145/y1=146/y1=147/y1=148/y1=149/y1<0:E; [Exit for Warmachines]
!!BMx16:U1/d1;                          [1 Min Damage every fight]
!!BMx16:U2/d1;                          [1 Max Damage every fight]


*******************************
!?BF;                                   [Combat Start]
*103 Pendant of Life +2 HP for all living units
*104 Pendant of Death   +1 Att/Def/Speed for Undead
*13  Shield of the Dwarven Lords +1/+2 life for level 1/2 troops
*15  Buckler of the Gnoll King 

!!BA:H0/?y2;                            [Attacker]
!!HEy2:A2/103/0/?y3 A2/104/0/?y4 A2/13/0/?y5 A2/15/0/?y6 S19/?y10 R4/?y13; [19  Tactics]
!!SN:W^Tactics_enabled^/?y11; !!VRy12:S0; !!VRy12&y10>0/y11=1/y13=1:S1;
!!DO(AC_Function_42)/0/20/1&y3=1:P1;
!!DO(AC_Function_42)/0/20/1&y4=1:P2;
!!DO(AC_Function_42)/0/20/1&y5=1:P3;
!!DO(AC_Function_42)/0/20/1&y6=1:P4/y12;

!!BA:H1/?y2;                            [Defender]
!!FU&y2<0:E;
!!HEy2:A2/103/0/?y3 A2/104/0/?y4 A2/13/0/?y5 A2/15/0/?y6 S19/?y10 R4/?y13; [19  Tactics]
!!SN:W^Tactics_enabled^/?y11; !!VRy12:S0; !!VRy12&y10>0/y11=1/y13=1:S1;
!!DO(AC_Function_42)/21/41/1&y3=1:P1;
!!DO(AC_Function_42)/21/41/1&y4=1:P2;
!!DO(AC_Function_42)/21/41/1&y5=1:P3;
!!DO(AC_Function_42)/21/41/1&y6=1:P4/y12;


!?FU(AC_Function_42);                   [increase Units Stats]
!!BMx16:T?y1;                           [get creature type]
!!FU|y1=145/y1=146/y1=147/y1=148/y1=149/y1<0:E; [Exit for Warmachines]
!!if&x1=1;                              [Alive]
  !!BMx16:F?i;
  !!VRi:&16;                            [just look at alive bit]
  !!BMx16&i>0:Hd2;
!!en;

!!if&x1=2;                              [Undead]
  !!BMx16:F?i;
  !!VRi:&262144;                        [just look at undead bit]
  !!BMx16&i>0:Ad1;
  !!BMx16&i>0:Dd1;
  !!BMx16&i>0:Sd1;
!!en;

!!if&x1=3;                              [Level 1 and level 2 troops]
  !!MA:Ly1/?y2;                         [get level of creature]
  !!BMx16&y2=0:Hd1;                     [add 1 life for level 1 troops]
  !!BMx16&y2=1:Hd2;                     [add 2 life for level 2 troops]
!!en;

!!if&x1=4;                              [Add Magic Mirror to troops for one round]
  !!BMx16&x2=0:M36/1/3;                 [36 Magic Mirror]
  !!BMx16&x2=1:M36/2/3;                 [36 Magic Mirror]
!!en;


*******************************
Life Artifacts +2%, +4%, +6%
94 Ring of Vitality
95 Ring of Life
96 Vial of Lifeblood

!?BF;
!!BA:H0/?y98;
!!HEy98:A2/94/?y1/?y10 A2/95/?y1/?y11 A2/96/?y1/?y12;
!!VRy13:S100;
!!VRy13&y10=1:+2; !!VRy13&y11=1:+4; !!VRy13&y12=1:+6;
!!DO(AC_Function_66)/0/20/1&y13>0:Py13;

!!BA:H1/?y99;
!!FU&y99<0:E;
!!HEy99:A2/94/?y1/?y10 A2/95/?y1/?y11 A2/96/?y1/?y12;
!!VRy13:S100;
!!VRy13&y10=1:+2; !!VRy13&y11=1:+4; !!VRy13&y12=1:+6;
!!DO(AC_Function_66)/21/41/1&y13>100:Py13;

!?FU(AC_Function_66);                   [increase HP by]
!!BMx16:T?y1;
!!FU|y1=145/y1=146/y1=147/y1=148/y1=149:E; [Execlude Warmachines]
!!BMx16:F?i;
!!VRi:&16;                              [just look at alive bit] 262144]
!!if&i>0;
!!BMx16:H?y1;
!!VRy1:*x1:100;
!!BMx16:Hy1;
!!en;
*******************************

!?MF1;
* 102 Pendant of Holiness cast Curse with Attacks
!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676;[Only run when melee or shooting damage]

!!MF:W?y80;
!!FU&y80>0:E;

!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]

!!BG:A?y1;
!!if&y1=6|y1=7;
  !!BG:N?y1;                              [Attacking Stack]
  !!MF:N?y4;                              [damage receiving stack]
  !!SN:W^Holiness_Attacking_Stack^/?y50;
  !!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
  !!SN:W^Holiness_Attacking_Stack^/y4;
  !!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
  !!BA:Hy5/?y99;
  !!FU&y99<0:E;
  !!HEy99:A2/102/0/?y81;                  [100 Pendant of Dispassion]
  !!FU&y81=0:E;
  !!VRy20:S0R99;                          [20% chance to cast curse on Attacks]
  !!BMy4:F?i G42/?y30/?y31;               [Get flag and curse length]
  !!VRi:&262144;                          [just look at undead bit]
  !!if&y20<20/1000/i=0/y30<3;             [Only apply if alive and not already cursed]
    !!BA:Q?j;
    !!BMy4:M42/2/3;                       [Apply curse]
    !!BMy4&j=0/1000:V40;                  [Show Curse Animation]
    !!VRz-1&j=0/1000:S^CURSE^;
    !!SN&j=0/1000:Pz-1;                   [Play Curse Sound if not Quick Comabat]
  !!en;
!!en;
!!en;


!?MF1;
* 102 Pendant of Free Will cast Hypnotize with Attacks
!!UN:C42149568/4/?y10;                  [Physical Damage]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]

!!MF:W?y80;
!!FU&y80>0:E;

!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]

!!BG:A?y1;
!!if&y1=6|y1=7;

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Will_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
!!SN:W^Will_Attacking_Stack^/y4;

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;
!!HEy99:A2/105/?y80/?y81;               [105 Pendant of Free Will]
!!FU&y81=0:E;

!!BG:A?y60;
!!VRy61:S130;
!!VRy61&y60=7:S180;                     [if shooting]
!!VRy20:S0Ry61;                         [5% chance to cast Hypnotize on melee Attacks and 3% at ranged attacks]
!!FU&y20>6:E;

!!BMy4:F?i;                             [Get Monster Flag]
!!VRi:&1024;                            [1024 Mind Spell Immunity]
!!FU&i>0:E;                             [Exit if creature is Mind Immune]

!!BA:Q?f;
!!BMy4:M60/1/3;
!!BMy4&i^battle_isVisible^/1000:V21;                    [Show Hypnotize Animation]
!!VRz-1&i^battle_isVisible^/1000:S^HYPNOTIZ^;
!!SN&i^battle_isVisible^/1000:Pz-1;                     [Play Curse Sound if not Quick Comabat]
!!en;
!!en;


!?MF1;
*Bow of Elven Cherrywood increases any ranged damage by 4*Hero level damage points
!!FU:E;
!!UN:C42149568/4/?y10;                  [Physical Damage]
!!FU&y10<>4455011:E;                    [Shooting Damage]

!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]

!!BG:A?y1;
!!FU&y1<>7:E;

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Cherry_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
!!SN:W^Cherry_Attacking_Stack^/y4;

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;
!!HEy99:A2/60/?y80/?y81;                [60 Bow of Elven Cherrywood]
!!FU&y81=0:E;
!!HEy99:E?y7/?y8/1;
!!MF:F?y6;
!!VRy7:S4*y8+y6;
!!MF:Fy7;


!?MF1;                                  [*Physical Combat *]
*Armor of Wonders reduces any ranged damage by 5+2*HLvL points
!!UN:C42149568/4/?y10;                  [Physical Damage]
!!FU&y10<>4455011:E;                    [Shooting Damage]
!!MF:W?y80;
!!FU&y80>0:E;
!!BG:A?y1;
!!if&y1=7;                              [or Shoot]
  !!MF:N?y4;                            [damage receiving stack]
  !!BMy4:I?y5;                          [Side index as for heroes (0:left, 1:right)]
  !!BA:Hy5/?y99;
  !!FU&y99<0:E;                         [Exit if no Hero]
  !!BMy4:F?y78 T?y7;                    [read flags and creature type]
  !!FU|y7=174/y7=175/y7=176/y7=177/y7=178/y7=179/y7=180/y7=181/y7=182:E; [Exit for att commanders]
  !!FU|y7=183/y7=184/y7=185/y7=186/y7=187/y7=188/y7=189/y7=190/y7=191:E; [Exit for def commanders]
  !!FU|y7=145/y7=146/y7=147/y7=148/y7=149:E; [Exit for warmachines]
  !!VRy78:&4194304;                     [just look summoned bit]
  !!FU&y78>0:E;                         [Exit if cloned or summoned]
  !!HEy99:A2/31/?y3/?y4;                [31 Armor of Wonder]
  !!FU&y4=0:E;                          [Exit if no Shield equipped]
  !!MF:F?y6;                            [Damage Dealt]
  !!HEy99:E?y10/?y8/1;
  !!VRy8:*2+5;                          [Armor Strength 5+2*Hero Level]
  !!if&y8>=y6;
    !!BA:Q?f;
    !!VRz-1&1000:S^CRUSDFND.wav^;       [find block sound]
    !!SN&i^battle_isVisible^:Pz-1;      [play block sound]
    !!MF:E0;
    !!MF:F0;
  !!el;                                 [do if damage is bigger than shield]
    !!VRy7:Sy6-y8;
    !!MF:Fy7;
  !!en;
!!en;


!?MF1;                                  [*Physical Combat *]
*25 Breastplate of Petrified Wood reduces any melee damage by 2*HLvL points
!!UN:C42149568/4/?y10;                  [Physical Damage]
!!FU&y10<>4462398:E;                    [melee Damage]
!!MF:W?y80;
!!FU&y80>0:E;
!!BG:A?y1;
!!if&y1=6;                              [or melee]
  !!MF:N?y4;                            [damage receiving stack]
  !!BMy4:I?y5;                          [Side index as for heroes (0:left, 1:right)]
  !!BA:Hy5/?y99;
  !!FU&y99<0:E;                         [Exit if no Hero]
  !!BMy4:F?i T?y7;                      [read flags and creature type]
  !!FU|y7=174/y7=175/y7=176/y7=177/y7=178/y7=179/y7=180/y7=181/y7=182:E; [Exit for att commanders]
  !!FU|y7=183/y7=184/y7=185/y7=186/y7=187/y7=188/y7=189/y7=190/y7=191:E; [Exit for def commanders]
  !!FU|y7=145/y7=146/y7=147/y7=148/y7=149:E; [Exit for warmachines]
  !!VRi:&4194304;                       [just look summoned bit]
  !!FU&i>0:E;                           [Exit if cloned or summoned]
  !!HEy99:A2/25/?y3/?y4;                [25 Breastplate of Petrified Wood]
  !!FU&y4=0:E;                          [Exit if no Shield equipped]
  !!MF:F?y6;                            [Damage Dealt]
  !!HEy99:E?y10/?y8/1;
  !!VRy8:*2;                            [Armor Strength 2*Hero Level]
  !!if&y8>=y6;
    !!BA:Q?f;
    !!VRz-1&1000:S^CRUSDFND.wav^;       [find block sound]
    !!SN&i^battle_isVisible^:Pz-1;      [play block sound]
    !!MF:E0;
    !!MF:F0;
  !!el;                                 [do if damage is bigger than shield]
    !!VRy7:Sy6-y8;
    !!MF:Fy7;
  !!en;
!!en;


!?MF1;                                  [*Physical Combat *]
16  Targ of the Rampaging Ogre has a small chance to block 50% of the damage

!!VRy1:S0R100;
!!FU&y1>7:E;                            [make a 7 percent chance to work]
!!UN:C42149568/4/?y10;                  [Physical Damage]
!!FU&y10<>4462398:E;                    [melee Damage]
!!MF:W?y80;
!!FU&y80>0:E;
!!BG:A?y1;
!!if&y1=6;                              [or melee]
  !!MF:N?y4;                            [damage receiving stack]
  !!BMy4:I?y5;                          [Side index as for heroes (0:left, 1:right)]
  !!BA:Hy5/?y99;
  !!FU&y99<0:E;                         [Exit if no Hero]
  !!BMy4:F?i T?y7;                      [read flags and creature type]
  !!FU|y7=174/y7=175/y7=176/y7=177/y7=178/y7=179/y7=180/y7=181/y7=182:E; [Exit for att commanders]
  !!FU|y7=183/y7=184/y7=185/y7=186/y7=187/y7=188/y7=189/y7=190/y7=191:E; [Exit for def commanders]
  !!FU|y7=145/y7=146/y7=147/y7=148/y7=149:E; [Exit for warmachines]
  !!VRi:&4194304;                       [just look summoned bit]
  !!FU&i>0:E;                           [Exit if cloned or summoned]
  !!HEy99:A2/16/?y3/?y4;                [25 Targ of the Rampaging Ogre]
  !!FU&y4=0:E;                          [Exit if no Shield equipped]
  !!MF:F?y6;                            [Damage Dealt]
  !!VRy6::2;                            [make 50% of damage]
  !!if&y6>0;
    !!MF:Fy6;                           [apply reduced damage]
    !!VRz-1:S^CRUSDFND.wav^;            [find block sound]
    !!SN&i^battle_isVisible^:Pz-1;      [play block sound]    
    !!SN:T^AC_Misc.Targe_Ramping_Ogre_Block^/?z2/^damage^/y6;
    !!BU&i^battle_isVisible^:Mz2;       [print message in the battle log]
  !!en;
!!en;


!?MF1;
*Blackshard of the Dead Knight deals extra 25+2*HLvL to any living unit
!!FU:E;
!!UN:C42149568/4/?y10;                  [Physical Damage]
!!FU&y10<>4462398:E;                    [Melee Damage]

!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]

!!BG:A?y1;
!!FU&y1<>6:E;

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Blackshard_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
!!SN:W^Blackshard_Attacking_Stack^/y4;

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;
!!HEy99:A2/8/?y80/?y81;                 [8 Blackshard of the Dead Knight]
!!FU&y81=0:E;
!!BMy4:F?i;                             [read flags]
!!VRi:&16;                              [just look alive bit]
!!if&i>0;                               [if alive]
  !!MF:F?y6;
  !!HEy99:E?y10/?y8/1;
  !!VRy8:*2+25;                         [Extra Damage 25+2*Hero Level]
  !!VRy7:Sy6+y8;
  !!MF:Fy7;
!!en;


!?MF1;
*9 Greater Gnoll's Flail deals extra 30+2*HLvL damage to any undead unit
!!FU:E;
!!UN:C42149568/4/?y10;                  [Physical Damage]
!!FU&y10<>4462398:E;                    [Melee Damage]

!!BA:Q?y1;                              [get acting side]
!!FU&y1=1:E;                            [Exit in Quick Combat]
!!BG:A?y1;                              [get action]
!!FU&y1<>6:E;
!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Flail_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
!!SN:W^Flail_Attacking_Stack^/y4;

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;
!!HEy99&y99>=0:A2/9/?y80/?y81;          [9 Greater Gnoll's Flail]
!!FU&y81=0:E;
!!BMy4:F?i;                             [read flags]
!!VRi:&262144;                          [just look undead bit]
!!if&i>0;                               [if undead]
  !!MF:F?y6;
  !!HEy99:E?y10/?y8/1;
  !!VRy8:*2+30;                         [Extra Damage 30+2*Hero Level]
  !!VRy7:Sy6+y8;
  !!MF:Fy7;
!!en;


!?FU(ACM_Event_AfterMeeleDamage);
*Ogre's Club of Havoc gives a 5% chance to stun with melee attacks
                    
!!VRy1:Si^acm_attackStack^;             [Attacker Stack]
!!VRy2:Si^acm_defendStack^;             [Defender Stack]
!!BG:N?y3;                              [currStack]
!!FU&y3<>y1:E;                          [Exit if it is a retaliation because they creatures action is over anyway]

!!BMy1:I?y5;                            [Get Attacking Side]
!!BHy5:N?y6;                            [Get Hero Number by side]
!!FU&y6<0:E;                            [Get Hero from side and exit if no hero]
!!HEy6:A2/10/?y8/?y10; !!FU&y10=0:E;    [check 10 Ogre's Club of Havoc and exit if not equipped]

!!VRy20:S0R99;                          [generate random value]
!!FU&y20>5:E;                           [5 percent chance to stun]

!!BMy2:F?y11 N?y22; 
!!FU&y22<=1:E;                          [Single stacks cannot be stunned. I guess...]
!!VRy11:&16; 
!!FU&y11=0:E;                           [Check flag if creature is living and if not exit. You can only stun living units]
!!BMy2:F?y11;
!!VRy11:&67108864; !!FU&y11>0:E;        [Check if creatures has already acted this round, if yes then exit]
!!BMy2:F?y11;
!!VRy11:|67108864;
!!BMy2:R0 Fy11;                         [Set retaliations to zero and flag to has acted]

!!if&i^battle_isVisible^;
  !!VRy30:S0R5;
  !!VRz2&y30=0:S^wood weapon vs leather01l.wav^; [load sound file]
  !!VRz2&y30=1:S^wood weapon vs leather02m.wav^;
  !!VRz2&y30=2:S^wood weapon vs leather03h.wav^;      
  !!VRz2&y30=3:S^wood vs metal01l.wav^; [load sound file in case hero wears a helmet]
  !!VRz2&y30=4:S^wood vs metal02m.wav^;
  !!VRz2&y30=5:S^wood vs metal03h.wav^;    
  !!SN:Pz2;                             [Play random sound]
  !!BMy2:V49;                           [Show stun animation]
!!en;


!?MF1;
*38 Red Dragon Flame Tongue deals fire damage to any unit with melee attacks, with 50% chance*
!!UN:C42149568/4/?y10;                  [Physical Damage]
!!FU&y10<>4462398:E;                    [Melee Damage]

!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]

!!BG:A?y1;
!!FU&y1<>6:E;

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]

!!SN:W^Tongue_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
!!SN:W^Tongue_Attacking_Stack^/y4;
!!VRy95:S0R1; !!FU&y95=0:E;               [Make a 50/50 coinflip]

!!BMy4:T?y40 F?i;                       [Get Type in y40]
!!VRi:&16384;                           [Check for Immunity vs Fire]
!!FU&i>0:E;                             [Exit if immune vs fire]
!!FU|y40=33/y40=52/y40=53/y40=82/y40=83/y40=114/y40=116/y40=117/y40=121/y40=125:E;
!!FU|y40=129/y40=130/y40=131/y40=155/y40=158/y40=164/y40=195:E;
!!BMy4:G31/?y41/?y42;                   [Get Fire Resistance]
!!FU&y41>0:E;                           [Exit if any Fire Resistance]

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;
!!HEy99:A2/38/?y80/?y81;                [38 Red Dragon Flame Tongue]
!!FU&y81=0:E;
!!HEy99:A2/81/?y10/?y16;                [81 Orb of Tempestuous Fire]
!!HEy99:E?y70/?y71/1;                   [Get Hero Level]
!!VRy71:*2;                             [Level times 2]
!!MF:F?y6;
!!VRy7:S5R100+y71;                      [Add +5-105+2*hero level fire damage]
!!VRy7&y16=1:*2;                        [Double Fire Damage with Orb]
!!VRy8:Sy7+y6;
!!MF:Fy8;
!!BA:Q?f;
!!SN&i^battle_isVisible^/1000:T^AC_Misc.Red Dragon Flame^/?z2/^damage3^/y7;
!!BU&i^battle_isVisible^/1000:Mz2;


!?MF1;
*Complete Dragon Set  burns enemies with melee attacks, burned enemies get damage over time
!!UN:C42149568/4/?y10;                  [Physical Damage]
!!FU&y10<>4462398:E;                    [Melee Damage]

!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]

!!BG:A?y1;
!!FU&y1<>6:E;

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^DragonSet_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
!!SN:W^DragonSet_Attacking_Stack^/y4;

!!BMy4:T?y40 F?i;                       [Get Type in y40]
!!VRi:&16384;                           [Check for Immunity vs Fire]
!!FU&i>0:E;                             [Exit if immune vs fire]
!!FU|y40=33/y40=52/y40=53/y40=82/y40=83/y40=114/y40=116/y40=117/y40=121/y40=125:E;
!!FU|y40=129/y40=130/y40=131/y40=155/y40=158/y40=164/y40=195:E;
!!BMy4:G31/?y41/?y42;                   [Get Fire Resistance]
!!FU&y41>0/y42=3:E;                     [Exit if Expert Fire Resistance]

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;                           [Exit if no Hero]
!!FU(Count_Set_Pieces):Py99/?y90;       [Count Set Pieces function, check for Dragon Set]
!!FU&y90<>6:E;                          [Exit if Set is not complete (6)]

!!HEy99:A2/81/?y10/?y16;                [81 Orb of Tempestuous Fire]
!!MF:F?y6;
!!VRy7:Sy6*25:100;                      [Take 25% of damage dealt]
!!FU&y7=0:E;                            [Exit if not enough damage]
!!BMy4:M21/1/3;                         [apply incinerate to stack]
!!BMy4&y4=0:M21/2/3;                    [fix?]
!!SN:W^Burned_Stack_%Y4^/dy7;           [Add and Stack Damage to the Stack]


!?MF1;
*Chance to Evade/Dodge melee or ranged attacks*
!!UN:C42149568/4/?y10;                  [Physical Damage]
!!if|y10=4462398/y10=4455011/y10=4456676;[Only run when melee or shooting damage]
  !!BG:A?y1;
    !!if|y1=6/y1=7;                     [If Melee or Range]
    !!MF:N?y4;                          [damage receiving stack]
    !!BMy4:I?y5;                        [Monster Side Index]
    !!BA:Hy5/?y99;
    !!FU&y99<0:E;                       [Exit if no valid Hero]
    !!HEy99:A2/97/?y30/?y86;            [97 Necklace of Swiftness]
    !!HEy99:A2/69/?y30/?y87;            [69 Ring of the Wayfarer]
    !!HEy99:A2/99/?y30/?y88;            [99 Cape of Velocity]
    !!FU&y86=0/y87=0:E;                 [Exit if none of both artifacts equipped]
    !!VRy20:S0R100;                     [Generate Random number]
    !!VRy22:S0;
    !!VRy22&y86=1:+4;                   [add 4% chance to dodge per artifact]
    !!VRy22&y87=1:+4;                   [add 4% chance to dodge per artifact]
    !!VRy22&y86=1/y87=1/y88=1:S15;      [add +7% chance to dodge if complete set]
    !!if&y20<=y22;                      [chance is ]
      !!VRz-1:S^AIRSHELD^;
      !!SN&i^battle_isVisible^:Pz-1;
      !!MF:E0;                          [set damage to zero]
      !!MF:F0;                          [set final damage to zero]
      !!SN:T^AC_Misc.Air Dodge^/?z-1;
      !!BU&i^battle_isVisible^:Mz-1;    [show message in log]
    !!en;
  !!en;
!!en;


!?MR1;                                  [*Magical Combat Improvements*]
*Flat Magic damage block from artifacts*
!!BG:S?y2;
!!FU&y2<=10|y2>=26:E;                   [Exit if no damage spell]
!!BG:Q?y1;
!!VRy1:-1 *-1;                          [Get opposite hero]
!!VRy1:F0/1;                            [Number must be in the range of 0 and 1]
!!BHy1:N?y99;                           [Current Hero Number]
!!FU&y99<0:E;                           [Exit if no hero]
!!HEy99:A2/37/?y30/?y86;                [37  Quiet Eye of the Dragon]
!!HEy99:A2/39/?y30/?y87;                [39  Dragon Scale Shield]
!!HEy99:A2/43/?y30/?y88;                [43 Necklace of Dragonteeth]
!!FU&y86=0/y87=0/y88=0:E;
!!VRy11:S0;
!!VRy11&y86=1:+50;                      [+50 magic damage block per artifact]
!!VRy11&y87=1:+50;
!!VRy11&y88=1:+50;
!!MR:F?y10;                             [Get spell damage]
!!FU&y10=0:E;                           [Exit no no damage]
!!VRy10:-y11;                           [Substract the damage]
!!VRy10&y10<=0:S0;                      [Cannot be below zero]
!!MR:Fy10;                              [Apply reduced magic damage]


!?MF1;
*axe of smashing +4 Attack and melee attacks have 10% chance to cripple the target*
!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!FU&y10<>4462398:E;                    [Melee Damage]
!!BG:A?y1; !!FU&y1<>6:E;                [Aktion in y1 Exit if not melee attack]
          
!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^AxeSmash_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
!!SN:W^AxeSmash_Attacking_Stack^/y4;
!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99; !!FU&y99<0:E;            [Get Hero and exit if nonne]
!!HEy99:A2/146/?y30/?y87;               [Check for Axe of smashing]
!!if&y87=1;
  !!VRy10:S0R99;                        [Random value]
  !!FU&y10>=10:E;                       [10% chance to perform a hit]
  !!BMy4&i^battle_isVisible^:V14;
  !!BMy4:Ad-5;                          [Attack -x]
  !!BMy4:Dd-5;                          [Defense -x]
  !!BMy4:Sd-2;                          [Speed -x]
  !!BMy4:A?y20; !!VRy20&y20<=1:S1; !!BMy4:Ay20;
  !!BMy4:D?y21; !!VRy21&y21<=1:S1; !!BMy4:Dy21;
  !!BMy4:S?y22; !!VRy22&y22<=3:S3; !!BMy4:Sy22;
!!en;


!?MF1;
*mithril mail +4 Defense and your level 1 troops receive only 50% damage*
!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676;[Only run when melee or shooting damage]
  !!BG:A?y1;
  !!if|y1=6/y1=7;                       [If Melee or Range]
    !!MF:N?y4;                          [damage receiving stack]
    !!BMy4:I?y5 T?y7;                   [Side index as for heroes (0:left, 1:right)]
    !!BA:Hy5/?y99; !!FU&y99<0:E;        [Get Hero and exit if nonne]
    !!HEy99:A2/147/?y30/?y87;           [get artifact]
    !!FU&y87=0:E;
    !!MA:Ly7/?y8;                       [get monster level]
    !!FU&y8>0:E;                        [Exit if not lvl 1]
    !!MF:F?y6;                          [damage dealt]
    !!VRy10:Sy6:2;                      [Only Half damage]
    !!MF:Fy10;                          [Apply reduced damage]
    !!BA:Q?f;
    !!SN&1000:T^AC_Misc.Mithril_Avoid^/?z-1/^damage^/y10;
    !!BU&i^battle_isVisible^:Mz-1;
  !!en;
!!en;


!?MF1;
*sword of sharpness *+4 Attack and +25% damage vs creatures that have more than 500HP. 
!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676;[Only run when melee or shooting damage]
  !!BG:A?y1;
  !!if|y1=6/y1=7;                       [If Melee or Range]
    !!BG:N?y1;                          [Attacking Stack]
    !!MF:N?y4;                          [damage receiving stack]
    !!SN:W^SwordSharpness_Attacking_Stack^/?y50;
    !!VRy1&y4=y1/y50>=0/y50<=41:Sy50;   [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
    !!SN:W^SwordSharpness_Attacking_Stack^/y4;
    !!BMy1:I?y5;                        [Side index as for heroes (0:left, 1:right)]
    !!BMy4:H?y8;                        [Get HP of attacked creature]
    !!BA:Hy5/?y99; !!FU&y99<0:E;        [Get Hero and exit if nonne]
    !!HEy99:A2/148/?y30/?y87;           [get artifact]
    !!FU|y87=0/y8<500:E;                [Exit if no artifact or]
    !!MF:F?y6;                          [damage dealt]
    !!VRy10:Sy6*125:100;                [+25% damage]
    !!MF:Fy10;                          [Apply increased damage]
    !!VRy11:Sy10-y6;                    [Get the amount of additional damage to display it in the battlelog]
    !!BA:Q?f;
    !!SN&1000:T^AC_Misc.sword_of_sharpness^/?z-1/^damage^/y11;
    !!BU&i^battle_isVisible^:Mz-1;
  !!en;
!!en;


!?MF1;
*Dragon Eye Ring +25% damage versus any Dragon. 
!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676;[Only run when melee or shooting damage]
  !!BG:A?y1;
  !!if|y1=6/y1=7;                       [If Melee or Range]
    !!BG:N?y1;                          [Attacking Stack]
    !!MF:N?y4;                          [damage receiving stack]
    !!SN:W^Dragon_Ring_Attacking_Stack^/?y50;
    !!VRy1&y4=y1/y50>=0/y50<=41:Sy50;   [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
    !!SN:W^Dragon_Ring_Attacking_Stack^/y4;
    !!BMy1:I?y5;                        [Side index as for heroes (0:left, 1:right)]
    !!BMy4:F?y8;                        [Get HP of attacked creature]
    !!VRy8:&2147483648;                 [check for Dragon Flag]    
    !!BA:Hy5/?y99; !!FU&y99<0:E;        [Get Hero and exit if nonne]
    !!HEy99:A2/153/?y30/?y87;           [get artifact]
    !!FU|y87=0/y8=0:E;                  [Exit if no artifact or no dragon]  
    !!MF:F?y6;                          [damage dealt]
    !!VRy10:Sy6*125:100;                [+25% damage]
    !!MF:Fy10;                          [Apply increased damage]
    !!VRy11:Sy10-y6;                    [Get the amount of additional damage to display it in the battlelog]
    !!BA:Q?f;
    !!SN&1000:T^AC_Misc.Dragon_Ring_damage^/?z-1/^damage^/y11;
    !!BU&i^battle_isVisible^:Mz-1;
  !!en;
!!en;


!?MF1;
*Bow of Seeking Range attacks have a 10% chance to cripple the target.
!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!FU&y10<>4455011:E;                    [Shooting Damage]
!!BG:A?y1; !!FU&y1<>7:E;                [Aktion in y1 Exit if not shooting attack]
          
!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99; !!FU&y99<0:E;            [Get Hero and exit if nonne]
!!HEy99:A2/152/?y30/?y87;               [Check for Axe of smashing]
!!if&y87=1;
  !!VRy10:S0R99;                        [Random value]
  !!FU&y10>=10:E;                       [10% chance to perform a hit]
  !!BMy4&i^battle_isVisible^:V14;
  !!BMy4:Ad-5;                          [Attack -x]
  !!BMy4:Dd-5;                          [Defense -x]
  !!BMy4:Sd-2;                          [Speed -x]
  !!BMy4:A?y20; !!VRy20&y20<=1:S1; !!BMy4:Ay20;
  !!BMy4:D?y21; !!VRy21&y21<=1:S1; !!BMy4:Dy21;
  !!BMy4:S?y22; !!VRy22&y22<=3:S3; !!BMy4:Sy22;
!!en;


!?MF1;
*hardened shield +3 Defense and blocks the first strike in combat carried out by the enemy.
!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676;[Only run when melee or shooting damage]
  !!BG:A?y1;
  !!if|y1=6/y1=7;                       [If Melee or Range]
    !!MF:N?y4;                          [damage receiving stack]
    !!BMy4:I?y5;                        [Side index as for heroes (0:left, 1:right)]
    !!BA:Hy5/?y99; !!FU&y99<0:E;        [Get Hero and exit if nonne]
    !!SN:W^Hardened_Shield_Block_%Y5^/?y9;
    !!HEy99:A2/154/?y30/?y87;           [get artifact]
    !!FU|y87=0/y9=0:E;
    !!MF:F?y6; !!FU&y6=0:E;             [damage dealt]
    !!VRy10:Sy6:2;                      [Only Half damage]
    !!MF:Fy10;                          [Apply reduced damage]
    !!SN:W^Hardened_Shield_Block_%Y5^/0;[Deactivate flag so it can only happen once per combat]
    !!BA:Q?f;
    !!SN&1000:T^AC_Misc.Hardened_Shield_Block^/?z-1/^damage^/y10;
    !!BU&i^battle_isVisible^:Mz-1;
  !!en;
!!en;


!?FU(OnCombatRound)&v997=0;
*155  Slava's Ring of Power Increase casts by 1 for all creatures
!!BA:H0/?y1; !!HEy1&y1>=0:A2/155/?y2/?y3;[Check hero and if he has artifact]
!!rei /0/20;                            [Attacker side]
  !!BMi&y3=1:Ed1;                       [Increase casts by 1 if Slavas Ring of Power is equipped]
!!en;

!!BA:H1/?y1; !!FU&y1<0:E; !!HEy1&y1>=0:A2/155/?y2/?y3; [Exit if no hero, Check hero and if he has artifact]
!!rei /21/41;                           [Defender side]
  !!BMi&y3=1:Ed1;                       [Increase casts by 1 if Slavas Ring of Power is equipped]
!!en;


; Replaced by Archer's script
!?MF1; 
!!FU:E;

*Vampire Coate gives 1% life leech to all creatures
*Cloak of the Undead King full set gives 5% life leech
!!UN:C42149568/4/?y10;                  [Physical Damage]
!!if|y10=4462398/y10=4456676;           [Only run when melee or Strikes all round]
  !!BG:A?y1; !!FU&y1<>6:E;              [Exit if not melee]
  !!BG:N?y1;                            [Attacking Stack]
  !!MF:N?y4;                            [damage receiving stack]
  !!SN:W^Vampire_Cowl_Attacking_Stack^/?y50;
  !!VRy1&y4=y1/y50>=0/y50<=41:Sy50;     [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
  !!SN:W^Vampire_Cowl_Attacking_Stack^/y4;
  !!BMy4:F?y36;                         [Get Flag of damage receiving stack]
  !!VRy36:&16;                          [Check Alive bit of creature]
  !!FU&y36=0:E;                         [Exit if no alive stack]
  !!BMy1:T?y2 H?y6 L?y7 B?y8 N?y9;      [Creature Type]
  !!FU&y8=0:E;
  !!FU&y6=0:E;
  !!FU&y6=y9/y7=0:E;                    [Exit if monster was not damaged]
  !!FU|y2=146/y2=147/y2=148/y2=149:E;   [Exit for Warmachines or Towers]
  !!BG:H?y5;                            [Get Hero]
  !!FU&y5<0:E;                          [Exit if no Hero]

  !!HEy5:A2/55/?y40/?y41; !!FU&y41=0:E; [Check for 55 Vampire's Cowl]
  !!MF:F?y80;                           [Get damage]
  !!FU&y80<=0:E;

  !!BMy1:N?y71 H?y2 L?y3 B?y4;          [Get Battle Monsters parameters]
  !!FU&y4=0:E;
  !!FU&y2=0:E;
  !!FU&y71=y4/y3=0:E;                   [Exit if monster was not damaged]
  !!VRy10:Sy80;
  !!HEy5:A2/54/?y40/?y41;               [54  Amulet of the Undertaker]
  !!HEy5:A2/55/?y40/?y42;               [55 Vampire's Cowl]
  !!HEy5:A2/56/?y40/?y43;               [56  Dead Man's Boots]
  !!VRy44:S0;
  !!VRy44&y42=1:S1;                     [1% leech]
  !!VRy44&y41=1/y42=1/y43=1:S5;         [5% leech with full set bonus]
  !!VRy10:*y44:100;                     [Calc leech amount aka HEAL]
  !!FU&y10<=0:E;

  !!VRy12:Sy10 %y2;                     [Divide Amount of Heal durch HP]
  !!VRy15:Sy3;                          [Set to lost life]
  !!VRy15:Sy15-y12;                     [Lost life - difference from Heal]
  !!VRy16:Sy15;
  !!VRy11:Sy10:y2;                      [Number of possible Revives]

  !!if&y12>=y3;                         [Calc correct rest life]
    !!VRy16:*-1;
    !!VRy17:Sy2;
    !!VRy17:-y16;
    !!VRy16:Sy17;
    !!VRy11:+1;                         [Add 1 creature for correct rest life]
  !!en;

  !!VRy70:Sy71+y11;                     [Total Number after attack]
  !!VRy16&y70>y4:S0;                    [Fix for Commander, Set lost life to zero if could heal more than 1 stack above maximum]
  !!VRy70&y70>=y4:Sy4;                  [Set Number Cannot be more than before fight]
  !!BMy1:Ny70 Ly16;                     [Heal happens Set Number and apply rest life]

  !!BMy1&i^battle_isVisible^:V74;                  [Show leech animation on stack]
  !!VRz1&1000:S^DRAINLIF^;
  !!SN&i^battle_isVisible^:Pz1;                    [Play leech sound]
!!en;


// All the Drain effects, including Vampire commander class and artifacts (Vampire Cowl and Cloak of the Undead King)
; by Archer30
; This script should be executed as late as possible to obtain the latest damage for draining
!?FU(ACM_OnBeforeMelee);
!#VA(atkStack:x) (defStack:x);

!!VRi^acm_drainPercent^:S0;
!!VRi^acm_drainHp^:S0;

; Exit if somethng kills the attacker
!!BM(atkStack):N?(atkNum:y);
!!FU&(atkNum)<=0:E;

; Check if it is possible to drain
; It cannot be a creature that can drain by default (like Vampires), here we check with function from WoG Scripts - Emerald Tower
!!BM(atkStack):T?(atkType:y);
!!FU(WOG_44_CheckIfMonDrainsLife):P(atkType)/?(result:y);
!!FU&(result):E;

!!VR(drainPercent:y):S0;

; It can be troops with draining artifacts (Vampire's Coul or the full Cloak of the Undead King set)
!!FU(ACM_GetActualStackSide):P(atkStack)/?(actualAtkSide:y);

!!if&i^battle_hero_%(actualAtkSide)^>(NO_HERO);
  !!HEi^battle_hero_%(actualAtkSide)^:A2/(ART_VAMPIRES_COWL)/?(has:y)/?(equipped:y);

  !!if&(equipped)>0;
    !!VR(drainPercent):+1;
    !!HEi^battle_hero_%(actualAtkSide)^:A2/(ART_AMULET_OF_THE_UNDERTAKER)/?(has:y)/?(equipped2:y);
    !!HEi^battle_hero_%(actualAtkSide)^:A2/(ART_DEAD_MANS_BOOTS)/?(has:y)/?(equipped3:y);
    !!VR(drainPercent)&(equipped2)>0/(equipped3):+4;
  !!en;
!!en;

; It can be a commander with Vampire class
!!if&(atkType)>=(MON_COMMANDER_FIRST_A)/(atkType)<=(MON_COMMANDER_LAST_D);
  !!BM(atkStack):I?(atkSide:y);

  !!if&i^battle_hero_%(atkSide)^>(NO_HERO);
    !!FU(Check_Com_Masteries):Pi^battle_hero_%(atkSide)^/?(masteryActivated:y)/0/0/?(comClass:y);
    !!VR(drainPercent)&(comClass)=19:+25;
  !!en;
!!en;

!!VRi^acm_drainPercent^&(drainPercent)>0:S(drainPercent);

!?FU(OnMonsterPhysicalDamage)&i^acm_drainPercent^>0;
; Exit if not direct melee or strike all around
!!UN:C42149568/(UNC_INT)/?(dmgType:y);
!!FU&(dmgType)<>4456676/(dmgType)<>4462398:E;

; Exit if the damage is not ideal
!!MF:F?(finalDmg:y);
!!FU&(finalDmg)<=0:E;

; Get the attacker/defender stack
!!MF:N?(defStack:y);

; Exit if not possible to drain due to not alive
!!BM(defStack):F?(defFlags:y);
!!VR(isAlive:y):S(defFlags) &(MON_FLAG_ALIVE);
!!FU&(isAlive)=(FALSE):E;

; compatibility with TUM Reborn - special creatures/artifact to prevent drain even if alive
!!if&i^tum_reborn_on^;
  !!BM(defStack):T?(defType:y);
  !!FU(tum_CheckIfMonIsImmuneToCreatureEffects):P(defType)/?(result:y);
  !!FU&(result):E;

  !!BM(defStack):I?(defSide:y);

  !!if&i^battle_hero_%(defSide)^>(NO_HERO);
    !!HEi^battle_hero_%(defSide)^:A2/286/?(has:y)/?(equipped:y); [Tri Colour Scepter]

    !!FU&(equipped)>0:E;
  !!en;
!!en;

; Calculatte drain hp
!!VR(drainHp:y):S(finalDmg) *i^acm_drainPercent^ :100;
!!VRi^acm_drainHp^&(drainHp)>0:+(drainHp);

!?FU(ACM_OnAfterMelee)&i^acm_drainHp^;
!#VA(atkStack:x) (defStack:x);

!!VR(drainHp:y):Si^acm_drainHp^;
!!VRi^acm_drainHp^:S0;
!!VRi^acm_drainPercent^:S0;

; Exit if the attacking stack is dead
!!BM(atkStack):N?(atkNum:y);
!!FU&(atkNum)<=0:E;

; Drain - if not full
!!FU(ACM_HealAndReviveStack):P(atkStack)/(drainHp)/?(reviveNum:y)/?(actualRegenHp:y);
!!FU&(actualRegenHp)<=0:E;

; Cosmetics
!!if&i^battle_isVisible^;
  ; Battle log
  ; First part - The @atkMon@ drain @num@ life from the @defMon@.
  !!BM(atkStack):T?(atkType:y);
  !!VR(atkIsPlural:y):S(atkNum) -1 B;
  !!SN:H^monname^/(atkType)/(atkIsPlural)/?(atkName:z);
  !!BM(defStack):T?(defType:y) N?(defNum:y);
  !!VR(defIsPlural:y):S(defNum) -1 B;
  !!SN:H^monname^/(defType)/(defIsPlural)/?(defName:z);
  !!SN:T^AC_Misc.Drain_%(atkIsPlural)^/?(battleLog:z)/^atkMon^/(atkName)/^defMon^/(defName)/^num^/(actualRegenHp);
  ; Second part - \n and @num@ rise from the dead.
  !!if&(reviveNum)>0;
    !!VR(isPlural:y):S(reviveNum) -1 B;
    !!SN:T^AC_Misc.Drain_Rise_%(isPlural)^/?(battleLogEnd:z)/^num^/(reviveNum);
    !!VR(battleLog):+(battleLogEnd);
  !!en;

  !!MM:S(battleLog);
  
  ; Sound
  !!SN:P^DRAINLIF^;
  ; Animation
  !!BM(atkStack):V74;
!!en;

!?FU(ACM_HealAndReviveStack);
!#VA(stack:x);                          [Stack Id]
!#VA(regenHp:x);                        [Amount of HP regen]
!#VA(reviveNum:x);                      [Out. Number of creature revived]
!#VA(actualRegenHp:x);                  [Out. Actual amount of HP regenerated. By default this equals to regen Hp unless the stack is neally full]
!#VA(mustRevive:x);                     [OPT. Activate the effect only when it's possible to revive at least one (like the limit of Archangel spell). FALSE means not limited]

; Initialise vars
!!FU:A?(numArgs:y);
!!VR(mustRevive)&(numArgs)<5:S(FALSE);

!!VR(reviveNum):S(FALSE);
!!VR(actualRegenHp):S(regenHp);

; Calculations
!!BM(stack):H?(hp:y) L?(lostHp:y) N?(num:y) B?(initNum:y);

; Exit if the heal amount is no bigger than the HP of one unit if it's set to Must Revive mode
!!FU&(regenHp)<(hp)/(mustRevive):E;

!!VR(totalCurrHp:y):S(hp) *(num) -(lostHp);
!!VR(totalInitHp:y):S(hp) *(initNum);

; Exit if it overflows
!!FU|(totalCurrHp)<=0/(totalInitHp)<=0:E;

; Exit if nothing to heal
!!if&(totalInitHp)<=(totalCurrHp);
  !!VR(actualRegenHp):S0;
  !!FU:E;
!!en;

!!VR(totalLostHp:y):S(totalInitHp) -(totalCurrHp);
!!VR(totalNewHp:y):S(totalCurrHp) +(regenHp);

; Fix overflows
!!VR(totalNewHp)&(totalNewHp)<(totalCurrHp):S(totalInitHp);
; Deal with overheal
!!if&(totalNewHp)>(totalInitHp);
  !!VR(overhealHp:y):S(totalNewHp) -(totalInitHp);
  !!VR(actualRegenHp):S(regenHp) -(overhealHp);
  !!VR(totalNewHp):S(totalInitHp);
!!en;

; Calculate new stats
!!VR(newNum:y):S(totalNewHp) :(hp);
!!VR(newCurrHp:y):S(totalNewHp) %(hp);

!!if&(newCurrHp)=0;
  !!VR(newCurrHp):S(hp);
!!el;
  !!VR(newNum):+1;
!!en;

!!VR(newLostHp:y):S(hp) -(newCurrHp);
!!VR(reviveNum):S(newNum) -(num);

; Set up new stack stats
!!BM(stack):N(newNum) L(newLostHp);


!?AE1&v998=146; Equip Artifact  !!FU&761:E;
!!HE-1:Fd4/d/d/d;                       [axe of smashing +4]
!?AE0&v998=146; Unequip Artifact   !!FU&761:E;
!!HE-1:Fd-4/d/d/d;                      

!?AE1&v998=147; Equip Artifact  !!FU&761:E;
!!HE-1:Fd/d4/d/d;                       [mithril mail +4 defense]
!?AE0&v998=147; Unequip Artifact   !!FU&761:E;
!!HE-1:Fd/d-4/d/d; 

!?AE1&v998=154; Equip Artifact  !!FU&761:E;
!!HE-1:Fd/d3/d/d;                       [hardened shield +3 defense]
!?AE0&v998=154; Unequip Artifact   !!FU&761:E;
!!HE-1:Fd/d-3/d/d; 

!?AE1&v998=148; Equip Artifact  !!FU&761:E;
!!HE-1:Fd4/d/d/d;                       [sword of sharpness +4 attack]
!?AE0&v998=148; Unequip Artifact   !!FU&761:E;
!!HE-1:Fd-4/d/d/d;  

!?AE1&v998=149; Equip Artifact  !!FU&761:E;
!!HE-1:Fd1/d1/d1/d1;                    [helm of immortality +1 to all]
!?AE0&v998=149; Unequip Artifact   !!FU&761:E;
!!HE-1:Fd-1/d-1/d-1/d-1;  

!?AE1&v998=151; Equip Artifact  !!FU&761:E;
!!HE-1:Fd/d/d3/d;                       [boots of haste +3 Spell Power]
!?AE0&v998=151; Unequip Artifact   !!FU&761:E;
!!HE-1:Fd/d/d-3/d; 

!?AE1&v998=155; Equip Artifact  !!FU&761:E;
!!HE-1:Fd/d/d3/d;                       [slava's ring of power +3 Spell Power]
!?AE0&v998=155; Unequip Artifact   !!FU&761:E;
!!HE-1:Fd/d/d-3/d;  

!?AE1&v998=152; Equip Artifact  !!FU&761:E;
!!HE-1:Fd3/d/d/d;                       [Bow of Seeking +3 attack]
!?AE0&v998=152; Unequip Artifact   !!FU&761:E;
!!HE-1:Fd-3/d/d/d; 


****************************************************************************************************
* Aura of Command for Commanders
*all creatures standing next to the aura gain certain bonuses*

The script loops through all battlefield positions (after every battle action) and checks if the monsters standing at that positions are next to a Commander. 
If yes bonus is given. After that the script loops after every battle action trough all monsters on the battlefield and checks if they are still standing next to the Commander, 
if no the bonus is removed.

!?FU(OnCombatRound)&v997=0;             [Before every battle resets variables]
*Set condition to give Aura and select creature ID

!!SN:W^ACM_Aura_of_Command_Attacker_Active^/-1; [Initialize variables]
!!SN:W^ACM_Aura_of_Command_Defender_Active^/-1;
!!VRy10:S0; !!VRy20:S0;

!!BA:H0/?y1;                            [Attacker Hero]
!!HEy1&y1>=0:A2/149/?y5/?y10;           [Check 149 Helm of Immortality Attacker]
!!SN:W^Commander_Leader_%Y1^/?y11;      [Check Commander Class]
!!SN:W^Commander_%Y1_Ancient_Leader^/?y12; [Check for Ancient Leader Commander]

!!BA:H1/?y2;                            [Defender Hero]
!!HEy2&y2>=0:A2/149/?y5/?y20;           [Check 149 Helm of Immortality Defender]
!!SN:W^Commander_Leader_%Y2^/?y21;      [Check Commander Class]
!!SN:W^Commander_%Y1_Ancient_Leader^/?y12; [Check for Ancient Leader Commander]

!!re i/0/41;                            [Loop Battle Stacks]
    !!BMi:T?y4;
    !!if&y4>=174/y4<=182;               [Attacker]
      !!SN|y10=1/y11=1/y12=1:W^ACM_Aura_of_Command_Attacker_Active^/y4; [If Leader Class or Helm of Immortality set Aura active for Attacker. Holds Creature ID]
      !!FU(Check_ACM_Aura_of_Command)|y10=1/y11=1:P1/y4/0/y1; [Run function to give bonus, pass 1 to show animation on units, pass current Battle Side]
    !!en;
    !!if&y4>=183/y4<=191;               [Defender]
      !!SN|y20=1/y21=1/y22=1:W^ACM_Aura_of_Command_Defender_Active^/y4; [If Leader Class or Helm of Immortality set Aura active for Defender. Holds Creature ID]
      !!FU(Check_ACM_Aura_of_Command)|y20=1/y21=1:P1/y4/1/y2; [Run function to give bonus, pass 1 to show animation on units, pass current Battle Side]
    !!en;
    !!SN:W^ACM_Aura_of_Command_Stack_%i^/0; [Reset at Battle Start]
!!en;


!?FU(OnBeforeBattleAction); 
!!BG:Q?y1 H?y3;
!!SN&y1=0:W^ACM_Aura_of_Command_Attacker_Active^/?y2;
!!SN&y1=1:W^ACM_Aura_of_Command_Defender_Active^/?y2;
!!FU(Check_ACM_Aura_of_Command)&y2>=0:P0/y2/y1/y3; [Run function to give bonus, pass 0 to avoid animation on units and pass creature ID that emits aura, and battleside]

!?FU(OnAfterBattleAction); 
!!BG:Q?y1 H?y3;
!!SN&y1=0:W^ACM_Aura_of_Command_Attacker_Active^/?y2;
!!SN&y1=1:W^ACM_Aura_of_Command_Defender_Active^/?y2;
!!FU(Check_ACM_Aura_of_Command)&y2>=0:P0/y2/y1/y3; [Run function to give bonus, pass 0 to avoid animation on units and pass creature ID that emits aura, and battleside]

!?FU(Check_ACM_Aura_of_Command); 
!!BG:Q?f;                               [Quick Combat flag]
!!FU&f=1:E;                             [Exit in quick combat]
!!FU|x2<=0:E;                           [Exit if no valid Creature]
!!FU(Check_Com_Masteries):Px4/?y40/?y42/0/?y41/0/0/0/0/0/0/0/?y43; [Pass Hero Number and return if Commander Mastery is enabled, and current kill count]

!!VRy50:S-4;                            [Attack and Defense Bonus from Aura]
!!VRy51:S-2;                            [Speed Bonus from Aura]
!!VRy50:*y43:100;                       [Apply Modifier to Aura]
!!VRy51:*y43:100;

!!re y1/0/41;                           [Reset the speed and flag every combat action]
    !!SN:W^ACM_Aura_of_Command_Stack_%Y1^/?y2;
    !!BMy1&y2=1:Ady50 Ddy50 Sdy51;      [Reduced parameter again]
    !!SN&y2=1:W^ACM_Aura_of_Command_Stack_%Y1^/0;
!!en;

!!VRy50:*-1;                            [make value positive again]
!!VRy51:*-1;                            [make value positive again]

!!re y1/0/186;                          [Loop all battlefield positions]
!!BU:Ey1/?y4;                           [Check if create stands on this hex]
    !!if&y4>=0;                         [if a monster is at a given position]
    !!BMy4:T?y10 P?y11 I?y12 B?y13 N?y14 H?y15 F?y16; [Get Creature Type and Position]
        !!if&y13>=1/y14>=1/y15>=1/y10<>145/y10<>146/y10<>147/y10<>148/y10<>149/y10<>x2; [If any valid creature, execlude Warmachines]
            !!re i/0/5;                 [loop around the creatures in cirlce 0-6 positions]
            !!FU(ACM_Calc_neighbouring_hex_2):Py1/i/?y3; [Pass position and return first neighbouring hex field]
            !!BU&y3>=0/y3<=186:Ey3/?y5; [Check if create stands on this hex]
            !!BMy5&y5>=0/y5<=41:I?y6 T?y20 S?y7; [Get the creatures side and speed and type]
            !!SN&y5>=0/y5<=41:W^ACM_Aura_of_Command_Stack_%Y4^/?y8; [Check creature bravery flag]
               !!if&y5>=0/y5<=41/x3=y12/y7>=1/y20=x2/y8=0; [If creature is Commander, belongs to same hero and has speed >1 and does not have bonus]
                    !!BMy4:Ady50 Ddy50 Sdy51; [increase speed by +3 Att and Def +5]
                    !!BMy4&x1=1:V20;    [Show animation on the first round]
                    !!SN:W^ACM_Aura_of_Command_Stack_%Y4^/1; [Set flag to true for creature to remember that bonus was given]
                !!en;

            *Start a second iteration to make the Aura 2hex wide if Master from Commander leader is enabled*
            !!if&y40=1/y41=6;           [With Mastery make the Aura 2 hex wide]
              !!re r/0/5;               [loop around the creatures in cirlce 0-6 positions]
              !!FU(ACM_Calc_neighbouring_hex_2):Py3/r/?y30; [Pass position and return first neighbouring hex field]
              !!BU&y30>=0/y30<=186:Ey30/?y5; [Check if create stands on this hex]
              !!BMy5&y5>=0/y5<=41:I?y6 T?y20 S?y7; [Get the creatures side and speed and type]
              !!SN&y5>=0/y5<=41:W^ACM_Aura_of_Command_Stack_%Y4^/?y8; [Check creature bravery flag]
                 !!if&y5>=0/y5<=41/x3=y12/y7>=1/y20=x2/y8=0; [If creature is Commander, belongs to same hero and has speed >1 and does not have bonus]
                      !!BMy4:Ady50 Ddy50 Sdy51; [increase speed by +3 Att and Def +5]
                      !!BMy4&x1=1:V20;  [Show animation on the first round]
                      !!SN:W^ACM_Aura_of_Command_Stack_%Y4^/1; [Set flag to true for creature to remember that bonus was given]
                  !!en;                
              !!en;
            !!en;
            !!en;
        !!en;
    !!en;
!!en;

*!re y1/0/41;
    *!SN:W^ACM_Aura_of_Command_Stack_%Y1^/?y2;
    *!BMy1&y2=1:F?y3;
    *!VRy3&y2=1:&131072;                [just look at no morlae bit]
    *!BMy1&y3=0/y2=1:G212/d1/d;         [Increase +1 Morale]
*!en;

!?FU(ACM_Calc_neighbouring_hex_2);      [Funktion to calculate neighbouring Hex cells]
!!UN:C6919200/4/?y1;                    [Y1 = combatManager]
!!VRx2:*2;
!!VRx1:*12+ y1+ 78952+ x2;
!!UN:Cx1/2/?x3;


****************************************************************************************************



****************************************************************************************************
Commander Masteries 
*Masteries are given if the kill count is above 50% of the maximum possible kill count

!?FU(Check_Com_Masteries); 
x1= Hero Number,
x2= Mastery Enabled(1) or Disabled (0)
x3= current kill count
x4= max kill count, 
x5= current Commander Class (0 or 1-29)
x6= Attack modifier for Commander
x7= Defense modifier for Commander
x8= Damage modifier for Commander
x9= Health modifier for Commander
x10= Speed modifier for Commander
x11= Spell Damage modifier for Commander
x12= Passive modifier for Commander
x13= Aura modifier for Commander
x14= Fix Speed modifier
x15= Pass Desired Class (1-9) to get basic stats
x16= 1 or 0, if 1 you can get different set of parameters from that function, for now with x16=1 you can call MR D and MR G type of commander

!!VRx2:S0; !!VRx3:S0; !!VRx4:S0; !!VRx5:S0; !!VRx6:S0; !!VRy40:S0; !!VRy20:S1; [Initialize]

!!SN:W^Commander_Fighter_%X1^/?y1; !!VRy40&y1=1:S1; [y40 holds commander class 1-9]
!!SN:W^Commander_Ranger_%X1^/?y1; !!VRy40&y1=1:S2;
!!SN:W^Commander_Defender_%X1^/?y1; !!VRy40&y1=1:S3;
!!SN:W^Commander_Caster_%X1^/?y1; !!VRy40&y1=1:S4;
!!SN:W^Commander_Supporter_%X1^/?y1; !!VRy40&y1=1:S5;
!!SN:W^Commander_Leader_%X1^/?y1; !!VRy40&y1=1:S6;
!!SN:W^Commander_Scout_%X1^/?y1; !!VRy40&y1=1:S7;
!!SN:W^Commander_Undead_%X1^/?y1; !!VRy40&y1=1:S8;
!!SN:W^Commander_FireMage_%X1^/?y1; !!VRy40&y1=1:S9;

!!SN:W^Commander_Dragonslayer_%X1^/?y1; !!VRy40&y1=1:S11; [y40 holds commander class 11-19]
!!SN:W^Commander_Sniper_%X1^/?y1; !!VRy40&y1=1:S12;
!!SN:W^Commander_Retaliator_%X1^/?y1; !!VRy40&y1=1:S13;
!!SN:W^Commander_ArchMage_%X1^/?y1; !!VRy40&y1=1:S14;
!!SN:W^Commander_Constructor_%X1^/?y1; !!VRy40&y1=1:S15;
!!SN:W^Commander_King_%X1^/?y1; !!VRy40&y1=1:S16;
!!SN:W^Commander_Prospector_%X1^/?y1; !!VRy40&y1=1:S17;
!!SN:W^Commander_Lich_%X1^/?y1; !!VRy40&y1=1:S18;
!!SN:W^Commander_Vampire_%X1^/?y1; !!VRy40&y1=1:S19;

!!SN:W^Commander_Paladin_%X1^/?y1; !!VRy40&y1=1:S21; [y40 holds commander class 21-29]
!!SN:W^Commander_Marksmen_%X1^/?y1; !!VRy40&y1=1:S22;
!!SN:W^Commander_Avenger_%X1^/?y1; !!VRy40&y1=1:S23;
!!SN:W^Commander_Warden_%X1^/?y1; !!VRy40&y1=1:S24;
!!SN:W^Commander_Arcanist_%X1^/?y1; !!VRy40&y1=1:S25;
!!SN:W^Commander_General_%X1^/?y1; !!VRy40&y1=1:S26;
!!SN:W^Commander_Lancer_%X1^/?y1; !!VRy40&y1=1:S27;
!!SN:W^Commander_Necromant_%X1^/?y1; !!VRy40&y1=1:S28;
!!SN:W^Commander_Ancient_%X1^/?y1; !!VRy40&y1=1:S29;

!!VRy40&x15>0/x15<30:Sx15;              [If you want to display default class values you can pass the class (1-9) to the function]

!!SN:W^Commander_Kill_Counter_%X1^/?y10;[Get number of total kills from commander]
!!VRy14:Sy10:5;                         [Generate 0,2% steps]
!!VRy13:Sy10:4;                         [Generate 0,25% steps]
!!VRy11:Sy10:2;                         [Generate 0,5% steps]
!!VRy12:Sy10*2;                         [Generate 2% steps]

!!COx1&x1>=0/x1<=155:X2/?y20;           [Get commander Level]
!!VRy21:Sy20*2;                         [Two times commander level]

!!VRy99:Sy20*3+17;                      [Set the maximum kill counter for the commander to 3*Com_Lvl+17]
!!VRy50:Sy99:2;                         [For Mastery you need 50% of max kills]

!!if&y40=29;
  !!VRy99:S9999;                        [Set the maximum kill counter for the Ancient commander to 9999]
  !!VRy50:S100;                         [For Mastery you need 100 kills]
!!en;

!!VRx2&y10>y50:S1;                      [Set x2 to 1 if Kill count > half max count]
!!VRx3:Sy10;                            [Returns current kill count]
!!VRx5:Sy40;                            [Returns current commander class, 0 means no class]


*Setting commander parameters, all modifieres start at 100% and are changed by the commander class*
All changes to these parameters should be done here. Values can be called anytime. If x16=1 returns different set of parameters.
!!VRy50:S100; !!VRy51:S100; !!VRy52:S100; !!VRy53:S100;!!VRy54:S100; !!VRy55:S100; !!VRy56:S100; !!VRy57:S100; !!VRy58:S0; !!VRy59:S0; !!VRy60:S5; 

---
!!if&y40=1;                             [Commander_Fighter]
  !!VRy50:S100; Attack !!VRy51:S70; Defense           !!VRy52:S120+y10; Damage !!VRy53:S90; [Health]
  !!VRy54:S100; Speed  !!VRy55:S60; Spell Damage !!VRy56:S60; Passive      !!VRy57:S50; [Aura] !!VRy58:S-1; [Const Speed]
  !!VRy59:S0; [MR Dwarf] !!VRy60:S5;    [MR Golem]
  !!VRy71&x16=1:S40; Upgrade to Dragonslayer !!VRy72&x16=1:S41; [Upgrade to Paladin]
!!en;

    !!if&y40=11;                        [Commander_Dragonslayer]
      !!VRy50:S100; Attack !!VRy51:S70; Defense           !!VRy52:S150; Damage !!VRy53:S90; [Health]
      !!VRy54:S90; Speed  !!VRy55:S70; Spell Damage !!VRy56:S70; Passive      !!VRy57:S60; [Aura] !!VRy58:S-1; [Const Speed]
      !!VRy59:S10; [MR Dwarf] !!VRy60:S15; [MR Golem]
    !!en;

    !!if&y40=21;                        [Commander_Paladin]
      !!VRy50:S100; Attack !!VRy51:S80; Defense           !!VRy52:S140; Damage !!VRy53:S100; [Health]
      !!VRy54:S85; Speed  !!VRy55:S80; Spell Damage !!VRy56:S50; Passive      !!VRy57:S70; [Aura] !!VRy58:S-1; [Const Speed]
      !!VRy59:S15; [MR Dwarf] !!VRy60:S10; [MR Golem]
    !!en;

---
!!if&y40=2;                             [Commander_Ranger]
  !!VRy50:S120+y11; Attack !!VRy51:S75; Defense           !!VRy52:S100; Damage !!VRy53:S90; [Health]
  !!VRy54:S100; Speed      !!VRy55:S75; Spell Damage !!VRy56:S75; Passive  !!VRy57:S50; [Aura] !!VRy58:S-1; [Const Speed]
  !!VRy59:S0; [MR Dwarf] !!VRy60:S5;    [MR Golem]
  !!VRy71&x16=1:S42; Upgrade to Sniper !!VRy72&x16=1:S43; [Upgrade to Marksman]
!!en;

  !!if&y40=12;                          [Commander_Sniper]
    !!VRy50:S145; Attack !!VRy51:S70; Defense           !!VRy52:S110; Damage !!VRy53:S80; [Health]
    !!VRy54:S90; Speed      !!VRy55:S60; Spell Damage !!VRy56:S75; Passive  !!VRy57:S50; [Aura] !!VRy58:S1; [Const Speed]
    !!VRy59:S5; [MR Dwarf] !!VRy60:S10; [MR Golem]
  !!en;

  !!if&y40=22;                          [Commander_Marksman]
    !!VRy50:S135; Attack !!VRy51:S80; Defense           !!VRy52:S65; Damage !!VRy53:S80; [Health]
    !!VRy54:S90; Speed      !!VRy55:S60; Spell Damage !!VRy56:S75; Passive  !!VRy57:S50; [Aura] !!VRy58:S0; [Const Speed]
    !!VRy59:S5; [MR Dwarf] !!VRy60:S10; [MR Golem]
  !!en;

---
!!if&y40=3;                             [Commander_Defender]
  !!VRy50:S85; Attack !!VRy51:S120+y11; Defense      !!VRy52:S80; Damage !!VRy53:S110+y13; [Health]
  !!VRy54:S90; Speed  !!VRy55:S75; Spell Damage !!VRy56:S90; Passive !!VRy57:S50; [Aura] !!VRy58:S+1; [Const Speed]
  !!VRy59:S10; [MR Dwarf] !!VRy60:S20;  [MR Golem]
  !!VRy71&x16=1:S44; Upgrade to Retaliator !!VRy72&x16=1:S45; [Upgrade to Avenger]
!!en;

  !!if&y40=13;                          [Commander_Retaliator]
    !!VRy50:S90; Attack !!VRy51:S130+y13; Defense      !!VRy52:S80; Damage !!VRy53:S110+y14; [Health]
    !!VRy54:S90; Speed  !!VRy55:S90; Spell Damage !!VRy56:S90; Passive !!VRy57:S60; [Aura] !!VRy58:S+1; [Const Speed]
    !!VRy59:S10; [MR Dwarf] !!VRy60:S20;[MR Golem]
  !!en;

  !!if&y40=23;                          [Commander_Avenger]
    !!VRy50:S80; Attack !!VRy51:S140+y13; Defense      !!VRy52:S80; Damage !!VRy53:S120+y14; [Health]
    !!VRy54:S90; Speed  !!VRy55:S90; Spell Damage !!VRy56:S90; Passive !!VRy57:S60; [Aura] !!VRy58:S+1; [Const Speed]
    !!VRy59:S10; [MR Dwarf] !!VRy60:S20;[MR Golem]
  !!en;


---
!!if&y40=4;                             [Commander_Caster]
  !!VRy50:S75; Attack !!VRy51:S85; Defense               !!VRy52:S75; Damage !!VRy53:S90; [Health]
  !!VRy54:S80; Speed !!VRy55:S119+y12+y20; Spell Damage !!VRy56:S110; Passive !!VRy57:S50; [Aura] !!VRy58:S0; [Const Speed]
  !!VRy59:S20; [MR Dwarf] !!VRy60:S20;  [MR Golem]
  !!VRy71&x16=1:S46; Upgrade to Fighter-Mage  !!VRy72&x16=1:S47; [Upgrade to Warden]
!!en; 

  !!if&y40=14;                          [Commander_Fighter_Mage]
    !!VRy50:S80; Attack !!VRy51:S90; Defense               !!VRy52:S80; Damage !!VRy53:S90; [Health]
    !!VRy54:S80; Speed !!VRy55:S139+y10+y20; Spell Damage !!VRy56:S110; Passive !!VRy57:S60; [Aura] !!VRy58:S1; [Const Speed]
    !!VRy59:S20; [MR Dwarf] !!VRy60:S20;[MR Golem]
  !!en;

  !!if&y40=24;                          [Commander_Warden]
    !!VRy50:S80; Attack !!VRy51:S90; Defense               !!VRy52:S80; Damage !!VRy53:S100; [Health]
    !!VRy54:S100; Speed !!VRy55:S139+y10+y20; Spell Damage !!VRy56:S110; Passive !!VRy57:S60; [Aura] !!VRy58:S1; [Const Speed]
    !!VRy59:S20; [MR Dwarf] !!VRy60:S20;[MR Golem]
  !!en;


---
!!if&y40=5;                             [Commander_Supporter]
  !!VRy50:S75; Attack     !!VRy51:S110; Defense          !!VRy52:S75; Damage      !!VRy53:S100; [Health]
  !!VRy54:S110; Speed !!VRy55:S100+y11; Spell Damage !!VRy56:S120+y10; Passive !!VRy56&x2=1:+20; Passive !!VRy57:S60; [Aura] !!VRy58:S1; [Const Speed]
  !!VRy59:S10; [MR Dwarf] !!VRy60:S10;  [MR Golem]
  !!VRy71&x16=1:S48; Upgrade to Constructor !!VRy72&x16=1:S49; [Upgrade to Priest]
!!en; 

  !!if&y40=15;                          [Commander_Constructor]
    !!VRy50:S80; Attack     !!VRy51:S115; Defense          !!VRy52:S80; Damage      !!VRy53:S100; [Health]
    !!VRy54:S100; Speed !!VRy55:S100+y11; Spell Damage !!VRy56:S140+y11; Passive  !!VRy57:S70; [Aura] !!VRy58:S1; [Const Speed]
    !!VRy59:S15; [MR Dwarf] !!VRy60:S15;[MR Golem]
  !!en;

  !!if&y40=25;                          [Commander_Priest]
    !!VRy50:S80; Attack     !!VRy51:S100; Defense          !!VRy52:S80; Damage      !!VRy53:S110; [Health]
    !!VRy54:S100; Speed !!VRy55:S100+y11; Spell Damage !!VRy56:S100+y10; Passive  !!VRy57:S70; [Aura] !!VRy58:S0; [Const Speed]
    !!VRy59:S15; [MR Dwarf] !!VRy60:S15;[MR Golem]
  !!en;


---
!!if&y40=6;                             [Commander_Leader]
  !!VRy50:S90; Attack !!VRy51:S90; Defense          !!VRy52:S90; Damage !!VRy53:S110; [Health]
  !!VRy54:S90; Speed  !!VRy55:S100; Spell Damage !!VRy56:S110; Passive  !!VRy57:S120+y10; [Aura] !!VRy58:S1; [Const Speed]
  !!VRy59:S10; [MR Dwarf] !!VRy60:S10;  [MR Golem]
  !!VRy71&x16=1:S50; Upgrade to King !!VRy72&x16=1:S51; [Upgrade to General]
!!en; 

  !!if&y40=16;                          [Commander_King]
    !!VRy50:S80; Attack !!VRy51:S90; Defense          !!VRy52:S80; Damage !!VRy53:S110; [Health]
    !!VRy54:S90; Speed  !!VRy55:S80; Spell Damage !!VRy56:S80; Passive  !!VRy57:S140; [Aura] !!VRy58:S0; [Const Speed]
    !!VRy59:S15; [MR Dwarf] !!VRy60:S15;[MR Golem]
  !!en;

  !!if&y40=26;                          [Commander_General]
    !!VRy50:S90; Attack !!VRy51:S100; Defense          !!VRy52:S80; Damage !!VRy53:S110; [Health]
    !!VRy54:S90; Speed  !!VRy55:S100; Spell Damage !!VRy56:S100; Passive  !!VRy57:S140; [Aura] !!VRy58:S1; [Const Speed]
    !!VRy59:S15; [MR Dwarf] !!VRy60:S15;[MR Golem]
  !!en;


---
!!if&y40=7;                             [Commander_Scout]
  !!VRy50:S75; Attack     !!VRy51:S80; Defense          !!VRy52:S70; Damage !!VRy53:S90; [Health]
  !!VRy54:S110+y11; Speed !!VRy55:S85; Spell Damage !!VRy56:S100; Passive !!VRy57:S50; [Aura] !!VRy58:S2; [Const Speed]
  !!VRy59:S10; [MR Dwarf] !!VRy60:S10;  [MR Golem]
  !!VRy71&x16=1:S52; Upgrade to Prospector !!VRy72&x16=1:S53; [Upgrade to Lancer]
!!en;

  !!if&y40=17;                          [Commander_Prospector]
    !!VRy50:S50; Attack     !!VRy51:S100; Defense          !!VRy52:S50; Damage !!VRy53:S100; [Health]
    !!VRy54:S130; Speed !!VRy55:S90; Spell Damage !!VRy56:S85; Passive !!VRy57:S60; [Aura] !!VRy58:S1; [Const Speed]
    !!VRy59:S15; [MR Dwarf] !!VRy60:S15;[MR Golem]
  !!en; 

  !!if&y40=27;                          [Commander_Lancer]
    !!VRy50:S80; Attack     !!VRy51:S90; Defense          !!VRy52:S80; Damage !!VRy53:S90; [Health]
    !!VRy54:S130; Speed !!VRy55:S80; Spell Damage !!VRy56:S85; Passive !!VRy57:S60; [Aura] !!VRy58:S1; [Const Speed]
    !!VRy59:S15; [MR Dwarf] !!VRy60:S15;[MR Golem]
  !!en;  


---
!!if&y40=8;                             [Commander_Undead]
  !!VRy50:S90; Attack       !!VRy51:S85; Defense          !!VRy52:S100; Damage !!VRy53:S66+y10; [Health]
  !!VRy54:S90; Speed      !!VRy55:S90; Spell Damage !!VRy56:S80; Passive  !!VRy57:S50; [Aura] !!VRy58:S1; [Const Speed]
  !!VRy59:S5; [MR Dwarf] !!VRy60:S0;   [MR Golem]
  !!VRy71&x16=1:S54; Upgrade to Lich !!VRy72&x16=1:S55; [Upgrade to Necromant] !!VRy73&x16=1:S56; [Upgrade to Vampire]
!!en; 

  !!if&y40=18;                            [Commander_Lich]
    !!VRy50:S90; Attack !!VRy51:S90; Defense          !!VRy52:S100; Damage !!VRy53:S80+y13; [Health]
    !!VRy54:S100; Speed      !!VRy55:S90; Spell Damage !!VRy56:S100; Passive  !!VRy57:S60; [Aura] !!VRy58:S1; [Const Speed]
    !!VRy59:S20; [MR Dwarf] !!VRy60:S5;   [MR Golem]
    !!if&x2=1;                            [If PowerLich +20% to all attributes]
      !!VRy50:+20; !!VRy51:+20; !!VRy52:+20; !!VRy53:+20; !!VRy54:+20; !!VRy55:+20; !!VRy56:+20; !!VRy57:+20;
    !!en;   
  !!en;

  !!if&y40=28;                            [Commander_Necromant]
    !!VRy50:S90; Attack !!VRy51:S90; Defense          !!VRy52:S90; Damage !!VRy53:S85+y13; [Health]
    !!VRy54:S90; Speed      !!VRy55:S90; Spell Damage !!VRy56:S100; Passive  !!VRy57:S60; [Aura] !!VRy58:S1; [Const Speed]
    !!VRy59:S20; [MR Dwarf] !!VRy60:S5;   [MR Golem]
    !!if&x2=1;                            [If Elder Necromancer +20% to all attributes]
      !!VRy50:+20; !!VRy51:+20; !!VRy52:+20; !!VRy53:+20; !!VRy54:+20; !!VRy55:+20; !!VRy56:+20; !!VRy57:+20;
    !!en;   
  !!en;

  !!if&y40=19;                          [Commander_Vampire]
    !!VRy50:S90+y11; Attack !!VRy51:S90; Defense          !!VRy52:S90; Damage !!VRy53:S75+y13; [Health]
    !!VRy54:S90; Speed      !!VRy55:S90; Spell Damage !!VRy56:S80; Passive  !!VRy57:S60; [Aura] !!VRy58:S1; [Const Speed]
    !!VRy59:S20; [MR Dwarf] !!VRy60:S5;   [MR Golem]
    !!if&x2=1;                            [If Vampirelord +20% to all attributes]
      !!VRy50:+20; !!VRy51:+20; !!VRy52:+20; !!VRy53:+20; !!VRy54:+20; !!VRy55:+20; !!VRy56:+20; !!VRy57:+20;
    !!en;
  !!en;


---
!!if&y40=9;                             [Commander_FireMage]
  !!VRy50:S1; Attack !!VRy51:S80; Defense          !!VRy52:S1; Damage !!VRy53:S90+y11; [Health]
  !!VRy54:S100; Speed  !!VRy55:S110+y12; Spell Damage !!VRy56:S120; Passive  !!VRy57:S100; [Aura] !!VRy58:S1; [Const Speed]
  !!VRy59:S10; [MR Dwarf] !!VRy60:S25;  [MR Golem]
  !!VRy71&x16=1:S57; [Upgrade to Ancient]
!!en; 


!!if&y40=29;                          [Commander_Ancient]
  !!SN:W^Ancient_Commander_Attack_%X1^/?y1; [Get Attack] !!VRy50:S100+y1; [Attack]
  !!SN:W^Ancient_Commander_Defense_%X1^/?y1; [Get Defense] !!VRy51:S100+y1; [Defense]
  !!SN:W^Ancient_Commander_Damage_%X1^/?y1; [Get Damage] !!VRy52:S100+y1; [Damage]
  !!SN:W^Ancient_Commander_Health_%X1^/?y1; [Get Health] !!VRy53:S100+y1; [Health]
  !!SN:W^Ancient_Commander_Speed_%X1^/?y1; [Get Speed] !!VRy54:S100+y1; [Speed]
  !!SN:W^Ancient_Commander_SpellDmg_%X1^/?y1; [Get SpellDmg] !!VRy55:S100+y1; [Spell Damage]
  !!SN:W^Ancient_Commander_Passive_%X1^/?y1; [Get Passive] !!VRy56:S100+y1; [Passive]
  !!SN:W^Ancient_Commander_Aura_%X1^/?y1; [Get Aura] !!VRy57:S100+y1; [Aura]
  !!VRy58:S0; [Const Speed] !!VRy59:S10; [MR Dwarf] !!VRy60:S10; [MR Golem]
!!en;

!!SN:W^Commander_%X1_Ancient_Supporter^/?y1;
!!VRy56&y1=1:+20;                       [+20% Passive if Ancient Supporter Commander]

*Set chance for commanders to gain extra strike in battle
*!VRy41:S0;
*!VRy41|x1=36/x1=105/x1=128:S25;
*!VRy41&y40=1:+35;
*!VRy41&y40=2:+35; 
*!SN:W^com_extra_strike_chance_%X1^/y41;[Pasis, Vey, Torosar Commander specialists]

!!SN:W^Commander_Opal_SpellDmg_%X1^/?y1; check how many opal crystals the hero has collected
!!VRy1:*5;                              [multiply collected Opals times 5]
!!VRy55:+y1;                            [add to spell modifier from commander]
!!VRy56:+y1;                            [add to passive modifier from commander]

---------------------------
*Commander Hero specialists
!!if|x1=4/x1=36/x1=105/x1=128;          [Lort Haart,Pasis, Vey, Torosar]
  !!HEx1:E?y2/?y3/1;                    [Check hero Level]
  !!VRy2:Sy3;                           [y3 keeps current level and y2 will be modified]

  !!if&x1=4;
    !!VRy50:+0;                         [Attack]
    !!VRy51:-20;                        [Defense]
    !!VRy52:+10;                        [Damage]
    !!VRy53:-10;                        [Health]
    !!VRy55:+10;                        [Spell Damage]
    !!VRy56:+10;                        [Passive]
  !!en;

  !!if&x1=36;
    !!VRy50:+10;                        [Attack]
    !!VRy51:+0;                         [Defense]
    !!VRy52:-10;                        [Damage]
    !!VRy53:-20;                        [Health]
    !!VRy55:+10;                        [Spell Damage]
    !!VRy56:+10;                        [Passive]
  !!en;

  !!if&x1=105;
    !!VRy50:+10;                        [Attack]
    !!VRy51:+10;                        [Defense]
    !!VRy52:-10;                        [Damage]
    !!VRy53:-10;                        [Health]
    !!VRy55:+0;                         [Spell Damage]
    !!VRy56:+10;                        [Passive]
  !!en;

  !!if&x1=128;
    !!VRy50:-10;                        [Attack]
    !!VRy51:-10;                        [Defense]
    !!VRy52:+10;                        [Damage]
    !!VRy53:+10;                        [Health]
    !!VRy55:+10;                        [Spell Damage]
    !!VRy56:+0;                         [Passive]
  !!en;

  *!VRy2:Sy3+4;                         [Health calculation]
  *!VRy53:+y2;                          [Add Health]
  *!VRy2:Sy3*3:2+3;                     [Damage calculation]
  *!VRy52:+y2;                          [Add Damage]

  !!VRy2:Sy3:20+1;                      [Speed Calculation]
  !!VRy58:+y2;                          [Add Const Speed]
!!en;

!!VRy99&x1=128/y40<>29:+y20;            [Pasis commander special gets +1 to limit of kill count]

*Weak Commander option
!!SN:W^acm_Weak_Commanders^/?y70;       [Check for Weak Commander Option]
!!VRy53&y70=1:-25;                      [-25% Health]
!!VRy52&y70=1:-25;                      [-25% Damage]
!!VRy56&y70=1:-25;                      [-25% Passive]
!!VRy55&y70=1:-25;                      [-25% Spell Damage]


*Artifact boost section*
!!if&x1>=0/x1<=155;
  !!HEx1:A2/151/?y80/?y81;              [151  Boots of Haste +25% Commander spell and passive effectiveness]
  !!if&y81=1;
    !!VRy55:+25; !!VRy56:+25;
  !!en;

  !!HEx1:A2/155/?y80/?y81;              [155 Slava's Ring of Power +10% to all Commander attributes.]
  !!if&y81=1;
    !!VRy50:+10; !!VRy51:+10; !!VRy52:+10; !!VRy53:+10; !!VRy54:+10; !!VRy55:+10; !!VRy56:+10; !!VRy57:+10;
  !!en;

  !!HEx1:A2/153/?y80/?y81;              [153  Dragon Eye Ring of Power +10% to all Commander attributes.]
  !!if&y81=1;
    !!VRy50:+10; !!VRy51:+10; !!VRy52:+10; !!VRy53:+10; !!VRy54:+10; !!VRy55:+10; !!VRy56:+10; !!VRy57:+10;
  !!en;

  !!HEx1:A2/50/?y80/?y81;               [50  Crest of Valor Attacker +15% to all attributes]
  !!if&y81=1;
    !!VRy50:+15; !!VRy51:+15; !!VRy52:+15; !!VRy53:+15; !!VRy54:+15; !!VRy55:+15; !!VRy56:+15; !!VRy57:+15;
  !!en;

  !!HEx1:A2/161/?y80/?y81;              [161  Blank Helmet +10% to all attributes]
  !!if&y81=1;
    !!VRy50:+10; !!VRy51:+10; !!VRy52:+10; !!VRy53:+10; !!VRy54:+10; !!VRy55:+10; !!VRy56:+10; !!VRy57:+10;
  !!en;

  !!HEx1:A2/163/?y80/?y81;              [163  Blank Shield +10% to all attributes]
  !!if&y81=1;
    !!VRy50:+10; !!VRy51:+10; !!VRy52:+10; !!VRy53:+10; !!VRy54:+10; !!VRy55:+10; !!VRy56:+10; !!VRy57:+10;
  !!en;

  !!HEx1:A2/166/?y80/?y81;              [66 Blank Neck Broach +10% to all attributes]
  !!if&y81=1;
    !!VRy50:+10; !!VRy51:+10; !!VRy52:+10; !!VRy53:+10; !!VRy54:+10; !!VRy55:+10; !!VRy56:+10; !!VRy57:+10;
  !!en;

  !!HEx1:A2/54/?y80/?y81;               [54 Amulet of the Undertaker +10% to all attributes]
  !!if&y81=1;
    !!VRy50:+10; !!VRy51:+10; !!VRy52:+10; !!VRy53:+10; !!VRy54:+10; !!VRy55:+10; !!VRy56:+10; !!VRy57:+10;
  !!en;

  !!FU(Count_Set_Pieces_2):Px1/0/0/?y90/?y91/?y92; [Count Set Pieces function]
  !!if&y90>=2;                          [If 2 set pieces equipped +10% to all attributes]
    !!VRy50:+10; !!VRy51:+10; !!VRy52:+10; !!VRy53:+10; !!VRy54:+10; !!VRy55:+10; !!VRy56:+10; !!VRy57:+10;
  !!en;
  !!if&y91>=2;                          [If 2 set pieces equipped +10% to all attributes]
    !!VRy50:+10; !!VRy51:+10; !!VRy52:+10; !!VRy53:+10; !!VRy54:+10; !!VRy55:+10; !!VRy56:+10; !!VRy57:+10;
  !!en; 
  !!if&y92>=2;                          [If 2 set pieces equipped +10% to all attributes]
    !!VRy50:+10; !!VRy51:+10; !!VRy52:+10; !!VRy53:+10; !!VRy54:+10; !!VRy55:+10; !!VRy56:+10; !!VRy57:+10;
  !!en;   

  !!SN:W^ACM_Com%X1_Artifact_150^/?y1; !!VRy1::2; [150 Pendant of Sorcery check battle wins and give +1% spell mod per two wins]

  !!re i/0/5;                           [Commander Artifacts, check all slots]
    !!COx1:A3/i/?y82/?y83;    
    !!VRy55&y82=150:+15;                [+15% Commander spell effectiveness]
    !!VRy55&y82=150:+y1;                [add +1% spell mod based on battles won with Pendant of Sorcery equipped]
    !!VRy99&y82=149:+30;                [149 Helm of Immortality +30 to max kill count]
    !!if|y82=153/y82=155/y82=152;       [Dragon Eye Ring or Slava's Ring or Bow of Seeking +10% to all Commander attributes]
      !!VRy50:+10; !!VRy51:+10; !!VRy52:+10; !!VRy53:+10; !!VRy54:+10; !!VRy55:+10; !!VRy56:+10; !!VRy57:+10;
    !!en;
  !!en;

  *Commander Balance 
  !!if&x1>=0;
    !!COx1:B1/6/?y1;                    [check Strikes All Around ability]
    !!VRy52&y1=1:-10;                   [-10% Damage if ability is active]

    !!if&y40<>(ACM_CMD_CLASS_SNIPER);   [If not Sniper, as they are forced to attack only once]
      !!COx1:B1/9/?y1;                  [check Attack Twice ability]
      !!VRy52&y1=1:-15;                 [-15% Damage if ability is active]
      !!VRy50&y1=1:-15;                 [-15% Attack if ability is active]
    !!en;

    !!if|y40=(ACM_CMD_CLASS_RANGER)/y40=(ACM_CMD_CLASS_SNIPER)/y40=(ACM_CMD_CLASS_LICH)/y40=(ACM_CMD_CLASS_MARKSMAN);    [If any commander class that has native shoot ability. Ranger Sniper Marksman Lich give +10% damage]
      !!COx1:B1/4/?y1;                  [check Shooting ability]
      !!VRy52&y1=1:+10;                 [+10% Damage if ability is active]
    !!en;
  !!en;
!!en;

!!VRy56&y40=25::2;                      [The supporter class has all passive value halved]

!!VRy50&y50<1:S1; !!VRy51&y51<1:S1; !!VRy52&y52<1:S1;!!VRy53&y53<1:S1; !!VRy55&y55<1:S1; !!VRy56&y56<1:S1; [So it cannot go below zero]

*return function values section
!!VRx4:Sy99 F0/9999;                    [Returns max kill count, max at 9999]
!!VRx6:Sy50; !!VRx7:Sy51; !!VRx8:Sy52; !!VRx9:Sy53; !!VRx10:Sy54; !!VRx11:Sy55; !!VRx12:Sy56; !!VRx13:Sy57; !!VRx14:Sy58; [Set an return variables to function]
!!if&x16=1;                             [if x16=1 means you fct returns Golem and Dwarf type of Magic Resistance]
  !!VRx6:Sy59; !!VRx7:Sy60;             [return Magic Resistance]
  !!SN:W^Ancient_Unlocked^/?y1;
  !!VRx8:Sy71; !!VRx9:Sy72; !!VRx10:Sy73; !!VRx11&y1=0:S0; !!VRx11&y1=1:S57;[return possible upgrade/promotion ID for commanders]
!!en;


!?OB101/7;                              [object Trigger Opal]
!!HE-1:N?y1;                            [get current hero]
!!SN:W^Commander_Opal_SpellDmg_%Y1^/d1; [count how many times opal crystal was visited]


; Send the change about commander class to other players computer
!?FU(ACM_MP_Sync_Commander_Classes);
x1=Hero ID  
!!IP:D(ANY_PLAYER);
!!IP:M^Commander_Fighter_%X1^/^Commander_Ranger_%X1^/^Commander_Defender_%X1^/^Commander_Caster_%X1^/^Commander_Supporter_%X1^/^Commander_Leader_%X1^/^Commander_Scout_%X1^/^Commander_Undead_%X1^/^Commander_FireMage_%X1^;
!!IP:M^Commander_Dragonslayer_%X1^/^Commander_Sniper_%X1^/^Commander_Retaliator_%X1^/^Commander_ArchMage_%X1^/^Commander_Constructor_%X1^/^Commander_King_%X1^/^Commander_Prospector_%X1^/^Commander_Lich_%X1^/^Commander_Vampire_%X1^;
!!IP:M^Commander_Paladin_%X1^/^Commander_Marksmen_%X1^/^Commander_Avenger_%X1^/^Commander_Warden_%X1^/^Commander_Arcanist_%X1^/^Commander_General_%X1^/^Commander_Lancer_%X1^/^Commander_Necromant_%X1^/^Commander_Ancient_%X1^;
!!IP:S;                                 [command to perform synchronization of all marked variables and arrays]


****************************************************************************************************
// Reset commander stats after recruiting a new one
; by Archer30
!?FU(OnAfterCommanderBuy);
!!HE(CURRENT_HERO):N?(hero:y);

!!FU(ACM_SetCommanderClass):P(hero)/0;

!!VRi^Commander_Kill_Counter_%(hero)^:S0;

!!SN:W^Ancient_Commander_Attack_%(hero)^/0;
!!SN:W^Ancient_Commander_Defense_%(hero)^/0;
!!SN:W^Ancient_Commander_Damage_%(hero)^/0;
!!SN:W^Ancient_Commander_Health_%(hero)^/0;
!!SN:W^Ancient_Commander_Speed_%(hero)^/0;
!!SN:W^Ancient_Commander_SpellDmg_%(hero)^/0;
!!SN:W^Ancient_Commander_Passive_%(hero)^/0;
!!SN:W^Ancient_Commander_Aura_%(hero)^/0;
!!SN:W^Ancient_Commander_Totalbonus_%(hero)^/0; 

!!VRi^Commander_Opal_SpellDmg_%(hero)^:S0;

; Reset bought spells
!!re i/(SPELL_FIRST_BATTLE)/(SPELL_LAST_BATTLE);
  !!VRi^Com_Attack_Caster_%(hero)_%i_purchased^:S0;
!!en;

; Set the default spell (used in Archmage and Warden commander class)
!!FU(ACM_FixCommanderSpellData):P(hero);

****************************************************************************************************
*When right cklicking the commander in battle set new stack description to show class and current level of commanders
Also show if Mastery is active or not

[set commander description in battle]
!?CM4&i^mouse_action^=(MOUSE_LMB_PRESSED);
!!FU:E;                                 [disabled and hopefully replaced by new way from Daemon :*]
!!CM:D?y1;                              [Get Battlefield position with click]
!!if&y1>=0/y1<=186;                     [If a valid battlefield position]
  !!BU:Ey1/?y2; !!FU&y2=-1:E;           [get monster ID at position and exit if no monster]
  !!BMy2:T?y3 I?y4 S?y6;                [get monster type and side index]
  !!BHy4:N?y30;                         [Get hero or commander ID]
  !!if&y3>=174/y3<=191/y30>=0/y2<40;    [if any commander and a hero]
    !!VRz11:S^^;
    !!FU(Check_Com_Masteries):Py30/?y10/?y11/?y12/?y13/0/0/0/0/0/?y50; [Pass Hero Number and return commander class]
    !!SN&y13>0:T^AC_Misc.Commander_Opt_%Y13^/?z2; [get text strings]
    !!SN&y13=0:T^AC_Misc.Commander_Opt_No_Class^/?z2; [...]
    !!SN&y10=0:T^AC_Misc.Com_Mastery_Disabled^/?z3; [...]
    !!SN&y10=1:T^AC_Misc.Com_Mastery_active^/?z3; [...]
    !!FU(Set_Com_Battle_Description)&y13>0:Py13/y30/y11/y50/y10/y6/y4;  
    !!COy30:X2/?y40;                    [Get Commander Level]
    !!SN:T^AC_Misc.Com_Battle_Text^/?z1/^level^/y40/^kills^/y11/^mastery^/z3/^class^/z2/^maxkills^/y12; [Set text to show]
    !!VRz1:+z11;                        [combine z1 and z11]
    !!IF:M1/4/^%Z1^; 
  !!en;
!!en;


!?FU(OnStartOrLoad); 
!!SN:L^EraPlugins\erm_hooker.era^/?y1;
!!FU&y1=0:E;

!!SN:Ay1/^SetHook^/?y2;
!!SN:Ey2/1/4621577/(ACM_beforeCreatureInfoDlg_Show); [right click] 468509
!!SN:Ey2/1/4621584/(ACM_beforeCreatureInfoDlg_Show); [left click] 468510


!?FU(ACM_beforeCreatureInfoDlg_Show);
!!MW:Cv998/v999/v1000/?y10;             [check if wandering monster and get WM number]
!!UN:Cx1/24/4/?y1;                      [get creature dlg]

!!if&y1>0;
  !!UN:Cx1/8/4/?y2 Cy2/8/4/?y3;         [get stack from stack lmao]
  !!UN:Cy3/52/4/?t;                     [get creature type]

    !!if&t>=174/t<=191;                 [if npc]
    !!FU&y10>0/t>=183:E;                [make compatible with Raid Boss Mod to set description of defender battle commander]
***Perrys code
      !!UN:Cy3/244/4/?y23 Cy3/248/4/?y2;[get monster side and index]
      !!VRy21:Sy23 *21 +y2;             [get stack id]
      !!BMy21:I?y23 S?y24;              [get monster type and side index]
      !!BHy23:N?y25;                    [Get hero or commander ID]

      !!if&y25>=0;                      [if any commander and a hero]
        !!VRz4:S^^; !!VRz6:S^^; !!VRz11:S^^;
        !!FU(Check_Com_Masteries):Py25/?y26/?y27/?y28/?y29/0/0/0/0/0/?y50; [Pass Hero Number and return commander class]
        !!SN&y29>0:T^AC_Misc.Commander_Opt_%Y29^/?z4; [get text strings]
        !!SN&y29=0:T^AC_Misc.Commander_Opt_No_Class^/?z4; [...]
        !!SN&y26=0:T^AC_Misc.Com_Mastery_Disabled^/?z3; [...]
        !!SN&y26=1:T^AC_Misc.Com_Mastery_active^/?z3; [...]
        !!FU(Set_Com_Battle_Description)&y29>0:Py29/y25/y27/y50/y26/y24/y23/?t/?t/1;
        !!COy25:X2/?y40;                [Get Commander Level]
        !!SN:T^AC_Misc.Com_Battle_Text^/?z-1/^level^/y40/^kills^/y27/^mastery^/z3/^class^/z4/^maxkills^/y28; [Set text to show]
        !!VRz-1:+z11;                   [combine z1 and z11]
***End

        !!VRy6:S0;
        !!SN:F^PluginExists^/^new_battle_interface_dlg^;
        !!VRy6&v1:V^%T(gem_plugin.combat_dlg.enable.creature_info)^;

        !!if&y6;
          !!FU(H3Dlg_Coords):Py1/?y4/?y5;[get Dlg Position]
          !!VRy2:V^%T(gem_plugin.combat_dlg.creature_info.description.x)^ Sdy4; [find x]
          !!VRy3:V^%T(gem_plugin.combat_dlg.creature_info.description.y)^ Sdy5; [find y]
          !!SN:E6289824/(CALLCONV_THISCALL)/y1/y2/y3; [find item there]
          !!VRy5:Sv1;                   [save]
        !!el;
          !!VRy4:S-1;
          !!SN:E6288816/2/y1/y4;
          !!VRy5:Sv1;                   [save]
        !!en;

        !!if&y5>0;                      [if found]
          !!UN:Cy5/24/2/?y6 Cy5/26/2/?y7;[get original item position]
          !!UN:Cy5/28/2/?y8 Cy5/30/2/?y9;[get original item size]
          !!UN:Cy5/64/4/?y10;           [get font]
          !!VRy11:Sy10 +4;              [get font name ptr]
          !!SN:By11/d/?z-2;             [get font name]
          !!VRy12:S9598952;             [set item address]
          !!SN:E6286720/2/y5/6/6;       [hide original description text item]
          !!SN:E6014624/2/y12/y6/y7/y8/y9/z-1/z-2/4/-2/0/0/8; [create new DlgText item with new id at z2 address]
          !!SN:E6287984/2/y1/y12/-1;    [add item to dlg list]
        !!en;
    !!en;
!!en;


!?FU(Set_Com_Battle_Description);
x1=commader class (1-29), x2=hero ID, x3=kill count, x4=passive mod, x5=Mastery, x6=speed, x7=Side, x8= 0 or 1  1- means Return only base value (ignore kill count)
x9=returns skill value

x10=mode (for Archmage and Warden), optional
; 1 - For Commander description on the battlefield, double-line display 
; 2 - For ACM Bonus list, show alternative text to remind players changing spells here
!!FU:A?y30;
!!VRx10&y30<10:S0;

!!VRz12:S^^; 

!!VRx3&x8=1:S0;                         [Set kill count to zero to show base value]

!!VRy10&x1=1/x5=0:S0;                   [Fighter]
!!VRy10&x1=1/x5=1:S25;                  [Fighter]
!!VRy10&x1=2/x5=0:S0;                   [Ranger]
!!VRy10&x1=2/x5=1:S25;                  [Ranger]
!!VRy10&x1=3/x5=0:S0;                   [Defender]
!!VRy10&x1=3/x5=1:S50;                  [Defender]
!!VRy10&x1=4:S1;                        [Caster]
!!VRy10&x1=5:S0;                        [Supporter]
!!VRy10&x1=6:S0;                        [Leader] todo add Att/Def value]
!!FU(ACM_Scout_Dodge_Chance)&x1=7:Px6/?y22; [Scout]
!!VRy10&x1=7:Sy22;                      [Scout]
!!VRy10&x1=8:S1;                        [Undead]
!!VRy10&x1=11:Sx3*2 +10;                [Dragonslayer]
!!VRy10&x1=12:Sx3:7 +7 F0/50;           [Sniper]
!!VRy10&x1=13:Sx3*1 +5;                 [Retaliator]

!!if|x1=(ACM_CMD_CLASS_ARCHMAGE)/x1=(ACM_CMD_CLASS_WARDEN);
  !!FU(ACM_FixCommanderSpellData):Px2;
  !!VRy98:Si^acm_cmdSpell_%x2^;

  !!VRz12:S^%T(AC_Misc.Spell_Book_Description_None)^;
  !!SN&y98>=1/y98<=69:H^spell^/y98/(SPELL_TEXT_NAME)/?z12; 
  !!VRy10:S0;                           [Arch Mage]
!!en;

*!FU(Calc_Fighter_On_Hit_Damage)&x1=14:Px2/x3/?y16/0/x4; [Pass Hero ID and Kill Count returns damage]
*!VRx3&x1=14:Sy16;                      [Fighter Mage Additional On Hit damage]

!!if&x1=15;                             [Constructor]
  !!VRy10&x1=15:Sx3:40 +1;              [Amount of maximum warmachines during combat]
  !!VRy15&x5=0:S0;                      [stat increase of WM if master enabled is twice the kill count]
  !!VRy15&x5=1:Sx3; 
!!en;

!!VRy10&x1=16:Sx3:25 +1;                [King]

!!SN&x1=17/x7=0:W^Att_Prospector_Res_Chance^/?y10; [Prospector]
!!SN&x1=17/x7=1:W^Def_Prospector_Res_Chance^/?y10; [Prospector]

!!VRy10&x1=18:Sx3+ 10;                  [Lich]
!!VRy10&x1=19:S25;                      [Vampire]
!!VRy10&x1=21:Sx3*2+ 10;                [Paladin]
!!VRy10&x1=22:Sx3:50 +1;                [Marksman]
!!VRy10&x1=22/x5=1:+1;                  [Marksman Mastery]
!!VRy10&x1=23:Sx3:4 +5;                 [Avenger]
                    
!!VRy10&x1=26:Sx3:10 +20;               [General]

!!if&x1=27;                             [Lancer]
  !!SN&x7=0:W^Lancer_Commander_Distance_Att^/?y15; [damage is increased based on the walking distance in combats]
  !!SN&x7=1:W^Lancer_Commander_Distance_Def^/?y15;
  !!VRy10&x3>=0/x3<=49:Sy15*1;          [With higher kill count langer levels damage faster during combat]
  !!VRy10&x3>=50/x3<=99:Sy15*2;
  !!VRy10&x3>=100/x3<=149:Sy15*3;
  !!VRy10&x3>=150/x3<=199:Sy15*4;
  !!VRy10&x3>=200:Sy15*5;										
!!en;

!!if&x1=28;                             [Necromant]
  !!SN&x7=0:W^Att_Commander_Summon_Stats^/?y15;
  !!SN&x7=1:W^Def_Commander_Summon_Stats^/?y15;
  !!VRy10:Sx3:10 +3;                    [Necromant]
!!en;

!!if&x1=29;                             [Ancient]
  !!SN:W^Ancient_Commander_Totalbonus_%X2^/?y10; [get total bonus]
!!en;

!!VRy31:Sx1;
!!VRz30:S^^;

!!if|x1=14/x1=24;
  !!if&x10<=1;
    !!VRy31:S14;
    !!VRz30&x10=1:S^
^;
  !!el&x10=2;
    !!VRy31:S24;
    !!VRz30:S^
^;
  !!en;
!!en;

!!SN:T^AC_Misc.Com_Battle_Text_%Y31^/?z11/^kills^/y10/^spell^/z12/^stat^/y15/^newLine^/z30; [set second string variable that will be shown on right click commander in battle]

; Hide Ancient hint if Ancient is not unlocked
!!if&x1=29/i^Ancient_Unlocked^<>(TRUE);
  !!VRz11:S^^;
!!en;

!!VRx9:Sy10;                            [return number for calculations]


; Set the spell of commanders at the start of battle (if they are Archmages or Wardens)
; by Archer30
; Sync the spell in MP games - send the choice of spell from the defender to the attacker
; i^wog_isNeutralBattle^ should be FALSE as the second hero can be added by WoG Scripts - random heroes, this variable helps you find the situation
; This is disabled as Berserkser said it's abnormal to sync data from the defender to the attacker. Now we sync the data after any change to spell from the UI instead
*?FU(OnBeforeBattleUniversal)&i^battle_hero_vs_hero^/i^wog_isNeutralBattle^<>(TRUE);
*!OW:C?(player:y)/?(interactPlayer:y);

*!if&(interactPlayer)=i^battle_owner_1^;
  *!FU(Check_Com_Masteries):Pi^battle_hero_1^/?t/?t/?t/?(cmdClass:y);

  *!if|(cmdClass)=(ACM_CMD_CLASS_ARCHMAGE)/(cmdClass)=(ACM_CMD_CLASS_WARDEN);
    *!IP:Di^battle_owner_0^;
    *!IP:M^acm_cmdSpell_%i(battle_hero_1)^;
    *!IP:S;
  *!en;
*!en;

!?FU(OnBattleRound)&i^battle_round^=0;  [Should not be earlier to be compatible with crappy Amethyst! Not even OnAfterTactics]
!!re i/(BATTLE_LEFT)/i^battle_hero_vs_hero^;
  !!VR(hero:y):Si^battle_hero_%i^;

  !!FU(Check_Com_Masteries):P(hero)/?t/?t/?t/?(cmdClass:y); [Pass Hero Number and return commander class]
  !!co&(cmdClass)<>(ACM_CMD_CLASS_ARCHMAGE)/(cmdClass)<>(ACM_CMD_CLASS_WARDEN);

  !!CO(hero):T?(cmd:y);

  ; Fix current spell value if it's not set
  !!if&i^acm_cmdSpell_%(hero)^=0;
    !!FU(ACM_GetDefaultCommanderSpell):P(cmd)/?i^acm_cmdSpell_%(hero)^;

    !!co;
  !!en;

  ; Set new spell to the stack if new spell was set
  !!CO(hero):T?(cmdType:y);

  !!if&i=(BATTLE_LEFT);
    !!VR(cmdType):+(MON_COMMANDER_FIRST_A);
    !!VR(startInd:y):S(BATTLE_ATTACKER_STACK_FIRST);
    !!VR(endInd:y):S(BATTLE_ATTACKER_STACK_LAST);
  !!el;
    !!VR(cmdType):+(MON_COMMANDER_FIRST_D);
    !!VR(startInd):S(BATTLE_DEFENDER_STACK_FIRST);
    !!VR(endInd):S(BATTLE_DEFENDER_STACK_LAST);
  !!en;
 
  !!re (stack:y)/(startInd)/(endInd);
    !!BM(stack):T?(type:y);

    !!if&(cmdType)=(type);
      !!BM(stack):U4/i^acm_cmdSpell_%(hero)^;
    !!en;
  !!en;
!!en;


!?FU(OnStackToStackDamage);
*!IF:L^Att:%X1 Def:%X2 finalDmgConst:%X3 finalDmg:%X4 basicDmg:%X5 dmgBonus:%X6 isDistant:%X7 distanceArg:%X8 isTheoretical:%X9^;

!!FU&x9=1:E;                            [Exit calculation for theoretical attack]
!!if&x1>=0/x1<=41;                      [if any valid battlestack]
!!if&x2>=0/x2<=41;                      [if any valid battlestack]
  !!BMx1:T?y2 I?y3;                     [Creature Type and Side index as for heroes (0:left, 1:right)]
  !!BA:Hy3/?y99; !!FU&y99<0:E;          [Get hero by side and exit if none]

  *Commander classes section
  !!FU(Check_Com_Masteries):Py99/0/?y15/0/?y10/0/0/0/0/0/?y44/?y45; [Pass Hero Number and return current com class and Passive Modifier]
  !!if&y2>=174/y2<=191;                 [if any commander]
    !!if&y10=11;                        [If Dragonslayer Commander Class]
      !!BMx2&x2>=0/x2<=41:T?y5; !!FU|y5<0/y5>999:E; [get creature type and exit if not correct]
      !!MA:Ly5/?y6; !!FU&y6<6:E;        [Get level of attacked stack and Exit if it was not level 7 creature]
      !!FU(Set_Com_Battle_Description):P11/y99/y15/0/0/0/y3/0/?y16;      
      !!VRy16:+100;                     [2% damage increase per kill count]
      !!VRy7:Sx4;                       [set y7 to current damage value]
      !!VRy7:*y16:100;                  [Increase damage based on percentag]
      !!VRx4&y7>=0:Sy7;                 [set new damage]
    !!en;

    !!if&y10=12;                        [If Sniper Commander Class]
      !!BMx2:H?y50 N?y51;               [get health and number of target creature]
      !!VRy52:S0; !!VRy52&y50>5000:S1;  [For boss creatures (creature with HP >= 5000), the HP percentage as damage is halved]
      !!VRy20:Sy51*y50;                 [total HP of target]
      !!FU(Set_Com_Battle_Description):P12/y99/y15/0/0/0/y3/0/?y16; [set percentage damage based on kill count 1% for 5 kill count +5]
      !!VRy7&y52=0:Sy20*y16:100;        [calc additional damage]
      !!VRy7&y52=1:Sy20*y16:200;        [the HP percentage as damage is halved]
      !!VRx4&y7>=0:+y7;                 [add new damage]
    !!en;

    !!if&y10=13/x9=0;                   [If Retaliator Commander Class] *this code only handles the second retaliation strike from commander
      !!SN:W^ACM_Now_Retail^/?y30; !!FU&y30=0:E; [Exit if not retaliation strike from commander]
      !!FU(Set_Com_Battle_Description):P13/y99/y15/0/0/0/y3/0/?y16; [deals 5%+1% for each kill count increased retaliation damage]
      !!VRy16:+100;                     [1% damage increase per kill count]
      !!VRy7:Sx4;                       [set y7 to current damage value]
      !!VRy7:*y16:100;                  [Increase damage based on percentag]
      !!VRx4&y7>=0:Sy7;                 [set new damage]
    !!en;

    !!if&y10=21;                        [If Paladin Commander Class]
      !!BMx2:F?i;                       [read flags]
      !!VRi:&16; !!FU&i>0:E;            [just look at alive bit and exit if yes]
      !!FU(Set_Com_Battle_Description):P21/y99/y15/0/0/0/y3/0/?y16;      
      !!VRy16:+100;                     [2% damage increase per kill count]
      !!VRy7:Sx4;                       [set y7 to current damage value]
      !!VRy7:*y16:100;                  [Increase damage based on percentag]
      !!VRx4&y7>=0:Sy7;                 [set new damage]
    !!en;

    !!if&y10=27;                        [If Lancer Commander Class]
      !!FU(Set_Com_Battle_Description):P27/y99/y15/0/0/0/y3/0/?y16;
      !!VRy16:+100;                     [% damage increase per kill count]
      !!VRy7:Sx4;                       [set y7 to current damage value]
      !!VRy7:*y16:100;                  [Increase damage based on percentag]
      !!VRx4&y7>=0:Sy7;                 [set new damage]
    !!en;
  
****
!!en;
    
    !!if&x7=0;                          [If melee attack]
      !!SN:W^Oger_Leader_Cast%X1^/?y4;  [Ogre Leader commander extra damage from Bloodlust cast]
      !!FU&y4=-1:E;                     [Exit if cast isnt on]
      !!FU&y4<>x1:E;                    [Exit if this creature was not cast with Ogre Leader Bloodlust Cast]
      !!BMx1:G43/?y13/?y14;             [check for Bloodlust Duration]
      !!FU&y13=0:E;
      !!BMx2:H?y50 N?y51;               [get health and number of target creature]
      !!VRy20:Sy51*y50*2:100;           [total HP of target and take 2% of it]
      !!COy99:X2/?y60;                  [Get Commander Level]
      !!COy99:S4/?y70;                  [Get Magic Level of Commander]
      !!VRy71:Sy70*y60*3;               [calc base damage value]
      !!VRy23:S50+y20+y71*y44:100;      [calculate total damage value 50 plus Clvl*MLvL*3+2% from total HP of attacked stack]
      !!VRy7:Sx4;                       [set y7 to current damage value]
      !!VRy7:+y23;                      [Increase damage based on flat amount]
      !!VRx4&y7>=0:Sy7;                 [set new damage]
    !!en;    
  

*Artifacts and damage skills section
  !!SN:W^Grandmaster_Adventurer_Hero%Y99^/?y12; [Grandmaster Adventurer perk]
  !!if&y12=1;
    !!BMx1:N?y13;                       [how many monsters in attacking stack]
    !!VRx4&y13>=0:+y13;                 [add new damage based on monster number]
  !!en;

  !!if&x7=1;                            [If range attack]
    !!HEy99:A2/60/?y80/?y81 E?y70/?y8/1;[60 Bow of Elven Cherrywood]
    !!VRy7:S4*y8;                       [4 times the level of the hero]
    !!VRx4&y81=1:+y7;                   [add new damage]
  !!en;

  !!if&x7=0;                            [If melee attack]
    !!HEy99:A2/8/?y80/?y81 E?y70/?y8/1; [8 Blackshard of the Dead Knight]
    !!BMx2:F?i;                         [read flags]
    !!VRi:&16;                          [just look alive bit]
    !!if&i>0/y81=1;                     [if alive and sword equipped]
      !!VRy7:S2*y8+25;                  [2 times the level of the hero +25]
      !!VRx4:+y7;                       [add new damage]
    !!en;
  !!en;

  !!if&x7=0;                            [If melee attack]
    !!HEy99:A2/9/?y80/?y81 E?y70/?y8/1; [9 Greater Gnoll's Flail]
    !!BMx2:F?i;                         [read flags]
    !!VRi:&262144;                      [just look undead bit]
    !!if&i>0/y81=1;                     [if alive and sword equipped]
      !!VRy7:S2*y8+30;                  [2 times the level of the hero +30]
      !!VRx4:+y7;                       [add new damage]
    !!en;
  !!en;


!!en; 
!!en; 
*!VR(finalDmgNew:y):S(finalDmgConst) *20 :100 +(finalDmg);
****************************************************************************************************
// Reduce damage to the secondary targets of Strike all Around attacks for commanders
// by Archer30
; Commanders now deal reduced damage to secondary targets of their strike all around attacks
; For the main target, the damage would still be 100%
; This sciprt won't work if the attacker, the defender and the secondary targets are all in the same side (possible with Berserk)
; To solve this, we need to introduce a new hook to get the actual attacking stack. But this is a rare situation so we are not doing it for now
!?FU(OnMonsterPhysicalDamage);
!!VRi^acm_Redstrik_damagePercent^:S50;  [Percentage of damage commanders deal to secondary targets of their Strike all around attacks]
 
!!UN:C42149568/(UNC_INT)/?(dmgTypeValue:y); [Get the type of MF damage]
!!if&(dmgTypeValue)=4456676;            [4456676 - Strike All (including main and secondary targets)]
  ; Get the attacker/defender stack
  !!MF:N?(defStack:y);
  !!BG:E?(targetStack:y);
  !!FU|(defStack)=(targetStack)/(defStack)=i^battle_acting_stack^:E; [exit if it is a process of calculating damage to the main target]

  ; Check if it is a commander dealing damage
  ; Here we assume the attacker with different side with the defender (MF:N) is the real attacker
  ; It can be the same if Berserked!
  !!BM(defStack):I?(defSide:y);
  !!VR(attackers[2]:y):Ci^battle_acting_stack^/(targetStack);

  !!re i/0/1;
    !!co&(attackers[i])=(NO_STACK);     [It's possible that BG:E is -1]

    !!FU(ACM_GetActualStackSide):P(attackers[i])/?(actualSide:y);

    !!if&(actualSide)<>(defSide);
      !!VR(atkStack:y):S(attackers[i]);

      !!br;
    !!en;
  !!en;

  ; Exit if we are really not sure about which stack was the attacker
  !!FU&i>1:E;

  !!BM(atkStack):T?(atkType:y);

  !!if&i^battle_hero_%(actualSide)^=105;[if special hero]
    !!HEi^battle_hero_%(actualSide)^:E?(exp:y)/?(level:y)/1; [get hero level]
    !!VRi^acm_Redstrik_damagePercent^:S(level) *2 +73; [calc new damage]
  !!en; 
   
  !!if&(atkType)>=(MON_COMMANDER_FIRST_A)/(atkType)<=(MON_COMMANDER_LAST_D); [If it is a commander inflicing damage]
    !!MF:F?(dmg:y);                     [get damage]
    !!VR(newDmg:y):S(dmg) *i^acm_Redstrik_damagePercent^:100; [calc new damage]
    !!MF&(newDmg)>0:F(newDmg);          [set new damage]
  !!en;
!!en;

; The stack size would be reverted if the stack is hypnotized
!?FU(ACM_GetActualStackSide);
!#VA(stack:x) (side:x);

!!BM(stack):I?(side) G(SPELL_HYPNOTIZE)/?(hypnotizeTurns:y)/d;
!!VR(side)&(hypnotizeTurns)>0:X(TRUE);


****************************************************************************************************
*Magic Damage for commanders based on Golem type Magic Resistance
!?MR1; 

!!MR:N?y5;                              [Get Creature number which took magic damage]
!!BMy5:T?y2 I?y3;                       [Creature Type and side]
!!BA:Hy3/?y4;                           [get hero by battle side]
!!FU&y4<0:E;                            [Exit if no Hero]
!!if&y2>=174/y2<=191;                   [If any commander is taking magic damage]
  !!COy4:S4/?y60 X2/?y40;               [Get Magic Level and Level of Commander]
  !!FU(ACM_Calc_Commander_Magic_Resistance):Py4/d/?y13; [Get golem type damage reduction]
  !!MR:F?y10;                           [Final (corrected) damage]
  !!MR:D?y11;                           [Basic (without resistance) damage]
  !!VRy14:S100-y13;                     [Calc amount of reduction for math]
  !!VRy15:Sy11*y14:100;                 [Calculate new magic damage value, reduced by golem type protection]
  !!MR&y15>0:Fy15;                      [Set to damage without any reduction]
!!en;

*Check the dwarf type Magic Resistance from commanders to dodge spells
!?MR2;                                  [Magic Resistance Trigger]

!!MR:N?y1;                              [Get Creature Number]
!!BMy1:I?y2 T?y3;                       [Get Creature Side]
!!if&y3>=174/y3<=191;
  !!BG:H?y50;                           [Get Casting Hero]
  !!BA:Hy2/?y5;                         [Get Hero Number of creature side]
  !!FU&y5<0:E;                          [Exit if no Hero]
  !!FU&y50=y5:E;                        [Exit for beneficial spells, meaning same hero side as crature side]
  ; Archer: here it's missing a check for spell type, it skips for all the spells casted by the same side (even when it's a damaging spell).
  ; Also we miss out the magic resistance from Stoic Watchman

  !!FU(Check_Com_Masteries):Py5/0/0/0/d/?y30/d/d/d/d/d/d/d/d/d/1; [Get commander class resistance dwarf type in y30]
  !!MR:F?y40;
  !!VRy40:+y30;                         [Add MR from com class to current MR value]
  !!VRy40&y40>100:S100;
  !!MR:Fy40;                            [Apply increased resistance chance to that stack temporarily]
  *!SN:W^Total_MR2_Value^/dy30;  
!!en;


!?FU(ACM_Calc_Commander_Magic_Resistance);
*Calculates Magic Resistance Dwarf and Golem type for the commander
x1=Commander ID, x2 returns MR (D), x3 returns MR (G)

Dwarf Type MR
  !!HEx1:S26/?y10;                      [Check Resistance skill of Hero]
  !!SN:W^H3_Resistance_0_Hero%X1^/?y11;
  !!SN:W^H3_Resistance_1_Hero%X1^/?y12;
  !!VRy16:S0;                           [Initialise to zero]
  !!FU(Check_Com_Masteries):Px1/0/0/0/d/?y16/d/d/d/d/d/d/d/d/d/1; [Get commander class resistance dwarf type in y16]
  !!VRy16&y10=1/y11=0/y12=0:+10;        [Basic]
  !!VRy16&y10=2/y11=0/y12=0:+15;        [Advanced]
  !!VRy16&y10=3/y11=0/y12=0:+20;        [Expert]
  !!VRy16&y10=3/y11=1/y12=0:+25;        [Master]
  !!VRy16&y10=3/y11=1/y12=1:+30;        [Grandmaster]
  !!HEx1:A2/57/?y10/?y15; !!VRy16&y15=1:+10; [57 Garniture of Interference]
  !!HEx1:A2/58/?y10/?y15; !!VRy16&y15=1:+15; [58 Surcoat of Counterpoise]
  !!HEx1:A2/59/?y10/?y15; !!VRy16&y15=1:+20; [59 Boots of Polarity]
  !!HEx1:A2/(ART_STOIC_WATCHMAN)/?y10/?y15; !!VRy16&y15>0:+10;
  !!VRx2:Sy16;                          [Return MR D value in x2]

Golem Type MR
  !!COx1:S4/?y10;                       [Get Magic Level and Level of Commander]
  !!VRy16:S0;                           [Initialise to zero]
  !!FU(Check_Com_Masteries):Px1/0/0/0/d/d/?y16/d/d/d/d/d/d/d/d/1; [Get commander class resistance golem type in y16]
  !!VRy16&y10=1:+10;                    [Basic]
  !!VRy16&y10=2:+15;                    [Advanced]
  !!VRy16&y10=3:+20;                    [Expert]
  !!VRy16&y10=4:+30;                    [Master]
  !!VRy16&y10=5:+40;                    [Grandmaster]

  !!HEx1:S26/?y10;                      [Check Resistance skill of Hero]
  !!SN:W^H3_Resistance_0_Hero%X1^/?y11;
  !!SN:W^H3_Resistance_1_Hero%X1^/?y12;
  !!VRy16&y10=1/y11=0/y12=0:+10;        [Basic]
  !!VRy16&y10=2/y11=0/y12=0:+15;        [Advanced]
  !!VRy16&y10=3/y11=0/y12=0:+20;        [Expert]
  !!VRy16&y10=3/y11=1/y12=0:+25;        [Master]
  !!VRy16&y10=3/y11=1/y12=1:+30;        [Grandmaster]
  !!VRx3:Sy16;                          [Return MR G value in x3]


!?MF1;
*Defender Mastery: Attacks slow the target 
!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676;[Only run when melee or shooting damage]
  !!BG:A?y1;
  !!if|y1=6/y1=7;                       [If Melee or Range]
    !!BG:N?y1;                          [Attacking Stack]
    !!MF:N?y4;                          [damage receiving stack]
    !!SN:W^Defender_Mastery_Attacking_Stack^/?y50;
    !!VRy1&y4=y1/y50>=0/y50<=41:Sy50;   [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
    !!SN:W^Defender_Mastery_Attacking_Stack^/y4;
    !!BMy1:I?y5 T?y6;                   [Side index as for heroes (0:left, 1:right) and creature type]
    !!BA:Hy5/?y99; !!FU&y99<0:E;        [Get Hero and exit if none]
    !!if&y6>=174/y6<=191;               [If commander type]
      !!FU(Check_Com_Masteries):Py99/?y40/0/0/?y41; [Pass Hero Number and return if Commander Mastery is enabled]
      !!SN:W^Commander_%Y99_Ancient_Defender^/?y98; [Check for Ancient Defender Commander]
      !!VRy40&y98=1:S1; !!VRy41&y98=1:S3;[enable passive for Ancient Defender]
      !!if&y40=1/y41=3;                 [Exit if no Mastery for Defender]
        !!VRy77:S0R1; !!FU&y77=0:E;     [50 percent chance to work]
        !!VRy60:S1R1;                   [Generate random value between 1 and 2]
        !!BMy4:Sd-y60 Ad-y60;           [Speed and Attack -x  slows by 1 or 2 ]
        !!BMy4:S?y22; !!VRy22&y22<=3:S3; !!BMy4:Sy22; [Speed cannot be reduced below 3]
        !!BMy4:A?y22; !!VRy22&y22<=1:S1; !!BMy4:Ay22; [Attack cannot be reduced below 1]
      !!en;
    !!en;
  !!en;
!!en;


On Battle Start set chance to generate Res to 100%

!#SN:W^Att_Prospector_Res_Chance^/100;
!#SN:W^Def_Prospector_Res_Chance^/100;

!?BF;
!!SN:W^Att_Prospector_Res_Chance^/100;
!!SN:W^Def_Prospector_Res_Chance^/100;

!?MF1; 
*Commander Scouts generate Resources with attacks in combat 50% chance
!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676;[Only run when melee or shooting damage]
  !!BG:A?y1;
  !!if|y1=6/y1=7;                       [If Melee or Range]
    !!BG:N?y1;                          [Attacking Stack]
    !!MF:N?y4 F?y7;                     [damage receiving stack and damage dealt]
    !!SN:W^Scout_Mastery_Attacking_Stack^/?y50;
    !!VRy1&y4=y1/y50>=0/y50<=41:Sy50;   [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
    !!SN:W^Scout_Mastery_Attacking_Stack^/y4;
    !!BMy1:I?y5 T?y6;                   [Side index as for heroes (0:left, 1:right) and creature Type]
    !!BA:Hy5/?y99;
    !!FU(Check_Com_Masteries):Py99/?y40/?y42/0/?y41; [Pass Hero Number and return if Commander Mastery is enabled]
    !!SN&y5=0:W^Att_Prospector_Res_Chance^/?y61;
    !!SN&y5=1:W^Def_Prospector_Res_Chance^/?y61;
    !!VRy60:S0R99;                      [33% chance to generate ressource]    
    !!SN:W^Scout_Mastery_Attacking_Stack^/y4;
    !!SN:W^Scout_Mastery_Attacking_Stack^/y4;    
    !!FU|y99<0/y7<=0/y41<>17/y60>y61:E; [Get Hero and exit if none or zero damage dealt, or no Scout Class Commander]
    !!if&y6>=174/y6<=191;               [If any Commander is striking]
      !!HEy99:O?y8;                     [Get Hero Owner]
      !!VRy9:S0R5;                      [Generate random resource type]
      !!VRy10:S1R1; !!VRy10&y40=1:+1;   [If Mastery enabled increase amount by +1]
      !!VRy42:+100;                     [current kill count +100 to make percentage based]
      !!VRy10:*y42:100;                 [Increase Res amount based on Kill Count]
      !!VRy10&y9=6:*100;                [Generate Res amount and increase if Gold]
      !!OW:Ry8/y9/dy10;                 [Add resources to player]
      !!VRz2:S^~>SMALRES.def:%Y9^;      [LOL smart trick Perry ;-)]
      !!SN&i^battle_isVisible^:T^AC_Misc.Com_Scout_Res^/?z1/^amount^/y10/^resources^/z2; [Get String]
      !!BU&i^battle_isVisible^:Mz1;     [Show Message in Battle Log]
      !!SN:W^Scout_Res_Player_%Y8_Res_%Y9^/dy10;
      !!SN&y5=0:W^Att_Prospector_Res_Chance^/d-10; [reduce chance for next attack by 10%]
      !!SN&y5=1:W^Def_Prospector_Res_Chance^/d-10;
      !!SN&y5=0:W^Att_Prospector_Res_Chance^/?y61; [get current chance]
      !!SN&y5=1:W^Def_Prospector_Res_Chance^/?y61;
      !!VRy61&y61<20:S20;               [chance cannot be below 20% with each attack]
      !!SN&y5=0:W^Att_Prospector_Res_Chance^/y61; [set chance]
      !!SN&y5=1:W^Def_Prospector_Res_Chance^/y61;       
    !!en;
  !!en;
!!en;


****************************************************************************************************
*Increase Creature bank reward with Statesman's Medal
!?OB16&1000;                            [16 Creature Bank]
!!HE-1:N?y1;
!!FU(Statesman_CB_Bonus1)&y1>=0/y1<=155:Py1;

!?OB24&1000;                            [24 Derelict Ship]
!!HE-1:N?y1;
!!FU(Statesman_CB_Bonus1)&y1>=0/y1<=155:Py1;

!?OB25&1000;                            [25 Dragon Utopia]
!!HE-1:N?y1;
!!FU(Statesman_CB_Bonus1)&y1>=0/y1<=155:Py1;

!?OB84&1000;                            [84 Crypt]
!!HE-1:N?y1;
!!FU(Statesman_CB_Bonus1)&y1>=0/y1<=155:Py1;

!?OB85&1000;                            [85 Shipwreck]
!!HE-1:N?y1;
!!FU(Statesman_CB_Bonus1)&y1>=0/y1<=155:Py1;

!$OB16&1000;                            [16 Creature Bank]
!!HE-1:N?y1;
!!FU(Statesman_CB_Bonus2)&y1>=0/y1<=155:Py1;

!$OB24&1000;                            [24 Derelict Ship]
!!HE-1:N?y1;
!!FU(Statesman_CB_Bonus2)&y1>=0/y1<=155:Py1;

!$OB25&1000;                            [25 Dragon Utopia]
!!HE-1:N?y1;
!!FU(Statesman_CB_Bonus2)&y1>=0/y1<=155:Py1;

!$OB84&1000;                            [84 Crypt]
!!HE-1:N?y1;
!!FU(Statesman_CB_Bonus2)&y1>=0/y1<=155:Py1;

!$OB85&1000;                            [85 Shipwreck]
!!HE-1:N?y1;
!!FU(Statesman_CB_Bonus2)&y1>=0/y1<=155:Py1;


!?FU(Statesman_CB_Bonus1);

!!SN:W^Creature Bank visit^/0;
!!SN:W^Creature Bank Reward^/0;
!!HEx1:A2/66/?y49/?y66;
!!SN&y66=1:W^Creature Bank visit^/1;
!!SN&y66=0:W^Creature Bank visit^/0;


!?FU(Statesman_CB_Bonus2);

!!HEx1:O?y3;
!!SN:W^Hero_Attacker_Owner0^/?y2;       [Check Owner Before Fight]
!!SN:W^Creature Bank Reward^/?y5;
!!FU|y3<>y2/y5<>1:E;                    [Exit if Hero has lost the Battle or didnt do a battle at all]

!!HEx1:E?y50/?y51/1; !!VRy52:Sy51*200;  [Get Hero Level]
!!HEx1:A2/66/?y49/?y66;
!!HEx1:A2/67/?y49/?y67;
!!HEx1:A2/68/?y49/?y68;
!!VRy69&y66=1/y67=1/y68=1:S1;           [Double Bonus if complete Set]

!!VRy20&y66=1:S1000+y52;                [1000+HeroLevel*200]
!!VRy20&y69=1:*2;                       [Double if set complete]
!!SN:T^AC_Misc.Statesman's Medal Bonus^/?z-9/^gold^y20;
!!IF&1000/999:M1/z-9;

!!OW:Ry3/6/dy20;
!!SN:W^Creature Bank visit^/0;
!!SN:W^Creature Bank Reward^/0;

!?FU(OnBattlefieldVisible)&1000;
!!SN:W^Creature Bank visit^/?y1;
!!SN:W^Creature Bank visit^/0;
!!SN&y1=1:W^Creature Bank Reward^/1;


*Gold and Resource giving artifacs also work in backpack*
; Disabled as Era Scripts - Backpack Artifacts opition works better
Perry: I dont think it works better in all regards. Skill description looks worse. Res amount from Wood and Ore is less. Gives free movement with Boots and Gloves which feels very strong
!?FU(OnEveryDay)&i^timerOnce^=1/i^timerDay^>1/i^timerIsAi^=0; [Trigger each day]

Fix for Cart of Lumber and Cart of Ore give +2 in total
!!DO(AC_Function_40)/0/155/1:P;         [loop through heroes]

!?FU(AC_Function_40);
!!HEx16:O?y1;                           [Checke Hero Owner]
!!FU&y1=-1:E;                           [Exit if none]

!!HEx16:A2/112/?y30/?y40; !!OW&y40>0:Ry1/2/dy40; [112 Inexhaustible Cart of Ore gives +2 in total]
!!HEx16:A2/114/?y30/?y40; !!OW&y40>0:Ry1/0/dy40; [114 Inexhaustible Cart of Lumber gives +2 in total]

!!HEx16:A2/109/?y30/?y40; !!VRy31:Sy30-y40; !!VRy31:Sy31*1; !!OW&y31>0/y30<>y40:Ry1/4/dy31; [109 Everflowing Crystal Cloak Add 1 Crystal resource to player]
!!HEx16:A2/110/?y30/?y40; !!VRy31:Sy30-y40; !!VRy31:Sy31*1; !!OW&y31>0/y30<>y40:Ry1/5/dy31; [110 Ring of Infinite Gems]
!!HEx16:A2/111/?y30/?y40; !!VRy31:Sy30-y40; !!VRy31:Sy31*1; !!OW&y31>0/y30<>y40:Ry1/1/dy31; [111 Everpouring Vial of Mercury]
!!HEx16:A2/112/?y30/?y40; !!VRy31:Sy30-y40; !!VRy31:Sy31*2; !!OW&y31>0/y30<>y40:Ry1/2/dy31; [112 Inexhaustible Cart of Ore]
!!HEx16:A2/113/?y30/?y40; !!VRy31:Sy30-y40; !!VRy31:Sy31*1; !!OW&y31>0/y30<>y40:Ry1/3/dy31; [113 Eversmoking Ring of Sulfur]
!!HEx16:A2/114/?y30/?y40; !!VRy31:Sy30-y40; !!VRy31:Sy31*2; !!OW&y31>0/y30<>y40:Ry1/0/dy31; [114 Inexhaustible Cart of Lumber]
!!HEx16:A2/115/?y30/?y40; !!VRy31:Sy30-y40; !!VRy31:Sy31*1000; !!OW&y31>0/y30<>y40:Ry1/6/dy31; [115 Endless Sack of Gold]
!!HEx16:A2/116/?y30/?y40; !!VRy31:Sy30-y40; !!VRy31:Sy31*750; !!OW&y31>0/y30<>y40:Ry1/6/dy31; [116 Endless Bag of Gold]
!!HEx16:A2/117/?y30/?y40; !!VRy31:Sy30-y40; !!VRy31:Sy31*500; !!OW&y31>0/y30<>y40:Ry1/6/dy31; [117 Endless Purse of Gold]

!!HEx16:A2/140/?y30/?y40; !!VRy30&y40=1:-5; [140 Cornucopia Adds 5 of each Resource]
!!OW&y30>0:Ry1/4/d5; !!OW&y30>0:Ry1/5/d5; !!OW&y30>0:Ry1/1/d5; !!OW&y30>0:Ry1/3/d5;               
                  

****************************************************************************************************
*Luck reducing Artifacts

!?FU(OnStartOrLoad);                      [At gamestart]
!!SN:L^EraPlugins\erm_hooker.era^/?y1;

!!if&y1;
  !!SN:Ay1/^SetHook^/?y2;
  !!SN:Ey2/1/4447493/(ACM_OnCombatStack_SetLuck); [hook for all creatures]
  !!SN:Ey2/1/4447480/(ACM_OnCombatStack_SetLuck); [hook for halfings or if we have any native luck suppression conditions]
!!en;

!?FU(ACM_OnCombatStack_SetLuck);
!!UN:Cx1/(STRUCT_HOOK_CONTEXT_EDI)/4/?(combatStack:y); [get combat creature from stack]
!!UN:Cx1/(STRUCT_HOOK_CONTEXT_EBP)/4/?(ebp:y)  C(ebp)/28/4/?(specialGroundType:y); [get combat terrain just in case]
!!UN:C(combatStack)/244/4/?(side:y) C(combatStack)/248/4/?(idBySide:y); [get combat stack' side/index per side]
!!VR(stackId:y):S(side) *(BATTLE_STACKS_PER_SIDE) +(idBySide); [get combat stack id]
!!UN:C(combatStack)/1260/4/?(stackLuck:y); [get current calculated luck level]

!!FU(gem_CombatStack_SetLuck):P(stackId)/?(stackLuck)/(specialGroundType); [call calculation function: use it everywhere anytime you need]

!!if&(side)=0;
  !!SN:W^Negative_Luck_Def^/?y10;
  !!VRy10:*-1;
  !!VR(stackLuck:y):+y10;
  !!UN:C(combatStack)/1260/4/(stackLuck:y); [set new luck level. this check been called always when combat stack luck function being called]
!!en;

!!if&(side)=1;
  !!SN:W^Negative_Luck_Att^/?y10;
  !!VRy10:*-1;
  !!VR(stackLuck:y):+y10;
  !!UN:C(combatStack)/1260/4/(stackLuck:y); [set new luck level. this check been called always when combat stack luck function being called]
!!en;


!?BF;
!!BH0:N?y1;                             [Attacker]
!!FU(ACM_Count_Negative_Luck):Py1/?y2/0;[Pass Hero and return negative Luck, pass side]
!!BH1:N?y1;                             [Defender]
!!FU&y1<0:E; 
!!FU(ACM_Count_Negative_Luck):Py1/?y2/1;[Pass Hero and return negative Luck, pass side]


!?FU(ACM_Count_Negative_Luck);
x1=Hero ID, x2=returns Luck
!!SN&x3=0:W^Negative_Luck_Att^/0;
!!SN&x3=1:W^Negative_Luck_Def^/0;
!!VRy10:S0;

!!FU(Count_Set_Pieces):Px1/0/0/0/0/?y4; [Count Set Pieces function]
!!VRy10&y4>=3:+1;
!!HEx1:A2/47/?y3/?y4;                   [Attacker Cards of Prophecy]
!!VRy10&y4=1:+1;
!!HEx1:A2/14/?y3/?y4;                   [Attacker Shield of the Yawning Dead]
!!VRy10&y4=1:+1;
!!HEx1:A2/63/?y3/?y4;                   [Attacker Bird of Perception]
!!VRy10&y4=1:+1;

!!VRy10&y10>=3:S3;                      [cannot be more than 3 negative Luck]
!!VRx2:Sy10;                            [return value in x3]
!!SN&x3=0:W^Negative_Luck_Att^/y10;     [set luck in variabel]
!!SN&x3=1:W^Negative_Luck_Def^/y10;


*legacy code that is disabled below
!?BR&v997<>-1;
!!FU:E;                                 [replaced code]
!!FU(Reduce_Luck0):P;
!?BG1;
!!FU:E;                                 [replaced code]
!!FU(Reduce_Luck0):P;
!?FU(Reduce_Luck0);
!!BA:H0/?y1 H1/?y2;

!!HEy1:A2/47/?y3/?y4;                   [Attacker Cards of Prophecy]
!!DO(Reduce_Luck1)/21/41/1&y4>0:P4;

!!HEy1:A2/14/?y3/?y4;                   [Attacker Shield of the Yawning Dead]
!!DO(Reduce_Luck1)/21/41/1&y4>0:P4;

!!HEy1:A2/63/?y3/?y4;                   [Attacker Bird of Perception]
!!DO(Reduce_Luck1)/21/41/1&y4>0:P4;

!!HEy1:A2/51/?y3/?y4;                   [Attacker Glyph of Gallantry]
!!DO(Reduce_Luck1)/21/41/1&y4>0:P4;

!!FU&y2<0:E;                            [Exit if no Defender Hero]
!!HEy2:A2/47/?y3/?y4;
!!DO(Reduce_Luck1)/0/20/1&y4>0:P4;

!!HEy2:A2/14/?y3/?y4;
!!DO(Reduce_Luck1)/0/20/1&y4>0:P4;

!!HEy2:A2/64/?y3/?y4;
!!DO(Reduce_Luck1)/0/20/1&y4>0:P4;

!!HEy2:A2/51/?y3/?y4;
!!DO(Reduce_Luck1)/0/20/1&y4>0:P4;


!?FU(Reduce_Luck1);
!!if&x1=4;
  !!BMx16:N?y3;                         [Get number]
  !!if&y3>0;                            [if a alive stack]
    !!BMx16:G213/?y2/?t;                [213 Luck]
    !!VRy2:-1;                          [add negative Luck to current Luck]
    !!VRy2&y2<=-3:S-3;                  [Cannot be more than -3 Luck]
    !!BMx16:G213/y2/?t;                 [213 Luck]
  !!en;
!!en;


****************
*Surcoat of Counterpoise +2defense
!?AE1&v998=58; Equip Artifact  !!FU&761:E;

!!HE-1:Fd/d2/d/d;                       [58 Surcoat of Counterpoise +2 defense]

!?AE0&v998=58; Unequip Artifact   !!FU&761:E;

!!HE-1:Fd/d-2/d/d;                      [58 Surcoat of Counterpoise -2]


!?FU(OnAfterBattleUniversal);           [59 Boots of Polarity have a chance to give movement bonus after combat]

!!HE(CURRENT_HERO):N?y1;                [Hero Number]
!!FU&y1<>i^battle_hero_0^:E;            [exit if not the attacking hero]
!!HEy1:O?y9;                            [get owner of this hero]
!!FU&y9=-1:E;                           [Exit if no Owner]
!!VRy20:S0R99;
!!HEy1:A2/59/?y29/?y21;                 [Check for Boots]
!!if&y20<=99/y21>0;                     [Archer: 22% chance?]
  !!HEy1:Wd250/1;                       [give calculated free Movement Points]
  !!if&1000;
    !!SN:T^AC_Misc.Polarity_Boots_Bonus^/?z2;
    !!IF:M^%Z2^;
    !!SN:D;
  !!en;
!!en;


****************
*Increased effectiveness of Magic Resistance Artifacts all grant +5% more MR*
57  Garniture of Interference +10%MR
58  Surcoat of Counterpoise +15%MR
59  Boots of Polarity +20%MR
64  Stoic Watchman +10%MR

!?MR2;                                  [Magic Resistance Trigger]

!!MR:N?y1 S?y7;                         [Get Creature Number and Spell Number]
!!BMy1:I?y2 T?y3 P?y4;                  [Get Creature Side]
!!BG:H?y50;                             [Get Casting Hero]
!!BA:Hy2/?y5;                           [Get Hero Number of creature side]
!!FU&y5<0:E;                            [Exit if no Hero]
!!FU&y50=y5:E;                          [Exit for beneficial spells, meaning same hero side as crature side]

!!VRy30:S0;
!!MR:F?y40;
!!HEy5:A2/57/?y29/?y21; !!VRy30&y21=1:+5;[Check for Garniture of Interference]
!!HEy5:A2/58/?y29/?y21; !!VRy30&y21=1:+5;[Check for Surcoat of Counterpoise]
!!HEy5:A2/59/?y29/?y21; !!VRy30&y21=1:+5;[Check for Boots of Polarity]
!!HEy5:A2/64/?y29/?y21; !!VRy30&y21=1:+10; [Check for Stoic Watchman]
!!VRy40:+y30;
*!VRy40&y40>100:S100;
!!MR:Fy40;                              [Apply increased resistance chance to that stack temporarily]

*Test script to add up all MR values
  *!HEy5:S26/?y10;                      [Check Resistance skill of Hero]
  *!SN:W^H3_Resistance_0_Hero%Y5^/?y11;
  *!SN:W^H3_Resistance_1_Hero%Y5^/?y12;
  *!VRy16:S0;                           [Initialise to zero]  
  *!VRy16&y10=1/y11=0/y12=0:+10;        [Basic]
  *!VRy16&y10=2/y11=0/y12=0:+15;        [Advanced]
  *!VRy16&y10=3/y11=0/y12=0:+20;        [Expert]
  *!VRy16&y10=3/y11=1/y12=0:+25;        [Master]
  *!VRy16&y10=3/y11=1/y12=1:+30;        [Grandmaster]
  *!HEy5:A2/57/?y10/?y15; *!VRy16&y15=1:+10; [57 Garniture of Interference]
  *!HEy5:A2/58/?y10/?y15; *!VRy16&y15=1:+15; [58 Surcoat of Counterpoise]
  *!HEy5:A2/59/?y10/?y15; *!VRy16&y15=1:+20; [59 Boots of Polarity]
  *!HEy5:A2/64/?y10/?y15; *!VRy16&y15=1:+10; [Check for Stoic Watchman]
  *!IF:L^y16 is %Y16^;
  *!SN:W^Total_MR2_Value^/dy16;

****************
*Crest of Valor increases stats of Henchman and Commander by +15%

!?FU(OnCombatRound)&v997=0;             [On First visible combat round]
!!BA:H0/?y1;
!!HEy1:A2/50/?y3/?y2;                   [50  Crest of Valor Attacker]

!!if&y2=1;
  !!re i/0/10;
  !!BMi:T?y3 P?y4;                      [Get Creature Type and Position]
    *!if&y3>=174/y3<=182|y4=20;         [If Commander or Henchmen found for Attacker]
    !!if&y4=20;                         [If Henchmen found for Attacker]
    !!VRy10:S115;                       [Coefficient for parameter increase +15%]
    !!BMi:A?y5; !!VRy5:*y10:100; !!BMi:Ay5; [Set Attack]
    !!BMi:D?y5; !!VRy5:*y10:100; !!BMi:Dy5; [Set Defense]
    !!BMi:H?y5; !!VRy5:*y10:100; !!BMi:Hy5; [Set Health]
    !!BMi:U1/?y5 U2/?y6; !!VRy5:*y10:100; !!VRy6:*y10:100; !!BMi:U1/y5 U2/y6; [Set Min+Max Damage]
    !!BMi:S?y5; !!VRy5:*y10:100; !!BMi:Sy5; [add Speed]
    !!en;
  !!en;
!!en;


!!BA:H1/?y1; !!FU&y1<0:E;               [Exit if no Defending Hero]
!!HEy1:A2/50/?y3/?y2;                   [50  Crest of Valor Defender]

!!if&y2=1;
  !!re i/21/31;
  !!BMi:T?y3 P?y4;                      [Get Creature Type and Position]
    *!if&y3>=183/y3<=191|y4=30;         [If Commander or Henchmen found for Defender]
    !!if&y4=30;                         [If Henchmen found for Defender]
    !!VRy10:S115;                       [Coefficient for parameter increase +15%]
    !!BMi:A?y5; !!VRy5:*y10:100; !!BMi:Ay5; [Set Attack]
    !!BMi:D?y5; !!VRy5:*y10:100; !!BMi:Dy5; [Set Defense]
    !!BMi:H?y5; !!VRy5:*y10:100; !!BMi:Hy5; [Set Health]
    !!BMi:U1/?y5 U2/?y6; !!VRy5:*y10:100; !!VRy6:*y10:100; !!BMi:U1/y5 U2/y6; [Set Min+Max Damage]
    !!BMi:S?y5; !!VRy5:*y10:100; !!BMi:Sy5; [add Speed]
    !!en;
  !!en;
!!en;


****************
*Glyph of Galantry gives a few creatures to your army every week, triggers for each player seperatly
!?FU(OnEveryDay)&i^timerDay^>1/i^timerWeekDay^=1/i^timerIsAi^=0;
!!OW:C?y1;
!!DO(AC_Function_Glyph_of_Galantry0)/0/155/1:Py1;

!?FU(AC_Function_Glyph_of_Galantry0);
!!HEx16:O?y1;                           [Checke Hero Owner]
!!FU&y1=-1:E;                           [Exit if none]
!!HEx16:O?y1;
!!FU&y1<>x1:E;
!!HEx16:A2/51/?y3/?y2;                  [51  Glyph of Gallantry]
!!FU&y2=0:E;                            [Exit if Arti not equipped]
!!HEx16:B0/?z4;                         [get hero name]

!!re i/0/30;
  !!VRy98:S0R6;                         [Generate random slot]
  !!HEx16:C0/y98/?y1/?y2;               [Check Heroes army]
  !!if&y2>0/y1>=0;                      [if slot is occupied]
  !!MA:Ly1/?y20;                        [get monster level]
  !!if&y20<6;                           [Does not work for level 7 creatures]
    !!VRy3:S1;
    !!VRy3&y20=0:S10R13;                [Set Number of creatures for 1 level]
    !!VRy3&y20=1:S7R10;                 [Set Number of creatures for 2 level]
    !!VRy3&y20=2:S5R8;                  [Set Number of creatures for 3 level]
    !!VRy3&y20=3:S3R6;                  [Set Number of creatures for 4 level]
    !!VRy3&y20=4:S2R4;                  [Set Number of creatures for 5 level]
    !!VRy3&y20=5:S1R2;                  [Set Number of creatures for 6 level]
    !!HEx16:C0/y98/d/dy3/0/0;           [Add Monsters to army]
    !!UN:N3/z3/y1/1;                    [Normal Creature]
    !!SN:T^AC_Warmachine.Glyph_of_Gal_Creatures^/?s^Text^/^crname^/z3/^heroname^/z4;
    !!IF&1000:M^%S(Text)^;              [Show text if already bought]
    !!br;                               [Exit loop if creatues was added]
  !!en;
  !!en;
!!en;


*****************
!?HL-1&i^acm_isGameStarted^;            [Works only after entering the map]
!!HE-1:O?y30;                           [Exit if AI's hero (they have their own script)]
!!OW:Iy30/?y31;
!!FU&y31:E;

The Champions Honor full set grants Warmachine Upgrades at level up with a 20%/50% chance
!!HE-1:N?y1;                            [Get Hero Number]
!!FU(Count_Set_Pieces)&y1>=0/y1<=155:Py1/0/0/0/?y93; [Count Set Pieces function, check for Champions Honor Set]
!!FU&y93<2:E;                           [Exit if not at least 2 set pieces]

!!VRy10:S0R100;
!!VRy20:S0;
!!VRy20&y93>=2:S20;                     [With 2 set pieces give a 20% chance]
!!VRy20&y93=4:S+30;                     [With 4 set pieces give a 50% chance]

!!if&y10<y20;                           [If roll is successful]
  !!VRy2:S1R23;                         [Generate Random Number from 1-24]
  !!SN&y2=1:W^Ballista_Fireball_Attack_%Y1^/?y3; !!SN&y2=1/y3=0:W^Ballista_Fireball_Attack_%Y1^/1; !!SN&y2=1/y3=0:T^AC_Warmachine.Bal_Ench_1^/?z-1; !!SN&y2=1/y3=0:T^AC_Warmachine.Bal_Ench_1_Description^/?z2;
  !!SN&y2=2:W^Ballista_Magic_Arrow_%Y1^/?y3; !!SN&y2=2/y3=0:W^Ballista_Magic_Arrow_%Y1^/1; !!SN&y2=2/y3=0:T^AC_Warmachine.Bal_Ench_2^/?z-1; !!SN&y2=2/y3=0:T^AC_Warmachine.Bal_Ench_2_Description^/?z2;
  !!SN&y2=3:W^Ballista_Spell_Trigger_%Y1^/?y3; !!SN&y2=3/y3=0:W^Ballista_Spell_Trigger_%Y1^/1; !!SN&y2=3/y3=0:T^AC_Warmachine.Bal_Ench_3^/?z-1; !!SN&y2=3/y3=0:T^AC_Warmachine.Bal_Ench_3_Description^/?z2;
  !!SN&y2=4:W^Ammo_Booby_Trap_%Y1^/?y3; !!SN&y2=4/y3=0:W^Ammo_Booby_Trap_%Y1^/1; !!SN&y2=4/y3=0:T^AC_Warmachine.Cart_Ench_1^/?z-1; !!SN&y2=4/y3=0:T^AC_Warmachine.Cart_Ench_1_Description^/?z2;
  !!SN&y2=5:W^Ammo_Replensih_SP_%Y1^/?y3; !!SN&y2=5/y3=0:W^Ammo_Replensih_SP_%Y1^/1; !!SN&y2=5/y3=0:T^AC_Warmachine.Cart_Ench_2^/?z-1; !!SN&y2=5/y3=0:T^AC_Warmachine.Cart_Ench_2_Description^/?z2;
  !!SN&y2=6:W^Ammo_Burning_Arrow_%Y1^/?y3; !!SN&y2=6/y3=0:W^Ammo_Burning_Arrow_%Y1^/1; !!SN&y2=6/y3=0:T^AC_Warmachine.Cart_Ench_3^/?z-1; !!SN&y2=6/y3=0:T^AC_Warmachine.Cart_Ench_3_Description^/?z2;
  !!SN&y2=7:W^Tent_Herbalism_%Y1^/?y3; !!SN&y2=7/y3=0:W^Tent_Herbalism_%Y1^/1; !!SN&y2=7/y3=0:T^AC_Warmachine.Tent_Ench_1^/?z-1; !!SN&y2=7/y3=0:T^AC_Warmachine.Tent_Ench_1_Description^/?z2;
  !!SN&y2=8:W^Tent_Overheal_%Y1^/?y3; !!SN&y2=8/y3=0:W^Tent_Overheal_%Y1^/1; !!SN&y2=8/y3=0:T^AC_Warmachine.Tent_Ench_2^/?z-1; !!SN&y2=8/y3=0:T^AC_Warmachine.Tent_Ench_2_Description^/?z2;
  !!SN&y2=9:W^Tent_Life_Aura_%Y1^/?y3; !!SN&y2=9/y3=0:W^Tent_Life_Aura_%Y1^/1; !!SN&y2=9/y3=0:T^AC_Warmachine.Tent_Ench_3^/?z-1; !!SN&y2=9/y3=0:T^AC_Warmachine.Tent_Ench_3_Description^/?z2;
  !!SN&y2=10:W^WM_Shield_Ench_%Y1^/?y3; !!SN&y2=10/y3=0:W^WM_Shield_Ench_%Y1^/1; !!SN&y2=10/y3=0:T^AC_Warmachine.All_Ench_1^/?z-1; !!SN&y2=10/y3=0:T^AC_Warmachine.All_WM_Ench_1_Description^/?z2;
  !!SN&y2=11:W^WM_MR_Ench_%Y1^/?y3; !!SN&y2=11/y3=0:W^WM_MR_Ench_%Y1^/1; !!SN&y2=11/y3=0:T^AC_Warmachine.All_Ench_2^/?z-1; !!SN&y2=11/y3=0:T^AC_Warmachine.All_WM_Ench_2_Description^/?z2;
  !!SN&y2=12:W^WM_MR_Aura_%Y1^/?y3; !!SN&y2=12/y3=0:W^WM_MR_Aura_%Y1^/1; !!SN&y2=12/y3=0:T^AC_Warmachine.All_Ench_3^/?z-1; !!SN&y2=12/y3=0:T^AC_Warmachine.All_WM_Ench_3_Description^/?z2;
  !!SN&y2=13:W^Ballista_Morale_%Y1^/?y3; !!SN&y2=13/y3=0:W^Ballista_Morale_%Y1^/1; !!SN&y2=13/y3=0:T^AC_Warmachine.Bal_Upg_1^/?z-1; !!SN&y2=13/y3=0:T^AC_Warmachine.Bal_Upg_1_Description^/?z2;
  !!SN&y2=14:W^Ballista_Add_Shots_%Y1^/?y3; !!SN&y2=14/y3=0:W^Ballista_Add_Shots_%Y1^/1; !!SN&y2=14/y3=0:T^AC_Warmachine.Bal_Upg_2^/?z-1; !!SN&y2=14/y3=0:T^AC_Warmachine.Bal_Upg_2_Description^/?z2;
  !!SN&y2=15:W^Ballista_Crippling_%Y1^/?y3; !!SN&y2=15/y3=0:W^Ballista_Crippling_%Y1^/1; !!SN&y2=15/y3=0:T^AC_Warmachine.Bal_Upg_3^/?z-1; !!SN&y2=15/y3=0:T^AC_Warmachine.Bal_Upg_3_Description^/?z2;
  !!SN&y2=16:W^Ammo_Supply_%Y1^/?y3; !!SN&y2=16/y3=0:W^Ammo_Supply_%Y1^/1; !!SN&y2=16/y3=0:T^AC_Warmachine.Cart_Upg_1^/?z-1; !!SN&y2=16/y3=0:T^AC_Warmachine.Cart_Upg_1_Description^/?z2;
  !!SN&y2=17:W^Ammo_Goblin_%Y1^/?y3; !!SN&y2=17/y3=0:W^Ammo_Goblin_%Y1^/1; !!SN&y2=17/y3=0:T^AC_Warmachine.Cart_Upg_2^/?z-1; !!SN&y2=17/y3=0:T^AC_Warmachine.Cart_Upg_2_Description^/?z2;
  !!SN&y2=18:W^Ammo_Enhanced_Arrow_%Y1^/?y3; !!SN&y2=18/y3=0:W^Ammo_Enhanced_Arrow_%Y1^/1; !!SN&y2=18/y3=0:T^AC_Warmachine.Cart_Upg_3^/?z-1; !!SN&y2=18/y3=0:T^AC_Warmachine.Cart_Upg_3_Description^/?z2;
  !!SN&y2=19:W^Tent_Improved_%Y1^/?y3; !!SN&y2=19/y3=0:W^Tent_Improved_%Y1^/1; !!SN&y2=19/y3=0:T^AC_Warmachine.Tent_Upg_1^/?z-1; !!SN&y2=19/y3=0:T^AC_Warmachine.Tent_Upg_1_Description^/?z2;
  !!SN&y2=20:W^Tent_Capacity_Upgrade_%Y1^/?y3; !!SN&y2=20/y3=0:W^Tent_Capacity_Upgrade_%Y1^/1; !!SN&y2=20/y3=0:T^AC_Warmachine.Tent_Upg_2^/?z-1; !!SN&y2=20/y3=0:T^AC_Warmachine.Tent_Upg_2_Description^/?z2;
  !!SN&y2=21:W^Tent_Gold_Gain_%Y1^/?y3; !!SN&y2=21/y3=0:W^Tent_Gold_Gain_%Y1^/1; !!SN&y2=21/y3=0:T^AC_Warmachine.Tent_Upg_3^/?z-1; !!SN&y2=21/y3=0:T^AC_Warmachine.Tent_Upg_3_Description^/?z2;
  !!SN&y2=22:W^WM_Fortification_%Y1^/?y3; !!SN&y2=22/y3=0:W^WM_Fortification_%Y1^/1; !!SN&y2=22/y3=0:T^AC_Warmachine.All_Upg_1^/?z-1; !!SN&y2=22/y3=0:T^AC_Warmachine.All_WM_Upg_1_Description^/?z2;
  !!SN&y2=23:W^WM_Maintainability_%Y1^/?y3; !!SN&y2=23/y3=0:W^WM_Maintainability_%Y1^/1; !!SN&y2=23/y3=0:T^AC_Warmachine.All_Upg_2^/?z-1; !!SN&y2=23/y3=0:T^AC_Warmachine.All_WM_Upg_2_Description^/?z2;
  !!SN&y2=24:W^WM_Versatility_%Y1^/?y3; !!SN&y2=24/y3=0:W^WM_Versatility_%Y1^/1; !!SN&y2=24/y3=0:T^AC_Warmachine.All_Upg_3^/?z-1; !!SN&y2=24/y3=0:T^AC_Warmachine.All_WM_Upg_3_Description^/?z2;

  !!SN:Iz2/?z2;                         [Interpolate String]
  !!if&y3=0;                            [When the upgrade is unknown to the hero display the text]
    !!SN:T^AC_Warmachine.Champions_Honor_Set_WM^/?z3;
    !!IF:M^%Z3


    %Z2^;
  !!en;
!!en;

!!VRy10:S0R100;
!!VRy20:S0;
!!VRy20&y93>=3:S25;                     [With 3 set pieces give a 25% chance for extra Prim Skill]
!!if&y10<=y20;                          [If roll is successful]
  !!VRy96:S1R3;
  !!SN:T^AC_Warmachine.Champions_Honor_Set_Skill^/?z21;
  !!IF&y96=1:Q2/31/1/1^%Z21^;
  !!HEy1&y96=1:Fd1/d/d/d;
  !!IF&y96=2:Q2/32/1/1^%Z21^;
  !!HEy1&y96=2:Fd/d1/d/d;
  !!IF&y96=3:Q2/33/1/1^%Z21^;
  !!HEy1&y96=3:Fd/d/d1/d;
  !!IF&y96=4:Q2/34/1/1^%Z21^;
  !!HEy1&y96=4:Fd/d/d/d1;
  !!UN:R1;                              [redraw hero screen]
!!en;


******************************End of Artefact Section***************************







********************************************************************************
*Set Artifact Descriptions at Map Start*
!?FU(OnGameEnter);

!!UN:P102/?y2;                          [Check for Artifact Boost]
!!UN:P71/?y3;                           [Check for Enhanced Artifacts]
!!SN:W^Spell_Trainer_Mod^/?y4;          [Spell Trainer Mod Active]
!!SN:W^Magic_Artillery_Mod^/?y5;        [Magic Artillery Mod Active]
!!SN:W^Mystik_Skill_Enhancement_Mod^/?y6;[Mystik_Skill_Enhancement Mod Active]
!!SN:W^Luck_Skill_Enhancement^/?y7;     [Not currently used]

!!VRy5:S1;                              [Activate Eagle Eye Description Magic Artillery]

*-------Books-------*
!!SN:H^art^/86/1/z188108;               [Tome of Fire]
!!SN:H^art^/87/1/z188109;               [Tome of Air]
!!SN:H^art^/88/1/z188110;               [Tome of Water]
!!SN:H^art^/89/1/z188111;               [Tome of Earth]
*-------Armor-------*
!!SN:H^art^/24/1/z188165;               [Thunder Helmet]
!!SN:H^art^/30/1/z188166;               [Titan's Cuirass]
!!SN:H^art^/18/1/z188164;               [Sentinel's Shield]
!!SN:H^art^/12/1/z188163;               [Titan's Gladius]
!!SN:H^art^/135/1/z188167;              [Titan's Thunder]
*!SN:H^art^/23/1/z179836;                [Hellstorm Helmet]
!!SN:H^art^/27/1/z179837;               [Scales of the Greater Basilisk]
*!SN:H^art^/29/1/z179839;                [Breastplate of Brimstone]
!!SN:H^art^/124/1/z179841;              [Spellbinder's Hat]
!!SN:H^art^/106/1/z179842;              [Pendant of Negativity]
!!SN:H^art^/127/1/z179843;               [Vial of Dragon Blood]
!!SN:H^art^/128/1/z179844;               [Armageddon's Blade]
!!SN:H^art^/41/1/z179857;                [Dragonbone Greaves]
!!SN:H^art^/42/1/z179858;                [Dragon Wing Tabard]
!!SN:H^art^/43/1/z179859;                [Necklace of Dragonteeth]
!!SN:H^art^/44/1/z179860;                [Crown of Dragontooth]
!!SN:H^art^/39/1/z179861;                [Dragon Scale Shield]
!!SN:H^art^/40/1/z179862;                [Dragon Scale Armor]
!!SN:H^art^/37/1/z179863;                [Quiet Eye of the Dragon]

*-------Moral-------*
!!SN:H^art^/49/1/z188112;                [Badge of Courage]
!!SN:H^art^/50/1/z188113;                [Crest of Valor]
!!SN:H^art^/51/1/z188114;                [Glyph of Gallantry]
!!SN:H^art^/108/1/z188115;               [Pendant of Courage]
*-------Luck-------*
!!SN:H^art^/46/1/z188116;                [Clover of Fortune]
!!SN:H^art^/47/1/z188117;                [Cards of Prophecy]
!!SN:H^art^/48/1/z188118;                [Ladybird of Luck]
!!SN:H^art^/45/1/z188119;                [Still Eye of the Dragon]
*-------Venom Teeth Set-------*
!!SN:H^art^/10/1/z188146;                [Ogre's Club of Havoc]
!!SN:H^art^/15/1/z188144;                [Buckler of the Gnoll King]
!!SN:H^art^/19/1/z188145;                [Helm of the Alabaster Unicorn]
*-------Orbs-------*
!!SN:H^art^/79/1/z188104;                [orb of firmament]
!!SN:H^art^/80/1/z188105;                [orb of silt]
!!SN:H^art^/81/1/z188106;                [orb of tempestous fire]
!!SN:H^art^/82/1/z188107;                [orb of driving rain]
*------Ring of Magi-----*
!!SN:H^art^/76/1/z188120;                [Changed Var Numers         [collar of conjuring]
!!SN:H^art^/77/1/z188121;                [ring of conjuring]
!!SN:H^art^/78/1/z188122;                [cape of conjuring]
!!SN:H^art^/139/1/z188123;               [ring of the magi]
*------Ring of Magi-----*
!!if&y4=1;                               [*Spell Trainer Enabled]
!!SN:H^art^/76/1/z188204;                [collar of conjuring]
!!SN:H^art^/77/1/z188205;                [ring of conjuring]
!!SN:H^art^/78/1/z188206;                [cape of conjuring]
!!SN:H^art^/139/1/z188207;               [ring of the magi]
!!en;
*-------Priest of the Light-----*
!!SN:H^art^/103/1/z188140;               [Pendant of Life]
!!SN:H^art^/13/1/z188141;                [Shield of the Dwarven Lords]
!!SN:H^art^/22/1/z188130;                [Crown of the Supreme Magi]
!!SN:H^art^/25/1/z188175;                [Breastplate of Petrified Wood]
!!SN:H^art^/9/1/z188132;                 [Greater Gnoll's Flail]
!!SN:H^art^/98/1/z188174;                [Boots of Speed]
*-------Priest of the Dark------*
!!SN:H^art^/104/1/z188142;               [Pendant of Death]
!!SN:H^art^/14/1/z188135;                [Shield of the Yawning Dead]
!!SN:H^art^/20/1/z188136;                [Skull Helmet]
!!SN:H^art^/26/1/z188137;                [Rib Cage]
!!SN:H^art^/8/1/z188138;                 [Blackshard of the Dead Knight]
!!SN:H^art^/56/1/z188139;                [Dead Man's Boots]
*-------Resistance Set-------*
!!SN:H^art^/57/1/z188154;                [Garniture of Interference]
!!SN:H^art^/58/1/z188155;                [Surcoat of Counterpoise]
!!SN:H^art^/59/1/z188156;                [Boots of Polarity]
*-------Pegasus Harness-------*
!!SN:H^art^/69/1/z188161;                [Necklace of Swiftness]
!!SN:H^art^/97/1/z188160;                [Ring of the Wayfarer]
!!SN:H^art^/99/1/z188162;                [Cape of Velocity]
*-------Vision of the Eagle----*
!!if&y5=0;                             [*Magic Artillery Disabled]
!!SN:H^art^/63/1/z188148;                [Bird of Perception]
!!SN:H^art^/64/1/z188149;                [Stoic Watchman]
!!SN:H^art^/65/1/z188150;                [Emblem of Cognizance]
!!en;
*-------Vision of the Eagle----*
!!if&y5=1;                             [*Magic Artillery Enabled]
!!SN:H^art^/63/1/z188194;                [Bird of Perception]
!!SN:H^art^/64/1/z188195;                [Stoic Watchman]
!!SN:H^art^/65/1/z188196;                [Emblem of Cognizance]
!!en;
*-------Archdevils Suite------*
!!SN:H^art^/11/1/z188169;                [Sword of Hellfire]
!!SN:H^art^/17/1/z188170;                [Shield of the Damned]
!!SN:H^art^/23/1/z188171;                [Hellstorm Helmet]
!!SN:H^art^/29/1/z188172;                [Breastplate of Brimstone]
!!SN:H^art^/101/1/z188173;               [Pendant of Second Sight]
*-------Angelic Alliance------*
!!SN:H^art^/31/1/z188131; *!UN:A31/5/-1; [Armor of Wonder]
!!SN:H^art^/32/1/z188133; *!UN:A32/5/-1; [Sandals of the Saint]
!!SN:H^art^/33/1/z188177; *!UN:A33/5/-1; [Celestial Necklace of Bliss]
!!SN:H^art^/34/1/z188178; *!UN:A34/5/-1; [Lion's Shield of Courage]
!!SN:H^art^/35/1/z188179; *!UN:A35/5/-1; [Sword of Judgement]
!!SN:H^art^/36/1/z188180; *!UN:A36/5/-1; [Helm of Heavenly Enlightenment]
*-------Pegasus Harness-------*
!!SN:H^art^/60/1/z188181;                [Bow of Elven Cherrywood]
!!SN:H^art^/61/1/z188182;                [Bowstring of the Unicorn's Mane]
!!SN:H^art^/62/1/z188183;                [Angel Feather Arrows]
!!SN:H^art^/137/1/z188184;               [Bow of the Sharpshooter]
*-------Battle Mage War Dress-------*
!!SN:H^art^/7/1/z188185;                 [Axe]
!!SN:H^art^/16/1/z188186;                [Ogre]
!!SN:H^art^/100/1/z188189;               [Pendant of Dispassion]
!!SN:H^art^/28/1/z179838;                [Tunic of the Cyclops King]
!!SN:H^art^/21/1/z179834;                [Helm of Chaos]
*-------Wizards Well-------*
!!SN:H^art^/73/1/z188208;                [Charm of Mana]
!!SN:H^art^/74/1/z188209;                [Talisman of Mana]
!!SN:H^art^/75/1/z188210;                [Mystic Orb of Mana]
!!SN:H^art^/138/1/z188211;               [Wizards Well]
*------Statue of Legion-----*
!!SN:H^art^/118/1/z188224;               [Legs of Legion]
!!SN:H^art^/119/1/z188225;               [Loins of Legion]
!!SN:H^art^/120/1/z188226;               [Torso of Legion]
!!SN:H^art^/121/1/z188227;               [Arms of Legion]
!!SN:H^art^/122/1/z188228;               [Head of Legion]
!!SN:H^art^/133/1/z188229;               [Statue of Legion]
*------Cornucopia-----*
!!SN:H^art^/109/1/z188239;               [Everflowing Crystal Cloak]
!!SN:H^art^/110/1/z188237;               [Ring of Infinite Gems]
!!SN:H^art^/111/1/z188236;               [Everpouring Vial of Mercury]
!!SN:H^art^/113/1/z188238;               [Eversmoking Ring of Sulfur]
!!SN:H^art^/140/1/z188240;               [Cornucopia]
*------Ancient Spyglass-----*
!!SN:H^art^/53/1/z188230;                [Spyglass]
!!SN:H^art^/52/1/z188231;                [Speculum]
*-------Wizards Well-------*
!!if&y6=1;                             [**Mystik_Skill_Enhancement Mod active]
!!SN:H^art^/73/1/z188212;                [Charm of Mana]
!!SN:H^art^/74/1/z188213;                [Talisman of Mana]
!!SN:H^art^/75/1/z188214;                [Mystic Orb of Mana]
!!SN:H^art^/138/1/z188215;               [Wizards Well]
!!en;
*-------The Adventures Fidelity-------*
; Not currently used
!!if&y7=1;                             [**Luck_Skill_Enhancement Mod active]
!!SN:H^art^/46/1/z188216;                [Clover of Fortune]
!!SN:H^art^/47/1/z188217;                [Cards of Prophecy]
!!SN:H^art^/48/1/z188218;                [Ladybird of Luck]
!!SN:H^art^/106/1/z188219;               [Pendant of Negativity]
!!en;
*-------Vestments of Authority-------*
!!SN:H^art^/66/1/z188245;                [Statesman's Medal]
!!SN:H^art^/67/1/z188246;                [Diplomat's Ring]
!!SN:H^art^/68/1/z188247;                [Ambassador's Sash]
*-------Elexir of Life-------*
!!SN:H^art^/94/1/z188241;                [Ring of Vitality]
!!SN:H^art^/95/1/z188242;                [Ring of Life]
!!SN:H^art^/96/1/z188243;                [Vial of Lifeblood]
!!SN:H^art^/131/1/z188244;               [Elixir of Life]
*-------Class Sets-------*
description
!!SN:H^art^/161/1/z188249;               [Royal Blank Helmet]
!!SN:H^art^/162/1/z188250;               [Royal Blank Sword]
!!SN:H^art^/163/1/z188251;               [Royal Blank Shield]
!!SN:H^art^/164/1/z188252;               [Royal Blank Horned Ring]
!!SN:H^art^/165/1/z188253;               [Royal Blank Gemmed Ring]
!!SN:H^art^/166/1/z188254;               [Royal Blank Neck Broach]
!!SN:H^art^/167/1/z188255;               [Royal Blank Armor]
!!SN:H^art^/168/1/z188256;               [Royal Blank Surcoat]
!!SN:H^art^/169/1/z188257;               [Royal Blank Boots]
!!SN:H^art^/170/1/z188258;               [Royal Blank Horn]

*Names class sets
!!SN:H^art^/161/0/z188260;               [Royal Blank Helmet]
!!SN:H^art^/162/0/z188261;               [Royal Blank Sword]
!!SN:H^art^/163/0/z188262;               [Royal Blank Shield]
!!SN:H^art^/164/0/z188263;               [Royal Blank Horned Ring]
!!SN:H^art^/165/0/z188264;               [Royal Blank Gemmed Ring]
!!SN:H^art^/166/0/z188265;               [Royal Blank Neck Broach]
!!SN:H^art^/167/0/z188266;               [Royal Blank Armor]
!!SN:H^art^/168/0/z188267;               [Royal Blank Surcoat]
!!SN:H^art^/169/0/z188268;               [Royal Blank Boots]
*!SN:H^art^/170/0/z188269;               [Royal Blank Horn]

*Commander artifacts description
!!SN:H^art^/146/1/z188220;              [146  Axe of Smashing]
!!SN:H^art^/147/1/z188221;              [147  Mithril Mail]
!!SN:H^art^/148/1/z188222;              [148  Sword of Sharpness]
!!SN:H^art^/149/1/z188223;              [149  Helm of Immortality]
!!SN:H^art^/150/1/z188232;              [150  Pendant of Sorcery]
!!SN:H^art^/151/1/z188233;              [151  Boots of Haste]
!!SN:H^art^/152/1/z188234;              [152  Bow of Seeking]
!!SN:H^art^/153/1/z188235;              [153  Dragon Eye Ring]
!!SN:H^art^/154/1/z188212;              [154  Hardened Shield]
!!SN:H^art^/155/1/z188213;              [155  Slava's Ring of Power]

*------- Ammo Cart -------*
*!SN:H^art^/5/1/z188259;                [Ammo Cart]
!!SN:H^art^/(ART_AMMO_CART)/1/?z30;
!!SN:H^art^/(ART_AMMO_CART)/1/^%z30
%T(AC_Warmachine.Ammo_Cart_Extra_Descr)^;

!!SN:H^art^/105/1/z188269;               [Pendant of Free Will]
!!SN:H^art^/102/1/z188270;               [Pendant of Holiness]
!!SN:H^art^/107/1/z188271;               [Pendant of Total Recall]

!!SN:H^art^/54/1/z188272;                [Amulet of the Undertaker]
!!SN:H^art^/55/1/z188273;                [Vampire's Cowl]
!!SN:H^art^/56/1/z188274;                [Dead Man's Boots]
!!SN:H^art^/130/1/z188275;               [Cloak of the Undead King]

!!SN:H^art^/38/1/z188276;                [Red Dragon Flame Tongue]

!!SN:H^art^/115/1/z188278;               [Endless Sack of Gold]
!!SN:H^art^/116/1/z188279;               [Endless Bag of Gold]
!!SN:H^art^/117/1/z188280;               [Endless Purse of Gold]
!!SN:H^art^/114/1/z188281;               [Inexhaustible Cart of Ore]
!!SN:H^art^/112/1/z188282;               [Inexhaustible Cart of Lumber]


!!if&y2=1;
*!IF:M^Artifact Boost enabled y2^;
!!SN:H^art^/56/1/z188143;                [Dead Man's Boots]
*-------Resistance Set-------*
!!SN:H^art^/57/1/z188157;                [Garniture of Interference]
!!SN:H^art^/58/1/z188158;                [Surcoat of Counterpoise]
!!SN:H^art^/59/1/z188159;                [Boots of Polarity]
*-------Vision of the Eagle----*
!!SN:H^art^/63/1/z188151;                [Bird of Perception]
!!SN:H^art^/64/1/z188152;                [Stoic Watchman]
!!SN:H^art^/65/1/z188153;                [Emblem of Cognizance]
*-------Vestments of Authority-------*
!!SN:H^art^/66/1/z188245;               [Statesman's Medal]
!!SN:H^art^/67/1/z188246;               [Diplomat's Ring]
!!SN:H^art^/68/1/z188247;               [Ambassador's Sash]
*-------Vision of the Eagle----*
!!if&y5=1;                              [*Magic Artillery Enabled]
!!SN:H^art^/63/1/z188197;               [Bird of Perception]
!!SN:H^art^/64/1/z188198;               [Stoic Watchman]
!!SN:H^art^/65/1/z188199;               [Emblem of Cognizance]
!!en;
!!en;


!!if&y3=1;
*-------Orbs-------*
!!SN:H^art^/79/1/z188100;               [orb of firmament]
!!SN:H^art^/80/1/z188101;               [orb of silt]
!!SN:H^art^/81/1/z188102;               [orb of tempestous fire]
!!SN:H^art^/82/1/z188103;               [orb of driving rain]
*------Ring of Magi-----*
!!SN:H^art^/76/1/z188120;               [collar of conjuring]
!!SN:H^art^/77/1/z188121;               [ring of conjuring]
!!SN:H^art^/78/1/z188122;               [cape of conjuring]
!!SN:H^art^/139/1/z188123;              [ring of the magi]
*-------Vestments of Authority-------*
!!SN:H^art^/66/1/z188245;               [Statesman's Medal]
!!SN:H^art^/67/1/z188246;               [Diplomat's Ring]
!!SN:H^art^/68/1/z188247;               [Ambassador's Sash]
*-------Elexir of Life-------*
!!SN:H^art^/94/1/z188241;               [Ring of Vitality]
!!SN:H^art^/95/1/z188242;               [Ring of Life]
!!SN:H^art^/96/1/z188243;               [Vial of Lifeblood]
!!SN:H^art^/131/1/z188244;              [Elixir of Life]
*------Ring of Magi-----*
!!if&y4=1;                              [*Spell Trainer Enabled]
!!SN:H^art^/76/1/z188200;               [collar of conjuring]
!!SN:H^art^/77/1/z188201;               [ring of conjuring]
!!SN:H^art^/78/1/z188202;               [cape of conjuring]
!!SN:H^art^/139/1/z188203;              [ring of the magi]
!!en;
*-------Priest of the Light-------*
!!SN:H^art^/13/1/z188129;               [Shield of the Dwarven Lords]
!!SN:H^art^/19/1/z188147;               [Helm of the Alabaster Unicorn]
!!SN:H^art^/104/1/z188134;              [Pendant of Death]
!!SN:H^art^/103/1/z188176;              [Pendant of Life]
!!en;


!!if&y3=1/y2=1;
*!IF:M^Enhanced Artifact & Artifact Boost enabled y3 + y2^;
!!SN:H^art^/103/1/z188128;              [Pendant of Life]
!!SN:H^art^/104/1/z188168;              [Pendant of Death]
!!SN:H^art^/56/1/z188143;               [Dead Man's Boots]
!!en;

*WoG Artifacts description (1)
!!SN:H^art^/141/1/z188283;              [141  Magic Wand]
!!SN:H^art^/142/1/z188284;              [142  Gold Tower Arrow]
!!SN:H^art^/143/1/z188285;              [143  Monster's Power]
*!SN:H^art^/160/1/z188286;              [160  Gate Key]

*names (0)
!!SN:H^art^/141/0/z188287;              [141  Magic Wand]
!!SN:H^art^/142/0/z188288;              [142  Gold Tower Arrow]
!!SN:H^art^/143/0/z188289;              [143  Monster's Power]
*!SN:H^art^/160/0/z188290;              [160  Gate Key]
!!SN:H^art^/170/0/z188291;              [170  Horn of Magic Energy]

!!SN:H^art^/134/1/z188125;              [134 Power of the Dragon Father]
********************************************************************************



                      Change Artifact Price and Class



********************************************************************************
Classes of Artifacts
1 No class
2 Treasure
4 Minor
8 Major
16 Relic and WoG


!?FU(Artifact_Cost_Increase);
!!UN:Ax16/1/d1000;

!#DO(Artifact_Cost_Increase)/0/170/1:P;


*******************
From Minor to Treasure
*******************

Inexhaustible Cart of Ore
!#UN:A112/3/2;

Inexhaustible Cart of Lumber
!#UN:A114/3/2;


*******************
From Treasure to Minor
*******************

49 Badge of Courage
!#UN:A49/3/4;

78 Cape of Conjuring
!#UN:A78/3/4;

97 Necklace of Swiftness
!#UN:A97/3/4;

103 Pendant of Life
!#UN:A103/3/4;


*******************
From Major to Minor
*******************

Ambassador's Sash
!#UN:A68/3/4;

Endless Bag of Gold
!#UN:A49/3/4;

Endless Purse of Gold
!#UN:A116/3/4;

Everflowing Crystal Cloak
!#UN:A109/3/4;

Everpouring Vial of Mercury
!#UN:A111/3/4;

Eversmoking Ring of Sulfur
!#UN:A113/3/4;

Ring of Infinite Gems
!#UN:A110/3/4;

Statesman's Medal
!#UN:A66/3/4;

Garniture of Interference
!#UN:A57/3/4;

Necklace of Ocean Guidance
!#UN:A71/3/4;


*******************
From Minor to Major
*******************

Crown of the Supreme Magi 22
!#UN:A22/3/8;

Red Dragon Flame Tongue 38
!#UN:A38/3/8;

Boots of Speed
!#UN:A98/3/8;

Gloves of Speed
!#UN:A70/3/8;


*******************
From Relic to Major
*******************

Boots of Polarity
!#UN:A59/3/8;

Endless Sack of Gold
!#UN:A115/3/8;

Sea Captain's Hat
!#UN:A123/3/8;


*******************
From Major to Relic
*******************

Pendant of Courage
!#UN:A108/3/16;

********************************************************************************
**V-Vars used: v9276,v9277,v9278,v9279,v9280,v9281,v9282,v9283,v9284,v9285,v9286-FREI ,v9287,v9288,v9290,v9390-v9410, v9441, v9442, v9443free, v9444, v9447, v9448, v9449
**Z-Vars used: z1, z-1, z796-z798
**Flags used: V890, V936


!#SN:W^Improved_Spells_Mod^/1;          [Improved_Spells_Mod Set to active]

!#UN:P22/0;                             [Disbale Monster Mutterings nonsense to get free z vars]
!#IF:V57/0;
!#UN:P58/0;                             [Disable Espionage nonsense to get free z vars]

!?FU(AC_ResetSpellFromStack);
; x1 - stack id
; x2 - spell id
!!UN:C6919200/4/?y10;
!!VRy1:Sx1 *1352 +21708 +y10;
!!SN:E4473392/2/y1/x2;

!?FU(OnGameEnter);                      [At gamestart]
;** Berserk radius at 0\1\2\3 fire magic rank. 0 - Set to 1 Hex, 1 set to 3 Hex
;** If you set the value to more than 2 there will be graphical bugs and will only work if you select the target explicitely
!!UN:C6562420/1/0;                      [None]
!!UN:C6562424/1/0;                      [Basic]
!!UN:C6562428/1/0;                      [Advanced 0 - Set to 1 Hex]
!!UN:C6562432/1/1;                      [Expert 1 - Set to 3 Hex]

*give damage flag to fire wall and land mines
!!SS13:F?y1;
!!VRy1:|512;
!!SS13:Fy1;
!!SS11:F?y1;
!!VRy1:|512;
!!SS11:Fy1;


!?FU(OnBattlefieldVisible)&1000;

!!SN:W^landmine_var^/0;                 [landmine variable]
!!SN:W^Bers_en^/0;                      [Reset vars before combat]
!!SN:W^Animate_Dead^/0;
!!SN:W^MA_Stack_Number^/-1;
!!SN:W^Improved_Cure^/0;
!!SN:W^Incinerate^/0;                   [Reset Incinerate Damage]
!!VRy1:S0;
[:loopCombatStartVarsImprovedSpells];
!!SN:W^DisruptingRayCastsStack%Y1^/0;
!!SN:W^DisRayStoneSkinRemoved%Y1^/0;
!!SN:W^StoneSkinHitsStack%Y1^/0;
!!SN:W^Burned_Stack_%Y1^/0;             [Reset afterwards]
!!VRy1:+1;
!!SN&y1<42:G[loopCombatStartVarsImprovedSpells];
!!IF:V936/0;                            [Quick Combat Flag]
!!SN:W^Summoned_Elemental_Perk^/0;


!?FU(OnAfterBattleUniversal)&1000;      [Reset vars after combat]

!!VRv9287:S0; !!VRv9288:S0; !!VRv9276:S0; !!VRv9277:S0;
!!VRv9278:S0; !!VRv9279:S0; !!VRv9280:S0; !!VRv9281:S0;
!!VRv9282:S0; !!VRv9283:S0;

!!SN:W^shield_var1^/0; !!SN:W^shield_var2^/0; [shield variable]
!!SN:W^sacrifice_var^/0;                [Reset vars after combat]
!!SN:W^Sorrow_Cast0^/0; !!SN:W^Sorrow_Cast1^/0;
!!SN:W^Force_Field_Cast^/0;             [Set Flag to false after battle Force Field]
!!SN:W^Mirth_Cast0^/0; !!SN:W^Mirth_Cast1^/0;
!!SN:W^Slayer_Cast0^/0; !!SN:W^Slayer_Cast1^/0;
!!SN:W^Mirth_Current_battle_round^/-1;
!!SN:W^Mirth_Stack_had_Moral^/-1;
!!SN:W^Bloodlust_Cast0^/0; !!SN:W^Bloodlust_Cast1^/0;
!!SN:W^Fortune_Cast0^/0; !!SN:W^Fortune_Cast1^/0;
!!SN:W^Prayer_Cast0^/0; !!SN:W^Prayer_Cast1^/0;
!!SN:W^Curse_Cast0^/0; !!SN:W^Curse_Cast1^/0;
!!SN:W^Weakness_Cast0^/0; !!SN:W^Weakness_Cast1^/0;
!!SN:W^Shield_Cast0^/0;   !!SN:W^Shield_Cast1^/0;
!!SN:W^Fire_Shield_Cast0^/0; !!SN:W^Fire_Shield_Cast1^/0;
!!SN:W^Slow_Cast0^/0; !!SN:W^Slow_Cast1^/0;
!!SN:W^Haste_Cast0^/0; !!SN:W^Haste_Cast1^/0;
!!SN:W^Bless_Cast0^/0; !!SN:W^Bless_Cast1^/0;
!!SN:W^Stoneskin_Cast0^/0; !!SN:W^Stoneskin_Cast1^/0;
!!SN:W^Stoneskin_Cast00^/0; !!SN:W^Stoneskin_Cast11^/0;
!!SN:W^Heal_Cast0^/0; !!SN:W^Heal_Cast1^/0;
!!SN:W^Improved_Cure^/0;
!!SN:W^Magic_Mirror_Cast0^/0; !!SN:W^Magic_Mirror_Cast1^/0;
!!SN:W^Air_Shield_Cast0^/0; !!SN:W^Air_Shield_Cast1^/0;
!!SN:W^Animate_Cast0^/0; !!SN:W^Animate_Cast1^/0;
!!SN:W^Improved_Magic_Arrow_Counter^/0;
!!SN:W^Fire_Protection_Cast_0^/0;
!!SN:W^Fire_Protection_Cast_1^/0;
!!SN:W^Water_Protection_Cast_0^/0;
!!SN:W^Water_Protection_Cast_1^/0;
!!SN:W^Earth_Protection_Cast_0^/0;
!!SN:W^Earth_Protection_Cast_1^/0;
!!SN:W^Air_Protection_Cast_0^/0;
!!SN:W^Air_Protection_Cast_1^/0;
!!SN:W^H3_Summon_Fire_0^/0;
!!SN:W^H3_Summon_Fire_1^/0;
!!SN:W^H3_Summon_Earth_0^/0;
!!SN:W^H3_Summon_Earth_1^/0;
!!SN:W^H3_Summon_Water_0^/0;
!!SN:W^H3_Summon_Water_1^/0;
!!SN:W^H3_Summon_Air_0^/0;
!!SN:W^H3_Summon_Air_1^/0;

!!DO(AC_Function_125)/0/41/1&1000:P10;       [Reset Position for Teleport]


!?BR&1000/-936;
!!DO(AC_Function_106)/0/41/1&v997>0:P;  [call function to take bonus]
!!DO(AC_Function_107)/0/41/1&v997=0:P;  [call function to remember HP for Force Field]

!!SN:W^Heal_Var1^/1;                    [Reset Heal_Var1 Variable]
!!SN:W^Heal_Var2^/1;                    [Reset Heal_Var2 Variable]
!!SN:W^Heal_Cast0^/0; !!SN:W^Heal_Cast1^/0;
!!SN:W^Bers_spread^/0;                  [Reset Bers_spread Variable]
!!SN:W^Slow_Cast0^/0; !!SN:W^Slow_Cast1^/0; [Reset Slow_Cast Variable]
!!SN:W^Haste_Cast0^/0; !!SN:W^Haste_Cast1^/0;
!!SN:W^Bless_Cast0^/0; !!SN:W^Bless_Cast1^/0;
!!SN:W^Stoneskin_Cast0^/0; !!SN:W^Stoneskin_Cast1^/0;
!!SN:W^Bloodlust_Cast0^/0; !!SN:W^Bloodlust_Cast1^/0;
!!SN:W^Death_Ripple_Cast0^/0; !!SN:W^Death_Ripple_Cast1^/0; [Reset Death Ripple Cast]
!!SN:W^Destroy_Undead_Cast1^/0; !!SN:W^Destroy_Undead_Cast0^/0;


!?BR-1&v997>0;                          [At round End]
!!SN:W^Fire_Protection_Cast_0^/?y1;     [Attacker Cast]
!!SN:W^Water_Protection_Cast_0^/?y2;
!!SN:W^Earth_Protection_Cast_0^/?y3;
!!SN:W^Air_Protection_Cast_0^/?y4;
!!DO(AC_Function_94)/0/20/1|y1>0/y2>0/y3>0/y4>0:P-10; [Only run if at least one Protection Spell was cast and pass attacking hero (-10)]

!!SN:W^Fire_Protection_Cast_1^/?y1;     [Defender Cast]
!!SN:W^Water_Protection_Cast_1^/?y2;
!!SN:W^Earth_Protection_Cast_1^/?y3;
!!SN:W^Air_Protection_Cast_1^/?y4;
!!DO(AC_Function_94)/21/41/1|y1>0/y2>0/y3>0/y4>0:P-20; [Only run if at least one Protection Spell was cast and pass defending hero (-20)]


!?FU(AC_Function_94);
!!BMx16:I?y1;
!!BA:Hy1/?y99;
!!FU&y99<0:E;
!!HEy99:Fd/d/?y86/d;

!!SN:W^H3_Air Magic_0_Hero%Y99^/?y11; !!SN:W^H3_Air Magic_1_Hero%Y99^/?y12; !!VRy87:Sy86:2+10; !!VRy87&y12=1:+20; !!VRy87&y87>=75:S75;
!!BMx16:G30/?y2/?y3;
!!DO(AC_Function_95)/60/60/1&y2>0/y3=3/y11=1:Px16/30/y87; [If Protection from Air Spell is applied at Expert run function to remove. Pass Creature Number, Element, chance to shake off]

!!SN:W^H3_Fire Magic_0_Hero%Y99^/?y11; !!SN:W^H3_Fire Magic_1_Hero%Y99^/?y12; !!VRy87:Sy86:2+10; !!VRy87&y12=1:+20; !!VRy87&y87>=75:S75;
!!BMx16:G31/?y2/?y3;
!!DO(AC_Function_95)/42/62/1&y2>0/y3=3/y11=1:Px16/31/y87; [If Protection from Fire Spell is applied at Expert run function to remove. Pass Creature Number, Element, chance to shake off]

!!SN:W^H3_Water Magic_0_Hero%Y99^/?y11; !!SN:W^H3_Water Magic_1_Hero%Y99^/?y12; !!VRy87:Sy86:2+10; !!VRy87&y12=1:+20; !!VRy87&y87>=75:S75;
!!BMx16:G32/?y2/?y3;
!!DO(AC_Function_95)/45/62/1&y2>0/y3=3/y11=1:Px16/32/y87; [If Protection from Water Spell is applied at Expert run function to remove. Pass Creature Number, Element, chance to shake off]

!!SN:W^H3_Earth Magic_0_Hero%Y99^/?y11; !!SN:W^H3_Earth Magic_1_Hero%Y99^/?y12; !!VRy87:Sy86:2+10; !!VRy87&y12=1:+20; !!VRy87&y87>=75:S75;
!!BMx16:G33/?y2/?y3;
!!DO(AC_Function_95)/50/62/1&y2>0/y3=3/y11=1:Px16/33/y87; [If Protection from Earth Spell is applied at Expert run function to remove. Pass Creature Number, Element, chance to shake off]


!?FU(AC_Function_95);
!!VRy10:S0R99;

!!if&x16=60;                           [Air Spells (Hypno)]
!!BMx1&x2=30:Gx16/?y2/?y3;              [Check for Spell]
!!BMx1&x2=30/y2>0/y10<x3:Gx16/1/?y33;   [Remove Spell]
!!VRz-1&x2=30/y2>0/y10<x3:S^CURE^;
!!SN&x2=30/y2>0/y10<x3:Pz-1;
!!en;

!!if|x16=52/x16=42/x16=62/x16=59;      [Fire Spells]
!!BMx1&x2=31:Gx16/?y2/?y3;              [Check for Spell]
!!BMx1&x2=31/y2>0/y10<x3:Gx16/1/?y33;   [Remove Spell]
!!VRz-1&x2=31/y2>0/y10<x3:S^CURE^;
!!SN&x2=31/y2>0/y10<x3:Pz-1;
!!en;

!!if|x16=45/x16=61;                    [Water Spells]
!!BMx1&x2=32:Gx16/?y2/?y3;              [Check for Spell]
!!BMx1&x2=32/y2>0/y10<x3:Gx16/1/?y33;   [Remove Spell]
!!VRz-1&x2=32/y2>0/y10<x3:S^CURE^;
!!SN&x2=32/y2>0/y10<x3:Pz-1;
!!en;

!!if|x16=54/x16=50;                    [Earth Spells]
!!BMx1&x2=33:Gx16/?y2/?y3;              [Check for Spell]
!!BMx1&x2=33/y2>0/y10<x3:Gx16/1/?y33;   [Remove Spell]
!!VRz-1&x2=33/y2>0/y10<x3:S^CURE^;
!!SN&x2=33/y2>0/y10<x3:Pz-1;
!!en;


********************************************************************************
!?FU(OnBattleRegeneratePhase)&1000;     [Reset Attacking Stacks Function]

!!SN:W^Weakness_Attacking_Stack^/-1;
!!SN:W^Curse_Attacking_Stack^/-1;
!!SN:W^Fortune_Attacking_Stack^/-1;
!!SN:W^Misfortune_Attacking_Stack^/-1;
!!SN:W^Slayer_Attacking_Stack^/-1;
!!SN:W^Mirth_Attacking_Stack^/-1;
!!SN:W^Prayer_Shield_Attacking_Stack^/-1;
!!SN:W^Sorrow_Shield_Attacking_Stack^/-1;
!!SN:W^Shield_Attacking_Stack^/-1;
!!SN:W^Prayer_Attacking_Stack^/-1;
!!SN:W^Sorrow_Attacking_Stack^/-1;
!!SN:W^Ray_Attacking_Stack^/-1;
!!SN:W^Stoneskin_Attacking_Stack^/-1;
!!SN:W^Summon_Attacking_Stack^/-1;
!!SN:W^Coordinated_Attacking_Stack^/-1;
!!SN:W^BlessSpell_Attacking_Stack^/-1;
!!SN:W^AxeSmash_Attacking_Stack^/-1;
!!SN:W^SwordSharpness_Attacking_Stack^/-1;
!!SN:W^Dragon_Ring_Attacking_Stack^/-1;
!!SN:W^Defender_Mastery_Attacking_Stack^/-1;
!!SN:W^Scout_Mastery_Attacking_Stack^/-1;


********************************************************************************
!?BG0&1000/-936;

!!BG:Q?v9280;                           [Current attacking side]
!!BH0:N?v9281;                          [Attacking Hero]
!!BH1:N?v9282;                          [Defending Hero]
!!BG:H?v9283;                           [Current attacking hero]

!!BA:Q?y1;
!!IF&y1=1:V936/1;
!!FU&y1=1:E;

!!BG:H?v9447;                           [Determine if AI controlls Hero]
!!HEv9447:O?v9447;
!!OW:Iv9447/?v9447;

!!BG:A?y1;
!!FU&y1<>1|v9447=1:E;


!!SN:W^H3_Fire Magic_0_Hero%V9283^/?y11;[Fire Magic Bonus handling]
!!SN:W^H3_Air Magic_0_Hero%V9283^/?y12; [Air Magic Bonus handling]
!!SN:W^H3_Water Magic_0_Hero%V9283^/?y13;[Water Magic Bonus handling]
!!SN:W^H3_Earth Magic_0_Hero%V9283^/?y14;[Earth Magic Bonus handling]

!!HEv9283:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85; [Checke ob der Held Sorcery und Magien hat (deleted all y85 requirements)]

!!BG:S?y2;                              [y2 now contains spell number]
!!FU&y2<=9|y2>69:E;

!!if&y2=46/y84=3/y14=1;
!!VRv9290:S100;                         [Stoneskin]
!!en;

!!if&y2=41/y83=3/y13=1;
!!VRv9290:S101;                         [Blessing]
!!en;

!!if&y2=43/y81=3/y11=1;
!!VRv9290:S102;                         [Bloodlust]
!!en;

!!if&y2=44/y82=3/y12=1;
!!VRv9290:S103;                         [Precision]
!!en;

!!if&y2=53/y82=3/y12=1;
!!VRv9290:S104;
!!SN&v9280=0:W^Haste_Cast0^/?y1;
!!SN&v9280=1:W^Haste_Cast1^/?y1;        [Haste]
!!DO(AC_Function_105)/0/41/1&y1=0:P;    [call early for slow check]
!!en;

!!if&y2=54/y84=3/y14=1;
!!VRv9290:S105;                         [Slow]
!!SN&v9280=0:W^Slow_Cast0^/?y1;
!!SN&v9280=1:W^Slow_Cast1^/?y1;
!!DO(AC_Function_105)/0/41/1&y1=0:P;    [call early for haste check]
!!en;

!!if&y2=37/y83=3/y13=1;
!!VRv9290:S106;                         [Heal]
!!en;

*!if&y2=27/y84=3/y10=1;
*!VRv9290:S107;                                                                 [Shield] replaced
*!en;

!!if&y2=28/y82=3/y12=1;
!!VRv9290:S108;                         [Air Shield]
!!en;

!!if&y2=36/y82=3/y12=1;
!!VRv9290:S109;                         [Anti Magic]
!!en;

!!if&y2=34/y84=3/y14=1;
*!VRv9290:S110;                         [Counterspell]
!!en;

!!if&y2=49/y83=3/y13=1;
!!VRv9290:S111;                         [Mirth]
!!SN&v9280=0:W^Mirth_Cast0^/1;
!!SN&v9280=1:W^Mirth_Cast1^/1;
!!en;

*!if&y2=51/y82=3/y10=1;
*!VRv9290:S112;                                                                 [Luck]
*!en;

!!if&y2=58/y82=3/y12=1;
!!VRv9290:S113;                         [Counterstrike]
!!en;

!!if&y2=55/y81=3/y11=1;
!!VRv9290:S114;                         [Slayer]
!!en;

!!if&y2=29/y81=3/y11=1;
!!VRv9290:S115;                         [Fire Shield]
!!en;

!!if&y2=56/y81=3/y11=1;
*!VRv9290:S116;                         [Frenzy]
!!en;

!!if&y2=31/y81=3/y11=1;
!!VRv9290:S117;                         [Protection from Fire]
!!SN&v9280=0:W^Fire_Protection_Cast_0^/1;
!!SN&v9280=1:W^Fire_Protection_Cast_1^/1;
!!en;

!!if&y2=32/y83=3/y13=1;
!!VRv9290:S118;                         [Protection from Water]
!!SN&v9280=0:W^Water_Protection_Cast_0^/1;
!!SN&v9280=1:W^Water_Protection_Cast_1^/1;
!!en;

!!if&y2=33/y84=3/y14=1;
!!VRv9290:S119;                         [Protection from Earth]
!!SN&v9280=0:W^Earth_Protection_Cast_0^/1;
!!SN&v9280=1:W^Earth_Protection_Cast_1^/1;
!!en;

!!if&y2=30/y82=3/y12=1;
!!VRv9290:S120;                         [Protection from Air]
!!SN&v9280=0:W^Air_Protection_Cast_0^/1;
!!SN&v9280=1:W^Air_Protection_Cast_1^/1;
!!en;

!!if&y2=66/y81=3/y11=1;
!!VRv9287&v9280=0:S10;                  [for attacker]
!!VRv9288&v9280=1:S10;                  [for defender]
!!VRv9290:S121;                         [Fire Elemental]
!!en;

!!if&y2=67/y84=3/y14=1;
!!VRv9287&v9280=0:S10;                  [for attacker]
!!VRv9288&v9280=1:S10;                  [for defender]
!!VRv9290:S122;                         [Earth Elemental]
!!en;

!!if&y2=68/y83=3/y13=1;
!!VRv9287&v9280=0:S10;                  [for attacker]
!!VRv9288&v9280=1:S10;                  [for defender]
!!VRv9290:S123;                         [Water Elemental]
!!en;

!!if&y2=69/y82=3/y12=1;
!!VRv9287&v9280=0:S10;                  [for attacker]
!!VRv9288&v9280=1:S10;                  [for defender]
!!VRv9290:S124;                         [Air Elemental]
!!en;

!!if&y2=65/y83=3/y13=1;
!!VRv9290:S125;                         [Clone Spell]
!!en;

*!if&y2=51/y82=3/y12=1;
*!VRv9290:S126;                                                                 [Luck2]
*!en;

!!if&y2=38/y84=3/y14=1;
!!VRv9290:S127;                         [Ressurect]
!!en;

!!if&y2=48/y83=3/y13=1;
!!VRv9290:S128;                         [Prayer]
!!SN&v9280=0:W^Prayer_Cast0^/1;
!!SN&v9280=1:W^Prayer_Cast1^/1;
!!en;

!!if&y2=50/y84=3/y14=1;
!!VRv9290:S129;                         [Sorrow]
!!SN&v9280=0:W^Sorrow_Cast0^/1;
!!SN&v9280=1:W^Sorrow_Cast1^/1;
!!en;

!!if&y2=47/y82=3/y12=1;
!!VRv9290:S130;                         [Disrupting Ray]
!!en;

!!if&y2=11/y81=3/y11=1;
!!VRv9290:S131;                         [Landmine]
!!SN:W^landmine_var^/?y90;
!!VRy90:+1;
!!SN:W^landmine_var^/y90;
!!en;

!!if&y2=45/y83=3/y13=1;
!!VRv9290:S132;                         [Weakness]
!!SN&v9280=0:W^Weakness_Cast0^/1;
!!SN&v9280=1:W^Weakness_Cast1^/1;
!!en;

!!if&y2=42/y81=3/y11=1;
!!VRv9290:S133;                         [Curse]
!!SN&v9280=0:W^Curse_Cast0^/1;
!!SN&v9280=1:W^Curse_Cast1^/1;
!!en;

!!if&y2=61/y83=3/y13=1;
!!VRv9290:S134;                         [Forgetfulness]
!!en;

!!if&y2=27/y84=3/y14=1;
!!VRv9290:S135;                         [Shield 2]
!!SN&v9280=0:W^Shield_Cast0^/1;
!!SN&v9280=1:W^Shield_Cast1^/1;
!!en;

!!if&y2=62/y81=3/y11=1;
!!VRv9290:S136;                         [Blind]
!!en;

!!if&y2=52/y81=3/y11=1;
!!VRv9290:S137;                         [Misfortune]
!!SN&v9280=0:W^Misfortune_Cast0^/1;
!!SN&v9280=1:W^Misfortune_Cast1^/1;
!!en;

!!if&y2=51/y82=3/y12=1;
!!VRv9290:S138;                         [Fortune (Luck 3)]
!!SN&v9280=0:W^Fortune_Cast0^/1;
!!SN&v9280=1:W^Fortune_Cast1^/1;
!!en;

!!if&y2=24/y84=3/y14=1;
!!VRv9290:S139;                         [Death Ripple]
!!en;

!!if&y2=25/y82=3/y12=1;
!!VRv9290:S140;                         [Destroy Undead]
!!en;

!!if&y2=13/y81=3/y11=1;
!!VRv9290:S141;                         [Firewall]
!!en;

!!if&y2=35/y83=3/y13=1;
!!VRv9290:S142;                         [Dispel]. Also look at [call function for dispel]
!!en;

!!if&y2=40/y81=3/y11=1;
!!SN:W^sacrifice_var^/?y34;
!!VRv9290&y34=0:S143;                   [Sacrificed]
!!en;

!!if&y2=42;
*!DO(AC_Function_122)/0/41/1:P;         [curse call fkt bless check]
!!en;

!!if&y2=35;
!!DO(AC_Function_108)/0/41/1:P;         [call funtion for dispel]
!!en;

!!if&y2=37;                            [call funtion for heal]
!!SN&y83=3/y13=1:W^Improved_Cure^/1;
!!DO(AC_Function_121)/0/41/1:P;
!!en;

!!if&y2=12/y84=3/y14=1;
!!SN:W^Force_Field_Cast^/1;             [Set Flag to True isf cast is Force Field]
!!VRv9290:S144;                         [Force Field]
!!en;

!!if&y2=10/y84=3/y14=1;
!!VRv9290:S145;                         [Quicksand]
!!en;

!!if&y2=63/y83=3/y13=1;
!!VRv9290:S146;                         [Teleport]
!!DO(AC_Function_125)/0/41/1:P;
!!if&y81=3/y11=1;                      [Increase big ones amount by 1 if also Master Fire. @alf]
!!SN:W^landmine_var^/?y90;
!!VRy90:+1;
!!SN:W^landmine_var^/y90;
!!en;
!!en;

!!if&y2=14/y84=3/y14=1;
!!VRv9290:S147;                         [Earthquake]
!!en;

!!if&y2=64/y81=3/y11=1;
!!VRv9290:S148;                         [Remove Obstacle]
!!en;

!!if&y2=26/y81=3/y11=1;
!!VRv9290:S149;                         [Armageddon]
!!DO(AC_Function_97)/0/20/1&v9280=0:P;
!!DO(AC_Function_97)/21/41/1&v9280=1:P;
!!en;

!!if&y2=59/y81=3/y11=1;
!!VRv9290:S150;                         [Berserker]
!!SN:W^Bers_en^/1;
!!en;

!!if&y2=60/y82=3/y12=1;
!!VRv9290:S151;                         [Hypnotize]
*!SN:W^Bers_en^/1;
!!en;

!!if&y2=39/y84=3/y14=1;
!!VRv9290:S152;                         [Animate Dead]
!!DO(AC_Function_104)/0/41/1:P;
!!SN&v9280=0:W^Animate_Cast0^/?y1;
!!SN&v9280=1:W^Animate_Cast1^/?y1;
!!SN&y1=0:W^Animate_Dead^/1;
!!SN&v9280=0:W^Animate_Cast0^/1;        [So it only works once per combat]
!!SN&v9280=1:W^Animate_Cast1^/1;
!!en;

!!if&y2=15;
!!VRv9290|y11=1/y12=1/y13=1/y14=1:S153; [Magic Arrow]
!!en;

********************************************************************************
!?BG1&1000/-936;                        [run forest]
!!BG:H?v9447;                           [Determine if AI controlls Hero]
!!HEv9447:O?v9447;
!!OW:Iv9447/?v9447;

!!FU&v9447=1:E;

!!BG:S?y2;                              [y2 now contains spell number]
!!FU&y2<=9|y2>69:E;
!!BA:Q?f;

!!SN:W^H3_Fire Magic_0_Hero%V9283^/?y11;[Fire Magic Bonus handling]
!!SN:W^H3_Air Magic_0_Hero%V9283^/?y12; [Air Magic Bonus handling]
!!SN:W^H3_Water Magic_0_Hero%V9283^/?y13;[Water Magic Bonus handling]
!!SN:W^H3_Earth Magic_0_Hero%V9283^/?y14;[Earth Magic Bonus handling]

!!if&v9290=100;
!!SN:W^Scaling_Magic_Spell_Number_^/?y21;
!!SS46&y21=46:E3/?y22;
!!FU(ApplyRemoveSpellScaling)&y21<>46:Pv9283/46/1/d/?y22;
!!VRz-1:S^You cast {improved Stone Skin}.
+%Y22 defense for this round.^;
*!BU&i^battle_isVisible^:Mz-1;
!!SN&v9280=0:W^Stoneskin_Cast0^/?y1;
!!SN&v9280=1:W^Stoneskin_Cast1^/?y1;
!!DO(AC_Function_105)/0/41/1&y1=0:P;    [call funktion for Stoneskin]
!!SN&v9280=0:W^Stoneskin_Cast0^/1;      [Only for Battle Round]
!!SN&v9280=1:W^Stoneskin_Cast1^/1;
!!SN&v9280=0:W^Stoneskin_Cast00^/1;     [For whole Battle]
!!SN&v9280=1:W^Stoneskin_Cast11^/1;
!!en;


!!if&v9290=101;
  !!VRz1:S^You cast {improved Bless}.
  +2 damage for this round.^;
  !!SN&v9280=0:W^Bless_Cast0^/?y1;
  !!SN&v9280=1:W^Bless_Cast1^/?y1;
  *!DO(AC_Function_105)/0/41/1&y1=0:P;    [call funktion for Bless]
  !!SN&v9280=0:W^Bless_Cast0^/1;
  !!SN&v9280=1:W^Bless_Cast1^/1;
    !!re i/0/20;
    !!SN&v9280=0:W^Bless_Strike_Creature%i^/1; Enable Bless Strike
    !!en;
    !!re i/21/41;
    !!SN&v9280=1:W^Bless_Strike_Creature%i^/1; Enable Bless Strike
    !!en;
!!en;


!!if&v9290=102;
!!SN:W^Scaling_Magic_Spell_Number_^/?y21;
!!SS43&y21=43:E3/?y22;
!!FU(ApplyRemoveSpellScaling)&y21<>43:Pv9283/43/1/d/?y22;
!!VRz1:S^You cast {improved Bloodlust}.
+%Y22 attack for this round and attack for every enemy stack slain.^;
!!SN:W^Bloodlust_Cast%V9280^/?y1;
!!DO(AC_Function_105)/0/41/1&y1=0:P;    [call funktion for bloodlust]
!!SN:W^Bloodlust_Cast%V9280^/1;
!!en;


!!if&v9290=103;
!!VRz1:S^You cast {improved Precision}.
Shooters can shoot when adjacent this round.^;
*!DO(AC_Function_105)/0/41/1:P;         [call funktion for precision]
  !!re i/0/20;
  !!SN&v9280=0:W^Precision_Strike_Creature%i^/1; Enable Bless Strike
  !!en;
  !!re i/21/41;
  !!SN&v9280=1:W^Precision_Strike_Creature%i^/1; Enable Bless Strike
  !!en;
!!en;


!!if&v9290=104;
!!VRz1:S^You cast {improved Haste}.
+1 extra speed this round.^;
!!SN&v9280=0:W^Haste_Cast0^/?y1;
!!SN&v9280=1:W^Haste_Cast1^/?y1;
!!DO(AC_Function_105)/0/41/1&y1=0:P;    [call funktion for Haste]
!!SN&v9280=0:W^Haste_Cast0^/1;
!!SN&v9280=1:W^Haste_Cast1^/1;

!!SN&v9280=1:W^Slow_Cast0^/0;
!!SN&v9280=0:W^Slow_Cast1^/0;
!!en;


!!if&v9290=105;
!!VRz1:S^You cast {improved Slow}.
-1 extra speed this round^;
!!SN&v9280=0:W^Slow_Cast0^/?y1;
!!SN&v9280=1:W^Slow_Cast1^/?y1;
!!DO(AC_Function_105)/0/41/1&y1=0:P;    [call funktion for slow]
!!SN&v9280=0:W^Slow_Cast0^/1;
!!SN&v9280=1:W^Slow_Cast1^/1;

!!SN&v9280=1:W^Haste_Cast0^/0;
!!SN&v9280=0:W^Haste_Cast1^/0;
!!en;


!!if&v9290=106;
!!VRz1:S^You cast {improved Cure}.
Heals over the maximum HP of your creatures, reviving them if possible.^;
!!if&v9280=0;
*!SN:W^Heal_Var1^/11;
*!SN:W^Heal_Cast0^/?y1;
*!DO(AC_Function_105)/0/20/1&y1=0:P;
*!SN:W^Heal_Cast0^/1;                                                           [call funktion for heal attacker]
!!en;
!!if&v9280=1;
*!SN:W^Heal_Var2^/11;
*!SN:W^Heal_Cast1^/?y1;
*!DO(AC_Function_105)/21/41/1&y1=0:P;
*!SN:W^Heal_Cast1^/1;                                                           [call funktion for heal defender]
!!en;
!!SN&v9280=1:W^Slow_Cast0^/0;
!!SN&v9280=0:W^Slow_Cast1^/0;
!!en;

!!if&v9290=107;
!!VRz1:S^You cast {improved Shield}.
Chance to block extra damage this round.^;
!!DO(AC_Function_105)/0/41/1:P;         [call funktion for shield]
!!en;


!!if&v9290=108;
!!VRz1:S^You cast {improved Air Shield}.
Small chance to dodge ranged attacks.^;
*!DO(AC_Function_105)/0/41/1:P;                                                             [call funktion for air shield]
!!SN&v9280=0:W^Air_Shield_Cast0^/1;
!!SN&v9280=1:W^Air_Shield_Cast1^/1;
!!en;

!!if&v9290=109;
!!VRz1:S^You cast {improved Magic Mirror}
Mirrors all spells to your enemies.^;
*!DO(AC_Function_105)/0/41/1:P;                                                             [call funktion for magic mirror]
!!SN&v9280=0:W^Magic_Mirror_Cast0^/1;
!!SN&v9280=1:W^Magic_Mirror_Cast1^/1;
!!en;

!!if&v9290=110;
!!VRz1:S^You cast {improved Anti-Magic}.
Your creature gets dispel ability this round.^;
*!DO(AC_Function_105)/0/41/1:P;         [call funktion for counterspell]
!!en;

!!if&v9290=111;
!!VRz1:S^You cast {improved Mirth}.
Next attack deals extra damage if stack had positive morale.^;
*!DO(AC_Function_105)/0/41/1:P;                                                             [call funktion for mirth] *changed from fly to bonus damage
!!en;

!!if&v9290=112;
!!VRz1:S^You cast {improved Luck}.
Your creatures get champion distance bonus this round.^;
!!DO(AC_Function_105)/0/41/1:P;         [call funktion for luck]
!!en;

!!if&v9290=113;
!!VRz1:S^You cast {improved Counterstrike}.
Your creatures get no retaliation this round.^;
*!DO(AC_Function_105)/0/41/1:P;         [call funktion for counterstrike]
!!SN&v9280=0:W^Counterstrike_Cast0^/1;
!!SN&v9280=1:W^Counterstrike_Cast1^/1;
!!en;

!!if&v9290=114;
!!VRz1:S^You cast {improved Slayer}.
Chance for crushing blows against lvl 7 creatures.^;
!!SN&v9280=0:W^Slayer_Cast0^/1;         [call funktion for slayer]
!!SN&v9280=1:W^Slayer_Cast1^/1;
!!en;

!!if&v9290=115;
!!VRz1:S^You cast {improved Fire Shield}.
Chance to summon Fire Elementals when attacking the Fire Shield.^;
!!SN&v9280=0:W^Fire_Shield_Cast0^/1;
!!SN&v9280=1:W^Fire_Shield_Cast1^/1;
*!DO(AC_Function_105)/0/41/1:P;                                                             [call funktion for fire shield]
!!en;

!!if&v9290=116;
!!VRz1:S^You cast {improved Frenzy}.
Chance that your creature gets attack and return this round.^;
*!DO(AC_Function_105)/0/41/1:P;         [call funktion for frenzy]
!!en;

!!if&v9290=117;
!!VRz1:S^You cast {improved Protection from Fire}.
Chance to cast Magic Arrow after attack.^;
*!DO(AC_Function_105)/0/41/1:P;                                                             [call funktion for Protection from Fire]
!!en;

!!if&v9290=118;
!!VRz1:S^You cast {improved Protection from Water}.
Chance to cast Magic Arrow after attack.^;
*!DO(AC_Function_105)/0/41/1:P;                                                             [call funktion for Protection from Water]
!!en;

!!if&v9290=119;
!!VRz1:S^You cast {improved Protection from Earth}.
Chance to cast Magic Arrow after attack.^;
*!DO(AC_Function_105)/0/41/1:P;                                                             [call funktion for Protection from Earth]
!!en;

!!if&v9290=120;
!!VRz1:S^You cast {improved Protection from Air}.
Chance to cast Magic Arrow after attack.^;
*!DO(AC_Function_105)/0/41/1:P;                                                             [call funktion for Protection from Air]
!!en;

!!if&v9290=121;
!!VRz1:S^You cast {improved Summoning Fire Elementals}.
Your summoned fire elementals grow for 3 battleround.^;
!!VRv9276:S1;                           [call for Summon Fire]
!!SN&v9280=1:W^H3_Summon_Fire_0^/v997;
!!SN&v9280=0:W^H3_Summon_Fire_1^/v997;  [Save var with Current Battle Round]
!!en;

!!if&v9290=122;
!!VRz1:S^You cast {improved Summoning Earth Elementals}.
Your summoned earth elementals grow for 3 battleround.^;
!!VRv9277:S1;                           [call for Summon Earth]
!!SN&v9280=1:W^H3_Summon_Earth_0^/v997;
!!SN&v9280=0:W^H3_Summon_Earth_1^/v997; [Save var with Current Battle Round]
!!en;

!!if&v9290=123;
!!VRz1:S^You cast {improved Summoning Water Elementals}.
Your summoned water elementals grow for 3 battleround.^;
!!VRv9278:S1;                           [call for Summon Water]
!!SN&v9280=1:W^H3_Summon_Water_0^/v997;
!!SN&v9280=0:W^H3_Summon_Water_1^/v997; [Save var with Current Battle Round]
!!en;

!!if&v9290=124;
!!VRz1:S^You cast {improved Summoning Air Elementals}.
Your summoned air elementals grow for 3 battleround.^;
!!VRv9279:S1;                           [call for Summon Air]
!!SN&v9280=1:W^H3_Summon_Air_0^/v997;
!!SN&v9280=0:W^H3_Summon_Air_1^/v997;   [Save var with Current Battle Round]
!!en;

!!if&v9290=125;
!!VRz1:S^You cast {improved Clone}. ALL clones grow in numbers.^;
!!DO(AC_Function_105)/0/41/1:P;         [call funktion for Clone]
!!en;

*!if&v9290=126;
*!VRz1:S^You cast {improved Luck}.
*Chance for Landmine.^;
*!BU:Mz1;
*!DO(AC_Function_105)/0/41/1:P;                                                             [call funktion for Luck2]
*!en;

!!if&v9290=127;
!!VRz1:S^You cast {improved Resurrection}.
Additional random buff for resurrected stack.^;                                 [call funktion for Resurrection]
!!BG:E?y12;
!!VRy28:S0R17;
!!VRy28&y28=0:S27; !!VRy28&y28=1:S28; !!VRy28&y28=2:S29; !!VRy28&y28=3:S30; !!VRy28&y28=4:S31; !!VRy28&y28=5:S32;
!!VRy28&y28=6:S33; !!VRy28&y28=7:S36; !!VRy28&y28=8:S41; !!VRy28&y28=9:S43; !!VRy28&y28=10:S44; !!VRy28&y28=11:S46;
!!VRy28&y28=12:S48; !!VRy28&y28=13:S49; !!VRy28&y28=14:S51; !!VRy28&y28=15:S53; !!VRy28&y28=16:S55; !!VRy28&y28=17:S58;
!!BMy12:My28/2/3;                       [apply buff when resurrection]
!!en;

!!if&v9290=128;
!!VRz1:S^You cast {improved Prayer}.
Additional holy damage against undead troops.^;                                                                     [call funktion for Prayer]
!!en;

!!if&v9290=129;
!!VRz1:S^You cast {improved Sorrow}.
Enemies deals less damage to bigger creatures.^;                                                                      [call funktion for Sorrow]
!!en;

!!if&v9290=130;
!!VRz1:S^You cast {improved Disrupting Ray}.
+2 additional damage for every stack attacking this stack.^;                                                                      [call funktion for Disrupting Ray]
!!BG:E?y12;
!!FU&y12=-1:E;
!!BMy12:G46/?y13/?y14;                  [Disrupting Ray removes Stone Skin and disables master bonus @alf]
!!FU(TakeStoneSkinBonusDisRay)&y13>0:Py3;
!!SN&y12<>-1:W^DisruptingRayCastsStack%Y12^/d+1;
!!FU(AC_ResetSpellFromStack):Py12/46;
!!en;

!!if&v9290=131;
!!VRz1:S^You cast {improved Landmine}.
Every creature stepping on a landmine loses speed, depending on monster level.^;                                                                      [call funktion for Landmine]
!!en;

!!if&v9290=132;
!!VRz1:S^You cast {improved Weakness}.
Enemies deals reduced damage for every battleround weakness lasts.^;                                                                      [call funktion for Weakness]
!!en;

!!if&v9290=133;
!!VRz1:S^You cast {improved Curse}.
Enemies deals reduced damage for every debuff affecting the stack.^;                                                                    [call funktion for Curse]
!!SN&v9280=1:W^Bless_Cast0^/0;
!!SN&v9280=0:W^Bless_Cast1^/0;
!!en;

!!if&v9290=134;
!!VRz1:S^You cast {improved Forgetfulness}.
Chance that shooters attack their neighbouring stack.^;                                                                       [call funktion for Forgetfulness]
!!DO(AC_Function_113)/0/41/1:P;
!!en;

!!if&v9290=135;
!!VRz1:S^You cast {improved Shield}.
First stack in stack gets a damage absorbing shield.^;
!!SN:W^shield_var1^/?y1;
!!SN:W^shield_var2^/?y2;                [call funktion for Shield 2]
!!if&v9280=0/y1=0;
!!DO(AC_Function_105)/0/20/1:P;
!!SN:W^shield_var1^/10;
!!en;
!!if&v9280=1/y2=0;
!!DO(AC_Function_105)/21/41/1:P;
!!SN:W^shield_var2^/10;
!!en;
!!en;

!!if&v9290=136;
!!VRz1:S^You cast {improved Blind}.
Blind cannot be dispelled or cured for the current battle round.^;                                                                      [call funktion for blind]
!!en;

!!if&v9290=137;
!!VRz1:S^You cast {improved Misfortune}.
Enemies has a chance to deal reduced damage with attacks.^;                                                                      [call funktion for misfortune]
!!en;

!!if&v9290=138;
!!VRz1:S^You cast {improved Fortune}.
Chance to steal stat values from your enemies with attack.^;                                                                     [call funktion for fortune]
!!en;

!!if&v9290=139;
!!VRz1:S^You cast {improved Death Ripple}.
All living creatures lose 1 morale for the current battle round.^;
!!SN&v9280=1:W^Death_Ripple_Cast1^/1;   [Defender]
!!SN&v9280=0:W^Death_Ripple_Cast0^/1;   [Attacker]
!!en;

!!if&v9290=140;
!!VRz1:S^You cast {improved Destroy Undead}.
All living creatures get 1 morale for the current battle round.^;
!!SN&v9280=1:W^Destroy_Undead_Cast1^/1; [Defender]
!!SN&v9280=0:W^Destroy_Undead_Cast0^/1; [Attacker                               [call funktion for destroy undead]
!!en;

!!if&v9290=141;
!!VRz1:S^You cast {improved Firewall}.
If enemies pass more than once through your firewall they explode.^;            [call funktion for firewall]
!!en;

!!if&v9290=142;
!!VRz1:S^You cast {improved Dispel}.
After dispel cast your buffs still last for the current battle round.^;         [call funktion for dispel]
!!SN:W^Slow_Cast0^/0;
!!SN:W^Slow_Cast1^/0;
!!SN:W^Bloodlust_Cast0^/0;
!!SN:W^Bloodlust_Cast1^/0;
!!SN:W^Bless_Cast0^/0;
!!SN:W^Bless_Cast1^/0;
!!SN:W^Haste_Cast0^/0;
!!SN:W^Haste_Cast1^/0;
!!SN:W^Stoneskin_Cast0^/0;
!!SN:W^Stoneskin_Cast1^/0;
!!en;

!!if&v9290=143;
!!VRz1:S^You cast {improved Sacrifice}.
The sacrificed stack gets revived martyr.^;                                     [call funktion for sacrifice]
!!DO(AC_Function_105)/0/41/1:P;
!!en;

!!if&v9290=144;
!!VRz1:S^You cast {improved Force Field}.
Creatures next to the Force Field have increased combat power.^;                [call funktion for Force Field]
!!en;

!!if&v9290=145;
!!VRz1:S^You cast {improved Quicksand}.
Places one patch of quicksand in front of all your shooting troops.^;           [call funktion for Quicksand]
!!DO(AC_Function_123)/0/20/1&v9280=0:P;
!!DO(AC_Function_123)/21/41/1&v9280=1:P;
!!BMi^battle_current_stack^:C0/0/0/0/0;                                         [Archer's hack to restore the highlight]
!!en;

!!if&v9290=146;
!!VRz1:S^You cast {improved Teleport}.
Teleported creatures get surrounded with landmines.^;                           [call funktion for Teleport]
!!DO(AC_Function_124)/0/41/1:P;
!!en;

!!if&v9290=147;
!!VRz1:S^You cast {improved Earthquake}.
Chance to stun enemy creatures. They also loose ammunition^;                    [call funktion for Earthquake]
!!DO(AC_Function_127)/21/41/1:P;
!!BU&i^battle_isVisible^:R;
!!en;

!!if&v9290=148;
!!VRz1:S^You cast {improved Remove Obstacle}.
Chance to cast again after the obstacle is removed^;                            [call funktion for Remove Obstacle]
!!FU(AC_Function_96):P;
!!en;

!!if&v9290=149;
!!VRz1:S^You cast {improved Armageddon}.
Your troops are resistant to fire and take less damage from Armageddon^;        [call funktion for Armageddon]
!!en;

!!if&v9290=150;
!!VRz1:S^You cast {improved Berserk}.
After Berserk wears off, enemy creatures are exhausted^;                        [call funktion for Berserker]
!!en;

!!if&v9290=151;
!!VRz1:S^You cast {improved Hypnotize}.
Hypnotized creatures have a chance to blind enemy creatures^;                   [call funktion for Hypnotize]
!!en;

!!if&v9290=152;
!!VRz1:S^You cast {improved Animate Dead}.
Undead stacks heal and with next attack^;                                        [call funktion for Animate Dead]
!!DO(AC_Function_128)/0/41/1:P;
!!en;

!!if&v9290=153;
  !!SN:W^Improved_Magic_Arrow_Counter^/?y20;  
  !!if&y20<2;
  !!SN:W^MA_Stack_Number^/?y50;
  !!if&y50>=0/y50<=41;
  !!BMy50:N?y51;  
  !!if&y51=0;                           [if enemy is dead]
    !!SN:W^Magic_Arrow_Hero%V9283^/?y10;[refer to current casting hero]    
    !!FU|v9283<0/v9283>155:E;
    !!HEv9283:E?y50/?y52/1;             [Get level of Hero]
    !!VRy52:*4;                         [Cap at four times hero level]
    !!FU&y10>y52:E;                     [Exit if bigger 4xhero level]
    !!SN:W^Magic_Arrow_dmg_increment^/?y60; [get damage increase per level]
    !!SN:T^AC_Misc.Arrow damage increase^/?z1/^increment^/y60;
    !!BU&i^battle_isVisible^:Mz1;
    !!VRz1:S^CLIMAX^;
    !!SN&i^battle_isVisible^:Pz1;
    !!SN:W^Magic_Arrow_Hero%V9283^/d+1; [when magic arrow was cast increase counter]
    !!SN:W^Improved_Magic_Arrow_Counter^/d+1;
  !!en;
  !!SN:W^MA_Stack_Number^/-1;
  !!en;
  !!en;
!!en;

!!VRv9290:S0;                           [Reset variable after cast]


********************************************************************************
*--------------------Destroy Undead --------------------------------*
!?BG1&1000;                             [Give Moral by One after every Action]

!!SN&v9280=1:W^Destroy_Undead_Cast1^/?y1;[Defender]
!!SN&v9280=0:W^Destroy_Undead_Cast0^/?y1;[Attacker                               [call funktion for destroy undead]
!!FU&y1=0:E;

!!DO(AC_Function_101)/0/20/1&v9280=0:P;
!!DO(AC_Function_101)/21/41/1&v9280=1:P;[call funktion for death ripple]

!?FU(AC_Function_101);
!!BMx16:F?y1 N?y3;                      [read flags]
!!VRy1:&16;                             [just look at alive]
!!FU|y1>0/y3<1:E;                       [Exit if no stack or has no morale Flag]
!!BMx16:G212/?y2/?t;                    [212 Moral]
!!VRy2:+1;                              [add positive morale to current morale]
!!VRy2&y2<=-3:S-3;                      [Cannot be more than -3 Morale]
!!VRy2&y2>=5:S5;                        [Cannot be more than +5 Morale]
!!BMx16:G212/y2/?t;                     [212 Moral]

********************************************************************************
*--------------------Death Ripple  --------------------------------*
!?BG1&1000;                             [Reduce Moral by One after every Action]

!!SN&v9280=0:W^Death_Ripple_Cast0^/?y1; [Attacker]
!!SN&v9280=1:W^Death_Ripple_Cast1^/?y1; [Defender]
!!FU&y1=0:E;

!!DO(AC_Function_109)/0/20/1&v9280=1:P;
!!DO(AC_Function_109)/21/41/1&v9280=0:P;[call funktion for death ripple]

!?FU(AC_Function_109);
!!BMx16:F?y1 N?y3;                      [read flags]
!!VRy1:&16;                             [just look at alive]
!!FU|y1=0/y3<1:E;                       [Exit if no stack or has no morale Flag]
!!BMx16:G212/?y2/?t;                    [212 Moral]
!!VRy2:-1;                              [add negative morale to current morale]
!!VRy2&y2<=-3:S-3;                      [Cannot be more than -3 Morale]
!!VRy2&y2>=5:S5;                        [Cannot be more than +5 Morale]
!!BMx16:G212/y2/?t;                     [212 Moral]


*-------------------------------Heal -----------------------------------------*
* Acts as little Resurrect
!?BG1&1000;

!!SN:W^Improved_Cure^/?y1;
!!FU&y1<>1:E;
!!HE-1:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y86/d; [Checke ob der Held Sorcery und Magien hat  16 Water Magic 24 int]

!!BG:Q?y99;                             [Current attacking side]
!!BG:H?y2;
!!SN:W^H3_Water Magic_1_Hero%Y2^/?y87;  [Changed intelligence requirement to GM Water @Alf]
!!DO(AC_Function_110)/0/20/1&y99=0:Py87/y83/y86/y2;
!!DO(AC_Function_110)/21/41/1&y99=1:Py87/y83/y86/y2;

!!SN:W^Improved_Cure^/0;
!!BA:Q?f;
!!BU&i^battle_isVisible^:R;


!?FU(AC_Function_110);

!!BMx16:N?y1 H?y2 L?y3 B?y4;
!!FU&y1<=0:E;                           [Skip if the stack is killed]
!!FU&y4=0:E;
!!FU&y2=0:E;
!!FU&y1=y4/y3=0:E;

!!BMx16:F?y5;
!!VRy5:&12582912;                       [Check for Clone Spell]
!!FU&y5>0:E;                            [Exit if Clone because they cannot be healed]
!!HEx4:X?y5/?y6/d/d/d/d/d;              [Check Hero Speciality]

!!SS37:P?y7;
!!SS37:Ex2/?y8;

!!VRy10&x2=3:S1 *x3 *y7 +y8;            [Set Cure for Expert @alf]
!!VRy10&x1>0:+100;                      [+100 HP with Intelligence] now GM Water @Alf]
!!VRy10&y5=3/y6=37:*2;                  [Cure specialists further doubles this bonus @Alf]

!!VRy12:Sy10 %y2;
!!VRy15:Sy3;
!!VRy15:Sy15-y12;
!!VRy16:Sy15;
!!VRy11:Sy10:y2;                        [Number of possible Revives]

!!if&y12>=y3;
!!VRy16:*-1;
!!VRy17:Sy2;
!!VRy17:-y16;
!!VRy16:Sy17;
!!VRy11:+1;                             [Add 1 creature for correct rest life]
!!en;

!!VRy6:Sy1+y11;                         [Total Number after attack]
!!VRy16&y6>y4:S0;                       [Fix for Commander, Set lost life to zero if could heal more than 1 stack above maximum]
!!VRy6&y6>=y4:Sy4;                      [Set Number Cannot be more than before fight]

!!BMx16:Ny6 Ly16;                       [Set Number and apply rest life]


*-------------------------------blind -----------------------------------------*
*Withstands one Heal or Dispel try
!?BG1&1000/-936;                        [run forest]

!!BG:S?y2;                              [y2 now contains spell number]
!!FU&y2<=9|y2>69:E;

!!if&v9280=0;
!!SN:W^H3_Fire Magic_0_Hero%V9282^/?y11;[Fire Magic Bonus handling]
!!HEv9282:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85; [Checke current hero Sorcery und Magien hat]
*!VRy85&y85><0/v7198=1:+4;
!!en;

!!if&v9280=1;
!!SN:W^H3_Fire Magic_0_Hero%V9281^/?y11;[Fire Magic Bonus handling]
!!HEv9281:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85; [Checke current hero Sorcery und Magien hat]
*!VRy85&y85><0/v7198=1:+4;
!!en;

!!if&y2=35/y81=3/y11=1;
!!DO(AC_Function_111)/0/41/1:P;         [call funtion for cleanse]
!!en;

!!if&y2=37/y81=3/y11=1;
!!DO(AC_Function_111)/0/41/1:P;         [call funtion for heal]
!!en;


*-------------------------------dispel ----------------------------------------*
*lets you keep all buffs for current battle round
!?BG1&1000/v9447=0/-936;                [run forest]

!!BG:S?y2;                              [y2 now contains spell number]
!!FU&y2<>35:E;                          [Exit if AIs turn]

!!BA:Hv9280/?y99;
!!SN:W^H3_Water Magic_0_Hero%Y99^/?y13; [Water Magic Bonus handling]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85; [Checke current hero Sorcery und Magien hat]

!!if&y2=35/y83=3/v9280=0/v9447=0/y13=1;
!!DO(AC_Function_116)/0/15/1:P;         [call funtion for cleanse]
!!BA:Q?f;
!!BU&i^battle_isVisible^:R;
!!en;                                  [Run function to give back spells]

!!if&y2=35/y83=3/v9280=1/v9447=0/y13=1;
!!DO(AC_Function_116)/21/36/1:P;        [call funtion for cleanse]
!!BA:Q?f;
!!BU&i^battle_isVisible^:R;
!!en;                                  [Run function to give back spells]


!?BG0&1000/v9447=0/-936;                [Extra Improved Dispel Trigger]

!!BG:A?y1;
!!FU&y1<>1:E;                           [Exit if no Hero cast]

!!BG:S?y2;                              [y2 now contains spell number]
!!FU&y2<>35:E;                          [Exit if not cleanse]

!!BA:Hv9280/?y99;
!!SN:W^H3_Water Magic_0_Hero%Y99^/?y13; [Water Magic Bonus handling]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85; [Checke current hero Sorcery und Magien hat]

!!if&y2=35/y83=3/v9280=0/y13=1;
!!DO(AC_Function_115)/0/15/1:P;         [call funtion for cleanse]
!!en;                                  [Run function to remember spells]

!!if&y2=35/y83=3/v9280=1/y13=1;
!!DO(AC_Function_115)/21/36/1:P;        [call funtion for cleanse]
!!en;                                  [Run function to remember spells]


*-------------------------------sorrow ----------------------------------------*
*deals 4% less damage for every lvl difference between monsters
!?MF1&1000/-936;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]

!!MF:W?y80;
!!FU&y80>0:E;

!!BG:A?y1;
!!if&y1=6|y1=7;

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Sorrow_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
!!SN:W^Sorrow_Attacking_Stack^/y4;

!!BMy1:I?y2;                            [Side index as for heroes (0:left, 1:right)]
!!VRy2:-1 *-1;

!!SN:W^Sorrow_Cast%Y2^/?y3;             [Check if Spell was actually cast by Hero]
!!FU&y3<>1:E;

!!BMy1:G50/?y13/?y14;                   [check for Sorrow Duration]
!!FU&y13=0:E;

!!BMy4:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!SN:W^H3_Earth Magic_0_Hero%Y99^/?y14; [Earth Magic Bonus handling]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85; [Checke ob der Held Sorcery und Magien hat]
!!FU|y84<3/y14<>1:E;

!!BMy4:T?y4;                            [monter type? defending]
!!BMy1:T?y10;                           [monter type? attacking]
!!MA:Ly4/?y5 Ly10/?y11;                 [monster level of receiving stack and defending stack]
!!FU&y5<=y11:E;                         [continue only if defending stack is bigger than attacking stack]

!!VRy5:-y11 *5;                         [5% less damage per level difference]
!!MF:F?y6;                              [damage dealt]
!!VRy13:S100-y5;
!!VRy7:Sy6 *y13:100;                    [additional]
!!VRy8:Sy6 -y7;                         [reduced damage]
!!MF&y7>0:Fy7;                          [apply new damage]
!!SN:T^AC_Misc.Sorrow reduce^/?z-1/^damage^/y8;
!!BA:Q?f;
!!BU&i^battle_isVisible^:Mz-1;                          [show message in log]
!!en;
!!en;

*-------------------------------disrupting ray --------------------------------*
*deals +2 damage per cast for every attacking stack against disrupting ray
!?MF1&1000/-936;                        [before stack takes physical damage]

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]
!!MF:W?y80;
!!FU&y80>0:E;

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Ray_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
!!SN:W^Ray_Attacking_Stack^/y4;

!!BMy4:G47/?y13/?y14;                   [check for disrupting ray]
!!FU&y13=0:E;

!!BMy1:I?y98;

!!BA:Hy98/?y99;
!!FU&y99<0:E;
!!SN:W^H3_Air Magic_0_Hero%Y99^/?y12;   [Air Magic Bonus handling]
!!HEy99:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85; [Checke ob der Held Sorcery und Air Magic hat]
!!FU|y82<3/y12<>1:E;

!!SN:W^H3_Air Magic_1_Hero%Y99^/?y13;   [Air GM Magic Bonus handling]
!!SN:W^DisruptingRayCastsStack%Y4^/?y14;
!!BMy1:N?y6;                            [how many monsters in attacking stack?]

!!VRy3&y12=1/y13=0:Sy6 *y14 *1;         [total additional damage 1 per cast with Master]
!!VRy3&y12=1/y13=1:Sy6 *y14 *2;         [total additional damage 2 per cast with GM]
!!MF:F?y4;                              [original damage]
!!VRy5:Sy4 +y3;
!!FU&y3=0:E;                            [Exit if zero damage]
!!MF:Fy5;                               [deal new updated damage]

!!SN:T^AC_Misc.Ray Damage^/?z-1/^damage^/y3;
!!BU&i^battle_isVisible^:Mz-1;
!!en;

*-------------------------------Stone Skin Special--------------------------------*
*stack gets 1 additional defence each 2 hits taken.
!?MF1&1000/-936;                        [before stack takes physical damage]

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]

!!MF:W?y1;
!!FU&y1>0:E;

!!MF:N?y4;                              [damage receiving stack]
!!BMy4:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!SN&y5=0:W^Stoneskin_Cast00^/?y1;
!!SN&y5=1:W^Stoneskin_Cast11^/?y1;
!!FU&y1=0:E;                            [Exit if Improves Stoneskin hasnt been cast]

!!BMy4:G46/?y13/?y14;                   [check for stoneskin]
!!FU&y13=0:E;

!!BMy4:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;
!!SN:W^H3_Earth Magic_0_Hero%Y99^/?y14; [Earth Magic Bonus handling]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85; [Checke ob der Held Sorcery und Magien hat]
!!FU|y84<3/y14<>1:E;

!!BA:Q?f;
!!SN:W^StoneSkinHitsStack%Y4^/d+1;
!!SN:W^StoneSkinHitsStack%Y4^/?y8;
!!VRy8:%2 *-1 +1;                       [If hits taken is even, then increase defence by 1]
!!BMy4:D?y9;
!!VRy9:+y8;
!!BMy4:Dy9;

!!VRz-1&i^battle_isVisible^/y8=1:S^SHIELD^;
!!SN&i^battle_isVisible^/y8=1:Pz-1;
!!BMy4&i^battle_isVisible^/y8=1:V54;
!!en;

*-------------------------------prayer ----------------------------------------*
*deals additional holy damage against undead creatures, scales with SP of hero (max 25%)
!?MF1&1000/-936;                        [before stack takes physical damage]

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]

!!MF:W?y80;
!!FU&y80>0:E;

!!BG:A?y1;
!!if&y1=6|y1=7;

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Prayer_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]

!!SN:W^Prayer_Attacking_Stack^/y4;

!!BMy1:I?y2;                            [Side index as for heroes (0:left, 1:right)]
!!SN:W^Prayer_Cast%Y2^/?y3;             [Check if Spell was actually cast by Hero]
!!FU&y3<>1:E;

!!BMy1:G48/?y13/?y14;                   [check for Prayer Duration]
!!FU&y13=0:E;

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!SN:W^H3_Water Magic_0_Hero%Y99^/?y13; [Water Magic Bonus handling]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d S24/?y87; [Checke ob der Held Sorcery und Water Magic hat und Spellpower]
!!FU|y83<3/y13<>1:E;

!!SN:W^H3_Water Magic_1_Hero%Y99^/?y87; [Water Magic Bonus handling]
!!BMy4:F?y78;                           [read flags]
!!VRy78:&262144;                        [just look undead bit]
!!if&y78>0;
!!MF:F?y4;                              [original damage]
!!VRy23:Sy22 *2;                        [additional holy damage]
!!VRy23::5 +100;                        [2% more damage per 5SP]
!!VRy23&y87>0:+5;                       [+5% Bonus with GM]
!!VRy23&y23>=125:S125;                  [Limit to 25% Bonus damage]
!!VRy5:Sy4 *y23:100;
!!VRy6:Sy5-y4;
!!MF:Fy5;                               [deal new updated damage]

!!SN:T^AC_Misc.Prayer Damage^/?z-1/^damage^/y6;
!!BU:Mz-1;
!!en;
!!en;
!!en;

*-------------------------------Landmine --------------------------------------*
* if stepping on landmine creature loses 1-3 speed for rest of combat
!?MR1&1000/-936;                        [after stack takes magic damage]

!!MR:S?y4;                              [Spell Number]
!!FU&y4<>11:E;                          [Exit if not Landmine spell]

!!BG:A?y2;
!!if|y2=2/y2=6;                        [if walk or attack]
!!BG:N?y1;                              [active stack]
!!BG:Q?y3;                              [current attacking side]

!!if&y3=0;
!!SN:W^H3_Fire Magic_0_Hero%V9282^/?y11;[Fire Magic Bonus handling]
!!HEv9282&v9282>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d; [Checke ob der Held Sorcery und Fire Magic hat]
!!FU|y81<3/y11<>1:E;
!!en;

!!if&y3=1;
!!SN:W^H3_Fire Magic_0_Hero%V9281^/?y11;[Fire Magic Bonus handling]
!!HEv9281&v9281>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d; [Checke ob der Held Sorcery und Fire Magic hat]
!!FU|y81<3/y11<>1:E;
!!en;

!!BMy1:T?y10;                           [monter type? attacking]
!!MA:Ly10/?y11;                         [monster level of stack]
!!BMy1:S?y6;                            [save speed in y6]

!!VRy5&y11<=3:S1R1;                     [1-2 Monster til level 4]
!!VRy5&y11=4:S1R2;                      [1-3 Monster  level 5]
!!VRy5&y11>=5:S2R3;                     [2-5 Monster bigger level 5]

!!VRy6:-y5;
!!VRy6&y6=1:S2;                         [Cannot be less than 2 speed]
!!VRy6&y6=0:S2;
!!VRy6&y6=-1:S2;
!!VRy6&y6=-2:S2;
!!BMy1&y6>0:Sy6;                        [reduce speed by 3]

!!SN:T^AC_Misc.Landmine Damage^/?z-1/^damage^/y5;
!!BU:Mz-1;
!!en;

*-------------------------------Landmine 2-------------------------------------*
* deploys one big land mine which deals fatal damage to the stack. Damage is 1500 +10% +5% per 10SP of total Health from Stack
!?MR1&1000/-936;                        [after stack takes magic damage]

!!SN:W^landmine_var^/?y90;
!!FU&y90=0:E;

!!BG:A?y2;
!!if|y2=2/y2=6;                        [if walk or attack]

!!MR:S?y4;                              [Spell Number]
!!FU&y4<>11:E;                          [Exit if not Landmine spell]
!!BG:N?y1;                              [active stack]
!!BG:Q?y3;

!!if&y3=0;
!!SN:W^H3_Fire Magic_0_Hero%V9282^/?y11;[Fire Magic Bonus handling]
!!HEv9282&v9282>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d; [Checke ob der Held Sorcery und Fire Magic hat]
!!FU|y81<3/y11<>1:E;
!!en;

!!if&y3=1;
!!SN:W^H3_Fire Magic_0_Hero%V9281^/?y11;[Fire Magic Bonus handling]
!!HEv9281&v9281>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d; [Checke ob der Held Sorcery und Fire Magic hat]
!!FU|y81<3/y11<>1:E;
!!en;

!!VRy10:S0R7;                           [1/8 chance for big landmine]

!!if&y10=0;
!!MR:F?y6;                              [damage dealt]
!!BMy1:N?y7;                            [get number of active stack]
!!BMy1:H?y8;                            [get Health Points from Stack]
!!VRy11:Sy22 :2 +10;                    [Calculate 10% +5% for 10 SP]
!!VRy9:Sy7 *y8;                         [calculate total HP from Stack]
!!VRy12:Sy9 *y11 :100 +1500 +y6;        [calculate prozentual damage from stacks HP] and add 1500+original damage]

!!VRz-1:S^ExplosionMine^;               [Play heavy explosion sound]
!!SN:Pz-1;
!!BMy1:V9;                              [show inferno animation]
!!MR:Fy12;                              [apply damage]

!!SN:T^AC_Misc.Landmine Damage 2^/?z-1;
!!BU:Mz-1;
!!VRy90:-1;
!!SN:W^landmine_var^/y90;               [Decrease big mines amount by 1 @alf]
!!en;
!!en;


*-------------------------------weakness --------------------------------------*
*creatures deal 4% less damage for every battleround after weakness was cast
!?MF1&1000/-936;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]

!!MF:W?y80;
!!FU&y80>0:E;

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Weakness_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]

!!BMy1:I?y2;                            [Side index as for heroes (0:left, 1:right)]
!!VRy2:-1 *-1;

!!SN:W^Weakness_Attacking_Stack^/y4;

!!SN:W^Weakness_Cast%Y2^/?y3;           [Check if Spell was actually cast by Hero]
!!FU&y3<>1:E;

!!BMy1:G45/?y13/?y14;                   [check for Weakness Duration]
!!FU&y13=0:E;

!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Weakness_Attacking_Stack^/y4;

!!BMy4:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!SN:W^H3_Water Magic_0_Hero%Y99^/?y33; [Water Magic Bonus handling]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d; [Checke ob der Held Sorcery und WaterMagien hat und Sp]
!!FU|y83<3/y33<>1:E;

!!VRy10:Sy22-y13;                       [calculate round after cast]
!!FU&y10=0:E;                           [exit if weakness was cast this round]

!!VRy10:S2;                             [Temorary fix for spell duration mod because he breaks the mechanic]
!!MF:F?y6;                              [damage dealt]
!!VRy10:Sy10 *-4 +100;                  [4% less damage per round difference]
!!VRy7:Sy6 *y10 :100;
!!VRy8:Sy6 -y7;
!!MF&y7>0:Fy7;                          [apply reduced damage]

!!SN:T^AC_Misc.Weakness Damage^/?z-1/^damage^/y8;
!!BU:Mz-1;                              [show message in log]
!!en;


*-------------------------------shield ----------------------------------------*
*first creature in stack gets a big shield which blocks physical and magic damage
!?MF1&1000/-936;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676;[Only run when melee or shooting damage]

!!MF:W?y80;
!!FU&y80>0:E;

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Shield_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
!!BMy1:I?y2;                            [Side index as for heroes (0:left, 1:right)]
!!VRy2:-1 *-1;
!!SN:W^Shield_Attacking_Stack^/y4;
!!SN:W^Shield_Cast%Y2^/?y3;             [Check if Spell was actually cast by Hero]
!!FU&y3<>1:E;
!!BMy4:G27/?y13/?y14;                   [check for Shield Duration]
!!SN:W^H3_Shield_0_Block_Stack_%Y4^/?y15;
!!FU|y13=0/y15<=0:E;                    [Exit if no Shield or no more Shield Blocks left]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Shield_Attacking_Stack^/y4;
!!BMy4:F?y78;                           [read flags]
!!VRy78:&4194304;                       [just look summoned bit]
!!FU&y78>0:E;                           [Exit if cloned or summoned]
!!BMy4:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!SN:W^H3_Earth Magic_0_Hero%Y99^/?y11; [Earth Magic Bonus handling]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 F?y80/?y80/?y22/?y80 S24/?y87 A2/39/?y88/?y89; [Checke ob der Held Sorcery und EarthMagien hat und Sp]
!!FU|y84<3/y11<>1:E;

*!BMy4:H?y6;                                                                    [Hit Points in defending stack]
*!BMy4:L?y7;                                                                    [Hit points lost by the next monster in the stack]
*!VRy11:Sy10 +y6 -y7;                                                           [HP of first stack in stack + shield]

!!SN:W^H3_Earth Magic_1_Hero%Y99^/?y87; [Earth Magic Bonus handling]
!!VRy10&y87=0:Sy22 *10 +100;            [calculate shield value with Master Earth]
!!VRy10&y87=1:Sy22 *15 +150;            [calculate shield value with GM Earth]
!!VRy10&y89=1:*2;                       [39  Dragon Scale Shield gives double effect]
!!BA:Q?f;
!!MF:F?y8;                              [damage dealt]
!!if&y8>y10;                            [do if damage is bigger than shield]
  !!VRy12:Sy6-y10;
  !!VRy9:Sy8-y10;
  !!VRz-1:S^CRUSDFND.wav^;              [find block sound]
  !!SN&i^battle_isVisible^:Pz-1;        [play block sound]
  !!MF:Fy9;
  !!SN:T^AC_Misc.Shield block^/?z-1/^damage^/y10;
  !!BU:Mz-1;
!!el;                                   [do if damage is smaller than shield]
  !!VRy12:Sy6-y10;
  !!VRz-1:S^CRUSDFND.wav^;              [find block sound]
  !!SN&i^battle_isVisible^:Pz-1;        [play block sound]
  !!VRy9:Sy8;
  !!MF:E0;
  !!MF:F0;
  !!SN:T^AC_Misc.Shield block^/?z-1/^damage^/y8;
  !!BU:Mz-1;
!!en;
!!SN:W^H3_Shield_0_Block_Stack_%Y4^/d-1;
!!en;


!?MR0&1000/-936;

!!SN&v9280=0:W^Shield_Cast1^/?y1;
!!SN&v9280=1:W^Shield_Cast0^/?y1;
!!FU&y1<>1:E;
!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>1:E;
!!MR:S?y2;
!!FU&y2<=9|y2>69:E;
!!FU(AC_Function_112):P?y4;             [call fkt for magic dmg recieving stack]
!!if&y4>=0/y4<=41;
!!BMy4:G27/?y13/?y14;                   [check for shield duration]
!!SN:W^H3_Shield_1_Block_Stack_%Y4^/?y15;
!!FU|y13=0/y15<=0:E;
!!BMy4:F?y78;                           [read flags]
!!VRy78:&4194304;                       [just look summoned bit]
!!FU&y78>0:E;                           [Exit if cloned or summoned]
!!BMy4:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!SN:W^H3_Earth Magic_0_Hero%Y99^/?y11; [Earth Magic Bonus handling]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d S24/?y87 A2/39/?y88/?y89; [Checke ob der Held Sorcery und EarthMagien hat und Sp]
!!FU|y84<3/y11<>1:E;
!!BA:Q?f;
!!SN:W^H3_Earth Magic_1_Hero%Y99^/?y87; [Earth Magic Bonus handling]
!!VRy10&y87=0:Sy22 *10 +100;            [calculate shield value with Master Earth]
!!VRy10&y87=1:Sy22 *15 +150;            [calculate shield value with GM Earth]
!!VRy10&y89=1:*2;                       [39  Dragon Scale Shield gives double effect]
!!MR:F?y8;                              [damage dealt]
!!FU&y8<=0:E;
!!if&y8>y10;                            [do if damage is bigger than shield]
  !!VRy12:Sy6-y10;
  !!VRy9:Sy8 -y10;
  !!VRz-1&i^battle_isVisible^:S^CRUSDFND.wav^;          [find block sound]
  !!SN&i^battle_isVisible^:Pz-1;                        [play block sound]
  !!MR:Dy9;
  !!SN:T^AC_Misc.Shield block 2^/?z-1/^damage^/y10;
  !!BU:Mz-1;
!!el;                                                   [do if damage is smaller than shield]
  !!VRy12:Sy6 -y10;
  !!VRz-1&i^battle_isVisible^:S^CRUSDFND.wav^;          [find block sound]
  !!SN&i^battle_isVisible^:Pz-1;                        [play block sound]
  !!VRy9:Sy8;
  !!VRy21:S0;
  !!MR:Dy21;
  !!SN:T^AC_Misc.Shield block 2^/?z-1/^damage^/y8;
  !!BU:Mz-1;
!!en;
!!en;
!!SN:W^H3_Shield_1_Block_Stack_%Y4^/d-1;


*-------------------------------curse -----------------------------------------*
*with Curse creature deals less damage for ever debuff applied
!?MF1&1000/-936;
!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]

!!MF:W?y80;
!!FU&y80>0:E;

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Curse_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]

!!BMy1:I?y2;                            [Side index as for heroes (0:left, 1:right)]
!!VRy2:-1 *-1;

!!SN:W^Curse_Attacking_Stack^/y4;

!!SN:W^Curse_Cast%Y2^/?y3;              [Check if Spell was actually cast by Hero]
!!FU&y3<>1:E;

!!BMy1:G42/?y13/?y14;                   [check for Curse Duration]
!!FU&y13=0:E;

!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Curse_Attacking_Stack^/y4;

!!BMy4:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!SN:W^H3_Fire Magic_0_Hero%Y99^/?y11;  [Fire Magic Bonus handling]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d; [Checke ob der Held Sorcery und Fire Magien hat und Sp]
!!FU|y81<3/y11<>1:E;
!!BA:Q?f;

!!BMy1:G45/?y13/?y14; !!VRy11&y13>0:+1;
!!BMy1:G47/?y13/?y14; !!VRy11&y13>0:+1;
!!BMy1:G50/?y13/?y14; !!VRy11&y13>0:+1;
!!BMy1:G52/?y13/?y14; !!VRy11&y13>0:+1;
!!BMy1:G54/?y13/?y14; !!VRy11&y13>0:+1;
!!BMy1:G61/?y13/?y14; !!VRy11&y13>0:+1;
!!BMy1:G62/?y13/?y14; !!VRy11&y13>0:+1;

!!MF:F?y6;                              [damage dealt]
!!VRy10:Sy11 *-5 +100;                  [5% less damage per debuff]
!!VRy7:Sy6 *y10 :100;
!!VRy8:Sy6 -y7;
!!MF:Fy7;                               [apply reduced damage]

!!SN:T^AC_Misc.Curse reduce^/?z-1/^damage^/y8;
!!BU&i^battle_isVisible^:Mz-1;
!!en;


*-------------------------------misfortune -------------------------------------*
*creature have a chance to deal less damage. damage reduction is dependant on SP
!?MF1&1000/-936;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]

!!MF:W?y80;
!!FU&y80>0:E;

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Misfortune_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]

!!SN:W^Misfortune_Attacking_Stack^/y4;

!!BMy1:I?y2;                            [Side index as for heroes (0:left, 1:right)]
!!VRy2:-1 *-1;

!!SN:W^Misfortune_Cast%Y2^/?y3;         [Check if Spell was actually cast by Hero]
!!FU&y3<>1:E;

!!BMy1:G52/?y13/?y14;                   [check for Misfortune Duration]
!!FU&y13=0:E;

!!BMy4:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!SN:W^H3_Fire Magic_0_Hero%Y99^/?y11;  [Fire Magic Bonus handling]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d S24/?y87; [Checke ob der Held Sorcery und Fire Magien hat und Sp]
!!FU|y81<3/y11<>1:E;
!!BA:Q?f;

!!VRy20:S0R99;
!!if&y20<25;                           [chance is 25% to deal less damage]
!!SN:W^H3_Fire Magic_1_Hero%Y99^/?y87;  [Fire Magic Bonus handling]
!!MF:F?y6;                              [damage dealt]
!!VRy10:Sy22 :2 +20;                    [20% + 1% for 2SP less damage]
!!VRy10&y87>0:+5;                       [+ 5% for GM Fire]
!!VRy10&y10>=50/y87=0:S50;              [Cap at 50%] for Master Fire @Alf]
!!VRy10&y10>=60/y87=1:S60;              [Cap at 60% for GM Fire @Alf]

!!VRy7:Sy6 *y10 :100;
!!VRy8:Sy6 -y7;
!!MF:Fy8;                               [apply reduced damage]

!!VRz-1&i^battle_isVisible^:S^MISFORT^;
!!SN&i^battle_isVisible^:Pz-1;
!!BMy1&i^battle_isVisible^:V48;

!!SN:T^AC_Misc.Misfortune Damage^/?z-1/^damage^/y10;
!!BU&i^battle_isVisible^:Mz-1;
!!en;
!!en;

*-------------------------------fortune ---------------------------------------*
*chance to steal stats with every attack. You can steal attack, defense, damage and speed
!?MF1&1000/-936;
!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]

!!MF:W?y80;
!!FU&y80>0:E;

!!BG:A?y1;
!!if&y1=6|y1=7;

!!BG:N?y1;                              [Attacking Stack]
!!BMy1:T?y7;
!!FU|y7=145/y7=146/y7=147/y7=148/y7=149:E; [Exit for Warmachines]

!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Fortune_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
!!SN:W^Fortune_Attacking_Stack^/y4;

!!BMy4:T?y7;
!!FU|y7=145/y7=146/y7=147/y7=148/y7=149:E; [Exit for Warmachines]

!!BMy1:I?y2;                            [Side index as for heroes (0:left, 1:right)]
!!SN:W^Fortune_Cast%Y2^/?y3;            [Check if Spell was actually cast by Hero]
!!FU&y3<>1:E;

!!BMy1:G51/?y13/?y14;                   [check for Fortune Duration]
!!FU&y13=0:E;

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!SN:W^H3_Air Magic_0_Hero%Y99^/?y12;   [Air Magic Bonus handling]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d S24/?y87; [Checke ob der Held Sorcery und Air Magien hat und Sp]
!!FU|y82<3/y12<>1:E;

!!SN:W^H3_Air Magic_1_Hero%Y99^/?y87;   [Air Magic Bonus handling]
!!VRy20:S0R99;
!!VRy22::2 +20;                         [Chance is 20% + 1% per 2SP]
!!VRy22&y87>0:+10;                      [+10% with GM Air]

!!if&y20<y22;                           [chance is  to steal with every attack]
  ; Check if the target stack is possible to accept a hostile Fortune spell
  !!SS(SPELL_FORTUNE):O?y7 O-1;
  !!FU(ACM_Battle_CanStackReceiveSpell):Py4/(SPELL_FORTUNE)/y5/?y6;
  !!SS(SPELL_FORTUNE):Oy7;
  !!FU&y6<>(TRUE):E;

  !!VRy15:S11 R3;
  !!VRy14:S0;
  ; Attack
  !!if&y15=11;
    !!BMy4:A?y11;
    !!FU&y11<=1:E;
    !!VRy13:Sy11 -4 F1/(INT_MAX);       [Reduce attack but prevent attack lower than 1]
    !!VRy14:Sy11 -y13;                  [Get the value changed]
    !!FU&y14<=0:E;
    !!BMy4:Ad-y14;
    !!BMy1:Ady14;
  ; Defense
  !!el&y15=12;
    !!BMy4:D?y11;
    !!FU&y11<=1:E;
    !!VRy13:Sy11 -4 F1/(INT_MAX);       [Reduce defense but prevent defense lower than 1]
    !!VRy14:Sy11 -y13;                  [Get the value changed]
    !!FU&y14<=0:E;
    !!BMy4:Dd-y14;
    !!BMy1:Ddy14;
  ; Speed
  !!el&y15=13;
    !!BMy4:S?y11;
    !!FU&y11<=3:E;
    !!VRy13:Sy11 -2 F3/(INT_MAX);       [Reduce speed but prevent speed lower than 3]
    !!VRy14:Sy11 -y13;                  [Get the value changed]
    !!FU&y14<=0:E;
    !!BMy4:Sd-y14;
    !!BMy1:Sdy14;
  ; Damage
  !!el&y15=14;
    !!BMy4:U2/?y11 U1/?y12;
    !!FU&y12<=1:E;
    !!VRy13:Sy12 -3 F1/(INT_MAX);       [Reduce damage but prevent damage lower than 1]
    !!VRy14:Sy12 -y13;
    !!FU&y14<=0:E;
    !!BMy4:U2/d-y14 U1/d-y14;                 
    !!BMy1:U2/dy14 U1/dy14;
  !!en;

  !!if&i^battle_isVisible^;
    !!SN&y15=11:T^AC_Misc.Fortune Steal 1^/?z-1/^num^/y14;
    !!SN&y15=12:T^AC_Misc.Fortune Steal 2^/?z-1/^num^/y14;
    !!SN&y15=13:T^AC_Misc.Fortune Steal 3^/?z-1/^num^/y14;
    !!SN&y15=14:T^AC_Misc.Fortune Steal 4^/?z-1/^num^/y14;
    !!MM:Sz-1;
    !!SN:P^MAGCHDRN^;
  !!en;                         
!!en;
!!en;
!!en;


!?FU(ACM_Battle_CanStackReceiveSpell);
!#VA(stackId:x) (spellID:x) (castingSide:x) (result:x);

!!BM(stackId):Z?(stack:y);              [I?(side:y);]
!!UN:C(COMBAT_MANAGER)/(UNC_INT)/?(cmbMgr:y);
!!SN:E5914512/(CALLCONV_THISCALL)/(cmbMgr)/(spellID)/(castingSide)/(stack)/1/1; [can stack apply buff/debuff] 5A3F90]
!!VR(result):Sv1;

*-------------------------------Firewall ---------------------------------------*
!?FU(OnStackToStackDamage);

!!SN:X?y1/?y2/?y3/?y4/?y5/?y6/?y7/?y8/?y9; [Prevents animation]
!!SN&y9=1:W^Real_Attack_0^/0;

!?BG0;
!!SN:W^Real_Attack_0^/1;

!?BG1;
!!SN:W^Real_Attack_0^/0;

*Enemies pass more than once through your firewall they explode
!?MR1&1000/-936;

!!SN:W^Real_Attack_0^/?y1;              [Only trigger when real attack and not theoretical]
!!FU&y1=0:E;

!!BG:A?y2;
!!if|y2=2/y2=6;                        [if walk or attack]

!!MR:S?y2;                              [y2 now contains spell number]
!!FU&y2<>13:E;

!!BG:Q?y3;
!!SN&y3=0:W^H3_Fire Magic_0_Hero%V9282^/?y11; [Fire Magic Bonus handling]
!!HEv9282&y3=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d; [Checke ob der Held Sorcery und Fire Magic hat]

!!SN&y3=1:W^H3_Fire Magic_0_Hero%V9281^/?y11; [Fire Magic Bonus handling]
!!HEv9281&y3=1:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d; [Checke ob der Held Sorcery und Fire Magic hat]

!!FU|y81<3/y11<>1:E;

!!FU(AC_Function_112):P?y4;             [call fkt for magic dmg recieving stack]
!!MR:N?y4;

!!if&y4>=0/y4<=41;

!!MR:F?y8;                              [damage dealt]
!!FU&y8<=0:E;

!!BG:A?y81;
!!if|y81=6/y81=2;

!!BG:N?y80;
!!FU&y4<>y80:E;

!!BMy4:G13/?y13/?y14;                   [Check for Firewall]
!!BA:Q?f;

!!if&y13>5/y8>10;
!!BMy4:M13/15/3;                        [Apply bigger Firewall]
!!VRy9:Sy8 *4;                          [quadruple damage]
!!BMy4&i^battle_isVisible^:V9;
!!VRz1:S^FIREBALL^;
!!SN&i^battle_isVisible^:Pz1;
!!en;

!!if&y13>0/y13<=5/y8>10;
!!BMy4:M13/15/3;                        [Apply Firewall]
!!VRy9:Sy8 *2;                          [double damage]
!!BMy4&i^battle_isVisible^:V53;
!!VRz1&i^battle_isVisible^:S^ExplosionMine^;
!!SN&i^battle_isVisible^:Pz1;
!!en;

!!if&y13=0/y8>0;
!!BMy4:M13/5/3;                         [Apply Firewall]
!!VRy9:Sy8;
!!en;

!!MR:Fy9;
!!en;
!!en;
!!en;


*-------------------------------Bloodlust -------------------------------------*
*creature gets +3 attack for every stack slayed
!?BG0&1000/-936;

!!SN&v9280=0:W^Bloodlust_Cast0^/?y1;
!!SN&v9280=1:W^Bloodlust_Cast1^/?y1;
!!FU&y1<>1:E;

!!BG:N?y1;                              [attacking stack]
!!BMy1:I?y2;                            [Side index as for heroes (0:left, 1:right)]
!!BG:Q?y40;
!!BG:A?y20;
!!FU&y20=7:E;                           [if shoot exit]

!!SN:W^Bloodlust_Var1^/?y10;
!!SN:W^Bloodlust_Var2^/?y11;

!!if&y2=y40;                           [so it only works for attacking not defending]
!!BMy1:G43/?y13/?y14;                   [check for bloodlust Duration]
!!FU&y13=0:E;

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!SN:W^H3_Fire Magic_0_Hero%Y99^/?y11;  [Fire Magic Bonus handling]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d; [Checke ob der Held Sorcery und Fire Magien hat und Sp]
!!FU|y81<3/y11<>1:E;

!!BG:D?y6;
!!BG:E?y7;
!!FU&y7=-1:E;
!!BU:Dy6/?y8;                           [-2 if there is alive stack at that position]
!!VRy10&y8<>-2:S0;
!!FU&y8<>-2:E;
!!VRy11:Sy1;
!!VRy10:Sy6;
!!SN:W^Bloodlust_Var1^/y10;
!!SN:W^Bloodlust_Var2^/y11;
!!en;


!?BG1&1000;

!!SN&v9280=0:W^Bloodlust_Cast0^/?y1;
!!SN&v9280=1:W^Bloodlust_Cast1^/?y1;
!!FU&y1<>1:E;

!!SN:W^Bloodlust_Var1^/?y1;
!!SN:W^Bloodlust_Var2^/?y2;
!!FU&y1=0:E;

!!BG:D?y6;
!!FU&y6<>y1:E;
!!BA:Q?f;

!!BU:Dy1/?y8;                           [-2 if there is alive stack at that position]
!!FU&y8<0:E;
!!BMy2:Ad3;
!!VRz1:S^BLOODLUS^;
!!SN&i^battle_isVisible^:Pz1;
!!SN:W^Bloodlust_Var1^/0;               [Reset bloodlust vars]
!!SN:W^Bloodlust_Var2^/0;


*-------------------------------Force Field -----------------------------------*
*Creatures standing next to the Force Field drain magic energy from it, massively increasing their combat power

!?BG1&1000/-936;
!!SN:W^Force_Field_Cast^/?y1;
!!DO(AC_Function_100)/0/186/1&y1=1:P;   [Run Loop on Battlefield to check for Force Field and give Bonus]
!!DO(AC_Function_119)/0/41/1&y1=1:P;    [Run Loop on Battlefield to check for Force Field and take Bonus]

*-------------------------------Berserk ---------------------------------------*
*When berserker wears off the attacking creature gets slowed

!?BG0&1000/-936;
!!SN:W^Bers_en^/?y1;
!!DO(AC_Function_98)/0/41/1&y1=1:P;     [Run only when Berserk was cast and y1=1]
!?BG1&1000/-936;
!!SN:W^Bers_en^/?y1;                    [Run only when Berserk was cast and y1=1]
!!DO(AC_Function_99)/0/41/1&y1=1:P;

*-------------------------------Hypnotize -------------------------------------*
*Hypnotized creatures have a chance to blind with attacks

!?MF1&1000/-936;
!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]

!!MF:W?y80;
!!FU&y80>0:E;

!!BG:N?y1;                              [attacking stack]
!!BMy1:I?y2;                            [Side index as for heroes (0:left, 1:right)]
!!BG:Q?y40;

!!if&y2=y40;                            [so it only works for attacking not defending]
!!BMy1:G60/?y13/?y14;                   [check for Hypnotize Duration]
!!FU&y13=0:E;

!!MF:N?y4;                              [damage receiving stack]
!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!VRy5:S0;                              [Works only for attacker for now]
!!BA:Hy5/?y99;
!!SN:W^H3_Air Magic_0_Hero%Y99^/?y12;   [Air Magic Bonus handling]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d S24/?y87; [Checke ob der Held Sorcery und Air Magien hat und Sp]
!!FU|y82<3/y12<>1:E;
!!BA:Q?f;
!!SN:W^H3_Air Magic_1_Hero%Y99^/?y87;   [Air Magic Bonus handling]
!!VRy20:S0R99;
!!VRy22:+20;
!!VRy22&y87>0:+20;                      [+20% chance with GM Air]

.!!if&y20<=y22;                         [chance is 20(40 with GM Air)% +SP% to blind]
!!BG:E?y7;
!!FU&y7=-1:E;

!!BMy7:M62/2/3;                         [Apply Blind]


!!VRz1:S^BLIND^;
!!SN&i^battle_isVisible^:Pz1;
!!BMy7&i^battle_isVisible^:V6;                          [Show Blind Animation]
.!!en;
!!en;
!!en;

*-------------------------------Animate Dead ----------------------------------*
*After cast the next attack from this creature heals the creature

!?BG0&1000/-936;

!!SN:W^Animate_Dead^/?y1;
!!FU&y1=0:E;

!!VRv9449:C-1/-1/-1;
!!BG:N?y1 A?y2;
!!SN:W^Animate_Monster^/?y10;
!!FU&y1<>y10:E;
!!FU&y2<>6:E;
!!BG:E?y2;
!!BMy2:F?y3;
!!VRy4:Sy3 &16;                         [only works on living creatures]
!!FU&y4=0:E;
!!BMy2:N?y5 H?y6 L?y7;
!!VRy5:*y6 -y7;
!!VRv9449:Cy1/y2/y5;                    [y5 is der HP pool]


!?MF1&v9449>=0;
!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!FU&y10<>4462398:E;                    [Exit if no Melee Damage]

!!SN:W^Animate_Dead^/?y81;
!!FU&y81=0:E;                           [Exit if Animate Dead was not cast this fight]
!!MF:W?y80;
!!FU&y80>0:E;

!!BG:N?y1;                              [Attacking Stack]
!!BMy1:I?y1;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy1/?y99;
!!FU&y99<0:E;
!!SN:W^H3_Earth Magic_1_Hero%Y99^/?y52; [Earth Magic Bonus handling]

!!MF:F?y10;                             [Damage dealt]
!!HEy99:Fd/d/?y22/d;

!!VRy22&y1>v9451/y52>0:+15;             [if you kill the entire stack you get 15% bonus to revive and you need GM Earth]
!!VRy10:*y22:100;                       [Heal only for %spell power from damage]

!!BMv9449:N?y1 H?y2 L?y3 B?y4;

!!if&y1=y4/y3=0;                       [If zero damage taken so far exit]
  !!VRv9449:C-1/-1/-1;
  !!FU:E;
!!en;

!!VRy10&y10>v9451:Sv9451;               [cannot revive more than HP is available]
!!VRy12:Sy10 %y2;                       [Rest damage HP]

!!VRy15:Sy3;
!!VRy15:Sy15-y12;
!!VRy16:Sy15;
!!VRy11:Sy10:y2;                        [Number of possible Revives]

!!if&y12>=y3;
!!VRy16:*-1;
!!VRy17:Sy2;
!!VRy17:-y16;
!!VRy16:Sy17;
!!VRy11:+1;                             [Add 1 creature for correct rest life]
!!en;

!!VRy6:Sy1+y11;                         [Total Number after attack]
!!VRy6&y6>=y4:Sy4;                      [Cannot be more than before fight]
!!VRy16&y6>=y4:S0;                      [Cannot be more than before fight]

!!BA:Q?f;
!!SN:T^AC_Misc.Animate leech^/?z1;
!!MM&i^battle_isVisible^:Sz1;
!!VRz1:S^ANIMDEAD^;
!!SN&i^battle_isVisible^:Pz1;
!!BMv9449:Ny6 Ly12;
!!BMv9449&i^battle_isVisible^:V74;
*!BMv9450:F?y1;
*!VRy1:|813694976;
*!BMv9450:Fy1 E0 K1;
!!VRv9449:C-1/-1/-1;
!!SN:W^Animate_Dead^/0;

*-------------------------------Magic Arrow-------------------------------------*
* Magic Arrow becomes stronger for 5% if enemy squad is killed
*damage increase of MA moved to Calc Magic Damage fct this code is only needed to get killed stack number
!?MR1&1000/-936;                        [after stack takes magic damage]
*!FU:E;
!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>1:E;

!!MR:S?y4;                              [Spell Number]
!!FU&y4<>15:E;                          [Exit if not Magic Arrow spell]

!!MR:F?y5;
!!FU&y5=0:E;                            [Exit if no damage]

!!BA:Hv9280/?y99;
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85; [Checke current hero Sorcery und Magien hat]

!!SN:W^H3_Air Magic_0_Hero%Y99^/?y81;   [Water Magic Bonus handling]
!!SN:W^H3_Fire Magic_0_Hero%Y99^/?y82;  [Water Magic Bonus handling]
!!SN:W^H3_Water Magic_0_Hero%Y99^/?y83; [Water Magic Bonus handling]
!!SN:W^H3_Earth Magic_0_Hero%Y99^/?y84; [Water Magic Bonus handling]

!!if|y81=1/y82=1/y83=1/y84=1;           [If any School at Master]
  !!BG:E?y50;
  !!if&y50>=0/y50<=41;
    !!SN:W^MA_Stack_Number^/y50;        [get stack number that was killed]
    !!SN:W^Magic_Arrow_Hero%Y99^/?y20;
    !!SN:W^Magic_Arrow_dmg_increment^/?y60; [get damage increase per level]
    *!MR:F?y10;                         [Get damage in y10]
    *!VRy11:Sy20 *y60 +100;             [2% stronger with every use and squad killed]
    *!VRy10:Sy10 *y11 :100;             [Increase damage by percent]
    *!MR:Fy10;                          [apply new damage]
  !!en;
!!en;


*-------------------------------Mirth------------------------------------------*
* %SP bonus damage if stack had moral in this round
!?MF1&1000/-936;                        [*Physical Combat *]

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]

!!MF:W?y80;
!!FU&y80>0:E;

!!BG:A?y1;
!!if&y1=6|y1=7;

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Mirth_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]

!!SN:W^Mirth_Attacking_Stack^/y4;

!!BMy1:I?y2;                            [Side index as for heroes (0:left, 1:right)]
!!SN:W^Mirth_Cast%Y2^/?y3;              [Check if Spell was actually cast by Hero]
!!FU&y3<>1:E;

!!BMy1:G49/?y13/?y14;                   [check for Mirth Duration]
!!FU&y13=0:E;                           [Exit if no Mirth]

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!SN:W^H3_Water Magic_0_Hero%Y99^/?y33; [Water Magic Bonus handling]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d S24/?y87; [Checke current hero Sorcery und Magien hat]
*!VRy85&y85><0/v7198=1:+4;
!!FU|y83<3/y33<>1:E;                    [Exit if less than Master Water Magic]

!!SN:W^Mirth_Current_battle_round^/?y3;
!!SN:W^Mirth_Stack_had_Moral^/?y51;

!!if&y3=v997/y1=y51;
!!SN:W^H3_Water Magic_1_Hero%Y99^/?y87; [Water Magic Bonus handling]
!!VRy22::2 +100;                        [+1% damage per 2SP]
!!VRy22&y87>0:+10;                      [+10% extra damage with GM Water]
!!MF:F?y6;
!!VRy7:Sy6 *y22:100;
!!MF:Fy7;
!!VRy8:Sy7 -y6;

!!SN:T^AC_Misc.Mirth Damage^/?z-1/^damage^/y8;
!!MM:Sz-1;
!!SN:W^Mirth_Current_battle_round^/-1;
!!SN:W^Mirth_Stack_had_Moral^/-1;
!!en;
!!en;
!!en;

!?BG0&1000/-936;

!!BG:N?y1;                              [attacking stack]
!!BMy1:I?y2;                            [Side index as for heroes (0:left, 1:right)]
!!BG:Q?y40;

!!if&y2=y40;                            [so it only works for attacking not defending]
!!BMy1:G49/?y13/?y14;                   [check for Mirth Duration]
!!FU&y13=0:E;                           [Exit if no Mirth]

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!SN:W^H3_Water Magic_0_Hero%Y99^/?y33; [Water Magic Bonus handling]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85; [Checke current hero Sorcery und Magien hat]
!!FU|y83<3/y33<>1:E;                    [Exit if less than Master Water magic]

!!BMy1:F?i;                             [read flags]
!!VRi:&16777216;                        [just look at moral bit]
!!SN&i>0:W^Mirth_Stack_had_Moral^/y1;   [Save stack number]
!!SN&i>0:W^Mirth_Current_battle_round^/v997; [Save current battle round]
!!en;

*-------------------------------Fire Shield------------------------------------*
*chance to summon fire element when hit with melee attack; chance is 10/20% + Spell Power/2%
!?MF1&-936;

!!MF:W?y80;
!!FU&y80>0:E;

; Exit if not Strike all around or normal melee attack
!!UN:C42149568/(UNC_INT)/?y30;
!!FU&y30<>4456676/y30<>4462398:E;

!!VRy1:Si^acm_defendStack^;             [Get the attacked stack from saved variable]
!!SN:W^ACM_Fire_Shield_Target_%Y1^/?y3; [Check if Spell was actually cast by Hero] - Archer30: Fire_Shield_Cast is deprecated
!!FU&y3<>1:E;

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]

; Exit if there can be no more stack for the side
!!FU(ACM_CheckIfPossibleToCreateMoreStacks):Py5/?y31;
!!FU&y31<>(TRUE):E;

!!BMy1:G29/?y13/?y14;                   [check for Fire_Shield Duration]
!!FU&y13<=0:E;                          [Exit if no Fire_Shield]

!!BA:Hy5/?y99;
!!SN:W^H3_Fire Magic_0_Hero%Y99^/?y11;  [Fire Magic Bonus handling]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d S24/?y87; [Checke ob der Held Sorcery und Fire Magien hat und Sp]
*!VRy85&y85><0/v7198=1:+4;
!!FU|y81<3/y11<>1:E;

!!BMy1:T?y66;                           [Archer30: It doesn't seem necessary to prevent summoning Fire Elementals from attacking Fire Elementals]
!!FU&y66=114:E;

!!SN:W^H3_Fire Magic_1_Hero%Y99^/?y87;  [Fire Magic Bonus handling]
!!VRy20:S0R99;
!!VRy23:Sy22:2 +10;                     [+10% + 1% per 2SP]
!!VRy23&y87>0:+10;                      [+10% with GM]
!!VRy23&y23>=50/y87=0:S50;              [Cap at 50%, 65% with GM @Alf]
!!VRy23&y23>=65/y87=1:S65;
*!FU&y20>=y23:E;                        [chance is dependant on Spell Power +20%]

; Archer30: Ideally, we should also check if the targeted position has siege wall on it

!!BMy1:P?y1;

!!VRy6:S0;
!!FU(AC_Function_126):Py1/y6/?y3;
!!BU&y3>=0/y3<=186:Ey3/?y8;             [-2 if there is alive stack at that position]
!!BU&y3>=0/y3<=186:Oy3/?y9;

!!if|y8<>-1/y9<>0;
  !!VRy6:S1;
  !!FU(AC_Function_126):Py1/y6/?y3;
  !!BU&y3>=0/y3<=186:Ey3/?y8;             [-2 if there is alive stack at that position]
  !!BU&y3>=0/y3<=186:Oy3/?y9;
!!en;

!!if|y8<>-1/y9<>0;
  !!VRy6:S2;
  !!FU(AC_Function_126):Py1/y6/?y3;
  !!BU&y3>=0/y3<=186:Ey3/?y8;             [-2 if there is alive stack at that position]
  !!BU&y3>=0/y3<=186:Oy3/?y9;
!!en;

!!if|y8<>-1/y9<>0;
  !!VRy6:S3;
  !!FU(AC_Function_126):Py1/y6/?y3;
  !!BU&y3>=0/y3<=186:Ey3/?y8;             [-2 if there is alive stack at that position]
  !!BU&y3>=0/y3<=186:Oy3/?y9;
!!en;

!!if|y8<>-1/y9<>0;
  !!VRy6:S4;
  !!FU(AC_Function_126):Py1/y6/?y3;
  !!BU&y3>=0/y3<=186:Ey3/?y8;             [-2 if there is alive stack at that position]
  !!BU&y3>=0/y3<=186:Oy3/?y9;
!!en;

!!if|y8<>-1/y9<>0;
  !!VRy6:S5;
  !!FU(AC_Function_126):Py1/y6/?y3;
  !!BU&y3>=0/y3<=186:Ey3/?y8;             [-2 if there is alive stack at that position]
  !!BU&y3>=0/y3<=186:Oy3/?y9;
!!en;

!!if&y8=-1/y9=0/y3>=0/y3<=186;
  !!BU:S114/y22/y3/y5/-1/1;               [Summon Element]

  !!SN&i^battle_isVisible^:P^SUMNELM^;
!!en;


; Check if there are 20 stacks already on one side of the battlefield
; by Archer30
!?FU(ACM_CheckIfPossibleToCreateMoreStacks);
!#VA(side:x) (result:x);
!#VA(pendingStacks:x);                  [Optional. Number of Stacks that has not yet been in the battlefield but should be considered]

!!FU:A?(numArgs:y);
!!VR(pendingStacks)&(numArgs)<3:S0;

!!VR(result):S(FALSE);
!!UN:C(COMBAT_MANAGER)/(UNC_INT)/?(combatManager:y);
!!VR(offset:y):S(side) *(UNC_INT) +21692;
!!UN:C(combatManager)/(offset)/4/?(stackQty:y);

!!VR(stackQty):+(pendingStacks);

!!VR(result)&(stackQty)<20:S(TRUE);

*-------------------------------Slayer-------------------------------------*
*Chance for Crushing Blow! Will Reduce Att/Def or Speed if successful hit of lvl 7 and 8
!?MF1&1000/-936;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]

!!MF:W?y80;
!!FU&y80>0:E;
!!BG:A?y1;                              [Aktion in y1]
!!if|y1=6/y1=7;
!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Slayer_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]

!!SN:W^Slayer_Attacking_Stack^/y4;

!!BMy1:I?y2;                            [Side index as for heroes (0:left, 1:right)]
!!SN:W^Slayer_Cast%Y2^/?y3;             [Check if Spell was actually cast by Hero]
!!FU&y3<>1:E;

!!BMy1:G55/?y13/?y14;                   [check for Slayer Duration]
!!FU&y13=0:E;

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!SN:W^H3_Fire Magic_0_Hero%Y99^/?y11;  [Fire Magic Bonus handling]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d S24/?y87; [Checke ob der Held Sorcery und Fire Magien hat und Sp]
*!VRy85&y85><0/v7198=1:+4;
!!FU|y81<3/y11<>1:E;

!!SN:W^H3_Fire Magic_1_Hero%Y99^/?y87;  [Fire Magic Bonus handling]
!!VRy10:S0R99;
!!VRy11:Sy22 :2 +20;                    [Chance for Crushing Blow is SP/2 + 20%]
!!VRy11&y87>0:+10;                      [+10% chance with GM Fire]
!!if&y10<y11;

!!MF:N?y6;                              [Damage recieving stack]
!!if&y6>=0/y6<=41;
!!BMy6:T?y7;
!!MA:Ly7/?y8;
!!FU&y8<6:E;                            [Exit if no lvl 7 or higher]

!!BMy6&i^battle_isVisible^:V14;

!!VRy30:S0R6;
!!BMy6|y30=0/y30=3/y30=4/y30=6:Ad-5;    [Attack -5]
!!BMy6|y30=1/y30=3/y30=5/y30=6:Dd-5;    [Defense -5]
!!BMy6|y30=2/y30=4/y30=5/y30=6:Sd-3;    [Speed -3]

!!BMy6:A?y20; !!VRy20&y20<=1:S1; !!BMy6:Ay20;
!!BMy6:D?y21; !!VRy21&y21<=1:S1; !!BMy6:Dy21;
!!BMy6:S?y22; !!VRy22&y22<=1:S2; !!BMy6:Sy22;

!!BA:Q?f;
!!VRz-1&1000:S^DWRFDFND^;
!!SN&i^battle_isVisible^:Pz-1;
!!en;

!!en;
!!en;
!!en;

*-------------------------------Magic Mirror --------------------------------------*
!?BG0&1000/-936;                        [run forest]

!!SN&v9280=0:W^Magic_Mirror_Cast1^/?y1; [If Defender Casts Spell Check if Attacker has casted Magic Mirror in that Battle]
!!SN&v9280=1:W^Magic_Mirror_Cast0^/?y1;
!!FU&y1<>1:E;

!!BG:A?y1;
!!FU&y1<>1:E;

!!BG:S?y2;                              [y2 now contains spell number]
!!FU&y2<=9|y2>69:E;

!!if|y2=42/y2=45/y2=50/y2=52/y2=54/y2=59/y2=61;

!!if&v9280=0;
!!SN:W^H3_Air Magic_0_Hero%V9282^/?y12; [Air Magic Bonus handling]
!!HEv9282:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d; [Checke current hero Sorcery und Magien hat]
*!VRy85&y85><0/v7198=1:+4;
!!DO(AC_Function_102)/21/41/1&y82=3/y12=1:P; [No more Sorcery requirement! @Alf  [Count creatures that have magic mirror applied]
!!SN:W^Magic_Mirror_Counter^/?y10;
!!if&y10>0;
!!DO(AC_Function_103)/0/20/1:Py10/y22/y2/1;
!!SN:W^Magic_Mirror_Counter^/0;
!!en;
!!en;

!!if&v9280=1;
!!SN:W^H3_Air Magic_0_Hero%V9281^/?y12; [Air Magic Bonus handling]
!!HEv9281:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d; [Checke current hero Sorcery und Magien hat]
*!VRy85&y85><0/v7198=1:+4;
!!DO(AC_Function_102)/0/20/1&y82=3/y12=1:P; [No more Sorcery requirement! @Alf]
!!SN:W^Magic_Mirror_Counter^/?y10;
!!if&y10>0;
!!DO(AC_Function_103)/21/41/1:Py10/y22/y2/2;
!!SN:W^Magic_Mirror_Counter^/0;
!!en;
!!en;
!!en;


*-------------------------------Air Shield --------------------------------------*
*Small chance to completly dodge the ranged Attack
!?MF1&1000/-936;

!!UN:C42149568/4/?y10;                  [Physical Damage]
!!FU&y10<>4455011:E;                    [Shooting Damage]

!!BG:A?y1;
!!FU&y1<>7:E;
!!MF:W?y80;
!!FU&y80>0:E;
!!MF:N?y4;                              [damage receiving stack]
!!BMy4:G28/?y13/?y14;                   [check for Air Shield]
!!FU&y13=0:E;
!!BMy4:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!SN:W^Air_Shield_Cast%Y5^/?y3;         [Check if Spell was actually cast by Hero]
!!FU&y3<>1:E;
!!BA:Hy5/?y99;
!!SN:W^H3_Air Magic_0_Hero%Y99^/?y12;   [Air Magic Bonus handling]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d S24/?y87; [Checke ob der Held Sorcery und Air Magien hat und Sp]
!!FU|y82<3/y12<>1:E;
!!SN:W^H3_Air Magic_1_Hero%Y99^/?y87;   [Air Magic Bonus handling]
!!VRy20:S0R99;
!!VRy22::10 +5;                         [+SP/10% +5% chance to dodge]
!!VRy22&y87>0:+3;                       [+3% chance with GM Air]
!!if&y20<=y22;                          [chance is ]
  !!VRz-1:S^AIRSHELD^;
  !!SN&i^battle_isVisible^:Pz-1;
  !!MF:E0;                              [set damage to zero]
  !!MF:F0;                              [set damage to zero]
  !!SN:T^AC_Misc.Air Dodge^/?z-1;
  !!BU&i^battle_isVisible^:Mz-1;        [show message in log]
!!en;


*******************************offense spells handling**************************
!?BR&1000/v997>0/-936;
!!FU(AC_Function_68):P;                 [Dragon Fire]
!!SN:W^Incinerate^/0;                   [Reset Incinerate Damage]

!?MR1&1000/-936;

!!BG:A?y1;
!!FU&y1<>1:E;

!!BG:H?y1;                              [Determine if AI controlls Hero]
!!HEy1:O?y1;
!!OW:Iy1/?y1;
!!FU&y1=1:E;

!!UN:C6919200/4/?y1;                    [y1 - combatmanager]
!!VRy2:Sy1 +78532;                      [y2 - _ptr_ autoCombat]
!!UN:Cy2/1/?y3;                         [y3 - autoCombat status]
!!FU&y3=1:E;                            [Exit in Auto Combat Status]

!!BG:Q?y1;
!!BA:Hy1/?y99;

!!FU&y99=-2:E;
!!HEy99:S24/?y57 S25/?y58;              [Checke ob der Held Intelligence und Sorcery hat]
*!VRy58&y58<>0/v7198=1:+4;
*!FU&y58=0:E;   No need for Sorcery (@Alf)

!!MR:F?y3;
!!FU&y3<=0:E;

!!BG:S?y9;                              [y9 now contains spell number]
!!FU&y9<=9|y9>69:E;

!!SN:W^H3_Fire Magic_1_Hero%Y99^/?y57;  [Fire Magic Bonus handling]
!!VRy80&y9=21|y9=22:Sy3;                [Speichere Damage for Feuerschaden]
!!VRy80&y57=0/y9=21::3;
!!VRy80&y57=0/y9=22::3;                 [incinerate value 1/3 fire damage]
!!VRy80&y57=1/y9=21::2;
!!VRy80&y57=1/y9=22::2;                 [incinerate value 1/2 fire damage with GM Fire]
!!SN&y9=21|y9=22:W^Incinerate^/y80;


!!SN:W^H3_Fire Magic_0_Hero%Y99^/?y11;  [Fire Magic Bonus handling]
!!SN:W^H3_Air Magic_0_Hero%Y99^/?y12;   [Air Magic Bonus handling]
!!SN:W^H3_Water Magic_0_Hero%Y99^/?y13; [Water Magic Bonus handling]
!!SN:W^H3_Earth Magic_0_Hero%Y99^/?y14; [Earth Magic Bonus handling]
!!HEy99:S14/?y51 S15/?y52 S16/?y53 S17/?y54 S18/?y55 S24/?y56 S25/?y58; [Checke ob der Held Scholar und Magien, 24 Intelligence 25 Sorcery]
*!VRy58&y58><0/v7198=1:+4;

!!MR:N?y1;

!!if&y1>=0/y1<=41;

**effect of ice spells
!!if&y9=16|y9=20;                      [Ice Bolt and Frost Ring]
!!if&y53=3/y13=1;
!!SN:W^H3_Water Magic_1_Hero%Y99^/?y56; [Earth Magic Bonus handling]
!!SN:T^AC_Misc.Ice Spells^/?z1;
!!BU&i^battle_isVisible^:Mz1;
!!BMy1:S?y10;                           [Save Current Speed in y10]
!!VRy10:-1;                             [speed decrease value =-1]
!!VRy10&y56=1:-1;                       [with GM Water value =-2]
!!VRy10&y10<=2:S2;                      [Cannot be slower than 2]
!!BMy1:Sy10;
!!en;
!!en;

**effect of earth spells
!!if&y9=18|y9=23;                      [Meteor Shower and Implosion]
!!if&y54=3/y14=1;
!!SN:W^H3_Earth Magic_1_Hero%Y99^/?y56; [Earth Magic Bonus handling]
!!SN:T^AC_Misc.Earth Spells^/?z1;
!!BU&i^battle_isVisible^:Mz1;
!!BMy1:D?y20;                           [Save Current Defence in y20]
!!VRy20:-2;                             [defence reduce value =-2]
!!VRy20&y56=1:-2;                       [with GM Earth value =-4]
!!VRy20&y20<=0:S0;
!!BMy1:Dy20;
!!en;
!!en;

**effect of fire spells
!!if&y9=21|y9=22;                      [Fireball and Inferno]
!!if&y51=3/y11=1;
!!SN:T^AC_Misc.Fire Spells^/?z1;
!!BU&i^battle_isVisible^:Mz1;
!!BMy1:M21/1/3;                         [apply incinerate to stack]
!!BMy1&y1=0:M21/2/3;                    [fix?]
!!en;
!!en;

**effect of electric spells
!!if|y9=17/y9=19/y9=57;                [Lightning Bolt and Chain Lightning or Titans Lightning Bolt]
!!if&y52=3/y12=1;
!!SN:T^AC_Misc.Lightning Spells^/?z1;
!!BU&i^battle_isVisible^:Mz1;
!!BMy1:M19/2/3;                         [apply electric shock to stack]
!!en;
!!en;

!!en;


!?FU(AC_Function_68);
; Create an array to store the stack ids of burned stacks
!!FU(NewIntArray):P?(affectedStacksList:y);

!!re i/(BATTLE_STACK_FIRST)/(BATTLE_STACK_LAST);
  ; Check if it is a valid stack
  !!BMi:T?(type:y) N?(num:y);

  !!if&(type)>(NO_MON)/(num)>0/(type)<>(MON_ARROW_TOWERS);
    ; Check if it is burned
    !!BMi:G(SPELL_FIREBALL)/?(duration:y)/?(level:y);

    ; Add them to the array if burned
    !!FU(Array_Push)&(duration)>0:P(affectedStacksList)/i;
  !!en;
!!en;

; Exit if there is no stack affected by Dragon Fire
!!SN:M(affectedStacksList)/?(size:y);
!!FU&(size)<=0:E;

; Damage them
!!VR(incinerate:y):Si^Incinerate^;

!!re i/0/(size)/1/-1;
  !!SN:M(affectedStacksList)/i/?(targetStack:y);
  !!VR(damage:y):S(incinerate) +i^Burned_Stack_%(targetStack)^;

  !!BM(targetStack):K(damage);

  ; Check if it is required to remove the body (if it was killed completely)
  !!BM(targetStack):N?(targetNum:y);
  !!BM(targetStack)&(targetNum)<=0:Fd|813694976 K1;  [set new modified bit]

  ; Log
  !!if&i^battle_isVisible^;
    !!SN:T^AC_Misc.Burn Damage^/?(battleLog:z)/^damage^/(damage);
    !!MM:S(battleLog);
  !!en;
!!en;

; Play animation on multiple stacks
!!if&i^battle_isVisible^;
  !!SN:P^Fireblst^;
  !!FU(ACM_PlayAnimationOnMultipleStacks):P(affectedStacksList)/8/(TRUE);
!!en;

!!FU(ACM_DrawActionPlay):P;


// Play a SPELL animation on multiple stacks at the same time (@feanor and Archer30)
!?FU(ACM_PlayAnimationOnMultipleStacks);
!#VA(stacksList:x);                     [Array of Stack numbers for animation]
!#VA(animation:x);                      [Index of the animation (BM:V)]
!#VA(playDamagedAnimation:x);           [Optional. Boolean. Whether to play the damaged animation]

!!FU:A?(numArgs:y);
!!VR(playDamagedAnimation)&(numArgs)<3:S(FALSE);

; Initialise array and variables
!!FU(NewIntArray):P10/?(stacksForAnimationList:y);
!!SN:M(stacksList)/?(size:y);
!!VR(bits[4]:y):C(BIT_0)/(BIT_8)/(BIT_16)/(BIT_24);

; Loop through the array containing stack numbers and set up the array for animation
!!re i/0/(size)/1/-1;
  !!SN:M(stacksList)/i/?(stack:y);
  ; Skip animation for the last stack of each side
  !!co|(stack)=(BATTLE_ATTACKER_STACK_LAST)/(stack)=(BATTLE_DEFENDER_STACK_LAST);

  ; Fix defender stack number
  !!VR(stack)&(stack)>(BATTLE_ATTACKER_STACK_LAST):-1;

  ; Set up the array for animation
  !!VR(slotIndex:y):S(stack) :4;
  !!VR(bitIndex:y):S(stack) %4;

  *!SN:M(stacksForAnimationList)/(slotIndex)/d|(bits[bitIndex]); [This syntax doesn't work]
  !!SN:M(stacksForAnimationList)/(slotIndex)/?(value:y);
  !!VR(value):|(bits[bitIndex]);
  !!SN:M(stacksForAnimationList)/(slotIndex)/(value);
!!en;

; Get the address of the array
!!SN:M(stacksForAnimationList)/?(arrayAddress:y)/0;

!!UN:C(COMBAT_MANAGER)/(UNC_INT)/?(cmbMgr:y);
; first parameter - combatmanager
; the second parameter is a pointer to an array of forty bytes: one per unit
; third parameter - animation number
; fourth parameter - whether to animate the damage (0 - not necessary, 1 - necessary)
!!SN:E5925584/2/(cmbMgr)/(arrayAddress)/(animation)/(playDamagedAnimation);     [play animation]

*--------------------------------------------------------------------Give Bonus---------------------------------------------------------------------------------*

!?FU(AC_Function_105);                  [Function to give Bonus in first round]

!!HEv9283:Fd/d/?y1/d S24/?y87;          [Save Spellpower aka aka Duration]
!!HEv9283:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14; [check for spell duration changing artifacts]
!!VRy1&y15=1:+1;                        [76 Collar of Conjuring]
!!VRy1&y16=1:+2;                        [77 Ring of Conjuring]
!!VRy1&y17=1:+3;                        [78 Cape of Conjuring]
!!VRy1&y18=1:+56;                       [139 Ring of the Magi]
!!SN:W^Spell_Duration_Mod^/?y95;
!!SN&y95=1:W^Duration_Mod_Changed^/?y21;
!!FU(Calc_Spell_Duration)&y21=1/y95=1:Pv9283/-1/?y1;
*-------------------------------stoneskin--------------------------------------*
!!if&v9290=100;
!!BMx16:G46/?y10/?y11;                  [check for stoneskin]
!!BMx16:D?y12;                          [speichere Defense]
!!if&y1=y10;                           [if duration from stoneskin is spellpower spell was cast this round]
!!SN:W^Scaling_Magic_Spell_Number_^/?y21;
!!SS46&y21=46:E3/?y22;
!!FU(ApplyRemoveSpellScaling)&y21<>46:Pv9283/46/1/d/?y22;
*!VRy12:+y22;                                                                   double defense in first round @alf
!!VRy12:+5;                             [double defense in first round @alf]
!!BMx16:Dy12;                           [set increased defense for creature]
!!VRv9390:S10;
!!en;
!!en;
*-------------------------------blessing---------------------------------------*
!!if&v9290=1010; Disabeld
!!BMx16:G41/?y20/?y11;                  [check for blessing]
!!BMx16:U2/?y22;                        [speichere max Damage]
.!!if&y1=y20;                          [if duration from blessing is spellpower spell was cast this round]
!!VRy22:+2;                             [+ 2 damage in first round]
!!BMx16:U2/y22;                         [set increased damage for creature]
!!VRv9391:S10;
.!!en;
!!en;
*-------------------------------bloodlust -------------------------------------*
!!if&v9290=102;
!!BMx16:G43/?y30/?y11;                  [check for bloodlust]
!!BMx16:A?y32;                          [speichere attack]
.!!if&y1=y30;                          [if duration from bloodlust is spellpower spell was cast this round]
!!SN:W^Scaling_Magic_Spell_Number_^/?y21;
!!SS43&y21=43:E3/?y22;
!!FU(ApplyRemoveSpellScaling)&y21<>43:Pv9283/43/1/d/?y22;
!!VRy32:+y22;                           [double attack in first round @alf]
!!BMx16:Ay32;                           [set increased attack for creature]
!!VRv9392:S10;
.!!en;
!!en;
*-------------------------------precision -------------------------------------*
!!if&v9290=1030; disabled
!!BMx16:G44/?y40/?y11;                  [check for precision]
*!BMx16:A?y42;                                                                  [speichere attack]
.!!if&y1=y40;                          [if duration from precision is spellpower spell was cast this round]
*!VRy42:+5;                                                                     [+ 5 attack in first round]
*!BMx16:Ay42;                                                                   [set increased attack for creature]
!!FU(AC_Function_114):Px16;
!!VRv9393:S10;
.!!en;
!!en;
*-------------------------------haste -----------------------------------------*
!!if&v9290=104;
!!BMx16:G53/?y50/?y11;                  [check for haste]
!!BMx16:G54/?y54/?y11;                  [check for slow if haste was cast]
!!BMx16:S?y52;                          [speichere speed]
!!BMx16:I?y53;                          [Side index as for heroes (0:left, 1:right)]

!!if&x16<21;
!!HEv9282:Fd/d/?y2/d;                   [Save Spellpower aka aka Duration for defender]
!!HEv9282:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14; [check for spell duration changing artifacts]
!!VRy2&y15=1:+1;                        [76 Collar of Conjuring]
!!VRy2&y16=1:+2;                        [77 Ring of Conjuring]
!!VRy2&y17=1:+3;                        [78 Cape of Conjuring]
!!VRy2&y18=1:+56;                       [139 Ring of the Magi]
!!en;

!!if&x16>20;
!!HEv9281:Fd/d/?y2/d;                   [Save Spellpower aka aka Duration for attacker]
!!HEv9281:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14; [check for spell duration changing artifacts]
!!VRy2&y15=1:+1;                        [76 Collar of Conjuring]
!!VRy2&y16=1:+2;                        [77 Ring of Conjuring]
!!VRy2&y17=1:+3;                        [78 Cape of Conjuring]
!!VRy2&y18=1:+56;                       [139 Ring of the Magi]
!!en;

.!!if&y2=y54/v9280=y53;
*!IF:M^Haste1 F:33698^;
!!VRy52:+1;                             [fix for frohes haste casten]
!!BMx16:Sy52;                           [set increased speed for creature]
!!VRv9394:S10;
.!!en;

.!!if&y1=y50;                          [if duration from haste is spellpower spell was cast this round]
*!IF:M^Haste2 F:33698^;
!!VRy52:+1;                             [+ 1 speed in first round]
!!BMx16:Sy52;                           [set increased speed for creature]
!!VRv9394:S10;
.!!en;
!!en;
*-------------------------------slow -----------------------------------------*
!!if&v9290=105;
!!BMx16:G54/?y60/?y11;                  [check for slow]
!!BMx16:G53/?y64/?y11;                  [check for haste]
!!BMx16:S?y62;                          [speichere speed]

!!if&x16<21;
!!HEv9281:Fd/d/?y2/d;                   [Save Spellpower aka aka Duration for defender]
!!HEv9281:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14; [check for spell duration changing artifacts]
!!VRy2&y15=1:+1;                        [76 Collar of Conjuring]
!!VRy2&y16=1:+2;                        [77 Ring of Conjuring]
!!VRy2&y17=1:+3;                        [78 Cape of Conjuring]
!!VRy2&y18=1:+56;                       [139 Ring of the Magi]
!!en;

!!if&x16>20;
!!HEv9282:Fd/d/?y2/d;                   [Save Spellpower aka aka Duration for attacker]
!!HEv9282:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14; [check for spell duration changing artifacts]
!!VRy2&y15=1:+1;                        [76 Collar of Conjuring]
!!VRy2&y16=1:+2;                        [77 Ring of Conjuring]
!!VRy2&y17=1:+3;                        [78 Cape of Conjuring]
!!VRy2&y18=1:+56;                       [139 Ring of the Magi]
!!en;

.!!if&y2=y64;
*!IF:M^1Slow F:33698^;
*!IF:M^Laufvariable %X16 Spellpower %Y2 Haste Dauer %Y64 Speed und Slow %Y60 von Creature %Y62 Y1 is%Y1 ^;
!!VRy62:-1;                             [fix for frohes slow casten]
!!BMx16:Sy62;                           [set decreased speed for creature]
!!VRv9395:S10;
.!!en;

.!!if&y1=y60;                          [if duration from slow is spellpower spell was cast this round]
*!IF:M^2Slow F:33698^;
*!IF:M^Laufvariable %X16 Spellpower %Y2 Haste Dauer %Y64 Speed und Slow %Y60 von Creature %Y62 Y1 is%Y1 ^;
!!VRy62:-1;                             [- 1 speed in first round]
*!IF:M^Laufvariable %X16 Spellpower %Y2 Haste Dauer %Y64 Speed und Slow %Y60 von Creature %Y62 Y1 is%Y1 ^;
!!BMx16&y62>0:Sy62;                     [set reduced speed for creature]
!!VRv9395:S10;
.!!en;
!!en;
*-------------------------------heal ------------------------------------------*
!!if&v9290=106;
!!BMx16:H?y72;                          [speichere hit points]
!!VRy72:+10;                            [+10 hit points]
!!BMx16:Hy72;
!!VRv9396:S10;                          [set increased HP]
!!en;
*-------------------------------shield ----------------------------------------*
!!if&v9290=107;
!!BMx16:G27/?y80/?y11;                  [check for shield]
.!!if&y1=y80;
!!FU(AC_Function_114):Px16;
!!VRv9397:S10;
.!!en;
!!en;
*-------------------------------air shield ------------------------------------*
!!if&v9290=108;
!!BMx16:G28/?y90/?y11;                  [check for air shield]
.!!if&y1=y90;
!!FU(AC_Function_114):Px16;
!!VRv9398:S10;
.!!en;
!!en;
*-------------------------------magic mirror-----------------------------------*
!!if&v9290=109;
!!BMx16:G36/?y93/?y11;                  [check for magic mirror]
.!!if&y1=y93;
*!FU(AC_Function_114):Px16;   Disabled and Replaced
!!VRv9399:S10;
.!!en;
!!en;
*-------------------------------counterspell-----------------------------------*
!!if&v9290=11000; Disabled
!!BMx16:G34/?y94/?y11;                  [check for counterspell]
.!!if&y1=y94;
!!FU(AC_Function_114):Px16;
!!VRv9400:S10;
.!!en;
!!en;
*--------------------------------mirth-----------------------------------------*
!!if&v9290=111;
*!BMx16:G49/?y95/?y11;                                                          [check for mirth]
.!!if&y1=y95;
*!FU(AC_Function_114):Px16;
*!VRv9401:S10;
.!!en;
!!en;
*--------------------------------luck------------------------------------------*
!!if&v9290=112;
!!BMx16:G51/?y96/?y11;                  [check for luck]
.!!if&y1=y96;
!!FU(AC_Function_114):Px16;
!!VRv9402:S10;
.!!en;
!!en;
*--------------------------------counterstrike---------------------------------*
!!if&v9290=1130; Disabled
!!BMx16:G58/?y97/?y11;                  [check for counterstrike]
.!!if&y1=y97;
!!FU(AC_Function_114):Px16;
!!VRv9403:S10;
.!!en;
!!en;
*--------------------------------slayer----------------------------------------*
!!if&v9290=114;
!!BMx16:G55/?y98/?y11;                  [check for slayer]
.!!if&y1=y98;
!!FU(AC_Function_114):Px16;
!!VRv9404:S10;
.!!en;
!!en;
*--------------------------------fire shield-----------------------------------*
!!if&v9290=115;
*!BMx16:G29/?y99/?y11;                                                          [check for fire shield]
.!!if&y1=y99;
*!FU(AC_Function_114):Px16;
*!VRv9405:S10;
.!!en;
!!en;
*--------------------------------frenzy----------------------------------------*
!!if&v9290=1160; Disabled
!!BMx16:G56/?y81/?y11;                  [check for frenzy]
.!!if|y81=1/y81=2;
!!FU(AC_Function_114):Px16;
!!VRv9406:S10;
.!!en;
!!en;
*--------------------------------prot fire-------------------------------------*
!!if&v9290=117;
!!BMx16:G31/?y82/?y11;                  [check for prot. fire]
.!!if&y1=y82;
!!FU(AC_Function_114):Px16;
!!VRv9407:S10;
.!!en;
!!en;
*--------------------------------prot water-------------------------------------*
!!if&v9290=118;
!!BMx16:G32/?y83/?y11;                  [check for prot. water]
.!!if&y1=y83;
!!FU(AC_Function_114):Px16;
!!VRv9408:S10;
.!!en;
!!en;
*--------------------------------prot earth-------------------------------------*
!!if&v9290=119;
!!BMx16:G33/?y84/?y11;                  [check for prot. earth]
.!!if&y1=y84;
!!FU(AC_Function_114):Px16;
!!VRv9409:S10;
.!!en;
!!en;
*--------------------------------prot air-------------------------------------*
!!if&v9290=120;
!!BMx16:G30/?y85/?y11;                  [check for prot. air]
.!!if&y1=y85;
!!FU(AC_Function_114):Px16;
!!VRv9410:S10;
.!!en;
!!en;
*--------------------------------clone spell ----------------------------------*
!!if&v9290=125;
!!BMx16:F?y78;                          [read flags]
!!VRy78:&8388608;                       [just look clone bit]
!!BMx16&y78>0:N?y59;                    [current number]
!!SN:W^H3_Water Magic_1_Hero%V9283^/?y87;[Water Magic Bonus handling]
!!VRy59&y78>0/y59>0/y87=0:*125 +99 :100;[grow 25%], rounded up @Alf]
!!VRy59&y78>0/y59>0/y87=1:*135 +99 :100;[grow 35%   with GM], rounded up @Alf]
!!BMx16&y78>0/y59>0:Ny59;               [Set current number]
!!en;
*--------------------------------luck------------------------------------------*
!!if&v9290=126;
!!BMx16:G51/?y96/?y11;                                                          [check for luck 2]
.!!if&y1=y96;
*!FU(AC_Function_114):Px16;
!!VRv9412:S10;
.!!en;
!!en;
*-------------------------------shield 2 --------------------------------------*
!!if&v9290=135;
!!BMx16:H?y73;                                                                  [speichere hit points]
!!VRy18:Sy1 *10 +100;                                                           [calculate shield value]
!!VRy73:+y18;
*!BMx16:Hy73;                                                                   [set shield]
!!VRv9413:S10;
!!en;
*--------------------------------death ripple ---------------------------------*
!!if&v9290=139;
!!BMx16:F?y78;                                                                  [read flags]
!!VRy78:&16;                                                                    [just look alive bit]
!!if&y78>0;
!!BMx16:M50/1/0;                                                                [Apply Basic Sorrow for 1 round]  ** Does NOT Work!
!!en;
!!en;
*--------------------------------destroy undead -------------------------------*
!!if&v9290=140;
!!BMx16:F?y78;                                                                  [read flags]
!!VRy78:&16;                                                                    [just look alive bit]
!!if&y78>0;
!!BMx16:M49/1/0;                                                                [Apply Basic SMirth for 1 round]
!!en;
!!en;
*-------------------------------sacrifice -------------------------------------*
!!if&v9290=143;
!!BMx16:F?y78;                                                                  [read flags]
!!VRy78:&268435456;                                                             [just look alive bit]
!!if&y78>0;
!!BMx16:B?y79;
!!BMx16:T?y80;
!!BMx16:P?y81;
!!BU:Sy80/1/y81/0/-1/1;                                                         [Summon martyr]

!!BU:Ey81/?y82;

!!BMy82:H?y83;
!!BMy82:U2/?y85;
!!VRy86:Sy85*y79;                                                               [calculate damage]
!!VRy84:Sy83*y79 :3;                                                            [calculate HP/3]
!!BMy82:Hy84;
!!BMy82:U2/y86;
!!BMy82:M40/10/3;
*!BMy82:M47/3/3;                                                                Disrupting Ray
!!BMy82:M53/3/3;
!!SN:W^sacrifice_var^/1;                                                        [Improved version can only be cast once per combat]
!!en;
!!en;

*--------------------------------------------------------------------Take Bonus---------------------------------------------------------------------------------*

!?FU(AC_Function_106);                  [Fix function for wrong duration from first creature and take away bonus after one round]

*!IF:M^Begin der neuen Runde^;
!!if&x16<21;
!!HEv9281:Fd/d/?y1/d S24/?y86;          [Save Spellpower aka aka Duration for attacker and Intelligence]
!!VRy49:Sy1:2;                          [Set to half SP for summon growth]
!!HEv9281:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14; [check for spell duration changing artifacts]
!!VRy1&y15=1:+1;                        [76 Collar of Conjuring]
!!VRy1&y16=1:+2;                        [77 Ring of Conjuring]
!!VRy1&y17=1:+3;                        [78 Cape of Conjuring]
!!VRy1&y18=1:+56;                       [139 Ring of the Magi]
!!VRy23:Sv9281;
!!en;

!!if&x16>20;
!!HEv9282:Fd/d/?y1/d S24/?y86;          [Save Spellpower aka aka Duration for defender and Intelligence]
!!VRy49:Sy1:2;                          [Set to half SP for summon growth]
!!HEv9282:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14; [check for spell duration changing artifacts]
!!VRy1&y15=1:+1;                        [76 Collar of Conjuring]
!!VRy1&y16=1:+2;                        [77 Ring of Conjuring]
!!VRy1&y17=1:+3;                        [78 Cape of Conjuring]
!!VRy1&y18=1:+56;                       [139 Ring of the Magi]
!!VRy23:Sv9282;
!!en;
!!SN:W^Spell_Duration_Mod^/?y95;
!!FU(Calc_Spell_Duration)&y95=1:Py23/-1/?y1;

*-------------------------------stoneskin--------------------------------------*
!!if&v9390=10;
!!BMx16:G46/?y10/?y11;                  [check for stoneskin]
!!BMx16:D?y12;                          [speichere Defense]

.!!if&x16>0;                           []
!!VRy10:-1;                             [reduce duration from creature 1 bis 20 um 1]
.!!en;

!!VRy13:Sy1-1;                          [duration -1 says second round]
!!SN:W^DisRayStoneSkinRemoved%X16^/?y24;[check if stoneskin bonus was removes by disrupting ray already @alf]
.!!if&y13=y10/y24=0;
!!SN:W^Scaling_Magic_Spell_Number_^/?y21;
!!SS46&y21=46:E3/?y22;
!!FU(ApplyRemoveSpellScaling)&y21<>46:Py23/46/1/d/?y22;
*!VRy12:-y22;                                                                   [reduce defense]
!!VRy12:-5;                             [reduce defense]
!!BMx16:Dy12;                           [apply original defense]
.!!en;
!!VRv9390&x16=41:S0;
!!en;

*-------------------------------blessing---------------------------------------*
!!if&v9391=1000;                       [Disabled]
!!BMx16:G41/?y20/?y11;                  [check for blessing]
!!BMx16:U2/?y22;                        [speichere max Damage]

.!!if&x16>0;                           [creature bigger than 0]
!!VRy20:-1;                             [reduce duration from creature 1 bis 20 um 1]
.!!en;

!!VRy14:Sy1-1;                          [duration -1 says second round]
.!!if&y14=y20;
!!VRy22:-2;                             [reduce max damage]
!!BMx16:U2/y22;                         [apply original damage]
.!!en;
!!VRv9391&x16=41:S0;
!!en;

*-------------------------------bloodlust -------------------------------------*
!!if&v9392=10;
!!BMx16:G43/?y30/?y11;                  [check for bloodlust]
!!BMx16:A?y32;                          [speichere attack]

.!!if&x16>0;                           [creature bigger than 0]
!!VRy30:-1;                             [reduce duration from creature 1 bis 20 um 1]
.!!en;

!!VRy15:Sy1-1;                          [duration -1 says second round]
.!!if&y15=y30;
!!SN:W^Scaling_Magic_Spell_Number_^/?y21;
!!SS43&y21=43:E3/?y22;
!!FU(ApplyRemoveSpellScaling)&y21<>43:Py23/43/1/d/?y22;
!!VRy32:-y22;                           [increase max attack]
!!BMx16:Ay32;                           [apply original attack]
.!!en;
!!VRv9392&x16=41:S0;
!!en;

*-------------------------------precision -------------------------------------*
!!if&v9393=1000;                       [disabled]
!!BMx16:G44/?y40/?y11;                  [check for precision]
*!BMx16:A?y42;                                                                  [speichere attack]

.!!if&x16>0;                           [creature bigger than 0]
!!VRy40:-1;                             [reduce duration from creature 1 bis 20 um 1]
.!!en;

*!VRy16:Sy1-1;                                                                  [duration -1 says second round]
.!!if&y16=y40;
*!VRy42:-5;                                                                     [increase max attack]
*!BMx16:Ay42;                                                                   [apply original attack]
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9393&x16=41:S0;
!!en;

*-------------------------------haste -----------------------------------------*
!!if&v9394=10;
!!BMx16:G53/?y50/?y11;                  [check for haste]
!!BMx16:S?y52;                          [speichere speed]

.!!if&x16>0;                           [creature bigger than 0]
!!VRy50:-1;                             [reduce duration from creature 1 bis 20 um 1]
.!!en;

!!VRy17:Sy1-1;                          [duration -1 says second round]
.!!if&y17=y50;
*!IF:M^Haste F:33699^;
!!VRy52:-1;                             [increase max speed]
!!BMx16:Sy52;                           [apply original speed]
.!!en;
!!VRv9394&x16=41:S0;
!!en;

*-------------------------------slow -----------------------------------------*
!!if&v9395=10;

!!if&x16<21;
!!HEv9282:Fd/d/?y2/d;                   [Save Spellpower aka aka Duration for defender]
!!HEv9282:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14; [check for spell duration changing artifacts]
!!VRy2&y15=1:+1;                        [76 Collar of Conjuring]
!!VRy2&y16=1:+2;                        [77 Ring of Conjuring]
!!VRy2&y17=1:+3;                        [78 Cape of Conjuring]
!!VRy2&y18=1:+56;                       [139 Ring of the Magi]
!!en;

!!if&x16>20;
!!HEv9281:Fd/d/?y2/d;                   [Save Spellpower aka aka Duration for attacker]
!!HEv9281:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14; [check for spell duration changing artifacts]
!!VRy2&y15=1:+1;                        [76 Collar of Conjuring]
!!VRy2&y16=1:+2;                        [77 Ring of Conjuring]
!!VRy2&y17=1:+3;                        [78 Cape of Conjuring]
!!VRy2&y18=1:+56;                       [139 Ring of the Magi]
!!en;

!!BMx16:G54/?y60/?y11;                  [check for slow]
!!BMx16:S?y62;                          [speichere speed]

!!VRy60&x16=0/y11>0:+1;                 [fix for first creature]
!!VRy18:Sy2;                            [duration -1 says second round]
.!!if&y18=y60;
*!IF:M^%X16 Hallo Slow F:33699. Duration %Y60 ^;
!!VRy62:+1;                             [increase max speed]
!!BMx16:Sy62;                           [apply original speed]
.!!en;
!!VRv9395&x16=41:S0;
!!en;

*-------------------------------heal ------------------------------------------*
!!if&v9396=10;
!!SN:W^Heal_Var1^/?y99;
!!SN:W^Heal_Var2^/?y98;
!!VRx16&y98=11/y99<>11/x16=0:S21;
!!VRx16&y99=11/y98<>11/x16=21:S41;

!!BMx16:H?y72;                          [speichere HP]
!!VRy72:-10;                            [decrease HP]
!!BMx16&y72>0:Hy72;                     [apply original HP for ally creatures]

!!VRv9396&x16=41:S0;
!!en;

*-------------------------------shield -----------------------------------------*
!!if&v9397=10;
!!BMx16:G27/?y80/?y11;                  [check for shield]

.!!if&x16>0;                           [creature bigger than 0]
!!VRy80:-1;                             [reduce duration from creature 1 bis 20 um 1]
.!!en;
!!VRy19:Sy1-1;                          [duration -1 says second round]
.!!if&y19=y80;
!!FU(AC_Function_120):Px16;             [**]
.!!en;
!!VRv9397&x16=41:S0;
!!en;

*-------------------------------air shield ------------------------------------*
!!if&v9398=10;
!!BMx16:G28/?y90/?y11;                  [check for air shield]

.!!if&x16>0;                           [creature bigger than 0]
!!VRy90:-1;                             [reduce duration from creature 1 bis 20 um 1]
.!!en;
!!VRy20:Sy1-1;                          [duration -1 says second round]
.!!if&y20=y90;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9398&x16=41:S0;
!!en;

*-------------------------------magic mirror ----------------------------------*
!!if&v9399=10;
!!BMx16:G36/?y93/?y11;                  [check for magic mirror]

.!!if&x16>0;                           [creature bigger than 0]
!!VRy93:-1;                             [reduce duration from creature 1 bis 20 um 1]
.!!en;
!!VRy21:Sy1-1;                          [duration -1 says second round]
.!!if&y21=y93;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9399&x16=41:S0;
!!en;

*-------------------------------counterspell ----------------------------------*
!!if&v9400=1000; Disabled
!!BMx16:G34/?y94/?y11;                  [check for counterspell]

.!!if&x16>0;                           [creature bigger than 0]
!!VRy94:-1;                             [reduce duration from creature 1 bis 20 um 1]
.!!en;
!!VRy22:Sy1-1;                          [duration -1 says second round]
.!!if&y22=y94;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9400&x16=41:S0;
!!en;

*--------------------------------mirth ----------------------------------------*
!!if&v9401=10;
!!BMx16:G49/?y95/?y11;                  [check for mirth]

.!!if&x16>0;                           [creature bigger than 0]
!!VRy95:-1;                             [reduce duration from creature 1 bis 20 um 1]
.!!en;
!!VRy23:Sy1-1;                          [duration -1 says second round]
.!!if&y23=y95;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9401&x16=41:S0;
!!en;

*--------------------------------luck -----------------------------------------*
!!if&v9402=10;
!!BMx16:G51/?y96/?y11;                  [check for luck]

.!!if&x16>0;                           [creature bigger than 0]
!!VRy96:-1;                             [reduce duration from creature 1 bis 20 um 1]
.!!en;
!!VRy24:Sy1-1;                          [duration -1 says second round]
.!!if&y24=y96;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9402&x16=41:S0;
!!en;

*--------------------------------counterstrike---------------------------------*
!!if&v9403=1000; Disabled
!!BMx16:G58/?y97/?y11;                  [check for counterstrike]

.!!if&x16>0;                           [creature bigger than 0]
!!VRy97:-1;                             [reduce duration from creature 1 bis 20 um 1]
.!!en;
!!VRy25:Sy1-1;                          [duration -1 says second round]
.!!if&y25=y97;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9403&x16=41:S0;
!!en;

*--------------------------------slayer----------------------------------------*
!!if&v9404=10;
!!BMx16:G55/?y98/?y11;                  [check for slayer]

.!!if&x16>0;                           [creature bigger than 0]
!!VRy98:-1;                             [reduce duration from creature 1 bis 20 um 1]
.!!en;
!!VRy26:Sy1-1;                          [duration -1 says second round]
.!!if&y26=y98;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9404&x16=41:S0;
!!en;

*--------------------------------fire shield-----------------------------------*
!!if&v9405=10;
!!BMx16:G29/?y99/?y11;                  [check for fire shield]

.!!if&x16>0;                           [creature bigger than 0]
!!VRy99:-1;                             [reduce duration from creature 1 bis 20 um 1]
.!!en;
!!VRy27:Sy1-1;                          [duration -1 says second round]
.!!if&y27=y99;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9405&x16=41:S0;
!!en;

*--------------------------------frenzy----------------------------------------*
!!if&v9406=1000; Disabled
!!BMx16:G56/?y81/?y11;                  [check for frenzy]
.!!if|y81=1/y81=2;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9406&x16=41:S0;
!!en;
*--------------------------------prot fire-------------------------------------*
!!if&v9407=10;
!!BMx16:G31/?y82/?y11;                  [check for prot fire]

.!!if&x16>0;                           [creature bigger than 0]
!!VRy82:-1;                             [reduce duration from creature 1 bis 20 um 1]
.!!en;
!!VRy28:Sy1-1;
.!!if&y82=y28;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9407&x16=41:S0;
!!en;
*--------------------------------prot water-------------------------------------*
!!if&v9408=10;
!!BMx16:G32/?y83/?y11;                  [check for prot water]

.!!if&x16>0;                           [creature bigger than 0]
!!VRy83:-1;                             [reduce duration from creature 1 bis 20 um 1]
.!!en;
!!VRy29:Sy1-1;
.!!if&y83=y29;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9408&x16=41:S0;
!!en;
*--------------------------------prot earth-------------------------------------*
!!if&v9409=10;
!!BMx16:G33/?y84/?y11;                  [check for prot earth]

.!!if&x16>0;                           [creature bigger than 0]
!!VRy84:-1;                             [reduce duration from creature 1 bis 20 um 1]
.!!en;
!!VRy30:Sy1-1;
.!!if&y84=y30;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9409&x16=41:S0;
!!en;
*--------------------------------prot air-------------------------------------*
!!if&v9410=10;
!!BMx16:G30/?y85/?y11;                  [check for prot air]

.!!if&x16>0;                           [creature bigger than 0]
!!VRy85:-1;                             [reduce duration from creature 1 bis 20 um 1]
.!!en;
!!VRy31:Sy1-1;
.!!if&y85=y31;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9410&x16=41:S0;
!!en;
*--------------------------------Summon Fire Elementals------------------------*
!!if&v9276=1;
!!BMx16:I?y76;                          [Side index as for heroes (0:left, 1:right)]                      ***Add check for Skills***]

!!if&y76=0/v9287=10;
!!BMx16:T?y77;                          [creature number]
!!SN:W^H3_Summon_Fire_1^/?y10;
!!VRy11:Sy10+1;
!!SN:W^H3_Fire Magic_1_Hero%V9281^/?y86;
!!VRy80&y86=0:S114;                     [Set Fire]
!!VRy80&y86=1:S129;                     [Set Energy]
!!if&y77=y80/v997<=y11;
!!BMx16:F?y78;                          [read flags]
!!VRy78:&4194304;                       [just look undead bit]
!!BMx16&y78>0:N?y59;                    [current number]
!!VRy3:Sy49 +110;
!!VRy3&y86>0:+10;                       [+10% If GM Fire]
!!VRy59&y78>0/y59>0:*y3:100;            [grow 10% + SP%]
!!BMx16&y78>0/y59>0:Ny59;               [Set current number]
!!BMx16&y78>0/y59>0:By59;               [Set number at beginning of Battle]
!!en;
!!en;


!!if&y76=1/v9288=10;
!!BMx16:T?y77;                          [creature number]
!!SN:W^H3_Summon_Fire_0^/?y10;
!!VRy11:Sy10+1;
!!SN:W^H3_Fire Magic_1_Hero%V9282^/?y86;
!!VRy80&y86=0:S114;                     [Set Fire]
!!VRy80&y86=1:S129;                     [Set Energy]
!!if&y77=y80/v997<=y11;
!!BMx16:F?y78;                          [read flags]
!!VRy78:&4194304;                       [just look summoned bit]
!!BMx16&y78>0:N?y59;                    [current number]
!!VRy3:Sy49 +110;
!!VRy3&y86>0:+10;                       [+10% If GM Fire]
!!VRy59&y78>0/y59>0:*y3:100;            [grow 10% + SP%]
!!BMx16&y78>0/y59>0:Ny59;               [Set current number]
!!BMx16&y78>0/y59>0:By59;               [Set number at beginning of Battle]
!!en;
!!en;
!!en;
*--------------------------------Summon Earth Elementals-----------------------*
!!if&v9277=1;
!!BMx16:I?y76;                          [Side index as for heroes (0:left, 1:right)]

!!if&y76=0/v9287=10;
!!BMx16:T?y77;                          [creature number]
!!SN:W^H3_Summon_Earth_1^/?y10;
!!VRy11:Sy10+1;
!!SN:W^H3_Earth Magic_1_Hero%V9281^/?y86;
!!VRy80&y86=0:S113;                     [Set Earth  Fix for Grandmaster Magma Elemental Summon]
!!VRy80&y86=1:S125;                     [Set Magma]
!!if&y77=y80/v997<=y11;
!!BMx16:F?y78;                          [read flags]
!!VRy78:&4194304;                       [just look summoned bit]
!!BMx16&y78>0:N?y59;                    [current number]
!!VRy3:Sy49 +110;
!!VRy3&y86>0:+10;                       [+10% If GM Earth]
!!VRy59&y78>0/y59>0:*y3:100;            [grow 10% + SP%]
!!BMx16&y78>0/y59>0:Ny59;               [Set current number]
!!BMx16&y78>0/y59>0:By59;               [Set number at beginning of Battle]
!!en;
!!en;


!!if&y76=1/v9288=10;
!!BMx16:T?y77;                          [creature number]
!!SN:W^H3_Summon_Earth_0^/?y10;
!!VRy11:Sy10+1;
!!SN:W^H3_Earth Magic_1_Hero%V9282^/?y86;
!!VRy80&y86=0:S113;                     [Set Earth]
!!VRy80&y86=1:S125;                     [Set Magma]
!!if&y77=y80/v997<=y11;
!!BMx16:F?y78;                          [read flags]
!!VRy78:&4194304;                       [just look summoned bit]
!!BMx16&y78>0:N?y59;                    [current number]
!!VRy3:Sy49 +110;
!!VRy3&y86>0:+10;                       [+10% If GM Earth]
!!VRy59&y78>0/y59>0:*y3:100;            [grow 10% + SP%]
!!BMx16&y78>0/y59>0:Ny59;               [Set current number]
!!BMx16&y78>0/y59>0:By59;               [Set number at beginning of Battle]
!!en;
!!en;
!!en;
*--------------------------------Summon Water Elementals-----------------------*
!!if&v9278=1;
!!BMx16:I?y76;                          [Side index as for heroes (0:left, 1:right)]

!!if&y76=0/v9287=10;
!!BMx16:T?y77;                          [creature number]
!!SN:W^H3_Summon_Water_1^/?y10;
!!VRy11:Sy10+1;
!!SN:W^H3_Water Magic_1_Hero%V9281^/?y86;
!!VRy80&y86=0:S115;                     [Set Water]
!!VRy80&y86=1:S123;                     [Set Ice]
!!if&y77=y80/v997<=y11;
!!BMx16:F?y78;                          [read flags]
!!VRy78:&4194304;                       [just look summoned bit]
!!BMx16&y78>0:N?y59;                    [current number]
!!VRy3:Sy49 +110;
!!VRy3&y86>0:+10;                       [+10% If GM Water]
!!VRy59&y78>0/y59>0:*y3:100;            [grow 10% + SP%]
!!BMx16&y78>0/y59>0:Ny59;               [Set current number]
!!BMx16&y78>0/y59>0:By59;               [Set number at beginning of Battle]
!!en;
!!en;


!!if&y76=1/v9288=10;
!!BMx16:T?y77;                          [creature number]
!!SN:W^H3_Summon_Water_0^/?y10;
!!VRy11:Sy10+1;
!!SN:W^H3_Water Magic_1_Hero%V9282^/?y86;
!!VRy80&y86=0:S115;                     [Set Water]
!!VRy80&y86=1:S123;                     [Set Ice]
!!if&y77=y80/v997<=y11;
!!BMx16:F?y78;                          [read flags]
!!VRy78:&4194304;                       [just look summoned bit]
!!BMx16&y78>0:N?y59;                    [current number]
!!VRy3:Sy49 +110;
!!VRy3&y86>0:+10;                       [+10% If GM Water]
!!VRy59&y78>0/y59>0:*y3:100;            [grow 10% + SP%]
!!BMx16&y78>0/y59>0:Ny59;               [Set current number]
!!BMx16&y78>0/y59>0:By59;               [Set number at beginning of Battle]
!!en;
!!en;
!!en;
*--------------------------------Summon Air Elementals-------------------------*
!!if&v9279=1;
!!BMx16:I?y76;                          [Side index as for heroes (0:left, 1:right)]

!!if&y76=0/v9287=10;
!!BMx16:T?y77;                          [creature number]
!!SN:W^H3_Summon_Air_1^/?y10;
!!VRy11:Sy10+1;
!!SN:W^H3_Air Magic_1_Hero%V9281^/?y86;
!!VRy80&y86=0:S112;                     [Set Air]
!!VRy80&y86=1:S127;                     [Set Storm]
!!if&y77=y80/v997<=y11;
!!BMx16:F?y78;                          [read flags]
!!VRy78:&4194304;                       [just look summoned bit]
!!BMx16&y78>0:N?y59;                    [current number]
!!VRy3:Sy49 +110;
!!VRy3&y86>0:+10;                       [+10% If GM Air]
!!VRy59&y78>0/y59>0:*y3:100;            [grow 10% + SP%]
!!BMx16&y78>0/y59>0:Ny59;               [Set current number]
!!BMx16&y78>0/y59>0:By59;               [Set number at beginning of Battle]
!!en;
!!en;


!!if&y76=1/v9288=10;
!!BMx16:T?y77;                          [creature number]
!!SN:W^H3_Summon_Air_0^/?y10;
!!VRy11:Sy10+1;
!!SN:W^H3_Air Magic_1_Hero%V9282^/?y86;
!!VRy80&y86=0:S112;                     [Set Air]
!!VRy80&y86=1:S127;                     [Set Storm]
!!if&y77=y80/v997<=y11;
!!BMx16:F?y78;                          [read flags]
!!VRy78:&4194304;                       [just look summoned bit]
!!BMx16&y78>0:N?y59;                    [current number]
!!VRy3:Sy49 +110;
!!VRy3&y86>0:+10;                       [+10% If GM Air]
!!VRy59&y78>0/y59>0:*y3:100;            [grow 10% + SP%]
!!BMx16&y78>0/y59>0:Ny59;               [Set current number]
!!BMx16&y78>0/y59>0:By59;               [Set number at beginning of Battle]
!!en;
!!en;
!!en;



*--------------------------------------------------------------------Take Bonus Extra Conditions Dispel/Disrupting Ray------------------------------------------------------------------------*

!?FU(AC_Function_108);                  [Fix function for early Cure or Dispel]

!!if&x16<21;
!!HEv9281:Fd/d/?y1/d;                   [Save Spellpower aka aka Duration for attacker]
!!HEv9281:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14; [check for spell duration changing artifacts]
!!VRy1&y15=1:+1;                        [76 Collar of Conjuring]
!!VRy1&y16=1:+2;                        [77 Ring of Conjuring]
!!VRy1&y17=1:+3;                        [78 Cape of Conjuring]
!!VRy1&y18=1:+56;                       [139 Ring of the Magi]
!!VRy23:Sv9281;
!!en;

!!if&x16>20;
!!HEv9282:Fd/d/?y1/d;                   [Save Spellpower aka aka Duration for defender]
!!HEv9282:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14; [check for spell duration changing artifacts]
!!VRy1&y15=1:+1;                        [76 Collar of Conjuring]
!!VRy1&y16=1:+2;                        [77 Ring of Conjuring]
!!VRy1&y17=1:+3;                        [78 Cape of Conjuring]
!!VRy1&y18=1:+56;                       [139 Ring of the Magi]
!!VRy23:Sv9282;
!!en;
!!SN:W^Spell_Duration_Mod^/?y95;
!!FU(Calc_Spell_Duration)&y95=1:Py23/-1/?y1;

*-------------------------------stoneskin--------------------------------------*
!!if&v9390=10;
!!BMx16:G46/?y10/?y11;                  [check for stoneskin]
!!BMx16:D?y12;                          [speichere Defense]

!!VRy13:Sy1;                            [duration -1 says second round]
.!!if&y13=y10;
!!SN:W^Scaling_Magic_Spell_Number_^/?y21;
!!SS46&y21=46:E3/?y22;
!!FU(ApplyRemoveSpellScaling)&y21<>46:Py23/46/1/d/?y22;
*!VRy12:-y22;                                                                   [reduce defense]
!!VRy12:-5;                             [reduce defense]
!!BMx16:Dy12;                           [apply original defense]
.!!en;
!!VRv9390&x16=41:S0;
!!en;

*-------------------------------blessing---------------------------------------*
!!if&v9391=1000; Disabled
!!BMx16:G41/?y20/?y11;                  [check for blessing]
!!BMx16:U2/?y22;                        [speichere max Damage]

!!VRy14:Sy1;                            [duration -1 says second round]
.!!if&y14=y20;
!!VRy22:-2;                             [reduce max damage]
!!BMx16:U2/y22;                         [apply original damage]
.!!en;
!!VRv9391&x16=41:S0;
!!en;

*-------------------------------bloodlust -------------------------------------*
!!if&v9392=10;
!!BMx16:G43/?y30/?y11;                  [check for bloodlust]
!!BMx16:A?y32;                          [speichere attack]

!!VRy15:Sy1;                            [duration -1 says second round]
.!!if&y15=y30;
!!SN:W^Scaling_Magic_Spell_Number_^/?y21;
!!SS43&y21=43:E3/?y22;
!!FU(ApplyRemoveSpellScaling)&y21<>46:Py23/43/1/d/?y22;
!!VRy32:-y22;                           [increase max attack]
!!BMx16:Ay32;                           [apply original attack]
.!!en;
!!VRv9392&x16=41:S0;
!!en;

*-------------------------------precision -------------------------------------*
!!if&v9393=1000; disabled
!!BMx16:G44/?y40/?y11;                  [check for precision]
*!BMx16:A?y42;                                                                  [speichere attack]

!!VRy16:Sy1;                            [duration -1 says second round]
.!!if&y16=y40;
*!VRy42:-5;                                                                     [increase max attack]
*!BMx16:Ay42;                                                                   [apply original attack]
!!FU(AC_Function_114):Px16;
.!!en;
!!VRv9393&x16=41:S0;
!!en;

*-------------------------------haste -----------------------------------------*
!!if&v9394=10;
!!BMx16:G53/?y50/?y11;                  [check for haste]
!!BMx16:S?y52;                          [speichere speed]

!!VRy17:Sy1;                            [duration -1 says second round]
.!!if&y17=y50;
*!IF:M^Haste F:33671^;
!!VRy52:-1;                             [increase max speed]
!!BMx16:Sy52;                           [apply original speed]
.!!en;
!!VRv9394&x16=41:S0;
!!en;

*-------------------------------slow -----------------------------------------*
!!if&v9395=10;

!!if&x16<21;
!!HEv9282:Fd/d/?y2/d;                   [Save Spellpower aka aka Duration for defender]
!!HEv9282:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14; [check for spell duration changing artifacts]
!!VRy2&y15=1:+1;                        [76 Collar of Conjuring]
!!VRy2&y16=1:+2;                        [77 Ring of Conjuring]
!!VRy2&y17=1:+3;                        [78 Cape of Conjuring]
!!VRy2&y18=1:+56;                       [139 Ring of the Magi]
!!en;

!!if&x16>20;
!!HEv9281:Fd/d/?y2/d;                   [Save Spellpower aka aka Duration for attacker]
!!HEv9281:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14; [check for spell duration changing artifacts]
!!VRy2&y15=1:+1;                        [76 Collar of Conjuring]
!!VRy2&y16=1:+2;                        [77 Ring of Conjuring]
!!VRy2&y17=1:+3;                        [78 Cape of Conjuring]
!!VRy2&y18=1:+56;                       [139 Ring of the Magi]
!!en;

!!BMx16:G54/?y60/?y11;                  [check for slow]
!!BMx16:S?y62;                          [speichere speed]
!!VRy60&x16=0:+1;                       [fix for first creature only necaserie when new round]

!!VRy18:Sy2;                            [duration -1 says second round]
.!!if&y18=y60;
!!VRy62:+1;                             [increase max speed]
!!BMx16:Sy62;                           [apply original speed]
.!!en;
!!VRv9395&x16=41:S0;
!!en;
*-------------------------------heal ------------------------------------------*

Cant Cleanse That Effect

*-------------------------------shield -----------------------------------------*
!!if&v9397=10;
!!BMx16:G27/?y80/?y11;                  [check for shield]

!!VRy19:Sy1;
.!!if&y19=y80;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9397&x16=41:S0;
!!en;

*-------------------------------air shield ------------------------------------*
!!if&v9398=10;
!!BMx16:G28/?y90/?y11;                  [check for air shield]

!!VRy20:Sy1;
.!!if&y20=y90;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9398&x16=41:S0;
!!en;

*-------------------------------magic mirror ----------------------------------*
!!if&v9399=10;
!!BMx16:G36/?y93/?y11;                  [check for magic mirror]

!!VRy21:Sy1;
.!!if&y21=y93;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9399&x16=41:S0;
!!en;

*-------------------------------counterspell ----------------------------------*
!!if&v9400=1000; Disabled
!!BMx16:G34/?y94/?y11;                  [check for counterspell]

!!VRy22:Sy1;
.!!if&y22=y94;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9400&x16=41:S0;
!!en;

*-------------------------------mirth -----------------------------------------*
!!if&v9401=10;
!!BMx16:G49/?y95/?y11;                  [check for mirth]

!!VRy23:Sy1;
.!!if&y23=y95;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9401&x16=41:S0;
!!en;

*-------------------------------luck ------------------------------------------*
!!if&v9402=10;
!!BMx16:G51/?y96/?y11;                  [check for luck]

!!VRy24:Sy1;
.!!if&y24=y96;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9402&x16=41:S0;
!!en;

*-------------------------------counterstrike ---------------------------------*
!!if&v9403=1000; Disabled
!!BMx16:G58/?y97/?y11;                  [check for counterstrike]

!!VRy25:Sy1;
.!!if&y25=y97;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9403&x16=41:S0;
!!en;

*-------------------------------slayer ----------------------------------------*
!!if&v9404=10;
!!BMx16:G55/?y98/?y11;                  [check for slayer]

!!VRy26:Sy1;
.!!if&y26=y98;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9404&x16=41:S0;
!!en;

*-------------------------------fire shield -----------------------------------*
!!if&v9405=10;
!!BMx16:G29/?y99/?y11;                  [check for fire shield]

!!VRy27:Sy1;
.!!if&y27=y99;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9405&x16=41:S0;
!!en;

*-------------------------------frenzy ----------------------------------------*
!!if&v9406=1000; Disabled
!!BMx16:G29/?y82/?y11;                  [check for frenzy]

.!!if&y82=1;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9406&x16=41:S0;
!!en;

*-------------------------------prot fire -------------------------------------*
!!if&v9407=10;
!!BMx16:G29/?y82/?y11;                  [check for prot fire]

!!VRy28:Sy1;
.!!if&y28=y82;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9407&x16=41:S0;
!!en;

*-------------------------------prot water ------------------------------------*
!!if&v9408=10;
!!BMx16:G29/?y83/?y11;                  [check for prot water]

!!VRy29:Sy1;
.!!if&y29=y83;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9408&x16=41:S0;
!!en;

*-------------------------------prot earth ------------------------------------*
!!if&v9409=10;
!!BMx16:G29/?y84/?y11;                  [check for prot earth]

!!VRy30:Sy1;
.!!if&y30=y84;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9409&x16=41:S0;
!!en;

*-------------------------------prot air --------------------------------------*
!!if&v9410=10;
!!BMx16:G29/?y85/?y11;                  [check for prot air]

!!VRy31:Sy1;
.!!if&y31=y85;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9410&x16=41:S0;
!!en;
*-------------------------------shield -----------------------------------------*
!!SN:W^shield_var1^/?y50;
!!SN:W^shield_var2^/?y60;
!!if&y50=10|y60=10;
*!SN:W^H3_Earth Magic_1_Hero%V9283^/?y87;                                       [Earth Magic Bonus handling]
!!BMx16:G27/?y87/?y11;                  [check for shield]

!!VRy3:Sx16;                            [use stack ID (read below*), I set y2 to current stack number]
!!VRy3:+1*-1;                           [now I add +1 then change to negative  value, we have now number of stack for EA thx Sal]
!!EAy3:L?y77;
!!FU&y77=0:E;
!!VRy15:Sy77 %2;

.!!if&y87>0/y15=0;
!!BMx16:H?y73;                          [speichere hit points]
!!VRy18:Sy1 *10 +100;                   [calculate shield value]
!!VRy73:-y18;
*!BMx16:Hy73;
!!VRy77:-1;                             [set shield]
!!EAy3:Ly77;                            [now shield bonus can not be applied again this fight]
.!!en;
!!en;


*--------------------------------------------------------------------Take Bonus Extra Conditions Disrupting Ray------------------------------------------------------------------------*

!?FU(TakeStoneSkinBonusDisRay);         [Fix function for early Disrupting Ray]

!!if&x1<21;
!!HEv9281:Fd/d/?y1/d;                   [Save Spellpower aka aka Duration for attacker]
!!HEv9281:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14; [check for spell duration changing artifacts]
!!VRy1&y15=1:+1;                        [76 Collar of Conjuring]
!!VRy1&y16=1:+2;                        [77 Ring of Conjuring]
!!VRy1&y17=1:+3;                        [78 Cape of Conjuring]
!!VRy1&y18=1:+56;                       [139 Ring of the Magi]
!!VRy23:Sv9281;
!!en;

!!if&x1>20;
!!HEv9282:Fd/d/?y1/d;                   [Save Spellpower aka aka Duration for defender]
!!HEv9282:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14; [check for spell duration changing artifacts]
!!VRy1&y15=1:+1;                        [76 Collar of Conjuring]
!!VRy1&y16=1:+2;                        [77 Ring of Conjuring]
!!VRy1&y17=1:+3;                        [78 Cape of Conjuring]
!!VRy1&y18=1:+56;                       [139 Ring of the Magi]
!!VRy23:Sv9282;
!!en;
!!SN:W^Spell_Duration_Mod^/?y95;
!!FU(Calc_Spell_Duration)&y95=1:Py23/-1/?y1;

!!if&v9390=10;
!!BMx1:G46/?y10/?y11;                   [check for stoneskin]
!!BMx1:D?y12;                           [speichere Defense]

!!VRy13:Sy1;                            [duration -1 says second round]
.!!if&y13=y10;
!!SN:W^Scaling_Magic_Spell_Number_^/?y21;
!!SS46&y21=46:E3/?y22;
!!FU(ApplyRemoveSpellScaling)&y21<>46:Py23/46/1/d/?y22;
*!VRy12:-y22;                                                                   [reduce defense]
!!VRy12:-5;                             [reduce defense]
!!VRy12&y12<0:S0;
!!BMx1:Dy12;                            [apply original defense]
!!VRy14:Sv9280 *-1 +1;                  [Side of the target is 1 minus current side]
!!SN:W^Stoneskin_Cast%Y14^/?y14;
!!SN&y13>0/y14=1:W^DisRayStoneSkinRemoved%X1^/1;
.!!en;
!!VRv9390&x1=41:S0;
!!en;

*--------------------------------------------------------------------Give Bonus Extra Abilities--------------------------------------------------------------------------*

!?FU(AC_Function_114);                  [Function for giving extra abilities]

!!BMx16:T?y1;
!!VRy2:Sx16;                            [use stack ID (read below*), I set y2 to current stack number]
!!VRy2:+1*-1;                           [now I add +1 then change to negative  value, we have now number of stack for EA thx Sal]

!!if&v9290=107/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Shield Block]
!!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
!!EAy2&y3>=0:By3/1/76/29/30/30/30/30/30/30/30/30/30/30/30; [Battle Monster]
!!en;

!!if&v9290=108/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Air Shield Block]
!!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
!!EAy2&y3>=0:By3/1/76/29/30/30/30/30/30/30/30/30/30/30/30; [Battle Monster]
!!en;

!!if&v9290=108/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Air Shield Block]
!!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
!!EAy2&y3>=0:By3/1/76/29/30/30/30/30/30/30/30/30/30/30/30; [Battle Monster]
!!en;

!!if&v9290=109/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Magic Mirror Cast]
!!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
!!EAy2&y3>=0:By3/1/106/16/50/50/50/50/50/50/50/50/50/50/50; [Battle Monster]
!!en;

!!if&v9290=110/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Counterspell cast Dispel]
*!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
*!EAy2&y3>=0:By3/1/99/78/100/100/100/100/100/100/100/100/100/100/100; [Battle Monster]
!!en;

!!if&v9290=111/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Mirth Fly]
!!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
!!EAy2&y3>=0:By3/1/102/70/1/1/1/1/1/1/1/1/1/1/1; [Battle Monster]
!!en;

!!if&v9290=112/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Luck Champion Distance Bonus]
!!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
!!EAy2&y3>=0:By3/1/102/99/1/1/1/1/1/1/1/1/1/1/1; [Battle Monster]
!!en;

!!if&v9290=113/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Counterstrike No Retaliation]
*!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
*!EAy2&y3>=0:By3/1/102/82/1/1/1/1/1/1/1/1/1/1/1; [Battle Monster]
!!en;

!!if&v9290=114/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Slayer Death Blow]
!!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
!!EAy2&y3>=0:By3/1/101/61/100/100/100/100/100/100/100/100/100/100/100; [Battle Monster]
!!en;

!!if&v9290=115/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Fire Shield Summon Clone]
!!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
!!EAy2&y3>=0:By3/1/108/114/25/25/25/25/25/25/25/25/25/25/25; [Battle Monster]
!!en;

!!if&v9290=116/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Frenzy Strike and Return]
*!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
*!EAy2&y3>=0:By3/1/102/98/1/1/1/1/1/1/1/1/1/1/1; [Battle Monster]
!!en;

!!if&v9290=117/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Protection Elements]
!!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
!!EAy2&y3>=0:By3/1/75/15/75/75/75/75/75/75/75/75/75/75/75; [Battle Monster]
!!en;

!!if&v9290=118/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Protection Elements]
!!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
!!EAy2&y3>=0:By3/1/75/15/75/75/75/75/75/75/75/75/75/75/75; [Battle Monster]
!!en;

!!if&v9290=119/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Protection Elements]
!!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
!!EAy2&y3>=0:By3/1/75/15/75/75/75/75/75/75/75/75/75/75/75; [Battle Monster]
!!en;

!!if&v9290=120/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Protection Elements]
!!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
!!EAy2&y3>=0:By3/1/75/15/75/75/75/75/75/75/75/75/75/75/75; [Battle Monster]
!!en;

!!if&v9290=103/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Precision Shoot when Adjacent]
*!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
*!EAy2&y3>=0:By3/1/102/115/1/1/1/1/1/1/1/1/1/1/1; [Battle Monster]
!!en;

*--------------------------------------------------------------------Take Bonus Extra Abilities----------------------------------------------------------------------------*

!?FU(AC_Function_120);                  [Function for taking extra abilities]

!!BMx16:T?y1;
!!VRy2:Sx16;                            [use stack ID (read below*), I set y2 to current stack number]
!!VRy2:+1*-1;                           [now I add +1 then change to negative  value, we have now number of stack for EA  thx Sal]

!!if&v9397=10/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Shield]
!!EAy2:F76/?y3;                         [Check for Deflect/next available bonus line: y3]
!!EAy2&y3>=0:By3/0/76/29/30/30/30/30/30/30/30/30/30/30/30; [Battle Monster]
!!en;

!!if&v9398=10/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Air Shield]
!!EAy2:F76/?y3;                         [Check for Deflect/next available bonus line: y3]
!!EAy2&y3>=0:By3/0/76/29/30/30/30/30/30/30/30/30/30/30/30; [Battle Monster]
!!en;

!!if&v9399=10/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Magic Mirror Ice Lightning]
!!EAy2:F106/?y3;                        [Check for Cast/next available bonus line: y3]
!!EAy2&y3>=0:By3/0/106/16/50/50/50/50/50/50/50/50/50/50/50; [Battle Monster]
!!en;

!!if&v9400=10/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Counterspell cast Dispel]
*!EAy2:F99/78/?y3;                      [Check for Cast/next available bonus line: y3]
*!EAy2&y3>=0:By3/0/99/78/100/100/100/100/100/100/100/100/100/100/100; [Battle Monster]
!!en;

!!if&v9401=10/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Mirth Fly]
!!EAy2:F102/70/?y3;                     [Check for Cast/next available bonus line: y3]
!!EAy2&y3>=0:By3/0/102/70/1/1/1/1/1/1/1/1/1/1/1; [Battle Monster]
!!en;

!!if&v9402=10/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Luck Champion Distance Bonus]
!!EAy2:F102/99/?y3;                     [Check for Cast/next available bonus line: y3]
!!EAy2&y3>=0:By3/0/102/99/1/1/1/1/1/1/1/1/1/1/1; [Battle Monster]
!!en;

!!if&v9403=10/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Counterstrike No Retaliation]
*!EAy2:F102/82/?y3;                     [Check for Cast/next available bonus line: y3]
*!EAy2&y3>=0:By3/0/102/82/1/1/1/1/1/1/1/1/1/1/1; [Battle Monster]
!!en;

!!if&v9404=10/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Slayer Death Blow]
!!EAy2:F101/?y3;                        [Check for Cast/next available bonus line: y3]
!!EAy2&y3>=0:By3/0/101/61/100/100/100/100/100/100/100/100/100/100/100; [Battle Monster]
!!en;

!!if&v9405=10/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Fire Shield Summon Clone]
!!EAy2:F108/114/?y3;                    [Check for Cast/next available bonus line: y3]
!!EAy2&y3>=0:By3/0/108/114/25/25/25/25/25/25/25/25/25/25/25; [Battle Monster]
!!en;

!!if&v9406=10/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Frenzy Death Stare]
!!EAy2:F102/98/?y3;                     [Check for Cast/next available bonus line: y3]
!!EAy2&y3>=0:By3/0/102/98/1/1/1/1/1/1/1/1/1/1/1; [Battle Monster]
!!en;

!!if&v9407=10/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Protection Elements]
!!EAy2:F75/15/?y3;                      [Check for Cast/next available bonus line: y3]
!!EAy2&y3>=0:By3/0/75/15/75/75/75/75/75/75/75/75/75/75/75; [Battle Monster]
!!en;

!!if&v9408=10/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Protection Elements]
!!EAy2:F75/15/?y3;                      [Check for Cast/next available bonus line: y3]
!!EAy2&y3>=0:By3/0/75/15/75/75/75/75/75/75/75/75/75/75/75; [Battle Monster]
!!en;

!!if&v9409=10/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Protection Elements]
!!EAy2:F75/15/?y3;                      [Check for Cast/next available bonus line: y3]
!!EAy2&y3>=0:By3/0/75/15/75/75/75/75/75/75/75/75/75/75/75; [Battle Monster]
!!en;

!!if&v9410=10/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Protection Elements]
!!EAy2:F75/15/?y3;                      [Check for Cast/next available bonus line: y3]
!!EAy2&y3>=0:By3/0/75/15/75/75/75/75/75/75/75/75/75/75/75; [Battle Monster]
!!en;

!!if&v9393=10/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Precision Shoot when Adjacent]
*!EAy2:F102/115/?y3;                    [Check for Cast/next available bonus line: y3]
*!EAy2&y3>=0:By3/0/102/115/1/1/1/1/1/1/1/1/1/1/1; [Battle Monster]
!!en;
*--------------------------------------------------------------------Extra Function for Slow and Heal----------------------------------------------------------------------*

!?FU(AC_Function_121);

!!if&x16<21;
!!HEv9282:Fd/d/?y2/d;                   [Save Spellpower aka aka Duration for defender]
!!HEv9282:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14; [check for spell duration changing artifacts]
!!VRy2&y15=1:+1;                        [76 Collar of Conjuring]
!!VRy2&y16=1:+2;                        [77 Ring of Conjuring]
!!VRy2&y17=1:+3;                        [78 Cape of Conjuring]
!!VRy2&y18=1:+56;                       [139 Ring of the Magi]
!!en;

!!if&x16>20;
!!HEv9281:Fd/d/?y2/d;                   [Save Spellpower aka aka Duration for attacker]
!!HEv9281:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14; [check for spell duration changing artifacts]
!!VRy2&y15=1:+1;                        [76 Collar of Conjuring]
!!VRy2&y16=1:+2;                        [77 Ring of Conjuring]
!!VRy2&y17=1:+3;                        [78 Cape of Conjuring]
!!VRy2&y18=1:+56;                       [139 Ring of the Magi]
!!en;

!!if&v9395=10;
!!BMx16:G54/?y60/?y11;                  [check for slow]
!!BMx16:S?y62;                          [speichere speed]
.!!if&y2=y60;
!!VRy62:+1;                             [increase max speed]
!!BMx16:Sy62;                           [apply original speed]
.!!en;
!!VRv9395&x16=41:S0;
!!en;


*--------------------------------------------------------------------Extra Function for Bless/Curse -----------------------------------------------------------------------------*
!?FU(AC_Function_122);

!!if&x16<21;
!!HEv9281:Fd/d/?y2/d;                                                           [Save Spellpower aka aka Duration for defender]
!!HEv9281:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14;     [check for spell duration changing artifacts]
!!VRy2&y15=1:+1;                                                                [76 Collar of Conjuring]
!!VRy2&y16=1:+2;                                                                [77 Ring of Conjuring]
!!VRy2&y17=1:+3;                                                                [78 Cape of Conjuring]
!!VRy2&y18=1:+56;                                                               [139 Ring of the Magi]
!!en;

!!if&x16>20;
!!HEv9282:Fd/d/?y2/d;                                                           [Save Spellpower aka aka Duration for attacker]
!!HEv9282:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14;     [check for spell duration changing artifacts]
!!VRy2&y15=1:+1;                                                                [76 Collar of Conjuring]
!!VRy2&y16=1:+2;                                                                [77 Ring of Conjuring]
!!VRy2&y17=1:+3;                                                                [78 Cape of Conjuring]
!!VRy2&y18=1:+56;                                                               [139 Ring of the Magi]
!!en;

!!if&v9391=10;
!!BMx16:G41/?y20/?y11;                                                          [check for bless]
!!BMx16:U2/?y22;                                                                [speichere max damage]
.!!if&y2=y20;
!!VRy22:-2;                                                                     [reduce max damage]
!!BMx16:U2/y22;                                                                 [apply original damage]
.!!en;
!!VRv9391&x16=41:S0;
!!en;


*--------------------------------------------------------------------Extra Trigger for Forgetfulness -----------------------------------------------------------------------------*
!?FU(AC_Function_113);

!!BMx16:G61/?y13/?y14;                  [check for Forgetfulness]
!!FU&y13=0:E;

!!BA:Hv9280/?y99;
!!SN:W^H3_Water Magic_0_Hero%Y99^/?y16;
!!HEy99&y99>=0:S16/?y82 S25/?y85 Fd/d/?y22/d S24/?y87; [Checke ob der Held Sorcery und Water Magic hat und Spellpower]
*!VRy85&y85><0/v7198=1:+4;
!!FU|y82<3/y16<>1:E;

!!SN:W^H3_Water Magic_1_Hero%Y99^/?y87;
!!VRy22::5;
!!VRy22:+5;                             [chance is 5% plus 1% per 5 Spellpower]
!!VRy22&y87=1:+5;                       [+5% with GM Water]
!!VRy1:S0R99;
!!BMx16&y1<y22:M59/1/3;


!?FU(AC_Function_112)&1000;             [Return Creature Number]

!!UN:C42231940/4/?y4;
!!UN:C6919200/4/?y2;
!!VRy4:-y2 -21708 :1352;
!!VRx1:Sy4;


*--------------------------------------------------------------------Extra Trigger for Blind -----------------------------------------------------------------------------*
!?FU(AC_Function_111);

!!if&x16<21;
!!HEv9281:Fd/d/?y1/d;                                                           [Save Spellpower aka aka Duration for attacker]
!!HEv9281:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14;     [check for spell duration changing artifacts]
!!VRy1&y15=1:+1;                                                                [76 Collar of Conjuring]
!!VRy1&y16=1:+2;                                                                [77 Ring of Conjuring]
!!VRy1&y17=1:+3;                                                                [78 Cape of Conjuring]
!!VRy1&y18=1:+56;                                                               [139 Ring of the Magi]
!!en;

!!if&x16>20;
!!HEv9282:Fd/d/?y1/d;                                                           [Save Spellpower aka aka Duration for defender]
!!HEv9282:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14;     [check for spell duration changing artifacts]
!!VRy1&y15=1:+1;                                                                [76 Collar of Conjuring]
!!VRy1&y16=1:+2;                                                                [77 Ring of Conjuring]
!!VRy1&y17=1:+3;                                                                [78 Cape of Conjuring]
!!VRy1&y18=1:+56;                                                               [139 Ring of the Magi]
!!en;


!!BMx16:G62/?y86/?y11;                                                          [check for blind]

!!VRy32:Sy1;
.!!if&y11=3;
!!BMx16:M62/1/2;
.!!en;

*--------------------------------------------------------------------Extra Trigger for Dispel -----------------------------------------------------------------------------*
!?FU(AC_Function_115);

!!VRv9442:Sx16;
!!SN:W^Crea_Num%X16_Spell%Y1^/x16;                                              [Create dynamic variables]
!!DO(AC_Function_118)/27/58/1:P;


!?FU(AC_Function_118);

!!if&v9442>=0/v9442<=41;
!!BMv9442:Gx16/?y2/?y3;                                                         [check for active spells]
!!SN:W^Crea_Num%V9442_Spell%X16^/y2;                                            [Write duration in Creature_Var]
!!en;


!?FU(AC_Function_116);                                                                      [Give Back Spell Function]
!!VRv9448:Sx16;
!!DO(AC_Function_117)/27/58/1:P;


!?FU(AC_Function_117);                                                                      [Give Back Spell Function]
!!if&v9442>=0/v9442<=41;
!!SN:W^Crea_Num%V9448_Spell%X16^/?y2;                                           [Check duration in Creature_Var]
!!if&y2>0/x16<>35/x16<>37/x16<>38/x16<>39/x16<>40/x16<>42/x16<>45/x16<>47/x16<>50/x16<>52/x16<>54/x16<>59/x16<>60/x16<>61/x16<>62;
!!BMv9448:I?y1;
!!BA:Hy1/?y1;
!!FU(ApplyRemoveSpellScaling):Py1/x16/1/?y3/?y4;
!!SSx16:Ey3/y4;
!!BMv9448:Mx16/1/y3;                                                             [Give back Spell with 1 duration]
!!FU(ApplyRemoveSpellScaling):Py1/x16/-1/?y3/?y4;
!!SSx16:Ey3/y4;
!!en;
!!en;


*--------------------------------------------------------------------Extra Trigger for Force Field -----------------------------------------------------------------------------*
!?FU(AC_Function_100);

!!VRy10:S0;
!!BU:Ox16/?y1;                          [Check for Obstacle on Battlefield position]

!!if&y1>10;                             [If Obstacle is Force Field run HP Bonus Routine]
*!BG:N?y40;
!!VRy2:Sx16 -1;
*!VRy2&v9280=0:Sx16 -1;                                                         [Offset for left side]
*!VRy2&v9280=1:Sx16 +1;                                                         [Offset for right side]
!!BU&y2>=0:Ey2/?y3;                     [Get or check the stack number to of a living monster at position before the Force Field]

!!FU&y3=-1:E;                           [If no living Monster at that position Exit]

!!BMy3:H?y83;                           [Get HP of Creature]
!!SN&y3=0:W^M0_HP^/?y1; !!SN&y3=21:W^M21_HP^/?y1;
!!SN&y3=1:W^M1_HP^/?y1; !!SN&y3=22:W^M22_HP^/?y1;
!!SN&y3=2:W^M2_HP^/?y1; !!SN&y3=23:W^M23_HP^/?y1;
!!SN&y3=3:W^M3_HP^/?y1; !!SN&y3=24:W^M24_HP^/?y1;
!!SN&y3=4:W^M4_HP^/?y1; !!SN&y3=25:W^M25_HP^/?y1;
!!SN&y3=5:W^M5_HP^/?y1; !!SN&y3=26:W^M26_HP^/?y1;
!!SN&y3=6:W^M6_HP^/?y1; !!SN&y3=27:W^M27_HP^/?y1;
!!SN&y3=7:W^M7_HP^/?y1; !!SN&y3=28:W^M28_HP^/?y1;
!!SN&y3=8:W^M8_HP^/?y1; !!SN&y3=29:W^M29_HP^/?y1;
!!SN&y3=9:W^M9_HP^/?y1; !!SN&y3=30:W^M31_HP^/?y1;
!!SN&y3=10:W^M10_HP^/?y1; !!SN&y3=31:W^M31_HP^/?y1;

!!VRy10&y1=y83:S1;

!!if&y10=1;
!!VRy84:Sy83 *3+1:2;                    [Give +50% HP] (rounded up, @alf)]
!!BMy3:Hy84;
!!BMy3:T?y19;                           [monter type? attacking]
!!MA&y19>=0:Ly19/?y20;                  [monster level of receiving stack and defending stack]
!!VRy20:Sy20 +2;                        [Level of Monster + 2 damage]
!!BMy3:U1/?y21;                         [Check extra Damage]
!!BMy3:U2/?y22;
!!VRy21:+y20;
!!VRy22:+y20;
!!BMy3:U1/y21;                          [Give extra Damage]
!!BMy3:U2/y22;

!!VRz1:S^MAGCHDRN^;
!!SN:Pz1;
*Play Animation on Hex
!!UN:C6919200/4/?y11;
!!SN:E4810128/2/y11/77/y2/100/0;
!!en;
!!en;


!?FU(AC_Function_119);

!!VRy10:S0;
!!BMx16:H?y83;

!!if&x16<11;
!!SN&x16=0:W^M0_HP^/?y1; !!SN&x16=21:W^M21_HP^/?y1;
!!SN&x16=1:W^M1_HP^/?y1; !!SN&x16=22:W^M22_HP^/?y1;
!!SN&x16=2:W^M2_HP^/?y1; !!SN&x16=23:W^M23_HP^/?y1;
!!SN&x16=3:W^M3_HP^/?y1; !!SN&x16=24:W^M24_HP^/?y1;
!!SN&x16=4:W^M4_HP^/?y1; !!SN&x16=25:W^M25_HP^/?y1;
!!SN&x16=5:W^M5_HP^/?y1; !!SN&x16=26:W^M26_HP^/?y1;
!!SN&x16=6:W^M6_HP^/?y1; !!SN&x16=27:W^M27_HP^/?y1;
!!SN&x16=7:W^M7_HP^/?y1; !!SN&x16=28:W^M28_HP^/?y1;
!!SN&x16=8:W^M8_HP^/?y1; !!SN&x16=29:W^M29_HP^/?y1;
!!SN&x16=9:W^M9_HP^/?y1; !!SN&x16=30:W^M31_HP^/?y1;
!!SN&x16=10:W^M10_HP^/?y1; !!SN&x16=31:W^M31_HP^/?y1;

!!VRy5:Sy1 *3+1:2;                      [(rounded up, @alf)]
!!VRy10&y5=y83/y5<>0:S1;

!!FU&y10=0:E;

!!BMx16:F?i;                            [read flags]
!!VRi:&1;                               [just look at double wide]
!!BMx16:P?y2;                           [Check position of creature]
*!IF:M^Position is %Y2^;
*!VRy2&v9280=0:+1;                                                                      [Offset for Force Field Attacker]
*!VRy2&v9280=1:-1;                                                                      [Offset for Force Field Defender]
!!VRy2:+1;
*!VRy2&i>0/v9280=0:+1;                                                                  [Offset for Big Creature]
*!VRy2&i>0/v9280=1:-1;                                                                  [Offset for Big Creature]
!!VRy2&i>0:+1;
*!IF:M^Now Offeset Position is %Y2 and side is %V9280^;
!!BU:Oy2/?y3;                           [Check for Obstacle on Battlefield position]
!!FU&y3>10:E;                           [Exit it creature is next to Force Field]

!!BMx16:Hy1;                            []

!!BMx16:T?y19;                          [monter type? attacking]
!!MA&y19>=0:Ly19/?y20;                  [monster level of receiving stack and defending stack]
!!VRy20:Sy20 +2;                        [Level of Monster + 2 damage]
!!BMx16:U1/?y21;                        [Check extra Damage]
!!BMx16:U2/?y22;
!!VRy21:-y20;
!!VRy22:-y20;
!!BMx16:U1/y21;                         [Take extra Damage]
!!BMx16:U2/y22;
!!en;


!?FU(AC_Function_107);
!!BMx16:H?y1;
!!SN&x16=0:W^M0_HP^/y1; !!SN&x16=1:W^M1_HP^/y1; !!SN&x16=2:W^M2_HP^/y1; !!SN&x16=3:W^M3_HP^/y1; !!SN&x16=4:W^M4_HP^/y1; [**Save HP for first 11 creature of attacker]
!!SN&x16=5:W^M5_HP^/y1; !!SN&x16=6:W^M6_HP^/y1; !!SN&x16=7:W^M7_HP^/y1; !!SN&x16=8:W^M8_HP^/y1; !!SN&x16=9:W^M9_HP^/y1; !!SN&x16=10:W^M10_HP^/y1;
!!SN&x16=21:W^M21_HP^/y1; !!SN&x16=22:W^M22_HP^/y1; !!SN&x16=23:W^M23_HP^/y1; !!SN&x16=24:W^M24_HP^/y1; !!SN&x16=25:W^M25_HP^/y1;
!!SN&x16=26:W^M26_HP^/y1; !!SN&x16=27:W^M27_HP^/y1; !!SN&x16=28:W^M287_HP^/y1; !!SN&x16=29:W^M29_HP^/y1; !!SN&x16=30:W^M30_HP^/y1; !!SN&x16=31:W^M31_HP^/y1; [**Save HP for first 11 creature of defender]


*--------------------------------------------------------------------Extra Trigger for Quicksand -----------------------------------------------------------------------------*
!?FU(AC_Function_123);

!!BMx16:F?i;
!!VRi:&4;                               [just look at shooting bit]
!!if&i>0;
!!BMx16:P?y1;
!!FU(ACM_GetStackHeadPosition):Px16/?y1; [While BM:P returns the position of the "ass" of a wide stack, this function always returns the position of the head]
!!VRy2:S1;
!!VRy2&x16>=21:S4;
!!FU(AC_Function_126):Py1/y2/?y3;
!!BMx16:Q0/y3/1;
!!en;

!?FU(AC_Function_126);                  [Function to calculate neighbouring Hex cells]
!!UN:C6919200/4/?y1;                    [Y1 = combatManager]
!!VRx2:*2;
!!VRx1:*12+ y1+ 78952+ x2;
!!UN:Cx1/2/?x3;


*--------------------------------------------------------------------Teleport -----------------------------------------------------------------------------*
!?FU(AC_Function_125);

!!BMx16:P?y1;
!!VRy1&x1=10:S0;
!!SN&x16=0:W^M0_PO^/y1; !!SN&x16=1:W^M1_PO^/y1; !!SN&x16=2:W^M2_PO^/y1; !!SN&x16=3:W^M3_PO^/y1; !!SN&x16=4:W^M4_PO^/y1; [**Save PO for first 20 creature of attacker]
!!SN&x16=5:W^M5_PO^/y1; !!SN&x16=6:W^M6_PO^/y1; !!SN&x16=7:W^M7_PO^/y1; !!SN&x16=8:W^M8_PO^/y1; !!SN&x16=9:W^M9_PO^/y1; !!SN&x16=10:W^M10_PO^/y1;
!!SN&x16=11:W^M11_PO^/y1; !!SN&x16=12:W^M12_PO^/y1; !!SN&x16=13:W^M13_PO^/y1; !!SN&x16=14:W^M14_PO^/y1; !!SN&x16=15:W^M15_PO^/y1; !!SN&x16=16:W^M16_PO^/y1;
!!SN&x16=17:W^M17_PO^/y1; !!SN&x16=18:W^M18_PO^/y1; !!SN&x16=19:W^M19_PO^/y1; !!SN&x16=20:W^M20_PO^/y1; 

!!SN&x16=21:W^M21_PO^/y1; !!SN&x16=22:W^M22_PO^/y1; !!SN&x16=23:W^M23_PO^/y1; !!SN&x16=24:W^M24_PO^/y1; !!SN&x16=25:W^M25_PO^/y1;
!!SN&x16=26:W^M26_PO^/y1; !!SN&x16=27:W^M27_PO^/y1; !!SN&x16=28:W^M28_PO^/y1; !!SN&x16=29:W^M29_PO^/y1; !!SN&x16=30:W^M30_PO^/y1; !!SN&x16=31:W^M31_PO^/y1; [**Save PO for first 20 creature of defender]
!!SN&x16=32:W^M32_PO^/y1; !!SN&x16=33:W^M33_PO^/y1; !!SN&x16=34:W^M34_PO^/y1; !!SN&x16=35:W^M35_PO^/y1; !!SN&x16=36:W^M36_PO^/y1; !!SN&x16=37:W^M37_PO^/y1; 
!!SN&x16=38:W^M38_PO^/y1; !!SN&x16=39:W^M39_PO^/y1; !!SN&x16=40:W^M40_PO^/y1; !!SN&x16=41:W^M41_PO^/y1;

*--------------------------------------------------------------------Teleport -----------------------------------------------------------------------------*
!?FU(AC_Function_124);

!!BG:N?y20;
!!BMx16:P?y2;
!!FU&v9280=0/x16>10:E;
!!FU&v9280=1/x16<21:E;

!!if&x16>=0/x16<=20;
  !!SN&x16=0:W^M0_PO^/?y1;
  !!SN&x16=1:W^M1_PO^/?y1;
  !!SN&x16=2:W^M2_PO^/?y1;
  !!SN&x16=3:W^M3_PO^/?y1;
  !!SN&x16=4:W^M4_PO^/?y1;
  !!SN&x16=5:W^M5_PO^/?y1;
  !!SN&x16=6:W^M6_PO^/?y1;
  !!SN&x16=7:W^M7_PO^/?y1;
  !!SN&x16=8:W^M8_PO^/?y1;
  !!SN&x16=9:W^M9_PO^/?y1;
  !!SN&x16=10:W^M10_PO^/?y1;
  !!SN&x16=11:W^M11_PO^/?y1;
  !!SN&x16=12:W^M12_PO^/?y1;
  !!SN&x16=13:W^M13_PO^/?y1;
  !!SN&x16=14:W^M14_PO^/?y1;
  !!SN&x16=15:W^M15_PO^/?y1;
  !!SN&x16=16:W^M16_PO^/?y1;
  !!SN&x16=17:W^M17_PO^/?y1;
  !!SN&x16=18:W^M18_PO^/?y1;
  !!SN&x16=19:W^M19_PO^/?y1;
  !!SN&x16=20:W^M20_PO^/?y1;

!!en;

!!if&x16>=21/x16<=41;
  !!SN&x16=21:W^M21_PO^/?y1;
  !!SN&x16=22:W^M22_PO^/?y1;
  !!SN&x16=23:W^M23_PO^/?y1;
  !!SN&x16=24:W^M24_PO^/?y1;
  !!SN&x16=25:W^M25_PO^/?y1;
  !!SN&x16=26:W^M26_PO^/?y1;
  !!SN&x16=27:W^M27_PO^/?y1;
  !!SN&x16=28:W^M28_PO^/?y1;
  !!SN&x16=29:W^M29_PO^/?y1;
  !!SN&x16=30:W^M30_PO^/?y1;
  !!SN&x16=31:W^M31_PO^/?y1;
  !!SN&x16=32:W^M32_PO^/?y1;
  !!SN&x16=33:W^M33_PO^/?y1;
  !!SN&x16=34:W^M34_PO^/?y1;
  !!SN&x16=35:W^M35_PO^/?y1;
  !!SN&x16=36:W^M36_PO^/?y1;
  !!SN&x16=37:W^M37_PO^/?y1;
  !!SN&x16=38:W^M38_PO^/?y1;
  !!SN&x16=39:W^M39_PO^/?y1;
  !!SN&x16=40:W^M40_PO^/?y1;
!!en;

!!if&y2<>y1;
!!BMx16:P?y4;
!!FU(AC_Function_126):Py4/0/?y3;
!!BMy20:Q1/y3/1;
!!FU(AC_Function_126):Py4/1/?y3;
!!BMy20:Q1/y3/1;
!!FU(AC_Function_126):Py4/2/?y3;
!!BMy20:Q1/y3/1;
!!FU(AC_Function_126):Py4/3/?y3;
!!BMy20:Q1/y3/1;
!!FU(AC_Function_126):Py4/4/?y3;
!!BMy20:Q1/y3/1;
!!FU(AC_Function_126):Py4/5/?y3;
!!BMy20:Q1/y3/1;


!!BMx16:F?i;                            [read flags]
!!VRi:&1;                               [just look at double wide]

!!if&i>0;
!!BMx16:P?y4;
!!VRy4&v9280=0:+1;                      [Offset position for big creature attacker]
!!VRy4&v9280=1:-1;                      [Offset position for big creature defender]
!!FU(AC_Function_126):Py4/0/?y3;
!!BMy20:Q1/y3/1;
!!FU(AC_Function_126):Py4/1/?y3;
!!BMy20:Q1/y3/1;
!!FU(AC_Function_126):Py4/2/?y3;
!!BMy20:Q1/y3/1;
!!FU(AC_Function_126):Py4/3/?y3;
!!BMy20:Q1/y3/1;
!!FU(AC_Function_126):Py4/4/?y3;
!!BMy20:Q1/y3/1;
!!FU(AC_Function_126):Py4/5/?y3;
!!BMy20:Q1/y3/1;
!!en;
!!en;


*--------------------------------------------------------------------Earthquake -----------------------------------------------------------------------------*
!?FU(AC_Function_127);

!!BMx16:H?y1;
!!BMx16:U3/?y6;                         [save number of shots ]
!!FU&y1<1:E;
!!HE-1:Fd/d/?y3/d;
!!VRy2:S0R99;
!!VRy4:Sy3 *3 :10;                      [Chance is 15% +3% per 10SP]
!!VRy5:Sy4 +15;
!!VRy5&y5>30:S30;                       [cap at 30% chance ]

!!if&y2<y5;
!!BMx16:M74/1/0;
!!en;

!!if&y6>0;                             [50% chance to loose 3 ammunition]
!!VRy2:S0R1;
!!VRy6&y2=1:-3;
!!VRy6&y6<0:S0;
!!BMx16:U3/y6;                          [apply number of shots]
!!BMx16&y2=1:V48;                       [show misfortune if shots ammunition lost]
!!en;

*--------------------------------------------------------------------Remove Obstacle -----------------------------------------------------------------------------*
!?FU(AC_Function_96);

!!HE-1:Fd/d/?y60/d;
!!VRy61:S0R99;
!!VRy60:+30;
!!VRy62&y61<y60:S1;

!!BG:Q?y1;                              [Current attacking side]
!!SN&y1=0:W^Double_Cast_Attacker^/?y4;
!!SN&y1=1:W^Double_Cast_Defender^/?y4;

!!if&y62=1/y4=0;
!!BHv9280:M0;
!!SN:T^AC_Misc.Obstacle cast^/?z1;
!!BU&i^battle_isVisible^:Mz1;
!!VRz1:S^FORTUNE^;
!!SN&i^battle_isVisible^:Pz1;
!!en;

*--------------------------------------------------------------------Armageddon -----------------------------------------------------------------------------*
!?FU(AC_Function_97);

!!BMx16:M31/1/3;

*--------------------------------------------------------------------Berserker -----------------------------------------------------------------------------*
!?FU(AC_Function_98);

!!BMx16:G59/?y1/?y2;

!!SN&x16=0:W^BE_00^/y1;
!!SN&x16=1:W^BE_01^/y1;
!!SN&x16=2:W^BE_02^/y1;
!!SN&x16=3:W^BE_03^/y1;
!!SN&x16=4:W^BE_04^/y1;
!!SN&x16=5:W^BE_05^/y1;
!!SN&x16=6:W^BE_06^/y1;
!!SN&x16=7:W^BE_07^/y1;
!!SN&x16=8:W^BE_08^/y1;
!!SN&x16=9:W^BE_09^/y1;

!!SN&x16=21:W^BE_21^/y1;
!!SN&x16=22:W^BE_22^/y1;
!!SN&x16=23:W^BE_23^/y1;
!!SN&x16=24:W^BE_24^/y1;
!!SN&x16=25:W^BE_25^/y1;
!!SN&x16=26:W^BE_26^/y1;
!!SN&x16=27:W^BE_27^/y1;
!!SN&x16=28:W^BE_28^/y1;
!!SN&x16=29:W^BE_29^/y1;


!?FU(AC_Function_99);

!!BMx16:G59/?y3/?y4;

!!SN&x16=0:W^BE_00^/?y1;
!!SN&x16=1:W^BE_01^/?y1;
!!SN&x16=2:W^BE_02^/?y1;
!!SN&x16=3:W^BE_03^/?y1;
!!SN&x16=4:W^BE_04^/?y1;
!!SN&x16=5:W^BE_05^/?y1;
!!SN&x16=6:W^BE_06^/?y1;
!!SN&x16=7:W^BE_07^/?y1;
!!SN&x16=8:W^BE_08^/?y1;
!!SN&x16=9:W^BE_09^/?y1;

!!SN&x16=21:W^BE_21^/?y1;
!!SN&x16=22:W^BE_22^/?y1;
!!SN&x16=23:W^BE_23^/?y1;
!!SN&x16=24:W^BE_24^/?y1;
!!SN&x16=25:W^BE_25^/?y1;
!!SN&x16=26:W^BE_26^/?y1;
!!SN&x16=27:W^BE_27^/?y1;
!!SN&x16=28:W^BE_28^/?y1;
!!SN&x16=29:W^BE_29^/?y1;

!!BMx16:N?y10;
!!BMx16&y3=0/y1>0/y10>0:M54/2/3;
!!BMx16&y3=0/y1>0/y10>0:V19;

!!BGx16:E?y11;                          [Berserker spread handling]
!!SN:W^Bers_spread^/?y15;
!!if&y11>=0/y11<=41/y3=0/y1>0/y10>0/y15=0;
  !!BMy11:G59/?y12/?y13 T?y60;          [Get Berserk Spell and monster type]
  !!FU|y60=145/y60=146/y60=147/y60=148/y60=149:E; [Exit for WM]
  !!VRy14&y12=0:S0R5;                   [16% chance to spread Berserk]
  !!BMy11&y14=1/y12=0:M59/2/3;          [Apply Berserk to stack]
  !!BMy11&y14=1/y12=0:V35;              [Show Berserk animation]
  !!SN&y14=1/y12=0:W^Bers_spread^/1;    [Can only happen once per Battleround]
!!en;

*--------------------------------------------------------------------Animate Dead -----------------------------------------------------------------------------*
!?FU(AC_Function_104);

!!BMx16:N?y1;

!!if&y1>0;
!!SN&x16=0:W^Animate_00^/y1;
!!SN&x16=1:W^Animate_01^/y1;
!!SN&x16=2:W^Animate_02^/y1;
!!SN&x16=3:W^Animate_03^/y1;
!!SN&x16=4:W^Animate_04^/y1;
!!SN&x16=5:W^Animate_05^/y1;
!!SN&x16=6:W^Animate_06^/y1;
!!SN&x16=7:W^Animate_07^/y1;
!!SN&x16=8:W^Animate_08^/y1;
!!SN&x16=9:W^Animate_09^/y1;

!!SN&x16=21:W^Animate_21^/y1;
!!SN&x16=22:W^Animate_22^/y1;
!!SN&x16=23:W^Animate_23^/y1;
!!SN&x16=24:W^Animate_24^/y1;
!!SN&x16=25:W^Animate_25^/y1;
!!SN&x16=26:W^Animate_26^/y1;
!!SN&x16=27:W^Animate_27^/y1;
!!SN&x16=28:W^Animate_28^/y1;
!!SN&x16=29:W^Animate_29^/y1;
!!en;

!?FU(AC_Function_128);

!!BMx16:N?y2;

!!if&y2>0;
!!SN&x16=0:W^Animate_00^/?y1;
!!SN&x16=1:W^Animate_01^/?y1;
!!SN&x16=2:W^Animate_02^/?y1;
!!SN&x16=3:W^Animate_03^/?y1;
!!SN&x16=4:W^Animate_04^/?y1;
!!SN&x16=5:W^Animate_05^/?y1;
!!SN&x16=6:W^Animate_06^/?y1;
!!SN&x16=7:W^Animate_07^/?y1;
!!SN&x16=8:W^Animate_08^/?y1;
!!SN&x16=9:W^Animate_09^/?y1;

!!SN&x16=21:W^Animate_21^/?y1;
!!SN&x16=22:W^Animate_22^/?y1;
!!SN&x16=23:W^Animate_23^/?y1;
!!SN&x16=24:W^Animate_24^/?y1;
!!SN&x16=25:W^Animate_25^/?y1;
!!SN&x16=26:W^Animate_26^/?y1;
!!SN&x16=27:W^Animate_27^/?y1;
!!SN&x16=28:W^Animate_28^/?y1;
!!SN&x16=29:W^Animate_29^/?y1;

!!if&y2<>y1/y1>0;
!!SN:W^Animate_Monster^/x16;
!!en;
!!en;

*--------------------------------------------------------------------Magic Arrow -----------------------------------------------------------------------------*
!?FU(AC_Function_129);
*[refer to hero 0-155]

!!SN:W^Magic_Arrow_Hero%X16^/0;         [at map start reset counter for magic arrow]

*--------------------------------------------------------------------Magic Mirror -----------------------------------------------------------------------------*
!?FU(AC_Function_102);                  [Count Function]

!!BMx16:G36/?y12/?y13;
!!SN&y12>0:W^Magic_Mirror_Counter^/d+1;

!?FU(AC_Function_103);                  [Apply Function]

[:LoopRandomMonster]
!!VRy5&x4=1:S0R7;
!!VRy5&x4=2:S21R7;
!!BMy5:N?y2;
!!BMy5:T?y3;
!!SN|y2=0/y3=145/y3=146/y3=147/y3=148/y3=149:G[LoopRandomMonster]; [Loop until it finds a valid Stack to apply debuff, execlude Warmachines]

!!BMy5:Mx3/x2/3;

!!VRx1:-1;
!!VRx16&x1=0:S41;                       [End if no more creatures have magic mirror]


***********************************Reworking some spells***************
*Bless deals with the next attack bonus damage based on the heroes current spell points*
!?MF1;
!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^BlessSpell_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
!!SN:W^BlessSpell_Attacking_Stack^/y4;

!!BMy1:I?y2;                            [Side index as for heroes (0:left, 1:right)]
!!SN:W^Bless_Cast%Y2^/?y3;              [Check if there was a valid Bless cast]
!!FU&y3=0:E;                            [Exit if there was not a correct bless cast this battle]
!!SN:W^Bless_Strike_Creature%Y1^/?y11;  [Disable for creature so it only works once]
!!FU&y11=0:E;

!!BMy1:G41/?y13/?y14;                   [check for Bless Duration]
!!FU&y13=0:E;
!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;
!!MF:F?y4;                              [original damage]
!!HEy99:I?y6/1;                         [Get Current spell points]
!!VRy4:Sy4+y6;
!!MF&y6>0:Fy4;                          [deal new updated damage with spell points damage]
!!SN&y6>0:W^Bless_Strike_Creature%Y1^/0;[Disable for creature so it only works once]
!!BA:Q?f;
!!SN&i^battle_isVisible^:T^AC_Misc.Bless_SP_Damage^/?z-1/^damage^/y6;
!!BU&i^battle_isVisible^/1000:Mz-1;
!!en;

***********************************
*Anti Magic, as long as AM is active on any of your stacks all your creatures gain +15% MR*
!?MR2&1000;                             [Magic Resistance Trigger]

!!MR:N?y1;                              [Get Creature Number]
!!BMy1:I?y2;                            [Get Creature Side]
!!BG:H?y50;                             [Get Casting Hero]
!!BA:Hy2/?y4;                           [Get Hero Number of creature side]
!!FU&y4<0:E;
!!SN:W^H3_Water Magic_0_Hero%Y4^/?y10;  [Water Magic Bonus handling]
!!FU|y50=y4/y10=0:E;                    [Exit for beneficial spells, meaning same hero]
!!VRy20:S0;
!!if&y2=1;                              [Check Defender Creatures]
  !!re i/21/31;                         [34 Anti-Magic]
  !!BMi:G34/?y12/?y13;
  !!VRy20&y12>0:S1;
  !!en;
!!en;
!!if&y2=0;                              [Check Attacker creatures]
  !!re i/0/10;                          [34 Anti-Magic]
  !!BMi:G34/?y12/?y13;                  [check for Anti Magic]
  !!VRy20&y12>0:S1;                     [Set y20 to 1 if creature found]
  !!en;
!!en;

!!if&y20=1;                             [If a creature with Anti Magic was found increase all MR]
  !!MR:F?y5;                            [Get temporarily MR of Creature]
  !!VRy5:+15; !!VRy5&y5>=100:S100;      [Cannot be more than 100%]
  !!MR:Fy5;                             [Apply increased resistance chance to that stack temporarily]
!!en;


***********************************
*Precision next range attack deals AOE damage based on your SP*
!?MF1;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!FU&y10<>4455011:E;                    [Shooting Damage]

!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>7:E;                           [or Shoot]
!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!BMy4:T?y40;                           [Get Type in y40]

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;                           [Exit if no Hero]
!!SN:W^H3_Air Magic_0_Hero%Y99^/?y90;   [Air Magic Bonus handling]
!!BMy1:G44/?y12/?y13;                   [44  Precision]
!!SN:W^Precision_Strike_Creature%Y1^/?y11; [Check if Creature still can hit]
!!FU|y90=0/y12=0/y11=0:E;               [Exit if not Master Air or No Precision cast on stack or no more hits]

!!BA:Q?f;
!!BMy4&i^battle_isVisible^/1000:V53;    [Show Fireball animation]
!!BMy4:P?y1 I?y30;                      [get target position and Side]
!!FU(ACM_GetStackHeadPosition):Py4/?y1; [While BM:P returns the position of the "ass" of a wide stack, this function always returns the position of the head]
!!CM&1000:D?y1;                         [get where we clicked to have correct position of the fireball]
!!MF:F?y10;                             [get damage of ranged attack]
!!HEy5:F?y21/?y21/?y20/?y21;            [Get Spell Power of Hero in y20]
!!VRy12:Sy20:5+20;                      [AOE Damage is 20%+1% per 5 SP]
!!VRy10:*y12:100;                       [% of the damage]

!!VRy31:S(FALSE);                       [indicator for damage dealt]

!!re i/0/5;
  !!FU(AC_Function_126):Py1/i/?y3;

  !!if&y3>=0/y3<=186;
    !!BU:Ey3/?y8;             [-2 if there is alive stack at that position]

    !!if&y8>=0/y8<=41/y4<>y8;
      !!BMy8:I?y40;       [apply damage to surrounding creatures]

      !!if&y40=y30;
        !!BMy8:Ky10;[apply damage to surrounding creatures if same side]
        !!VRy31:S(TRUE);
      !!en;
    !!en;
  !!en;
!!en;

; If damage was dealt by BM:K, refresh the screen and check phoenix type resurrections
!!if&y31;
  !!FU(ACM_DrawActionPlay):P;
  !!FU(ACM_ExecutePhoenixResurrection):P;
!!en;

!!BG:N?y1;                              [Attacking Stack]
!!SN:W^Precision_Strike_Creature%Y1^/0; [Disable for creature so it only works once]

!?BF;

!!re y1/0/41;
 !!SN:W^Bless_Strike_Creature%Y1^/0;    [Reset Strikes before any Battle]
 !!SN:W^Precision_Strike_Creature%Y1^/0;
!!en;


************************
Frenzy: chance to avoid retaliations

!?MF1;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4456676;          [Only run when melee or strikes all round]

!!MF:W?y80;
!!FU&y80>0:E;
!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>6:E;                           [Exit if not melee attack]
!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]

!!FU&y4<>y1:E;                          [If attacking stack same as defending stack it means retaliation]
!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!SN:W^H3_Fire Magic_0_Hero%Y99^/?y90;  [Fire Magic Bonus handling]
!!SN:W^H3_Fire Magic_1_Hero%Y99^/?y91;  [Fire Magic Bonus handling]
!!BMy1:G56/?y12/?y13;                   [56 Frenzy]
!!FU|y12=0/y90=0:E;

!!HEy99:F?y41/?y41/?y40/?y41;
!!VRy20:S0R99;
!!VRy40::5 +20;                         [+SP/5% +20% chance to dodge]
!!VRy40&y91>0:+10;                      [+10% chance with GM Air]

!!if&y40>y20;                           [If roll is successful]
  !!BA:Q?f;
  !!VRz-1&1000:S^AIRSHELD^;
  !!SN&i^battle_isVisible^:Pz-1;
  !!MF:E0;                              [apply reduced damage]
  !!MF:F0;
  !!SN:T^AC_Misc.Air Dodge^/?z-1;
  !!BU&i^battle_isVisible^:Mz-1;        [show message in log]
!!en;
!!en;


************************
Counterstrike: Increases retaliation damage based on your Spell Power
!?MF1;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]

!!if|y10=4462398/y10=4456676;           [Only run when melee or strikes all round]
  !!BG:N?y1;                            [Attacking Stack]
  !!MF:N?y4;                            [damage receiving stack]

  !!if&y1=y4;                           [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
    !!VRy1:Si^acm_attackStack^;
    !!BMy1:I?y5;                        [Side index as for heroes (0:left, 1:right)]
    !!FU&i^Counterstrike_Cast%Y5^=0:E;  [Check if there was a valid Counterstrike cast]

    !!BA:Hy5/?y99;
    !!FU&y99=(NO_HERO):E;

    !!HEy99:S(SKILL_AIR_MAGIC)/?y30;
    !!SN:W^H3_Air Magic_0_Hero%Y99^/?y90;   [Air Magic Bonus handling]
    !!SN:W^H3_Air Magic_1_Hero%Y99^/?y91;   [Air Magic Bonus handling]
    !!FU|y30<(SKILL_EXPERT)/y90=(FALSE):E;

    !!BMy1:G58/?y12/?y13;                   [58 Counterstrike]
    !!FU|y12=0/y13<(SKILL_EXPERT):E; [Exit if conditions are wrong]

    !!HEy99:F?y41/?y41/?y40/?y41;
    !!VRy40::3 +10 +100;                    [+SP/3% +10% increased damage]
    !!VRy40&y91>0:+10;                      [+10% increase with GM Air]

    !!MF:F?y6;                              [damage dealt]
    !!VRy10:Sy6*y40:100-y6;                 [Calc increased damage]

    !!if&y10>0;
      !!VRy7:Sy6 +y10;

      !!if&y7>y6;
        !!MF:Fy7;

        !!if&i^battle_isVisible^;
          !!SN:T^AC_Misc.Counterstrike_Avoid^/?z-1/^damage1^/y10;
          !!MM:Sz-1;
        !!en;
      !!en;
    !!en;
  !!en;
!!en;


****************************************************************************************************
*-----------------------Set correct Spell Description---------------------------
**Set when click on Spell Book
**Set when click on Mage Guild in Town
**Set in Battle
**Set when click cast spell on Adv.Map

; Opening and closing spell book hooks by Archer30
; The following script manipulates spell details (SS:C, SS:E etc) when opening and closing spell book, also on every stack turn in the battle
; Spell details are restored after battle or closing spell book (if not in battle)
!?FU(ACM_CreateERMHook);
!#VA(setHook:x);

!!SN:E(setHook)/1/5882167/(ACM_OnOpenSpellBook); 59C137
!!SN:E(setHook)/1/5885016/(ACM_OnCloseSpellBook); 59CC58

!?FU(ACM_OnOpenSpellBook);
!#VA(hook:x);

; Get Hero Id
!!UN:C(hook)/(STRUCT_HOOK_CONTEXT_EBX)/4/?(ebx:y);
!!UN:C(ebx)/26/4/?(heroId:y);

; Detemine the side variable depending on whether it's in a battle
!!UN:C(hook)/(STRUCT_HOOK_CONTEXT_EDX)/4/?(edx:y); [3rd parametre]

!!if&(edx)=(NULL);
  !!VR(side:y):S3;                      [Set side to 3 if not in a battle]
  !!VRi^acm_isNonCombatSpellBookOpened^:S(TRUE);
!!el;
  !!VR(side):Si^battle_current_side^;
!!en;

; Get the type of terrain
; Here this parameter is not used as it seems Perry's function handles it
!!UN:C(hook)/(STRUCT_HOOK_CONTEXT_EAX)/4/?(terrain:y); [BU:G value, -1 for no terrain overlay]

!!FU(H3_Set_Spell_Descriptions):P(heroId)/(side);

; Restore spell details when closing spell book (only when not in battle)
!?FU(ACM_OnCloseSpellBook)&i^acm_isNonCombatSpellBookOpened^;
!!VRi^acm_isNonCombatSpellBookOpened^:S(FALSE);
!!FU(ACM_RestoreOriginalSpellValue):P;

; Compatibility with Summon Elemental (WoG Option)
!!if&i^acm_isAdvMapSummonElem^;
  !!re i/(SPELL_FIRE_ELEMENTAL)/(SPELL_AIR_ELEMENTAL);
    !!SSi:C0/d:10;                      [Normal]
    !!SSi:C1/d*10;                      [Basic]
    !!SSi:C2/d*10;                      [Advanced]
    !!SSi:C3/d*10;                      [Expert]
  !!en;
!!en;

; Restore spell details when exiting battle
!?FU(OnAfterBattleUniversal);
!!FU(ACM_RestoreOriginalSpellValue):P;

!?FU(OnBattleStackObtainsTurn);         [Set spells in Combat]
!!BHi^battle_current_side^:N?y1;        [get owner]
!!FU(H3_Set_Spell_Descriptions)&y1>=0/y1<=155:Py1/i^battle_current_side^;

; Mage Guild
!?CM1;                                  [town screen click]
!!CM:I?y1;
!!FU&y1>5:E;                            [0-5 mage guild click]
!!FU(H3_Set_Spell_Descriptions_Orginal):P;

*?OB54&1000;                       [When visiting a Monster, this is done so that spells applied to a monster have the normal power]
*!VRz1:S^SPTRAITS.TXT^;            [Normal Sptraits]
*!UN:C5890966/4/9597928;
*!SN:E5890960/1;
*!UN:C5890966/4/6849372;

!?FU(ACM_RestoreOriginalSpellValue);
!!re i/0/69;
  !!SN:W^H3_Normal_Spell_%i_Cost^/?t;    !!SSi:C0/t;
  !!SN:W^H3_Basic_Spell_%i_Cost^/?t;     !!SSi:C1/t;
  !!SN:W^H3_Advanced_Spell_%i_Cost^/?t;  !!SSi:C2/t;
  !!SN:W^H3_Expert_Spell_%i_Cost^/?t;    !!SSi:C3/t;

  !!if|i=11/i=13/i=15/i=16/i=17/i=18/i=19/i=20/i=21/i=22/i=23/i=24/i=25/i=26/i=57;
    !!SN:W^H3_Normal_Spell_%i_Effect^/?t;   !!SSi:E0/t; [Normal]
    !!SN:W^H3_Basic_Spell_%i_Effect^/?t;    !!SSi:E1/t; [Basic]
    !!SN:W^H3_Advanced_Spell_%i_Effect^/?t; !!SSi:E2/t; [Advanced]
    !!SN:W^H3_Expert_Spell_%i_Effect^/?t;   !!SSi:E3/t; [Expert]
  !!en;
!!en;

!?FU(H3_Set_Spell_Descriptions);

!!SN:W^Damage_Spells_Increment^/?y79;
!!SN:W^Spell_Trainer_Mod^/?y80;         [Check for Spell Trainer option]

!!HEx1:F?y1/?y1/?y2/?y1;
!!HEx1:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85; [Checke current hero Sorcery und Magien hat]

!!TRv998/v999/v1000:G?y1;               [Check for Terrain on Which the hero stands to prevent wrong spell description if on special terrain]
!!VRy81&y1=46:S3; Magic Plains 46 !!VRy81&y1=226:S3; [Fiery Field 226]
!!VRy82&y1=46:S3; Magic Plains 46 !!VRy82&y1=229:S3; [Magic Clouds 229]
!!VRy83&y1=46:S3; Magic Plains 46 !!VRy83&y1=228:S3; [Loucid Pool 228]
!!VRy84&y1=46:S3; Magic Plains 46 !!VRy84&y1=231:S3; [Rocklands 231]

!!SN:W^H3_Sorcery_0_Hero%X1^/?y20;
!!SN:W^H3_Sorcery_1_Hero%X1^/?y21;

!!VRy1:S0;
!!VRy1&y85=0:S0;                        [No Sorcery]
!!VRy1&y85=1/y20=0/y21=0:S1;            [Basic         +1 Spell Points]
!!VRy1&y85=2/y20=0/y21=0:S2;            [Advanced      +2]
!!VRy1&y85=3/y20=0/y21=0:S3;            [Expert        +3]
!!VRy1&y85=3/y20=1/y21=0:S4;            [Master        +4]
!!VRy1&y85=3/y20=1/y21=1:S5;            [Grandmaster   +5]

*Here it sets the additional amount of Spell Points you need for multicasting (+5,+10,+15,+20,+20 and so on)
!!VRy30:S0; !!VRy31:S0;
!!SN&x2=0:W^Magic_Specialists_%V997_Cast_Count_Att^/?y30;
!!SN&x2=1:W^Magic_Specialists_%V997_Cast_Count_Def^/?y30;
!!VRy31&y30=0:S0; !!VRy31&y30=1:S5; !!VRy31&y30=2:S15; !!VRy31&y30=3:S30; !!VRy31&y30=4:S50; !!VRy31&y30=5:S70; !!VRy31&y30=6:S90; !!VRy31&y30=7:S110; !!VRy31&y30=8:S130; !!VRy31&y30=9:S150; !!VRy31&y30>=10:S170;
!!VRy1:+y31;

[Restore original spell value]
!!FU(ACM_RestoreOriginalSpellValue):P;

*Change Spell Point Costs for all Spells (replaces SPTRAITS, should be safer to use but just guessing) at least fixes the bug that the ballista is calles SPTRAITS in battle
!!re i/0/69;
  !!SSi:C0/dy1;                         [Normal]
  !!SSi:C1/dy1;                         [Basic]
  !!SSi:C2/dy1;                         [Advanced]
  !!SSi:C3/dy1;                         [Expert]

  ; Compatibility with Summon Elemental (WoG Option)
  !!if&i^acm_isAdvMapSummonElem^/i>=(SPELL_FIRE_ELEMENTAL)/i<=(SPELL_AIR_ELEMENTAL);
    !!SSi:C0/d*10;                      [Normal]
    !!SSi:C1/d*10;                      [Basic]
    !!SSi:C2/d*10;                      [Advanced]
    !!SSi:C3/d*10;                      [Expert]
  !!en;

  !!if|i=11/i=13/i=15/i=16/i=17/i=18/i=19/i=20/i=21/i=22/i=23/i=24/i=25/i=26/i=57; [Disabled for now]
    !!SSi:S?y60;                        [Get spell's magic school bits]
    !!VRy61:Sy60:1%2;                   [air. If bits of this spell contain school of air magic, this will be equal to 1]
    !!VRy62:Sy60:2%2;                   [fire]
    !!VRy63:Sy60:4%2;                   [water]
    !!VRy64:Sy60:8%2;                   [earth]
    !!VRy25&y61=1:S1;                   [air y3]
    !!VRy25&y62=1:S4;                   [fire y4]
    !!VRy25&y63=1:S8;                   [water y5]
    !!VRy25&y64=1:S2;                   [earth y6]
    !!VRy26&y25=1:Sy82;                 [Air]
    !!VRy26&y25=2:Sy84;                 [Earth]
    !!VRy26&y25=4:Sy81;                 [Fire]
    !!VRy26&y25=8:Sy83;                 [Water]
    !!if&i=15;
      !!VRy26|y81=0/y82=0/y83=0/y84=0:S0;
      !!VRy26|y81=1/y82=1/y83=1/y84=1:S1;
      !!VRy26|y81=2/y82=2/y83=2/y84=2:S2;
      !!VRy26|y81=3/y82=3/y83=3/y84=3:S3;
    !!en;
    !!SSi:Ey26/?y3; !!SSi:P?y5;         [Get Spell damage Power and Extra Damage]
    !!FU(H3_Calc_Normal_Spell_Damage):Px1/?y99/?y98/0/i/0;
    !!VRy23:Sy5*y2+y3;
    !!VRy24:Sy5*y2+y3*y99:100;

    !!VRy24:Sy24-y23+y3;
    *!IF&i=19:L^now %Vi y23 is%Y23    Total:%Y24  Readout y3:%Y3  and power is y5:%Y5  and SP is:%Y2  y99 is %Y99^;
    *!IF&i=19:L^y99 is %Y99^;
    !!if|i=11/i=13;
      !!SN&i=13:W^Hero%X1_Fire Wall_Upgrade^/?y23; !!VRy24&i=13:Sy23*50+y3; [Exception for Landmine]
      !!SN&i=11:W^Hero%X1_Land Mine_Upgrade^/?y23; !!VRy24&i=11:Sy23*35+y3; [Exception for Fire Wall]
    !!en;
    !!SSi:Ey26/y24; Set new Spell damage
  !!en;
!!en;

!!FU(Calc_Magic_Strength):Px1/?y90;

!!SN:W^H3_Fire Magic_0_Hero%X1^/?y10;   [Fire Magic Bonus handling]
!!SN:W^H3_Fire Magic_1_Hero%X1^/?y11;
!!FU(Fire_Spells_Improved_Description):Px1/y2/y11/y10/y11/y81/y90/y85/y80/y79; [Pass Spell Power Y2 and Hero Number X1 and (Intelligence Y11) and Master Y10  and Grandmaster Level Y11 and Fire Magic Y81 and Magic Strength Y90 and Sorcery Y85 and y80 spell trainer option]

!!SN:W^H3_Air Magic_0_Hero%X1^/?y10;    [Air Magic Bonus handling]
!!SN:W^H3_Air Magic_1_Hero%X1^/?y11;
!!FU(Air_Spells_Improved_Description):Px1/y2/y11/y10/y11/y82/y90/y85/y80/y79;

!!SN:W^H3_Water Magic_0_Hero%X1^/?y10;  [Water Magic Bonus handling]
!!SN:W^H3_Water Magic_1_Hero%X1^/?y11;
!!FU(Water_Spells_Improved_Description):Px1/y2/y11/y10/y11/y83/y90/y85/y80/y79;

!!SN:W^H3_Earth Magic_0_Hero%X1^/?y10;  [Earth Magic Bonus handling]
!!SN:W^H3_Earth Magic_1_Hero%X1^/?y11;
!!FU(Earth_Spells_Improved_Description):Px1/y2/y11/y10/y11/y84/y90/y85/y80/y79;

!!SN:W^H3_Fire Magic_0_Hero%X1^/?y10;   [Fire Magic Bonus handling]
!!SN:W^H3_Fire Magic_1_Hero%X1^/?y11;
!!SN:W^H3_Air Magic_0_Hero%X1^/?y13;    [Air Magic Bonus handling]
!!SN:W^H3_Air Magic_1_Hero%X1^/?y14;
!!SN:W^H3_Water Magic_0_Hero%X1^/?y15;  [Water Magic Bonus handling]
!!SN:W^H3_Water Magic_1_Hero%X1^/?y16;
!!SN:W^H3_Earth Magic_0_Hero%X1^/?y17;  [Earth Magic Bonus handling]
!!SN:W^H3_Earth Magic_1_Hero%X1^/?y18;

!!VRy50&y10=0/y13=0/y15=0/y17=0:S0;
!!VRy50|y10=1/y13=1/y15=1/y17=1:S1;
!!VRy50|y11=1/y14=1/y16=1/y18=1:S2;

!!FU(Magic_Arrow_Improved_Description):Px1/y81/y82/y83/y84/y50/y85/0/y80/y79; [Normal-Expert]


********************************************************************************
*Sets the Spell Description in the Mage Guilt
!?FU(H3_Set_Spell_Descriptions_Orginal);

!!VRz125:Sz199705;                      [Magic Arrow]
!!SN:H^spell^/15/(SPELL_TEXT_DESCR)/z125;

** Fire
!!VRz121:Sz199701;                      [Land Mine]
!!SN:H^spell^/11/(SPELL_TEXT_DESCR)/z121;

!!VRz123:Sz199703;                      [Fire Wall]
!!SN:H^spell^/13/(SPELL_TEXT_DESCR)/z123;

!!VRz131:Sz199711;                      [Fireball]
!!SN:H^spell^/21/(SPELL_TEXT_DESCR)/z131;

!!VRz132:Sz199712;                      [Inferno]
!!SN:H^spell^/22/(SPELL_TEXT_DESCR)/z132;

!!VRz136:Sz199716;                      [Armageddon]
!!SN:H^spell^/26/(SPELL_TEXT_DESCR)/z136;

!!VRz139:Sz199719;                      [Fire Shield]
!!SN:H^spell^/29/(SPELL_TEXT_DESCR)/z139;

!!VRz481:Sz199720;                      [Protection from Fire]
!!SN:H^spell^/31/(SPELL_TEXT_DESCR)/z481;

!!VRz258:Sz199730;                      [Sacrifice]
!!SN:H^spell^/40/(SPELL_TEXT_DESCR)/z258;

!!VRz257:Sz199732;                      [Curse]
!!SN:H^spell^/42/(SPELL_TEXT_DESCR)/z257;

!!VRz256:Sz199733;                      [Bloodlust]
!!SN:H^spell^/43/(SPELL_TEXT_DESCR)/z256;

!!VRz255:Sz199742;                      [Misfortune]
!!SN:H^spell^/52/(SPELL_TEXT_DESCR)/z255;

!!VRz770:Sz199745;                      [Slayer]
!!SN:H^spell^/55/(SPELL_TEXT_DESCR)/z770;

!!VRz254:Sz199746;                      [Frenzy]
!!SN:H^spell^/56/(SPELL_TEXT_DESCR)/z254;

!!VRz730:Sz199749;                      [Berserk]
!!SN:H^spell^/59/(SPELL_TEXT_DESCR)/z730;

!!VRz772:Sz199752;                      [Blind]
!!SN:H^spell^/62/(SPELL_TEXT_DESCR)/z772;

!!VRz776:Sz199756;                      [Summon Fire Elemental]
!!SN:H^spell^/66/(SPELL_TEXT_DESCR)/z776;
**

**Air
!!VRz127:Sz199707;                      [Lightning Bolt}]
!!SN:H^spell^/17/(SPELL_TEXT_DESCR)/z127;

!!VRz129:Sz199709;                      [Chain Lightning}]
!!SN:H^spell^/19/(SPELL_TEXT_DESCR)/z129;

!!VRz135:Sz199715;                      [Destroy Undead}]
!!SN:H^spell^/25/(SPELL_TEXT_DESCR)/z135;

!!VRz138:Sz199718;                      [Air Shield}]
!!SN:H^spell^/28/(SPELL_TEXT_DESCR)/z138;

!!VRz140:Sz199720;                      [Protection from Air}]
!!SN:H^spell^/30/(SPELL_TEXT_DESCR)/z140;

!!VRz119:Sz199726;                      [Magic Mirror}]
!!SN:H^spell^/36/(SPELL_TEXT_DESCR)/z119;

!!VRz253:Sz199734;                      [Precision}]
!!SN:H^spell^/44/(SPELL_TEXT_DESCR)/z253;

!!VRz252:Sz199737;                      [Disrupting Ray}]
!!SN:H^spell^/47/(SPELL_TEXT_DESCR)/z252;

!!VRz251:Sz199741;                      [Fortune}]
!!SN:H^spell^/51/(SPELL_TEXT_DESCR)/z251;

!!VRz250:Sz199743;                      [Haste}]
!!SN:H^spell^/53/(SPELL_TEXT_DESCR)/z250;

!!VRz598:Sz199748;                      [Counterstrike}]
!!SN:H^spell^/58/(SPELL_TEXT_DESCR)/z598;


!!VRz731:Sz199750;                      [Hypnotize}]
!!SN:H^spell^/60/(SPELL_TEXT_DESCR)/z731;

!!VRz779:Sz199759;                      [Summon Air Elemental}]
!!SN:H^spell^/69/(SPELL_TEXT_DESCR)/z779;
**

**Water
!!VRz487:Sz199727;                      [Cure}]
!!SN:H^spell^/37/(SPELL_TEXT_DESCR)/z487;                         [set cure description]

!!VRz126:Sz199706;                      [Ice Bolt}]
!!SN:H^spell^/16/(SPELL_TEXT_DESCR)/z126;

!!VRz130:Sz199710;                      [Frost Ring}]
!!SN:H^spell^/20/(SPELL_TEXT_DESCR)/z130;

!!VRz482:Sz199722;                      [Protection from Water}]
!!SN:H^spell^/32/(SPELL_TEXT_DESCR)/z482;

!!VRz485:Sz199725;                      [Dispel}]
!!SN:H^spell^/35/(SPELL_TEXT_DESCR)/z485;

!!VRz780:Sz199731;                      [Bless}]
!!SN:H^spell^/41/(SPELL_TEXT_DESCR)/z780;

!!VRz781:Sz199735;                      [Weakness}]
!!SN:H^spell^/45/(SPELL_TEXT_DESCR)/z781;

!!VRz782:Sz199738;                      [Prayer}]
!!SN:H^spell^/48/(SPELL_TEXT_DESCR)/z782;

!!VRz783:Sz199739;                      [Mirth}]
!!SN:H^spell^/49/(SPELL_TEXT_DESCR)/z783;

!!VRz771:Sz199751;                      [Forgetfulness}]
!!SN:H^spell^/61/(SPELL_TEXT_DESCR)/z771;

!!VRz773:Sz199753;                      [Teleport}]
!!SN:H^spell^/63/(SPELL_TEXT_DESCR)/z773;

!!VRz774:Sz199754;                      [Remove Obstacle}]
!!SN:H^spell^/64/(SPELL_TEXT_DESCR)/z774;

!!VRz775:Sz199755;                      [Clone}]
!!SN:H^spell^/65/(SPELL_TEXT_DESCR)/z775;

!!VRz778:Sz199758;                      [Summon Water Elemental}]
!!SN:H^spell^/68/(SPELL_TEXT_DESCR)/z778;
**

**Earth
!!VRz120:Sz199700;                      [Quicksand}]
!!SN:H^spell^/10/(SPELL_TEXT_DESCR)/z120;

!!VRz122:Sz199702;                      [Force Field}]
!!SN:H^spell^/12/(SPELL_TEXT_DESCR)/z122;

!!VRz124:Sz199704;                      [Earthquake}]
!!SN:H^spell^/14/(SPELL_TEXT_DESCR)/z124;

!!VRz128:Sz199708;                      [Implosion}]
!!SN:H^spell^/18/(SPELL_TEXT_DESCR)/z128;

!!VRz133:Sz199713;                      [Meteor Shower}]
!!SN:H^spell^/23/(SPELL_TEXT_DESCR)/z133;

!!VRz134:Sz199714;                      [Death Ripple}]
!!SN:H^spell^/24/(SPELL_TEXT_DESCR)/z134;

!!VRz137:Sz199717;                      [Shield}]
!!SN:H^spell^/27/(SPELL_TEXT_DESCR)/z137;

!!VRz483:Sz199723;                      [Protection from Earth}]
!!SN:H^spell^/33/(SPELL_TEXT_DESCR)/z483;

!!VRz484:Sz199724;                      [Anti-Magic}]
!!SN:H^spell^/34/(SPELL_TEXT_DESCR)/z484;

!!VRz488:Sz199728;                      [Resurrection}]
!!SN:H^spell^/38/(SPELL_TEXT_DESCR)/z488;

!!VRz489:Sz199729;                      [Animate Dead}]
!!SN:H^spell^/39/(SPELL_TEXT_DESCR)/z489;

!!VRz786:Sz199736;                      [Stone Skin}]
!!SN:H^spell^/46/(SPELL_TEXT_DESCR)/z786;

!!VRz784:Sz199740;                      [Sorrow}]
!!SN:H^spell^/50/(SPELL_TEXT_DESCR)/z784;

!!VRz785:Sz199744;                      [Slow}]
!!SN:H^spell^/54/(SPELL_TEXT_DESCR)/z785;

!!VRz777:Sz199757;                      [Summon Earth Elemental}]
!!SN:H^spell^/67/(SPELL_TEXT_DESCR)/z777;


****************************************************************************************************************************************************************
*Sets the Spell Description in the Hero Book and Combat*

!?FU(Magic_Arrow_Improved_Description);
!!VRz6|x2=0/x3=0/x4=0/x5=0:S^g^;        [Normal]
!!VRz6|x2=1/x3=1/x4=1/x5=1:S^g^;        [Basic]
!!VRz6|x2=2/x3=2/x4=2/x5=2:S^g^;        [Advanced]
!!VRz6|x2=3/x3=3/x4=3/x5=3:S^g^;        [Expert]
!!VRz6&x6=1:S^DodgerBlue^;              [Master]
!!VRz6&x6=2:S^r^;                       [Grandmaster]

!!SN|x2=0/x3=0/x4=0/x5=0:T^AC_Spells.Spell_Normal^/?z5;
!!SN|x2=1/x3=1/x4=1/x5=1:T^AC_Spells.Spell_Basic^/?z5;
!!SN|x2=2/x3=2/x4=2/x5=2:T^AC_Spells.Spell_Advanced^/?z5;
!!SN|x2=3/x3=3/x4=3/x5=3:T^AC_Spells.Spell_Expert^/?z5;
!!SN&x6=1:T^AC_Spells.Spell_Master^/?z5;
!!SN&x6=2:T^AC_Spells.Spell_Grandmaster^/?z5;

!!SN:W^Magic_Arrow_Hero%X1^/?y15;
!!SN:W^Magic_Arrow_dmg_increment^/?y60; [get damage increase per level]
!!VRy15:*y60;                           [Magic Arrow 2% Bonus damage per kill at M/GM level]

!!SN:T^AC_Spells.Magic_Arrow_0^/?z125;
!!SN&x6>0:T^AC_Spells.Magic_Arrow_1^/?z125;
!!SN&x9=1:W^SpellTrainerHero%X1_Spell15^/?y93; !!VRy93&x9=1:Sy93*x10;
!!SN&x9=1:T^AC_Spells.Trainer_Damage^/?z1/^damage^/y93;

!!VRz125&x9=1:+z1;!!SN:Iz125/?z125;
!!SN|x2=0/x3=0/x4=0/x5=0:H^spell^/15/(SPELL_TEXT_DESCR)/z125;
!!SN|x2=1/x3=1/x4=1/x5=1:H^spell^/15/(SPELL_TEXT_DESCR_BASIC)/z125;
!!SN|x2=2/x3=2/x4=2/x5=2:H^spell^/15/(SPELL_TEXT_DESCR_ADVANCED)/z125;
!!SN|x2=3/x3=3/x4=3/x5=3:H^spell^/15/(SPELL_TEXT_DESCR_EXPERT)/z125;


***************************************
!?FU(Fire_Spells_Improved_Description);
!!VRz6&x6=0/x4=0/x5=0:S^g^;             [Normal]
!!VRz6&x6=1/x4=0/x5=0:S^g^;             [Basic]
!!VRz6&x6=2/x4=0/x5=0:S^g^;             [Advanced]
!!VRz6&x6=3/x4=0/x5=0:S^g^;             [Expert]
!!VRz6&x6=3/x4=1/x5=0:S^DodgerBlue^;    [Master]
!!VRz6&x6=3/x4=1/x5=1:S^r^;             [Grandmaster]

!!SN&x6=0/x4=0/x5=0:T^AC_Spells.Spell_Normal^/?z5;
!!SN&x6=1/x4=0/x5=0:T^AC_Spells.Spell_Basic^/?z5;
!!SN&x6=2/x4=0/x5=0:T^AC_Spells.Spell_Advanced^/?z5;
!!SN&x6=3/x4=0/x5=0:T^AC_Spells.Spell_Expert^/?z5;
!!SN&x6=3/x4=1/x5=0:T^AC_Spells.Spell_Master^/?z5;
!!SN&x6=3/x4=1/x5=1:T^AC_Spells.Spell_Grandmaster^/?z5;

!!if&x6=0/x4=0/x5=0;                   [Means no rank]
!!VRz-6:S^^;                            [z-6 is female ending]
!!VRz-7:S^^;                            [z-7 is male ending]
!!VRz-8:S^^;                            [z-8 is plural ending]
!!VRz-9:S^^;                            [z-9 is neutral ending]
!!en;

!!if&x6=1/x4=0/x5=0;                   [Means Basic]
!!SN:T^AC_Spells.Basic_female^/?z-6;
!!SN:T^AC_Spells.Basic_male^/?z-7;
!!SN:T^AC_Spells.Basic_plural^/?z-8;
!!SN:T^AC_Spells.Basic_neutral^/?z-9;
!!en;

!!if&x6=2/x4=0/x5=0;                   [Means Advanced]
!!SN:T^AC_Spells.Advanced_female^/?z-6;
!!SN:T^AC_Spells.Advanced_male^/?z-7;
!!SN:T^AC_Spells.Advanced_plural^/?z-8;
!!SN:T^AC_Spells.Advanced_neutral^/?z-9;
!!en;

!!if&x6=3/x4=0/x5=0;                   [Means Expert]
!!SN:T^AC_Spells.Expert_female^/?z-6;
!!SN:T^AC_Spells.Expert_male^/?z-7;
!!SN:T^AC_Spells.Expert_plural^/?z-8;
!!SN:T^AC_Spells.Expert_neutral^/?z-9;
!!en;

!!if&x6=3/x4=1/x5=0;                   [Means Master]
!!SN:T^AC_Spells.Master_female^/?z-6;
!!SN:T^AC_Spells.Master_male^/?z-7;
!!SN:T^AC_Spells.Master_plural^/?z-8;
!!SN:T^AC_Spells.Master_neutral^/?z-9;
!!en;

!!if&x6=3/x4=1/x5=1;                   [Means Grandmaster]
!!SN:T^AC_Spells.Grandmaster_female^/?z-6;
!!SN:T^AC_Spells.Grandmaster_male^/?z-7;
!!SN:T^AC_Spells.Grandmaster_plural^/?z-8;
!!SN:T^AC_Spells.Grandmaster_neutral^/?z-9;
!!en;


**Fire
!!FU(ApplyRemoveSpellScaling):Px1/43/0/?y1/?y43; [Bloodlust]
!!FU(ApplyRemoveSpellScaling):Px1/42/0/?y1/?y42; [Curse]
!!FU(ApplyRemoveSpellScaling):Px1/29/0/?y1/?y29; [Fire Shield]
!!FU(ApplyRemoveSpellScaling):Px1/66/0/?y1/?y66; [Fire Elemental]
!!FU(ApplyRemoveSpellScaling):Px1/31/0/?y1/?y31; [Protection from Fire]
!!FU(ApplyRemoveSpellScaling):Px1/52/0/?y1/?y52; [Misfortune]
!!FU(ApplyRemoveSpellScaling):Px1/55/0/?y1/?y55; [Slayer]


!!VRy6&x6=0:S4; !!VRy6&x6=1:S4; !!VRy6&x6=2:S6; !!VRy6&x6=3:S8;
!!VRy7:Sx2 :2 +10;
!!SN&x4=1:T^AC_Spells.Land_Mine_0^/?z121;
!!SN&x4=0:T^AC_Spells.Land_Mine_1^/?z121;
!!SN:W^Hero%X1_Land Mine_Upgrade^/?y78;
!!SN&x9=1:W^SpellTrainerHero%X1_Spell11^/?y79; !!VRy78&x9=1:Sy78*50;
!!SN&x9=1:T^AC_Spells.Trainer_Damage_Casts^/?z1/^damage^/y78/^casts^/y79;
!!VRz121&x9=1:+z1; !!SN:Iz121/?z121; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/11/m/z121;


!!SN&x4=1:T^AC_Spells.Fire_Wall_0^/?z123;
!!SN&x4=0:T^AC_Spells.Fire_Wall_1^/?z123;
!!SN:W^Hero%X1_Fire Wall_Upgrade^/?y80;
!!SN:W^SpellTrainerHero%X1_Spell13^/?y81; !!VRy80&x9=1:Sy80*35;
!!SN&x9=1:T^AC_Spells.Trainer_Damage_Casts^/?z1/^damage^/y80/^casts^/y81;
!!VRz123&x9=1:+z1; !!SN:Iz123/?z123; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/13/m/z123;


!!VRy8&x4=1:S27;
!!VRy8&x5=1:S40;
!!SN&x4=1:T^AC_Spells.Fire_Ball_0^/?z131;
!!SN&x4=0:T^AC_Spells.Fire_Ball_1^/?z131;
!!SN&x9=1:W^SpellTrainerHero%X1_Spell21^/?y93; !!VRy93&x9=1:Sy93*x10;
!!SN&x9=1:T^AC_Spells.Trainer_Damage^/?z1/^damage^/y93;
!!VRz131&x9=1:+z1; !!SN:Iz131/?z131; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/21/m/z131;


!!SN&x4=1:T^AC_Spells.Inferno_0^/?z132;
!!SN&x4=0:T^AC_Spells.Inferno_1^/?z132;
!!SN&x9=1:W^SpellTrainerHero%X1_Spell22^/?y94; !!VRy94&x9=1:Sy94*x10;
!!SN&x9=1:T^AC_Spells.Trainer_Damage^/?z1/^damage^/y94;
!!VRz132&x9=1:+z1; !!SN:Iz132/?z132; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/22/m/z132;


!!SN&x4=1:T^AC_Spells.Armageddon_0^/?z136;
!!SN&x4=0:T^AC_Spells.Armageddon_1^/?z136;
!!SN&x9=1:W^SpellTrainerHero%X1_Spell26^/?y95; !!VRy95&x9=1:Sy95*x10;
!!SN&x9=1:T^AC_Spells.Trainer_Damage^/?z1/^damage^/y95;
!!VRz136&x9=1:+z1; !!SN:Iz136/?z136; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/26/m/z136;


!!VRy92:Sx2 :2 +10;                     [+10% + 1% per 2SP]
!!VRy92&x3>0:+10;                       [+10% with GM Fire]
!!VRy92&y92>=50/x3=0:S50;               [Cap at 50%]
!!VRy92&y92>=65/x3=1:S65;               [65% with GM Fire]
!!FU(Fire_Shield_Calculation):Px1/0/0/0/0/1/0/?y29/0;
!!SN&x4=1:T^AC_Spells.Fire_Shield_0^/?z139;
!!SN&x4=0:T^AC_Spells.Fire_Shield_1^/?z139;
!!SN&x9=1:W^Hero%X1_Fire Shield_Upgrade^/?y44; !!VRy95&x9=1:Sy44*50;
!!SN&x9=1:W^SpellTrainerHero%X1_Spell29^/?y70; 
!!SN&x9=1:T^AC_Spells.Trainer_Damage_Casts^/?z1/^damage^/y95/^casts^/y70;
!!VRz139&x9=1:+z1; !!SN:Iz139/?z139; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/29/m/z139;


!!VRy16:Sx2:2 +10;                      [+SP/2% +10% chance to shake off]
!!VRy16&x3>0:+20;                       [+20% chance with GM Fire]
!!VRy16&y16>=75:S75;                    [Cap at 75%]
!!SN&x9=1:W^Hero%X1_Protection_Upgrade^/?y71; !!VRy31&x9=1:+y71; Add Spell Trainer Effect
!!SN&x6>0/x4=1:T^AC_Spells.Fire_Protection_0^/?z481;
!!SN&x6=3/x4=0:T^AC_Spells.Fire_Protection_1^/?z481;
!!SN&x6<3/x4=0:T^AC_Spells.Fire_Protection_2^/?z481;
!!SN:W^SpellTrainerHero%X1_Spell30^/?y70;
!!SN&x9=1:T^AC_Spells.Trainer_Damage_Reduction_Casts^/?z1/^damage^/y71/^casts^/y70;
!!VRz481&x9=1:+z1; !!SN:Iz481/?z481; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/31/m/z481;


!!SN&x6=3/x4=1:T^AC_Spells.Sacrifice_0^/?z258;
!!SN|x6<3/x4=0:T^AC_Spells.Sacrifice_1^/?z258;
!!SN:Iz258/?z258; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/40/m/z258;


!!SN&x9=1:W^Hero%X1_Curse_Upgrade^/?y72; !!VRy42&x9=1:+y72; Add Spell Trainer Effect
!!SN&x6>0/x4=1:T^AC_Spells.Curse_0^/?z257;
!!SN&x6=3/x4=0:T^AC_Spells.Curse_1^/?z257;
!!SN&x6<3/x4=0:T^AC_Spells.Curse_2^/?z257;
!!SN:W^SpellTrainerHero%X1_Spell42^/?y73;
!!SN&x9=1:T^AC_Spells.Trainer_MinDmg_Casts^/?z1/^damage^/y72/^casts^/y73;
!!VRz257&x9=1:+z1; !!SN:Iz257/?z257; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/42/m/z257;



!!FU(Count_Set_Pieces_2):Px1/?y90;      [Count Set Pieces function X2]
!!VRy43&y90>=4:+4;
!!SN&x9=1:W^Hero%X1_Bloodlust_Upgrade^/?y74; !!VRy43&x9=1:+y74; Add Spell Trainer Effect
!!SN&x6>0/x4=1:T^AC_Spells.Bloodlust_0^/?z256;
!!SN&x6=3/x4=0:T^AC_Spells.Bloodlust_1^/?z256;
!!SN&x6<3/x4=0:T^AC_Spells.Bloodlust_2^/?z256;
!!SN:W^SpellTrainerHero%X1_Spell43^/?y75;
!!SN&x9=1:T^AC_Spells.Trainer_Attack_Casts^/?z1/^damage^/y74/^casts^/y75;
!!VRz256&x9=1:+z1; !!SN:Iz256/?z256; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/43/m/z256;


!!VRy78:Sx2 :2 +20;                     [Chance is 20% + 5% per 10SP]
!!VRy78&x3>0:+5;                        [+5% with GM Fire]
!!VRy78&y78>=50/x3=0:S50;
!!VRy78&y78>=60/x3=1:S60;
!!SN&x9=1:W^Hero%X1_Misfortune_Upgrade^/?y76; !!VRy52&x9=1:+y76; Add Spell Trainer Effect
!!SN&x6>0/x4=1:T^AC_Spells.Misfortune_0^/?z255;
!!SN&x6=3/x4=0:T^AC_Spells.Misfortune_1^/?z255;
!!SN&x6<3/x4=0:T^AC_Spells.Misfortune_2^/?z255;
!!SN:W^SpellTrainerHero%X1_Spell52^/?y77;
!!SN&x9=1:T^AC_Spells.Trainer_Luck1_Casts^/?z1/^damage^/y76/^casts^/y77;
!!VRz255&x9=1:+z1; !!SN:Iz255/?z255; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/52/m/z255;


!!VRy79:Sx2 :2 +20;                     [Chance for Crushing Blow is SP/2 + 20%]
!!VRy79&x3>0:+10;                       [+10% chance with GM Fire]
!!VRy79&y79>=100:S100;
!!SN&x9=1:W^Hero%X1_Slayer_Upgrade^/?y30; !!VRy55&x9=1:+y30; Add Spell Trainer Effect
!!SN&x6=3/x4=1:T^AC_Spells.Slayer_0^/?z770;
!!SN&x6=3/x4=0:T^AC_Spells.Slayer_1^/?z770;
!!SN&x6=2/x4=0:T^AC_Spells.Slayer_2^/?z770;
!!SN&x6<2/x4=0:T^AC_Spells.Slayer_3^/?z770;
!!SN:W^SpellTrainerHero%X1_Spell52^/?y31;
!!SN&x9=1:T^AC_Spells.Trainer_Attack_Casts^/?z1/^damage^/y30/^casts^/y31;
!!VRz770&x9=1:+z1; !!SN:Iz770/?z770; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/55/m/z770;


!!SS56:Ex6/?y7;
!!VRy85:Sx2 :5 +20;                     [Chance for Aviod is SP/2 + 20%]
!!VRy85&x3>0:+10;                       [+10% chance with GM Fire]
!!VRy85&y85>=100:S100;
!!SN&x9=1:W^Hero%X1_Frenzy_Upgrade^/?y32; !!VRy32:*5; !!VRy7&x9=1:+y32; Add Spell Trainer Effect
!!SN&x4=1:T^AC_Spells.Frenzy_0^/?z254/^damage^/y85;
!!SN&x4=0:T^AC_Spells.Frenzy_1^/?z254;
!!SN:W^SpellTrainerHero%X1_Spell56^/?y33;
!!SN&x9=1:T^AC_Spells.Trainer_Attack_Casts^/?z1/^damage^/y32/^casts^/y33;
!!VRz254&x9=1:+z1; !!SN:Iz254/?z254; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/56/m/z254;


!!SN&x6>0/x4=1:T^AC_Spells.Berserk_0^/?z730;
!!SN&x6>2/x4=0:T^AC_Spells.Berserk_1^/?z730;
!!SN&x6<3/x4=0:T^AC_Spells.Berserk_2^/?z730;
!!SN:Iz730/?z730; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/59/m/z730;


!!VRy8:S3 -x6 *25;
!!SN&x4=1:T^AC_Spells.Blind_0^/?z772;
!!SN&x6=3/x4=0:T^AC_Spells.Blind_1^/?z772;
!!SN&x6<3/x4=0:T^AC_Spells.Blind_2^/?z772;
!!SN:Iz772/?z772; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/62/m/z772;


!!VRy64:Sx2 +30;
!!VRy64&y64>=100:S100;                  [Cap at 100]
!!SN&x4=1:T^AC_Spells.Remove_0^/?z774;
!!SN&x4=0:T^AC_Spells.Remove_1^/?z774;
!!SN:Iz774/?z774; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/64/m/z774;


!!VRy66:Sx2:2+10;
!!VRy66&x3>0:+10;                       [with GM Fire]
!!SN:T^AC_Spells.Fire^/?z7;
!!SN&x3>0:T^AC_Spells.Energy^/?z7;
!!FU(Calc_Summoning_Power):Px1/66/?y10; [Pass Hero Number, Spell Number, Returns total Summoned HP]
!!SN&x9=1:W^Hero%X1_Summoning_Upgrade^/?y34; !!VRy34:*2;
!!SN&x6>0/x4=1:T^AC_Spells.Fire_Element_0^/?z776;
!!SN&x4=0:T^AC_Spells.Fire_Element_1^/?z776;
!!SN:W^SpellTrainerHero%X1_Spell66^/?y35;
!!SN&x9=1:T^AC_Spells.Trainer_HP_Casts_Sum^/?z1/^damage^/y34/^casts^/y35;
!!VRz776&x9=1:+z1; !!SN:Iz776/?z776; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/66/m/z776;


****************************************
!?FU(Air_Spells_Improved_Description);
!!VRz6&x6=0/x4=0/x5=0:S^g^;             [Normal]
!!VRz6&x6=1/x4=0/x5=0:S^g^;             [Basic]
!!VRz6&x6=2/x4=0/x5=0:S^g^;             [Advanced]
!!VRz6&x6=3/x4=0/x5=0:S^g^;             [Expert]
!!VRz6&x6=3/x4=1/x5=0:S^DodgerBlue^;    [Master]
!!VRz6&x6=3/x4=1/x5=1:S^r^;             [Grandmaster]

!!SN&x6=0/x4=0/x5=0:T^AC_Spells.Spell_Normal^/?z5;
!!SN&x6=1/x4=0/x5=0:T^AC_Spells.Spell_Basic^/?z5;
!!SN&x6=2/x4=0/x5=0:T^AC_Spells.Spell_Advanced^/?z5;
!!SN&x6=3/x4=0/x5=0:T^AC_Spells.Spell_Expert^/?z5;
!!SN&x6=3/x4=1/x5=0:T^AC_Spells.Spell_Master^/?z5;
!!SN&x6=3/x4=1/x5=1:T^AC_Spells.Spell_Grandmaster^/?z5;

!!if&x6=0/x4=0/x5=0;                   [Means no rank]
!!VRz-6:S^^;                            [z-6 is female ending]
!!VRz-7:S^^;                            [z-7 is male ending]
!!VRz-8:S^^;                            [z-8 is plural ending]
!!VRz-9:S^^;                            [z-9 is neutral ending]
!!en;

!!if&x6=1/x4=0/x5=0;                   [Means Basic]
!!SN:T^AC_Spells.Basic_female^/?z-6;
!!SN:T^AC_Spells.Basic_male^/?z-7;
!!SN:T^AC_Spells.Basic_plural^/?z-8;
!!SN:T^AC_Spells.Basic_neutral^/?z-9;
!!en;

!!if&x6=2/x4=0/x5=0;                   [Means Advanced]
!!SN:T^AC_Spells.Advanced_female^/?z-6;
!!SN:T^AC_Spells.Advanced_male^/?z-7;
!!SN:T^AC_Spells.Advanced_plural^/?z-8;
!!SN:T^AC_Spells.Advanced_neutral^/?z-9;
!!en;

!!if&x6=3/x4=0/x5=0;                   [Means Expert]
!!SN:T^AC_Spells.Expert_female^/?z-6;
!!SN:T^AC_Spells.Expert_male^/?z-7;
!!SN:T^AC_Spells.Expert_plural^/?z-8;
!!SN:T^AC_Spells.Expert_neutral^/?z-9;
!!en;

!!if&x6=3/x4=1/x5=0;                   [Means Master]
!!SN:T^AC_Spells.Master_female^/?z-6;
!!SN:T^AC_Spells.Master_male^/?z-7;
!!SN:T^AC_Spells.Master_plural^/?z-8;
!!SN:T^AC_Spells.Master_neutral^/?z-9;
!!en;

!!if&x6=3/x4=1/x5=1;                   [Means Grandmaster]
!!SN:T^AC_Spells.Grandmaster_female^/?z-6;
!!SN:T^AC_Spells.Grandmaster_male^/?z-7;
!!SN:T^AC_Spells.Grandmaster_plural^/?z-8;
!!SN:T^AC_Spells.Grandmaster_neutral^/?z-9;
!!en;


!!FU(ApplyRemoveSpellScaling):Px1/44/0/?y1/?y44; [Precision]
!!FU(ApplyRemoveSpellScaling):Px1/28/0/?y1/?y28; [Air Shield]
!!FU(ApplyRemoveSpellScaling):Px1/51/0/?y1/?y51; [Fortune]
!!FU(ApplyRemoveSpellScaling):Px1/53/0/?y1/?y53; [Haste]
!!FU(ApplyRemoveSpellScaling):Px1/47/0/?y1/?y47; [Disrupting Ray]
!!FU(ApplyRemoveSpellScaling):Px1/69/0/?y1/?y69; [Air Elemental]
!!FU(ApplyRemoveSpellScaling):Px1/30/0/?y1/?y30; [Protection from Air]
!!FU(ApplyRemoveSpellScaling):Px1/58/0/?y1/?y58; [Counterstrike]
!!FU(ApplyRemoveSpellScaling):Px1/36/0/?y1/?y36; [Magic Mirror]


!!SN&x4=1:T^AC_Spells.Lightning_0^/?z127;
!!SN&x4=0:T^AC_Spells.Lightning_1^/?z127;
!!SN&x9=1:W^SpellTrainerHero%X1_Spell17^/?y93; !!VRy93&x9=1:Sy93*x10;
!!SN&x9=1:T^AC_Spells.Trainer_Damage^/?z1/^damage^/y93;
!!VRz127&x9=1:+z1; !!SN:Iz127/?z127; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/17/m/z127;


!!VRy61&x6=0/x4=0/x5=0:S4;              [No Rank]
!!VRy61&x6=1/x4=0/x5=0:S4;              [Basic]
!!VRy61&x6=2/x4=0/x5=0:S5;              [Advanced]
!!VRy61&x6=3/x4=0/x5=0:S5;              [Expert]
!!VRy61&x6=3/x4=1/x5=0:S5;              [Master]
!!VRy61&x6=3/x4=1/x5=1:S5;              [Grandmaster]

!!SN&x4=1:T^AC_Spells.Chain_0^/?z129;
!!SN&x4=0:T^AC_Spells.Chain_1^/?z129;
!!SN&x9=1:W^SpellTrainerHero%X1_Spell19^/?y95; !!VRy95&x9=1:Sy95*x10;
!!SN&x9=1:T^AC_Spells.Trainer_Damage^/?z1/^damage^/y95;
!!VRz129&x9=1:+z1; !!SN:Iz129/?z129; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/19/m/z129;


!!SN&x4=1:T^AC_Spells.Destroy_0^/?z135;
!!SN&x4=0:T^AC_Spells.Destroy_1^/?z135;
!!SN&x9=1:W^SpellTrainerHero%X1_Spell25^/?y94; !!VRy94&x9=1:Sy94*x10;
!!SN&x9=1:T^AC_Spells.Trainer_Damage^/?z1/^damage^/y94;
!!VRz135&x9=1:+z1; !!SN:Iz135/?z135; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/25/m/z135;


!!VRy5:Sx2:10 +5;                       [+SP/10% +5% chance to dodge]
!!VRy5&x3>0:+3;                         [+3% chance with GM Air]
!!SN&x9=1:W^Hero%X1_Air Shield_Upgrade^/?y80; !!VRy28&x9=1:+y80; Add Spell Trainer Effect
!!SN&x6>0/x4=1:T^AC_Spells.Air_Shield_0^/?z138;
!!SN&x6=3/x4=0:T^AC_Spells.Air_Shield_1^/?z138;
!!SN&x6<3/x4=0:T^AC_Spells.Air_Shield_2^/?z138;
!!SN:W^SpellTrainerHero%X1_Spell28^/?y81;
!!SN&x9=1:T^AC_Spells.Trainer_Damage_Reduction_Casts^/?z1/^damage^/y80/^casts^/y81;
!!VRz138&x9=1:+z1; !!SN:Iz138/?z138; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/28/m/z138;


!!VRy11:Sx2:2 +10;                      [+SP/2% +10% chance to shake off]
!!VRy11&x3>0:+20;                       [+20% chance with GM Air]
!!VRy11&y11>=75:S75;                    [Cap at 75%]
!!SN&x9=1:W^Hero%X1_Protection_Upgrade^/?y71; !!VRy30&x9=1:+y71; [Add Spell Trainer Effect]
!!SN&x6>0/x4=1:T^AC_Spells.Air_Protect_0^/?z140;
!!SN&x6=3/x4=0:T^AC_Spells.Air_Protect_1^/?z140;
!!SN&x6<3/x4=0:T^AC_Spells.Air_Protect_2^/?z140;
!!SN:W^SpellTrainerHero%X1_Spell30^/?y70;
!!SN&x9=1:T^AC_Spells.Trainer_Damage_Reduction_Casts^/?z1/^damage^/y71/^casts^/y70;
!!VRz140&x9=1:+z1; !!SN:Iz140/?z140; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/30/m/z140;


!!SN&x4=1:T^AC_Spells.Magic_Mirror_0^/?z119;
!!SN&x4=0:T^AC_Spells.Magic_Mirror_1^/?z119;
!!SN:Iz119/?z119; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/36/m/z119;


!!VRy6:Sx2:5+20;                        [AOE Damage is 20%+1% per 5 SP]
!!SN&x9=1:W^Hero%X1_Precision_Upgrade^/?y82; !!VRy44&x9=1:+y82; [Add Spell Trainer Effect]
!!SN&x6>0/x4=1:T^AC_Spells.Precision_0^/?z253/^damage^/y6;
!!SN&x6=3/x4=0:T^AC_Spells.Precision_1^/?z253;
!!SN&x6<3/x4=0:T^AC_Spells.Precision_2^/?z253;
!!SN:W^SpellTrainerHero%X1_Spell44^/?y83;
!!SN&x9=1:T^AC_Spells.Trainer_Attack_Casts^/?z1/^damage^/y82/^casts^/y83;
!!VRz253&x9=1:+z1; !!SN:Iz253/?z253; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/44/m/z253;


!!VRy60&x4=1/x5=0:S1;                   [+1 chance with Master]
!!VRy60&x4=1/x5=1:S2;                   [+2 chance with GM]
!!SN&x9=1:W^Hero%X1_Disrupting Ray_Upgrade^/?y84; !!VRy47&x9=1:+y84; Add Spell Trainer Effect
!!SN&x6=3/x4=1:T^AC_Spells.Disrupting_0^/?z252;
!!SN&x4=0:T^AC_Spells.Disrupting_1^/?z252;
!!SN:W^SpellTrainerHero%X1_Spell47^/?y85;
!!SN&x9=1:T^AC_Spells.Trainer_reduce_Casts^/?z1/^damage^/y84/^casts^/y85;
!!VRz252&x9=1:+z1; !!SN:Iz252/?z252; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/47/m/z252;


!!VRy77:Sx2:2;
!!VRy77:+20;                            [Chance is 20% + 1% per 2SP]
!!VRy77&x3>0:+10;                       [+10% with GM Air]
!!VRy77&y77>=100:S100;
!!SN&x9=1:W^Hero%X1_Fortune_Upgrade^/?y88; !!VRy51&x9=1:+y88; Add Spell Trainer Effect
!!SN&x6>0/x4=1:T^AC_Spells.Fortune_0^/?z251;
!!SN&x6=3/x4=0:T^AC_Spells.Fortune_1^/?z251;
!!SN&x6<3/x4=0:T^AC_Spells.Fortune_2^/?z251;
!!SN:W^SpellTrainerHero%X1_Spell51^/?y89;
!!SN&x9=1:T^AC_Spells.Trainer_Luck2_Casts^/?z1/^damage^/y88/^casts^/y89;
!!VRz251&x9=1:+z1; !!SN:Iz251/?z251; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/51/m/z251;

!!HEx1:A2/151/?y18/?y19;                [Check for Boots of Haste]
!!VRy53&y19=1:+2;                       [+2 Haste with Boots equipped]
!!SN&x9=1:W^Hero%X1_Haste_Upgrade^/?y86; !!VRy53&x9=1:+y86; [Add Spell Trainer Effect]
!!SN&x6>0/x4=1:T^AC_Spells.Haste_0^/?z250;
!!SN&x6=3/x4=0:T^AC_Spells.Haste_1^/?z250;
!!SN&x6<3/x4=0:T^AC_Spells.Haste_2^/?z250;
!!SN:W^SpellTrainerHero%X1_Spell53^/?y87;
!!SN&x9=1:T^AC_Spells.Trainer_Haste_Casts^/?z1/^damage^/y86/^casts^/y87;
!!VRz250&x9=1:+z1; !!SN:Iz250/?z250; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/53/m/z250;


!!VRy49:Sx2:3+10;                       [Chance is 10% + 1% per 3SP]
!!VRy49&x3>0:+10;                       [+10% with GM Air]
!!SN&x6>0/x4=1:T^AC_Spells.Counterstrike_0^/?z598/^damage^/y49;
!!SN&x6=3/x4=0:T^AC_Spells.Counterstrike_1^/?z598;
!!SN&x6<3/x4=0:T^AC_Spells.Counterstrike_2^/?z598;
!!SN:Iz598/?z598; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/58/m/z598;


!!VRy60:Sx2 +20;                        [20% base + SP%]
!!VRy60&x3>0:+20;                       [+20% chance with GM Air]
!!VRy60&y60>=100:S100;

!!SS60:Ex6/?y30; !!SS60:P?y31;          [Get Spell damage Power and Extra Damage 60 Hypnotize]
!!VRy58:Sy31*x2+y30;                    [calc total Hypno Power]
!!SN&x4=1:T^AC_Spells.Hypnotize_0^/?z731;
!!SN&x4=0:T^AC_Spells.Hypnotize_1^/?z731;
!!SN:Iz731/?z731; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/60/m/z731;


!!VRy69:Sx2:2+10;
!!VRy69&x3>0:+10;                       [with GM Air]
!!SN:T^AC_Spells.Air^/?z7;
!!SN&x3>0:T^AC_Spells.Storm^/?z7;
!!FU(Calc_Summoning_Power):Px1/69/?y10; [Pass Hero Number, Spell Number, Returns total Summoned HP]
!!SN&x9=1:W^Hero%X1_Summoning_Upgrade^/?y34; !!VRy34:*2;
!!SN&x4=1:T^AC_Spells.Summon_Air_0^/?z779;
!!SN&x4=0:T^AC_Spells.Summon_Air_1^/?z779;
!!SN:W^SpellTrainerHero%X1_Spell66^/?y35;
!!SN&x9=1:T^AC_Spells.Trainer_HP_Casts_Sum^/?z1/^damage^/y34/^casts^/y35;
!!VRz779&x9=1:+z1; !!SN:Iz779/?z779; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/69/m/z779;


****************************************
!?FU(Water_Spells_Improved_Description);
!!VRz6&x6=0/x4=0/x5=0:S^g^;             [Normal]
!!VRz6&x6=1/x4=0/x5=0:S^g^;             [Basic]
!!VRz6&x6=2/x4=0/x5=0:S^g^;             [Advanced]
!!VRz6&x6=3/x4=0/x5=0:S^g^;             [Expert]
!!VRz6&x6=3/x4=1/x5=0:S^DodgerBlue^;    [Master]
!!VRz6&x6=3/x4=1/x5=1:S^r^;             [Grandmaster]

!!SN&x6=0/x4=0/x5=0:T^AC_Spells.Spell_Normal^/?z5;
!!SN&x6=1/x4=0/x5=0:T^AC_Spells.Spell_Basic^/?z5;
!!SN&x6=2/x4=0/x5=0:T^AC_Spells.Spell_Advanced^/?z5;
!!SN&x6=3/x4=0/x5=0:T^AC_Spells.Spell_Expert^/?z5;
!!SN&x6=3/x4=1/x5=0:T^AC_Spells.Spell_Master^/?z5;
!!SN&x6=3/x4=1/x5=1:T^AC_Spells.Spell_Grandmaster^/?z5;

!!if&x6=0/x4=0/x5=0;                   [Means no rank]
!!VRz-6:S^^;                            [z-6 is female ending]
!!VRz-7:S^^;                            [z-7 is male ending]
!!VRz-8:S^^;                            [z-8 is plural ending]
!!VRz-9:S^^;                            [z-9 is neutral ending]
!!en;

!!if&x6=1/x4=0/x5=0;                   [Means Basic]
!!SN:T^AC_Spells.Basic_female^/?z-6;
!!SN:T^AC_Spells.Basic_male^/?z-7;
!!SN:T^AC_Spells.Basic_plural^/?z-8;
!!SN:T^AC_Spells.Basic_neutral^/?z-9;
!!en;

!!if&x6=2/x4=0/x5=0;                   [Means Advanced]
!!SN:T^AC_Spells.Advanced_female^/?z-6;
!!SN:T^AC_Spells.Advanced_male^/?z-7;
!!SN:T^AC_Spells.Advanced_plural^/?z-8;
!!SN:T^AC_Spells.Advanced_neutral^/?z-9;
!!en;

!!if&x6=3/x4=0/x5=0;                   [Means Expert]
!!SN:T^AC_Spells.Expert_female^/?z-6;
!!SN:T^AC_Spells.Expert_male^/?z-7;
!!SN:T^AC_Spells.Expert_plural^/?z-8;
!!SN:T^AC_Spells.Expert_neutral^/?z-9;
!!en;

!!if&x6=3/x4=1/x5=0;                   [Means Master]
!!SN:T^AC_Spells.Master_female^/?z-6;
!!SN:T^AC_Spells.Master_male^/?z-7;
!!SN:T^AC_Spells.Master_plural^/?z-8;
!!SN:T^AC_Spells.Master_neutral^/?z-9;
!!en;

!!if&x6=3/x4=1/x5=1;                   [Means Grandmaster]
!!SN:T^AC_Spells.Grandmaster_female^/?z-6;
!!SN:T^AC_Spells.Grandmaster_male^/?z-7;
!!SN:T^AC_Spells.Grandmaster_plural^/?z-8;
!!SN:T^AC_Spells.Grandmaster_neutral^/?z-9;
!!en;


**Water
!!FU(ApplyRemoveSpellScaling):Px1/41/0/?y1/?y41; [Bless]
!!FU(ApplyRemoveSpellScaling):Px1/45/0/?y1/?y45; [Weakness]
!!FU(ApplyRemoveSpellScaling):Px1/68/0/?y1/?y68; [Water Elemental]
!!FU(ApplyRemoveSpellScaling):Px1/32/0/?y1/?y32; [Protection from Water]
!!FU(ApplyRemoveSpellScaling):Px1/48/0/?y1/?y48; [Prayer]
!!FU(ApplyRemoveSpellScaling):Px1/49/0/?y1/?y49; [Mirth]


!!SS37:P?y7;
!!SS37:Ex6/?y8;
!!VRy37:Sx2 *y7 +y8;
!!VRy9:Sy37;
!!VRy37&x3>0:+100;                      [+100HP healed with GM Water]
!!HEx1:X?y7/?y8/d/d/d/d/d;              [Check Hero Speciality]
!!VRy37&y7=3/y8=37:*2;                  [Double Cure heal for specialists @alf]
!!VRz-2:S^doubles^;
!!VRz-2&y7=3/y8=37:S^{~Gold}triples{~}^;
!!SN&x9=1:W^Hero%X1_Cure_Upgrade^/?y80; !!VRy80:*5; !!VRy37&x9=1:+y80; Add Spell Trainer Effect !!VRy9&x9=1:+y80;
!!SN&x6=3/x4=1:T^AC_Spells.Cure_0^/?z487;
!!SN&x6=3/x4=0:T^AC_Spells.Cure_1^/?z487;
!!SN&x6<3/x4=0:T^AC_Spells.Cure_2^/?z487;
!!SN:W^SpellTrainerHero%X1_Spell37^/?y81;
!!SN&x9=1:T^AC_Spells.Trainer_HP_Casts^/?z1/^damage^/y80/^casts^/y81;
!!VRz487&x9=1:+z1; !!SN:Iz487/?z487; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/37/m/z487;      [set cure description]


!!VRy20:S1;
!!VRy20&x3>0:S2;
!!SN&x6>0/x4=1:T^AC_Spells.Ice_Bolt_0^/?z126;
!!SN&x4=0:T^AC_Spells.Ice_Bolt_1^/?z126;
!!SN&x9=1:W^SpellTrainerHero%X1_Spell16^/?y93; !!VRy93&x9=1:Sy93*x10;
!!SN&x9=1:T^AC_Spells.Trainer_Damage^/?z1/^damage^/y93;
!!VRz126&x9=1:+z1; !!SN:Iz126/?z126; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/16/m/z126;


!!VRy20:S1;
!!VRy20&x3>0:S2;
!!SN&x6>0/x4=1:T^AC_Spells.Frost_Ring_0^/?z130;
!!SN&x4=0:T^AC_Spells.Frost_Ring_1^/?z130;
!!SN&x9=1:W^SpellTrainerHero%X1_Spell20^/?y94; !!VRy94&x9=1:Sy94*x10;
!!SN&x9=1:T^AC_Spells.Trainer_Damage^/?z1/^damage^/y94;
!!VRz130&x9=1:+z1; !!SN:Iz130/?z130; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/20/m/z130;


!!VRy14:Sx2:2 +10;                      [+SP/2% +10% chance to shake off]
!!VRy14&x3>0:+20;                       [+20% chance with GM Water]
!!VRy14&y14>=75:S75;                    [Cap at 75%]
!!SN&x9=1:W^Hero%X1_Protection_Upgrade^/?y71; !!VRy32&x9=1:+y71; Add Spell Trainer Effect
!!SN&x6=3/x4=1:T^AC_Spells.Water_Protection_0^/?z482;
!!SN&x6=3/x4=0:T^AC_Spells.Water_Protection_1^/?z482;
!!SN&x6<3/x4=0:T^AC_Spells.Water_Protection_2^/?z482;
!!SN:W^SpellTrainerHero%X1_Spell30^/?y70;
!!SN&x9=1:T^AC_Spells.Trainer_Damage_Reduction_Casts^/?z1/^damage^/y71/^casts^/y70;
!!VRz482&x9=1:+z1; !!SN:Iz482/?z482; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/32/m/z482;


!!SN&x6>0/x4=1:T^AC_Spells.Disple_0^/?z485;
!!SN&x6=3/x4=0:T^AC_Spells.Disple_1^/?z485;
!!SN&x6=2/x4=0:T^AC_Spells.Disple_2^/?z485;
!!SN&x6<2/x4=0:T^AC_Spells.Disple_3^/?z485;
!!SN:Iz485/?z485; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/35/m/z485;

!!HEx1:I?y98/1;              [Get current Hero Spell Points]
!!SN&x9=1:W^Hero%X1_Bless_Upgrade^/?y82; !!VRy41&x9=1:+y82; Add Spell Trainer Effect
!!SN&x6>0/x4=1:T^AC_Spells.Bless_0^/?z780/^damage^/y98;
!!SN&x6=3/x4=0:T^AC_Spells.Bless_1^/?z780;
!!SN&x6<3/x4=0:T^AC_Spells.Bless_2^/?z780;
!!SN:W^SpellTrainerHero%X1_Spell41^/?y83;
!!SN&x9=1:T^AC_Spells.Trainer_MaxDmg_Casts^/?z1/^damage^/y82/^casts^/y83;
!!VRz780&x9=1:+z1; !!SN:Iz780/?z780; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/41/m/z780;


!!SN&x9=1:W^Hero%X1_Weakness_Upgrade^/?y84; !!VRy45&x9=1:+y84; Add Spell Trainer Effect
!!SN&x6>0/x4=1:T^AC_Spells.Weakness_0^/?z781;
!!SN&x6=3/x4=0:T^AC_Spells.Weakness_1^/?z781;
!!SN&x6<3/x4=0:T^AC_Spells.Weakness_2^/?z781;
!!SN:W^SpellTrainerHero%X1_Spell45^/?y85;
!!SN&x9=1:T^AC_Spells.Trainer_Attack2_Casts^/?z1/^damage^/y84/^casts^/y85;
!!VRz781&x9=1:+z1; !!SN:Iz781/?z781; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/45/m/z781;


!!FU(Count_Set_Pieces):Px1/0/0/0/0/0/0/0/0/0/0/0/0/?y90; [Count Set Pieces function X14]
!!VRy48&y90>=5:+2;
!!VRy11:Sx2*2;                          [additional holy damage]
!!VRy11::5;                             [2% more damage per 5SP]
!!VRy11&x3>0:+5;                        [+5% more damage with GM Water]
!!VRy11&y11>=25:S25;                    [Limit to 25% Bonus damage]
!!SN&x9=1:W^Hero%X1_Prayer_Upgrade^/?y86; !!VRy48&x9=1:+y86; Add Spell Trainer Effect
!!SN&x6>0/x4=1:T^AC_Spells.Prayer_0^/?z782;
!!SN&x6=3/x4=0:T^AC_Spells.Prayer_1^/?z782;
!!SN&x6<3/x4=0:T^AC_Spells.Prayer_2^/?z782;
!!SN:W^SpellTrainerHero%X1_Spell48^/?y87;
!!SN&x9=1:T^AC_Spells.Trainer_Prayer_Casts^/?z1/^damage^/y86/^casts^/y87;
!!VRz782&x9=1:+z1; !!SN:Iz782/?z782; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/48/m/z782;


!!VRy12:Sx2 :2;
!!VRy12&x3>0:+10;                       [With GM Water]
!!SN&x9=1:W^Hero%X1_Mirth_Upgrade^/?y88; !!VRy49&x9=1:+y88; [Add Spell Trainer Effect]
!!SN&x6>0/x4=1:T^AC_Spells.Mirth_0^/?z783;
!!SN&x6=3/x4=0:T^AC_Spells.Mirth_1^/?z783;
!!SN&x6<3/x4=0:T^AC_Spells.Mirth_2^/?z783;
!!SN:W^SpellTrainerHero%X1_Spell49^/?y89;
!!SN&x9=1:T^AC_Spells.Trainer_Morale_Casts^/?z1/^damage^/y88/^casts^/y89;
!!VRz783&x9=1:+z1; !!SN:Iz783/?z783; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/49/m/z783;


!!VRy61:Sx2:5;
!!VRy61:+5;                             [chance is 5% plus 1% per 5 Spellpower]
!!VRy61&x3>0:+5;                        [With GM Water]
!!VRy61&y61>=100:S100;
!!SN&x6>0/x4=1:T^AC_Spells.Forgetfulness_0^/?z771;
!!SN&x6=3/x4=0:T^AC_Spells.Forgetfulness_1^/?z771;
!!SN&x6=2/x4=0:T^AC_Spells.Forgetfulness_2^/?z771;
!!SN&x6<2/x4=0:T^AC_Spells.Forgetfulness_3^/?z771;
!!SN:Iz771/?z771; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/61/m/z771;


!!SN&x6>2/x4=1:T^AC_Spells.Teleport_0^/?z773;
!!SN&x6=3/x4=0:T^AC_Spells.Teleport_1^/?z773;
!!SN&x6=2/x4=0:T^AC_Spells.Teleport_2^/?z773;
!!SN&x6<2/x4=0:T^AC_Spells.Teleport_3^/?z773;
!!SN:Iz773/?z773; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/63/m/z773;


!!VRy6&x6=0:S4; !!VRy6&x6=1:S5; !!VRy6&x6=2:S6; !!VRy6&x6=3:S7;
!!VRy65:S25;
!!VRy65&x3>0:+10;                       [with GM Water]
!!SN&x6>0/x4=1:T^AC_Spells.Clone_0^/?z775;
!!SN&x4=0:T^AC_Spells.Clone_1^/?z775;
!!SN:Iz775/?z775; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/65/m/z775;


!!VRy68:Sx2:2+10;
!!VRy68&x3>0:+10;                       [with GM Water]
!!VRz7:S^Water^; !!VRz7&x3>0:S^Ice^;
!!SN:T^AC_Spells.Water^/?z7;
!!SN&x3>0:T^AC_Spells.Ice^/?z7;
!!FU(Calc_Summoning_Power):Px1/68/?y10; [Pass Hero Number, Spell Number, Returns total Summoned HP]
!!SN&x9=1:W^Hero%X1_Summoning_Upgrade^/?y34; !!VRy34:*2;
!!SN&x6>0/x4=1:T^AC_Spells.Summon_Water_0^/?z778;
!!SN&x4=0:T^AC_Spells.Summon_Water_1^/?z778;
!!SN:W^SpellTrainerHero%X1_Spell66^/?y35;
!!SN&x9=1:T^AC_Spells.Trainer_HP_Casts_Sum^/?z1/^damage^/y34/^casts^/y35;
!!VRz778&x9=1:+z1; !!SN:Iz778/?z778; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/68/m/z778;



****************************************
!?FU(Earth_Spells_Improved_Description);
!!VRz6&x6=0/x4=0/x5=0:S^g^;             [Normal]
!!VRz6&x6=1/x4=0/x5=0:S^g^;             [Basic]
!!VRz6&x6=2/x4=0/x5=0:S^g^;             [Advanced]
!!VRz6&x6=3/x4=0/x5=0:S^g^;             [Expert]
!!VRz6&x6=3/x4=1/x5=0:S^DodgerBlue^;    [Master]
!!VRz6&x6=3/x4=1/x5=1:S^r^;             [Grandmaster]

!!SN&x6=0/x4=0/x5=0:T^AC_Spells.Spell_Normal^/?z5;
!!SN&x6=1/x4=0/x5=0:T^AC_Spells.Spell_Basic^/?z5;
!!SN&x6=2/x4=0/x5=0:T^AC_Spells.Spell_Advanced^/?z5;
!!SN&x6=3/x4=0/x5=0:T^AC_Spells.Spell_Expert^/?z5;
!!SN&x6=3/x4=1/x5=0:T^AC_Spells.Spell_Master^/?z5;
!!SN&x6=3/x4=1/x5=1:T^AC_Spells.Spell_Grandmaster^/?z5;

!!if&x6=0/x4=0/x5=0;                   [Means no rank]
!!VRz-6:S^^;                            [z-6 is female ending]
!!VRz-7:S^^;                            [z-7 is male ending]
!!VRz-8:S^^;                            [z-8 is plural ending]
!!VRz-9:S^^;                            [z-9 is neutral ending]
!!en;

!!if&x6=1/x4=0/x5=0;                   [Means Basic]
!!SN:T^AC_Spells.Basic_female^/?z-6;
!!SN:T^AC_Spells.Basic_male^/?z-7;
!!SN:T^AC_Spells.Basic_plural^/?z-8;
!!SN:T^AC_Spells.Basic_neutral^/?z-9;
!!en;

!!if&x6=2/x4=0/x5=0;                   [Means Advanced]
!!SN:T^AC_Spells.Advanced_female^/?z-6;
!!SN:T^AC_Spells.Advanced_male^/?z-7;
!!SN:T^AC_Spells.Advanced_plural^/?z-8;
!!SN:T^AC_Spells.Advanced_neutral^/?z-9;
!!en;

!!if&x6=3/x4=0/x5=0;                   [Means Expert]
!!SN:T^AC_Spells.Expert_female^/?z-6;
!!SN:T^AC_Spells.Expert_male^/?z-7;
!!SN:T^AC_Spells.Expert_plural^/?z-8;
!!SN:T^AC_Spells.Expert_neutral^/?z-9;
!!en;

!!if&x6=3/x4=1/x5=0;                   [Means Master]
!!SN:T^AC_Spells.Master_female^/?z-6;
!!SN:T^AC_Spells.Master_male^/?z-7;
!!SN:T^AC_Spells.Master_plural^/?z-8;
!!SN:T^AC_Spells.Master_neutral^/?z-9;
!!en;

!!if&x6=3/x4=1/x5=1;                   [Means Grandmaster]
!!SN:T^AC_Spells.Grandmaster_female^/?z-6;
!!SN:T^AC_Spells.Grandmaster_male^/?z-7;
!!SN:T^AC_Spells.Grandmaster_plural^/?z-8;
!!SN:T^AC_Spells.Grandmaster_neutral^/?z-9;
!!en;


**Earth
!!FU(ApplyRemoveSpellScaling):Px1/27/0/?y1/?y27; [Shield]
!!FU(ApplyRemoveSpellScaling):Px1/46/0/?y1/?y46; [Stone Skin]
!!FU(ApplyRemoveSpellScaling):Px1/54/0/?y1/?y54; [Slow]
!!FU(ApplyRemoveSpellScaling):Px1/67/0/?y1/?y67; [Earth Elemental]
!!FU(ApplyRemoveSpellScaling):Px1/33/0/?y1/?y33; [Protection from Earth]
!!FU(ApplyRemoveSpellScaling):Px1/50/0/?y1/?y50; [Sorrow]



!!VRy6&x6=0:S4; !!VRy6&x6=1:S4; !!VRy6&x6=2:S6; !!VRy6&x6=3:S8;
!!SN&x6>0/x4=1:T^AC_Spells.Quicksand_0^/?z120;
!!SN&x4=0:T^AC_Spells.Quicksand_1^/?z120;
!!SN:Iz120/?z120; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/10/m/z120;


!!VRy11&x6<=1:S2; !!VRy11&x6>1:S3;
!!SN&x6>0/x4=1:T^AC_Spells.Force_Field_0^/?z122;
!!SN&x4=0:T^AC_Spells.Force_Field_1^/?z122;
!!SN:Iz122/?z122; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/12/m/z122;


!!VRy7&x6=0:S2; !!VRy7&x6=1:S2; !!VRy7&x6=2:S3; !!VRy7&x6=3:S4;
!!VRy14:Sx2 *3 :10;                     [Chance is 15% +3% per 10SP]
!!VRy14:+15;
!!VRy14&y14>30:S30;
!!SN&x6>0/x4=1:T^AC_Spells.Earthquake_0^/?z124;
!!SN&x4=0:T^AC_Spells.Earthquake_1^/?z124;
!!SN:Iz124/?z124; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/14/m/z124;


!!VRy8:S2;
!!VRy8&x3=1:S4;
!!SN&x6>0/x4=1:T^AC_Spells.Implosion_0^/?z128;
!!SN&x4=0:T^AC_Spells.Implosion_1^/?z128;
!!SN&x9=1:W^SpellTrainerHero%X1_Spell18^/?y93; !!VRy93&x9=1:Sy93*x10;
!!SN&x9=1:T^AC_Spells.Trainer_Damage^/?z1/^damage^/y93;
!!VRz128&x9=1:+z1; !!SN:Iz128/?z128; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/18/m/z128;


!!VRy8:S2;
!!VRy8&x3=1:S4;
!!SN&x6>0/x4=1:T^AC_Spells.Meteor_0^/?z133;
!!SN&x4=0:T^AC_Spells.Meteor_1^/?z133;
!!SN&x9=1:W^SpellTrainerHero%X1_Spell23^/?y94; !!VRy94&x9=1:Sy94*x10;
!!SN&x9=1:T^AC_Spells.Trainer_Damage^/?z1/^damage^/y94;
!!VRz133&x9=1:+z1; !!SN:Iz133/?z133; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/23/m/z133;


!!SN&x6>0/x4=1:T^AC_Spells.Death_Ripple_0^/?z134;
!!SN&x4=0:T^AC_Spells.Death_Ripple_1^/?z134;
!!SN&x9=1:W^SpellTrainerHero%X1_Spell24^/?y95; !!VRy95&x9=1:Sy95*x10;
!!SN&x9=1:T^AC_Spells.Trainer_Damage^/?z1/^damage^/y95;
!!VRz134&x9=1:+z1; !!SN:Iz134/?z134; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/24/m/z134;

!!HEx1:A2/39/?y18/?y19;                 [Check for 39 Dragon Scale Shield ]
!!VRy71:Sx2 *10 +100;
!!VRy71&x3>0:Sx2 *15 +150;              [with GM Earth]
!!VRy71&y19=1:*2;                       [double effect with artifact equipped]
!!SN&x9=1:W^Hero%X1_Shield_Upgrade^/?y80; !!VRy27&x9=1:+y80; [Add Spell Trainer Effect]
!!HEx1:A2/41/?y18/?y19;                 [Check for 41 Dragonbone Greaves]
!!VRy27&y19=1:+5;                       [Add Artifact Effect]
!!SN&x6=3/x4=1:T^AC_Spells.Shield_0^/?z137;
!!SN&x6=3/x4=0:T^AC_Spells.Shield_1^/?z137;
!!SN&x6<3/x4=0:T^AC_Spells.Shield_2^/?z137;
!!SN:W^SpellTrainerHero%X1_Spell27^/?y81;
!!SN&x9=1:T^AC_Spells.Trainer_Damage_Reduction_Casts^/?z1/^damage^/y80/^casts^/y81;
!!VRz137&x9=1:+z1; !!SN:Iz137/?z137; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/27/m/z137;


!!VRy15:Sx2:2 +10;                      [+SP/2% +10% chance to shake off]
!!VRy15&x3>0:+20;                       [+20% chance with GM Earth]
!!VRy15&y15>=75:S75;                    [Cap at 75%]
!!SN&x9=1:W^Hero%X1_Protection_Upgrade^/?y71; !!VRy33&x9=1:+y71; Add Spell Trainer Effect
!!SN&x6=3/x4=1:T^AC_Spells.Earth_Protection_0^/?z483;
!!SN&x6=3/x4=0:T^AC_Spells.Earth_Protection_1^/?z483;
!!SN&x6<3/x4=0:T^AC_Spells.Earth_Protection_2^/?z483;
!!SN:W^SpellTrainerHero%X1_Spell30^/?y70;
!!SN&x9=1:T^AC_Spells.Trainer_Damage_Reduction_Casts^/?z1/^damage^/y71/^casts^/y70;
!!VRz483&x9=1:+z1; !!SN:Iz483/?z483; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/33/m/z483;


!!VRy9&x6=0:S2; !!VRy9&x6=1:S3; !!VRy9&x6=2:S4; !!VRy9&x6=3:S5;
!!SN&x4=1:T^AC_Spells.Anti_Magic_0^/?z484;
!!SN&x4=0:T^AC_Spells.Anti_Magic_1^/?z484;
!!SN:Iz484/?z484; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/34/m/z484;


!!FU(Count_Set_Pieces):Px1/0/0/0/0/0/?y90; [Check for Priest of Light Set]
!!SS38:P?y5;
!!SS38:Ex6/?y6;
!!VRy7:Sx2 *y5 +y6;
!!HEx1:X?y2/?y3;                        [check hero speciality]
!!if&y2=3/y3=38;                        [If Resurrection Specialist]
  !!HEx1:Ed/?y62/1;                     [Get Hero Level]
  !!VRy8:Sx2+y62*20;
  !!VRy7:+y8;                           [Add power from specialists]
!!en;
!!VRy7&y90>=5:*3:2;
!!SN&x9=1:W^Hero%X1_Resurrection_Upgrade^/?y82; !!VRy82&x9=1:*80; !!VRy7&x9=1:+y82; Add Spell Trainer Effect
!!SN&x6=3/x4=1:T^AC_Spells.Resurrection_0^/?z488;
!!SN&x6>1/x4=0:T^AC_Spells.Resurrection_1^/?z488;
!!SN&x6<2/x4=0:T^AC_Spells.Resurrection_2^/?z488;
!!SN:W^SpellTrainerHero%X1_Spell38^/?y83;
!!SN&x9=1:T^AC_Spells.Trainer_HP_Casts^/?z1/^damage^/y82/^casts^/y83;
!!VRz488&x9=1:+z1; !!SN:Iz488/?z488; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/38/m/z488;


!!FU(Count_Set_Pieces):Px1/0/0/0/0/0/0/?y90;  [Priest of the Dark Set Darzogs Armor]
!!VRy39:Sx2;
!!VRy80:S5;
!!VRy80&x3>0:S15;                       [with GM Earth]
!!SS39:P?y5;
!!SS39:Ex6/?y6;
!!VRy7:Sx2 *y5 +y6;
!!HEx1:X?y2/?y3;                        [check hero speciality]
!!if&y2=3/y3=39;                        [If Animate Specialist]
  !!HEx1:Ed/?y62/1;                     [Get Hero Level]
  !!VRy8:Sx2+y62*20;
  !!VRy7:+y8;                           [Add power from specialists]
!!en;
!!VRy7&y90>=5:*3:2;
!!SN&x9=1:W^Hero%X1_Animation_Upgrade^/?y84; !!VRy84&x9=1:*100; !!VRy7&x9=1:+y84; Add Spell Trainer Effect
!!SN&x4=1:T^AC_Spells.Animate_Dead_0^/?z489;
!!SN&x4=0:T^AC_Spells.Animate_Dead_1^/?z489;
!!SN:W^SpellTrainerHero%X1_Spell39^/?y85;
!!SN&x9=1:T^AC_Spells.Trainer_HP_Casts^/?z1/^damage^/y84/^casts^/y85;
!!VRz489&x9=1:+z1; !!SN:Iz489/?z489; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/39/m/z489;


!!SN&x9=1:W^Hero%X1_Stoneskin_Upgrade^/?y86; !!VRy46&x9=1:+y86; Add Spell Trainer Effect
!!SN&x6>0/x4=1:T^AC_Spells.Stone_Skin_0^/?z786;
!!SN&x6=3/x4=0:T^AC_Spells.Stone_Skin_1^/?z786;
!!SN&x6<3/x4=0:T^AC_Spells.Stone_Skin_2^/?z786;
!!SN:W^SpellTrainerHero%X1_Spell46^/?y87;
!!SN&x9=1:T^AC_Spells.Trainer_Defense_Casts^/?z1/^damage^/y86/^casts^/y87;
!!VRz786&x9=1:+z1; !!SN:Iz786/?z786; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/46/m/z786;


!!SN&x9=1:W^Hero%X1_Sorrow_Upgrade^/?y88; !!VRy50&x9=1:+y88; Add Spell Trainer Effect
!!SN&x6>0/x4=1:T^AC_Spells.Sorrow_0^/?z784;
!!SN&x6=3/x4=0:T^AC_Spells.Sorrow_1^/?z784;
!!SN&x6<3/x4=0:T^AC_Spells.Sorrow_2^/?z784;
!!SN:W^SpellTrainerHero%X1_Spell50^/?y89;
!!SN&x9=1:T^AC_Spells.Trainer_Morale_Casts^/?z1/^damage^/y88/^casts^/y89;
!!VRz784&x9=1:+z1; !!SN:Iz784/?z784; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/50/m/z784;


!!SN&x9=1:W^Hero%X1_Slow_Upgrade^/?y90; !!VRy54&x9=1:+y90; [Add Spell Trainer Effect]
!!HEx1:A2/56/?y18/?y19;                 [Check for 56 Dead Man's Boots]
!!VRy54&y19=1:+5;                       [Add Artifact Effect]
!!SN&x6>0/x4=1:T^AC_Spells.Slow_0^/?z785;
!!SN&x6=3/x4=0:T^AC_Spells.Slow_1^/?z785;
!!SN&x6<3/x4=0:T^AC_Spells.Slow_2^/?z785;
!!SN:W^SpellTrainerHero%X1_Spell54^/?y91;
!!SN&x9=1:T^AC_Spells.Trainer_Speed_Reduction_Casts^/?z1/^speed^/y90/^casts^/y91;
!!VRz785&x9=1:+z1; !!SN:Iz785/?z785; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/54/m/z785;


!!VRy67:Sx2:2+10;
!!VRy67&x3>0:+10;                       [with GM Earth]
!!SN:T^AC_Spells.Earth^/?z7;
!!SN&x3>0:T^AC_Spells.Magma^/?z7;
!!FU(Calc_Summoning_Power):Px1/67/?y10; [Pass Hero Number, Spell Number, Returns total Summoned HP]
!!SN&x9=1:W^Hero%X1_Summoning_Upgrade^/?y34; !!VRy34:*2;
!!SN&x4=1:T^AC_Spells.Summon_Earth_0^/?z777;
!!SN&x4=0:T^AC_Spells.Summon_Earth_1^/?z777;
!!SN:W^SpellTrainerHero%X1_Spell66^/?y35;
!!SN&x9=1:T^AC_Spells.Trainer_HP_Casts_Sum^/?z1/^damage^/y34/^casts^/y35;
!!VRz777&x9=1:+z1; !!SN:Iz777/?z777; !!VRm:Sx6 +(SPELL_TEXT_DESCR); !!SN:H^spell^/67/m/z777;
*end of spell description section


****************************************************************************************************
!?BF&1000;

!!DO(AC_Function_69)/0/41/1:P1;         [When Battle Starts Set Number of Shield Blocks to 1 for every Stack]

!?FU(AC_Function_69);

!!SN:W^H3_Shield_0_Block_Stack_%X16^/x1;[Normal Damage]
!!SN:W^H3_Shield_1_Block_Stack_%X16^/x1;[Magic Damage]
!!SN:W^H3_Shield_2_Block_Stack_%X16^/x1;[Free]


!?FU(AC_Function_73);                   [Save Spell Points change of Spells at Map start]

!!SSx16:C0/?y1; Normal   !!SN:W^H3_Normal_Spell_%X16_Cost^/y1;
!!SSx16:C1/?y1; Basic    !!SN:W^H3_Basic_Spell_%X16_Cost^/y1;
!!SSx16:C2/?y1; Advanced !!SN:W^H3_Advanced_Spell_%X16_Cost^/y1;
!!SSx16:C3/?y1; Expert   !!SN:W^H3_Expert_Spell_%X16_Cost^/y1;

!!SSx16:E0/?y1; Normal   !!SN:W^H3_Normal_Spell_%X16_Effect^/y1;
!!SSx16:E1/?y1; Basic    !!SN:W^H3_Basic_Spell_%X16_Effect^/y1;
!!SSx16:E2/?y1; Advanced !!SN:W^H3_Advanced_Spell_%X16_Effect^/y1;
!!SSx16:E3/?y1; Expert   !!SN:W^H3_Expert_Spell_%X16_Effect^/y1;


********************************************************************************
*[Scaling Magic]*
*a mod by Perry R and Alf with Cake*


!#UN:X?i/?j;
!#VRy1&i=36:S1;                         [Set 1 for S size]
!#VRy1&i=72:S2;                         [Set 2 for M size]
!#VRy1&i=108:S3;                        [Set 3 for L size]
!#VRy1&i=144:S4;                        [Set 4 for XL size]
!#VRy1&i>144:S5;                        [Set 5 for XXL size]
!#SN:W^Scaling_Magic_Map_Size^/y1;

!#SN:W^Scaling_Magic_Mod^/1;            [Scaling Magic Mod Active]

*------------------------------------------------------------------------------*
!?CM2&1000;                             [Show Spell level when right click on spell book]

!!FU:E;                                 [Disabled and moved to Spell Book]

!!CM:F?v3 I?v4 S?v5;                    [where we click and click subtype]

!!if&v3=512/v4=19;                      [if right click and specialty icon are clicked]
!!HE-1:N?y99;                           [Get current hero #]

!!HEy99:S14/?y81 S15/?y82 S16/?y83 S17/?y84 Fd/d/?y86/d S25/?y87; [Checke current hero  Fire14 Air15 Water16 Earth17 Magien und Sorcery(25)hat]
!!HEy99:S18/?y88 S7/?y89 S24/?y91 S8/?y92; [Checke current hero Scholar(18) and Wisdom[7] Intelligence[24] Mysticism [8]hat]

!!FU(Calc_Magic_Strength):Py99/?y86;

!!FU(ApplyRemoveSpellScaling):Py99/27/1/?y1/?y27; [Shield]
!!FU(ApplyRemoveSpellScaling):Py99/46/1/?y1/?y46; [Stone Skin]
!!FU(ApplyRemoveSpellScaling):Py99/54/1/?y1/?y54; [Slow]
!!FU(ApplyRemoveSpellScaling):Py99/67/1/?y1/?y67; [Earth Elemental]
!!FU(ApplyRemoveSpellScaling):Py99/33/1/?y1/?y33; [Protection from Earth]
!!FU(ApplyRemoveSpellScaling):Py99/50/1/?y1/?y50; [Sorrow]
!!FU(ApplyRemoveSpellScaling):Py99/41/1/?y1/?y41; [Bless]
!!FU(ApplyRemoveSpellScaling):Py99/45/1/?y1/?y45; [Weakness]
!!FU(ApplyRemoveSpellScaling):Py99/68/1/?y1/?y68; [Water Elemental]
!!FU(ApplyRemoveSpellScaling):Py99/32/1/?y1/?y32; [Protection from Water]
!!FU(ApplyRemoveSpellScaling):Py99/48/1/?y1/?y48; [Prayer]
!!FU(ApplyRemoveSpellScaling):Py99/49/1/?y1/?y49; [Mirth]
!!FU(ApplyRemoveSpellScaling):Py99/43/1/?y1/?y43; [Bloodlust]
!!FU(ApplyRemoveSpellScaling):Py99/42/1/?y1/?y42; [Curse]
!!FU(ApplyRemoveSpellScaling):Py99/29/1/?y1/?y29; [Fire Shield]
!!FU(ApplyRemoveSpellScaling):Py99/66/1/?y1/?y66; [Fire Elemental]
!!FU(ApplyRemoveSpellScaling):Py99/31/1/?y1/?y31; [Protection from Fire]
!!FU(ApplyRemoveSpellScaling):Py99/52/1/?y1/?y52; [Misfortune]
!!FU(ApplyRemoveSpellScaling):Py99/55/1/?y1/?y55; [Slayer]
!!FU(ApplyRemoveSpellScaling):Py99/44/1/?y1/?y44; [Precision]
!!FU(ApplyRemoveSpellScaling):Py99/28/1/?y1/?y28; [Air Shield]
!!FU(ApplyRemoveSpellScaling):Py99/51/1/?y1/?y51; [Fortune]
!!FU(ApplyRemoveSpellScaling):Py99/53/1/?y1/?y53; [Haste]
!!FU(ApplyRemoveSpellScaling):Py99/47/1/?y1/?y47; [Disrupting Ray]
!!FU(ApplyRemoveSpellScaling):Py99/69/1/?y1/?y69; [Air Elemental]
!!FU(ApplyRemoveSpellScaling):Py99/30/1/?y1/?y30; [Protection from Air]
!!FU(ApplyRemoveSpellScaling):Py99/58/1/?y1/?y58; [Counterstrike]
!!FU(ApplyRemoveSpellScaling):Py99/36/1/?y1/?y36; [Magic Mirror]

!!IF:M^           Spell Upgrades List:

{~Red}Magic Strength:%Y86{~}

{~Green}Earth{~}:
{Shield} Multiplier:*0.%Y27
{Stone Skin} Defense:+%Y46
{Slow} Multiplier:*0.%Y54
{Sorrow} Morale:-%Y50
{Summon Earth} Bonus:*%Y69
{Protec. Earth} Multiplier:*0.%Y33

{~Blue}Water{~}:
{Bless} Max. Damage:+%Y41
{Weakness} Attack:%Y45
{Prayer} Stats:+%Y48
{Mirth} Morale:+%Y49
{Summon Water} Bonus:*%Y68
{Protec. Water} Multipl.:*0.%Y32

{~Red}Fire{~}:
{Bloodlust} Attack:+%Y43
{Curse} Min. Damage:-%Y42
{Fire Shield} Reflected:%Y29%
{Misfortune} Luck:-%Y52
{Slayer} Attack:+%Y55
{Summon Fire} Bonus:*%Y66
{Protec. Fire} Multiplier:*0.%Y31

{~White}Air{~}:
{Haste} Speed:+%Y53
{Disrupting Ray} Defense:-%Y47
{Precision} Attack:+%Y44
{Fortune} Luck:+%Y51
{Air Shield} Multiplier:*0.%Y28
{Magic Mirror} Reflect:%Y36%
{Counterstrike} Retaliations:%Y58
{Summon Air} Bonus:*%Y67
{Protec. Air} Multiplier:*0.%Y30
^;

*!SN:T^AC_Spells.Spell Upgrades List^/?z2;
*!IF:M^%Z2^;

!!CM:R0;                                [disable default reaction]
!!en;


*------------------------------------------------------------------------------*
!?PI;
!!SN:W^Specialists_SP_Damage_spell_bonus^/125; [in percents]

!?BG0&1000;                             [Trigger Buff/Debuff Spells]

!!BG:H?y3;                              [Determine if AI controlls Hero]
!!HEy3:O?y3;
!!OW:Iy3/?y3;
!!FU&y3=1:E;

!!BG:A?y1;                              [Aktion in y1 must be Hero Cast]
!!FU&y1<>1:E;

!!BG:Q?y1;                              [Check Side]
!!BA:Hy1/?y99;                          [Check Hero Number]
!!FU&y99=-2:E;

!!HEy99:S14/?y81 S15/?y82 S16/?y83 S17/?y84 Fd/d/?y86/d S25/?y87; [Checke current hero  Fire14 Air15 Water16 Earth17 Magien und Sorcery(25)hat]
!!HEy99:S18/?y88 S7/?y89 S24/?y91 S8/?y92; [Checke current hero Scholar(18) and Wisdom[7] Intelligence[24] Mysticism [8]hat]

!!BG:S?y4;                              [Spell Number]
!!FU|y4<10/y4>69:E;
!!SN:W^Scaling_Magic_Spell_Number_^/y4; [Save Spell Number]

*-----------------------*  Mystic and Intelligence Specialist can increase Spell Power for additional Spell Points
!!HEy99:X?y11/?y12/d/d/d/d/d;
!!if&y11=0;                            [If SS Speci]
!!if|y12=8/y12=24;                     [If Mystic or Intelligence]
!!FU(Check_For_Valid_Spell):Py4/?y50;
!!if&y50>0;
!!UN:C6919200/4/?y1;                    [y1 - combatmanager]
!!VRy2:Sy1 +78532;                      [y2 - _ptr_ autoCombat]
!!UN:Cy2/1/?y3;                         [y3 - autoCombat status]
!!FU&y3=1:E;                            [Exit when Auto Combat]
!!BA:Q?y1;                              [Exit Quick Combat]
!!FU&y1=1:E;
!!FU(MSR_Determine_Spell_Type):Py4/0/0/?y13; [y22 Returns the Magic School of the Spell that was Cast  1Air  2Earth  4Fire  8Water   15Magic Arrow]
!!HEy99:I?y96/1;                        [Spell Points in y96]
!!SSy4&y13=1:Cy82/?y20;                 [Air                                                    [Determine Mana Cost by Spell School]
!!SSy4&y13=2:Cy84/?y20;                 [Earth]
!!SSy4&y13=4:Cy81/?y20;                 [Fire]
!!SSy4&y13=8:Cy83/?y20;                 [Water]
!!SSy4&y13=15:C0/?y20;                  [Magic Arrow]
!!VRy19:Sy20;
!!VRy20:*2;                             [Take Spell Cost times 2]
!!IF:V1/0;                              [Initzialize Flag 1 to zero]
!!if&y20<y96;                           [If double Spell Points is more than current Spell Points of the Hero]
!!SN:W^Specialists_SP_Damage_increase^/1;[calculate effect increase]

!!if&y50=1;                       [For damage spells]
!!FU(H3_Calc_Vanilla_Bonus_Spell_Damage):Py99/y4/?y3;
!!SN:W^Specialists_SP_Damage_spell_bonus^/?y5;
!!VRy2:Sy3 *y5 :100;
!!en;

!!if|y50=2/y50=3;                 [For stat spells]
!!FU(ApplyRemoveSpellScaling):Py99/y4/0/?y1/?y2;
!!SN:W^Specialists_SP_Damage_increase^/0;
!!FU(ApplyRemoveSpellScaling):Py99/y4/0/?y1/?y3;
!!en;

!!if&y50=4;                       [For summon spells]
!!FU(Calc_Summoning_Power):Py99/y4/?y2;
!!SN:W^Specialists_SP_Damage_increase^/0;
!!FU(Calc_Summoning_Power):Py99/y4/?y3;
!!en;

!!VRy2:-y3;
!!VRz3:S^^;
!!SN&y50=1:T^AC_Misc.Cast Damage^/?z3;
!!SN&y50=2:T^AC_Misc.Cast Percentage^/?z3;
!!SN&y50=3:T^AC_Misc.Cast Stat^/?z3;
!!SN&y50=4:T^AC_Misc.Cast Summon^/?z3;
!!SN:Iz3/?z3;
!!if&y2=0;
!!SN:T^AC_Misc.Failed Spend Spell Points^/?z2 Iz2/?z2;
!!IF&1000/999:Q1/9/y4/1/z2;
!!SN:W^Specialists_SP_Damage_increase^/0;
!!en;
!!if&y2>0;
!!SN:T^AC_Misc.Spend Spell Points^/?z2 Iz2/?z2;
!!IF&1000/999:Q1/9/y4/2/z2;
!!SN&1:W^Specialists_SP_Damage_increase^/1; [Set Flag to true if Player agreed to buff Spell]
!!SN&-1:W^Specialists_SP_Damage_increase^/0;
!!en;
!!en;
!!en;
!!en;
!!en;

*---------------------*

!!FU(ApplyRemoveSpellScaling):Py99/y4/1/?y1/?y2;
!!SSy4:Ey1/y2;                          [Set new Spell Value]

!!VRy19&1:*-1;
!!HEy99&1:Idy19/1;                      [Reduce Mana Pool]
!!HEy99&1:I?y96/1;
!!HEy99&y96<0/1:I0/1;

!!SN:W^Scaling_Magic_Flag^/1;           [Set Flag]

*!IF:M^%Y11 SpecialSchool%Y12 and Spell:%Y4 and School_from_Spell %Y13 and Manacost%Y20 and Hero Mana %Y96  Flag 1 is %F1^;

*------------------------------------------------------------------------------*
!?BG1&1000;                             [After Action Reset Spell Value to old                        [Trigger Buff/Debuff Spells]

!!SN:W^Scaling_Magic_Flag^/?y1;
!!FU&y1<>1:E;

!!BG:H?y3;                              [Determine if AI controlls Hero]
!!HEy3:O?y3;
!!OW:Iy3/?y3;
!!FU&y3=1:E;

!!BG:Q?y1;
!!BA:Hy1/?y99;
!!FU&y99=-2:E;

!!SN:W^Scaling_Magic_Spell_Number_^/?y4;

!!FU(ApplyRemoveSpellScaling):Py99/y4/-1/?y1/?y2;

!!SSy4:Ey1/y2;

!!SN:W^Scaling_Magic_Spell_Number_^/0;
!!SN:W^Scaling_Magic_Flag^/0;
!!SN:W^Specialists_SP_Damage_increase^/0;


********************************************************************************
!?FU(CalcSpellScaling);
x1=hero id, x2 - spell id, x3 - return how much effect will be added.

!!FU(Calc_Magic_Strength):Px1/?y1;      [Get MS of hero in y1]
!!VRx3:S0;

*Code to add Magic Strength based on spell school, as the orbs do. EG Earth spells are cast with +5 MS
This MS will not show in your bonus list and the bonus is only given in the visibility in the spell book
79  Orb of the Firmament
80  Orb of Silt
81  Orb of Tempestuous Fire
82  Orb of Driving Rain 
!!SSx2:S?y2;                            [Get spell's magic school bits]
!!VRy3:Sy2:1%2;                         [air. If bits of this spell contain school of air magic, this will be equal to 1]
!!VRy4:Sy2:2%2;                         [fire]
!!VRy5:Sy2:4%2;                         [water]
!!VRy6:Sy2:8%2;                         [earth]

!!HEx1:A2/79/?y60/?y61;
!!VRy1&y61=1/y3=1:+5;                   [If Air Orb equppied and is air spell]

!!HEx1:A2/81/?y60/?y61;
!!VRy1&y61=1/y4=1:+5;                   [If Fire Orb equppied and is Fire spell]

!!HEx1:A2/82/?y60/?y61;
!!VRy1&y61=1/y5=1:+5;                   [If Water Orb equppied and is Water spell]

!!HEx1:A2/80/?y60/?y61;
!!VRy1&y61=1/y6=1:+5;                   [If Earth equppied and is Earth spell]


;Percentage spells
; Shield27, Air Shield28, 4 Protections from Element30-33, Magic Mirror36, Slow54.
; Fire Shield29 is special
!!if|x2=27/x2=28/x2=30/x2=31/x2=32/x2=33/x2=36;
!!VRx3&y1>=15:S3;
!!VRx3&y1>=20:S5;
!!VRx3&y1>=25:S8;
!!VRx3&y1>=30:S10;
!!VRx3&y1>=40:S12;
!!VRx3&y1>=50:S15;
!!VRx3&y1>=65:S17;
!!VRx3&y1>=85:S20;
!!VRx3&y1>=100:S25;
!!VRx3&y1>=110:Sy1*3:10-3;
!!VRx3&x3>=99/x2<>36:S99;               [max 99% for reduction spells]
!!VRx3&x3>=100/x2=36:S100;              [max 100% for Magic Mirror]
!!en;

; Slow54.
!!if&x2=54;
!!VRx3&y1>=15:S2;
!!VRx3&y1>=20:S4;
!!VRx3&y1>=25:S6;
!!VRx3&y1>=30:S8;
!!VRx3&y1>=35:S10;
!!VRx3&y1>=40:S12;
!!VRx3&y1>=50:S14;
!!VRx3&y1>=60:S16;
!!VRx3&y1>=70:S18;
!!VRx3&y1>=85:S20;
!!VRx3&y1>=100:S25;
!!VRx3&y1>=110:S30;
!!VRx3&y1>=120:S35;
!!VRx3&x3>=99:S99;                      [max 99% for reduction spells]
!!en;

!!if&x2=29;                            [Fire Shield]
!!VRx3&y1>=20:S2;
!!VRx3&y1>=25:S5;
!!VRx3&y1>=30:S8;
!!VRx3&y1>=40:S10;
!!VRx3&y1>=50:S12;
!!VRx3&y1>=65:S15;
!!VRx3&y1>=85:S17;
!!VRx3&y1>=100:S20;
!!VRx3&y1>=110:Sy1*3:10-10;
!!en;


;Attack/Defence
; Bloodlust43, Precision44, Weakness45, Stone Skin46, Disrupting Ray47, Slayer55
!!if|x2=43/x2=44/x2=45/x2=46/x2=47/x2=55;
!!VRx3&y1>=25:S1;
!!VRx3&y1>=30:S2;
!!VRx3&y1>=35:S3;
!!VRx3&y1>=45:S4;
!!VRx3&y1>=55:S5;
!!VRx3&y1>=70:S6;
!!VRx3&y1>=90:S7;
!!VRx3&y1>=105:S8;
!!VRx3&y1>=120:Sy1:10-3;
!!en;


;Damage
; Bless41, Curse42
!!if|x2=41/x2=42;
!!VRx3&y1>=25:S1;
!!VRx3&y1>=65:S2;
!!VRx3&y1>=105:S3;
!!VRx3&y1>=160:S4;
!!en;


;Morale/Luck/Retals
; Mirth49, Sorrow50, Fortune51, Misfortune52, Counterstrike58
!!if|x2=49/x2=50/x2=51/x2=52/x2=58;
!!VRx3&y1>=40:S1;
!!VRx3&y1>=70:S2;
!!VRx3&y1>=110:Sy1*3:100;
!!en;


;Haste53
!!if&x2=53;
!!VRx3&y1>=35:S1;
!!VRx3&y1>=45:S2;
!!VRx3&y1>=75:S3;
!!VRx3&y1>=110:Sy1:25;
!!en;

;Prayer48
!!if&x2=48;
!!VRx3&y1>=35:S1;
!!VRx3&y1>=55:S2;
!!VRx3&y1>=95:S3;
!!VRx3&y1>=130:Sy1:25;
!!en;


;Summons
; Summon Fire66, Summon Air67, Summon Water68, Summon Earth69
!!if|x2=66/x2=67/x2=68/x2=69;
!!VRx3&y1>=30:S1;
!!VRx3&y1>=50:Sy1:25;
!!en;


********************************************************************************
!?FU(GetSpellRank);
*x1 is hero id, x2 is spell id, x3=return rank (for example Basic 1 or Expert 3)

!!HEx1:S14/?y81 S15/?y82 S16/?y83 S17/?y84; [Get current hero Fire14 Air15 Water16 Earth17 Magics]
!!SSx2:S?y1;                            [Get spell's magic school bits]
!!VRy3:Sy1:1%2;                         [air. If bits of this spell contain school of air magic, this will be equal to 1]
!!VRy4:Sy1:2%2;                         [fire]
!!VRy5:Sy1:4%2;                         [water]
!!VRy6:Sy1:8%2;                         [earth]
!!VRy1:S0;
!!VRy1&y3=1/y82>y1:Sy82;                [air y3, y82]
!!VRy1&y4=1/y81>y1:Sy81;                [fire y4, y81]
!!VRy1&y5=1/y83>y1:Sy83;                [water y5, y83]
!!VRy1&y6=1/y84>y1:Sy84;                [earth y6, y84]
Now y1 has spell's highest magic school rank.
!!VRx3:Sy1;


********************************************************************************
!?FU(ApplyRemoveSpellScaling);          [Doesn't apply or remove scaling immideately, it just returns rank and effect to set.]
x1 - hero id; x2 - spell id; x3 - mode. -1 is remove, 1 - apply, 0 - print for descriptions; x4 - return spell school rank; x5 - return applied effect.

!!FU(CalcSpellScaling):Px1/x2/?y1;
!!FU(GetSpellRank):Px1/x2/?x4;
!!SSx2:Ex4/?x5;
!!VRy1|x2=27/x2=28/x2=30/x2=31/x2=32/x2=33/x2=54:*-1; [Reduction spells decrease multiplier.]
!!VRy1&x3=-1:*-1;                       [Remove mode decreases effect]
!!VRx5:+y1;
!!if&x3=0;
!!VRx5|x2=27/x2=28/x2=30/x2=31/x2=32/x2=33/x2=54:-100 *-1; [For descriptions change reduction spells values: (35% multiplier) to (100-35=65% reduction)]
!!en;


********************************************************************************
!?FU(Calc_Magic_Strength);

!!HEx1:S14/?y81 S15/?y82 S16/?y83 S17/?y84 Fd/d/?y86/d S25/?y87; [Checke current hero  Fire14 Air15 Water16 Earth17 Magien, SpellPower und Sorcery(25)hat]
!!HEx1:S18/?y88 S7/?y89 S24/?y91 S8/?y92;[Checke current hero Scholar(18) and Wisdom[7] Intelligence[24] Mysticism [8]hat]


*-----Special conditions which can change MS, like weeks, artifacts, spells, heroes etc...----*
!!SN:W^Magic_Week_Number^/?y99;
!!VRy86&y99=46:+20;                     [+20 Magic Strength if Special Week 46]

!!SN:W^Specialists_SP_Damage_increase^/?y1; [Intelligence and Mystic Specialists can increase MS]
!!VRy86&y1=1:+20;

!!HEx1:A2/57/?y15/?y16 A2/141/?y15/?y17;[57 Garniture of Interference +5 Magic Strength, Magic Wand +20 to MS]
!!VRy86&y16=1:+5;
!!VRy86&y17=1:+20;

!!FU(Count_Set_Pieces):Px1/0/?y18;      [Check for Elemental Unity Set, gives +3/+7 with three and four pieces]
!!VRy86&y18>=3:+3;
!!VRy86&y18=4:+7;

!!SN:W^Grandmaster_Mage_Hero%X1^/?y30;  [Gm Mage Channeling ability If Spell Points are abouve maximum increase MS by +15]
!!if&y30=1;
  !!FU(Intelligence_Set_Spell_Points):Px1/0/?y31/1; [Return Number of Max Possible Spell Points in y31 for the Hero and only check not set]
  !!HEx1:I?y32/1;                       [Get Current Heroes Spell Points]
  !!VRy33:Sy31*95:100;                  [Get 95% of max spell points]
  !!VRy86&y32>=y33:+15;                 [Increase MS by +15 is condition is true]
!!en;

!!FU(Check_Com_Masteries):Px1/?y40/0/0/?y41; [Pass Hero Number and return if Commander Mastery is enabled, and current class]
!!VRy86&y41=5/y40=1:+10;                [If Supporter and Mastery enabled +10 MS]
!!VRy86&y41=24/y40=1:+15;               [If Warden commander and Mastery enabled +15 MS]
!!SN:W^Commander_%X1_Ancient_Supporter^/?y1;
!!VRy56&y1=1:+10;                       [If Ancient Supporter Commander +10 MS]
*---------------------*

!!SN:W^H3_Sorcery_0_Hero%X1^/?y1; !!SN:W^H3_Sorcery_1_Hero%X1^/?y2;
!!VRy86&y87=1/y1=0/y2=0:+4;             [Basic Sorc gives +4 to scaling]
!!VRy86&y87=2/y1=0/y2=0:+6;             [Advanced Sorc gives +6 to scaling]
!!VRy86&y87=3/y1=0/y2=0:+8;             [Expert Sorc gives +8 to scaling]
!!VRy86&y87=3/y1=1/y2=0:+12;            [Master +12]
!!VRy86&y87=3/y1=1/y2=1:+16;            [GM +16]

!!SN:W^H3_Fire Magic_0_Hero%X1^/?y1; !!SN:W^H3_Fire Magic_1_Hero%X1^/?y2;
!!VRy86&y81=1/y1=0/y2=0:+2;             [Basic Fire Magic gives +2 to scaling]
!!VRy86&y81=2/y1=0/y2=0:+3;             [Advanced Fire Magic gives +3 to scaling]
!!VRy86&y81=3/y1=0/y2=0:+4;             [Expert Fire Magic gives +4 to scaling]
!!VRy86&y81=3/y1=1/y2=0:+6;             [Master +6]
!!VRy86&y81=3/y1=1/y2=1:+8;             [GM +8]

!!SN:W^H3_Air Magic_0_Hero%X1^/?y1; !!SN:W^H3_Air Magic_1_Hero%X1^/?y2;
!!VRy86&y82=1/y1=0/y2=0:+2;             [Basic Air Magic gives +2 to scaling]
!!VRy86&y82=2/y1=0/y2=0:+3;             [Advanced Air Magic gives +3 to scaling]
!!VRy86&y82=3/y1=0/y2=0:+4;             [Expert Air Magic gives +4 to scaling]
!!VRy86&y82=3/y1=1/y2=0:+6;             [Master +6]
!!VRy86&y82=3/y1=1/y2=1:+8;             [GM +8]

!!SN:W^H3_Water Magic_0_Hero%X1^/?y1; !!SN:W^H3_Water Magic_1_Hero%X1^/?y2;
!!VRy86&y83=1/y1=0/y2=0:+2;             [Basic Water Magic gives +2 to scaling]
!!VRy86&y83=2/y1=0/y2=0:+3;             [Advanced Water Magic gives +3 to scaling]
!!VRy86&y83=3/y1=0/y2=0:+4;             [Expert Water Magic gives +4 to scaling]
!!VRy86&y83=3/y1=1/y2=0:+6;             [Master +6]
!!VRy86&y83=3/y1=1/y2=1:+8;             [GM +8]

!!SN:W^H3_Earth Magic_0_Hero%X1^/?y1; !!SN:W^H3_Earth Magic_1_Hero%X1^/?y2;
!!VRy86&y84=1/y1=0/y2=0:+2;             [Basic Earth Magic gives +2 to scaling]
!!VRy86&y84=2/y1=0/y2=0:+3;             [Advanced Earth Magic gives +3 to scaling]
!!VRy86&y84=3/y1=0/y2=0:+4;             [Expert Earth Magic gives +4 to scaling]
!!VRy86&y84=3/y1=1/y2=0:+6;             [Master +6]
!!VRy86&y84=3/y1=1/y2=1:+8;             [GM +8]

!!SN:W^H3_Scholar_0_Hero%X1^/?y1; !!SN:W^H3_Scholar_1_Hero%X1^/?y2;
!!VRy86&y88=1/y1=0/y2=0:+3;             [Basic Scholar gives +3 to scaling]
!!VRy86&y88=2/y1=0/y2=0:+4;             [Advanced Scholar gives +4 to scaling]
!!VRy86&y88=3/y1=0/y2=0:+5;             [Expert Scholar gives +5 to scaling]
!!VRy86&y88=3/y1=1/y2=0:+6;             [Master +6]
!!VRy86&y88=3/y1=1/y2=1:+8;             [GM +8]

!!SN:W^H3_Wisdom_0_Hero%X1^/?y1; !!SN:W^H3_Wisdom_1_Hero%X1^/?y2;
!!VRy86&y89=1/y1=0/y2=0:+1;             [Basic Wisdom gives +1 to scaling]
!!VRy86&y89=2/y1=0/y2=0:+2;             [Advanced Wisdom gives +2 to scaling]
!!VRy86&y89=3/y1=0/y2=0:+3;             [Expert Wisdom gives +3 to scaling]
!!VRy86&y89=3/y1=1/y2=0:+5;             [Master +5]
!!VRy86&y89=3/y1=1/y2=1:+7;             [GM +7]

!!SN:W^H3_Intelligence_0_Hero%X1^/?y1; !!SN:W^H3_Intelligence_1_Hero%X1^/?y2;
!!VRy86&y91=1/y1=0/y2=0:+1;             [Basic Intelligence gives +1 to scaling]
!!VRy86&y91=2/y1=0/y2=0:+2;             [Advanced Intelligence gives +2 to scaling]
!!VRy86&y91=3/y1=0/y2=0:+3;             [Expert Intelligence gives +3 to scaling]
!!VRy86&y91=3/y1=1/y2=0:+5;             [Master +5]
!!VRy86&y91=3/y1=1/y2=1:+7;             [GM +7]

!!SN:W^H3_Mysticism_0_Hero%X1^/?y1; !!SN:W^H3_Mysticism_1_Hero%X1^/?y2;
!!VRy86&y92=1/y1=0/y2=0:+2;             [Basic Mysticism gives +2 to scaling]
!!VRy86&y92=2/y1=0/y2=0:+3;             [Advanced Mysticism gives +3 to scaling]
!!VRy86&y92=3/y1=0/y2=0:+4;             [Expert Mysticism gives +4 to scaling]
!!VRy86&y92=3/y1=1/y2=0:+5;             [Master +5]
!!VRy86&y92=3/y1=1/y2=1:+7;             [GM +7]

!!SN:W^H3_Eagle Eye_0_Hero%X1^/?y1; !!SN:W^H3_Eagle Eye_1_Hero%X1^/?y2;
!!VRy86&y1=1/y2=0:+2;                   [Master Eagle Eye]
!!VRy86&y1=1/y2=1:+3;                   [GM Eagle Eye]

!!SN:W^ACM_Reward_Magic_Strength_%X1^/?y2; [Add Bonus Magic Strength from ACM rewards]
!!VRy86:+y2;

!!SN:W^Scaling_Magic_Map_Size^/?y10;

!!VRy86&y10=1:*120:100;                 [+20% Bonus on S size map]
!!VRy86&y10=2:*110:100;                 [+10% Bonus on M size map]
!!VRy86&y10=3:+0;                       [0 penalty on L size map]
!!VRy86&y10=4:*85:100;                  [-15% penalty on XL size map]
!!VRy86&y10=5:*80:100;                  [-20% penalty on XXL size map]

!!SN:W^Spell_Trainer_Mod^/?y1;          [Spell Trainer option reduces your MS by 25%]
!!VRy86&y1=1:*75:100;

!!VRx2:Sy86;                            [Set MS to x2 for return]
!!VRx2&x2<1:S1;                         [Set Minimum to 1]

!?FU(Check_For_Valid_Spell);
!!VRx2:S0;
!!VRx2|x1=15/x1=16/x1=17/x1=18/x1=19/x1=20/x1=21/x1=22/x1=23/x1=24/x1=25/x1=26:S1; [Damaging spells]
!!VRx2|x1=27/x1=28/x1=30/x1=31/x1=32/x1=33/x1=36/x1=54:S2; [Percentage spells, no Fire Shield]
!!VRx2|x1=41/x1=42/x1=43/x1=44/x1=45/x1=46/x1=47/x1=48:S3; [Other stat spells]
!!VRx2|x1=49/x1=50/x1=51/x1=52/x1=53/x1=55:S3; [Other stat spells]
!!VRx2|x1=66/x1=67/x1=68/x1=69:S4;      [Summon spells]


****************************************************************************************************
*Fire Shield Rework*
!?MF1;
!!UN:C42149568/4/?y10;                  [Physical Damage]
!!MF:N?y4;                              [Damage receiving stack]

!!if|y10=4462398/y10=4456676;
  !!MF:F?y6;                              [Damage]
  !!BMy4:N?y20 H?y21 L?y22;               [Get Number and Life of Stack to calc real applied damage]
  !!VRy23:Sy20*y21 -y22;
  !!VRy6&y23<y6:Sy23;                     [If rest life of the stack is smaller than applied damage only set the rest life as new damage]

  !!SN:W^Damage_Fire_Shield^/y6;          [Save Physical Damage]

!!el&y10=4458589;                         [Exit if damage does not come from Fire Shield]

  ; Check if the target stack is possible to accept a hostile Fire Shield
  ; Replaced by Archer30's new implementation
  *!BG:N?y1 E?y2 Q?y3;
  *!MF:N?y4;                              [Damage receiving stack]

  *!BMy4:T?y80 F?i;
  *!VRi:&16384;                           [Check for Immunity vs Fire]
  *!VRy90:S0;
  *!VRy90&i>0:S1;                         [If Immune vs Fire Exit]

  *!VRy90|y80=27/y80=33/y80=55/y80=82/y80=83/y80=116/y80=117:S1;
  *!VRy90|y80=121/y80=151/y80=153/y80=155/y80=172/y80=195/y80=207/y80=209/y80=231/y80=251:S1;
  *!VRy90|y80=249/y80=289/y80=294:S1;

  *!MF&y90=1:E0;                          [Apply Zero Damage if Immune]
  *!MF&y90=1:F0;                          [Apply Zero Damage if Immune]
  *!FU&y90=1:E;                           [Exit]

  *Immune Creatures*
  27 Gold Dragon
  33 Iron Golem
  55 Arch Devil
  69 Ghost Dragon removed
  82 Red Dragon
  83 Black Dragon
  116 Gold Golem
  117 Diamond Golem
  121 Magic Elemental
  151 Diamond Dragon
  153 Antichrist
  155 Darkness Dragon
  172 Nightmare
  195 Hell Steed

  TUM Creatures
  207 Pure Diamond Dragon
  209 Steel Golems
  231 Black Dragons Upgrade
  251 Void Elemental
  249 Plasma Elemental
  289 Fire Paladin
  294 Vermin Bird

  !!BMi^acm_defendStack^:I?y3;          [DO NOT use MF:N here!]
  !!FU(ACM_GetActualStackSide):Pi^acm_attackStack^/?y30;
  !!FU(Fire_Shield_Calculation):Pi^battle_hero_%y3^/i^acm_attackStack^/i^acm_defendStack^/d/y30/i^Damage_Fire_Shield^/?y7/0/1;
  !!MF:Fy7;                             [Apply new Damage]
!!en;

; New implementation for skipping Fire Shield damage for spell immune creatures (except for Fire Immunity ones)
; by Archer30
; Ideally we should also manage Fire Shield damage under this hook, but it's possibly got overwritten by Amethyst
!?FU(ACM_CreateERMHook);
!#VA(setHook:x);

!!SN:E(setHook)/1/4335104/(ACM_OnGetFireShieldDamage);

!?FU(ACM_OnGetFireShieldDamage);
!#VA(hook:x);

!!UN:C(COMBAT_MANAGER)/(UNC_INT)/?(cmbMgr:y);

!!UN:C(hook)/(STRUCT_HOOK_CONTEXT_EBX)/4/?(stackStruct:y);
!!UN:C(stackStruct)/244/4/?(side:y);
!!VR(oppSide:y):S(side) X(TRUE);

; Check if the targeted stack can receive a hostile Fire Shield spell
!!SS(SPELL_FIRE_SHIELD):O?(savedSpellType:y) O-1;
!!SN:E5914512/(CALLCONV_THISCALL)/(cmbMgr)/(SPELL_FIRE_SHIELD)/(oppSide)/(stackStruct)/1/1; [can stack apply buff/debuff]
!!SS(SPELL_FIRE_SHIELD):O(savedSpellType);

!!if&v1<>(TRUE);
  !!SN:X?t/0;
  !!UN:C(hook)/(STRUCT_HOOK_CONTEXT_RET)/4/4335094;
!!en;


!?FU(Fire_Shield_Calculation);
*x1=Hero Number, x2=attacking stack, x3=damage receiving stack, x4=destination monster stack, x5=attacking side, x6=damage, x7=returns damage, x7=returns only magic damage, x9=State (1)Combat/Non-Combat(0)

!!VRx6::5;                              [20% of physical damage]

; Calculate custom Fire Shield damage (used by external scripts)
!!if&x9=1;
  !!BMx3:T?y30;
  !!FU(ACM_GetCustomFireShieldMultiplier):Py30/?y31;
  !!VRx6&y31>1:*y31;

  !!SN:W^ACM_Fire_Shield_Target_%i(acm_defendStack)^/?y50;[Check if Fire Shield was casted on that Stack]
!!en;

!!HEx1&x1>=0:F?y2/?y3/?y4/?y5;
!!VRy4&x1<0:S1;                         [Set Spell Power to 1 if no Hero]

!!HEx1&x1>=0:S14/?y10;                  [Fire Magic]
!!SN:W^H3_Fire Magic_0_Hero%X1^/?y11;
!!SN:W^H3_Fire Magic_1_Hero%X1^/?y12;
!!VRy17:S100;                           [Initial 100% damage]
!!VRy16:S25;                            [Initial flat damage]
!!VRy16&y10=0/y11=0/y12=0:S50;   !!VRy16&y10=1/y11=0/y12=0:S100;   !!VRy16&y10=2/y11=0/y12=0:S150;  !!VRy16&y10=3/y11=0/y12=0:S200; [Flat Damage from Basic and Expert Fire Magic]
!!VRy17&y10=3/y11=0/y12=0:S100;  !!VRy17&y10=3/y11=1/y12=0:S115;  !!VRy17&y10=3/y11=1/y12=1:S125;
!!VRy9:Sy4*15+y16*y17:100;              [Formula is 20%+(25+SP*15*Sorcery)]

!!VRy55:S0;
!!SN&x1>=0:W^Hero%X1_Fire Shield_Upgrade^/?y55; [Get Fire Shield Upgrade Counter]
!!VRy55:*50;                            [Fifty times damage per Upgrade]
!!VRy9:+y55;                            [Add damage from Spell Trainer]

!!HEx1&x1>=0:S25/?y10;                  [Sorcery]
!!SN:W^H3_Sorcery_0_Hero%X1^/?y11;
!!SN:W^H3_Sorcery_1_Hero%X1^/?y12;
!!VRy15:S100;
!!VRy15&y10=0/y11=0/y12=0:S100;  !!VRy15&y10=1/y11=0/y12=0:S110;  !!VRy15&y10=2/y11=0/y12=0:S120;  !!VRy15&y10=3/y11=0/y12=0:S130;  !!VRy15&y10=3/y11=1/y12=0:S140;  !!VRy15&y10=3/y11=1/y12=1:S150;
!!VRy9:*y15:100;                        [Formula is 20%+(25+SP*10*Sorcery)]

!!HEx1:A2/81/?y60/?y61;
!!VRy9&y61=1:*125:100;                  [+25% damage with Orb of Fire]

!!VRx8:Sy9;                             [Get only the additional Magic Damage without the physical part]
!!FU&x9=0:E;                            [Exit here if only damage for the spell book is wanted (Non Combat)]

!!VRy30:Sx6+y9;                         [Total Damage add Physical Damage]
!!VRy30|x1<0/y50=0:-y9;                 [If no Hero or Fire Shield was not cast damage is only 20%]
!!VRy30&y30<0:S0;

!!BMx3&x3>=0/x3<=41:G31/?y70/?y71 T?y80;[Check for Protection of Fire and creature type]

*!VRx5:-1 *-1;                          [Archer30: x5 is now the real attacker side so we don't have to reverse it]
!!BHx5:N?x1;                            [Hero Number]
!!if&x1>=0;                             [Resistance Calculation]
  !!HEx1:S26/?y10;
  !!SN:W^H3_Resistance_0_Hero%X1^/?y11;
  !!SN:W^H3_Resistance_1_Hero%X1^/?y12;
  !!VRy15:S100;
  !!VRy15&y10=0/y11=0/y12=0:S100;  !!VRy15&y10=1/y11=0/y12=0:S90;  !!VRy15&y10=2/y11=0/y12=0:S85;  !!VRy15&y10=3/y11=0/y12=0:S80;  !!VRy15&y10=3/y11=1/y12=0:S75;  !!VRy15&y10=3/y11=1/y12=1:S70;
  !!VRy30|y80<174/y80>191:*y15:100;     [Reduce damage if enemy hero has resistance but make exception for commanders]

  !!VRy40:S0R100;                       [Chance to avoid damage]
  !!VRy16:S0;
  !!VRy16&y10=0/y11=0/y12=0:S0;  !!VRy16&y10=1/y11=0/y12=0:S10;  !!VRy16&y10=2/y11=0/y12=0:S15;  !!VRy16&y10=3/y11=0/y12=0:S20;  !!VRy16&y10=3/y11=1/y12=0:S25;  !!VRy16&y10=3/y11=1/y12=1:S30;

  !!HEx1:A2/57/?y10/?y15; !!VRy16&y15=1:+10; [57 Garniture of Interference]
  !!HEx1:A2/58/?y10/?y15; !!VRy16&y15=1:+15; [58 Surcoat of Counterpoise]
  !!HEx1:A2/59/?y10/?y15; !!VRy16&y15=1:+20; [59 Boots of Polarity]
  !!VRy30&y40<=y16:S0;                  [Deal Zero Damage if Spell can be resisted]

  !!HEx1:A2/37/?y10/?y15; !!VRy30&y15=1:-50; [37 Quiet Eye of the Dragon -50 flat magic damage]
  !!HEx1:A2/39/?y10/?y15; !!VRy30&y15=1:-50; [39 Dragon Scale Shield -50 flat magic damage]
  !!HEx1:A2/43/?y10/?y15; !!VRy30&y15=1:-50; [43  Necklace of Dragonteeth -50 flat magic damage]
  !!VRy30&y30<0:S0;                     [Set zero if value is negative]
!!en;

!!BMx3&x3>=0/x3<=41:G31/?y70/?y71 T?y80;[Check for Protection of Fire and creature type]

!!if&y80>=174/y80<=191/x1>=0;           [If any commander check Magic Resistance and reduce damage accordingly]
  !!FU(ACM_Calc_Commander_Magic_Resistance):Px1/d/?y82; [Get value of Magic Resistance Golem Type from commander]
  !!VRy83:S100-y82;                     [Get correct value for calculation]
  !!VRy30:*y83:100;                     [Calc damage with MR reduction]
!!en;

!!VRy30&y70>0::2;                       [Half damage from Fire Shield if Protection is On]

!!VRx7:Sy30 F1/(INT_MAX);               [Transfer New damage]


!?BG0;                                  [Before Battle Action]
*Safe the stack that received the Fire Shield Spell
!!BG:S?y10 A?y20 N?y30 E?y40 D?y50;     [Spell Number and action type]
!!SN&y10=29/y20=1:W^ACM_Fire_Shield_Target_%Y40^/1; [Set Flag active]

!?FU(OnSetupBattlefield);

!!re y1/0/41;
!!SN:W^ACM_Fire_Shield_Target_%Y1^/0;   [Remove Flag before every combat]
!!en;


********************************************************************************
*Summoning Rework Spells by Remagic from Algor* modified by PerryR

** Summoning spells:
** - have a "standard" calculation formula (SP * a + b)
** - receive a 50% bonus if the hero has a sphere of the corresponding element.
** - do not have a restriction on summoning only one type of creature in battle.

!?FU(OnGameEnter);
!!UN:C5896327/1/235;                    [Disable type checking of called elemental]

// New Summon Elemental implementation
; by Archer30
!?FU(ACM_CreateERMHook);
!#VA(setHook:x);

!!SN:E(setHook)/1/5928230/(ACM_OnCombatElementalSummonCount);

!?FU(ACM_OnCombatElementalSummonCount); [This hook works with any summoning cast]
!#VA(hook:x);

!!BG:A?(action:y);
!!FU&(action)<>(BATTLE_ACTION_HERO_CAST):E;

; Exit if no hero on the side
!!FU&i^battle_hero_%i(battle_acting_side)^=(NO_HERO):E;

; Manage the spell only when the combination of spell id and summon type is correct
!!UN:C(hook)/(STRUCT_HOOK_CONTEXT_EBP)/4/?(ebp:y) C(ebp)/8/4/?(spellId:y);

!!VR(secSkill:y):S(NO_SKILL);
!!UN:C(ebp)/12/4/?(monId:y);

!!if&(spellId)=(SPELL_FIRE_ELEMENTAL)/(monId)=(MON_FIRE_ELEMENTAL);
  !!VR(secSkill:y):S(SKILL_FIRE_MAGIC);
!!el&(spellId)=(SPELL_EARTH_ELEMENTAL)/(monId)=(MON_EARTH_ELEMENTAL);
  !!VR(secSkill):S(SKILL_EARTH_MAGIC);
!!el&(spellId)=(SPELL_WATER_ELEMENTAL)/(monId)=(MON_WATER_ELEMENTAL);
  !!VR(secSkill):S(SKILL_WATER_MAGIC);
!!el&(spellId)=(SPELL_AIR_ELEMENTAL)/(monId)=(MON_AIR_ELEMENTAL);
  !!VR(secSkill):S(SKILL_AIR_MAGIC);
!!en;

!!FU&(secSkill)=(NO_SKILL):E;

!!VR(hero:y):Si^battle_hero_%i(battle_acting_side)^;

; Check if the elemental should be upgraded
!!UN:C(ebp)/20/4/?(spellLevel:y);

!!if&(spellLevel)>=(SKILL_EXPERT);
  !!HE(hero):S(secSkill)/?(realLevel:y);
  !!SN:Mi^acm_SkillNames_ArrayId^/(secSkill)/?(skillName:z);

  !!if&(realLevel)>=(SKILL_EXPERT)/i^H3_%(skillName)_0_Hero%(hero)^/i^H3_%(skillName)_1_Hero%(hero)^;
    !!FU(GetUpgradedMonster):P(monId)/?(upgMonId:y);
    !!VR(monId)&(upgMonId)>(NO_MON):S(upgMonId);
  !!en;
!!en;

; Get the HP to summon and calculate the number to summon
!!FU(Calc_Summoning_Power):Pi^battle_hero_%i(battle_acting_side)^/(spellId)/?(totalHp:y);

!!MA:P(monId)/?(baseHp:y);
!!VR(totalSummonCount:y):S(totalHp:y) :(baseHp);

!!if&(totalSummonCount)>0;
  !!VR(lostHp:y):S(totalHp:y) %(baseHp);
  !!VR(totalSummonCount)&(lostHp): +1;
!!en;

!!VR(totalSummonCount):F1/(INT_MAX);

; Set the date in the memory to summon
!!VR(monInfoOffset:y):S(monId) *116;
!!UN:C(hook)/(STRUCT_HOOK_CONTEXT_ESI)/4/(totalSummonCount:y) C(ebp)/12/4/(monId:y) C(ebp)/-28/4/(monInfoOffset:y); [set new mon count and id to summon and text]

!!VRi^acm_summonElementalSpell^:S(spellId);

!?FU(ACM_BattleStack_InitParams)&i^acm_summonElementalSpell^;
!#VA(stackId:x) (side:x);

!!VR(spellId:y):Si^acm_summonElementalSpell^;
!!VRi^acm_summonElementalSpell^:S(NULL);

!!SN&(spellId)=(SPELL_WATER_ELEMENTAL):W^Summoned_Water_Perk_%X2^/1; [If Water or Ice  Elemental was summoned Set Flag to 1]
!!SN&(spellId)=(SPELL_EARTH_ELEMENTAL):W^Summoned_Earth_Perk_%X2^/1; [If Earth or Magma Elemental was summoned Set Flag to 1]

!!BM(stackId)&(spellId)=(SPELL_FIRE_ELEMENTAL):M29/99/3;        [Apply 29 Fire Shield to Fire Elemental or Energy Elemental]
!!BM(stackId)&(spellId)=(SPELL_AIR_ELEMENTAL):Sd1;             [Apply +1 Speed to Air Elemental or Storm Elemental]


; Replaced by Archer's implementation. This implemtation doesn't handle spell book button and shadow correctly
!?BG0; 
!!FU:E;

!!BG:A?y1;
!!FU&y1<>1:E;
!!BG:S?y1 Q?y2;
!!FU|y1<66/y1>69:E;                     [Exit if Spell is not Summon]

*!VRy4&y1=66:S164;
*!VRy4&y1=67:S165;
*!VRy4&y1=68:S167;
*!VRy4&y1=69:S166;

112 Air Elemental    Creature Number
113 Earth Elemental
114 Fire Elemental
115 Water Elemental

66 Fire Elemental    Spell Number
67 Earth Elemental
68 Water Elemental
69 Air Elemental

!!BA:Hy2/?y5;
!!SN&y1=66:W^H3_Fire Magic_1_Hero%Y5^/?y30;    [Check for Grandmaster Fire]
!!SN&y1=67:W^H3_Earth Magic_1_Hero%Y5^/?y30;   [Check for Grandmaster Earth]
!!SN&y1=68:W^H3_Water Magic_1_Hero%Y5^/?y30;   [Check for Grandmaster Water]
!!SN&y1=69:W^H3_Air Magic_1_Hero%Y5^/?y30;     [Check for Grandmaster Air]

!!VRy4&y1=66:S114; !!VRy4&y1=66/y30=1:S129;    [Set Summoned Creature to Fire Elemental or Energy Elemental if Grandmaster]
!!VRy4&y1=67:S113; !!VRy4&y1=67/y30=1:S125;    [Set Summoned Creature to Earth Elemental or Magma Elemental if Grandmaster]
!!VRy4&y1=68:S115; !!VRy4&y1=68/y30=1:S123;    [Set Summoned Creature to Water Elemental or Ice Elemental if Grandmaster]
!!VRy4&y1=69:S112; !!VRy4&y1=69/y30=1:S127;    [Set Summoned Creature to Air Elemental or Storm Elemental if Grandmaster]

!!FU(Summoning_Rework6):Py1/0/y5/?y7;
!!SSy1:Cy7/?y9 Ey7/?y10 P?y11;
!!VRy9:*-1;

!!FU(Calc_Summoning_Power):Py5/y1/?y13; [Pass Hero Number, Spell Number, Returns total Summoned HP]

!!MA:Py4/?y20;
!!VRy21:Sy13 :y20 +1;

!!VRy22:Sy13 %y20 -y20 *-1;
!!VRy21&y22=0:-1;
; Fix summoning a stack with 0 hp
!!if&y22=y20;
  !!VRy21:-1;
  !!VRy22:S0;
!!en;
!!FU(Summoning_Rework1):Py4/y2/y21/?y18/y22;
!!BA:Q?f;
!!if&y18=0;
  !!BHy2:M1;
  !!HEy5:Idy9/1 B0/?z1;
*!UN&i^battle_isVisible^:N1/2/y1;
*!SN&i^battle_isVisible^:T^AC_Misc.Summon_1^/?z3;
*!VRz3&i^battle_isVisible^:Sz180000;
*!MM&i^battle_isVisible^:Sz3;
!!en;
!!BG:A0;


!?FU(Summoning_Rework1);
!!VRy1:Sx2 *21;
!!VRy2:Sy1 +20;
!!VRy3:S-1;
!!DO(Summoning_Rework2)/y1/y2/1:P?y3;
!!BA:Q?f;
!!if&y3=-1;
  !!SN&i^battle_isVisible^:T^AC_Misc.Summon_2^/?z3;
  !!MM&i^battle_isVisible^:Sz3;
  !!VRx4:S1;
  !!FU:E;
!!en;
!!VRv2:S0;
!!DO(Summoning_Rework3)/0/10/1:P0/x2;
!!if&v2>0;
  !!VRv2:-1;
  !!VRy4:S1Rv2;
  !!VRv2:S0;
  !!DO(Summoning_Rework3)/0/10/1:Py4/x2;
  !!BU:Sx1/x3/v2/x2/-1/1 Ev2/?y4;

  !!BMy4:Lx5;
  !!BMy4:F?i; !!VRi:|4194304; !!BMy4:Fi;[Add Summoning Flag]

  !!SN|x1=123/x1=115:W^Summoned_Water_Perk_%X2^/1; [If Water or Ice  Elemental was summoned Set Flag to 1]
  !!SN|x1=113/x1=125:W^Summoned_Earth_Perk_%X2^/1; [If Earth or Magma Elemental was summoned Set Flag to 1]

  !!BMy4|x1=114/x1=129:M29/99/3;        [Apply 29 Fire Shield to Fire Elemental or Energy Elemental]
  !!BMy4|x1=112/x1=127:Sd1;             [Apply +1 Speed to Air Elemental or Storm Elemental]
  !!VRz1&i^battle_isVisible^:S^SUMNELM^;
  !!SN&i^battle_isVisible^:Pz1;
  !!VRx4:S0;
  !!BU&i^battle_isVisible^:R;
!!el;
  !!SN&i^battle_isVisible^:T^AC_Misc.Summon_3^/?z3;
  !!MM&i^battle_isVisible^:Sz3;
  !!VRx4:S2;
  !!FU:E;
!!en;

!?FU(Summoning_Rework2);
!!BMx16:T?y1 N?y2;
!!FU|y1<>-1/y2<>0:E;
!!VRx1:Sx16;
!!VRx16:S100500;

!?FU(Summoning_Rework3);
!!VRi:Sx2 *13;
!!VRy1:Sx16 *17 +1 +i;
!!VRy1&y1=20:+1;
!!BU:Dy1/?y2 Oy1/?y3 Ey1/?y4;
!!VRv2&y2=-1/y3=0/y4=-1:+1;
!!if&x1>0/x1=v2;
  !!VRv2:Sy1;
  !!VRx16:S100500;
  !!BU&i^battle_isVisible^:R;
  !!FU:E;
!!en;
!!VRy1:+1;
!!BU:Dy1/?y2 Oy1/?y3 Ey1/?y4;
!!VRv2&y2=-1/y3=0/y4=-1:+1;
!!if&x1>0/x1=v2;
  !!VRv2:Sy1;
  !!VRx16:S100500;
  !!BU&i^battle_isVisible^:R;
  !!FU:E;
!!en;


!?PI;

!!DO(Summoning_Rework4)/0/196/1:P;
!?FU(Summoning_Rework4);
!!DO(Summoning_Rework5)/0/19/1:Px16;
!?FU(Summoning_Rework5);
!!EAx1:Bx16/?y2/?y3/?y4/d/d/d/d/d/d/d/d/d/d/d;
!!if|y3=74/y3=97/y3=99/y3=106/y3=112/y3=115;
  !!EAx1&y4>65/y4<70:Bx16/0/d/d/0/0/0/0/0/0/0/0/0/0/0;
!!en;


!?BG0; 

!!BG:A?y1;
!!FU&y1<>10:E;
!!BG:Q?y2 N?y3;
!!BMy3:T?y4 U4/?y1 E?y30;
!!FU|y1<66/y1>69/y4<174/y4>191/y30<1:E;
!!VRy4&y1=66:S114;
!!VRy4&y1=67:S113;
!!VRy4&y1=68:S115;
!!VRy4&y1=69:S112;
!!BA:Hy2/?y5; !!FU&y5<0:E;              [Fix for false commander check if no hero is present]
!!COy5:S4/?y6;
!!VRy7:S2;
!!BA:P?y11/?y12/?y13;
!!TRy11/y12/y13:G?y8;
!!VRy7&y8=46:S3;
!!VRy7&y1=69/y8=229:S3;
!!VRy7&y1=66/y8=226:S3;
!!VRy7&y1=68/y8=228:S3;
!!VRy7&y1=67/y8=231:S3;
!!HEy5:A2/79/?i/?y14 A2/80/?i/?y15 A2/81/?i/?y16 A2/82/?i/?y17;
!!VRy9:Sy6 +1 *y7;
!!VRy9&y1=66/y16>0:*5 :4;
!!VRy9&y1=67/y17>0:*5 :4;
!!VRy9&y1=68/y15>0:*5 :4;
!!VRy9&y1=69/y14>0:*5 :4;
!!FU(Summoning_Rework1):Py4/y2/y9/?y18/0;
!!if&y18=0;
  !!BG:A12;
  !!VRy30:-1;
  !!BMy3:Ey30;
!!en;

!?FU(Summoning_Rework6);
!!VRy10:S0;
!!HEx3&x2=1:P?y1/?y2/?y3;
!!BA&x2=0:P?y1/?y2/?y3;
!!TRy1/y2/y3:G?y4;
!!SSx1:S?y5;
!!VRy6:Sy5 &1;
!!VRy7:Sy5 &4;
!!VRy8:Sy5 &2;
!!VRy9:Sy5 &8;
!!HEx3:S15/?y11 S16/?y12 S14/?y13 S17/?y14;
!!VRy10&y6>0/y10<y11:Sy11;
!!VRy10&y7>0/y10<y12:Sy12;
!!VRy10&y8>0/y10<y13:Sy13;
!!VRy10&y9>0/y10<y14:Sy14;
!!VRy10&y4=46:S3;
!!VRy10&y6>0/y4=229:S3;
!!VRy10&y7>0/y4=228:S3;
!!VRy10&y8>0/y4=226:S3;
!!VRy10&y9>0/y4=231:S3;
!!VRx4:Sy10;


!?FU(Calc_Summoning_Power);
[Pass Hero Number, Spell Number, Returns total Summoned HP]

66 Fire Elemental
67 Earth Elemental
68 Water Elemental
69 Air Elemental

!!VRz1&x2=66:S^Fire^;  !!VRy2&x2=66:S14;
!!VRz1&x2=67:S^Earth^; !!VRy2&x2=67:S17;
!!VRz1&x2=68:S^Water^; !!VRy2&x2=68:S16;
!!VRz1&x2=69:S^Air^;   !!VRy2&x2=69:S15;

!!HEx1&x1>=0:Sy2/?y10 Ed/?y40/1;        [Check Fire Magic and Hero level]
!!SN:W^H3_%Z1 Magic_0_Hero%X1^/?y11;
!!SN:W^H3_%Z1 Magic_1_Hero%X1^/?y12;

!!VRy16&y10=0/y11=0/y12=0:S100;   !!VRy16&y10=1/y11=0/y12=0:S200;   !!VRy16&y10=2/y11=0/y12=0:S300;  !!VRy16&y10=3/y11=0/y12=0:S500; !!VRy16&y10=3/y11=1/y12=0:S750;  !!VRy16&y10=3/y11=1/y12=1:S1000; [Flat health from Basic until GM]
!!FU(Calc_Magic_Strength):Px1/?y90;
!!VRy20:S100;
!!VRy20&x2=69:S50; !!VRy20&x2=68:S100; !!VRy20&x2=66:S150; !!VRy20&x2=67:S200;

!!VRy9:Sy90*20+y16 *y20:100;            [Formula is (MS*20) * Spell Level Modifier 50% for Air 100% Water 150% Fire 200%Earth]

!!HEx1:A2/79/?i/?y24 A2/82/?i/?y25 A2/81/?i/?y26 A2/80/?i/?y27 A2/143/?i/?y28;
!!VRy9&x2=66/y26>0:*5 :4;               [+25% HP with Orbs]
!!VRy9&x2=67/y27>0:*5 :4;
!!VRy9&x2=68/y25>0:*5 :4;
!!VRy9&x2=69/y24>0:*5 :4;

*Summoner specialists, they increase HP by 125 +3*HeroLvL.
!!if|x1=88/x1=129;                      [88 Alamar and 129 Thunar]
  !!VRy42:Sy40*3+122;                   [HP increase is 125+3*Herolvl%]
  !!VRy9:*y42:100;                      [Set new total HP value]
!!en;

!!SN:W^Hero%X1_Summoning_Upgrade^/?y50;
!!VRy50:*2+100;                           [+2% HP per Spell Upgrade]
!!VRy9:*y50:100;
!!VRy9&y28>0:+1000;                     [+1000HP with the scroll of summoning]
!!VRx3:Sy9;                             [Return and pass HP value]


!?MF1;
!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676;[Only run when melee or shooting damage or Strikes all Enemies Around]

!!SN:W^Summoned_Water_Perk_0^/?y5;      [For Attacker Side 0]
!!SN:W^Summoned_Earth_Perk_0^/?y6;      [For Attacker Side 0]
!!SN:W^Summoned_Water_Perk_1^/?y7;      [For Defender Side 1]
!!SN:W^Summoned_Earth_Perk_1^/?y8;      [For Defender Side 1]
!!FU&y5=0/y6=0/y7=0/y8=0:E;             [Exit if no Summoning Flag is enabled]

!!BG:A?y1;                              [Aktion in y1]
!!if|y1=6/y1=7;
  !!BG:N?y1;                            [Attacking Stack]
  !!BG:E?y2;                            [Destination Stack]
  !!MF:N?y4;                            [Damage receiving stack]
  !!BMy4:I?y5;
  !!SN:W^Summoned_Earth_Perk_%Y5^/?y6;
  !!if&y6=1;
    !!MF:F?y10;                         [damage dealt]
    !!VRy11:Sy10*95:100;                [Reduce Damage by 5%]
    !!MF:Fy11;
  !!en;

  !!SN:W^Summon_Attacking_Stack^/?y50;
  !!VRy1&y4=y1/y50>=0/y50<=41:Sy50;     [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
  !!SN:W^Summon_Attacking_Stack^/y4;

  !!BMy1:I?y5;
  !!SN:W^Summoned_Water_Perk_%Y5^/?y6;
  !!if&y6=1;
    !!MF:F?y10;                         [damage dealt]
    !!VRy11:Sy10*105:100;               [Increase Damage by 5%]
    !!MF:Fy11;
  !!en;
!!en;
!!en;


!?FU(OnBattleRegeneratePhase)&1000;
!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]

!!SN:X?y1;                              [Event parameter]
!!BMy1:I?y2;                            [Acting Side Monster]
!!BA:Hy2/?y4;                           [Current Hero]
!!FU&y4<0:E;                            [Exit if none]
!!SN:W^Summoned_Water_Perk_0^/?y5;      [For Attacker Side 0]
!!SN:W^Summoned_Earth_Perk_0^/?y6;      [For Attacker Side 0]
!!SN:W^Summoned_Water_Perk_1^/?y7;      [For Defender Side 1]
!!SN:W^Summoned_Earth_Perk_1^/?y8;      [For Defender Side 1]
!!FU&y5=0/y6=0/y7=0/y8=0:E;             [Exit if no Summoning Flag is enabled]

!!SN:W^Summoned_Water_Perk_0^/0;        [For Attacker Side 0]
!!SN:W^Summoned_Earth_Perk_0^/0;        [For Attacker Side 0]
!!SN:W^Summoned_Water_Perk_1^/0;        [For Defender Side 1]
!!SN:W^Summoned_Earth_Perk_1^/0;        [For Defender Side 1]
!!DO(Check_Summon_Flags)/0/41/1:P;


!?FU(Check_Summon_Flags);

!!BMx16:N?y1;                           [Get Number of Creatures in y1]
!!FU&y1=0:E;

!!if&x16<21;
!!BMx16:T?y3;                           [Get Creature Number]
!!if|y3=113/y3=125;                    [Earth or Magma]
!!BMx16:F?y2;                           [Get Flag in y2]
!!VRy2:&4194304;                        [Check for Summoning Flag]
!!SN&y2>0:W^Summoned_Earth_Perk_0^/1;   [Enable Flag For Attacker Side 0 again]
!!en;
!!if|y3=115/y3=123;                    [Water or Ice]
!!BMx16:F?y2;                           [Get Flag in y2]
!!VRy2:&4194304;                        [Check for Summoning Flag]
!!SN&y2>0:W^Summoned_Water_Perk_0^/1;   [Enable Flag For Attacker Side 0 again]
*!IF:M^Now %Y3 Water %Y4^;
!!en;
!!en;

!!if&x16>20;
!!BMx16:T?y3;                           [Get Creature Number]
!!if|y3=113/y3=125;                    [Earth or Magma]
!!BMx16:F?y2;                           [Get Flag in y2]
!!VRy2:&4194304;                        [Check for Summoning Flag]
!!SN&y2>0:W^Summoned_Earth_Perk_1^/1;   [Enable Flag For Defender Side 1 again]
!!en;
!!if|y3=115/y3=123;                    [Water or Ice]
!!BMx16:F?y2;                           [Get Flag in y2]
!!VRy2:&4194304;                        [Check for Summoning Flag]
!!SN&y2>0:W^Summoned_Water_Perk_1^/1;   [Enable Flag For Defender Side 1 again]
!!en;
!!en;


Adapt the Summon Elementals Option by Archer30
The following lines must be executed later than the functions with the same name in 4 wog - summon elementals.erm

!?FU(WOG_74_GetSummonQty);
!#VA(hero:x) (spell:x) (level:x) (qty:x);

!!FU(Calc_Summoning_Power):P(hero)/(spell)/?(totalHp:y); [Pass Hero Number, Spell Number, Returns total Summoned HP]

!!MA:Pi^wog_74_mon_%(spell)^/?(hp:y);
!!VR(qty):S(totalHp) :(hp) +1;

; Fix quantity in particular cases
!!VR(lostHp:y):S(totalHp) %(hp) -(hp) *-1;
!!VR(qty)|(hp)=(lostHp)/(lostHp)=0:-1;

; Compatibility
!?FU(OnBeforeAdventureMagic)&i^wog_74_enabled^;
!!VRi^acm_isAdvMapSummonElem^:S(TRUE);

!?FU(OnAfterAdventureMagic)&i^acm_isAdvMapSummonElem^;
!!VRi^acm_isAdvMapSummonElem^:S(FALSE);

********************************************************************************


                 Reworked Magic Specialists Mod Section


a Mod by PerryR V.1.6
ERMS_ScriptAuthor=PerryR
********************************************************************************
**V-Vars used: v3,v4
**Z-Vars used:
**Function used: FU377879 -FU377885
**Flags used:

!#SN:W^Reworked_Magic_Specialists_Mod^/1;[Reworked_Magic_Specialists_Mod Set to active]
!#UN:P39/?y1;                           [Check if Hero Specialisation Boost ins enabled in WoG]
!_#IF&y1=0:M^Hero Specialisation Boost seems disabled. To keep balance the crit chance for unique spells and the 0.5% spell damage per level for magic heroes will be disabled. Have fun.^;


********************************************************************************[Set Speciality Description]
!?FU(OnHeroScreenMouseClick);
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]

!!if|v3=512/v3=0;                       [if right or left click]
!!HE-1:N?y6;                            [Get current hero #]

!!FU(ACM_GetDialogMessageType):Pi^mouse_action^/?y30;
!!FU(Set_Desc_Hero_Speciality):Py6/?y11/?y12/y30;
!!en;


********************************************************************************
!?BF;                                   [Prepare Battle]
!!BH0:N?y2;                             [For Attacker]
!!if&y2>=0;
  !!HEy2:X?y11/?y12/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
  !!SN&y11=0/y12=25:W^Magic_Specialists_Att_Spells_Saved^/1; [Set Saved Spells Flag true for Sorcery Specialists]
  !!DO(AC_Function_74)/10/69/1&y11=0/y12=25:Py2; [Remember Attacker Hero Spells Sorcery]

  !!if|y12=14/y12=15/y12=16/y12=17;
    !!DO(AC_Function_74)/10/69/1&y11=0:Py2; [Remember Attacker Hero Spells Fire, Air, Water, Earth Magic]
    !!SN&y11=0:W^Magic_Specialists_Att_Spells_Saved^/1; [Set Saved Spells Flag true for Sorcery Specialists]
  !!en;

    !!if&y11=3/y12>=13/y12<=39;         [If spell specialist and its damage spell increase spell counter]
      !!HEy2:Ed/?y4/1;                  [Get Hero Level]
      !!HEy2:My12/?y30;                 [Check if Hero acctually knows his spell to prevent blank spell book]
      !!if&y30=1;
        !!DO(AC_Function_74)/10/69/1:Py2;[Remember Attacker Hero Spells]
        !!SN:W^Magic_Specialists_Att_Spells_Saved^/1;

        !!VRy4&y12=15::7;               [Magic Arrow]
        !!VRy4&y12=16::8;               [Ice Bolt]
        !!VRy4&y12=20::10;              [Frost Ring]
        !!VRy4&y12=19::15;              [Chain Lighnting]
        !!VRy4&y12=22::13;              [Inferno]
        !!VRy4&y12=23::12;              [Meteor Shower]
        !!VRy4&y12=21::10;              [Fireball]
        !!VRy4&y12=24::15;              [Death Ripple]
        !!VRy4&y12=13::10;              [Fire Wall]
        !!VRy4&y12=17::10;              [Lightning Bolt]
        !!VRy4&y12=18::16;              [Implosion]
        !!VRy4&y12=38::12;              [Animate Dead]
        !!VRy4&y12=39::12;              [Resurrection]

        !!SN:W^Magic_Specialists_Att^/y4; 
        !!SN&y12=37:W^Magic_Specialists_Att^/0; [Fix set zero for Uland]
        *!FU(Save_Special_Spell_Mana_Cost):Py2/y12/0;                                   [Save Own Special Spell Attacker]
      !!en;
    !!en;
  !!en;

!!BH1:N?y3;
!!if&y3>=0;                             [For Defender]
  !!HEy3:X?y21/?y22/?y23/?y24/?y25/?y26/?y27; [Check Hero Speciality]
  *!FU(Save_Special_Spell_Mana_Cost):Py3/y12/0;                                   [Save Special Spell from Attacker for Defender]
  !!SN&y21=0/y22=25:W^Magic_Specialists_Def_Spells_Saved^/1;
  !!DO(AC_Function_74)/10/69/1&y21=0/y22=25:Py3; [Remember Defender Hero Spells Sorcery]

  !!if|y22=14/y22=15/y22=16/y22=17;
    !!DO(AC_Function_74)/10/69/1&y21=0:Py3; [Remember Attacker Hero Spells Fire, Air, Water, Earth Magic]
    !!SN&y21=0:W^Magic_Specialists_Def_Spells_Saved^/1;
  !!en;

    !!if&y21=3/y22>=13/y22<=39;         [If spell specialist and its damage spell increase spell counter]
      !!HEy3:Ed/?y5/1;                  [Get Hero Level]
      !!HEy3:My22/?y31;                 [Check if Hero acctually knows his spell to prevent blank spell book]
      !!if&y31=1;
        !!DO(AC_Function_74)/10/69/1:Py3;[Remember Defender Hero Spells]
        !!SN:W^Magic_Specialists_Def_Spells_Saved^/1;
        !!VRy5&y22=15::7;               [Magic Arrow]
        !!VRy5&y22=16::8;               [Ice Bolt]
        !!VRy5&y22=20::10;              [Frost Ring]
        !!VRy5&y22=19::15;              [Chain Lighnting]
        !!VRy5&y22=22::13;              [Inferno]
        !!VRy5&y22=23::12;              [Meteor Shower]
        !!VRy5&y22=21::10;              [Fireball]
        !!VRy5&y22=24::15;              [Death Ripple]
        !!VRy5&y22=13::10;              [Fire Wall]
        !!VRy4&y22=17::10;              [Lightning Bolt]
        !!VRy4&y22=18::16;              [Implosion]
        !!VRy4&y12=38::12;              [Animate Dead]
        !!VRy4&y12=39::12;              [Resurrection]

        !!SN:W^Magic_Specialists_Def^/y5;[Extra Cast Variable Defender Set 1]
        !!SN&y12=37:W^Magic_Specialists_Def^/0; [Fix set zero for Uland]
        *!FU(Save_Special_Spell_Mana_Cost):Py3/y22/1;                                   [Save Own Special Spell Defender]
      !!en;
    !!en;
  !!en;


********************************************************************************
!?FU(OnAfterBattleUniversal);           [Give Back Hero Spells after Fight]

!!BA:H0/?y2;                            [For Attacker]
!!SN:W^Magic_Specialists_Att_Spells_Saved^/?y1;
!!if&y2>=0/y1=1;
  !!DO(AC_Function_75)/10/69/1:Py2/1;   [Give Back Hero Spells Function]
  !!DO(AC_Function_76)/86/89/1:Py2/2;   [Give Back Hero Spells Function Books]
  !!DO(AC_Function_76)/1011/1070/1:Py2/2;[Give Back Hero Spells Function Scrolls]
  !!DO(AC_Function_77)/10/69/1:Py2;     [Reset Book Spells Vars]
  *!FU(Restore_Special_Spell_Mana_Cost):Py2;                                      [Reset Special Spell Mana Cost Attacker]
  !!HEy2:A2/128/?y10/?y11;
  !!HEy2&y11=1:A3/128/1/1;
  !!HEy2&y11=1:A4/128;                  [Reequip Armageddon Blade after fight]
  !!HEy2&y11=1:Fd-3/d-3/d-3/d-6;        [Reduce Stats to compensate for AM stats]
  !!HEy2:A2/124/?y10/?y11;
  !!HEy2&y11=1:A3/124/1/1;
  !!HEy2&y11=1:A4/124;                  [Reequip 124 Spellbinder's Hat  after fight]
!!en;

!!BA:H1/?y3;                            [For Defender]
!!SN:W^Magic_Specialists_Def_Spells_Saved^/?y1;
!!if&y3>=0/y1=1;
  !!DO(AC_Function_75)/10/69/1:Py3/1;   [Give Back Hero Spells Function]
  !!DO(AC_Function_76)/86/89/1:Py3/2;   [Give Back Hero Spells Function Books]
  !!DO(AC_Function_76)/1011/1070/1:Py3/2;[Give Back Hero Spells Function Scrolls]
  !!DO(AC_Function_77)/10/69/1:Py3;     [Reset Book Spells Vars]
  *!FU(Restore_Special_Spell_Mana_Cost):Py3;                                      [Reset Special Spell Mana Cost]
  !!HEy3:A2/128/?y10/?y11;
  !!HEy3&y11=1:A3/128/1/1;
  !!HEy3&y11=1:A4/128;                  [Reequip Armageddon Blade after fight]
  !!HEy3&y11=1:Fd-3/d-3/d-3/d-6;        [Reduce Stats to compensate for AM stats]
  !!HEy3:A2/124/?y10/?y11;
  !!HEy3&y11=1:A3/124/1/1;
  !!HEy3&y11=1:A4/124;                  [Reequip 124 Spellbinder's Hat  after fight]
!!en;

!!SN:W^Magic_Specialists_Att^/0;        [Reset extra Cast at Battle End]
!!SN:W^Magic_Specialists_Def^/0;
!!SN:W^Sorcery_Specialists_Cast_Counter^/0;
!!SN:W^Elemental_Specialists_Cast_Counter^/0;
!!SN:W^Magic_Specialists_Def_Spells_Saved^/0;
!!SN:W^Magic_Specialists_Att_Spells_Saved^/0;
!!DO(AC_Function_78)/0/99/1:P;          [Reset Cast Counter at Battle End]


********************************************************************************
!?BR&v997>=1/1000;

!!BH0:N?y2;                             [For Attacker]
!!SN:W^Magic_Specialists_Att_Spells_Saved^/?y1;
!!if&y2>=0/y1=1;
!!DO(AC_Function_75)/10/69/1:Py2;       [Give Back Hero Spells Function]
*!FU(Restore_Special_Spell_Mana_Cost):Py2;                                      [Reset Special Spell Mana Cost]
!!en;

!!BH1:N?y3;                             [For Defender]
!!SN:W^Magic_Specialists_Def_Spells_Saved^/?y1;
!!if&y3>=0/y1=1;
!!DO(AC_Function_75)/10/69/1:Py3;       [Give Back Hero Spells Function]
*!FU(Restore_Special_Spell_Mana_Cost):Py3;                                      [Reset Special Spell Mana Cost]
!!en;


********************************************************************************
!?BG0&1000;

!!BA:Q?y1;                              [Exit if Quick Combat]
!!FU&y1=1:E;

!!BG:Q?y1;
!!SN&y1=0:W^Double_Cast_Attacker^/?y4;
!!SN&y1=1:W^Double_Cast_Defender^/?y4;
!!SN&y1=0:W^Magic_Week_34_att^/?y2;
!!SN&y1=1:W^Magic_Week_34_def^/?y2;
!!SN&y1=0:W^Magic_Week_41_att^/?y3;
!!SN&y1=1:W^Magic_Week_41_def^/?y3;
!!SN:W^Magic_Week_Spell_Element^/?y5;
!!SN&y1=0:W^Elemental_Set_att^/?y6;
!!SN&y1=1:W^Elemental_Set_def^/?y6;
!!SN&y1=0:W^Master_Mage_Extra_Cast_att^/?y7;
!!SN&y1=1:W^Master_Mage_Extra_Cast_def^/?y7;
!!SN&y1=0:W^Special_Hero_Extra_Cast_Att^/?y8;
!!SN&y1=1:W^Special_Hero_Extra_Cast_Def^/?y8;

*!IF:M^Eins %Y4 und %Y2 und %Y3 und %Y5 und %Y6 und %Y7^;

!!if&y4=0/y2=0/y3=0/y5=0/y6=0/y7=0/y8=0;[fix with Double Cast mod and Magic Week 34,41 37,38,39,40 and Wizards Knowledge]

!!BG:Q?y1;                              [Acting Side]
!!BHy1:N?y2;                            [Hero Number]
!!BG:S?y3;                              [Spell Number]
!!BG:A?y20;                             [Aktion]
!!if&y3>=10/y3<=69/y20=1;

!!HEy2&y2>-1:X?y5/?y6/?y7/?y8/?y9/?y10/?y11; [Check Hero Speciality]
!!if&y5=3/y6>=13/y6<=39;                [If spell specialist and its damage spell increase spell counter]
!!SN&y1=0:W^Magic_Specialists_Att^/?y4; [Extra Cast Variable Attacker]
!!SN&y1=1:W^Magic_Specialists_Def^/?y4; [Extra Cast Variable Defender]

!!DO(AC_Function_79)/10/69/1&y5=3/y4>0/y3<>y6:Py2/y3/y6; [Remove Hero Spells Fkt if Spell was not Specialist Spell]

!!if&y3=y6;                             [Extra Mana Cost Handling]
*!SN&y1=0:W^Magic_Specialists_%V997_Cast_Count_Att^/d1;   [Increase Battle Round Special Spell Cast Counter by 1]
*!SN&y1=1:W^Magic_Specialists_%V997_Cast_Count_Def^/d1;
!!en;
!!en;
!!en;
!!en;

**************Some Heroes will get extra cast to bring them on level with other strong multicast Heroes**********
!?BF;

!!SN:W^Special_Hero_Extra_Cast_Att^/0;  [Reset Extra Cast Counter before any Battle]
!!SN:W^Special_Hero_Extra_Cast_Def^/0;

!!BA:H0/?y1;                            [Defender]
!!FU(ACM_Setting_Multicast_Heroes):Py1/1;

!!BA:H1/?y1;                            [Attacker]
!!FU(ACM_Setting_Multicast_Heroes):Py1/2;


!?FU(ACM_Setting_Multicast_Heroes);
x1=Hero ID, x2 Att(1)/Def(2) Hero,

10 Cuthbert, 25 Uland, 59 Olema, 61 Ash, 77 Xsi, 95 Darkstorn, 108 Zubin, 120 Mirlanda, 139 Labetha
!!if|x1=10/x1=25/x1=59/x1=61/x1=77/x1=95/x1=108/x1=120/x1=139; [Hero ID]
  !!HEx1:E?y2/?y3/1;
  !!SN&x2=1/y3>=5:W^Special_Hero_Extra_Cast_Att^/1; [Give one Extra Cast for Level 5]
  !!SN&x2=2/y3>=5:W^Special_Hero_Extra_Cast_Def^/1; [Give one Extra Cast for Level 5]
!!en;

9 Adela, 14 Loynis, 24 Coronius, 33 Thane, 40 Astral, 46 Cyra, 63 Xarfax, 107 Terek, 137 Brissa
!!if|x1=9/x1=14/x1=24/x1=33/x1=40/x1=46/x1=63/x1=107/x1=137; [Hero ID]
  !!HEx1:E?y2/?y3/1;
  !!SN&x2=1/y3>=10:W^Special_Hero_Extra_Cast_Att^/1; [Give one Extra Cast for Level 10]
  !!SN&x2=2/y3>=10:W^Special_Hero_Extra_Cast_Def^/1; [Give one Extra Cast for Level 10]
!!en;


!?BG1;

!!BA:Q?y1;                              [Exit if Quick Combat]
!!FU&y1=1:E;
!!BA:Q?f;

!!BG:Q?y1;
!!SN&y1=0:W^Double_Cast_Attacker^/?y4;
!!SN&y1=1:W^Double_Cast_Defender^/?y4;
!!SN&y1=0:W^Magic_Week_34_att^/?y2;
!!SN&y1=1:W^Magic_Week_34_def^/?y2;
!!SN&y1=0:W^Magic_Week_41_att^/?y3;
!!SN&y1=1:W^Magic_Week_41_def^/?y3;
!!SN:W^Magic_Week_Spell_Element^/?y5;
!!SN&y1=0:W^Elemental_Set_att^/?y6;
!!SN&y1=1:W^Elemental_Set_def^/?y6;
!!SN&y1=0:W^Master_Mage_Extra_Cast_att^/?y7;
!!SN&y1=1:W^Master_Mage_Extra_Cast_def^/?y7;
!!SN&y1=0:W^Magic_Specialists_Att^/?y8; [Check Cast Variable Attacker]
!!SN&y1=1:W^Magic_Specialists_Def^/?y8; [Check Cast Variable Defender]

!!if&y4=0/y2=0/y3=0/y5=0/y6=0/y7=0/y8=0;[fix with Double Cast mod and Magic Week 34,41 37,38,39,40 and Wizards Knowledge]
  !!SN&y1=0:W^Special_Hero_Extra_Cast_Att^/?y2; [Check Cast Variable Attacker]
  !!SN&y1=1:W^Special_Hero_Extra_Cast_Def^/?y2; [Check Cast Variable Defender]
  !!FU&y2<=0:E;
  !!BHy1:M?y3;
  !!FU&y3=0:E;
  !!BHy1:M0;                            [Renable Cast]

  !!SN:T^AC_Misc.Specialists Extra Cast^/?z-1;
  !!BU&i^battle_isVisible^:Mz-1;
  !!VRz1:S^FORTUNE^;
  !!SN&i^battle_isVisible^:Pz1;
  !!SN&y1=0:W^Special_Hero_Extra_Cast_Att^/d-1; [Decrease Extra Cast Counter]
  !!SN&y1=1:W^Special_Hero_Extra_Cast_Def^/d-1;  
  !!SN&y1=0:W^Magic_Specialists_%V997_Cast_Count_Att^/d1; [Increase Battle Round Special Spell Cast Counter by 1]
  !!SN&y1=1:W^Magic_Specialists_%V997_Cast_Count_Def^/d1;
!!en;



********************************************************************************
!?FU(OnBattleRegeneratePhase);          [Set Spell Points and Reset Spell Points]

!!FU:E;                                 [Disabled Mana Cost increase for Special Spells]
!!SN:X?y1/?y2/0;                        [get who moves]
!!VRy2:Sy1:21;                          [get side]
!!BHy2:N?y1;                            [get owner]

!!if&y1>=0;
!!FU(Restore_Special_Spell_Mana_Cost):Py1/0; [Reset Special Spell Mana Cost]
!!FU(Restore_Special_Spell_Mana_Cost):Py1/1; [Reset Special Spell Mana Cost]

!!SN&y2=0:W^Magic_Specialists_%V997_Cast_Count_Att^/?y77;
!!SN&y2=1:W^Magic_Specialists_%V997_Cast_Count_Def^/?y77;
!!VRy77:+1;                             [Add +1 for correct Mana increase]

!!HEy1:X?y5/?y6/?y7/?y8/?y9/?y10/?y11;  [Check Hero Speciality]

!!if&y5=3/y6>=13/y6<=26;                [If spell specialist and its damage spell increase spell counter]

!!HEy1:S14/?y30 S15/?y31 S16/?y32 S17/?y33; [Checke current hero  Fire14 Air15 Water16 Earth17 Magien]

!!VRy12|y6=17/y6=19/y6=25:S1;           [Air]
!!VRy12|y6=18/y6=23/y6=24:S2;           [Earth]
!!VRy12|y6=21/y6=22/y6=26:S4;           [Fire]
!!VRy12|y6=16/y6=20:S8;                 [Water]
!!VRy12&y6=15:S15;                      [Magic Arrow]

!!SSy6&y12=1:Cy31/?y20;                 [Determine Mana Cost by Spell School]
!!SSy6&y12=2:Cy33/?y20;
!!SSy6&y12=4:Cy30/?y20;
!!SSy6&y12=8:Cy32/?y20;
!!SSy6&y12=15:C3/?y20;

!!VRy21:Sy20 *y77;

!!SSy6&y12=1:Cy31/y21;                  [Set Mana Cost by Spell School and times Cast]
!!SSy6&y12=2:Cy33/y21;
!!SSy6&y12=4:Cy30/y21;
!!SSy6&y12=8:Cy32/y21;
!!SSy6&y12=15:C3/y21;
!!en;
!!en;

********************************************************************************
!?BG1&1000;                             [Speciality extra cast per combat]

!!BA:Q?y1;                              [Exit if Quick Combat]
!!FU&y1=1:E;
!!BA:Q?f;

!!BG:Q?y1;
!!SN&y1=0:W^Double_Cast_Attacker^/?y4;
!!SN&y1=1:W^Double_Cast_Defender^/?y4;
!!SN&y1=0:W^Magic_Week_34_att^/?y2;
!!SN&y1=1:W^Magic_Week_34_def^/?y2;
!!SN&y1=0:W^Magic_Week_41_att^/?y3;
!!SN&y1=1:W^Magic_Week_41_def^/?y3;
!!SN:W^Magic_Week_Spell_Element^/?y5;
!!SN&y1=0:W^Elemental_Set_att^/?y6;
!!SN&y1=1:W^Elemental_Set_def^/?y6;
!!SN&y1=0:W^Master_Mage_Extra_Cast_att^/?y7;
!!SN&y1=1:W^Master_Mage_Extra_Cast_def^/?y7;
!!SN&y1=0:W^Special_Hero_Extra_Cast_Att^/?y8;
!!SN&y1=1:W^Special_Hero_Extra_Cast_Def^/?y8;

*!IF:M^Eins %Y4 und %Y2 und %Y3 und %Y5 und %Y6 und %Y7^;

!!if&y4=0/y2=0/y3=0/y5=0/y6=0/y7=0/y8=0;[fix with Double Cast mod and Magic Week 34,41 37,38,39,40 and Wizards Knowledge]

  !!SN&y1=0:W^Magic_Specialists_Att^/?y2;[Check Cast Variable Attacker]
  !!SN&y1=1:W^Magic_Specialists_Def^/?y2;[Check Cast Variable Defender]

  !!FU&y2<=0:E;
  !!BHy1:M?y3;
  !!FU&y3=0:E;
  !!BHy1:M0;                            [Renable Cast]

  !!SN&y1=0:W^Magic_Specialists_%V997_Cast_Count_Att^/d1;
  !!SN&y1=1:W^Magic_Specialists_%V997_Cast_Count_Def^/d1;

  !!SN:T^AC_Misc.Specialists Extra Cast^/?z-1;
  !!BU&i^battle_isVisible^:Mz-1;
  !!VRz1:S^FORTUNE^;
  !!SN&i^battle_isVisible^:Pz1;
  !!SN&y1=0:W^Magic_Specialists_Att^/d-1;
  !!SN&y1=1:W^Magic_Specialists_Def^/d-1;
!!en;

************************** Sorcery Specialists *********************************
!?BG0&1000;

!!BA:Q?y1;                              [Exit if Quick Combat]
!!FU&y1=1:E;

!!BG:Q?y1;
!!SN&y1=0:W^Double_Cast_Attacker^/?y4;
!!SN&y1=1:W^Double_Cast_Defender^/?y4;
!!SN&y1=0:W^Magic_Week_34_att^/?y2;
!!SN&y1=1:W^Magic_Week_34_def^/?y2;
!!SN&y1=0:W^Magic_Week_41_att^/?y3;
!!SN&y1=1:W^Magic_Week_41_def^/?y3;
!!SN:W^Magic_Week_Spell_Element^/?y5;
!!SN&y1=0:W^Elemental_Set_att^/?y6;
!!SN&y1=1:W^Elemental_Set_def^/?y6;
!!SN&y1=0:W^Master_Mage_Extra_Cast_att^/?y7;
!!SN&y1=1:W^Master_Mage_Extra_Cast_def^/?y7;
!!SN&y1=0:W^Special_Hero_Extra_Cast_Att^/?y8;
!!SN&y1=1:W^Special_Hero_Extra_Cast_Def^/?y8;

!!if&y4=0/y2=0/y3=0/y5=0/y6=0/y7=0/y8=0;[fix with Double Cast mod and Magic Week 34,41 37,38,39,40 and Wizards Knowledge]

!!BHy1:N?y2;                            [Hero Number]
!!FU&y2=-1:E;
!!BG:S?y3;                              [Spell Number]
!!BG:A?y20;                             [Aktion]
!!if&y3>=10/y3<=69/y20=1;
!!HEy2:X?y5/?y6/?y7/?y8/?y9/?y10/?y11;
!!if&y5=0/y6=25;                        [If Sorcery Specialist]
  !!HEy2:Ed/?y60/1;
  !!SN:W^Sorcery_Specialists_Cast_Counter^/?y1;
  !!FU&y1=1/y60<20:E;
  !!FU&y1=2/y60<40:E;
  !!FU&y1=3/y60<50:E;
  !!FU&y1=4/y60<80:E;
  !!FU&y1=5/y60<100:E;
  !!FU&y1=6:E;
  !!SN:W^Sorcery_Specialists_Sec_Cast^/1;
  !!DO(AC_Function_79)/10/10/1:Py2;     [Remove Quicksand]
  !!DO(AC_Function_79)/12/12/1:Py2;     [Remove Force Field]
  !!DO(AC_Function_79)/14/14/1:Py2;     [Remove Earthquake]
  !!DO(AC_Function_79)/27/69/1:Py2;     [Remove Spells 27-69]
!!en;
!!en;
!!en;
**Gird the Battle Mage
**Malekith the Warlock
**Sandro the Necromancer
**Styg the Witch
**Zydar the Heretic

!?BG1&1000;

!!SN:W^Sorcery_Specialists_Sec_Cast^/?y1;
!!FU&y1<>1:E;

!!BG:Q?y10;                             [Acting Side]
!!BHy10:N?y2;                           [Hero Number]
!!FU&y2=-1:E;
!!HEy2:Ed/?y60/1;
!!VRy61:S0R100;
!!VRy60:+9;
!!VRy62&y61<y60:S1;

!!if&y62=1;
!!BA:Q?f;
!!BHy10:M0;

!!SN&y10=0:W^Magic_Specialists_%V997_Cast_Count_Att^/d1;
!!SN&y10=1:W^Magic_Specialists_%V997_Cast_Count_Def^/d1;

!!VRz-1:S^FORTUNE^;
!!SN&i^battle_isVisible^:Pz-1;
!!SN:T^AC_Misc.Sorcery Specialists Extra^/?z-1;

!!BU&i^battle_isVisible^:Mz-1;
!!SN:W^Sorcery_Specialists_Cast_Counter^/d+1;
!!en;
!!SN:W^Sorcery_Specialists_Sec_Cast^/0;


************************** Elemental Specialists Multi Cast*******************************
!?BG0&1000;

!!BA:Q?y1;                              [Exit if Quick Combat]
!!FU&y1=1:E;

!!BG:Q?y1;
!!SN&y1=0:W^Double_Cast_Attacker^/?y4;
!!SN&y1=1:W^Double_Cast_Defender^/?y4;
!!SN&y1=0:W^Magic_Week_34_att^/?y2;
!!SN&y1=1:W^Magic_Week_34_def^/?y2;
!!SN&y1=0:W^Magic_Week_41_att^/?y3;
!!SN&y1=1:W^Magic_Week_41_def^/?y3;
!!SN:W^Magic_Week_Spell_Element^/?y5;
!!SN&y1=0:W^Elemental_Set_att^/?y6;
!!SN&y1=1:W^Elemental_Set_def^/?y6;
!!SN&y1=0:W^Master_Mage_Extra_Cast_att^/?y7;
!!SN&y1=1:W^Master_Mage_Extra_Cast_def^/?y7;
!!SN&y1=0:W^Special_Hero_Extra_Cast_Att^/?y8;
!!SN&y1=1:W^Special_Hero_Extra_Cast_Def^/?y8;

!!if&y4=0/y2=0/y3=0/y5=0/y6=0/y7=0/y8=0;[fix with Double Cast mod and Magic Week 34,41 37,38,39,40 and Wizards Knowledge]
!!BHy1:N?y2;                            [Hero Number]

!!FU&y2=-1:E;
!!BG:S?y3;                              [Spell Number]
!!BG:A?y20;                             [Aktion]
!!if&y3>=10/y3<=69/y20=1;               [If Hero Cast and Spell]
!!HEy2:X?y5/?y6/?y7/?y8/?y9/?y10/?y11;
!!FU&y5<>0:E;                           [Exit if not a secondary skill Specialist]

!!if|y6=14/y6=15/y6=16/y6=17;           [Fire, Air, Water, Earth Magic]
!!HEy2:Ed/?y60/1;
!!SN:W^Elemental_Specialists_Cast_Counter^/?y1;
!!FU&y1=1/y60<25:E;
!!FU&y1=2/y60<40:E;
!!FU&y1=3/y60<60:E;
!!FU&y1=4/y60<80:E;
!!FU&y1=5/y60<100:E;
!!FU&y1=6:E;
!!SN:W^Elemental_Specialists_Sec_Cast^/1;

!!FU(MSR_Determine_Spell_Type):Py3/?y20/?y21/?y22; [y22 Returns the Magic School of the Spell that was Cast  1Air  2Earth  4Fire  8Water   15Magic Arrow]
!!DO(AC_Function_80)/10/69/1&y6=14/y22<>4:Py2/y6/4; [Remove Spells, Pass Hero Number, Hero Speciality, School of Spell]
!!DO(AC_Function_80)/10/69/1&y6=15/y22<>1:Py2/y6/1; [Remove Spells, Pass Hero Number, Hero Speciality, School of Spell]
!!DO(AC_Function_80)/10/69/1&y6=16/y22<>8:Py2/y6/8; [Remove Spells, Pass Hero Number, Hero Speciality, School of Spell]
!!DO(AC_Function_80)/10/69/1&y6=17/y22<>2:Py2/y6/2; [Remove Spells, Pass Hero Number, Hero Speciality, School of Spell]
*!IF:M^School y6 is%Y6 and School of Spell y22 is%Y22 and Hero y2 is%Y2 and casts y1 is%Y1^;
!!en;
!!en;
!!en;
**Geon 92
**Malcom 28
**Nimbus 75
**Oris 110
**Sanya 13
**Serena 42
**Tiva 127 (replaced as Luck Specialist)

!?BG1&1000;

!!SN:W^Elemental_Specialists_Sec_Cast^/?y1;
!!FU&y1<>1:E;

!!BA:Q?f;
!!BG:Q?y10;                             [Acting Side]
!!BHy10:N?y2;                           [Hero Number]
!!FU&y2=-1:E;
!!HEy2:Ed/?y60/1;
!!VRy61:S0R100;
!!VRy60:+9;
!!VRy62&y61<y60:S1;

!!if&y62=1;
!!BHy10:M0;

!!SN&y10=0:W^Magic_Specialists_%V997_Cast_Count_Att^/d1;
!!SN&y10=1:W^Magic_Specialists_%V997_Cast_Count_Def^/d1;

!!VRz-1:S^FORTUNE^;
!!SN&i^battle_isVisible^:Pz-1;
!!SN:T^AC_Misc.Elemental Specialists Extra^/?z-1;
!!BU&i^battle_isVisible^:Mz-1;
!!SN:W^Elemental_Specialists_Cast_Counter^/d+1;
!!en;
!!SN:W^Elemental_Specialists_Sec_Cast^/0;


********************************************************************************
***Hero Class Bonus Handling 1% SP per two Heroes Level ***
!?MR1&1000;

!!FU:E;                                 [Disabled for now]

!!UN:P39/?y1;                           [Check if Hero Specialisation Boost ins enabled in WoG]
!!FU&y1=0:E;                            [Exit if disabled]

!!BG:S?y50;                             [Spell Number]
!!BG:A?y20;                             [Aktion]
!!if&y50>=10/y50<=69/y20=1;
!!BG:Q?y1;
!!BHy1:N?y10;
!!HEy10:Ed/?y1/1;                       [Get Level]
!!HEy10:B2/?y2;                         [Get Class]
!!VRy3:Sy2 %2;
!!VRy3&y3=1:Sy1:2 +100;                 [If 1 is Mage Class set y3 to Hero level/2 to increase Magic Damage]

!!if&y3>0;
!!MR:F?y4;                              [Get magic damage]
!!VRy5:Sy4 *y3:100;
!!MR:Fy5;                               [apply increased damage]
!!en;
!!en;


********************************************************************************
**Special Spell Crit Handling**
!?MR1&1000;                             [Magic Res Trigger for Crit]

!!FU:E;                                 [Disabled for now]

!!UN:P39/?y1;                           [Check if Hero Specialisation Boost ins enabled in WoG]
!!FU&y1=0:E;                            [Exit if disabled]

!!SN:W^Critical_Sorcery_Mod^/?y1;       [If Critical Sorcery Mod enabled disable that part of Code]
!!FU&y1=1:E;

!!BG:H?y1;                              [Determine if AI controlls Hero]
!!HEy1:O?y1;
!!OW:Iy1/?y1;
!!FU&y1=1:E;

!!UN:C6919200/4/?y1;                    [y1 - combatmanager]
!!VRy2:Sy1 +78532;                      [y2 - _ptr_ autoCombat]
!!UN:Cy2/1/?y3;                         [y3 - autoCombat status]
!!FU&y3=1:E;                            [Exit in Quick Combat]

!!BG:Q?y4;
!!BA:Hy4/?y4;
!!FU&y4=-2:E;

!!HEy4&y4>=0:X?y21/?y22/?y23/?y24/?y25/?y26/?y27; [Check Hero Speciality]
!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>1:E;

!!BG:S?y2;                              [Falls Aktion ein Cast ist dann Speichere 1 in y2]
!!FU&y2<=9|y2>69:E;
!!FU&y22<>y2:E;                         [Exit if spell is not speciality]

!!MR:F?y3;                              [Speichere DMG in y3]
!!FU&y3<=0:E;

!!MR:N?y5;                              [return Creature number which took magic damage]

!!if&y5>=0/y5<=41;
!!HEy4:S18/?y17 S8/?y21;                [check for Bildung in y17 Bildung macht 50% mehr Schaden] [Checke ob der Held Mystik hat und Speichere in y21]
!!HEy4:E?y15/?y16/1;                    [Checke das Level vom Helden und Speichern in y16]
!!VRy9:S0R100;                          [y9 chance to crit (0..99)]

!!if&y9<y16;
!!VRy99:S100;
!!VRy99:+50;                            [Normaler Crit wenn LvL kleiner als Random Wert ist]
!!VRy3:*y99:100;

!!MR:Fy3;                               [apply new damage]
!!BMy5:V82;                             [show crit animation]
!!en;
!!en;


******************************** Bonus Handling*********************************
***Haste***Stoneskin***Bloodlust***Bless***Disrupting Ray***Precision***Weakness
!?BG0&1000;

!!BA:Q?y1;                              [Exit if Quick Combat]
!!FU&y1=1:E;

!!BG:Q?y1;                              [Acting Side]
!!BHy1:N?y2;                            [Hero Number]
!!FU&y2=-1:E;
!!BG:S?y3;                              [Spell Number]
!!BG:A?y20;                             [Aktion]

!!if&y3>=27/y3<=69/y20=1;
!!HEy2:X?y5/?y6/?y7/?y8/?y9/?y10/?y11;
*!IF:M^%Y5 und %Y6 und %Y7 und %Y8 und %Y9 und %Y10 und %Y11^;

!!if&y5=3/y6=43/y3=43;                  [If Bloodlust Specialist]
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S14/?y61;                        [Get Fire Magic Skill]
!!SS43:Ey61/?y10;                       [Get Bloodlust Power]
!!SN:W^Bloodlust_Specialist_Start^/y10;
!!VRy60:Sy62 +y63 :10 +y10;
!!SS43:Ey61/y60;                        [Set New Power]
!!SN:W^Bloodlust_Specialists_Flag^/1;
!!en;

!!if&y5=3/y6=46/y3=46;                  [If Stoneskin Specialist]
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S17/?y61;                        [Get Earth Magic Skill]
!!SS46:Ey61/?y10;                       [Get Stoneskin Power]
!!SN:W^Stoneskin_Specialist_Start^/y10;
!!VRy60:Sy62 +y63 :10 +y10;
!!SS46:Ey61/y60;                        [Set New Power]
!!SN:W^Stoneskin_Specialists_Flag^/1;
!!en;

!!if&y5=3/y6=53/y3=53;                  [If Haste Specialist]
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S15/?y61;                        [Get Air Magic Skill]
!!SS53:Ey61/?y10;                       [Get Haste Power]
!!SN:W^Haste_Specialist_Start^/y10;
!!VRy60:Sy62 +y63 :20 +y10;
!!SS53:Ey61/y60;                        [Set New Power]
!!SN:W^Haste_Specialists_Flag^/1;
!!en;

!!if&y5=3/y6=41/y3=41;                  [If Bless Specialist]
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S16/?y61;                        [Get Water Magic Skill]
!!SS41:Ey61/?y10;                       [Get Bless Power]
!!SN:W^Bless_Specialist_Start^/y10;
!!VRy60:Sy62 +y63 :25 +y10;
!!SS41:Ey61/y60;                        [Set New Power]
!!SN:W^Bless_Specialists_Flag^/1;
!!en;

!!if&y5=3/y6=42/y3=42;                  [If Curse Specialist]
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S14/?y61;                        [Get Fire Magic Skill]
!!SS42:Ey61/?y10;                       [Get Curse Power]
!!SN:W^Curse_Specialist_Start^/y10;
!!VRy60:Sy62 +y63 :25 +y10;
!!SS42:Ey61/y60;                        [Set New Power]
!!SN:W^Curse_Specialists_Flag^/1;
!!en;

!!if&y5=3/y6=47/y3=47;                  [If Disrupting Ray Specialist]
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S15/?y61;                        [Get Air Magic Skill]
!!SS47:Ey61/?y10;                       [Get Disrupting Ray Power]
!!SN:W^Disrupting Ray_Specialist_Start^/y10;
!!VRy60:Sy62 +y63 +5 :10 +y10;
!!SS47:Ey61/y60;                        [Set New Power]
!!SN:W^Disrupting Ray_Specialists_Flag^/1;
!!en;

!!if&y5=3/y6=44/y3=44;                  [If Precision Specialist]
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S15/?y61;                        [Get Air Magic Skill]
!!SS44:Ey61/?y10;                       [Get Precision Power]
!!SN:W^Precision_Specialist_Start^/y10;
!!VRy60:Sy62 +y63 +5 :10 +y10;
!!SS44:Ey61/y60;                        [Set New Power]
!!SN:W^Precision_Specialists_Flag^/1;
!!en;

!!if&y5=3/y6=55/y3=55;                  [If Slayer Specialist]
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S14/?y61;                        [Get Fire Magic Skill]
!!SS55:Ey61/?y10;                       [Get Slayer Power]
!!SN:W^Slayer_Specialist_Start^/y10;
!!VRy60:Sy62 +y63 +5 :10 +y10;
!!SS55:Ey61/y60;                        [Set New Power]
!!SN:W^Slayer_Specialists_Flag^/1;
!!en;

!!if&y5=3/y6=45/y3=45;                  [If Weakness Specialist]
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S16/?y61;                        [Get Water Magic Skill]
!!SS45:Ey61/?y10;                       [Get Weakness Power]
!!SN:W^Weakness_Specialist_Start^/y10;
!!VRy60:Sy62 +y63 :10 +y10;
!!SS45:Ey61/y60;                        [Set New Power]
!!SN:W^Weakness_Specialists_Flag^/1;
!!en;

!!if&y5=3/y6=48/y3=48;                  [If Prayer Specialist]
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S16/?y61;                        [Get Air Magic Skill]
!!SS48:Ey61/?y10;                       [Get Prayer Power]
!!SN:W^Prayer_Specialist_Start^/y10;
!!VRy60:Sy62 +y63 :25 +y10;
!!SS48:Ey61/y60;                        [Set New Power]
!!SN:W^Prayer_Specialists_Flag^/1;
!!en;

!!if&y5=3/y6=38/y3=38;                  [If Resurrection Specialist]
*!HEy2:Ed/?y62/1;                       [Get Hero Level]
*!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
*!HEy2:S17/?y61;                        [Get Earth Magic Skill]
*!SS38:Ey61/?y10;                       [Get Resurrection Power]
*!SN:W^Resurrection_Specialists_Start^/y10;
*!VRy60:Sy62 +y63 *20 +y10;
*!SS38:Ey61/y60;                        [Set New Power]
*!SN:W^Resurrection_Specialists_Flag^/1;
!!en;

!!if&y5=3/y6=39/y3=39;                  [If Animate Dead Specialist]
*!HEy2:Ed/?y62/1;                       [Get Hero Level]
*!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
*!HEy2:S17/?y61;                        [Get Earth Magic Skill]
*!SS39:Ey61/?y10;                       [Get Animate Dead Power]
*!SN:W^Animate_Specialists_Start^/y10;
*!VRy60:Sy62 +y63 *20 +y10;
*!SS39:Ey61/y60;                        [Set New Power]
*!SN:W^Animate_Specialists_Flag^/1;
*!en;

*!SN:W^Buff_Specialists_Flag^/1;
!!en;

*************
!?BG1&1000;

!!SN:W^Buff_Specialists_Flag^/?y1;
!!FU&y1<>1:E;

!!BG:Q?y1;                              [Acting Side]
!!BHy1:N?y2;                            [Hero Number]
!!FU&y2=-1:E;

!!SN:W^Bloodlust_Specialists_Flag^/?y3;
!!if&y3=1;
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S14/?y61;                        [Get Fire Magic Skill]
!!SS43:Ey61/?y10;                       [Get Bloodlust Power]
!!VRy60:Sy62 +y63 :10 *-1 +y10;
!!SS43:Ey61/y60;                        [Set New Power]
!!SN:W^Bloodlust_Specialists_Flag^/0;
!!en;

!!SN:W^Stoneskin_Specialists_Flag^/?y3;
!!if&y3=1;
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S17/?y61;                        [Get Earth Magic Skill]
!!SS46:Ey61/?y10;                       [Get Stoneskin Power]
!!VRy60:Sy62 +y63 :10 *-1 +y10;
!!SS46:Ey61/y60;                        [Set New Power]
!!SN:W^Stoneskin_Specialists_Flag^/0;
!!en;

!!SN:W^Haste_Specialists_Flag^/?y3;
!!if&y3=1;
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S15/?y61;                        [Get Air Magic Skill]
!!SS53:Ey61/?y10;                       [Get Haste Power]
!!VRy60:Sy62 +y63 :20 *-1 +y10;
!!SS53:Ey61/y60;                        [Set New Power]
!!SN:W^Haste_Specialists_Flag^/0;
!!en;

!!SN:W^Bless_Specialists_Flag^/?y3;
!!if&y3=1;
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S16/?y61;                        [Get Water Magic Skill]
!!SS41:Ey61/?y10;                       [Get Bless Power]
!!VRy60:Sy62 +y63 :25 *-1 +y10;
!!SS41:Ey61/y60;                        [Set New Power]
!!SN:W^Bless_Specialists_Flag^/0;
!!en;

!!SN:W^Curse_Specialists_Flag^/?y3;
!!if&y3=1;
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S14/?y61;                        [Get Fire Magic Skill]
!!SS42:Ey61/?y10;                       [Get Curse Power]
!!VRy60:Sy62 +y63 :25 *-1 +y10;
!!SS42:Ey61/y60;                        [Set New Power]
!!SN:W^Curse_Specialists_Flag^/0;
!!en;

!!SN:W^Disrupting Ray_Specialists_Flag^/?y3;
!!if&y3=1;
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S15/?y61;                        [Get Air Magic Skill]
!!SS47:Ey61/?y10;                       [Get Disrupting Ray Power]
!!VRy60:Sy62 +y63 +5 :8 *-1 +y10;
!!SS47:Ey61/y60;                        [Set New Power]
!!SN:W^Disrupting Ray_Specialists_Flag^/0;
!!en;

!!SN:W^Precision_Specialists_Flag^/?y3;
!!if&y3=1;
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S15/?y61;                        [Get Air Magic Skill]
!!SS44:Ey61/?y10;                       [Get Precision Power]
!!VRy60:Sy62 +y63 +5 :10 *-1 +y10;
!!SS44:Ey61/y60;                        [Set New Power]
!!SN:W^Precision_Specialists_Flag^/0;
!!en;

!!SN:W^Slayer_Specialists_Flag^/?y3;
!!if&y3=1;
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S14/?y61;                        [Get Fire Magic Skill]
!!SS55:Ey61/?y10;                       [Get Slayer Power]
!!VRy60:Sy62 +y63 +5 :10 *-1 +y10;
!!SS55:Ey61/y60;                        [Set New Power]
!!SN:W^Slayer_Specialists_Flag^/0;
!!en;

!!SN:W^Weakness_Specialists_Flag^/?y3;
!!if&y3=1;
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S16/?y61;                        [Get Water Magic Skill]
!!SS45:Ey61/?y10;                       [Get Weakness Power]
!!VRy60:Sy62 +y63 :10 *-1 +y10;
!!SS45:Ey61/y60;                        [Set New Power]
!!SN:W^Weakness_Specialists_Flag^/0;
!!en;

!!SN:W^Prayer_Specialists_Flag^/?y3;
!!if&y3=1;
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S16/?y61;                        [Get Air Magic Skill]
!!SS48:Ey61/?y10;                       [Get Prayer Power]
!!VRy60:Sy62 +y63 :25 *-1 +y10;
!!SS48:Ey61/y60;                        [Set New Power]
!!SN:W^Prayer_Specialists_Flag^/0;
!!en;

!!SN:W^Resurrection_Specialists_Flag^/?y3;
!!if&y3=1;
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S17/?y61;                        [Get Earth Magic Skill]
!!SS38:Ey61/?y10;                       [Get Resurrection Power]
!!VRy60:Sy62 +y63 *20 *-1 +y10;
!!SS38:Ey61/y60;                        [Set New Power]
!!SN:W^Resurrection_Specialists_Flag^/0;
!!en;

!!SN:W^Animate_Specialists_Flag^/?y3;
!!if&y3=1;
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S17/?y61;                        [Get Earth Magic Skill]
!!SS39:Ey61/?y10;                       [Get Animate Dead Power]
!!VRy60:Sy62 +y63 *20 *-1 +y10;
!!SS39:Ey61/y60;                        [Set New Power]
!!SN:W^Animate_Specialists_Flag^/0;
!!en;


!!SN:W^Buff_Specialists_Flag^/0;

********************************************************************************
!?FU(AC_Function_79);                   [Remove Hero Spells]

!!HEx1&x16<>x3:Mx16/0;

!?FU(AC_Function_80);                   [Remove Hero Spells]

!!FU(MSR_Determine_Spell_Type):Px16/0/0/?y1; [y1 Returns the Magic School of the Spell that was Cast  1Air  2Earth  4Fire  8Water   15Magic Arrow]
!!HEx1&x3<>y1:Mx16/0;                   [Remove all Spells Except Your Specialisation]

********************************************************************************
!?FU(AC_Function_74);                   [Save all Hero Spells]

!!HEx1:Mx16/?y1;
!!SN:W^Hero%X1_Spell%X16_Specialists^/y1;

!!HEx1&y1=1:M=x16/1;
!!SN&-1/y1=1:W^Hero%X1_Spell%X16_Flag1^/1; [if flag is zero the spell is saved because its learned from scroll or book]


********************************************************************************
!?FU(AC_Function_75);                   [Restore all Hero Spells]

!!SN:W^Hero%X1_Spell%X16_Specialists^/?y2;
!!HEx1:Mx16/y2;

!!SN&x2=1:W^Hero%X1_Spell%X16_Flag1^/?y1;[At battle end remove all spells learned from books]
!!HEx1&y1=1/x2=1:Mx16/0;


!?FU(AC_Function_76);

!!SN:W^Critical_Sorcery_Mod^/?y1;       [*If critical Sorcery is enabled disable the Set Count Fkt in Critical Sorcery Mod]
!!SN&y1=1:W^Critical_Sorcery_Book_Fix^/1;

!!HEx1&x2=2:A2/x16/?y15/?y14;           [check for books]
!!HEx1&x2=2/y14=1:A3/x16/1/1;           [remove books first]
!!HEx1&x2=2/y14=1:A4/x16;               [than reequip books]

!!SN&y1=1:W^Critical_Sorcery_Book_Fix^/0;[Activate again     Why disable again 12.2.2019]

********************************************************************************
!?FU(AC_Function_77);                   [Reset Vars after Combat]

!!SN:W^Hero%X1_Spell%X16_Specialists^/0;
!!SN:W^Hero%X1_Spell%X16_Flag1^/0;

!?FU(AC_Function_78);                   [Reset Vars after Combat]

!!SN:W^Magic_Specialists_%X16_Cast_Count_Att^/0;
!!SN:W^Magic_Specialists_%X16_Cast_Count_Def^/0;


!?FU(OnBattleStackObtainsTurn);
little extra script to make sure spell points are not increaased with multicast by autocasts from artifacts
!!SN:W^First_Turn_in_Combat^/?y1;
!!FU&y1=1:E;
!!SN:W^First_Turn_in_Combat^/1;
!!DO(AC_Function_78)/0/99/1:P;          [Reset Cast Counter at Battle Start]


********************************************************************************
!?FU(Set_Desc_Hero_Speciality);         [Set description for Hero Speciality]

!!HEx1:Ed/?y1/1;                        [Get Hero Level]
!!HEx1:Fd/d/?y60/d;                     [Get Spell Power]
!!HEx1:B0/?z-1;
!!HEx1:R2/?y70;
!!VRz-2&y70=0:S^%T(AC_Misc.his)^;       [his]
!!VRz-2&y70=1:S^%T(AC_Misc.her)^;       [her]
!!HEx1&x1>-1:X?y5/?y6/?y7/?y8/?y9/?y10/?y11; [Check Hero Speciality]

!!if&y5=3/y6=19;                        [45 Solomyr Cain Lightning]
!!VRy20:S15; *!VRz3:S^Chain Lightning^; !!UN:N1/3/y6;
!!VRy16:Sy1 :y20; !!VRx2:Sy6; !!SN:T^AC_Misc.Spell Specialist^/?z4/^casts^/y20; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/x4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click  Spells]
!!en;

!!if&y5=3/y6=24;                        [72 Septienna Death Ripple]
!!VRy20:S15; *!VRz3:S^Death Ripple^; !!UN:N1/3/y6;
!!VRy16:Sy1 :y20; !!VRx2:Sy6; !!SN:T^AC_Misc.Spell Specialist^/?z4/^casts^/y20; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/x4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click  Spells]
!!en;

!!if&y5=3/y6=13;                        [136 Luna Fire Wall]
!!VRy20:S10; *!VRz3:S^Fire Wall^; !!UN:N1/3/y6;
!!VRy16:Sy1 :y20; !!VRx2:Sy6; !!SN:T^AC_Misc.Fire Wall Specialist^/?z4/^casts^/y20; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/x4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click  Spells]
!!en;

!!if&y5=3/y6=16;                        [30 Alagar Ice Bolt]
!!VRy20:S8; *!VRz3:S^Ice Bolt^; !!UN:N1/3/y6;
!!VRy16:Sy1 :y20; !!VRx2:Sy6; !!SN:T^AC_Misc.Spell Specialist^/?z4/^casts^/y20; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/x4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click  Spells]
!!en;

!!if&y5=3/y6=22;                        [57 Xyron Inferno]
!!VRy20:S13; *!VRz3:S^Inferno^; !!UN:N1/3/y6;
!!VRy16:Sy1 :y20; !!VRx2:Sy6; !!SN:T^AC_Misc.Spell Specialist^/?z4/^casts^/y20; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/x4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click  Spells]
!!en;

!!if&y5=3/y6=23;                        [73 Aislinn Meteor Shower  93 Deemer]
!!VRy20:S12; *!VRz3:S^Meteor Shower^; !!UN:N1/3/y6;
!!VRy16:Sy1 :y20; !!VRx2:Sy6; !!SN:T^AC_Misc.Spell Specialist^/?z4/^casts^/y20; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/x4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click  Spells]
!!en;

!!if&y5=3/y6=21;                        [63 Xarfax Fireball]
!!VRy20:S10; *!VRz3:S^Fireball^; !!UN:N1/3/y6;
!!VRy16:Sy1 :y20; !!VRx2:Sy6; !!SN:T^AC_Misc.Spell Specialist^/?z4/^casts^/y20; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/x4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click  Spells]
!!en;

!!if&y5=3/y6=20;                        [11 Adelaide Frost Ring]
!!VRy20:S10; *!VRz3:S^Frost Ring^; !!UN:N1/3/y6;
!!VRy16:Sy1 :y20; !!VRx2:Sy6; !!SN:T^AC_Misc.Spell Specialist^/?z4/^casts^/y20; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/x4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click  Spells]
!!en;

!!if&y5=3/y6=17;                        [Lightning Bolt]
!!VRy20:S10; *!VRz3:S^Lightning Bolt^; !!UN:N1/3/y6;
!!VRy16:Sy1 :y20; !!VRx2:Sy6; !!SN:T^AC_Misc.Spell Specialist^/?z4/^casts^/y20; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/x4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click  Spells]
!!en;

!!if&y5=3/y6=18;                        [Implosion]
!!VRy20:S16; *!VRz3:S^Implosion^; !!UN:N1/3/y6;
!!VRy16:Sy1 :y20; !!VRx2:Sy6; !!SN:T^AC_Misc.Spell Specialist^/?z4/^casts^/y20; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/x4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click  Spells]
!!en;

!!if&y5=3/y6=15;                        [138 Ciele Magic Arrow]
!!VRy20:S7; *!VRz3:S^Magic Arrow^; !!UN:N1/3/y6;
!!VRy16:Sy1 :y20; !!VRx2:Sy6; !!SN:T^AC_Misc.Magic Arrow Specialist^/?z4/^casts^/y20; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/x4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click  Spells]
!!en;

!!if&y6=25/y5=0;                        [104 Gird or 90 Malekith or 74 Sandro or 125 Styg or 62 Zydar  Sorcery]
!!FU(Skill_Value_Database):Px1/y6/y1/?y71; [Pass Hero Number, Skill, Hero Level, Return Value]

!!VRy17:S1; !!VRy17&y1>=25:S2; !!VRy17&y1>=40:S3; !!VRy17&y1>=60:S4; !!VRy17&y1>=80:S5;
!!VRy16:Sy1 +9; !!VRy16&y16>=100:S100; !!VRx2:S25; !!SN:T^AC_Misc.Sorcery Specialist^/?z4/^casts^/y17; !!VRx3:S1; !!SN:Iz4/?z4;
!!IF:Q1/20/80/x4^%Z4^; !!CM:R0;          [show description for Hero Speciality when right click  Sorcery]
!!en;
**Gird the Battle Mage
**Malekith the Warlock
**Sandro the Necromancer
**Styg the Witch
**Zydar the Heretic

!!if&y5=0;
!!if|y6=14/y6=15/y6=16/y6=17;
!!VRy17:S1; !!VRy17&y1>=25:S2; !!VRy17&y1>=40:S3; !!VRy17&y1>=60:S4; !!VRy17&y1>=80:S5;
!!VRy16:Sy1 +9; !!VRy16&y16>=100:S100; !!VRx2&y6=14:S47; !!VRx2&y6=15:S50; !!VRx2&y6=16:S53; !!VRx2&y6=17:S56;
!!SN&y6=14:T^AC_Misc.Fire^/?z3; !!SN&y6=15:T^AC_Misc.Air^/?z3; !!SN&y6=16:T^AC_Misc.Water^/?z3; !!SN&y6=17:T^AC_Misc.Earth^/?z3;
!!SN:T^AC_Misc.Elemental Specialist^/?z4/^casts^/y17; !!SN:Iz4/?z4;
!!VRx3:S1; !!IF:Q1/20/x2/x4^%Z4^; !!CM:R0;[show description for Hero Speciality when right click]
!!en;
!!en;
**Geon 92
**Malcom 28
**Nimbus 75
**Oris 110
**Sanya 13
**Serena 42
**Tiva 127 (Replaced as Luck Specialists)

!!if&y5=0/y6=8;                         [Mysticism  Specialists]
!!VRx2&y6=8:S8; !!VRy50:Sy1:2+1; !!SN:T^AC_Misc.Mysticism Specialist^/?z4; !!VRx3:S1; !!SN:Iz4/?z4; [Y50 Level/2 to get additional Spell Points Recovery]
!!IF:Q1/20/29/x4^%Z4^; !!CM:R0;          [show description for Hero Speciality when right click]
!!en;

!!if&y5=3/y6=41;                        [9 Adela Bless]
*!VRz3:S^Bless^; !!UN:N1/3/y6;
!!VRy16:Sy60 +y1 :25; !!VRx2:Sy6; !!SN:T^AC_Misc.Bless Specialist^/?z4; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/x4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click]
!!en;

!!if&y5=3/y6=42;                        [Curse]
*!VRz3:S^Curse^; !!UN:N1/3/y6;
!!VRy16:Sy60 +y1 :25; !!VRx2:Sy6; !!SN:T^AC_Misc.Curse Specialist^/?z4; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/x4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click]
!!en;

!!if&y5=3/y6=43;                        [61 Ash Bloodlust]
*!VRz3:S^Bloodlust^; !!UN:N1/3/y6;
!!VRy16:Sy60 +y1 :10; !!VRy17:Sy16+3; !!VRy18:Sy16+2; !!VRy19:Sy16+1; !!VRx2:Sy6; !!SN:T^AC_Misc.Bloodlust Specialist^/?z4; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/x4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click]
!!en;

!!if&y5=3/y6=46;                        [95 Darkstorm 139 Labetha 124 Merist 77 Xsi Stoneskin]
*!VRz3:S^Stoneskin^; !!UN:N1/3/y6;
!!VRy16:Sy60 +y1 :10; !!VRy17:Sy16+3; !!VRy18:Sy16+2; !!VRy19:Sy16+1; !!VRx2:Sy6; !!SN:T^AC_Misc.Stoneskin Specialist^/?z4; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/x4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click]
!!en;

!!if&y5=3/y6=53;                        [137 Brissa 46 Cyra 107 Terek Haste]
*!VRz3:S^Haste^; !!UN:N1/3/y6;
!!VRy16:Sy60 +y1 :20; !!VRy17:Sy16+3; !!VRy18:Sy16+2; !!VRy19:Sy16+1; !!VRx2:Sy6; !!SN:T^AC_Misc.Haste Specialist^/?z4; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/x4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click]
!!en;

!!if&y5=3/y6=47;                        [141 Aenain Disrupting Ray  (Outdated)]
*!VRz3:S^Disrupting Ray^; !!UN:N1/3/y6;
!!VRy16:Sy60 +y1 +5 :8 +2; !!VRx2:Sy6; !!SN:T^AC_Misc.Disrupting Ray Specialist^/?z4; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/x4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click]
!!en;

!!if&y5=3/y6=44;                        [108 Zubin Precision]
*!VRz3:S^Precision^; !!UN:N1/3/y6;
!!VRy16:Sy60 +y1 +5 :10; !!VRy17:Sy16+3; !!VRy18:Sy16+2; !!VRy19:Sy16+1; !!VRx2:Sy6; !!SN:T^AC_Misc.Precision Specialist^/?z4; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/x4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click]
!!en;

!!if&y5=3/y6=45;                        [10 Cuthbert 120 Mirlanda 59 Olema  Weakness]
*!VRz3:S^Weakness^; !!UN:N1/3/y6;
!!VRy16:Sy60 +y1 :10; !!VRy17:Sy16+3; !!VRy18:Sy16+2; !!VRy19:Sy16+1; !!VRx2:Sy6; !!SN:T^AC_Misc.Weakness Specialist^/?z4; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/x4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click]
!!en;

!!if&y5=3/y6=48;                        [14 Loynis Prayer]
*!VRz3:S^Prayer^; !!UN:N1/3/y6;
!!VRy16:Sy60 +y1 :25; !!VRy17:Sy16+3; !!VRy18:Sy16+2; !!VRy19:Sy16+1; !!VRx2:Sy6; !!VRx3:S0; !!SN:T^AC_Misc.Prayer Specialist^/?z4; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/x4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click]
!!en;

!!if&y5=3/y6=38;                        [Resurrection]
!!VRy20:S12; *!VRz3:S^Resurrection^; !!UN:N1/3/y6;
!!VRy16:Sy60 +y1 *20; !!VRx2:Sy6; !!VRx3:S0; !!SN:T^AC_Misc.Resurrection Specialist^/?z4/^casts^/y20; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/x4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click]
!!en;

!!if&y5=3/y6=39;                        [Animate Dead]
!!VRy20:S12; *!VRz3:S^Animate Dead^; !!UN:N1/3/y6;
!!VRy16:Sy60 +y1 *20; !!VRx2:Sy6; !!VRx3:S0; !!SN:T^AC_Misc.Animate Specialist^/?z4/^casts^/y20; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/x4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click]
!!en;

!!if&y5=3/y6=55;                        [Slayer]
*!VRz3:S^Slayer^; !!UN:N1/3/y6;
!!VRy16:Sy60 +y1 +5 :10; !!VRx2:Sy6; !!VRx3:S0; !!SN:T^AC_Misc.Slayer Specialist^/?z4; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/x4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click]
!!en;
********************************************************************************





******************************************************************************
!?FU(Save_Special_Spell_Mana_Cost);     [Save Special Spell Mana Cost]
!!HEx1:S14/?y30 S15/?y31 S16/?y32 S17/?y33; [Checke current hero  Fire14 Air15 Water16 Earth17 Magien]

!!VRy13|x2=17/x2=19/x2=25:S1;           [Air]
!!VRy13|x2=18/x2=23/x2=24:S2;           [Earth]
!!VRy13|x2=21/x2=22/x2=26:S4;           [Fire]
!!VRy13|x2=16/x2=20:S8;                 [Water]
!!VRy13&x2=15:S15;                      [Magic Arrow]

!!SSx2&y13=1:Cy31/?y20;                 [Determine Mana Cost by Spell School]
!!SSx2&y13=2:Cy33/?y20;
!!SSx2&y13=4:Cy30/?y20;
!!SSx2&y13=8:Cy32/?y20;
!!SSx2&y13=15:C3/?y20;

!!SN&x3=0:W^Magic_Specialists_Att_Mana_Spell^/y20;
!!SN&x3=0:W^Magic_Specialists_Att_Spell^/x2;
!!SN&x3=1:W^Magic_Specialists_Def_Mana_Spell^/y20;
!!SN&x3=1:W^Magic_Specialists_Def_Spell^/x2;


!?FU(Restore_Special_Spell_Mana_Cost);  [Restore Special Spell Mana Cost]
!!HEx1:S14/?y30 S15/?y31 S16/?y32 S17/?y33; [Checke current hero  Fire14 Air15 Water16 Earth17 Magien]

!!SN&x2=0:W^Magic_Specialists_Att_Mana_Spell^/?y20;
!!SN&x2=0:W^Magic_Specialists_Att_Spell^/?y12;
!!SN&x2=1:W^Magic_Specialists_Def_Mana_Spell^/?y20;
!!SN&x2=1:W^Magic_Specialists_Def_Spell^/?y12;

!!VRy13|y12=17/y12=19/y12=25:S1;        [Air]
!!VRy13|y12=18/y12=23/y12=24:S2;        [Earth]
!!VRy13|y12=21/y12=22/y12=26:S4;        [Fire]
!!VRy13|y12=16/y12=20:S8;               [Water]
!!VRy13&y12=15:S15;                     [Magic Arrow]

!!SSy12&y13=1:Cy31/y20;                 [Determine Mana Cost by Spell School]
!!SSy12&y13=2:Cy33/y20;
!!SSy12&y13=4:Cy30/y20;
!!SSy12&y13=8:Cy32/y20;
!!SSy12&y13=15:C3/y20;


!?FU(MSR_Determine_Spell_Type);
**Funtion to determine the Spell Type School**
[x1=spell number,  x2/y96 returns level (Level 1-5), x3/y97 returns type (Adventurer/Combat), x4/y98 returns element (Air 1, Earth 2, Fire 4 Water 8 )]
!!FU|x1<0/x1>69:E;
*!SSx1:L?y96;                           [Check level of Spell 1-5]
*!SSx1:F?i;                             [Get flag in i]
*!VRi:&2;                               [Check Flag for Adventure Spell]
*!VRy97&i>0:S1;                         [Set y97 to 1 if Adventure Spell]
*!SSx1:F?i;                             [Get flag in i]
*!VRi:&1;                               [Check Flag for Combat Spell]
*!VRy97&i>0:S2;                         [Set y97 to 2 if Combat Spell]

!!SSx1:S?y1;                            [Get spell's magic school bits]
!!VRy3:Sy1:1%2;                         [air. If bits of this spell contain school of air magic, this will be equal to 1]
!!VRy4:Sy1:2%2;                         [fire]
!!VRy5:Sy1:4%2;                         [water]
!!VRy6:Sy1:8%2;                         [earth]
!!VRy98&y3=1:S1;                        [air y3]
!!VRy98&y4=1:S4;                        [fire y4]
!!VRy98&y5=1:S8;                        [water y5]
!!VRy98&y6=1:S2;                        [earth y6]

!!VRx2:Sy96;
!!VRx3:Sy97;
!!VRx4:Sy98;
****************************************************************************************************


                          Change Heroes Specialities and starting abilities 



****************************************************************************************************
*-------------Castle-----------------------*
!#UN:G2/1/1/160; !#UN:G2/1/3/160;
!#UN:G2/2/1/161; !#UN:G2/2/3/161;
!#UN:G2/5/1/162; !#UN:G2/5/3/162;
!#UN:G2/7/1/164; !#UN:G2/7/3/164;
!#UN:G2/12/1/163; !#UN:G2/12/3/163;

!#HE3:S21/0;                            [Sylvia Learning]
!#HE3:S6/0;
!#HE3:S4/1;

!#HE4:X3/2;                             [Lort Haart Commander Special]
!#UN:G2/4/1/274; !#UN:G2/4/3/274;
!#CO4:B1/11/1;                          [give regeneration to commander]

!#VRy10:S2R1;                           [starts with 1 stack of swordsman]
!#HE5:C0/2/6/y10;                       [5 Sorsha]

!#HE8:S11/1;                            [Rion Eagle Eye instead of Wisdom]
!#HE8:S7/0;                             [Remove Wisdom]

!#HE9:S16/1;                            [Adela Water magic instead of Wisdom and Offense instead of Leadership]
!#HE9:S7/0;
!#HE9:S6/0;

!#HE10:S13/0;                           [Cuthbert starts with Water Magic instead of Estate]
!#HE10:S16/1;

!#HE11:S8/1;                            [Adelaide Water Magic and Mysticism instead of Adv. Wisdom]
!#HE11:S16/1;
!#HE11:S7/0;
!#HE11:F0/0/2/3;                        [1 bonus knowledge]

!#HE12:C0/2/8/1;                        [Inghamn starts with 1 Monk]

!#UN:G2/13/1/305; !#UN:G2/13/3/305; !#HE13:X0/16; !#HE13:S11/0;  !#HE13:S16/1; [Sanya Water]
*#HE14:S7/0;                            [Loynis Water magic instead of Wisdom]
*#HE14:S16/1;
*#HE14:S7/0;                            [Loynis Water magic instead of Wisdom]
*#HE14:S16/1;

!#HE15:S7/0;                            [Caitlin remove Wisdom]
!#HE15:S24/0;                           [Remove Intelligence]
!#HE15:S11/1;                           [Give Eagle Eye]
!#HE15:S21/1;                           [Give Learning]
*------------------------------------------*



*-------------Rampart-----------------------*
!#UN:G2/17/1/169; !#UN:G2/17/3/169;
!#UN:G2/19/1/172; !#UN:G2/19/3/172;
!#UN:G2/21/1/170; !#UN:G2/21/3/170;
!#UN:G2/22/1/173; !#UN:G2/22/3/173;
!#UN:G2/31/1/171; !#UN:G2/31/3/171;

!#HE17:C0/2/14/15;                      [17 Ufretin starts some more Centaures]

!#HE18:S11/1;                           [Jenova Give Eagle Eye]
!#HE18:S5/1;                            [Jenova Give Nobility]
!#HE18:S1/0;                            [Remove Adv. Archery]

!#HE19:C0/2/22/1;                       [19 Ryland starts with 1 Dendroid]

!#VRy10:S4R2;                           [starts with 1 stack of elves]
!#HE21:C0/2/18/y10;

!#HE23:S3/1;                            [Kyrre Basic Scouting instead of Archery]
!#HE23:S1/0;

!#HE24:M55/0;                           [Ice Bolt instead of Slayer]
!#HE24:M16/1;
!#HE24:X0/7;                            [Coronius Now Wisdom Specialist]
!#HE24:S7/3;                            [Starts with Expert Wisdom]

!#HE25:A1/6/15;                         [Uland starts first aid Tent]
!#HE25:S7/1;                            [Basic Wisdom]
!#HE25:S10/0;                           [Removes Ballistic]
!#HE25:S16/1;                           [Water Magic]
!#HE25:F0/2/3/2;                        [+2 Spell Power]

!#HE27:S27/1;                           [Gem Advanced First Aid instead of Basic and Diplomacy instead of Wisdom]
!#HE27:S4/1;
!#HE27:S7/0;
!#UN:G2/28/1/305; !#UN:G2/28/3/305; !#HE28:X0/16;  !#HE28:S11/0;  !#HE28:S16/1; [Malcom Water]

!#HE29:S7/0;                            [Melodia starts with Diplomancy instead of Wisdom]
!#HE29:S4/1;
!#HE29:M51/0;                           [Bloodlust instead of Fortune]
!#HE29:M43/1;
!#HE29:X0/4;                            [Diplomacy]
!#UN:G2/29/3/295;
!#UN:G2/29/1/295;

!#HE31:S22/1;                           [Aeris Offense]
!#HE31:S7/0;                            [no Wisdom]
!#HE31:S23/1;                           [Armourer]
!#HE31:S3/0;                            [no Scouting]
!#VRy10:S2R1;                           [starts with 1 stack of pegasus]
!#HE31:C0/2/20/y10;
*------------------------------------------*



*-------------Tower------------------------*
!#UN:G2/32/1/178; !#UN:G2/32/3/178;
!#UN:G2/44/1/180; !#UN:G2/44/3/180;
!#UN:G2/34/1/179; !#UN:G2/34/3/179;
!#UN:G2/38/1/177; !#UN:G2/38/3/177;
!#UN:G2/39/1/181; !#UN:G2/39/3/181;
!#UN:G2/37/1/182; !#UN:G2/37/3/182;
!#HE33:S18/1;                           [Thane Basic Scholar]
!#HE33:S25/1;
!#HE33:M15/0;                           [Lightning Bolt instead of Magic Arrow]
!#HE33:M17/1;
!#HE33:X0/18;                           [Thane Scholar Special]

!#HE35:S17/1;                           [Neela starts with Earth magic instead of Scholar]
!#HE35:S18/0;

!#HE36:X3/2;                            [Torosar Commander Special]
!#UN:G2/36/1/276; !#UN:G2/36/3/276;
!#HE36:S1/1;                            [Starts with Archery instead of Mysticism]
!#HE36:S8/0;
!#CO36:B1/8/1;                          [give Block ability to commander]

!#HE37:S18/0;                           [Fafner Replace Basic Scholar with Luck]
!#HE37:S9/1;

!#HE38:S8/0;                            [Rissa starts with Archery and Air Magic instead of Mysticism and Offense]
!#HE38:S22/0;
!#HE38:S1/1;
!#HE38:S15/1;
!#HE38:X1/28;                           [Gremlin Specialist   changed from 29]
!#VRy10:S20 R10;                        [Rissa starts with Master Gremlins]
!#HE38:C0/0/29/y10;
!#VRy10:S30 R10;
!#HE38:C0/1/29/y10;
!#VRy10:S30 R10;
!#HE38:C0/2/29/y10;
!#HE38:F0/1/1/2;                        [Down from 1/1/2/2]

!#HE39:S18/0;                           [Iona Replace Basic Scholar with Leadership]
!#HE39:S6/1;
!#HE39:C0/2/36/1;                       [Iona starts with 1 genie instead of possible golems]
!#UN:G2/39/1/39; !#UN:G2/39/3/39;

!#HE40:F0/0/4/3;                        [+2 Spell Power  40 Astral]

!#UN:G2/42/1/292; !#UN:G2/42/3/292; !#HE42:X0/15; !#HE42:S11/0;  !#HE42:S15/1; [Serena Air]

!#HE43:S7/0;                            [Daremyth starts with Diplomacy, Learning instead of Wisdom and Intelligence.]
!#HE43:S24/0;
!#HE43:S4/1;
!#HE43:S21/1;
!#HE43:X0/4;

*#HE44:S16/1;                           [Theodorus Water Magic instead of Wisdom, Archery instead of Ballistics]
*#HE44:S7/0;
*#HE44:S1/1;
*#HE44:S10/0;
*#HE44:M63/1;                           [Teleport instead of Shield]
*#HE44:M27/0;
*#VRy10:S3R1;                           [starts with 2 stacks 3-4 Mages and a possible stack of 5-7 stone gargoyles]
*#HE44:C0/0/34/y10;
*#VRy10:S4R1;
*#HE44:C0/1/34/y10;
*#VRy10:S5R2;
*#HE44:C0/2/30/y10;

!#HE45:S8/1;                            [Solmyr starts with Mysticism and Wisdom instead of Sorcery]
!#HE45:S7/1;
!#HE45:S25/0;

!#HE46:S15/1;                           [Cyra starts with Air magic instead of Leadership]
!#HE46:S6/0;
!#HE46:S7/0;                            [Removes Wisdom]
!#HE46:S20/1;                           [Artillery instead of Diplomacy]
!#HE46:S4/0;
!#HE46:A1/4/13;                         [Cyra starts with a Ballista war machine]

!#HE47:S6/0;                            [Aine Remove Wisdom and Scholar]
!#HE47:S7/0;                            [Removes Wisdom]
!#HE47:S18/0;                           [Removes Scholar]
!#HE47:S13/1;                           [Give Estate]
!#HE47:S4/1;                            [Give Diplomacy]
*------------------------------------------*


*-------------Inferno------------------------*
!#UN:G2/49/1/190; !#UN:G2/49/3/190;
!#UN:G2/50/1/188; !#UN:G2/50/3/188;
!#UN:G2/51/1/185; !#UN:G2/51/3/185;
!#UN:G2/53/1/186; !#UN:G2/53/3/186;
!#UN:G2/55/1/189; !#UN:G2/55/3/189;

!#HE48:S21/1;                           [Fiona starts with Learning in addition to Advanced Scouting]
!#HE48:S3/1;
!#HE48:X0/3;                            [Fiona Scouting specialist]
!#VRy10:S4R2;
!#HE48:C0/2/46/y10;
!#UN:G2/48/1/302; !#UN:G2/48/3/302;

!#HE49:S18/0;                           [Rashka starts with Leadership instead of Scholar]
!#HE49:S6/1;

!#VRy10:S3R1;                           [starts with 1 stack of Damons]
!#HE50:C0/2/48/y10;

!#HE52:S18/0;                           [Octavia remove Scholar and Offense and give Estate and Diplomacy]
!#HE52:S22/0;
!#HE52:S13/1;
!#HE52:S4/1;

!#HE55:C0/2/50/2;                       [55 Nymus starts with 2 Pit Fiends]

!#HE57:X3/22;                           [Xyron Inferno]
!#HE57:F1/1/1/2;                        [Adjust Primary Skills]
!#UN:G2/57/1/57; !#UN:G2/57/3/57;

*#HE59:S23/1;                           [Olema starts with Armourer instead of Leadership]
*#HE59:S6/0;
*#HE59:S7/0;                            [No Wisdom]
*#HE59:S16/1;                           [Water Magic]
*#HE59:S10/0;                           [Removes Ballistics]

!#HE60:S7/0;                            [Calid starts with Pathfinding instead of Wisdom.]
!#HE60:S0/1;                            [Set to basic Pathfinding]
!#HE60:S4/1;                            [Diplomacy]
!#HE60:S21/0;                           [no Learning]
!#HE60:X0/0;

!#HE61:S14/1;                           [Ash Fire Magic and Warfare instead of Wisdom and Eagle Eye]
!#HE61:S19/1;
!#HE61:S7/0;
!#HE61:S11/0;

!#HE62:M15/1;                           [Zydar starts with Magic Arrow instead of Stone skin (Stone skin? Like, for real?)]
!#HE62:M46/0;

!#HE63:S14/1;                           [Xarfax starts with Fire magic instead of Leadership]
!#HE63:S6/0;
!#HE63:S8/1;                            [Mysticism instead of Wisdom]
!#HE63:S7/0;
!#HE63:X3/57;
*------------------------------------------*


*-------------Necropolis------------------------*
!#UN:G2/64/1/193; !#UN:G2/64/3/193;
!#UN:G2/65/1/195; !#UN:G2/65/3/195;
!#UN:G2/66/1/196; !#UN:G2/66/3/196;
!#UN:G2/67/1/194; !#UN:G2/67/3/194;
!#UN:G2/68/1/197; !#UN:G2/68/3/197;
!#UN:G2/71/1/192; !#UN:G2/71/3/192;
*#UN:G2/79/1/156; *#UN:G2/79/3/156; Nagash 

!#VRy10:S2R1;                           [starts with 1 stack of Vampires]
!#HE65:C0/2/62/y10;

!#HE66:C0/2/64/1;                       [66 Moandor 1 Liche]

!#VRy10:S4R2;
!#HE67:C0/2/60/y10;                     [67 Charna]

!#HE70:X0/22;                           [Clavius Offense specialist]

!#HE74:M15/1;                           [Sandro starts with Magic arrow instead of Slow]
!#HE74:M54/0;

!#UN:G2/75/1/296; !#UN:G2/75/3/296;
!#HE75:X0/17;
!#HE75:S11/0;
!#HE75:S17/1;                           [Nimbus Earth]

!#HE76:M39/1;                           [Thant starts with Reanimate Dead again.]
!#HE76:M46/0;

!#HE77:S17/1;                           [Xsi starts with Earth magic instead of Learning]
!#HE77:S21/0;

!#HE78:S12/1;                           [Vidomina starts with Learning and Basic Necro]
!#HE78:S21/1;
!#HE78:X0/21;                           [Learning]

!#HE79:S2/1;                            [Nagash Logistics]
!#HE79:S21/0;                           [No Learning]
!#HE79:S24/0;                           [No Intelligence]
*------------------------------------------*



*-------------Dungeon------------------------*
!#UN:G2/80/1/201; !#UN:G2/80/3/201;
!#UN:G2/82/1/205; !#UN:G2/82/3/205;
!#UN:G2/83/1/202; !#UN:G2/83/3/202;
!#UN:G2/84/1/204; !#UN:G2/84/3/204;     [84 Damacon 204 Medusa Queen  Specialist]
!#UN:G2/86/1/206; !#UN:G2/86/3/206;
!#UN:G2/87/1/200; !#UN:G2/87/3/200;
!#UN:G2/88/1/308; !#UN:G2/88/3/308;
!#UN:G2/91/1/91;  !#UN:G2/91/3/91;

!#VRy10:S3R2;                           [starts with 1 stack of Harpy]
!#HE80:C0/2/72/y10;

!#HE82:C0/2/78/1;                       [82 Dace starts with 1 Minotaure]

!#VRy10:S4R2;                           [starts with 1 stack of Beholder]
!#HE83:C0/2/74/y10;

!#VRy10:S2R1;                           [starts with 1 stack of Medusa]
!#HE84:C0/2/76/y10;
!#HE84:X1/76;                           [Make him Medusa Specialist]
!#HE84:S13/1;                           [Damacon starts with Archery and Estates instead of Adv. Offense]
!#HE84:S1/1;
!#HE84:S22/0;

!#HE85:S13/1;                           [Gunnar starts with Basic Estates instead of Tactics]
!#HE85:S19/0;

!#HE88:X3/69;                           [Alamar Air Elemental Spell]
!#HE88:M69/1;                           [Get Summon Air Elemental]
!#HE88:M38/0;                           [Delete Resurrection Spell]
!#HE88:S18/0;                           [Delete Scholar and Wisdom]
!#HE88:S15/1;                           [Give Basic Air Magic]
!#HE88:F0/1/2/2;                        [Adjust Primary Skills]

!#HE90:M15/1;                           [Malekith starts with Magic Arrow instead of Bloodlust]
!#HE90:M43/0;

!#HE91:S7/1;                            [Jeddite Basic Wisdom]
!#HE91:S17/1;                           [Jeddite Basic Earth Magic]
!#HE91:F0/0/2/3;                        [Jeddite Adjust Primary Skills]

!#UN:G2/92/1/296; !#UN:G2/92/3/296; 
!#HE92:X0/17; !#HE92:S11/0;  !#HE92:S17/1; [Geon Earth]

!#HE93:S17/1;                           [Deemer Earth and Intelligence instead Wisdom and Scouting]
!#HE93:S24/1;
!#HE93:S7/0;
!#HE93:S3/0;

!#HE94:S13/2;                           [Sephinroth starts with Adv. Estates instead of Wisdom and Intelligence]
!#HE94:S7/0;
!#HE94:S24/0;
!#HE94:S3/0;
!#HE94:M43/1;                           [Bloodlust instead of Air Protection.]
!#HE94:M30/0;
!#HE94:X0/13;                           [Estates Special]
!#UN:G2/94/3/94;                        [Set the picture back to Estates after HE:X]

!#HE95:S17/1;                           [Darkstorn starts with Earth magic instead of Learning]
!#HE95:S21/0;
!#HE95:S19/1;                           [Warfare instead of Wisdom]
!#HE95:S7/0;
*------------------------------------------*



*-------------Stronghold------------------------*
!#UN:G2/96/1/214; !#UN:G2/96/3/214;
!#UN:G2/98/1/211; !#UN:G2/98/3/211;
!#UN:G2/99/1/213; !#UN:G2/99/3/213;
!#UN:G2/100/1/209; !#UN:G2/100/3/209;
!#UN:G2/101/1/212; !#UN:G2/101/3/212;
!#UN:G2/103/1/210; !#UN:G2/103/3/210;

!#HE96:S1/1;                            [Yog starts with Archery instead of Ballistics]
!#HE96:S10/0;
!#HE97:S20/1;                           [Gurnisson starts with Artillery instead of Offense]
!#HE97:S22/1;

!#HE99:C0/2/92/1;                       [99 Shiva starts with one Bird]

!#VRy10:S2R1;                           [starts with 1 stack of 2-3 Ogres]
!#HE101:C0/2/90/y10;

!#HE104:M16/1;                          [Gird starts with Ice bolt instead of Bloodlust]
!#HE104:M43/0;

!#HE105:X3/2;                           [Vey Commander specialist]
!#HE105:S19/1;                          [Warfare instead of Wisdom]
!#HE105:S7/0;
!#CO105:B1/6/1;                         [give Strike All Around ability to commander]

!#UN:G2/105/1/281; !#UN:G2/105/3/281;

!#HE106:A1/6/15;                        [Dessa starts first aid Tent]
!#HE106:S3/1;                           [Dessa starts with Scouting and Logistics instead of Wisdom and Logistics]
!#HE106:S7/0;

!#HE107:S15/1;                          [Terek starts with Air magic instead of Tactics]
!#HE107:S19/0;
!#HE107:S22/1;                          [Offense instead of Wisdom]
!#HE107:S7/0;

!#HE108:S15/1;                          [Zubin starts with Air magic instead of Wisdom]
!#HE108:S7/0;
!#HE108:A1/4/13;                        [ballista Zubin]

!#HE109:X0/3;                           [Gundula is now Scouting Specialist]
!#UN:G2/109/1/302; !#UN:G2/109/3/302;
!#HE109:S7/0;                           [Starts with Scouting instead of Wisdom and remove Offense and add Eagle Eye]
!#HE109:S3/1;
!#HE109:S22/0;
!#HE109:S11/1;

!#UN:G2/110/1/145; !#UN:G2/110/3/145; !#HE110:X0/14;  !#HE110:S11/0;  !#HE110:S14/1; [Oris Fire Magic]
!#HE110:F1/1/1/2;                       [Adjust Primary Skills]
!#HE110:M30/0;                          [Delete useless Prot from Air Spell]
!#HE110:M56/1;                          [Give 56 Frenzy]

!#HE111:S7/0;                           [Saurug starts with Sorcery and Air Magic instead of Wisdom and Resistance]
!#HE111:S26/0;
!#HE111:S15/1;
!#HE111:S25/1;
!#HE111:M43/0;                          [Lightning Bolt instead of Bloodlust]
!#HE111:M17/1;
!#HE111:X3/17;                          [Saurog Lightning]
*------------------------------------------*



*-------------Fortress------------------------*
!#UN:G2/112/1/219; !#UN:G2/112/3/219;
!#UN:G2/113/1/216; !#UN:G2/113/3/216;
!#UN:G2/114/1/217; !#UN:G2/114/3/217;
!#UN:G2/116/1/220; !#UN:G2/116/3/220;
!#UN:G2/117/1/218; !#UN:G2/117/3/218;
!#UN:G2/119/1/221; !#UN:G2/119/3/221;

!#VRy10:S2R1;                           [starts with 1 stack of Basilisks]
!#HE112:C0/3/106/y10;

!#VRy10:S5R3;                           [starts with 1 stack of Lizards]
!#HE114:C0/3/100/y10;                   [114 Wystan]

!#HE116:C0/3/102/1;                     [116 Alkin starts with 1 Gorgon]

!#VRy10:S4R2;                           [starts with 1 stack of Serpents]
!#HE117:C0/3/104/y10;                   [117 Korbac]

!#HE118:X0/19;                          [Gerwulf is now a Warfare Specialist]
!#HE118:S23/0;                          [Gerwulf starts with Warfare insteach of Armorer]
!#HE118:S19/1;

!#HE120:M29/1;                          [Mirlanda starts with Fire Shield in addition to Weakness]
!#HE120:S14/1;
!#HE120:S16/1;
!#HE120:S7/0;

!#HE122:S5/1;                           [Voy starts with Basic Nobility and Pathfinding instead of Expert Nobility and Wisdom]
!#HE122:S0/1;
!#HE122:S7/0;

!#HE123:S27/2;                          [Verdish starts with Advanced First Aid  instead of Wisdom and Basic FA]
!#HE123:S7/0;

!#HE124:S7/0;                           [Merist starts with Pathfinding, and Logistics instead of Wisdom and Learning]
!#HE124:S21/0;
!#HE124:S0/1;
!#HE124:S2/1;
!#HE124:X0/0;                           [Merist Pathfinding]

!#HE125:M20/1;                          [Styg starts with Frost Ring instead of Shield ->]
!#HE125:M27/0;                          [->]
!#HE125:S16/1;                          [-> and Water magic instead of Wisdom]
!#HE125:S7/0;

!#HE127:S9/2;                           [Tiva starts with Advanced Luck, Basic Eagle Eye]
!#HE127:S11/0;
!#HE127:S7/0;
!#HE127:F1/1/2/2;                       [Tiva also starts with least possible primary attributes]
!#HE127:M46/0;                          [Tiva doesn't know Stone Skin yet]
!#HE127:X0/9;                           [Luck]
*------------------------------------------*



*-------------Conflux------------------------*
!_#HE128:X1/182;       [Pasis Commander Specialist]

!#SN:W^Zulu_Mod_On^/?y1;

!#HE128&y1=0:X3/2;
!#UN&y1=0:G2/128/1/282; !#UN&y1=0:G2/128/3/282;

!#HE129&y1=0:X3/67;                     [Thunar Earth Elemental Spell]
!#HE129&y1=0:A1/0/17;                   [Get spell book]
!#HE129&y1=0:M67/1;                     [Get Summon Earth Elemental]
!#HE129&y1=0:S13/0;
!#HE129&y1=0:S19/0;                     [Delete Tactics and Estates]
!#HE129&y1=0:S17/2;                     [Get Advanced Earth Magic]
!#HE129&y1=0:F0/0/1/3;                  [Adjust Primary Skills]

!#HE130&y1=0:S10/1;                     [Ignissa starts with Ballistics instead of Offense]
!#HE130&y1=0:S22/0;
!#HE130&y1=0:X1/130;                    [Ignissa Fire Bird Specialist]
*#HE130&y1=0:X3/2;                      [Make Her Master of Spell so Firebird gets no additional Bonus]
!#HE130&y1=0:F0/0/1/1;                  [Adjust Primary Skills to lowest Possible]

!#HE131&y1=0:X0/19;                     [Lacus Warfare Specialist]

!#UN&y1=0:G2/130/1/232; !#UN&y1=0:G2/130/3/232;
!#UN&y1=0:G2/132/1/231; !#UN&y1=0:G2/132/3/231;
!#UN&y1=0:G2/133/1/230; !#UN&y1=0:G2/133/3/230;
!#UN&y1=0:G2/134/1/229; !#UN&y1=0:G2/134/3/229;
!#UN&y1=0:G2/135/1/228; !#UN&y1=0:G2/135/3/228;
!#UN&y1=0:G2/141/1/227; !#UN&y1=0:G2/141/3/227;
132 Monere    !#HE132&y1=0:X1/120;
133 Erdamon   !#HE133&y1=0:X1/113;
134 Fiur      !#HE134&y1=0:X1/114;
135 Kalt      !#HE135&y1=0:X1/115;
141 Aenian    !#HE141&y1=0:X1/226;


!#HE133&y1=0:C0/2/113/1;                [133 Erdamon starts with 1 Earth Element]

!#VRy10&y1=0:S2R1;                      [starts with 2 stacks 4-5 Fire Elements]
!#HE134&y1=0:C0/2/114/y10;

!#VRy10&y1=0:S4R2;                      [starts with 2 stacks 4-5 Water Elements]
!#HE135&y1=0:C0/2/115/y10;              [135 Kalt]

!#HE137&y1=0:S9/1;
!#HE137&y1=0:S7/0;                      [Brissa Luck instead of Wisdom]

!#HE138&y1=0:S25/1;                     [Ciele starts with Sorcery instead of Wisdom]
!#HE138&y1=0:S7/0;
!#HE138&y1=0:F0/0/2/2;                  [Adjust Primary Skills]

!#HE139&y1=0:S27/1;                     [Labetha First aid instead of Wisdom]
!#HE139&y1=0:S7/0;
!#HE139&y1=0:A1/6/15;                   [starts with first aid Tent]

!#HE140&y1=0:M43/0;                     [Inteus starts with Fireball instead of Bloodlust]
!#HE140&y1=0:M21/1;
!#HE140&y1=0:X3/21;

!#UN&y1=0:G2/140/1/140;
!#UN&y1=0:G2/140/3/140;                 [Fireball Specialist]

!#HE141&y1=0:X1/112;                    [Aenain Air Elemental Specialist]
!#HE141&y1=0:F2/1/1/1;                  [Adjust Primary Skills]
!#HE141&y1=0:S7/0;                      [Starts with Warfare and Ballistics instead of Wisdom and Air Magic.]
!#HE141&y1=0:S15/0;
!#HE141&y1=0:S19/1;
!#HE141&y1=0:S10/1;                     [141 Aenain]
!#VRy10&y1=0:S5R2;                      [starts with 2 stacks 4-5 Air Elements]
!#HE141&y1=0:C0/2/112/y10;

!#HE142&y1=0:S7/0;                      [Gelare starts with Expert Learning instead of Wisdom and Water Magic]
!#HE142&y1=0:S16/0;
!#HE142&y1=0:S21/3;
!#HE142&y1=0:X0/21;                     [Gelare Learning]

!#HE143&y1=0:S7/0;                      [Grindan remove Wisdom and Earth]
!#HE143&y1=0:S17/0;
!#HE143&y1=0:S4/1;                      [Gives Estates and Diplomacy]
!#HE143&y1=0:S13/1;
!#HE145&y1=0:X0/14;                     [Adrienne Is Fire]

!#SN:W^H3_Fire Magic_0_Hero145^/1;      [Adrienne starts with Grandmaster Fire]
!#SN:W^H3_Fire Magic_1_Hero145^/1;
*------------------------------------------*
Extension Heroes
*#HE144&y1=0:X0/14;                     [144 Sir Mullich - Speed]
!#HE146&y1=0:X1/6;                      [146 Catherine - Crusader]
*#HE147&y1=0:X0/14;                     [147 Dracon Enchanters]
*#HE148&y1=0:X0/14;                     [148 Gelu Sharpshooters]
!#HE149&y1=0:X1/96;                     [149 Kilgor Behemots]
!#HE150&y1=0:X1/66;                     [150 Lord Haart Black Knight ]
*#HE151&y1=0:X1/14;                     [151 Mutare Dragons]
!#HE152&y1=0:X1/6;                      [152 Roland Crusaders]
*#HE153&y1=0:X1/14;                     [153 Mutare Drake Dragons]
*#HE154&y1=0:X0/14;                     [154 Boragus Ogres]
!#HE155&y1=0:X1/54;                     [155 Xeron Devils]

*Pictures
!#UN&y1=0:G2/146/1/162; !#UN&y1=0:G2/146/3/162;
!#UN&y1=0:G2/149/1/215; !#UN&y1=0:G2/149/3/215;
!#UN&y1=0:G2/150/1/197; !#UN&y1=0:G2/150/3/197;
!#UN&y1=0:G2/152/1/162; !#UN&y1=0:G2/152/3/162;
!#UN&y1=0:G2/154/1/212; !#UN&y1=0:G2/154/3/212;
!#UN&y1=0:G2/155/1/191; !#UN&y1=0:G2/155/3/191;


********************************************************************************



                        Magic Weeks Section



********************************************************************************


**V-Vars used: v2125
**Z-Vars used: Z710-Z712
**Function used: F7779, FU(AC_Function_84)
**Flags used: V891, V936


!?BG0&1000/-936;                        [Disable Triggers in Quick Combat]
!!BA:Q?y1;
!!IF&y1=1:V936/1;
!!FU&y1=1:E;

********************************************************************************
!?FU(OnEveryDay)&i^timerOnce^=1/i^timerDay^>1/i^timerWeekDay^=1/i^timerIsAi^=0; [Trigger each monday]

!!VRy1:S0R46;                           [Set Random Week]
!!VRy1&y1=13:S13 R1;                    [Half chance for tripple Magic Arrow v=14 reserved]      *Fire]
!!VRy1&y1=15:S15 R1;                    [Half chance for quintuple Magic Arrow v=16 reserved]   *Water]
!!VRy1&y1=11:S11 R1;                    [Half chance for Implosion Bonus v=12 reserved]        *Earth]
!!VRy1&y1=17:S17 R1;                    [Half chance for Lightning Strike Bonus v=18 reserved]*Air]
!!VRy1&y1=19:S19 R1;                    [Half chance for Ice Lightning Bonus v=20 reserved]
!!VRy1&y1=21:S21 R1;                    [Half chance for Fireball Bonus v=22 reserved]
!!VRy1&y1=41:S41 R1;                    [Half chance for 2 extra casts]

!!VRy1&y1=28:S0;                        [Disabled Spell Counter Week]
!!VRy1&y1=27:S44;                       [Disabled Double Summoining Week]
!!VRy1&y1=43:S0;                        [Disabled Magic School Weeks]
!!SN:W^Critical_Sorcery_Mod^/?y10;
!!if&y10=0;
!!VRy1&y1=5:S10;                        [If Critical Sorcery Mod is disabled Set Week to more Spell Power]
!!VRy1&y1=6:S10;
!!en;

!!SN:W^Reworked_Magic_Specialists_Mod^/?y10;
!!if&y10=1;
!!VRy1|y1=23/y1=24/y1=25/y1=26:S0;      [If Reworked_Magic_Specialists_Mod is enabled Set Week to Nothing for now to prevent getting learned all spells if wrong mod order]
!!en;

*!VRy1:S34; **test var**                                                        [Set Week on purpose here for testing]

!!SN:W^Magic_Week_Number^/y1;
!!FU(Show_Magic_Week):P;


!?FU(Show_Magic_Week);

!!SN:W^Magic_Week_Number^/?y1;

!!if|y1=0/y1=20/y1=22;
!!SN:T^AC_Spells.No_Week^/?s^Magic_Week^;
!!IF&1000:Q2/13/0/1^%S(Magic_Week)^;    [Nothing this week]
!!en;

!!if&y1=1|y1=12;
!!SN:T^AC_Spells.Earth_Week^/?s^Magic_Week^;
!!IF&1000:Q2/20/56/1^%S(Magic_Week)^;   [Earth Week]
!!en;

!!if&y1=2|y1=14;
!!SN:T^AC_Spells.Air_Week^/?s^Magic_Week^;
!!IF&1000:Q2/20/50/1^%S(Magic_Week)^;   [Air Week]
!!en;

!!if&y1=3|y1=16;
!!SN:T^AC_Spells.Water_Week^/?s^Magic_Week^;
!!IF&1000:Q2/20/53/1^%S(Magic_Week)^;   [Water Week]
!!en;

!!if&y1=4|y1=18;
!!SN:T^AC_Spells.Fire_Week^/?s^Magic_Week^;
!!IF&1000:Q2/20/47/1^%S(Magic_Week)^;   [Fire Week]
!!en;

!!if&y1=5;
!!SN:T^AC_Spells.CritChance_Week^/?s^Magic_Week^;
!!IF&1000:Q2/9/19/1^%S(Magic_Week)^;    [Crit chance Week]
!!en;

!!if&y1=6;
!!SN:T^AC_Spells.CritDmg_Week^/?s^Magic_Week^;
!!IF&1000:Q2/9/57/1^%S(Magic_Week)^;    [Crit dmg Week]
!!en;

!!if&y1=7;
!!SN:T^AC_Spells.LessDmg_Week^/?s^Magic_Week^;
!!IF&1000:Q2/16/1/1^%S(Magic_Week)^;    [Less dmg Week]
!!en;

!!if&y1=8;
!!SN:T^AC_Spells.LessPoints_Week^/?s^Magic_Week^;
!!IF&1000:Q2/34/0/1^%S(Magic_Week)^;    [Mana Bonus]
!!en;

!!if&y1=9;
!!SN:T^AC_Spells.MagicArrow2X_Week^/?s^Magic_Week^;
!!IF&1000:Q2/9/15/1^%S(Magic_Week)^;    [Magic Arrow Bonus]
!!en;

!!if&y1=10;
!!SN:T^AC_Spells.SP10_Week^/?s^Magic_Week^;
!!IF&1000:Q2/33/0/1^%S(Magic_Week)^;    [Spell Power Bonus]
!!en;

!!if&y1=11;
!!SN:T^AC_Spells.Implosion_Week^/?s^Magic_Week^;
!!IF&1000:Q2/9/18/1^%S(Magic_Week)^;    [Implosion Bonus]
!!en;

!!if&y1=13;
!!SN:T^AC_Spells.MagicArrow3X_Week^/?s^Magic_Week^;
!!IF&1000:Q2/9/15/1^%S(Magic_Week)^;    [3X Magic Arrow Bonus]
!!en;

!!if&y1=15;
!!SN:T^AC_Spells.MagicArrow5X_Week^/?s^Magic_Week^;
!!IF&1000:Q2/9/15/1^%S(Magic_Week)^;    [5X Magic Arrow Bonus]
!!en;

!!if&y1=17;
!!SN:T^AC_Spells.LightningBolt_Week^/?s^Magic_Week^;
!!IF&1000:Q2/9/17/1^%S(Magic_Week)^;    [Lightning Strike Bonus]
!!en;

!!if&y1=19;
!!SN:T^AC_Spells.IceLigthing_Week^/?s^Magic_Week^;
!!IF&1000:Q2/9/16/1^%S(Magic_Week)^;    [Ice Lightning Bonus]
!!en;

!!if&y1=21;
!!SN:T^AC_Spells.Fireball_Week^/?s^Magic_Week^;
!!IF&1000:Q2/9/21/1^%S(Magic_Week)^;    [Fireball Bonus]
!!en;

!!if&y1=23;
!!SN:T^AC_Spells.FireSpells_Week^/?s^Magic_Week^;
!!IF&1000:Q2/8/86/1^%S(Magic_Week)^;    [All Fire Spells Bonus]
!!en;


!!if&y1=24;
!!SN:T^AC_Spells.AirSpells_Week^/?s^Magic_Week^;
!!IF&1000:Q2/8/87/1^%S(Magic_Week)^;    [All Air Spells Bonus]
!!en;


!!if&y1=25;
!!SN:T^AC_Spells.EarthSpells_Week^/?s^Magic_Week^;
!!IF&1000:Q2/8/89/1^%S(Magic_Week)^;    [All Earth Spells Bonus]
!!en;


!!if&y1=26;
!!SN:T^AC_Spells.WaterSpells_Week^/?s^Magic_Week^;
!!IF&1000:Q2/8/88/1^%S(Magic_Week)^;    [All Water Spells Bonus]
!!en;


!!if&y1=27;
!!SN:T^AC_Spells.Summon_Week^/?s^Magic_Week^;
!!IF&1000:Q2/9/66/1^%S(Magic_Week)^;    [All Summoning Bonus]
!!en;


!!if&y1=28;
!!SN:T^AC_Spells.SpellBlock_Week^/?s^Magic_Week^;
!!IF&1000:Q2/9/34/1^%S(Magic_Week)^;    [Spell block Bonus]
!!en;


!!if&y1=29;
!!SN:T^AC_Spells.Slow_Week^/?s^Magic_Week^;
!!IF&1000:Q2/9/54/1^%S(Magic_Week)^;    [Slow Bonus]
!!en;


!!if&y1=30;
!!SN:T^AC_Spells.Haste_Week^/?s^Magic_Week^;
!!IF&1000:Q2/9/53/1^%S(Magic_Week)^;    [Haste Bonus]
!!en;


!!if&y1=31;
!!SN:T^AC_Spells.Bless_Week^/?s^Magic_Week^;
!!IF&1000:Q2/9/41/1^%S(Magic_Week)^;    [Bless Bonus]
!!en;


!!if&y1=32;
!!SN:T^AC_Spells.Bloodlust_Week^/?s^Magic_Week^;
!!IF&1000:Q2/9/43/1^%S(Magic_Week)^;    [Bloodlust Bonus]
!!en;

!!if&y1=33;
!!SN:T^AC_Spells.StoneSkin_Week^/?s^Magic_Week^;
!!IF&1000:Q2/9/46/1^%S(Magic_Week)^;    [Stone Skin Bonus]
!!en;

!!if&y1=34;
!!SN:T^AC_Spells.CastI_Week^/?s^Magic_Week^;
!!IF&1000:Q2/33/0/1^%S(Magic_Week)^;    [Extra Cast Bonus 1]
!!en;

!!if&y1=35;
!!SN:T^AC_Spells.Artifact_Week^/?s^Magic_Week^;
!!IF&1000:Q2/33/0/1^%S(Magic_Week)^;    [Double Artifact Bonus]
!!en;

!!if&y1=36;
!!SN:T^AC_Spells.PointsDmg_Week^/?s^Magic_Week^;
!!IF&1000:Q2/34/0/1^%S(Magic_Week)^;    [Spell Point Bonus]
!!en;

!!if&y1=37;
!!SN:T^AC_Spells.FireCast_Week^/?s^Magic_Week^;
!!IF&1000:Q2/20/47/1^%S(Magic_Week)^;   [Reanable Fire Cast]
!!en;

!!if&y1=38;
!!SN:T^AC_Spells.WaterCast_Week^/?s^Magic_Week^;
!!IF&1000:Q2/20/53/1^%S(Magic_Week)^;   [Reanable Water Cast]
!!en;

!!if&y1=39;
!!SN:T^AC_Spells.EarthCast_Week^/?s^Magic_Week^;
!!IF&1000:Q2/20/56/1^%S(Magic_Week)^;   [Reanable earth Cast]
!!en;

!!if&y1=40;
!!SN:T^AC_Spells.AirCast_Week^/?s^Magic_Week^;
!!IF&1000:Q2/20/50/1^%S(Magic_Week)^;   [Reanable Air Cast]
!!en;

!!if&y1=41;
!!SN:T^AC_Spells.CastII_Week^/?s^Magic_Week^;
!!IF&1000:Q2/33/0/1^%S(Magic_Week)^;    [Extra Cast Bonus 2]
!!en;

!!if&y1=42;
!!SN:T^AC_Spells.SP20Bonus_Week^/?s^Magic_Week^;
!!IF&1000:Q2/33/0/1^%S(Magic_Week)^;    [Spell Power Bonus 20%]
!!en;

!!if&y1=43;
!!SN:T^AC_Spells.School_Week^/?s^Magic_Week^;
!!IF&1000:Q2/33/0/1^%S(Magic_Week)^;    [Magic Schools]
!!en;

!!if&y1=44;
!!SN:T^AC_Spells.Mana_Week^/?s^Magic_Week^;
!!IF&1000:Q2/34/0/1^%S(Magic_Week)^;    [Battle Mana Bonus]
!!en;

!!if&y1=45;
!!SN:T^AC_Spells.LvLDmg_Week^/?s^Magic_Week^;
!!IF&1000:Q2/33/0/1^%S(Magic_Week)^;    [Spell Damage per Level]
!!en;

!!if&y1=46;
!!SN:T^AC_Spells.MS_Week^/?s^Magic_Week^;
!!IF&1000:Q2/33/0/1^%S(Magic_Week)^;    [Magic Strength Bonus]
!!en;


When right-clicking on System Icon at Adventure Map show Magic Weeks
!?CM0&1000;
!!CM:F?v3 I?v4 S?v5;                    [where we click and click subtype]
!!FU(Show_Magic_Week)&v3=512/v4=12:P;   [if right click and specialty icon are clicked]


********************************************************************************
!?FU(OnBattlefieldVisible)&1000;        [Combat Spell Power for Hero (single player only right now)]

!!SN:W^Magic_Week_Number^/?y99;

!!IF:V936/0;                            [Quick Combat Flag]
!!SN&y99=34:W^Magic_Week_34_att^/1;     [Extra Cast Variable Attacker Set 1]
!!SN&y99=34:W^Magic_Week_34_def^/1;     [Extra Cast Variable Defender Set 1]

!!SN&y99=41:W^Magic_Week_41_att^/2;     [Extra Cast Variable Attacker Set 2]
!!SN&y99=41:W^Magic_Week_41_def^/2;     [Extra Cast Variable Defender Set 2]

!!BA:H0/?y88;                           [Attacking Hero]
!!BA:H1/?y89;                           [Defending Hero]

!!FU(AC_Function_83)&y88>=0:Py88/y99;   [For Attacker]Call Fkt Pass hero number and week number]
!!FU(AC_Function_83)&y89>=0:Py89/y99;   [For Defender]

!!HEy88&y88>=0/y99=44:Id10/1;           [Week 44 +10 Mana for each battle]
!!HEy89&y89>=0/y99=44:Id10/1;

!!SN:W^Week_Slow_Cast0^/0;              [So only works once per combat]
!!SN:W^Week_Slow_Cast1^/0;
!!SN:W^Week_Haste_Cast0^/0;             [So only works once per combat]
!!SN:W^Week_Haste_Cast1^/0;


!?FU(AC_Function_83);

!!SN:W^Spell_000^/0; !!SN:W^Spell_001^/0; !!SN:W^Spell_002^/0; !!SN:W^Spell_003^/0;
!!SN:W^Spell_004^/0; !!SN:W^Spell_005^/0; !!SN:W^Spell_006^/0; !!SN:W^Spell_007^/0;
!!SN:W^Spell_008^/0; !!SN:W^Spell_009^/0; !!SN:W^Spell_010^/0; !!SN:W^Spell_011^/0;
!!SN:W^Spell_012^/0; !!SN:W^Spell_013^/0; !!SN:W^Spell_014^/0; !!SN:W^Spell_015^/0;
!!SN:W^Spell_016^/0;

!!if&x2=23;
!!HEx1:M11/?y50 M13/?y51 M21/?y52 M22/?y53 M26/?y54 M29/?y55; [Check if the hero already has fire Spell]
!!HEx1:M31/?y56 M40/?y57 M42/?y58 M43/?y59 M52/?y60 M55/?y61;
!!HEx1:M56/?y62 M59/?y63 M62/?y64 M64/?y65 M66/?y66;

!!HEx1:M11/1 M13/1 M21/1 M22/1 M26/1 M29/1 M31/1;
!!HEx1:M40/1 M42/1 M43/1 M52/1 M55/1 M56/1 M59/1;
!!HEx1:M62/1 M64/1 M66/1;               [Give Spell]
!!en;

!!if&x2=24;
!!HEx1:M02/?y50 M04/?y51 M05/?y52 M06/?y53 M17/?y54 M19/?y55; [Check if the hero already has air Spell]
!!HEx1:M25/?y56 M28/?y57 M30/?y58 M36/?y59 M44/?y60 M47/?y61;
!!HEx1:M51/?y62 M53/?y63 M58/?y64 M60/?y65 M69/?y66;

!!HEx1:M02/1 M04/1 M05/1 M06/1 M17/1 M19/1 M25/1;
!!HEx1:M28/1 M30/1 M36/1 M44/1 M47/1 M51/1 M53/1;
!!HEx1:M58/1 M60/1 M69/1;               [Give Spell]
!!en;

!!if&x2=25;
!!HEx1:M03/?y50 M09/?y51 M10/?y52 M12/?y53 M14/?y54 M18/?y55; [Check if the hero already has Earth Spell]
!!HEx1:M23/?y56 M24/?y57 M27/?y58 M33/?y59 M34/?y60 M38/?y61;
!!HEx1:M39/?y62 M46/?y63 M50/?y64 M54/?y65 M67/?y66;

!!HEx1:M03/1 M09/1 M10/1 M12/1 M14/1 M18/1;
!!HEx1:M23/1 M24/1 M27/1 M33/1 M34/1 M38/1;
!!HEx1:M39/1 M46/1 M50/1 M54/1 M67/1;   [Give Spell]
!!en;

!!if&x2=26;
!!HEx1:M00/?y50 M01/?y51 M07/?y52 M08/?y53 M16/?y54 M20/?y55; [Check if the hero already has water Spell]
!!HEx1:M32/?y56 M35/?y57 M37/?y58 M41/?y59 M45/?y60 M48/?y61;
!!HEx1:M49/?y62 M61/?y63 M63/?y64 M65/?y65 M68/?y66;

!!HEx1:M00/1 M01/1 M07/1 M08/1 M16/1 M20/1;
!!HEx1:M32/1 M35/1 M37/1 M41/1 M45/1 M48/1;
!!HEx1:M49/1 M61/1 M63/1 M65/1 M68/1;   [Give Spells]
!!en;

!!SN:W^Spell_000^/y50; !!SN:W^Spell_001^/y51; !!SN:W^Spell_002^/y52; !!SN:W^Spell_003^/y53;
!!SN:W^Spell_004^/y54; !!SN:W^Spell_005^/y55; !!SN:W^Spell_006^/y56; !!SN:W^Spell_007^/y57;
!!SN:W^Spell_008^/y58; !!SN:W^Spell_009^/y59; !!SN:W^Spell_010^/y60; !!SN:W^Spell_011^/y61;
!!SN:W^Spell_012^/y62; !!SN:W^Spell_013^/y63; !!SN:W^Spell_014^/y64; !!SN:W^Spell_015^/y65;
!!SN:W^Spell_016^/y66;


********************************************************************************
!?FU(OnAfterBattleUniversal)&1000;

!!BA:H0/?y88;                           [Attacking Hero]
!!BA:H1/?y89;                           [Defending Hero]

!!SN:W^Magic_Week_Number^/?y99;

!!FU(AC_Function_82)&y88>=0:Py88/y99;   [For Attacker] Pass hero number and week number]
!!FU(AC_Function_82)&y89>=0:Py89/y99;

!!SN:W^Magic_Week_34_att^/0;            [Extra Cast Variable Attacker Reset]
!!SN:W^Magic_Week_34_def^/0;            [Extra Cast Variable Defender Reset]

!!SN:W^Magic_Week_41_att^/0;            [Extra Cast Variable Attacker Reset]
!!SN:W^Magic_Week_41_def^/0;            [Extra Cast Variable Defender Reset]

!!SN:W^Magic_Week_Spell_Element^/0;     [Extra Cast Variable Element Week Reset]


!?FU(AC_Function_82);

!!SN:W^Spell_000^/?y50; !!SN:W^Spell_001^/?y51; !!SN:W^Spell_002^/?y52; !!SN:W^Spell_003^/?y53;
!!SN:W^Spell_004^/?y54; !!SN:W^Spell_005^/?y55; !!SN:W^Spell_006^/?y56; !!SN:W^Spell_007^/?y57;
!!SN:W^Spell_008^/?y58; !!SN:W^Spell_009^/?y59; !!SN:W^Spell_010^/?y60; !!SN:W^Spell_011^/?y61;
!!SN:W^Spell_012^/?y62; !!SN:W^Spell_013^/?y63; !!SN:W^Spell_014^/?y64; !!SN:W^Spell_015^/?y65;
!!SN:W^Spell_016^/?y66;

!!if&x2=23;
!!HEx1&y50<>1:M11/0; !!HEx1&y51<>1:M13/0; !!HEx1&y52<>1:M21/0; !!HEx1&y53<>1:M22/0; !!HEx1&y54<>1:M26/0; !!HEx1&y55<>1:M29/0; !!HEx1&y56<>1:M31/0;
!!HEx1&y57<>1:M40/0; !!HEx1&y58<>1:M42/0; !!HEx1&y59<>1:M43/0; !!HEx1&y60<>1:M52/0; !!HEx1&y61<>1:M55/0; !!HEx1&y62<>1:M56/0; !!HEx1&y63<>1:M59/0;
!!HEx1&y64<>1:M62/0; !!HEx1&y65<>1:M64/0; !!HEx1&y66<>1:M66/0; [Take fire Spells]
!!en;

!!if&x2=24;
!!HEx1&y50<>1:M02/0; !!HEx1&y51<>1:M04/0; !!HEx1&y52<>1:M05/0; !!HEx1&y53<>1:M06/0; !!HEx1&y54<>1:M17/0; !!HEx1&y55<>1:M19/0; !!HEx1&y56<>1:M25/0;
!!HEx1&y57<>1:M28/0; !!HEx1&y58<>1:M30/0; !!HEx1&y59<>1:M36/0; !!HEx1&y60<>1:M44/0; !!HEx1&y61<>1:M47/0; !!HEx1&y62<>1:M51/0; !!HEx1&y63<>1:M53/0;
!!HEx1&y64<>1:M58/0; !!HEx1&y65<>1:M60/0; !!HEx1&y66<>1:M69/0; [Take air Spells]
!!en;

!!if&x2=25;
!!HEx1&y50<>1:M03/0; !!HEx1&y51<>1:M09/0; !!HEx1&y52<>1:M10/0; !!HEx1&y53<>1:M12/0; !!HEx1&y54<>1:M14/0; !!HEx1&y55<>1:M18/0; !!HEx1&y56<>1:M23/0;
!!HEx1&y57<>1:M24/0; !!HEx1&y58<>1:M27/0; !!HEx1&y59<>1:M33/0; !!HEx1&y60<>1:M34/0; !!HEx1&y61<>1:M38/0; !!HEx1&y62<>1:M39/0; !!HEx1&y63<>1:M46/0;
!!HEx1&y64<>1:M50/0; !!HEx1&y65<>1:M54/0; !!HEx1&y66<>1:M67/0; [Take earth Spells]
!!en;

!!if&x2=26;
!!HEx1&y50<>1:M00/0; !!HEx1&y51<>1:M01/0; !!HEx1&y52<>1:M07/0; !!HEx1&y53<>1:M08/0; !!HEx1&y54<>1:M16/0; !!HEx1&y55<>1:M20/0; !!HEx1&y56<>1:M32/0;
!!HEx1&y57<>1:M35/0; !!HEx1&y58<>1:M37/0; !!HEx1&y59<>1:M41/0; !!HEx1&y60<>1:M45/0; !!HEx1&y61<>1:M48/0; !!HEx1&y62<>1:M49/0; !!HEx1&y63<>1:M61/0;
!!HEx1&y64<>1:M63/0; !!HEx1&y65<>1:M65/0; !!HEx1&y66<>1:M68/0; [Take water Spells]
!!en;

********************************************************************************
!?MR1;

!!BG:H?y88;
!!FU&y88=-1:E;
!!BG:A?y1;                              [Hero casts a spell]
!!FU&y1<>1:E;
!!BG:S?y11;                             [y11 now contains spell number]
!!FU&y11<=9|y11>69:E;
!!FU(MSR_Determine_Spell_Type):Py11/?y20/?y21/?y22; [y22 Returns the Magic School of the Spell that was Cast  1Air  2Earth  4Fire  8Water   15Magic Arrow]
*!IF:M^Spell Element %Y-98 and %Y-97 and %Y-96 and Spell %Y11^;

!!SN:W^Magic_Week_Number^/?y99;

!!MR:F?y14;                             [get Spell damage in y14]

!!if&y99=36;                            [If week 36 ]
!!HEy88:I?y3/1;
!!VRy14:Sy14 +y3;                       [Add Current Spell Points to Magic Damage]
!!en;

!!if&y99=8;                             [Mana Bonus]
!!HEy88:Id3/1;
!!en;

!!if&y22=8;                             [Water]
!!VRy14|y99=3/y99=16:*125: 100;
!!en;

!!if&y22=4;                             [Fire]
!!VRy14|y99=4/y99=18:*125: 100;
!!en;

!!if&y22=1;                             [Air]
!!VRy14|y99=2/y99=14:*125: 100;
!!en;

!!if&y22=2;                             [Earth]
!!VRy14|y99=1/y99=12:*125: 100;
!!en;

!!if&y99=7;                             [less Magic Damage]
!!VRy14:*75: 100;
!!en;

!!if&y99=10;                            [10% Magic Damage]
!!VRy14:*110: 100;
!!en;

!!if&y99=42;                            [20% Magic Damage]
!!VRy14:*120: 100;
!!en;

!!if&y99=43;                            [5% per Magic School Magic Damage]
!!HEy88:S14/?y24; !!HEy88:S15/?y25; !!HEy88:S16/?y26; !!HEy88:S17/?y27;
!!VRy49:S100;
!!VRy49&y24>0:+5; !!VRy49&y25>0:+5; !!VRy49&y26>0:+5; !!VRy49&y27>0:+5;
!!VRy14:*y49: 100;
!!en;

!!if&y99=45;                            [1% per Hero Level Magic Damage]
!!HEy88:E?y30/?y48/1;
!!VRy49:Sy48+100;
!!VRy14:*y49: 100;
!!en;

!!if&y99=9/y11=15;                      [Magic Arrow Bonus]
!!VRy14:*200: 100;
!!en;

!!if&y99=13/y11=15;                     [3X Magic Arrow Bonus]
!!VRy14:*300: 100;
!!en;

!!if&y99=15/y11=15;                     [5X Magic Arrow Bonus]
!!VRy14:*500: 100;
!!en;

!!if&y99=11/y11=18;                     [Implosion Bonus]
!!VRy14:*130: 100;
!!en;

!!if&y99=17/y11=17;                     [Lightning Strike Bonus]
!!VRy15:S120R80;
!!VRy14:*y15: 100;
!!en;

!!if&y99=19/y11=16;                     [Ice Bolt Bonus]
!!VRy15:S120R80;
!!VRy14:*y15: 100;
!!en;

!!if&y99=21/y11=21;                     [Fireball Bolt Bonus]
!!VRy15:S120R80;
!!VRy14:*y15: 100;
!!en;

!!MR:Fy14;                              [Set new damage]



!?BG0;

!!SN:W^Magic_Week_Number^/?y99;
!!FU|y99<29/y99>30:E;
!!BG:H?y88;
!!FU&y88=-1:E;
!!BG:A?y1;                              [Hero casts a spell]
!!FU&y1<>1:E;
!!BG:S?y11;                             [y11 now contains spell number]
!!BG:Q?y3;

!!if&y11=53/y99=30;                     [If Spell is Haste]
!!SN&y3=0:W^Week_Haste_Cast0^/?y4;      [So only works once per combat]
!!SN&y3=1:W^Week_Haste_Cast1^/?y4;
!!FU&y4=1:E;
!!SN&y3=0:W^Week_Haste_Cast0^/1;        [So only works once per combat]
!!SN&y3=1:W^Week_Haste_Cast1^/1;
!!DO(AC_Function_84)/0/20/1&y3=0:P0/2;
!!DO(AC_Function_84)/21/40/1&y3=1:P0/2;
!!en;

!!if&y11=54/y99=29;                     [If Spell is Slow]
!!SN&y3=0:W^Week_Slow_Cast0^/?y4;       [So only works once per combat]
!!SN&y3=1:W^Week_Slow_Cast1^/?y4;
!!FU&y4=1:E;
!!SN&y3=0:W^Week_Slow_Cast0^/1;         [So only works once per combat]
!!SN&y3=1:W^Week_Slow_Cast1^/1;
!!DO(AC_Function_84)/21/41/1&y3=0:P0/3;
!!DO(AC_Function_84)/0/20/1&y3=1:P0/3;
!!en;





********************************************************************************
!?BG0&1000;                             [Continue trigger if magic week is enabled]

!!SN:W^Magic_Week_Number^/?y99;
!!FU:E;                                 [Disabled for now]

!!BG:A?y1;                              [Hero casts a spell]
!!FU&y1<>1:E;

!!BG:Q?y90;                             [Current attacking side]
!!BH0:N?y88;                            [Attacking Hero]
!!BH1:N?y89;                            [Defending Hero]

!!HEy88&y90=1:S8/?y20;
!!HEy89&y90=0:S8/?y21;
!!FU&y21=0/y20=0:E;

!!VRy20:*10;                            [chance to block at expert mysticism is 30%]
!!VRy21:*10;

!!BG:E?y1 A?y2 Q?y3 S?y4 N?y11;         [get destination stack, action type, side, spell, acting stack]
!!BMy1&y1>-1/y2=1:I?y5 P?y8;            [if hero casting, get side, position of target stack]
!!BMy1&y1>-1/y2=10:I?y5 P?y8;           [if monster casting, get side, position of target stack]

!!VRy10&y4>=27/y4<=33:S1;
!!VRy10|y4=37/y4=41/y4=43/y4=44/y4=46/y4=48/y4=49/y4=51/y4=53/y4=58:S1; [check for beneficial (mass) spells]

*!VRy9&y1=-1/y10=1:S1;                                                          [if hero cast spell with no target (mass) set to 1]
*!VRy9&y1>-1/y3=y5:S1;                                                          [if caster is targeting own side set to 1]

!!VRy6:S0R99;                           [random roll]
*!VRy6:S10;
*!IF:M^y6 is %Y6^;

!!VRy7&y3=0/y21>0/y6<y21:S1;            [if attacker cast, check against defender Eagle Eye rating]
!!VRy7&y3=1/y20>0/y6<y20:S1;            [if defender cast, check against attacker Eagle Eye rating]

!!BMy11&y1>-1/y7=1/y2=10:C0/y8/0/0/1 E?y12; [have current stack cast summon boat (for sound effect), get # of spells remaining]
!!VRy12&y1>-1/y7=1/y2=10:-1;            [reduce spell count by 1]
!!BMy11&y1>-1/y7=1/y2=10:V32 V32 V32 Ey12; [show animation (caster), reset spell count]
!!BG&y1>-1/y2=10/y7=1:A2;               [make unit move (cancel action)]

!!BG&y7=1/y2=1:S0;                      [reset spell to summon boat]
!!BMy11&y7=1/y2=1:V60 V60 V60;          [show animation (hero)]

!!VRz2&y7=1:S^{Magic Week} spell counter!^; [set combat message]
!!MM&y7=1:Sz2;                          [display combat message]


********************************************************************************
[Start of battlefield trigger]
!?BF&1000;

!!SN:W^Magic_Week_Number^/?y50;         [Exit if not correct week]

!!if|y50=31/y50=32/y50=33;
!!BA:H0/?y98 H1/?y99;

!!DO(AC_Function_84)/0/20/1&y98>=0:Py50/1;
!!DO(AC_Function_84)/21/40/1&y99>=0:Py50/1;
!!en;

!?FU(AC_Function_84);
!!BMx16&x1=31/x2=1:M41/99/3;            [Apply Expert Bless]
!!BMx16&x1=32/x2=1:M43/99/3;            [Apply Expert Bloodlust]
!!BMx16&x1=33/x2=1:M46/99/3;            [Apply Expert Stone Skin]
*!BMx16:M29/99/3;                                                                    [Apply Fire Shield]

!!BMx16:T?y1;
!!if&y1<145;
!!BMx16&x2=2:Sd1;                       [add Speed]

!!BMx16&x2=3:S?y2;
!!VRy2&x2=3:-1;
!!VRy2&x2=3/y2<=2:S2;
!!BMx16&x2=3:Sy2;                       [remove Speed]
!!en;                                   [Cannot be lower than 2]


********************************************************************************
!?BG1&1000;                             [1 extra cast per combat week 34]

!!SN:W^Magic_Week_Number^/?y50;
!!if&y50=34|y50=41;                     [Exit if wrong week]

!!BG:Q?y1;                              [Fix for Double Cast]
!!SN&y1=0:W^Double_Cast_Attacker^/?y4;
!!SN&y1=1:W^Double_Cast_Defender^/?y4;

!!if&y4=0;
!!BA:Q?f;
!!BG:Q?y90;                             [Current attacking side]
!!BH0:N?y88;                            [Attacking Hero]
!!BH1:N?y89;                            [Defending Hero]

!!HEy88&y88>=0/y90=0:S8/?y4;
!!HEy89&y89>=0/y90=1:S8/?y4;

!!VRy4:S3;                              [Added]

!!FU&y4=0:E;

!!if&y50=34;
!!BG:Q?y1;
!!SN&y1=0:W^Magic_Week_34_att^/?y2;
!!SN&y1=1:W^Magic_Week_34_def^/?y2;
!!FU&y2=0:E;
!!BHy1:M?y3;
!!FU&y3=0:E;
!!BHy1:M0;

!!SN&y1=0:W^Magic_Specialists_%V997_Cast_Count_Att^/d1;
!!SN&y1=1:W^Magic_Specialists_%V997_Cast_Count_Def^/d1;

!!VRz-1:S^%T(AC_Misc.Magic Week Extra Cast)^;
!!BU&i^battle_isVisible^:Mz-1;
!!SN&y1=0:W^Magic_Week_34_att^/0;
!!SN&y1=1:W^Magic_Week_34_def^/0;
!!en;

!!if&y50=41;
!!BG:Q?y1;
!!SN&y1=0:W^Magic_Week_41_att^/?y2;
!!SN&y1=1:W^Magic_Week_41_def^/?y2;
!!FU&y2=0:E;
!!BHy1:M?y3;
!!FU&y3=0:E;
!!BHy1:M0;

!!SN&y1=0:W^Magic_Specialists_%V997_Cast_Count_Att^/d1;
!!SN&y1=1:W^Magic_Specialists_%V997_Cast_Count_Def^/d1;

!!VRz-1:S^%T(AC_Misc.Magic Week Extra Cast)^;
!!BU&i^battle_isVisible^:Mz-1;
!!SN&y1=0:W^Magic_Week_41_att^/d-1;
!!SN&y1=1:W^Magic_Week_41_def^/d-1;
!!en;
!!en;
!!en;

********************************************************************************
!?BG0&1000;                             [Elemental extra cast per combat, week 37-40]

!!SN:W^Magic_Week_Number^/?y99;
!!FU&y99<37|y99>40:E;

!!BG:Q?y1;                              [Fix for Double Cast]
!!SN&y1=0:W^Double_Cast_Attacker^/?y4;
!!SN&y1=1:W^Double_Cast_Defender^/?y4;
!!SN:W^Magic_Week_Spell_Element^/0;

!!VRy10:S0R99;                          [25% Chance Roll]

!!if&y4=0/y10<25;

!!BG:Q?y90;                             [Current attacking side]
!!BHy90:N?y88;                          [Current Hero Number]

!!if&y88>=0;
!!BG:A?y82;                             [Hero casts a spell]
!!FU&y82<>1:E;
!!BG:S?y11;                             [y11 now contains spell number]
!!FU&y11<=9|y11>69:E;
!!FU(MSR_Determine_Spell_Type):Py11/0/0/?y22; [y22 Returns the Magic School of the Spell that was Cast  1Air  2Earth  4Fire  8Water   15Magic Arrow]

*!IF:M^Now Roll is successfull and no more double cast Element is %Y-98 and %Y99^;
!!SN&y99=37/y22=4:W^Magic_Week_Spell_Element^/y22;
!!SN&y99=38/y22=8:W^Magic_Week_Spell_Element^/y22;
!!SN&y99=39/y22=2:W^Magic_Week_Spell_Element^/y22;
!!SN&y99=40/y22=1:W^Magic_Week_Spell_Element^/y22;
!!en;
!!en;
********************************************************************************
!?BG1&1000;                             [Elemental extra cast per combat, week 37-40]

!!SN:W^Magic_Week_Number^/?y99;
!!FU&y99<37|y99>40:E;

!!SN:W^Magic_Week_Spell_Element^/?y5;
!!FU&y5=0:E;

!!BA:Q?f;
!!BG:Q?y90;                             [Current attacking side]

!!BHy90&y99=37/y5=4:M0;                 [Fire]
!!BHy90&y99=38/y5=8:M0;                 [Water]
!!BHy90&y99=39/y5=2:M0;                 [Earth]
!!BHy90&y99=40/y5=1:M0;                 [Air]

!!SN&y90=0:W^Magic_Specialists_%V997_Cast_Count_Att^/d1;
!!SN&y90=1:W^Magic_Specialists_%V997_Cast_Count_Def^/d1;

!!BHy90:M?y11;
!!if&y11=0;
!!VRz-1:S^FORTUNE^;
!!SN&i^battle_isVisible^:Pz-1;
!!VRz-1:S^%T(AC_Misc.Magic Week Extra Cast)^;
!!BU&i^battle_isVisible^:Mz-1;
!!en;

********************************************************************************
Spell Duration Mod from Alf :)

!?BG0;                                  [Before every action]
!!SN:W^Spell_Duration_Mod^/?y1;
!!FU&y1=0:E;                            [Exit if Mod not active]

!!SN:W^Duration_Mod_Hero_Id^/-1;        [Reset Var]
!!SN:W^Duration_Mod_Spell_Id^/-1;       [Reset Var]
!!SN:W^Duration_Mod_Changed^/0;         [Reset Var]

!!BG:A?y1;
!!FU&y1<>1:E;                           [If Hero Casts a Spell]

!!BG:S?y2;                              [Get spell id]
!!FU|y2<27/y2>62/y2=35/y2=37/y2=38/y2=39/y2=40/y2=47/y2=56/y2=57/y2=59:E;
Spells allowed: Shield, Air Shield, Fire Shield, Protection from element, Anti-magic, Magic Mirror, Bless, Curse, Bloodlust, Precision,
Weakness, Stone Skin, Prayer, Mirth, Sorrow, Fortune, Misfortune, Haste, Slow, Slayer, Counterstrike, Hypnotize, Forgetfulness, Blind.
!!SN:W^Duration_Mod_Spell_Id^/y2;       [Save spell id]

!!BG:H?y3;                              [Get hero id]
!!SN:W^Duration_Mod_Hero_Id^/y3;        [Save hero id]

------------------------------------------------------------------------------------------------------------------------
!?BG1;                                  [After action]
!!SN:W^Spell_Duration_Mod^/?y1;
!!FU&y1=0:E;                            [Exit if Mod not active]

!!SN:W^Duration_Mod_Hero_Id^/?y99;      [Get hero id]
!!SN:W^Duration_Mod_Spell_Id^/?y2;      [Get spell id]
!!FU|y99=-1/y2<10:E;                    [Exit if false]

!!BG:Q?y1;
!!BA:Hy1/?y99;
!!FU&y99=-2:E;

!!BG:D?y3;                              [Get hex id that was affected]
!!SSy2:O?y4;                            [Get which type of stack does the spell affect]
!!BG:Q?y5;                              [Get hero side]
!!FU(Calc_Spell_Duration):Py99/y2/?y6/?y7; [Get spell duration with new and old formula, accordingly.]
!!DO(Battle_Stacks_Valid_Spellcast)/0/41/1&y3=-1:Py99/y2/y4/y5/y6/y7; [Run Function and loop through all Battle stacks if not mass spell]
!!if&y3>-1/y3<187;                      [If casted spell is not mass and current stack is the target]
  !!BU:Ey3/?y1;                         [Get stack id standing on hex]
  !!BMy1&y1>=0:Gy2/?y3/?y4;             [Get current duration and power of the spell]
  !!FU&y3=0:E; <-- SadnessPower fix     [Exit if duration is 0 (spell has been resisted)]
  *!BMy1&y3=y7/y1>=0:Gy2/y6/y4;         
  !!BMy1&y1>=0:Gy2/y6/y4;               [Set duration if spell target valid, because according to TheInvisible1966 it sometimes fails to set propper duration]
!!en;
!!SN:W^Duration_Mod_Changed^/1;


!?FU(Battle_Stacks_Valid_Spellcast);    [For stacks that were affected, change duration from SP to 1.5 + SP/10, rounded down]
x1 hero id, x2 spell id, x3 type of target, x4 hero side, x5 new spell duration, x6 vanilla spell duration
!!BMx16:I?y1;                           [Get side of current stack]
!!VRy2:Sy1+x4;                          [Sum of hero side and stack side variables. Equals 1 if both from different side.]

!!if&x3=-1/y2=1;                        [If spell is mass, affects enemies and current stack is enemy]
  !!BMx16:Gx2/?y2/?y3;                  [Get current duration and power of the spell]
  *!BMx16&y2=x6:Gx2/x5/y3;              
  !!BMx16&y2>0:Gx2/x5/y3;               [Set duration if spell target valid]
!!en;

!!if&x3=1/y2<>1;                        [If spell is mass, affects allies and current stack is ally]
  !!BMx16:Gx2/?y2/?y3;
  *!BMx16&y2=x6:Gx2/x5/y3;              
  !!BMx16&y2>0:Gx2/x5/y3;               [Set duration if spell target valid]
!!en;


!?FU(Calc_Spell_Duration);
x1 hero id, x2 spell id, x3 returns new duration, x4 returns vanilla duration
y1-y20 reserved for spells, y21-y40 for artifacts.
!!HEx1:Fd/d/?y1/d S14/?y2 S15/?y3 S16/?y4 S17/?y5 S25/?y6; [Get current hero's Spellpower, Fire14 Air15 Water16 Earth17 and Sorcery(25, not used).]
!!VRx4:Sy1;                             [Duration first equals spellpower]
!!HEx1:A2/76/?y88/?y21;                 [Check for spell duration changing artifacts]
!!VRx4&y21=1:+1;                        [76 Collar of Conjuring]
!!HEx1:A2/77/?y88/?y22;
!!VRx4&y22=1:+2;                        [77 Ring of Conjuring]
!!HEx1:A2/78/?y88/?y23;
!!VRx4&y23=1:+3;                        [78 Cape of Conjuring]
!!HEx1:A2/139/?y88/?y24;
!!VRx4&y24=1:+56;                       [139 Ring of the Magi]

!!VRx3:Sy1+13;                          [Calculate new duration as (spellpower+13)/8, rounded down]
!!VRx3&y21=1:+5;                        [76 Collar of Conjuring gives 5 effective SP]
!!VRx3&y22=1:+10;                       [77 Ring of Conjuring gives 10 effective SP]
!!VRx3&y23=1:+15;                       [78 Cape of Conjuring gives 15 effective SP]
!!VRx3&y24=1:+100;                      [139 Ring of the Magi gives 100 effective SP]

!!VRx3&y2=3:+2;
!!VRx3&y3=3:+2;
!!VRx3&y4=3:+2;
!!VRx3&y5=3:+2;
!!SN:W^H3_Sorcery_1_Hero%X1^/?y11;
!!VRx3&y11=1:+10;                       [Grandmaster Sorcery gives extra 10 too]
!!VRx3::8;

****************************************************************************************************



Warmachine Upgrades and Enchantments Sections
By clicking on the Blacksmith or Mage Guild you can buyupgrades or enchantment for your Warmachines



****************************************************************************************************
Warmachine Upgrades and Enchantments. Call DL in Town Screen when clicking Smith or Mage Guild
!?FU(OnTownMouseClick)&i^mouse_action^=(MOUSE_RMB_PRESSED)/i^dlg_action^=(DLG_CMD_TYPE_DEFAULT)/i^mouse_flags^=(MOUSE_FLAG_RMB);

  !!CA(CURRENT_TOWN):H1/?(visitHero:y); [town Visitor]
  !!FU|(visitHero)<0/(visitHero)>155:E;

  !!if&i^mouse_item^>=0/i^mouse_item^<=4|i^mouse_item^=16;
    !!VR(itemAction:y):Si^mouse_item^ -4 F0/1 X1;
    !!SN:W^WM_Upgrade_Hero^/(visitHero);
    !!UN:P(WOG_OPT_DISABLE_TOWN_DEMOLISHING)/?(demolishTown:y);
    ; If demolishing town building is possible, avoid opening the DL when the town hall is not available (logical sense)
    !!if&(demolishTown)<>(TRUE);
      !!CA(CURRENT_TOWN):B3/10;         [10 - town hall]
      !!FU&-1:E;
    !!en;

    !!FU(Warmachine_Upgrade_Town):P(visitHero)/(itemAction); [Jump to Warmachine Function for Upgrades]
    !!SN:W^WM_Visit_Purchased^/0;
    ; If demolishing building is disabled, disbale standard mouseclick
    !!if&(demolishTown);
      !!CM:R0;
    ; If Demolishing building is possible set detailed conditoins
    !!el;
      ; For Mage Guild
      !!if&i^mouse_item^>=0/i^mouse_item^<=4;
        ; Check if Grail is built
        !!CA(CURRENT_TOWN):B3/26;
        ; If Grail is built, it is not possible to demolish mage guild so we disable standard action here
        !!if&1; 
          !!CM:R0;
        !!el;
          ; Check if any dwelling is built
          !!re i/30/36;
            !!CA(CURRENT_TOWN):B3/i;

            !!br&1;
          !!en;
          ; If any building is built, disable standard action
          !!CM&i<=36:R0;
        !!en;
      !!en;
      ; There is no demolishing requirement for Blacksmith
    !!en;
  !!en;


!?FU(gem_OnOpenButtonDlg);              [Function from GEM Mod that is called when clicking the new buttons]
  !!CA-1:H1/?y5;                        [town Visitor]
  !!FU|y5<0/y5>155:E;                   [Exit if no hero]
  !!SN:T^AC_Warmachine.GEM_Button_Smith^/?z20;
  !!SN:T^AC_Warmachine.GEM_Button_Smith_Hint^/?z21;
  !!SN:T^AC_Warmachine.GEM_Button_Ench^/?z22;
  !!SN:T^AC_Warmachine.GEM_Button_Ench_Hint^/?z23;
  !!SN:W^WM_Upgrade_Hero^/y5;

  !!FU(gem_AddTownButton):P^upgrsmth.def^/46/40/^%Z20^/^%Z21^/^%Z21^/(Warmachine_Upgrade_Town)/y5/0/0; [Blacksmith button]
  !!FU(gem_AddTownButton):P^MageGld.def^/46/40/^%Z22^/^%Z23^/^%Z23^/(Warmachine_Upgrade_Town)/y5/1/0; [Enchanter button]
  !!SN:W^WM_Visit_Purchased^/0;


!?FU(OnCustomDialogEvent)&i^dlg_id^=(ACM_WM_DLG_ID);
  !!if&i^mouse_action^=(MOUSE_LMB_RELEASED);
    !!if&i^mouse_item^>=10/i^mouse_item^<=13;
      !!VR(supPage:y):Si^mouse_item^ -10;
      !!if&(supPage)<>i^acm_Dlg_WM_Page^;
        !!VRi^acm_Dlg_WM_Page^:S(supPage);
        !!FU(acm_Dlg_WarMachines_AdjustView):Pi^dlg_id^/i^acm_Dlg_WM_Page^;
        !!FU(acm_Dlg_WarMachines_AdjustEnchNames):Pi^dlg_id^/i^acm_Hero_WM_skill_names_temp_array_ID^/i^acm_Dlg_WM_Type^/i^acm_Dlg_WM_Page^;
      !!en;

    !!el|i^mouse_item^=30722/i^mouse_item^=30723;
      !!FU(acm_WM_Try_Upgrade):Pi^acm_Dlg_WM_Type^/i^acm_Dlg_WM_Page^/i^acm_WM_Current_Chosen_Skill^/i^acm_Hero_WM_skill_names_temp_array_ID^/i^acm_WM_Requires_temp_array_ID^;

    !!el|i^mouse_item^=30720/i^mouse_item^=30721;
      !!DL:C1;
    !!el&i^mouse_item^=14;
      !!VRi^acm_Dlg_WM_CallAgain^:S(TRUE);
      !!DL:C1;
    !!en;

  !!el&i^mouse_item^>=1/i^mouse_item^<=3;
    !!SN&i^mouse_action^=(MOUSE_LMB_PRESSED):P^button.wav^;

    !!FU(acm_Dlg_WarMachines_ShowSkillDesc):Pi^mouse_item^/i^acm_Dlg_WM_Page^;

    !!if&i^mouse_action^=(MOUSE_LMB_PRESSED);
      !!FU(H3Dlg_GetCurrentDlg):P?(dlg:y);
      !!re i/41/44;
        !!FU(acm_DlgShowItem):Pi/(TRUE)/(TRUE)/(FALSE)/(dlg);
      !!en;
      !!VRi^acm_Dlg_WM_LastItemClicked^:Si^mouse_item^;
      !!VRi^acm_Dlg_WM_LastPageClicked^:Si^acm_Dlg_WM_Page^;

      !!VR(frame:y):Si^acm_Dlg_WM_Page^ *3 +i^mouse_item^ -1;
      !!DLi^dlg_id^:A41/(DLG_CMD_SET_DEF_FRAME)/(frame)/1;
      !!VRi^acm_WM_Current_Chosen_Skill^:Si^acm_Dlg_WM_Type^ *12 +(frame);

      !!SN:T^AC_Warmachine.%s(acm_wm)_%s(acm_temp)_%i(mouse_item)^/?(text:z);
      !!DLi^dlg_id^:A42/(DLG_CMD_SET_TEXT)/(text)/1;
      !!DLi^dlg_id^:A43/(DLG_CMD_SET_DEF_FRAME)/i^acm_Dlg_WM_upg_state_%i(mouse_item)^/1;
      !!FU(acm_WM_Upg_GetCost):Pi^acm_Dlg_WM_Type^/i^acm_Dlg_WM_Page^/i^mouse_item^/(FALSE); [/?(skillId:y);]

      !!FU(acm_Dlg_WarMachines_AdjustEnchNames):Pi^dlg_id^/i^acm_Hero_WM_skill_names_temp_array_ID^/i^acm_Dlg_WM_Type^/i^acm_Dlg_WM_Page^;
    !!en;

  !!el&i^mouse_item^=41;
    !!FU(acm_Dlg_WarMachines_ShowSkillDesc):Pi^acm_Dlg_WM_LastItemClicked^/i^acm_Dlg_WM_LastPageClicked^;

  !!el&i^mouse_item^=44;
    !!SN:H^secskill^/i^acm_WM_Upg_req_skill^/1/?(msg:z);
    !!VR(pic:y):Si^acm_WM_Upg_req_skill^ *3 +3;
    !!IF:Q1/(PIC_TYPE_SEC_SKILL)/(pic)/(MSG_TYPE_POPUP)/(msg);
  !!en;


!?FU(acm_WM_Try_Upgrade);
!#VA(dlgType:x) (page:x) (chosenSkill:x) (skillsArrayID:x) (resourcesArrayId:x);
  !!if&(chosenSkill)<>(NO_SKILL);
    !!if&i^acm_WM_%(page)^;
      !!SN:M(skillsArrayID)/(chosenSkill)/?(variableName:z);
      !!VRy99:Si^%(variableName)^;

      !!if&i^%(variableName)^=0;
        !!if&i^acm_WM_Upg_req_skill^<>(NO_SKILL);
          !!HEi^WM_Upgrade_Hero^:Si^acm_WM_Upg_req_skill^/?(skillLvl:y);

          !!if&(skillLvl)=(NULL);
            !!IF:M^%T(AC_Warmachine.cant_afford)^;
            !!FU:E;
          !!en;

        !!en;
        !!if&i^WM_Upgrade_No_Resources^=0;

          !!re i/0/(RES_LAST_WOG);
            !!SN:M(resourcesArrayId)/i/?(value:y);
            !!OW:R(CURRENT_PLAYER)/i/d-(value);
          !!en;
          !!if&(dlgType);
            !!SN:P^Enchant Item.wav^;
          !!el;
            !!SN:P^fixit.wav^;
          !!en;

          !!VRi^acm_wm_buyed_upg^:S(TRUE);
          !!VRi^%(variableName)^:S(TRUE);
          !!DLi^dlg_id^:A45/(DLG_CMD_SET_TEXT)/^%T(AC_Warmachine.Purchased)^/0;
          !!DLi^dlg_id^:A43/(DLG_CMD_SET_DEF_FRAME)/i^%(variableName)^/1;
          !!FU(acm_Dlg_WarMachines_AdjustEnchNames):Pi^dlg_id^/(skillsArrayID)/(dlgType)/(page);
        !!el;

          !!FU(Play_Upgrade_Sound):P(dlgType)/2;

          !!IF:M^%T(AC_Warmachine.cant_afford)^;
        !!en;
      !!el;        
        !!IF:M^%T(AC_Warmachine.Already_Bought)^;
      !!en;
    !!el;
      !!FU(acm_WM_No_WM_Error):P(page);
    !!en;
  !!el;
    !!IF:M^%T(AC_Warmachine.No_Upgrade)^;
  !!en;


!?FU(acm_WM_No_WM_Error);
!#VA(page:x);
  !!if&(page)=0;
    !!IF:M^%T(AC_Warmachine.No_Ballista)^;
  !!el&(page)=1;
    !!IF:M^%T(AC_Warmachine.No_Ammo)^;

  !!el&(page)=2;
    !!IF:M^%T(AC_Warmachine.No_Tent)^;

  !!el&(page)=3;
    !!IF:M^%T(AC_Warmachine.No_Machines)^;
  !!en;


!?FU(acm_WM_Upg_SetCost);
!#VA(resources[8]:x) (skillId:x) (justExit:x);

  !!if&(justExit)=(TRUE);
     !!VRi^acmSkillRequired^:S(skillId);
     !!FU:E;
  !!en;
  !!VRf:S0; 
  !!VR(cost:z):S^^;
  !!VRi^WM_Upgrade_No_Resources^:S(FALSE);

  !!re i/0/7;
    !!if&(resources[i])>0;
      !!VRf:+1;
      !!VR(cost)&f=5:+^
^;
      !!OW:R-1/i/?(playerRes:y);
      !!if&(playerRes)>=(resources[i]);
        !!VR(cost):+^%(resources[i]) {~>smalres.def:%i}, ^;
      !!el;
        !!VRi^WM_Upgrade_No_Resources^:S(TRUE);
        !!VR(cost):+^{~r}%(resources[i])} {~>smalres.def:%i}, ^;
      !!en;
    !!en;
    !!SN:Mi^acm_WM_Requires_temp_array_ID^/i/(resources[i]);    
  !!en;
  !!SN:K(cost)/?(length:y);
  !!if&(length)>1;
    !!VR(length):-2;
    !!SN:K(cost)/(length)/^.^;
  !!en;

  !!DLi^dlg_id^:A45/(DLG_CMD_SET_TEXT)/(cost)/1;
  !!SN:Mi^acm_WM_Requires_temp_array_ID^/8/(skillId);    
  !!VR(random:y):R0/1/3;
  !!SN:T^AC_Warmachine.Buying_%(random)^/?(ask:z);
  !!DLi^dlg_id^:A50/(DLG_CMD_SET_TEXT)/(ask)/1;

  !!VRi^acm_WM_Upg_req_skill^:S(skillId);
  !!if&(skillId)<>(NO_SKILL);
    !!SN:H^secskill^/(skillId)/0/?(skillName:z); 
    !!HEi^WM_Upgrade_Hero^:S(skillId)/?(skillLvl:y);
    !!SN:K(skillName)/0/?(char:z);

    !!if&(char)=^{^;
      !!VR(clearName:z):S^^;
      !!SN:K(skillName)/?(length:y);
      !!re j/1/(length)/1/-1;
        !!SN:K(skillName)/j/?(char:z);
        !!if|(char)=^{^/(char)=^}^;
          !!br;
        !!en;
        !!VR(clearName):+(char);
      !!en;
    !!el;
      !!VR(clearName:z):S(skillName);

    !!en;

    !!if&(skillLvl);
      !!VRz-3:S^{~gold}%(clearName)}^;
    !!el;
      !!VRz-3:S^{~r}%(clearName)}^;
    !!en;

    !!SN:T^AC_Warmachine.Requirement_2^/?z1 Iz1/?z1;
    !!VR(skillId):*3+3;
    !!DLi^dlg_id^:A44/(DLG_CMD_SET_DEF_FRAME)/(skillId)/1;
    !!DLi^dlg_id^:A40/(DLG_CMD_SET_TEXT)/z1/1;
  !!el;
    !!DLi^dlg_id^:A40/(DLG_CMD_SET_TEXT)/^^/1;

    !!FU(H3Dlg_GetCurrentDlg):P?(dlg:y);
    !!FU(acm_DlgShowItem):P44/(FALSE)/(FALSE)/(FALSE)/(dlg);
  !!en;


!?FU(acm_WM_Upg_GetCost);
!#VA(type:x) (page:x) (upg:x) (justExit:x);

  !!if&(type);
    !!if&(page)=0;
      !!FU(acm_WM_Upg_SetCost)&(upg)=1:P0/0/0/15/10/0/10000/0/(SKILL_AIR_MAGIC)/(justExit); [Fireball Attack]
      !!FU(acm_WM_Upg_SetCost)&(upg)=2:P0/10/0/0/0/0/20000/0/(SKILL_SORCERY)/(justExit); [Magic Arrow]
      !!FU(acm_WM_Upg_SetCost)&(upg)=3:P0/15/0/15/15/15/5000/0/(SKILL_DIPLOMACY)/(justExit); [Spell Trigger]
    !!el&(page)=1;
      !!FU(acm_WM_Upg_SetCost)&(upg)=1:P15/0/10/10/0/0/10000/0/(SKILL_OFFENCE)/(justExit); [Booby Trap]
      !!FU(acm_WM_Upg_SetCost)&(upg)=2:P5/5/5/5/5/5/5000/0/(SKILL_TACTICS)/(justExit); [Replenish Spell Points]
      !!FU(acm_WM_Upg_SetCost)&(upg)=3:P20/5/5/20/5/5/15000/0/(SKILL_FIRE_MAGIC)/(justExit); [Fire Arrow]
    !!el&(page)=2;
      !!FU(acm_WM_Upg_SetCost)&(upg)=1:P5/5/5/5/5/5/10000/0/(SKILL_FIRST_AID)/(justExit); [Herbalism]
      !!FU(acm_WM_Upg_SetCost)&(upg)=2:P2/2/2/2/2/2/15000/0/(SKILL_LEARNING)/(justExit); [Overheal]
      !!FU(acm_WM_Upg_SetCost)&(upg)=3:P0/5/10/5/5/5/20000/0/(SKILL_WATER_MAGIC)/(justExit); [Life Aura]
    !!el&(page)=3;
      !!FU(acm_WM_Upg_SetCost)&(upg)=1:P0/5/0/2/2/5/8000/0/(SKILL_EARTH_MAGIC)/(justExit); [Shield Enchantment]
      !!FU(acm_WM_Upg_SetCost)&(upg)=2:P5/5/5/5/5/5/6000/0/(NO_SKILL)/(justExit); [Magic Resistence]
      !!FU(acm_WM_Upg_SetCost)&(upg)=3:P10/10/10/10/10/10/10000/0/(SKILL_NAVIGATION)/(justExit); [Resistance Aura]
    !!en;
  !!el;
    !!if&(page)=0;
      !!FU(acm_WM_Upg_SetCost)&(upg)=1:P15/0/15/0/0/0/6000/0/(SKILL_LEADERSHIP)/(justExit); [Ballista_Morale]
      !!FU(acm_WM_Upg_SetCost)&(upg)=2:P5/5/5/5/5/5/10000/0/(SKILL_EAGLE_EYE)/(justExit); [Ballista_Add_Shots]
      !!FU(acm_WM_Upg_SetCost)&(upg)=3:P5/5/5/5/5/5/15000/0/(SKILL_BALLISTICS)/(justExit); [Ballista_Crippling]
    !!el&(page)=1;
      !!FU(acm_WM_Upg_SetCost)&(upg)=1:P0/0/0/0/0/0/10000/0/(SKILL_RESISTANCE)/(justExit); [Ammo_Supply]
      !!FU(acm_WM_Upg_SetCost)&(upg)=2:P5/5/5/5/5/5/10000/0/(SKILL_LUCK)/(justExit); [Ammo_Goblin]
      !!FU(acm_WM_Upg_SetCost)&(upg)=3:P20/0/0/20/0/0/15000/0/(SKILL_MYSTICISM)/(justExit); [Ammo_Enhanced_Arrow]
    !!el&(page)=2;
      !!FU(acm_WM_Upg_SetCost)&(upg)=1:P0/0/0/0/0/10/8000/0/(SKILL_ARMORER)/(justExit); [Tent_Improved]
      !!FU(acm_WM_Upg_SetCost)&(upg)=2:P0/0/0/0/10/0/6000/0/(SKILL_SCHOLAR)/(justExit); [Tent_Capacity_Upgrade]
      !!FU(acm_WM_Upg_SetCost)&(upg)=3:P0/5/0/5/5/5/10000/0/(SKILL_ESTATES)/(justExit); [Tent_Gold_Gain]
    !!el&(page)=3;
      !!FU(acm_WM_Upg_SetCost)&(upg)=1:P10/0/20/0/0/0/5000/0/(SKILL_ARTILLERY)/(justExit); [WM_Fortification]
      !!FU(acm_WM_Upg_SetCost)&(upg)=2:P10/0/0/0/0/0/10000/0/(NO_SKILL)/(justExit); [WM_Maintainability]
      !!FU(acm_WM_Upg_SetCost)&(upg)=3:P10/10/10/0/0/0/10000/0/(SKILL_PATHFINDING)/(justExit); [WM_Versatility]
    !!en;
  !!en;


!?FU(acm_Dlg_WarMachines_ShowSkillDesc);
!#VA(index:x) (dlgPage:x);
  !!FU(acm_Dlg_WarMachines_AdjustTextVariableNames):P(dlgPage);
  !!if&(dlgPage)=3;
    !!SN:T^AC_Warmachine.%s(acm_wm)_%s(acm_temp)_%(index)^/?z-1; [Get Upgrade Name of 1st]
    !!SN:T^AC_Warmachine.%s(acm_wm)_WM_%s(acm_temp)_%(index)_Description^/?z1; [set text for 1st]
  !!el;
    !!SN:T^AC_Warmachine.%s(acm_wm)_%s(acm_temp)_%(index)^/?z-1; [Get Upgrade Name of 1st]
    !!SN:T^AC_Warmachine.%s(acm_wm)_%s(acm_temp)_%(index)_Description^/?z1; [set text for 1st]
  !!en;
  !!SN:Iz1/?z1;
  !!IF:M0/4/^%Z1^;


!?FU(acm_Dlg_WarMachines_AdjustTextVariableNames);
!#VA(dlgPage:x);
  !!if&(dlgPage)=0;
    !!VRs^acm_wm^:S^Bal^;
  !!el&(dlgPage)=1;
    !!VRs^acm_wm^:S^Cart^;
  !!el&(dlgPage)=2;
    !!VRs^acm_wm^:S^Tent^;
  !!el&(dlgPage)=3;
    !!VRs^acm_wm^:S^All^;
  !!en;


!?FU(acm_Dlg_WarMachines_AdjustView);
!#VA(dlgId:x) (dlgPage:x);

  !!FU(acm_Dlg_WarMachines_AdjustTextVariableNames):P(dlgPage);

  !!re i/1/3;
    !!VR(frame:y):S(dlgPage) *3 +i-1;
    !!DL(dlgId):Ai/(DLG_CMD_SET_DEF_FRAME)/(frame)/1;

    !!SN:T^AC_Warmachine.%s(acm_wm)_%s(acm_temp)_%i^/?(text:z);
    !!VR(textId:y):Si+3;
    !!DL(dlgId):A(textId)/(DLG_CMD_SET_TEXT)/(text)/1;
  !!en;

  !!re i/0/2;
    !!VR(itemId:y):S46 +i;
    !!if&(dlgPage)=i/i^acm_WM_%i^=0;
      !!DL(dlgId):A(itemId)/(DLG_CMD_SET_TEXT)/^{~r}%i(acm_WM_%i)}^/1;

    !!el&(dlgPage)=3/i^acm_WM_%i^=0;
      !!DL(dlgId):A(itemId)/(DLG_CMD_SET_TEXT)/^{~r}%i(acm_WM_%i)}^/1;
    !!el;
      !!DL(dlgId):A(itemId)/(DLG_CMD_SET_TEXT)/^%i(acm_WM_%i)}^/1;
    !!en;
  !!en;


!?FU(acm_Dlg_WarMachines_AdjustEnchNames);
!#VA(dlgId:x) (skillsArrayID:x) (dlgType:x) (dlgPage:x);
  !!re i/1/3;
    !!VR(itemOffset:y):S(dlgPage) *3;
    !!VR(variableId:y):S(dlgType)*12 +(itemOffset) +i -1;
    !!SN:M(skillsArrayID)/(variableId)/?(variableName:z);
    !!VRi^acm_Dlg_WM_upg_state_%i^:Si^%(variableName)^;
    !!VR(defId:y):Si+6;
    !!DL(dlgId):A(defId)/(DLG_CMD_SET_DEF_FRAME)/i^acm_Dlg_WM_upg_state_%i^/1;
  !!en;


****************************************************************************************************
!?FU(Warmachine_Upgrade_Town);
x1=Hero Number, x1= 1 or 2 (Blacksmith or Mage Guild)
  !!VRi^acm_Dlg_WM_CallAgain^:S(TRUE);
  !!FU(Play_Upgrade_Sound):Px2/1;

  !!VR(revertDlgType:y):Sx2 X1;
  !!re i;
    !!if&i^acm_Dlg_WM_CallAgain^;
      !!VR(revertDlgType):X1;
      !!SN:P^Enter.wav^;
      !!FU(acm_Dlg_WarMachines_Prepare):Px1/(revertDlgType)/(ACM_WM_DLG_ID);
      !!if&i^acm_wm_buyed_upg^;
        !!FU(Play_Upgrade_Sound):P(revertDlgType)/4;
      !!el;
        !!FU(Play_Upgrade_Sound):P(revertDlgType)/3;
      !!en;
    !!el;
      !!br;
    !!en;
  !!en;

  !!FU(acm_Dlg_WarMachines_Destruct):P;
  !!UN:R4;

!?FU(Play_Upgrade_Sound);
!#VA(upgType:x) (upgCase:x);
  !!CA-1:T?y1;
  !!if&y1>=(TOWN_FIRST)/y1<=(TOWN_LAST_WOG);
    !!VRz2&y1=0:S^Hu^;
    !!VRz2&y1=1:S^Dw^;
    !!VRz2&y1=2:S^Wi^;
    !!VRz2&y1=3:S^Ev^;
    !!VRz2&y1=4:S^Ev^;
    !!VRz2&y1=5:S^Wa^;
    !!VRz2&y1=6:S^Wa^;
    !!VRz2&y1=7:S^Hu^;
    !!VRz2&y1=8:S^El^;
    !!if&(upgType);
      !!VRz3:S^%Z2_MS_0%X2.wav^;
    !!el;
      !!VRz3:S^%Z2_WS_0%X2.wav^;        [play quest sound before showing dialogue]
    !!en;
    !!SN:Pz3;                           [play quest sound before showing dialogue]
  !!en;


!?FU(acm_Dlg_WarMachines_Destruct);
  !!SN:W^acm_temp^;
  !!SN:W^acm_wm^;
  !!SN:W^acm_Dlg_WM_Type^;
  !!SN:W^acm_Dlg_WM_LastItemClicked^;
  !!SN:W^acm_Dlg_WM_LastPageClicked^;

  !!SN:W^acm_Dlg_WM_Page^;
  !!SN:W^acm_WM_Current_Chosen_Skill^;
  !!SN:W^acm_WM_Upg_req_skill^;
  !!SN:W^acm_WM_Requires_temp_array_ID^;
  !!SN:W^acm_Hero_WM_skill_names_temp_array_ID^;
  !!SN:W^acm_Hero_WM_skill_names_temp_array_ID^;
  !!SN:W^acm_wm_buyed_upg^;
  !!re i/0/3;
    !!SN:W^acm_Dlg_WM_upg_state_%i^;
    !!SN:W^acm_WM_%i^;
  !!en;


!?FU(acm_Dlg_WarMachines_SetCorrectType);
!#VA(dlgType:x) (dlgId:x) (dlg:x);

  !!if&(dlgType)=1;
    !!DL(dlgId):A17/(DLG_CMD_SET_TEXT)/^{~GoldenRod}%T(AC_Warmachine.Enchantment)}^/1;
    !!DL(dlgId):A18/(DLG_CMD_SET_TEXT)/^{~GoldenRod}%T(AC_Warmachine.Enchantment)}^/1;

    !!DL(dlgId):A13/(DLG_CMD_SET_DEF)/^enchant.def^/1;
    !!DL(dlgId):A14/(DLG_CMD_SET_DEF)/^upgrsmth.def^/1;

    !!DL(dlgId):A29/(DLG_CMD_SET_DEF)/^titlmage.def^/1;
    !!DL(dlgId):A30722/(DLG_CMD_SET_DEF)/^enchmage.def^/1;
    !!DL(dlgId):A30723/(DLG_CMD_SET_DEF)/^enchmage.def^/1;


    !!FU(acm_DlgShowItem):P22/(FALSE)/(FALSE)/(FALSE)/(dlg);
    !!DL(dlgId):A1/52/320/1 A1/53/187/1;
    !!DL(dlgId):A2/52/446/1 A2/53/282/1;
    !!DL(dlgId):A3/52/270/1 A3/53/372/1;

    !!DL(dlgId):A41/52/619/1 A41/53/104/1;
    !!DL(dlgId):A30721/52/438/1 A30721/53/420/1;

    !!DL(dlgId):A30723/52/400/1 A30723/53/390/1;
    !!DL(dlgId):A41/(DLG_CMD_SET_DEF)/^wm_ench.def^/1;
    !!FU(acm_DlgItemSize):P41/82/76/(dlg);

    !!re i/1/3;
      !!FU(acm_DlgItemSize):Pi/82/76/(dlg);
      !!FU(acm_DlgItemPosition):Pi/?(x:y)/?(y:y)/(dlg);
      !!DL(dlgId):Ai/(DLG_CMD_SET_DEF)/^wm_ench.def^/1;
      !!VR(textId:y):Si+3;
      !!VR(defId:y):Si+6;
      !!VR(x):-6;
      !!VR(y):+78;
      !!DL(dlgId):A(defId)/52/(x)/1 A(defId)/53/(y)/1;
      !!VR(y):+4;
      !!DL(dlgId):A(textId)/52/(x)/1 A(textId)/53/(y)/1;
    !!en;
    !!VRs^acm_temp^:S^Ench^;
  !!el;
    !!DL(dlgId):A17/(DLG_CMD_SET_TEXT)/^{~GoldenRod}%T(AC_Warmachine.Upgrade)}^/1;
    !!DL(dlgId):A18/(DLG_CMD_SET_TEXT)/^{~GoldenRod}%T(AC_Warmachine.Upgrade)}^/1;
    !!VRs^acm_temp^:S^Upg^;
  !!en;


!?FU(acm_Dlg_WarMachines_Prepare);
!#VA(heroId:x) (dlgType:x) (dlgId:x);
  !!VRi^acm_Dlg_WM_CallAgain^:S(FALSE); [prevent calling dlg again]

  !!DL(dlgId):N^WM_Upg_d.txt^;          [parse dialogue]
  !!FU(DL_FindById):P(dlgId)/?(dlg:y);
  !!UN:C(dlg)/(UNC_INT)/?(dlg);

  !!FU(acm_Dlg_WarMachines_SetCorrectType):P(dlgType)/(dlgId)/(dlg);

  //set correct background pic
  !!DL(dlgId):A100/(DLG_CMD_SET_PCX)/^dl_wm_%(dlgType).pcx^/1;

  //set correct header pic
  !!DL(dlgId):A51/(DLG_CMD_SET_DEF_FRAME)/(dlgType)/1;

  !!DL(dlgId):A23/(DLG_CMD_SET_TEXT)/^%T(AC_Warmachine.Ballista_0)^/1;
  !!DL(dlgId):A24/(DLG_CMD_SET_TEXT)/^%T(AC_Warmachine.Cart_0)^/1;
  !!DL(dlgId):A25/(DLG_CMD_SET_TEXT)/^%T(AC_Warmachine.Tent_0)^/1;
  !!DL(dlgId):A26/(DLG_CMD_SET_TEXT)/^%T(AC_Warmachine.Warmachines_0)^/1;
  !!SN:T^AC_Warmachine.Say_Hello_%s(acm_temp)^/?(visit:z);
  !!DL(dlgId):A27/(DLG_CMD_SET_TEXT)/(visit)/1;
  !!DL(dlgId):A28/(DLG_CMD_SET_TEXT)/^%T(AC_Warmachine.Exit)^/1;

  !!re i/41/44;
    !!FU(acm_DlgShowItem):Pi/(FALSE)/(FALSE)/(FALSE)/(dlg);
  !!en;

  !!VRi^acm_wm_buyed_upg^:S(FALSE);
  !!VRi^acm_WM_Current_Chosen_Skill^:S(NO_SKILL);
  !!VRi^acm_Dlg_WM_Type^:S(dlgType);
  !!VRs^acm_wm^:S^Bal^;
  !!VRi^acm_Dlg_WM_Page^:S0;
  !!HEi^WM_Upgrade_Hero^:A2/(ART_BALLISTA)/d/?i^acm_WM_0^ A2/(ART_AMMO_CART)/d/?i^acm_WM_1^ A2/(ART_FIRST_AID_TENT)/d/?i^acm_WM_2^;
  !!VRi^acm_WM_3^:S1 &i^acm_WM_0^ &i^acm_WM_1^ &i^acm_WM_2^;

  !!FU(NewIntArray):P9/?i^acm_WM_Requires_temp_array_ID^;

  !!FU(NewStrArray):P?i^acm_Hero_WM_skill_names_temp_array_ID^;

  !!FU(Array_Push):Pi^acm_Hero_WM_skill_names_temp_array_ID^/^Ballista_Morale_%X1^/^Ballista_Add_Shots_%X1^/^Ballista_Crippling_%X1^/^Ammo_Supply_%X1^/^Ammo_Goblin_%X1^/
  ^Ammo_Enhanced_Arrow_%X1^/^Tent_Improved_%X1^/^Tent_Capacity_Upgrade_%X1^/^Tent_Gold_Gain_%X1^/^WM_Fortification_%X1^/^WM_Maintainability_%X1^/^WM_Versatility_%X1^;
  !!FU(Array_Push):Pi^acm_Hero_WM_skill_names_temp_array_ID^/^Ballista_Fireball_Attack_%X1^/^Ballista_Magic_Arrow_%X1^/^Ballista_Spell_Trigger_%X1^/^Ammo_Booby_Trap_%X1^/^Ammo_Replensih_SP_%X1^/
  ^Ammo_Burning_Arrow_%X1^/^Tent_Herbalism_%X1^/^Tent_Overheal_%X1^/^Tent_Life_Aura_%X1^/^WM_Shield_Ench_%X1^/^WM_MR_Ench_%X1^/^WM_MR_Aura_%X1^;

  !!FU(acm_Dlg_WarMachines_AdjustView):P(dlgId)/i^acm_Dlg_WM_Page^;
  !!FU(acm_Dlg_WarMachines_AdjustEnchNames):P(dlgId)/i^acm_Hero_WM_skill_names_temp_array_ID^/(dlgType)/i^acm_Dlg_WM_Page^; [/i^WM_Upgrade_Hero^;]

  !!DL(dlgId):S;                        [parse dialogue]


****************************************************************************************************

                      Combat Scripting of War machines Upgrades

****************************************************************************************************
*Teach AI how to use WM Upgrades and Enchantments
!?HL-1;
!!HE-1:O?(owner:y);                     [Exit if not AI's hero]
!!OW:I(owner)/?(isAi:y);
!!FU&(isAi)<>(TRUE):E;

There are 24 Upgrades in total.
!!HE-1:Ed/?(level:y)/1;                 [Get Hero Number and level]
!!FU&(level)<=5:E;                      [Exit if level is smaller or equal 5 or above 50]
!!FU&(level)>50:E;

!!VRi^heroLevel^:S(level);
!!HE-1:N?i^heroNumber^;

!!re i/1/i^heroLevel^;                  [number of attempts to gain an obtainable new WM ability = heroLevel]
   !!VRi^randomRoll^:R0/0/23;           [Generate Random Number from 0-23]
   !!VRi^type^:S(TRUE);                 [convert in type[0..1] page[0..3] upg[1..3] format]
   !!VRi^type^&i^randomRoll^>12:S(FALSE);
   !!VRi^page^:Si^randomRoll^ %12 :3;
   !!VRi^upg^:Si^randomRoll^ %12 %3 +1;
   !!FU(acm_WM_Upg_GetCost):Pi^type^/i^page^/i^upg^/(TRUE); [get secondary skill required]
   !!VRi^randomRoll^:+1;                [convert in [1..24]]
   !!HE-1&i^acmSkillRequired^<>(NO_SKILL):Si^acmSkillRequired^/?(isSkillPresent:y); [check hero for required skill]
   !!VR(isSkillPresent)&i^acmSkillRequired^=(NO_SKILL):S(TRUE);

   !*IF:M^%i: RandomRoll=%i(randomRoll) - type=%i(type) page=%i(page) upg=%i(upg) 
SkillRequired=%i(acmSkillRequired)  isSkillPresent=%(isSkillPresent)^;
   !!if&(isSkillPresent)<>(FALSE);
      !!VR(heroWMAbilityName:z)&i^randomRoll^=1:S^Ballista_Fireball_Attack_%i(heroNumber)^;
      !!VR(heroWMAbilityName)&i^randomRoll^=2:S^Ballista_Magic_Arrow_%i(heroNumber)^;
      !!VR(heroWMAbilityName)&i^randomRoll^=3:S^Ballista_Spell_Trigger_%i(heroNumber)^;
      !!VR(heroWMAbilityName)&i^randomRoll^=4:S^Ammo_Booby_Trap_%i(heroNumber)^;   
      !!VR(heroWMAbilityName)&i^randomRoll^=5:S^Ammo_Replensih_SP_%i(heroNumber)^;
      !!VR(heroWMAbilityName)&i^randomRoll^=6:S^Ammo_Burning_Arrow_%i(heroNumber)^;
      !!VR(heroWMAbilityName)&i^randomRoll^=7:S^Tent_Herbalism_%i(heroNumber)^;
      !!VR(heroWMAbilityName)&i^randomRoll^=8:S^Tent_Overheal_%i(heroNumber)^;
      !!VR(heroWMAbilityName)&i^randomRoll^=9:S^Tent_Life_Aura_%i(heroNumber)^;
      !!VR(heroWMAbilityName)&i^randomRoll^=10:S^WM_Shield_Ench_%i(heroNumber)^;
      !!VR(heroWMAbilityName)&i^randomRoll^=11:S^WM_MR_Ench_%i(heroNumber)^;
      !!VR(heroWMAbilityName)&i^randomRoll^=12:S^WM_MR_Aura_%i(heroNumber)^;
      !!VR(heroWMAbilityName)&i^randomRoll^=13:S^Ballista_Morale_%i(heroNumber)^;
      !!VR(heroWMAbilityName)&i^randomRoll^=14:S^Ballista_Add_Shots_%i(heroNumber)^;
      !!VR(heroWMAbilityName)&i^randomRoll^=15:S^Ballista_Crippling_%i(heroNumber)^;
      !!VR(heroWMAbilityName)&i^randomRoll^=16:S^Ammo_Supply_%i(heroNumber)^;
      !!VR(heroWMAbilityName)&i^randomRoll^=17:S^Ammo_Goblin_%i(heroNumber)^;
      !!VR(heroWMAbilityName)&i^randomRoll^=18:S^Ammo_Enhanced_Arrow_%i(heroNumber)^;
      !!VR(heroWMAbilityName)&i^randomRoll^=19:S^Tent_Improved_%i(heroNumber)^;
      !!VR(heroWMAbilityName)&i^randomRoll^=20:S^Tent_Capacity_Upgrade_%i(heroNumber)^;
      !!VR(heroWMAbilityName)&i^randomRoll^=21:S^Tent_Gold_Gain_%i(heroNumber)^;
      !!VR(heroWMAbilityName)&i^randomRoll^=22:S^WM_Fortification_%i(heroNumber)^;
      !!VR(heroWMAbilityName)&i^randomRoll^=23:S^WM_Maintainability_%i(heroNumber)^;
      !!VR(heroWMAbilityName)&i^randomRoll^=24:S^WM_Versatility_%i(heroNumber)^;   

      !!FU(CheckAndGainWMAbility):P(heroWMAbilityName)/?(isAlreadyPresent:y);
      !!FU&(isAlreadyPresent)=(FALSE):E;[exit the function if hero has gained a new ability]
   !!en;
!!en;

!?FU(CheckAndGainWMAbility);            [add the WM ability to hero if not already present]
!#VA(abilityName:x) (return:x);         [return 0: Skill added, 1: Already present]

!!SN:Wz(abilityName)/?(return);         [check if already present]
!!SN&(return)=0:Wz(abilityName)/1;      [add it if not already present]
!*IF:M^abilityName=%z(abilityName), isAlreadyPresent=%(return)^;


**********************Fortified Warmachines* Add HP and Def to all**********************************
*adds 250HP and 5 Defense to all WM*

!?FU(OnCombatRound)&v997=0;             [On First visible combat round]

!!BA:H0/?y1;
!!SN:W^WM_Fortification_%Y1^/?y10;
!!VRy5:S5;                              [Attack and Defense]
!!VRy6:S250;                            [Health]

!!re i/0/10;
  !!BMi:T?y3;                           [Get Creature Type ]
    !!if&y10=1;
      !!if|y3=145/y3=146/y3=147/y3=148; [If Ballista found for Defender]
        !!BMi:Ddy5;
        !!BMi:Hdy6;
      !!en;
    !!en;
!!en;

!!BA:H1/?y1; !!FU&y1<0:E;               [Exit if no Defending Hero]
!!SN:W^WM_Fortification_%Y1^/?y10; !!FU&y10=0:E;
!!re i/21/31;
  !!BMi:T?y3;                           [Get Creature Type ]
    !!if&y10=1;
      !!if|y3=145/y3=146/y3=147/y3=148; [If Ballista found for Defender]
        !!BMi:Ddy5;
        !!BMi:Hdy6;
      !!en;
    !!en;
!!en;


**********************Warmachines can have Morale********************
*Sets Morale Flag to Ballista*
!?BG0&1000;

!!VRy1:S0R99;
!!FU&y1>=10:E;                          [10% chance for Morale]
!!BG:N?y1;                              [Attacking Stack]
!!BMy1:T?y2 N?y3;
!!BG:A?y4;                              [Aktion in y1]
!!BG:H?y5;                              [Current Hero]
!!FU&y5<0:E;                            [Exit if no Hero]
!!SN:W^Ballista_Morale_%Y5^/?y6;

!!if&y2=146/y3=1/y4=7/y6=1;
!!UN:C4605354/4/1;                      [some UN C Magic]
!!SN:W^Warmachines_Morale_Trigger^/1;   [enable Flag]
!!en;

!?BG1&1000;

!!SN:W^Warmachines_Morale_Trigger^/?y1; [check flag]
!!FU&y1<>1:E;                           [exit if not]
!!SN:W^Warmachines_Morale_Trigger^/0;   [reset flag]
!!UN:C4605354/4/24;


!?BF&1000;
*Remove Ballista Flag for no morale for attacker and defender
!!BA:H0/?y1;
!!SN:W^Ballista_Morale_%Y1^/?y2;
!!if&y1>=0/y2=1;
  !!re i/0/10;
    !!BMi:T?y3;
    !!if&y3=146;
      !!BMi:F?y1;
      !!VRy1:&-131073;                  [Flag for no morale]
      !!BMi:Fy1;
    !!en;
  !!en;
!!en;

!!BA:H1/?y1;
!!SN:W^Ballista_Morale_%Y1^/?y2;
!!if&y1>=0/y2=1;
  !!re i/21/31;
    !!BMi:T?y3;
    !!if&y3=146;
      !!BMi:F?y1;
      !!VRy1:&-131073;                  [Flag for no morale]
      !!BMi:Fy1;
    !!en;
  !!en;
!!en;

************************Ballista Enchantment Fireball Attack**********************
*Fireball Attack deals 33% of the damage to all surrounding creatures

!?MF1;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!FU&y10<>4455011:E;                    [Shooting Damage]

!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>7:E;                           [or Shoot]
!!BG:N?y1;                              [Attacking Stack]
!!BMy1:T?y40;                           [Get Type in y40]
!!FU&y40<>146:E;                        [Exit if no Ballista as Attacker]
!!MF:N?y4;                              [damage receiving stack]
!!BMy4:T?y40;                           [Get Type in y40]

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;                           [Exit if no Hero]
!!SN:W^Ballista_Fireball_Attack_%Y99^/?y90; [Check if options have already been activated]
!!FU&y90=0:E;                           [Exit if enchantment is not bought]

!!BA:Q?f;
!!BMy4&i^battle_isVisible^:V53;         [Show Fireball animation]
!!BMy4:P?y1 I?y30;                      [get target position and Side]
!!FU(ACM_GetStackHeadPosition):Py4/?y1; [While BM:P returns the position of the "ass" of a wide stack, this function always returns the position of the head]
!!CM&1000:D?y1;                         [get where we clicked to have correct position of the fireball]
!!MF:F?y10;                             [get damage of ballista]
!!VRy10::3;                             [33% of the damage]

!!VRy31:S(FALSE);                       [Indicator for damage dealt]

!!if&y1>=0/y1<=186;                     [If valid battlefield position]
  !!re i/0/5;
    !!FU(AC_Function_126):Py1/0/?y3; 
    !!VRy8&y3=-1:S-1;

    !!if&y3>=0/y3<=186;
      !!BU:Ey3/?y8;           [-2 if there is alive stack at that position]

      !!if&y8>=0/y8<=41/y4<>y8;
        !!BMy8:I?y40;     [apply damage to surrounding creatures]

        !!if&y40=y30;
          !!BMy8:Ky10; [apply damage to surrounding creatures if same side]
          !!VRy31:S(TRUE);
        !!en;
      !!en;
    !!en;
  !!en;
!!en;

; If damage was dealt by BM:K, refresh the screen and check phoenix type resurrections
!!if&y31;
  !!FU(ACM_DrawActionPlay):P;
  !!FU(ACM_ExecutePhoenixResurrection):P;
!!en;

************************Ballista Magic Arrow upgrade**********************
*Magic Damage based on your SP*5 is added to damage

!?MF1;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!FU&y10<>4455011:E;                    [Shooting Damage]

!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>7:E;                           [or Shoot]
!!BG:N?y1;                              [Attacking Stack]
!!BMy1:T?y40;                           [Get Type in y40]
!!FU&y40<>146:E;                        [Exit if no Ballista as Attacker]
!!MF:N?y4;                              [damage receiving stack]
!!BMy4:T?y40;                           [Get Type in y40]

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;                           [Exit if no Hero]
!!SN:W^Ballista_Magic_Arrow_%Y99^/?y90; [Check if options have already been activated]
!!FU&y90=0:E;                           [Exit if enchantment is not bought]
!!HEy99:F?y9/?y9/?y11/?y9;
!!VRy12:Sy11*5+20;                      [add 5* Spell Power from Hero to Damage +20]
!!MF:F?y10;                             [get damage of ballista]
!!VRy13:Sy10+y12;
!!MF:Fy13;

************************Ballista Spell Trigger upgrade**********************
*Chance with every hit to Trigger a Spell on the Target

!?MF1;

!!VRy1:S0R99;
!!FU&y1>10:E;                           [10% Chance to Trigger the Spell]
!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!FU&y10<>4455011:E;                    [Shooting Damage]

!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>7:E;                           [or Shoot]
!!BG:N?y1;                              [Attacking Stack]
!!BMy1:T?y40;                           [Get Type in y40]
!!FU&y40<>146:E;                        [Exit if no Ballista as Attacker]
!!MF:N?y4;                              [damage receiving stack]
!!BMy4:T?y40;                           [Get Type in y40]

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;                           [Exit if no Hero]
!!SN:W^Ballista_Spell_Trigger_%Y99^/?y90;[Check if options have already been activated]
!!FU&y90=0:E;                           [Exit if enchantment is not bought]
!!BMy4:P?y2;
!!VRy10:S0R6;
!!VRy11|y10=0/y10=1:S15;                [Magic Arrow]
!!VRy11|y10=2/y10=3:S16;                [Ice Bolt]
!!VRy11|y10=4/y10=5:S17;                [Lightning]
!!VRy11&y10=6:S18;                      [Implosion]
!!BMy1:Cy11/y2/3/3/1;                   [Make Ballista Cast Spell on Target]

****************************************************************************************************
*Ammo Cart adds a little bonus movement +100 if upgrade was purchased
; Replaced by Archer's implementation
!?FU(OnEveryDay)&i^timerIsAi^=0;
!!FU:E;

!!re y1/0/155;
  !!HEy1:O?y2;                          [Checke Hero Owner]
  !!if&y2>=0/y2<=7;                     [if any valid owner]  
    !!SN:W^Ammo_Supply_%Y1^/?y11;       [Check if options have already been activated]
    !!HEy1:A2/5/?y9/?y10;               [5 Ammo Cart]
    !!HEy1&y10=1/y11=1:Wd100/1;         [Add little Bonus Movement]
    !!HEy1&y10=1/y11=1:W?y20/1;         [Get current movementpoints]
    !!HEy1&y10=1/y11=1:Gy20/1;          [Set maximum movement points]
    !!SN&y10=1/y11=1:W^ACM_Total_add_movement_%Y1^/y20;
  !!en;
!!en;


************************Ammo Cart Supply Upgrade***********************************************
*+1 Speed in first Battle Round

!?FU(OnAfterTacticsPhase); [Moved timing from OnCombatRound to OnAfterTacticsPhase to have correct move order in battle]

!!SN:W^Ammo_Speed_Bonus_Att^/0;
!!SN:W^Ammo_Speed_Bonus_Def^/0;

!!BH0:N?y1;                             [Attacker]
!!HEy1:A2/5/?y1/?y10;                   [5 Ammo Cart]
!!SN:W^Ammo_Supply_%Y1^/?y11;           [Check if options have already been activated]
!!DO(AC_Function_4)/0/20/1&y10=1/y11=1:P1; [Increase Speed]
!!SN&y10=1/y11=1:W^Ammo_Speed_Bonus_Att^/1; [Set Flag for Attacker]

!!BH1:N?y1;                             [Defender]
!!FU&y1<0:E;
!!HEy1:A2/5/?y1/?y10;                   [5 Ammo Cart]
!!SN:W^Ammo_Supply_%Y1^/?y11;           [Check if options have already been activated]
!!DO(AC_Function_4)/21/41/1&y10=1/y11=1:P1;
!!SN&y10=1/y11=1:W^Ammo_Speed_Bonus_Def^/1;


!?FU(OnCombatRound)&v997=1;

!!SN:W^Ammo_Speed_Bonus_Att^/?y1;       [Check Flag]
!!DO(AC_Function_4)/0/20/1&y1=1:P2;     [Reduce Speed]
!!SN:W^Ammo_Speed_Bonus_Def^/?y1;
!!DO(AC_Function_4)/21/41/1&y1=1:P2;


***************************Ballista Upgrade**********************
*Chance for Crushing Blow for Ballista at Blacksmith
First hit works 100%, the next Arrow only has 20% chance to hit
!?MF1;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!FU&y10<>4455011:E;                    [Shooting Damage]

!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>7:E;                           [or Shoot]

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!BMy1:T?y2;                            [Creature Type]
!!FU&y2<>146:E;                         [Exit if no Ballista]
!!BG:H?y5;                              [Hero Number]
!!SN:W^Ballista_Crippling_%Y5^/?y6;     [Exit if no Upgrade]
!!FU|y6=0/y5<0:E;
!!SN:W^Ballista_Crippling_Target_%Y4^/?y1; [Set flag that creature has been targetet with ballista]

!!if&y1=1;
  !!VRy10:S0R99;
  !!FU&y10>=24:E;                       [If Target has already been hit the next arrow only has 25% chance to crush]
!!en;
!!if&y1>1;
  !!VRy10:S0R99;
  !!FU&y10>=14:E;                       [If Target has already been hit the next arrow only has 15% chance to crush]
!!en;

!!BMy4&i^battle_isVisible^:V14;
!!BMy4:Ad-4;                            [Attack -x]
!!BMy4:Dd-4;                            [Defense -x]
!!BMy4:Sd-1;                            [Speed -x]
!!BMy4:A?y20; !!VRy20&y20<=1:S1; !!BMy4:Ay20;
!!BMy4:D?y21; !!VRy21&y21<=1:S1; !!BMy4:Dy21;
!!BMy4:S?y22; !!VRy22&y22<=3:S3; !!BMy4:Sy22;

!!SN:W^Ballista_Crippling_Target_%Y4^/d1;[Set flag that creature has been targetet with ballista]
!!SN&i^battle_isVisible^:P^DWRFDFND^;

!?BF;
!!re y1/0/41;
!!SN:W^Ballista_Crippling_Target_%Y1^/0;[Set flag that creature has been targetet with ballista]
!!en;


*********************************Burning Arrows*****************************************************
*Blacksmith Upgrade for Ammo Cart lets ranged attacks burn enemies for 10% (or 15% with Fire Orb) of the damage in the next round
!?MF1;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!FU&y10<>4455011:E;                    [Shooting Damage]

!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>7:E;                           [or Shoot]
!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!BMy4:T?y40;                           [Get Type in y40]
!!FU|y40=33/y40=52/y40=53/y40=82/y40=83/y40=114/y40=116/y40=117/y40=121/y40=125:E;
!!FU|y40=129/y40=130/y40=131/y40=155/y40=158/y40=164/y40=195:E;
!!BMy4:G31/?y41/?y42;                   [Get Fire Resistance]
!!FU&y41>0/y42=3:E;                     [Exit if Expert Fire Resistance]

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;                           [Exit if no Hero]
!!SN:W^Ammo_Burning_Arrow_%Y99^/?y90;
!!FU&y90=0:E;                           [Exit if Set is not complete (6)]

!!HEy99:A2/5/?y10/?y16;                 [5  Ammo Cart ]
!!FU&y16=0:E;                           [Exit if No Ammo Cart]
!!HEy99:A2/81/?y10/?y16;                [81 Orb of Tempestuous Fire]
!!VRy50:S10;                            [Set to 10% Fire Damage]
!!VRy50&y16=1:S15;                      [Set to 15% with Orb]
!!MF:F?y6;
!!VRy7:Sy6*y50:100;                     [Take 10% of damage dealt]
!!FU&y7=0:E;                            [Exit if not enough damage]
!!BMy4:M21/1/3;                         [apply incinerate to stack]
!!BMy4&y4=0:M21/2/3;                    [fix?]
!!SN:W^Burned_Stack_%Y4^/dy7;           [Add and Stack Damage to the Stack]


***************************Ammo Cart Enhanced Arrows**********************
*+1 Max damage to all troops
!?FU(OnCombatRound)&v997=0;

!!BH0:N?y1;                             [Attacker]
!!HEy1:A2/5/?y2/?y10;                   [5 Ammo Cart]
!!SN:W^Ammo_Enhanced_Arrow_%Y1^/?y11;   [Check if options have already been activated]
!!if&y10=1/y11=1;
  !!re i/0/20;
    !!BMi:T?y5;                         [Get Creature Type]
    !!BMi&y5<>145/y5<>147/y5<>148/y5<>149:U2/d1; [+1Max Damage]
  !!en;
!!en;

!!BH1:N?y1; !!FU&y1<0:E;                [Defender]
!!HEy1:A2/5/?y2/?y10;                   [5 Ammo Cart]
!!SN:W^Ammo_Enhanced_Arrow_%Y1^/?y11;   [Check if options have already been activated]
!!if&y10=1/y11=1;
  !!re i/21/41;
    !!BMi:T?y5;                         [Get Creature Type]
    !!BMi&y5<>145/y5<>147/y5<>148/y5<>149:U2/d1; [+1Max Damage]
  !!en;
!!en;


***************************Ammo Cart Booby Trap**********************
*If Strike kills Ammo Cart it explodes and deals 25%+2000 points of damage in melee
; Archer30: The timing of explosion is bad - it happens before the melee attack landing on the ammo cart
!?MF1&1000;
!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4456676;           [Only run when melee or surround damage]

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!BMy4:T?y40;                           [Get Type in y40]
!!FU&y40<>148:E;                        [Exit if not Ammo Cart]

!!BMy4:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;                           [Exit if no Hero]
!!SN:W^Ammo_Booby_Trap_%Y99^/?y90;
!!FU&y90=0:E;                           [Exit if Upgrade not bought]

!!BMy4:H?y10;                           [Get Health of Ammo Cart]
!!MF:F?y6;                              [get damage]
!!BA:Q?f;                               [get battle side]
!!if&y6>=y10;                           [If damage is biggger than Health of Ammo Cart]
  !!BMy1:N?y2 H?y4 I?y7;                [get number and health of attackins stack and side]
  !!BA:Hy7/?y99;                        [get attacking hero ID]
  !!if&y99>=0/y99<=155;
    !!HEy99:S26/?y8;                    [get resistance skill level]
    !!SN:W^H3_Resistance_0_Hero%Y99^/?y10; [get MR level]
    !!SN:W^H3_Resistance_1_Hero%Y99^/?y11;
    !!VRy9:S100; 
    !!VRy9&y8=1:S95;                    [Basic]
    !!VRy9&y8=2:S90;                    [Advanced]
    !!VRy9&y8=3:S85;                    [Expert]
    !!VRy9&y8=3/y10=1/y11=0:S80;        [Master]
    !!VRy9&y8=3/y10=1/y11=1:S75;        [Grandmaster]
  !!en;
  !!VRy5:Sy2*y4:4+2000*y9:100;          [Damage of Booby trap is 25% health +2000 damage and reduction from resistance skill because it is considered magic damage]
  !!BMy1:Ky5;                           [apply damage to stack]
  !!BMy1:N?y3;                          [get new stack number]
  !!if&y3=0/y2>0;                       [If monster would be killes set to summon so it vanishes]
    !!BMy1:F?i;                         [get flag]
    !!VRi:|813694976;                   [set summoning flag so it vanishes from battlefield on next damage]
    !!BMy1:Fi K1;                       [set new modified bit]
  !!en;

  !!if&i^battle_isVisible^;
    !!SN:H^monname^/(MON_AMMO_CART)/0/?z3;
    !!SN:T^AC_Warmachine.Ammo_Cart_Booby_Trap^/?z2/^cart^/z3;
    !!MM:Sz2;

    !!SN:P^ExplosionMine^;              [play quest sound before showing dialogue]
    !!BMy1:V9;                          [Play Inferno Animation]
  !!en;

  !!FU(ACM_DrawActionPlay):P;
!!en;


*******************************Life Aura First Aid Tent Upgrade*************************************
!?FU(OnCombatRound)&v997=0;
*Life Aura Gives all living untis +5% HP
!!BH0:N?y1;                             [Attacker]
!!HEy1:A2/6/?y2/?y10;                   [6  First Aid Tent]
!!SN:W^Tent_Life_Aura_%Y1^/?y11;
!!if&y10=1/y11=1;
  !!re i/0/20;
  !!BMi:F?j; !!VRj:&16;                 [Check living flag]
  !!BMi:H?y3;!!VRy4:Sy3*105:100; !!VRy4&y4=y3:+1; !!BMi&j>0:Hy4; [+5% HP but min+1HP]
  !!en;
!!en;

!!BH1:N?y1; !!FU&y1<0:E;                [Defender]
!!HEy1:A2/6/?y2/?y10;                   [6  First Aid Tent]
!!SN:W^Tent_Life_Aura_%Y1^/?y11;
!!if&y10=1/y11=1;
  !!re i/21/41;
  !!BMi:F?j; !!VRj:&16;                 [Check living flag]
  !!BMi:H?y3;!!VRy4:Sy3*105:100; !!VRy4&y4=y3:+1; !!BMi&j>0:Hy4; [+5% HP but min+1HP]
  !!en;
!!en;


*******************************WM Maintainability***************************************************
*WM get repaired after battle, but that costs a few 250 movement points*
*Upgrade happens without further notice to the player, you can just see on the decerased movement points*
!?FU(OnBattlefieldVisible);

!!SN:W^WM_Maintain_Att_Bal^/0;  !!SN:W^WM_Maintain_Def_Bal^/0;
!!SN:W^WM_Maintain_Att_Ammo^/0; !!SN:W^WM_Maintain_Def_Ammo^/0;
!!SN:W^WM_Maintain_Att_Tent^/0; !!SN:W^WM_Maintain_Def_Tent^/0;

!!BA:H0/?y1;                            [Attacker]
!!SN:W^WM_Maintainability_%Y1^/?y11;
!!if&y11=1;
  !!HEy1:A2/4/?y2/?y10; !!SN&y10=1:W^WM_Maintain_Att_Bal^/1; [4  Ballista ]
  !!HEy1:A2/5/?y2/?y11; !!SN&y11=1:W^WM_Maintain_Att_Ammo^/1; [5  Ammo Cart]
  !!HEy1:A2/6/?y2/?y12; !!SN&y12=1:W^WM_Maintain_Att_Tent^/1; [6  First Aid Tent]
!!en;

!!BA:H1/?y1; !!FU&y1<0:E;               [Defender]
!!SN:W^WM_Maintainability_%Y1^/?y11;
!!if&y11=1;
  !!HEy1:A2/4/?y2/?y10; !!SN&y10=1:W^WM_Maintain_Def_Bal^/1; [4  Ballista ]
  !!HEy1:A2/5/?y2/?y11; !!SN&y11=1:W^WM_Maintain_Def_Ammo^/1; [5  Ammo Cart]
  !!HEy1:A2/6/?y2/?y12; !!SN&y12=1:W^WM_Maintain_Def_Tent^/1; [6  First Aid Tent]
!!en;

!?FU(OnAfterBattleUniversal);

!!BA:H0/?y1;                            [Attacker]
!!SN:W^WM_Maintainability_%Y1^/?y11;
!!if&y11=1;
  !!VRy50:S-250;
  !!HEy1:A2/4/?y2/?y10; !!SN:W^WM_Maintain_Att_Bal^/?y21;  !!HEy1&y10=0/y21=1:A4/4; !!HEy1&y10=0/y21=1/1000:Wdy50/1; [4  Ballista ]
  !!HEy1:A2/5/?y2/?y11; !!SN:W^WM_Maintain_Att_Ammo^/?y22; !!HEy1&y11=0/y22=1:A4/5; !!HEy1&y11=0/y22=1/1000:Wdy50/1; [5  Ammo Cart]
  !!HEy1:A2/6/?y2/?y12; !!SN:W^WM_Maintain_Att_Tent^/?y23; !!HEy1&y12=0/y23=1:A4/6; !!HEy1&y12=0/y23=1/1000:Wdy50/1; [6  First Aid Tent]
!!en;

!!BA:H1/?y1; !!FU&y1<0:E;               [Defender]
!!SN:W^WM_Maintainability_%Y1^/?y11;
!!if&y11=1;
  !!VRy50:S-250;
  !!HEy1:A2/4/?y2/?y10; !!SN:W^WM_Maintain_Def_Bal^/?y21;  !!HEy1&y10=0/y21=1:A4/4; !!HEy1&y10=0/y21=1/1000:Wdy50/1; [4  Ballista ]
  !!HEy1:A2/5/?y2/?y11; !!SN:W^WM_Maintain_Def_Ammo^/?y22; !!HEy1&y11=0/y22=1:A4/5; !!HEy1&y11=0/y22=1/1000:Wdy50/1; [5  Ammo Cart]
  !!HEy1:A2/6/?y2/?y12; !!SN:W^WM_Maintain_Def_Tent^/?y23; !!HEy1&y12=0/y23=1:A4/6; !!HEy1&y12=0/y23=1/1000:Wdy50/1; [6  First Aid Tent]
!!en;


**********************Warmachines can be used everywhere********************************************
!?BF&1000;

!!BA:H0/?y1;                            [Attacker]
!!SN:W^WM_Versatility_%Y1^/?y11;
!!if&y11=1;
  !!HEy1:A2/4/?y2/?y10; !!BU:E51/?y3 E52/?y4;!!BU&y10=1/y3=-1/y4=-1:S146/1/51/0/-1/0; [Summon Ballista]
  !!HEy1:A2/5/?y2/?y11; !!BU:E18/?y3;        !!BU&y11=1/y3=-1:S148/1/18/0/-1/0; [Summon Ammo Cart]
  !!HEy1:A2/6/?y2/?y12; !!BU:E153/?y3;       !!BU&y12=1/y3=-1:S147/1/153/0/-1/0; [Summon First Aid Tent]
!!en;

*!FU:E;                                 [Makes only sense for Attacker -_- well except for Siege :) ]
!!BA:H1/?y1;                            [Defender]
!!FU&y1<0:E;
!!SN:W^WM_Versatility_%Y1^/?y11;
!!if&y11=1;
  !!HEy1:A2/4/?y2/?y10; !!BU:E67/?y3 E66/?y4;!!BU&y10=1/y3=-1/y4=-1:S146/1/67/1/-1/0; [Summon Ballista]
  !!HEy1:A2/5/?y2/?y11; !!BU:E32/?y3;        !!BU&y11=1/y3=-1:S148/1/32/1/-1/0; [Summon Ammo Cart]
  !!HEy1:A2/6/?y2/?y12; !!BU:E169/?y3;       !!BU&y12=1/y3=-1:S147/1/169/1/-1/0; [Summon First Aid Tent]
!!en;


**********************Shield Enchantment for universal WM*******************************************
*At the beginning of the fight casts a random Shield on all your Warmachines
!?FU(OnCombatRound)&v997=0;

!!BA:H0/?y1;
!!SN:W^WM_Shield_Ench_%Y1^/?y10;
!!VRy20:S0R2;
!!VRy5&y20=0:S27; !!VRy5&y20=1:S28;  !!VRy5&y20=2:S29; [27-Shield  28-AirShield  29-FireShield]
!!re i/0/10;
  !!BMi:T?y3;                           [Get Creature Type ]
  !!BMi&y3=145/y10=1:My5/99/3;          [If Ballista found for Attacker]
  !!BMi&y3=146/y10=1:My5/99/3;          [If Ballista found for Attacker]
  !!BMi&y3=147/y10=1:My5/99/3;          [If Ammo Cart found for Attacker]
  !!BMi&y3=148/y10=1:My5/99/3;          [If First Aid Tent found for Attacker]
!!en;

!!BA:H1/?y1; !!FU&y1<0:E;               [Exit if no Defending Hero]
!!SN:W^WM_Shield_Ench_%Y1^/?y10;
!!VRy20:S0R2;
!!VRy5&y20=0:S27; !!VRy5&y20=1:S28;  !!VRy5&y20=2:S29; [27-Shield  28-AirShield  29-FireShield]
!!re i/21/31;
  !!BMi:T?y3;                           [Get Creature Type ]
  !!BMi&y3=145/y10=1:My5/99/3;          [If Ballista found for Attacker]
  !!BMi&y3=146/y10=1:My5/99/3;          [If Ballista found for Attacker]
  !!BMi&y3=147/y10=1:My5/99/3;          [If Ammo Cart found for Attacker]
  !!BMi&y3=148/y10=1:My5/99/3;          [If First Aid Tent found for Attacker]
!!en;


**********************Magic Resistance for universal WM*******************************************
*Makes all Warmachines immune to direct damage spells or AOE Spells*

!?MR2;                                  [Magic Resistance Trigger]

!!MR:N?y1 S?y5;                         [Get Creature Number, Spell Number]
!!BMy1:I?y2 T?y3;                       [Get Creature Side, Type]
!!if|y3=145/y3=146/y3=147/y3=148;       [All WM]
  !!BG:H?y50;                           [Get Casting Hero]
  !!BA:Hy2/?y4;                         [Get Hero Number of creature side]
  !!FU&y4<0:E;
  *!FU&y50=y4:E;                        [Exit for beneficial spells, meaning same hero]
  !!if|y5=15/y5=16/y5=17/y5=18/y5=19/y5=20/y5=21/y5=22/y5=23/y5=24/y5=25/y5=26/y5=57; [If any Damage Spell]
    !!SN:W^WM_MR_Ench_%Y4^/?y10;
    !!MR&y10=1:F100;                    [Apply increased resistance chance to that stack temporarily]
    *!SN:W^Total_MR2_Value^/d100; Test MR
  !!en;
!!en;


**********************Magic Resistance Aura for universal WM****************************************
*All Units standing next to Warmachines have a +15% chance to resist spells*
*Effect can double if standing between two WM*

!?MR2;                                  [Magic Resistance Trigger]

!!MR:N?y1 S?y7;                         [Get Creature Number and Spell Number]
!!BMy1:I?y2 T?y3 P?y4;                  [Get Creature Side]
!!BG:H?y50;                             [Get Casting Hero]
!!BA:Hy2/?y5;                           [Get Hero Number of creature side]
!!FU&y5<0:E;                            [Exit if no Hero]
!!FU&y50=y5:E;                          [Exit for beneficial spells, meaning same hero]
!!SN:W^WM_MR_Aura_%Y5^/?y10;

*Ammo Cart
!!BU&y2=0:E18/?y8; !!BMy8&y8>=0/y8<=41/y2=0:T?y8; [Check Ammo Cart Attacker]

!!if&y2=0/y8=148/y10=1;
  !!MR|y4=1/y4=19/y4=35:Fd15;           [Apply increased resistance chance to that stack temporarily]
  *!SN|y4=1/y4=19/y4=35:W^Total_MR2_Value^/d15;  
!!en;

!!BU&y2=1:E32/?y8; !!BMy8&y8>=0/y8<=41/y2=1:T?y8; [Check Ammo Cart Defender]
!!if&y2=1/y8=148/y10=1;
  !!MR|y4=14/y4=15/y4=31/y4=48/y4=49:Fd15; [Apply increased resistance chance to that stack temporarily]
  *!SN|y4=14/y4=15/y4=31/y4=48/y4=49:W^Total_MR2_Value^/d15;
!!en;

*Ballista
!!BU&y2=0:E51/?y8; !!BMy8&y8>=0/y8<=41/y2=0:T?y8; [Check Ballista Attacker]
!!if&y2=0/y8=146/y10=1;
  !!MR|y4=35/y4=53/y4=69:Fd15;          [Apply increased resistance chance to that stack temporarily]
  *!SN|y4=35/y4=53/y4=69:W^Total_MR2_Value^/d15;
!!en;

!!BU&y2=1:E67/?y8; !!BMy8&y8>=0/y8<=41/y2=1:T?y8; [Check Ballista Defender]
!!if&y2=1/y8=146/y10=1;
  !!MR|y4=49/y4=48/y4=65/y4=82/y4=83:Fd15; [Apply increased resistance chance to that stack temporarily]
  *!SN|y4=49/y4=48/y4=65/y4=82/y4=83:W^Total_MR2_Value^/d15;
!!en;

*First Aid Tent
!!BU&y2=0:E153/?y8; !!BMy8&y8>=0/y8<=41/y2=0:T?y8; [Check First Aid Tent Attacker]
!!if&y2=0/y8=147/y10=1;
  !!MR|y4=137/y4=155/y4=171:Fd15;       [Apply increased resistance chance to that stack temporarily]
  *!SN|y4=137/y4=155/y4=171:W^Total_MR2_Value^/d15;
!!en;

!!BU&y2=1:E169/?y8; !!BMy8&y8>=0/y8<=41/y2=1:T?y8; [Check First Aid Tent Defender]
!!if&y2=1/y8=147/y10=1;
  !!MR|y4=151/y4=150/y4=167/y4=184/y4=185:Fd15; [Apply increased resistance chance to that stack temporarily]
  *!SN|y4=151/y4=150/y4=167/y4=184/y4=185:W^Total_MR2_Value^/d15;
!!en;


*********************************Ammo Cart Goblin Support********************************************
*The Goblin Support adds a chance to find additional Resources after combat*

!?FU(OnAfterBattleUniversal)&1000/999;

!!BA:H0/?y1;                            [Attacker Hero Number]
!!FU&y1<0:E;                            [Exit if no Hero]
!!SN:W^Ammo_Goblin_%Y1^/?y11; !!FU&y11=0:E;
!!HEy1:O?y2;                            [get owner of this hero]
!!SN:W^Hero_Attacker_Owner0^/?y3;       [Check Owner Before Fight]
!!FU&y2<>y3:E;                          [Prevent to give Bonus if retreat]
!!FU|y2<=(NO_PLAYER)/y2>(PLAYER_LAST):E;

!!VRy50:S0;
!!VRy50&i^timerDay^>150:S1;             [After a certain game time, increase reward]

!!VRy99:S0R99;                          [Random Roll 0-99]
!!FU(AC_Goblin_Support)&y99<=16/y1>=0/y1<=155:Py1/0/y2/y99/y50;

!?FU(AC_Goblin_Support);
** function for Goblin    x1=hero number   x2=scouting  x3=Hero Owner  x4=Encouter  x5=Specialist

!!DL122:N^GoblinDL.txt^;                [Name of Dialogue text file Parse Dialogue]

!!if&x4>=0/x4<=3;                       [Gold Reward]
  !!HEx1:E?y5/?y6/1;                    [get hero's level]
  !!VRy60:S1Ry6*300+200R5000;           [Set Gold reward]
  !!VRy60&x5=1:+2000;                   [If specialist]
  !!SN:T^AC_Warmachine.Goblin_Support_Gold_0^/?z20;
  !!SN:T^AC_Warmachine.Goblin_Support_Gold_1^/?z21;
  !!DL122:A4/3/z20/1;                   [Set text to text fields]
  !!DL122:S1;
  !!IF:Q2/6/y60/1^%Z21^;                [2= Gold]
  !!OW:Rx3/6/dy60;                      [give gold]
  !!SN:W^Total_Goblin_Gold_%X1^/dy60;   [gained gold from Goblin upgrade]
!!en;

!!if&x4>=4/x4<=7;                       [Resource Reward]
  !!VRy61:S0R5;                         [random resource 0 to 5]
  !!VRy60:S1R12;                        [random quantity 1 to 12]
  !!VRy60&x5=1:+2;
  !!VRy60&y61=0:*3:2;                   [double for wood]
  !!VRy60&y61=2:*3:2;                   [double for ore]
  !!SN:T^AC_Warmachine.Goblin_Support_Res_0^/?z20;
  !!SN:T^AC_Warmachine.Goblin_Support_Res_1^/?z21;
  !!DL122:A4/3/z20/1;                   [Set text to text fields]
  !!DL122:S1;
  !!IF:Q2/y61/y60/1^%Z21^;
  !!OW:Rx3/y61/dy60;                    [give the resources]
!!en;

!!if&x4>=8/x4<=10;                      [Creature Reward]
  !!FU(pick_a_monster):P?y4;            [call function (pick_a_monster) to pick monster]   5= pick monster  give hero]
  !!VRy1:S0R2;
  !!if&y1=2;
    !!HEx1:B2/?y1;
    !!VRy4|y1=0/y1=1:S0R13;             [Castle]
    !!VRy4|y1=2/y1=3:S14R13;
    !!VRy4|y1=4/y1=5:S28R13;
    !!VRy4|y1=6/y1=7:S42R13;
    !!VRy4|y1=8/y1=9:S56R13;
    !!VRy4|y1=10/y1=11:S70R13;
    !!VRy4|y1=12/y1=13:S84R13;
    !!VRy4|y1=14/y1=15:S97R13;
    !!VRy4|y1=16/y1=17:S112R13;         [Conflux]
    !!VRy4|y4=122/y4=124:S127;
    !!VRy6:S0R6;                        [Generate random slot]
    !!HEx1:C0/y6/?y40/?y5;              [Check creature slot]
    !!VRy4&y40>=0/y5>0:Sy40;            [Change monster to one of the hereos army]
    !!if|y4=-1/y5=0;
      !!VRy6:S0R6;                      [Generate random slot]
      !!HEx1:C0/y6/?y40/?y5;            [Check creature slot]
      !!VRy4&y40>=0/y5>0:Sy40;          [Change monster to one of the hereos army]
    !!en;
  !!en;
  !!VRy1:S0R2;
  !!VRy4&x1=48/y1=1:S46;                [HS1]
  !!VRy4&x1=48/y1=2:S47;
  !!VRy2:S84R13;
  !!VRy4&x1=109/y1=1:Sy2;               [HS2]
  !!VRy4&x1=109/y1=2:Sy2;
  !!MA:Gy4/?y60;                        [get 1 weeks production]
  !!VRy60:Sy60R2;                       [**]
  !!MA:Ly4/?y5;                         [Get Level of Monster]
  !!if&i^timerDay^<22;
    !!VRy4|y4=132/y4=133/y4=134/y4=135:S138; [OP Dragons cannot be found in first 21 days and are set to Halflings instead]
  !!en;
  !!VRy4&y5=6/i^timerDay^<16:S137;      [Level 7 creatures cannot be found in first two weeks gets changes to Sharpshooters]
  !!VRy4&y5=5/i^timerDay^<8:S138;       [Level 6 creatures cannot be found in first week gets changes to Halflings]
  !!UN:N3/z704/y4/0;                    [refresh get monster name]
  !!UN:N3/z705/y4/1;                    [refresh get monsters name]
  !!SN:T^AC_Warmachine.Goblin_Support_Creature_0^/?z20;
  !!SN:T^AC_Warmachine.Goblin_Support_Creature_1^/?z21;
  !!DL122:A4/3/z20/1;                   [Set text to text fields]
  !!DL122:S1;
  !!HEx1&1000/999:Cy4/y60/-1/0/-1/0/-1/0/-1/0/-1/0/-1/0; [give creatures]
!!en;

!!if&x4>=11/x4<=13;                     [Experience Reward]
  !!HEx1:E?y5/?y6/1;                    [get hero's level]
  !!VRy60:Sy6*150R1000;                 [(level + 0-20) x 50]
  !!VRy60&x5=1:Sy60R2000;               [Specialist]
  !!VRy60&y6>15:*2; !!VRy60&y6>20:*2; !!VRy60&y6>40:*2; !!VRy60&y6>50:*2; [Increase Exp with level so it doesnt get useless]
  !!SN:T^AC_Warmachine.Goblin_Support_Exp_0^/?z20;
  !!SN:T^AC_Warmachine.Goblin_Support_Exp_1^/?z21;
  !!DL122:A4/3/z20/1;                   [Set text to text fields]
  !!DL122:S1;
  !!IF:Q2/17/y60/1^%Z21^;               [8= experience]
  !!HEx1:Edy60;                         [give experience]
!!en;

!!if&x4>=14/x4<=14;                     [Artifact Reward]
  !!VRy1:S0R2;
  !!UN|y1=0/y1=1:J6/2/?y2;              [get a random Treasure artifact  2/3 chance]
  !!UN&y1=2:J6/4/?y2;                   [get a random Minor artifact  1/3 chance]
  !!SN:T^AC_Warmachine.Goblin_Support_Artifact_0^/?z20;
  !!SN:T^AC_Warmachine.Goblin_Support_Artifact_1^/?z21;
  !!DL122:A4/3/z20/1;                   [Set text to text fields]
  !!DL122:S1;
  !!IF:Q2/8/y2/1^%Z21^;
  !!HEx1:Ay2;                           [Give Artifact]
!!en;

!!if&x4>=15/x4<=15;                     [Spell Reward]
  !!HEx1:A2/0/d/?y15;                   [Check for Spell Book]
  !!FU&y15=0:E;                         [Exit if no Spell Book]
  !!FU(ACM_GenerateRandomSpell):P1/4/x1/?y-99; [Function to generate a random level 1-4 spell which skips banned spells]
  !!if&y99>=0/y99<=69;                  [Valid Spell]
    !!HEx1:S7/?y14;                     [7 Wisdom]
    !!SSy99:L?y5;                       [Spell Level]
    !!FU&y5=5/y14<3:E;                  [Exit if Wisdom level not high enough]
    !!FU&y5=4/y14<2:E;
    !!FU&y5=3/y14<1:E;
    !!SN:T^AC_Warmachine.Goblin_Support_Spell_0^/?z20;
    !!SN:T^AC_Warmachine.Goblin_Support_Spell_1^/?z21;
    !!DL122:A4/3/z20/1;                 [Set text to text fields]
    !!DL122:S1;
    !!IF:Q2/9/y99/1^%Z21^;
    !!HEx1:My99/1;                      [Give Spell]
  !!en;
!!en;

!!if&x4>=16/x4<=16;                     [Primary Skill Reward]
  !!VRy96:S2R3;
  !!SN&y96=2:T^AC_Misc.Scout_Attack1^/?z-9;
  !!SN&y96=3:T^AC_Misc.Scout_Defense1^/?z-9;
  !!SN&y96=4:T^AC_Misc.Scout_SP1^/?z-9;
  !!SN&y96=5:T^AC_Misc.Scout_Knowledge1^/?z-9;
  !!SN:T^AC_Warmachine.Goblin_Support_Skill_0^/?z20;
  !!SN:T^AC_Warmachine.Goblin_Support_Skill_1^/?z21;
  !!DL122:A4/3/z20/1;                   [Set text to text fields]
  !!DL122:S1;
  !!IF&y96=2:Q2/31/1/1^%Z21^;
  !!HEx1&y96=2:Fd1/d/d/d;
  !!IF&y96=3:Q2/32/1/1^%Z21^;
  !!HEx1&y96=3:Fd/d1/d/d;
  !!IF&y96=4:Q2/33/1/1^%Z21^;
  !!HEx1&y96=4:Fd/d/d1/d;
  !!IF&y96=5:Q2/34/1/1^%Z21^;
  !!HEx1&y96=5:Fd/d/d/d1;
!!en;
!!UN&1000/999:R1 R2;                    [redraw hero screen]


!?DL&v998=122/v999=30722/v1000=13;      [When clicking on the close Button in Goblin Support DL]
!!DL:C1;

// Right-Click on hero screen/hero meeting screen shows War Machines enhancements details
; erm 2 part by Archer30
!?FU(OnHeroScreenMouseClick)&i^mouse_action^=(MOUSE_RMB_PRESSED);
!!VR(item:y):Si^mouse_item^;
!!VR(art:y):S(NO_ART);

!!VR(art)&(item)=18:S(ART_CATAPULT); [Catapult]
!!VR(art)&(item)=16:S(ART_AMMO_CART); [Ammo Cart]
!!VR(art)&(item)=15:S(ART_BALLISTA); [Ballista]
!!VR(art)&(item)=17:S(ART_FIRST_AID_TENT); [First Aid Tent]
!!FU&(art)=(NO_ART):E;

!!HE(CURRENT_HERO):N?(hero:y);
!!FU(ACM_PrepareWarMachineDlg):P(hero)/(art);

!?FU(OnHeroesMeetScreenMouseClick)&i^mouse_action^=(MOUSE_RMB_PRESSED);
!!VR(item:y):Si^mouse_item^;
!!VR(art:y):S(NO_ART);

!!if&(item)>=40/(item)<=43;
  !!CM:H?(hero:y)/?(otherHero:y);
  !!VR(art)&(item)=40:S(ART_BALLISTA);
  !!VR(art)&(item)=41:S(ART_AMMO_CART);
  !!VR(art)&(item)=42:S(ART_FIRST_AID_TENT);
  !!VR(art)&(item)=43:S(ART_CATAPULT);
!!el&(item)>=59/(item)<=62;
  !!CM:H?(otherHero:y)/?(hero:y);
  !!VR(art)&(item)=59:S(ART_BALLISTA);
  !!VR(art)&(item)=60:S(ART_AMMO_CART);
  !!VR(art)&(item)=61:S(ART_FIRST_AID_TENT);
  !!VR(art)&(item)=62:S(ART_CATAPULT);
!!en;

!!FU&(art)=(NO_ART):E;

!!FU(ACM_PrepareWarMachineDlg):P(hero)/(art);

!?FU(ACM_PrepareWarMachineDlg);
!#VA(hero:x) (art:x);

!!HE(hero):A2/(art)/?(has:y)/?(equipped:y);

!!if&(equipped);
  !!FU(Get_WM_Upgrade_Description):P(hero)/(art)/?(desc:z)/?(shortDesc:z);
  !!IF:Q1/(PIC_TYPE_ART)/(art)/(MSG_TYPE_POPUP)/(desc);
  !!CM:R0;
!!en;

!?FU(Get_WM_Upgrade_Description);

18 Catapult Slot
3 Catapult
!!if&x2=(ART_CATAPULT);                 [if right click and specialty icon are clicked]
  !!SN:T^AC_Warmachine.All_Upg_1^/?z21; !!SN:W^WM_Fortification_%X1^/?y10; !!VRz31&y10=0:S^Grey^; !!VRz31&y10=1:S^Gold^; [Check if hero has bought the upgrade and set color of text accordingly]
  !!SN:T^AC_Warmachine.All_Upg_2^/?z22; !!SN:W^WM_Maintainability_%X1^/?y10; !!VRz32&y10=0:S^Grey^; !!VRz32&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.All_Upg_3^/?z23; !!SN:W^WM_Versatility_%X1^/?y10; !!VRz33&y10=0:S^Grey^; !!VRz33&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.All_Ench_1^/?z24; !!SN:W^WM_Shield_Ench_%X1^/?y10; !!VRz34&y10=0:S^Grey^; !!VRz34&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.All_Ench_2^/?z25; !!SN:W^WM_MR_Ench_%X1^/?y10; !!VRz35&y10=0:S^Grey^; !!VRz35&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.All_Ench_3^/?z26; !!SN:W^WM_MR_Aura_%X1^/?y10; !!VRz36&y10=0:S^Grey^; !!VRz36&y10=1:S^Gold^;
  *!SN:H^art^/3/1/^^;                   [restore original artefact description]
  !!SN:H^art^/3/1/?z2;                  [readout artefact description]
  !!VRz1:S^%Z2

  {~%Z31}%Z21{~}
  {~%Z32}%Z22{~}
  {~%Z33}%Z23{~}
  {~%Z34}%Z24{~}
  {~%Z35}%Z25{~}
  {~%Z36}%Z26{~}^;
  *!UN:A3/10/z1;                        [Set new Ammo Cart description to show it on right click]
  
  !!VRz4:S^
{~%Z31}%Z21{~}
{~%Z32}%Z22{~}
{~%Z33}%Z23{~}
{~%Z34}%Z24{~}
{~%Z35}%Z25{~}
{~%Z36}%Z26{~}^;
!!en;

16 Ammo Cart Slot
5 Ammo Cart
!!if&x2=(ART_AMMO_CART);                [if right click and specialty icon are clicked]
  !!SN:T^AC_Warmachine.Cart_Upg_1^/?z21; !!SN:W^Ammo_Supply_%X1^/?y10; !!VRz31&y10=0:S^Grey^; !!VRz31&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.Cart_Upg_2^/?z22; !!SN:W^Ammo_Goblin_%X1^/?y10; !!VRz32&y10=0:S^Grey^; !!VRz32&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.Cart_Upg_3^/?z23; !!SN:W^Ammo_Enhanced_Arrow_%X1^/?y10; !!VRz33&y10=0:S^Grey^; !!VRz33&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.Cart_Ench_1^/?z24; !!SN:W^Ammo_Booby_Trap_%X1^/?y10; !!VRz34&y10=0:S^Grey^; !!VRz34&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.Cart_Ench_2^/?z25; !!SN:W^Ammo_Replensih_SP_%X1^/?y10; !!VRz35&y10=0:S^Grey^; !!VRz35&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.Cart_Ench_3^/?z26; !!SN:W^Ammo_Burning_Arrow_%X1^/?y10; !!VRz36&y10=0:S^Grey^; !!VRz36&y10=1:S^Gold^;
  *!SN:H^art^/5/1/^^;
  !!SN:H^art^/5/1/?z2;
  !!VRz1:S^%Z2

  {~%Z31}%Z21{~}
  {~%Z32}%Z22{~}
  {~%Z33}%Z23{~}
  {~%Z34}%Z24{~}
  {~%Z35}%Z25{~}
  {~%Z36}%Z26{~}^;
  *!UN:A5/10/z1;                        [Set new Ammo Cart description]

  !!VRz4:S^
{~%Z31}%Z21{~}
{~%Z32}%Z22{~}
{~%Z33}%Z23{~}
{~%Z34}%Z24{~}
{~%Z35}%Z25{~}
{~%Z36}%Z26{~}^;
!!en;

15 Ballista Slot
4 Ballista
!!if&x2=(ART_BALLISTA);                 [if right click and specialty icon are clicked]
  !!SN:T^AC_Warmachine.Bal_Upg_1^/?z21; !!SN:W^Ballista_Morale_%X1^/?y10; !!VRz31&y10=0:S^Grey^; !!VRz31&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.Bal_Upg_2^/?z22; !!SN:W^Ballista_Add_Shots_%X1^/?y10; !!VRz32&y10=0:S^Grey^; !!VRz32&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.Bal_Upg_3^/?z23; !!SN:W^Ballista_Crippling_%X1^/?y10; !!VRz33&y10=0:S^Grey^; !!VRz33&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.Bal_Ench_1^/?z24; !!SN:W^Ballista_Fireball_Attack_%X1^/?y10; !!VRz34&y10=0:S^Grey^; !!VRz34&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.Bal_Ench_2^/?z25; !!SN:W^Ballista_Magic_Arrow_%X1^/?y10; !!VRz35&y10=0:S^Grey^; !!VRz35&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.Bal_Ench_3^/?z26; !!SN:W^Ballista_Spell_Trigger_%X1^/?y10; !!VRz36&y10=0:S^Grey^; !!VRz36&y10=1:S^Gold^;
  *!SN:H^art^/4/1/^^;
  !!SN:H^art^/4/1/?z2;
  !!VRz1:S^%Z2

  {~%Z31}%Z21{~}
  {~%Z32}%Z22{~}
  {~%Z33}%Z23{~}
  {~%Z34}%Z24{~}
  {~%Z35}%Z25{~}
  {~%Z36}%Z26{~}^;
  *!UN:A4/10/z1;

  !!VRz4:S^
{~%Z31}%Z21{~}
{~%Z32}%Z22{~}
{~%Z33}%Z23{~}
{~%Z34}%Z24{~}
{~%Z35}%Z25{~}
{~%Z36}%Z26{~}^;
!!en;

17 First Aid Tent Slot
6 First Aid Tent
!!if&x2=(ART_FIRST_AID_TENT);           [if right click and specialty icon are clicked]
  !!SN:T^AC_Warmachine.Tent_Upg_1^/?z21; !!SN:W^Tent_Improved_%X1^/?y10; !!VRz31&y10=0:S^Grey^; !!VRz31&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.Tent_Upg_2^/?z22; !!SN:W^Tent_Capacity_Upgrade_%X1^/?y10; !!VRz32&y10=0:S^Grey^; !!VRz32&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.Tent_Upg_3^/?z23; !!SN:W^Tent_Gold_Gain_%X1^/?y10; !!VRz33&y10=0:S^Grey^; !!VRz33&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.Tent_Ench_1^/?z24; !!SN:W^Tent_Herbalism_%X1^/?y10; !!VRz34&y10=0:S^Grey^; !!VRz34&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.Tent_Ench_2^/?z25; !!SN:W^Tent_Overheal_%X1^/?y10; !!VRz35&y10=0:S^Grey^; !!VRz35&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.Tent_Ench_3^/?z26; !!SN:W^Tent_Life_Aura_%X1^/?y10; !!VRz36&y10=0:S^Grey^; !!VRz36&y10=1:S^Gold^;
  *!SN:H^art^/6/1/^^;
  !!SN:H^art^/6/1/?z2;
  !!VRz1:S^%Z2

  {~%Z31}%Z21{~}
  {~%Z32}%Z22{~}
  {~%Z33}%Z23{~}
  {~%Z34}%Z24{~}
  {~%Z35}%Z25{~}
  {~%Z36}%Z26{~}^;
  *!UN:A6/10/z1;

  !!VRz4:S^
{~%Z31}%Z21{~}
{~%Z32}%Z22{~}
{~%Z33}%Z23{~}
{~%Z34}%Z24{~}
{~%Z35}%Z25{~}
{~%Z36}%Z26{~}^;
!!en;

!!VRx3:Zz1;                             [Export the text]
!!VRx4:Zz4;

****************************************************************************************************
**Spell Trainer
*by Perry R

**V-Vars used: v3,v4,v5
**Z-Vars used: z735-z737, z426-z428, z937
**Function used:
**Flags used:

*#SN:W^Spell_Trainer_Mod^/1;            [Spell Trainer Mod Active]
!#SN:W^Damage_Spells_Increment^/1;      [Change the Increment for Damage Spells in this Line e.g. change 3 to 2 or 3 to 5]

********************************************************************************
!?PI;

!!SN:W^Spell_Trainer_Mod^/?y1;          [Check if options have already been activated]
!!DO(Spell_Trainer_Reset_1)/0/155/1&y1=1:P; [Reset spell damage increase/counter for all Heroes when Map Starts]
!!FU(Spell_Trainer_Reset_2)&y1=1:P;

*------------------------------------------------------------------------------*
!?CM2;                                  [Show Spell level when right click on spell book]
!!CM:F?v3 I?v4 S?v5;                    [where we click and click subtype]
!!HE-1:N?y99;                           [Get current hero #]

!!SN:W^Spell_Trainer_Mod^/?y1;          [Check if options have already been activated]
!!FU(ACM_OpenSpellTrainerTable)&v3=512/v4=19/y1=1:P;                 [if right click and specialty icon are clicked]

!?FU(ACM_OpenSpellTrainerTable);
!!DL88:N^SpTr.txt^;                     [Name of Dialogue text file Parse Dialogue]

!!SN:W^Damage_Spells_Increment^/?y98;

**Earth
!!SN:W^Hero%Y99_Shield_Upgrade^/?y10; !!SN:W^SpellTrainerHero%Y99_Spell27^/?y11;
!!SN:W^Hero%Y99_Stoneskin_Upgrade^/?y12; !!SN:W^SpellTrainerHero%Y99_Spell46^/?y13;
!!SN:W^Hero%Y99_Slow_Upgrade^/?y14; !!SN:W^SpellTrainerHero%Y99_Spell54^/?y15;
!!SN:W^Hero%Y99_Resurrection_Upgrade^/?y16; !!SN:W^SpellTrainerHero%Y99_Spell38^/?y17; !!VRy16:*80;
!!SN:W^Hero%Y99_Animation_Upgrade^/?y18; !!SN:W^SpellTrainerHero%Y99_Spell39^/?y19; !!VRy18:*100;
!!SN:W^Hero%Y99_Death Ripple_Upgrade^/?y20; !!SN:W^SpellTrainerHero%Y99_Spell24^/?y21; !!VRy20:Sy21 *y98 +100; [**Death Ripple]
                                            !!SN:W^SpellTrainerHero%Y99_Spell23^/?y23; !!VRy22:Sy23 *y98 +100; [**Meteor Shower]
                                            !!SN:W^SpellTrainerHero%Y99_Spell18^/?y25; !!VRy24:Sy25 *y98 +100; [**Implosion]
!!SN:W^Hero%Y99_Summoning_Upgrade^/?y26; !!SN:W^SpellTrainerHero%Y99_Spell66^/?y27;    !!VRy26:*100; [**Summoning]
!!SN:W^Hero%Y99_Protection_Upgrade^/?y28; !!SN:W^SpellTrainerHero%Y99_Spell30^/?y29;
!!SN:W^Hero%Y99_Sorrow_Upgrade^/?y68; !!SN:W^SpellTrainerHero%Y99_Spell50^/?y69;

**Water
!!SN:W^Hero%Y99_Bless_Upgrade^/?y30; !!SN:W^SpellTrainerHero%Y99_Spell41^/?y31;
!!SN:W^Hero%Y99_Weakness_Upgrade^/?y32; !!SN:W^SpellTrainerHero%Y99_Spell45^/?y33;
!!SN:W^Hero%Y99_Prayer_Upgrade^/?y34; !!SN:W^SpellTrainerHero%Y99_Spell48^/?y35;
!!SN:W^Hero%Y99_Mirth_Upgrade^/?y64; !!SN:W^SpellTrainerHero%Y99_Spell49^/?y65;
!!SN:W^Hero%Y99_Cure_Upgrade^/?y76; !!SN:W^SpellTrainerHero%Y99_Spell37^/?y77;         !!VRy76:*5;
                                            !!SN:W^SpellTrainerHero%Y99_Spell16^/?y37; !!VRy36:Sy37 *y98 +100; [**Ice Bolt]
                                            !!SN:W^SpellTrainerHero%Y99_Spell20^/?y39; !!VRy38:Sy39 *y98 +100; [**Frost Ring]
**Fire
!!SN:W^Hero%Y99_Bloodlust_Upgrade^/?y40; !!SN:W^SpellTrainerHero%Y99_Spell43^/?y41;
!!SN:W^Hero%Y99_Curse_Upgrade^/?y42; !!SN:W^SpellTrainerHero%Y99_Spell42^/?y43;
!!SN:W^Hero%Y99_Fire Shield_Upgrade^/?y44; !!SN:W^SpellTrainerHero%Y99_Spell29^/?y45; !!VRy44:*50; [Fire Shield]
!!SN:W^Hero%Y99_Misfortune_Upgrade^/?y72; !!SN:W^SpellTrainerHero%Y99_Spell52^/?y73;
!!SN:W^Hero%Y99_Frenzy_Upgrade^/?y74; !!SN:W^SpellTrainerHero%Y99_Spell56^/?y75;       !!VRy74:*5;
!!SN:W^Hero%Y99_Slayer_Upgrade^/?y66; !!SN:W^SpellTrainerHero%Y99_Spell55^/?y67;
                                            !!SN:W^SpellTrainerHero%Y99_Spell21^/?y47; !!VRy46:Sy47 *y98 +100; [**Fire Ball]
                                            !!SN:W^SpellTrainerHero%Y99_Spell22^/?y49; !!VRy48:Sy49 *y98 +100; [**Inferno]
!!SN:W^Hero%Y99_Land Mine_Upgrade^/?y78; !!SN:W^SpellTrainerHero%Y99_Spell11^/?y79;    !!VRy78:*50; [**Land Mine]
!!SN:W^Hero%Y99_Fire Wall_Upgrade^/?y80;  !!SN:W^SpellTrainerHero%Y99_Spell13^/?y81;   !!VRy80:*35; [**Fire Wall]
                                            !!SN:W^SpellTrainerHero%Y99_Spell26^/?y83; !!VRy82:Sy83 *y98 +100; [**Armageddon]
**Air
!!SN:W^Hero%Y99_Haste_Upgrade^/?y50; !!SN:W^SpellTrainerHero%Y99_Spell53^/?y51;
!!SN:W^Hero%Y99_Disrupting Ray_Upgrade^/?y52; !!SN:W^SpellTrainerHero%Y99_Spell47^/?y53;
!!SN:W^Hero%Y99_Precision_Upgrade^/?y54; !!SN:W^SpellTrainerHero%Y99_Spell44^/?y55;
!!SN:W^Hero%Y99_Air Shield_Upgrade^/?y56; !!SN:W^SpellTrainerHero%Y99_Spell28^/?y57;
!!SN:W^Hero%Y99_Fortune_Upgrade^/?y70; !!SN:W^SpellTrainerHero%Y99_Spell51^/?y71;
!!SN:W^Hero%Y99_Destroy Undead_Upgrade^/?y58; !!SN:W^SpellTrainerHero%Y99_Spell25^/?y59; !!VRy58:Sy59 *y98 +100; [**Destroy Undead]
                                            !!SN:W^SpellTrainerHero%Y99_Spell17^/?y61; !!VRy60:Sy61 *y98 +100; [**Lightning Bolt]
                                            !!SN:W^SpellTrainerHero%Y99_Spell19^/?y63; !!VRy62:Sy63 *y98 +100; [**Chain Lightning]

!!FU(Spell_Trainer_Calc):Py99/?y92/?y93;[Pass Hero Number and return Number of Spell Upgrades and Chance for Spell Upgrade]
!!CM:R0;                                [disable standard reaction]

; Spell Upgrades List - Archer30
!!SN:T^AC_Spell_Upgrades.Upgrade_List_Title^/?z14/^upg^/y92/^chance^/y93;

!!SN:T^AC_Spell_Upgrades.Fire^/?z12 Iz12/?z12;
!!SN:T^AC_Spell_Upgrades.FireExtra^/?z15 Iz15/?z15;
!!SN:T^AC_Spell_Upgrades.Air^/?z13 Iz13/?z13;
!!SN:T^AC_Spell_Upgrades.Earth^/?z10 Iz10/?z10;
!!SN:T^AC_Spell_Upgrades.Water^/?z11 Iz11/?z11;                  

!!DL88:A5/3/z14/1;
!!DL88:A1/3/z12/1;
!!DL88:A6/3/z15/1;
!!DL88:A3/3/z13/1;
!!DL88:A2/3/z10/1;          
!!DL88:A4/3/z11/1;       

!!DL88:S1;                              [Show complete Dialogue number 88]

!?DL&v998=88/v999=30722/v1000=13;       [When clicking on the close Button]
!!DL:C1;


!?FU(Spell_Trainer_Calc);
x1=Hero Number, x2=returns number of spell upgrades, x3=returns chance for spell upgrade
Chance:
Warrior:10%
Adventurer:25%
Mage:50%
Scholar:+25%
Mage Class Points:+x%
Ring of Conjuring:+15%

Possible Upgrades:
Warrior:0
Adventurer:0
Mage:+1
Scholar Basic:+1
Scholar Expert:+1
Scholar Grandmaster:+1
Collar of Conjuring:+1
Druid:+1
Battlemage:+1
Grandmaster Mage:+1

!!VRy5:S0;                              [Spell Upgrades Chance]
!!VRy6:S0;                              [Spell Upgrades Number]

!!VRy7:S0;                              [14  Fire Magic]
!!VRy8:S0;                              [15  Air Magic]
!!VRy9:S0;                              [16  Water Magic]
!!VRy10:S0;                             [17  Earth Magic]


!!FU(Calc_Class_Points_Original):Px1/0/0/?y10; [Get Mage Class Points]

!!VRy5:+y10;                            [+Class Points]

!!HEx1:B2/?y1;                          [Get Hero Class]
!!VRy1:Sy1 %2;                          [if y1=1 it means Magic Class Hero, if y1=0 it means Might Class Hero]
!!FU(Valid_Adventurer_Hero):Px1/?y60;   [Call Function to Check if Adventurer Hero 1 means yes]
!!VRy5&y1=1/y60=0:+40;                  [+Class Points [If Mage and no Adventurer Hero]
!!VRy5&y1=1/y60=1:+25;                  [+Class Points [If Mage and Adventurer Hero]
!!VRy5&y1=0/y60=1:+25;                  [+Class Points [If Warrior and Adventurer Hero]
!!VRy5&y1=0/y60=0:+10;                  [+Class Points [If Mage and no Adventurer Hero]

!!VRy6&y1=1/y60=0:+1;                   [+1 Spell Upgrade per Combat If Mage and no Adventurer Hero]

!!SN:W^H3_Scholar_0_Hero%X1^/?y14;
!!SN:W^H3_Scholar_1_Hero%X1^/?y15;

!!HEx1:S18/?y4 S14/?y7 S15/?y8 S16/?y9 S17/?y10; [Checke current hero Scholar]
!!VRy5&y4>0:+25;                        [+Scholar Bonus]
!!VRy6&y4>0:+1;                         [+Spell Upgrade for Basic Scholar]
!!VRy6&y4=3:+1;                         [+Spell Upgrade for Expert Scholar]
!!VRy6&y4=3/y14=1/y15=1:+1;             [+Spell Upgrade for Grandmaster Scholar]

!!HEx1:A2/76/d/?y20 A2/77/d/?y21 A2/78/d/?y22 A2/139/d/?y23; [Check for Artifacts Collar,Ring,Cape,Ring of the Magi]
!!VRy5|y21=1/y23=1:+15;                 [+Artifact Bonus Chance]
!!VRy6|y20=1/y23=1:+1;                  [+Artifact Bonus Spell Upgrade]

!!SN:W^Master_Adventurer_Hero%X1^/?y90;
!!SN:W^Master_Mage_Hero%X1^/?y91;
!!VRy6&y90=1/y91=1:+1;                  [+1 Spell Upgrade if Druid]
!!SN:W^Master_Warrior_Hero%X1^/?y90;
!!SN:W^Master_Mage_Hero%X1^/?y91;
!!VRy6&y90=1/y91=1:+1;                  [+1 Spell Upgrade if Battlemage]
!!SN:W^Grandmaster_Mage_Hero%X1^/?y90;
!!VRy6&y90=1/y91=1:+1;                  [+1 Spell Upgrade if Grandmaster]

!!if&y7<2/y8<2/y9<2/y10<2;              [if hero has no advanced magic skill]
  !!VRy5:-25;                           [-25% chance to upgrade]
!!en;

!!VRy5&y5>100:S100;                     [Cap at hundred percent]
!!VRy5&y5<0:S0;                         [Cannot be below zero]

!!VRx2:Sy6;                             [Return Spell Upgrades]
!!VRx3:Sy5;                             [Return Spell Upgrade Chance]


*------------------------------------------------------------------------------*
!?FU(OnBattlefieldVisible)&1000;
!!SN:W^Monster_Level^/0;                [Reset Monster_Level at Battle Start]

!?BA0&1000;
!!SN:W^Upgrade_Counter^/0;              [Reset Upgrade_Counter at Battle Start]

*?BA1&1000;
*!SN:W^SpellTrainer_Sound_End^/?y1;
*!FU&y1<>1:E;
*!VRz1:S^CLIMAX^;
*!SN:Pz1;
*!SN:W^SpellTrainer_Sound_End^/0;

*------------------------------------------------------------------------------*
!?BG0&1000;                             [Trigger Buff/Debuff Spells]

!!SN:W^Spell_Trainer_Mod^/?y1; !!FU&y1=0:E; [Check if options have already been activated]
!!BG:H?y3;                              [Determine if AI controlls Hero]
!!HEy3:O?y3;
!!OW:Iy3/?y3;
!!FU&y3=1:E;                            [Exit if AI Hero]

!!BA:Q?y1;                              [Check for Quick Combat]
!!if&y1=1;
  !!VRy99:S0R99;
  !!FU&y99>30:E;                        [In Quick Combat the chance to level up a spell is only 30% to encourage the player to use his spells and not get the level ups for free]
!!en;

!!BG:A?y1;                              [Aktion in y1 Must be Hero Cast]
!!if|y1=1/y1=0;

!!BG:Q?y1;
!!BA:Hy1/?y99;
!!FU&y99=-2:E;                          [Exit if no defending Hero]

!!FU(Spell_Trainer_Calc):Py99/?y90/?y91;[Pass Hero Number and return Number of Spell Upgrades and Chance for Spell Upgrade]
!!FU&y90=0:E;                           [Exit if NO possible Spell Upgrades]
!!VRy92:S0R99;                          [Random Roll: Chance for Might Heros without Scholar to level up is 33%]
!!FU&y91<y92:E;                         [Exit if Roll was not successful]

!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S18/?y85; [Checke current hero Scholar und Magien hat]
!!BG:S?y4;                              [Spell Number]

!!SN&y4>=24/y4<=69:W^Spell_Number_Buff^/y4;
!!SN&y4>=24/y4<=69:W^Flag_V898_Value^/1;
!!SN|y4=11/y4=13:W^Spell_Number_Buff^/y4;
!!SN|y4=11/y4=13:W^Flag_V898_Value^/1;

!!if&y4=27/y84>=0;                      [Shield]
!!SN:W^Hero%Y99_Shield_Upgrade^/?y20;
!!SS27:E3/?y10;
!!VRy10:Sy10 -y20;
!!SS27:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell27^/d+1;
!!en;

!!if&y4=43/y81>=0;                      [Bloodlust]
!!SN:W^Hero%Y99_Bloodlust_Upgrade^/?y20;
!!SS43:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS43:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell43^/d+1;
!!en;

!!if&y4=41/y83>=0;                      [Bless]
!!SN:W^Hero%Y99_Bless_Upgrade^/?y20;
!!SS41:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS41:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell41^/d+1;
!!en;

!!if&y4=42/y81>=0;                      [Curse]
!!SN:W^Hero%Y99_Curse_Upgrade^/?y20;
!!SS42:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS42:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell42^/d+1;
!!en;

!!if&y4=44/y82>=0;                      [Precision]
!!SN:W^Hero%Y99_Precision_Upgrade^/?y20;
!!SS44:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS44:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell44^/d+1;
!!en;

!!if&y4=45/y83>=0;                      [Weakness]
!!SN:W^Hero%Y99_Weakness_Upgrade^/?y20;
!!SS45:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS45:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell45^/d+1;
!!en;

!!if&y4=46/y84>=0;                      [Stoneskin]
!!SN:W^Hero%Y99_Stoneskin_Upgrade^/?y20;
!!SS46:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS46:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell46^/d+1;
!!en;

!!if&y4=28/y82>=0;                      [Air Shield]
!!SN:W^Hero%Y99_Air Shield_Upgrade^/?y20;
!!SS28:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS28:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell28^/d+1;
!!en;

!!if&y4=29/y81>=0;                      [Fire Shield]
!!SN:W^Hero%Y99_Fire Shield_Upgrade^/?y20;
!!SS29:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS29:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell29^/d+1;
!!en;

!!if&y4=53/y82>=0;                      [Haste]
!!SN:W^Hero%Y99_Haste_Upgrade^/?y20;
!!SS53:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS53:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell53^/d+1;
!!en;

!!if&y4=54/y84>=0;                      [Slow]
!!SN:W^Hero%Y99_Slow_Upgrade^/?y20;
!!SS54:E3/?y10;
!!VRy10:Sy10 -y20;
!!SS54:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell54^/d+1;
!!en;

!!if&y4=47/y82>=0;                      [Disrupting Ray]
!!SN:W^Hero%Y99_Disrupting Ray_Upgrade^/?y20;
!!SS47:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS47:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell47^/d+1;
!!en;

!!if&y4=66/y81>=0;                      [SummoningFire]
!!SN:W^Hero%Y99_Summoning_Upgrade^/?y20;
!!SS66:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS66:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell66^/d+1;
!!en;

!!if&y4=67/y84>=0;                      [SummoningEarth]
!!SN:W^Hero%Y99_Summoning_Upgrade^/?y20;
!!SS67:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS67:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell66^/d+1;
!!en;

!!if&y4=68/y83>=0;                      [SummoningWater]
!!SN:W^Hero%Y99_Summoning_Upgrade^/?y20;
!!SS68:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS68:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell66^/d+1;
!!en;

!!if&y4=69/y82>=0;                      [SummoningAir]
!!SN:W^Hero%Y99_Summoning_Upgrade^/?y20;
!!SS69:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS69:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell66^/d+1;
!!en;

!!if&y4=31/y81>=0;                      [ProtectionFire]
!!SN:W^Hero%Y99_Protection_Upgrade^/?y20;
!!SS31:E3/?y10;
!!VRy10:Sy10 -y20;
!!SS31:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell30^/d+1;
!!en;

!!if&y4=30/y82>=0;                      [ProtectionAir]
!!SN:W^Hero%Y99_Protection_Upgrade^/?y20;
!!SS30:E3/?y10;
!!VRy10:Sy10 -y20;
!!SS30:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell30^/d+1;
!!en;

!!if&y4=32/y83>=0;                      [ProtectionWater]
!!SN:W^Hero%Y99_Protection_Upgrade^/?y20;
!!SS32:E3/?y10;
!!VRy10:Sy10 -y20;
!!SS32:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell30^/d+1;
!!en;

!!if&y4=33/y84>=0;                      [ProtectionEarth]
!!SN:W^Hero%Y99_Protection_Upgrade^/?y20;
!!SS33:E3/?y10;
!!VRy10:Sy10 -y20;
!!SS33:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell30^/d+1;
!!en;

!!if&y4=38/y84>=0;                      [Resurrection]
!!SN:W^Hero%Y99_Resurrection_Upgrade^/?y20;
!!SS38:E3/?y10; !!VRy20:*80;
!!VRy10:Sy10 +y20;
!!SS38:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell38^/d+1;
!!en;

!!if&y4=39/y84>=0;                      [Animation]
!!SN:W^Hero%Y99_Animation_Upgrade^/?y20;
!!SS39:E3/?y10; !!VRy20:*100;
!!VRy10:Sy10 +y20;
!!SS39:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell39^/d+1;
!!en;

!!if&y4=24/y84=30;                      [Disabled                      [Death Ripple]
!!SN:W^Hero%Y99_Death Ripple_Upgrade^/?y20;
!!SS24:E3/?y10; !!VRy20:*30;
!!VRy10:Sy10 +y20;
!!SS24:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell24^/d+1;
!!en;

!!if&y4=25/y82=30;                      [Disabled                     [Destroy Undead]
!!SN:W^Hero%Y99_Destroy Undead_Upgrade^/?y20;
!!SS25:E3/?y10; !!VRy20:*50;
!!VRy10:Sy10 +y20;
!!SS25:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell25^/d+1;
!!en;

!!if&y4=48/y83>=0;                      [Prayer]
!!SN:W^Hero%Y99_Prayer_Upgrade^/?y20;
!!SS48:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS48:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell48^/d+1;
!!en;

!!if&y4=55/y81>=0;                      [Slayer]
!!SN:W^Hero%Y99_Slayer_Upgrade^/?y20;
!!SS55:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS55:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell55^/d+1;
!!en;

!!if&y4=49/y83>=0;                      [Mirth]
!!SN:W^Hero%Y99_Mirth_Upgrade^/?y20;
!!SS49:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS49:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell49^/d+1;
!!en;

!!if&y4=50/y84>=0;                      [Sorrow]
!!SN:W^Hero%Y99_Sorrow_Upgrade^/?y20;
!!SS50:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS50:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell50^/d+1;
!!en;

!!if&y4=51/y82>=0;                      [Fortune]
!!SN:W^Hero%Y99_Fortune_Upgrade^/?y20;
!!SS51:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS51:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell51^/d+1;
!!en;

!!if&y4=52/y81>=0;                      [Misfortune]
!!SN:W^Hero%Y99_Misfortune_Upgrade^/?y20;
!!SS52:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS52:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell52^/d+1;
!!en;

!!if&y4=56/y81>=0;                      [Frenzy]
!!SN:W^Hero%Y99_Frenzy_Upgrade^/?y20;
!!SS56:E3/?y10; !!VRy20:*5;
!!VRy10:Sy10 +y20;
!!SS56:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell56^/d+1;
!!en;

!!if&y4=37/y83>=0;                      [Cure]
!!SN:W^Hero%Y99_Cure_Upgrade^/?y20;
!!SS37:E3/?y10; !!VRy20:*5;
!!VRy10:Sy10 +y20;
!!SS37:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell37^/d+1;
!!en;

!!if&y4=13/y81>=0;                      [Fire Wall]
!!SN:W^Hero%Y99_Fire Wall_Upgrade^/?y20;
!!SS13:E3/?y10; !!VRy20:*35;
!!VRy10:Sy10 +y20;
!!SS13:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell13^/d+1;
!!en;

!!if&y4=11/y81>=0;                      [Land Mine]
!!SN:W^Hero%Y99_Land Mine_Upgrade^/?y20;
!!SS11:E3/?y10; !!VRy20:*50;
!!VRy10:Sy10 +y20;
!!SS11:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell11^/d+1;
!!en;

!!en;

*------------------------------------------------------------------------------*
!?BG1&1000;                             [Trigger Buff/Debuff Spells]

!!SN:W^Spell_Trainer_Mod^/?y1; !!FU&y1=0:E; [Check if options have already been activated]
!!SN:W^Flag_V898_Value^/?y1;
!!FU&y1<>1:E;
!!SN:W^Flag_V898_Value^/0;

!!BG:H?y3;                              [Determine if AI controlls Hero]
!!HEy3:O?y3;
!!OW:Iy3/?y3;
!!FU&y3=1:E;

!!BG:Q?y1;
!!BA:Hy1/?y99;
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S18/?y85; [Checke current hero Scholar und Magien hat]

!!SS43:Ey81/?y10;                       [revert bloodlust to original value]
!!SN:W^Bloodlust_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS43:Ey81/y10;

!!SS27:Ey84/?y10;                       [revert shield to original value]
!!SN:W^Shield_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS27:Ey84/y10;

!!SS41:Ey83/?y10;                       [revert Bless to original value]
!!SN:W^Bless_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS41:Ey83/y10;

!!SS42:Ey81/?y10;                       [revert Curse to original value]
!!SN:W^Curse_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS42:Ey81/y10;

!!SS44:Ey82/?y10;                       [revert Precision to original value]
!!SN:W^Precision_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS44:Ey82/y10;

!!SS45:Ey83/?y10;                       [revert Weakness to original value]
!!SN:W^Weakness_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS45:Ey83/y10;

!!SS46:Ey84/?y10;                       [revert Stoneskin to original value]
!!SN:W^Stoneskin_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS46:Ey84/y10;

!!SS28:Ey82/?y10;                       [revert Air Shield to original value]
!!SN:W^Air Shield_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS28:Ey82/y10;

!!SS29:Ey81/?y10;                       [revert Fire Shield to original value]
!!SN:W^Fire Shield_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS29:Ey81/y10;

!!SS53:Ey82/?y10;                       [revert Haste to original value]
!!SN:W^Haste_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS53:Ey82/y10;

!!SS54:Ey84/?y10;                       [revert Slow to original value]
!!SN:W^Slow_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS54:Ey84/y10;

!!SS47:Ey82/?y10;                       [revert Disrupting Ray to original value]
!!SN:W^Disrupting Ray_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS47:Ey82/y10;

!!SS66:Ey81/?y10;                       [revert SummoningFire to original value]
!!SN:W^SummoningFire_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS66:Ey81/y10;

!!SS67:Ey82/?y10;                       [revert SummoningAir to original value]
!!SN:W^SummoningAir_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS67:Ey82/y10;

!!SS68:Ey83/?y10;                       [revert SummoningWater to original value]
!!SN:W^SummoningWater_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS68:Ey83/y10;

!!SS69:Ey84/?y10;                       [revert SummoningEarth to original value]
!!SN:W^SummoningEarth_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS69:Ey84/y10;

!!SS31:Ey81/?y10;                       [revert ProtectionFire to original value]
!!SN:W^ProtectionFire_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS31:Ey81/y10;

!!SS30:Ey82/?y10;                       [revert ProtectionAir to original value]
!!SN:W^ProtectionAir_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS30:Ey82/y10;

!!SS32:Ey83/?y10;                       [revert ProtectionWater to original value]
!!SN:W^ProtectionWater_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS32:Ey83/y10;

!!SS33:Ey84/?y10;                       [revert ProtectionEarth to original value]
!!SN:W^ProtectionEarth_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS33:Ey84/y10;

!!SS38:Ey84/?y10;                       [revert Resurrection to original value]
!!SN:W^Resurrection_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS38:Ey84/y10;

!!SS39:Ey84/?y10;                       [revert Animation to original value]
!!SN:W^Animation_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS39:Ey84/y10;

!!if&y1=100;                            [Disabled]
  !!SS24:E3/?y10;                       [revert Death Ripple to original value]
  !!SN:W^Death Ripple_Value_Start^/?y30;
  !!VRy10&y10<>y30:Sy30;
  !!SS24:E3/y10;

  !!SS25:E3/?y10;                       [revert Destroy Undead to original value]
  !!SN:W^Destroy Undead_Value_Start^/?y30;
  !!VRy10&y10<>y30:Sy30;
  !!SS25:E3/y10;
!!en;

!!SS48:Ey83/?y10;                       [revert Prayer to original value]
!!SN:W^Prayer_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS48:Ey83/y10;

!!SS55:Ey83/?y10;                       [revert Slayer to original value]
!!SN:W^Slayer_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS55:Ey83/y10;

!!SS49:Ey83/?y10;                       [revert Mirth to original value]
!!SN:W^Mirth_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS49:Ey83/y10;

!!SS50:Ey84/?y10;                       [revert Sorrow to original value]
!!SN:W^Sorrow_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS50:Ey84/y10;

!!SS51:Ey82/?y10;                       [revert Fortune to original value]
!!SN:W^Fortune_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS51:Ey82/y10;

!!SS52:Ey81/?y10;                       [revert Misfortune to original value]
!!SN:W^Misfortune_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS52:Ey81/y10;

!!SS56:Ey81/?y10;                       [revert Frenzy to original value]
!!SN:W^Frenzy_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS56:Ey81/y10;

!!SS37:Ey83/?y10;                       [revert Cure to original value]
!!SN:W^Cure_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS37:Ey83/y10;

!!SS13:Ey81/?y10;                       [revert Fire Wall to original value]
!!SN:W^Fire Wall_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS13:Ey81/y10;

!!SS11:Ey81/?y10;                       [revert Land Mine to original value]
!!SN:W^Land Mine_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS11:Ey81/y10;

!!FU(Spell_Trainer_Calc):Py99/?y85;     [Pass Hero Number and return Number of Spell Upgrades and Chance for Spell Upgrade]

!!SN:W^Upgrade_Counter^/?y21;
!!FU&y85=1/y21>=1:E;                    [can only upgrade 1 times in one battle witch basic scholar]
!!FU&y85=2/y21>=2:E;                    [can only upgrade 2 times in one battle witch advanced scholar]
!!FU&y85=3/y21>=3:E;                    [can only upgrade 3 times in one battle witch expert scholar]
!!FU&y85=4/y21>=4:E;                    [allows +1 spell upgrade with Collar of conjuring]
!!FU&y85=5/y21>=5:E;                    [allows +1 spell upgrade with Ring of conjuring]
!!FU&y85=6/y21>=6:E;
!!FU&y85=7/y21>=7:E;

!!BG:S?y2;                              [y2 now contains spell number]

!!FU&y2<=9|y2>69:E;
!!SN:W^Spell_Number_Buff^/?y3;

!!FU&y2<>y3:E;                          [Exit if different Spell than Hero cast]


!!if&y2=27/y84>=0;                      [Shield]
!!SN:W^SpellTrainerHero%Y99_Spell27^/?y1;
!!if|y1=2/y1=6/y1=11/y1=17/y1=24/y1=32/y1=41/y1=50/y1=61/y1=73/y1=86/y1=100/y1>100;
!!if|y1<=100/y1=120/y1=140/y1=160/y1=180/y1=200/y1=220/y1=240/y1=260/y1=280/y1=300;
!!SN:W^Hero%Y99_Shield_Upgrade^/?y20;
*!SS27:E3/?y10;
*!VRy10:Sy10 -y20 -101 * -1;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Shield^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Shield_Upgrade^/d+1;    [set upgrade counter and increase upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=43/y81>=0;                      [Bloodlust]
!!SN:W^SpellTrainerHero%Y99_Spell43^/?y1;
!!if|y1=3/y1=7/y1=12/y1=17/y1=24/y1=32/y1=41/y1=50/y1=61/y1=73/y1=86/y1=100/y1>100;
!!if|y1<=100/y1=120/y1=140/y1=160/y1=180/y1=200/y1=220/y1=240/y1=260/y1=280/y1=300;
!!SN:W^Hero%Y99_Bloodlust_Upgrade^/?y20;
*!SS43:E3/?y10;
*!VRy10:+1 +y20;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Bloodlust^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Bloodlust_Upgrade^/d+1; [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=41/y83>=0;                      [Bless]
!!SN:W^SpellTrainerHero%Y99_Spell41^/?y1;
!!if|y1=10/y1=30/y1=55/y1=90/y1=130/y1=170/y1=220/y1=300/y1=400/y1=500/y1=600/y1=700/y1=800/y1=1000;
!!SN:W^Hero%Y99_Bless_Upgrade^/?y20;
*!SS41:E3/?y10;
*!VRy10:+1 +y20;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Bless^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Bless_Upgrade^/d+1;     [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;

!!if&y2=42/y81>=0;                      [Curse]
!!SN:W^SpellTrainerHero%Y99_Spell42^/?y1;
!!if|y1=7/y1=20/y1=35/y1=60/y1=90/y1=120/y1=150/y1=200/y1=250/y1=300/y1=350/y1=400/y1=450/y1=500/y1=550;
!!SN:W^Hero%Y99_Curse_Upgrade^/?y20;
*!SS42:E3/?y10;
*!VRy10:+1 +y20;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Curse^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Curse_Upgrade^/d+1;     [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;

!!if&y2=44/y82>=0;                      [Precision]
!!SN:W^SpellTrainerHero%Y99_Spell44^/?y1;
!!if|y1=3/y1=7/y1=12/y1=17/y1=24/y1=32/y1=41/y1=50/y1=61/y1=73/y1=86/y1=100/y1>100;
!!if|y1<=100/y1=120/y1=140/y1=160/y1=180/y1=200/y1=220/y1=240/y1=260/y1=280/y1=300;
!!SN:W^Hero%Y99_Precision_Upgrade^/?y20;
*!SS44:E3/?y10;
*!VRy10:+1 +y20;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Precision^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Precision_Upgrade^/d+1; [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=45/y83>=0;                      [Weakness]
!!SN:W^SpellTrainerHero%Y99_Spell45^/?y1;
!!if|y1=3/y1=7/y1=12/y1=17/y1=24/y1=32/y1=41/y1=50/y1=61/y1=73/y1=86/y1=100/y1>100;
!!if|y1<=100/y1=120/y1=140/y1=160/y1=180/y1=200/y1=220/y1=240/y1=260/y1=280/y1=300;
!!SN:W^Hero%Y99_Weakness_Upgrade^/?y20;
*!SS45:E3/?y10;
*!VRy10:+1 +y20;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Weakness^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Weakness_Upgrade^/d+1;  [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=46/y84>=0;                      [Stoneskin]
!!SN:W^SpellTrainerHero%Y99_Spell46^/?y1;
!!if|y1=3/y1=7/y1=12/y1=17/y1=24/y1=32/y1=41/y1=50/y1=61/y1=73/y1=86/y1=100/y1>100;
!!if|y1<=100/y1=120/y1=140/y1=160/y1=180/y1=200/y1=220/y1=240/y1=260/y1=280/y1=300;
!!SN:W^Hero%Y99_Stoneskin_Upgrade^/?y20;
*!SS46:E3/?y10;
*!VRy10:+1 +y20;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Stoneskin^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Stoneskin_Upgrade^/d+1; [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=28/y82>=0;                      [Air Shield]
!!SN:W^SpellTrainerHero%Y99_Spell28^/?y1;
!!if|y1=2/y1=6/y1=11/y1=17/y1=24/y1=32/y1=41/y1=50/y1=61/y1=73/y1=86/y1=100/y1>100;
!!if|y1<=100/y1=120/y1=140/y1=160/y1=180/y1=200/y1=220/y1=240/y1=260/y1=280/y1=300;
!!SN:W^Hero%Y99_Air Shield_Upgrade^/?y20;
*!SS28:E3/?y10;
*!VRy10:Sy10 -y20 -101 * -1;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_AirShield^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Air Shield_Upgrade^/d+1;[set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=29/y81>=0;                      [Fire Shield]
!!SN:W^SpellTrainerHero%Y99_Spell29^/?y1;
!!if|y1=2/y1=7/y1=12/y1=17/y1=24/y1=32/y1=41/y1=50/y1=60/y1=70/y1=80/y1=90/y1=100;
!!SN:W^Hero%Y99_Fire Shield_Upgrade^/?y20;
*!SS29:E3/?y10;
*!VRy10:+1 +y20;
!!VRy10:Sy20 *50 +50;
!!SN:T^AC_Spells.Trainer_FireShield^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Fire Shield_Upgrade^/d+1;[set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;

!!if&y2=53/y82>=0;                      [Haste]
!!SN:W^SpellTrainerHero%Y99_Spell53^/?y1;
!!if|y1=4/y1=13/y1=28/y1=40/y1=65/y1=85/y1=110/y1=150/y1=200/y1=250/y1=300/y1=350;
!!SN:W^Hero%Y99_Haste_Upgrade^/?y20;
*!SS53:E3/?y10;
*!VRy10:+1 +y20;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Haste^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Haste_Upgrade^/d+1;     [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;

!!if&y2=54/y84>=0;                      [Slow]
!!SN:W^SpellTrainerHero%Y99_Spell54^/?y1;
!!if|y1=3/y1=8/y1=17/y1=26/y1=35/y1=45/y1=50/y1=60/y1=70/y1=80/y1>80;
!!if|y1<=80/y1=100/y1=120/y1=150/y1=160/y1=180/y1=200/y1=240/y1=260/y1=280/y1=300;
!!SN:W^Hero%Y99_Slow_Upgrade^/?y20;
*!SS54:E3/?y10;
*!VRy10:Sy10 -y20 -101 * -1;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Slow^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Slow_Upgrade^/d+1;      [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=47/y82>=0;                      [Disrupting Ray]
!!SN:W^SpellTrainerHero%Y99_Spell47^/?y1;
!!if|y1=2/y1=6/y1=11/y1=17/y1=24/y1=32/y1=41/y1=50/y1=61/y1=73/y1=86/y1=100/y1>100;
!!if|y1<=100/y1=120/y1=140/y1=160/y1=180/y1=200/y1=220/y1=240/y1=260/y1=280/y1=300;
!!SN:W^Hero%Y99_Disrupting Ray_Upgrade^/?y20;
*!SS47:E3/?y10;
*!VRy10:+1 +y20;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Disrupting^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Disrupting Ray_Upgrade^/d+1; [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=66/y81>=0;                      [SummoningFire]
!!SN:W^SpellTrainerHero%Y99_Spell66^/?y1;
!!if|y1=2/y1=6/y1=10/y1=15/y1=20/y1=26/y1=32/y1=38/y1=45/y1=52/y1=60/y1=70/y1=80/y1>80;
!!if|y1<=80/y1=90/y1=100/y1=110/y1=120/y1=130/y1=140/y1=160/y1=180/y1=200/y1=250;
!!SN:W^Hero%Y99_Summoning_Upgrade^/?y20;
!!VRy10:Sy20*2+2;
!!SN:T^AC_Spells.Trainer_Summoning^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Summoning_Upgrade^/d+1; [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=67/y84>=0;                      [SummoningEarth]
!!SN:W^SpellTrainerHero%Y99_Spell66^/?y1;
!!if|y1=2/y1=6/y1=10/y1=15/y1=20/y1=26/y1=32/y1=38/y1=45/y1=52/y1=60/y1=70/y1=80/y1>80;
!!if|y1<=80/y1=90/y1=100/y1=110/y1=120/y1=130/y1=140/y1=160/y1=180/y1=200/y1=250;
!!SN:W^Hero%Y99_Summoning_Upgrade^/?y20;
!!VRy10:Sy20*2+2;
!!SN:T^AC_Spells.Trainer_Summoning^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Summoning_Upgrade^/d+1; [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=68/y83>=0;                      [SummoningWater]
!!SN:W^SpellTrainerHero%Y99_Spell66^/?y1;
!!if|y1=2/y1=6/y1=10/y1=15/y1=20/y1=26/y1=32/y1=38/y1=45/y1=52/y1=60/y1=70/y1=80/y1>80;
!!if|y1<=80/y1=90/y1=100/y1=110/y1=120/y1=130/y1=140/y1=160/y1=180/y1=200/y1=250;
!!SN:W^Hero%Y99_Summoning_Upgrade^/?y20;
!!VRy10:Sy20*2+2;
!!SN:T^AC_Spells.Trainer_Summoning^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Summoning_Upgrade^/d+1; [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=69/y82>=0;                      [SummoningAir]
!!SN:W^SpellTrainerHero%Y99_Spell66^/?y1;
!!if|y1=2/y1=6/y1=10/y1=15/y1=20/y1=26/y1=32/y1=38/y1=45/y1=52/y1=60/y1=70/y1=80/y1>80;
!!if|y1<=80/y1=90/y1=100/y1=110/y1=120/y1=130/y1=140/y1=160/y1=180/y1=200/y1=250;
!!SN:W^Hero%Y99_Summoning_Upgrade^/?y20;
!!VRy10:Sy20*2+2;
!!SN:T^AC_Spells.Trainer_Summoning^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Summoning_Upgrade^/d+1; [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=31/y81>=0;                      [ProtectionFire]
!!SN:W^SpellTrainerHero%Y99_Spell30^/?y1;
!!if|y1=2/y1=5/y1=9/y1=13/y1=17/y1=21/y1=25/y1=29/y1=34/y1=40/y1=50/y1=65/y1=80/y1=100/y1>100;
!!if|y1<=100/y1=120/y1=140/y1=160/y1=180/y1=200/y1=220/y1=240/y1=260/y1=280/y1=300;
!!SN:W^Hero%Y99_Protection_Upgrade^/?y20;
*!SS31:E3/?y10;
*!VRy10:Sy10 -y20 -101 * -1;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Protection^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Protection_Upgrade^/d+1;[set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=30/y82>=0;                      [ProtectionAir]
!!SN:W^SpellTrainerHero%Y99_Spell30^/?y1;
!!if|y1=2/y1=5/y1=9/y1=13/y1=17/y1=21/y1=25/y1=29/y1=34/y1=40/y1=50/y1=65/y1=80/y1=100/y1>100;
!!if|y1<=100/y1=120/y1=140/y1=160/y1=180/y1=200/y1=220/y1=240/y1=260/y1=280/y1=300;
!!SN:W^Hero%Y99_Protection_Upgrade^/?y20;
*!SS30:E3/?y10;
*!VRy10:Sy10 -y20 -101 * -1;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Protection^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Protection_Upgrade^/d+1;[set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=32/y83>=0;                      [ProtectionWater]
!!SN:W^SpellTrainerHero%Y99_Spell30^/?y1;
!!if|y1=2/y1=5/y1=9/y1=13/y1=17/y1=21/y1=25/y1=29/y1=34/y1=40/y1=50/y1=65/y1=80/y1=100/y1>100;
!!if|y1<=100/y1=120/y1=140/y1=160/y1=180/y1=200/y1=220/y1=240/y1=260/y1=280/y1=300;
!!SN:W^Hero%Y99_Protection_Upgrade^/?y20;
*!SS32:E3/?y10;
*!VRy10:Sy10 -y20 -101 * -1;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Protection^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Protection_Upgrade^/d+1;[set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=33/y84>=0;                      [ProtectionEarth]
!!SN:W^SpellTrainerHero%Y99_Spell30^/?y1;
!!if|y1=2/y1=5/y1=9/y1=13/y1=17/y1=21/y1=25/y1=29/y1=34/y1=40/y1=50/y1=65/y1=80/y1=100/y1>100;
!!if|y1<=100/y1=120/y1=140/y1=160/y1=180/y1=200/y1=220/y1=240/y1=260/y1=280/y1=300;
!!SN:W^Hero%Y99_Protection_Upgrade^/?y20;
*!SS33:E3/?y10;
*!VRy10:Sy10 -y20 -101 * -1;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Protection^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Protection_Upgrade^/d+1;[set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=38/y84>=0;                      [Resurrection]
!!SN:W^SpellTrainerHero%Y99_Spell38^/?y1;
!!if|y1=2/y1=6/y1=11/y1=17/y1=23/y1=30/y1=35/y1=40/y1=45/y1=50/y1=55/y1=60/y1=65/y1>65;
!!if|y1<=65/y1=70/y1=80/y1=85/y1=90/y1=95/y1=100/y1=120/y1=140/y1=160/y1=180/y1=200;
!!SN:W^Hero%Y99_Resurrection_Upgrade^/?y20;
!!VRy22:Sy20*80;
!!VRy10:Sy22 +80;
!!SN:T^AC_Spells.Trainer_Resurrection^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Resurrection_Upgrade^/d+1; [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=39/y84>=0;                      [Animation]
!!SN:W^SpellTrainerHero%Y99_Spell39^/?y1;
!!if|y1=2/y1=6/y1=11/y1=17/y1=23/y1=30/y1=35/y1=40/y1=45/y1=50/y1=55/y1=60/y1=65/y1>65;
!!if|y1<=65/y1=70/y1=80/y1=85/y1=90/y1=95/y1=100/y1=120/y1=140/y1=160/y1=180/y1=200;
!!SN:W^Hero%Y99_Animation_Upgrade^/?y20;
!!VRy22:Sy20*100;
!!VRy10:Sy22 +100;
!!SN:T^AC_Spells.Trainer_Animation^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Animation_Upgrade^/d+1; [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=24/y84=30;                      [Disabled                      [Death Ripple]
!!SN:W^SpellTrainerHero%Y99_Spell24^/?y1;
!!if|y1=2/y1=6/y1=11/y1=17/y1=23/y1=30/y1=35/y1=40/y1=45/y1=50/y1=55/y1=60/y1=65/y1>65;
!!if|y1<=65/y1=70/y1=80/y1=85/y1=90/y1=95/y1=100/y1=120/y1=140/y1=160/y1=180/y1=200;
!!SN:W^Hero%Y99_Death Ripple_Upgrade^/?y20;
!!VRy22:Sy20*30;
!!VRy10:S50 +y22;
!!SN:T^AC_Spells.Trainer_Ripple^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Death Ripple_Upgrade^/d+1; [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=25/y82=30;                      [Disabled                    [Destroy Undead]
!!SN:W^SpellTrainerHero%Y99_Spell25^/?y1;
!!if|y1=2/y1=6/y1=11/y1=17/y1=23/y1=30/y1=35/y1=40/y1=45/y1=50/y1=55/y1=60/y1=65/y1>65;
!!if|y1<=65/y1=70/y1=80/y1=85/y1=90/y1=95/y1=100/y1=120/y1=140/y1=160/y1=180/y1=200;
!!SN:W^Hero%Y99_Destroy Undead_Upgrade^/?y20;
!!VRy22:Sy20*50;
!!VRy10:S50 +y22;
!!SN:T^AC_Spells.Trainer_Destroy^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Destroy Undead_Upgrade^/d+1; [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=48/y83>=0;                      [Prayer]
!!SN:W^SpellTrainerHero%Y99_Spell48^/?y1;
!!if|y1=10/y1=35/y1=50/y1=70/y1=130/y1=180/y1=220/y1=290/y1=350/y1=450/y1=550/y1=650/y1=800/y1=1000;
!!SN:W^Hero%Y99_Prayer_Upgrade^/?y20;
*!SS48:E3/?y10;
*!VRy10:+1 +y20;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Prayer^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Prayer_Upgrade^/d+1;    [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;

!!if&y2=55/y81>=0;                      [Slayer]
!!SN:W^SpellTrainerHero%Y99_Spell55^/?y1;
!!if|y1=2/y1=6/y1=11/y1=17/y1=24/y1=32/y1=41/y1=50/y1=60/y1=70/y1=80/y1=90/y1=100;
!!SN:W^Hero%Y99_Slayer_Upgrade^/?y20;
*!SS55:E3/?y10;
*!VRy10:+1 +y20;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Slayer^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Slayer_Upgrade^/d+1;    [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;

!!if&y2=49/y83>=0;                      [Mirth]
!!SN:W^SpellTrainerHero%Y99_Spell49^/?y1;
!!if|y1=10/y1=30/y1=60/y1=100;
!!SN:W^Hero%Y99_Mirth_Upgrade^/?y20;
*!SS49:E3/?y10;
*!VRy10:+1 +y20;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Mirth^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Mirth_Upgrade^/d+1;     [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;

!!if&y2=50/y84>=0;                      [Sorrow]
!!SN:W^SpellTrainerHero%Y99_Spell50^/?y1;
!!if|y1=10/y1=30/y1=60/y1=100;
!!SN:W^Hero%Y99_Sorrow_Upgrade^/?y20;
*!SS50:E3/?y10;
*!VRy10:+1 +y20;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Sorrow^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Sorrow_Upgrade^/d+1;    [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;

!!if&y2=51/y82>=0;                      [Fortune]
!!SN:W^SpellTrainerHero%Y99_Spell51^/?y1;
!!if|y1=10/y1=30/y1=60/y1=100;
!!SN:W^Hero%Y99_Fortune_Upgrade^/?y20;
*!SS51:E3/?y10;
*!VRy10:+1 +y20;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Fortune^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Fortune_Upgrade^/d+1;   [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;

!!if&y2=52/y81>=0;                      [Misfortune]
!!SN:W^SpellTrainerHero%Y99_Spell52^/?y1;
!!if|y1=10/y1=30/y1=60/y1=100;
!!SN:W^Hero%Y99_Misfortune_Upgrade^/?y20;
*!SS52:E3/?y10;
*!VRy10:+1 +y20;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Misfortune^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Misfortune_Upgrade^/d+1;[set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;

!!if&y2=56/y81>=0;                      [Frenzy]
!!SN:W^SpellTrainerHero%Y99_Spell56^/?y1;
!!if|y1=2/y1=6/y1=11/y1=17/y1=24/y1=32/y1=41/y1=50/y1=60/y1=70/y1=80/y1=90/y1=100;
!!SN:W^Hero%Y99_Frenzy_Upgrade^/?y20;
!!VRy22:Sy20*5;                         [5% extra Bonus per level]
!!VRy10:S5 +y22;
!!SN:T^AC_Spells.Trainer_Frenzy^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Frenzy_Upgrade^/d+1;    [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;

!!if&y2=37/y83>=0;                      [Cure]
!!SN:W^SpellTrainerHero%Y99_Spell37^/?y1;
!!if|y1=2/y1=6/y1=11/y1=17/y1=23/y1=30/y1=35/y1=40/y1=45/y1=50/y1=55/y1=60/y1=65/y1>65;
!!if|y1<=65/y1=70/y1=80/y1=85/y1=90/y1=95/y1=100/y1=120/y1=140/y1=160/y1=180/y1=200;
!!SN:W^Hero%Y99_Cure_Upgrade^/?y20;
!!VRy22:Sy20*5;                         [5 extra HP per level]
!!VRy10:S5 +y22;
!!SN:T^AC_Spells.Trainer_Cure^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Cure_Upgrade^/d+1;      [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=13/y81>=0;                      [Fire Wall]
!!SN:W^SpellTrainerHero%Y99_Spell13^/?y1;
!!if|y1=2/y1=6/y1=11/y1=17/y1=24/y1=32/y1=41/y1=50/y1=61/y1=73/y1=86/y1=100/y1>100;
!!if|y1<=100/y1=120/y1=140/y1=160/y1=180/y1=200/y1=220/y1=240/y1=260/y1=280/y1=300;
!!SN:W^Hero%Y99_Fire Wall_Upgrade^/?y20;
!!VRy22:Sy20*35;
!!VRy10:S35 +y22;
!!SN:T^AC_Spells.Trainer_FireWall^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Fire Wall_Upgrade^/d+1; [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=11/y81>=0;                      [Land Mine]
!!SN:W^SpellTrainerHero%Y99_Spell11^/?y1;
!!if|y1=2/y1=6/y1=11/y1=17/y1=24/y1=32/y1=41/y1=50/y1=61/y1=73/y1=86/y1=100/y1>100;
!!if|y1<=100/y1=120/y1=140/y1=160/y1=180/y1=200/y1=220/y1=240/y1=260/y1=280/y1=300;
!!SN:W^Hero%Y99_Land Mine_Upgrade^/?y20;
!!VRy22:Sy20*50;
!!VRy10:S50 +y22;
!!SN:T^AC_Spells.Trainer_LandMine^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Land Mine_Upgrade^/d+1; [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;


*------------------------------------------------------------------------------*
!?BG1&1000;                             [Trigger damage Spells]

!!SN:W^Spell_Trainer_Mod^/?y1; !!FU&y1=0:E; [Check if options have already been activated]
!!SN:W^Flag_V896_Value^/?y1;
!!FU&y1<>1:E;
!!SN:W^Flag_V896_Value^/0;

!!BG:H?y3;                              [Determine if AI controlls Hero]
!!HEy3:O?y3;
!!OW:Iy3/?y3;
!!FU&y3=1:E;                            [Exit if AI Hero]

!!BG:S?y2;                              [y2 now contains spell number]
!!FU&y2<=9|y2>69:E;

!!BG:Q?y1;
!!BA:Hy1/?y99;                          [Get Hero Number]
!!FU&y99=-2:E;                          [Exit if no Hero]

!!FU(Spell_Trainer_Calc):Py99/?y85/?y91;[Pass Hero Number and return Number of Spell Upgrades and Chance for Spell Upgrade]
!!FU&y85=0:E;                           [Exit if NO possible Spell Upgrades]
!!VRy92:S0R99;                          [Random Roll: Chance for Might Heros without Scholar to level up is 33%]
!!FU&y91<y92:E;                         [Exit if Roll was not successful]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84; [Checke ob der Held scholar und Magien hat]

!!HEy99&y99>=0:E?y70/?y71/1;            [Get Heroes level]
!!HEy99&y99>=0:A2/76/d/?y76 A2/77/d/?y77 A2/78/d/?y78 A2/139/d/?y79; [Check for Artifacts Collar,Ring,Cape,Ring of the Magi]

*!VRy71:*2;                             [Double the possible amount of spell level cap Test]
!!VRy71&y78=1|y79=1:+5;                 [If hero wears cape/ring of the magi increase maximal level of spells by 5]

!!SN:W^Damage_Spells_Increment^/?y60;
!!VRy60&y79=1:*2;

!!SN:W^Upgrade_Counter^/?y90;
!!FU&y85=1/y90>=1:E;                    [can only upgrade 1 times in one battle witch basic scholar]
!!FU&y85=2/y90>=2:E;
!!FU&y85=3/y90>=3:E;
!!FU&y85=4/y90>=4:E;
!!FU&y85=5/y90>=5:E;
!!FU&y85=6/y90>=6:E;
!!FU&y85=7/y90>=7:E;

!!SN:W^Spell_Number_Damage^/?y2;
!!SN:W^ST_Stack_Number1^/?y50;
!!SN:W^Monster_Level^/?y52;

!!if&y50>=0/y50<=41;
!!BMy50:N?y51;
!!VRy51|y2=19/y2=24/y2=25/y2=26:S0;     [Chain Lightning, Armageddon, 25  Destroy Undead, 24 Death Ripple dont neet to kill to level up]
!!if&y51=0;


!!if&y2=15;
               
!!SN:W^SpellTrainerHero%Y99_Spell15^/?y1;
!!VRy72:+y1 -y71;
!!VRy73:S0R10;
!!VRy73&y72<0:S11;
!!VRy73&y73>y72:S11;
!!if&y73=11;
!!SN:W^SpellTrainerHero%Y99_Spell15^/d+1;
!!SN&y79=1:W^SpellTrainerHero%Y99_Spell15^/d+1;
!!SN:W^SpellTrainerHero%Y99_Spell15^/?y1;
!!VRy10:Sy1 *y60; !!VRy10&y79=1::2;     [Total spell damages increased]
!!VRy90:+1;
!!UN:N1/2/y2; !!SN:T^AC_Spells.Trainer^/?z1/^damage^/y60/^damage2^/y10; !!VRz1:S^{%Z2 %Z1}^;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!en;
!!en;
   

!!if&y2=16/y83>=0;
!!SN:W^SpellTrainerHero%Y99_Spell16^/?y1;
!!VRy72:+y1 -y71;
!!VRy73:S0R10;
!!VRy73&y72<0:S11;
!!VRy73&y73>y72:S11;
!!if&y73=11;
!!SN:W^SpellTrainerHero%Y99_Spell16^/d+1;
!!SN&y79=1:W^SpellTrainerHero%Y99_Spell16^/d+1;
!!SN:W^SpellTrainerHero%Y99_Spell16^/?y1;
!!VRy10:Sy1 *y60; !!VRy10&y79=1::2;
!!VRy90:+1;
!!UN:N1/2/y2; !!SN:T^AC_Spells.Trainer^/?z1/^damage^/y60/^damage2^/y10; !!VRz1:S^{%Z2 %Z1}^;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!en;
!!en;

!!if&y2=17/y82>=0;
!!SN:W^SpellTrainerHero%Y99_Spell17^/?y1;
!!VRy72:+y1 -y71;
!!VRy73:S0R10;
!!VRy73&y72<0:S11;
!!VRy73&y73>y72:S11;
!!if&y73=11;
!!SN:W^SpellTrainerHero%Y99_Spell17^/d+1;
!!SN&y79=1:W^SpellTrainerHero%Y99_Spell17^/d+1;
!!SN:W^SpellTrainerHero%Y99_Spell17^/?y1;
!!VRy10:Sy1 *y60; !!VRy10&y79=1::2;
!!VRy90:+1;
!!UN:N1/2/y2; !!SN:T^AC_Spells.Trainer^/?z1/^damage^/y60/^damage2^/y10; !!VRz1:S^{%Z2 %Z1}^;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!en;
!!en;

!!if&y2=21/y81>=0;
!!SN:W^SpellTrainerHero%Y99_Spell21^/?y1;
!!VRy72:+y1 -y71;
!!VRy73:S0R10;
!!VRy73&y72<0:S11;
!!VRy73&y73>y72:S11;
!!if&y73=11;
!!SN:W^SpellTrainerHero%Y99_Spell21^/d+1;
!!SN&y79=1:W^SpellTrainerHero%Y99_Spell21^/d+1;
!!SN:W^SpellTrainerHero%Y99_Spell21^/?y1;
!!VRy10:Sy1 *y60; !!VRy10&y79=1::2;
!!VRy90:+1;
!!UN:N1/2/y2; !!SN:T^AC_Spells.Trainer^/?z1/^damage^/y60/^damage2^/y10; !!VRz1:S^{%Z2 %Z1}^;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!en;
!!en;

!!if&y2=22/y52>0/y81>=0;
!!SN:W^SpellTrainerHero%Y99_Spell22^/?y1;
!!VRy72:+y1 -y71;
!!VRy73:S0R10;
!!VRy73&y72<0:S11;
!!VRy73&y73>y72:S11;
!!if&y73=11;
!!SN:W^SpellTrainerHero%Y99_Spell22^/d+1;
!!SN&y79=1:W^SpellTrainerHero%Y99_Spell22^/d+1;
!!SN:W^SpellTrainerHero%Y99_Spell22^/?y1;
!!VRy10:Sy1 *y60; !!VRy10&y79=1::2;
!!VRy90:+1;
!!UN:N1/2/y2; !!SN:T^AC_Spells.Trainer^/?z1/^damage^/y60/^damage2^/y10; !!VRz1:S^{%Z2 %Z1}^;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!en;
!!en;

!!if&y2=23/y52>0/y84>=0;
!!SN:W^SpellTrainerHero%Y99_Spell23^/?y1;
!!VRy72:+y1 -y71;
!!VRy73:S0R10;
!!VRy73&y72<0:S11;
!!VRy73&y73>y72:S11;
!!if&y73=11;
!!SN:W^SpellTrainerHero%Y99_Spell23^/d+1;
!!SN&y79=1:W^SpellTrainerHero%Y99_Spell23^/d+1;
!!SN:W^SpellTrainerHero%Y99_Spell23^/?y1;
!!VRy10:Sy1 *y60; !!VRy10&y79=1::2;
!!VRy90:+1;
!!UN:N1/2/y2; !!SN:T^AC_Spells.Trainer^/?z1/^damage^/y60/^damage2^/y10; !!VRz1:S^{%Z2 %Z1}^;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!en;
!!en;

!!if&y2=20/y83>=0;
!!SN:W^SpellTrainerHero%Y99_Spell20^/?y1;
!!VRy72:+y1 -y71;
!!VRy73:S0R10;
!!VRy73&y72<0:S11;
!!VRy73&y73>y72:S11;
!!if&y73=11;
!!SN:W^SpellTrainerHero%Y99_Spell20^/d+1;
!!SN&y79=1:W^SpellTrainerHero%Y99_Spell20^/d+1;
!!SN:W^SpellTrainerHero%Y99_Spell20^/?y1;
!!VRy10:Sy1 *y60; !!VRy10&y79=1::2;
!!VRy90:+1;
!!UN:N1/2/y2; !!SN:T^AC_Spells.Trainer^/?z1/^damage^/y60/^damage2^/y10; !!VRz1:S^{%Z2 %Z1}^;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!en;
!!en;

!!VRy80:S0R3;                           [1/4 chance to level]
!!if&y2=19/y80=3/y82>0;
!!SN:W^SpellTrainerHero%Y99_Spell19^/?y1;
!!VRy72:+y1 -y71;
!!VRy73:S0R10;
!!VRy73&y72<0:S11;
!!VRy73&y73>y72:S11;
!!if&y73=11;
!!SN:W^SpellTrainerHero%Y99_Spell19^/d+1;
!!SN&y79=1:W^SpellTrainerHero%Y99_Spell19^/d+1;
!!SN:W^SpellTrainerHero%Y99_Spell19^/?y1;
!!VRy10:Sy1 *y60; !!VRy10&y79=1::2;
!!VRy90:+1;
!!UN:N1/2/y2; !!SN:T^AC_Spells.Trainer^/?z1/^damage^/y60/^damage2^/y10; !!VRz1:S^{%Z2 %Z1}^;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!en;
!!en;

!!if&y2=18/y52>2/y84>=0;
!!SN:W^SpellTrainerHero%Y99_Spell18^/?y1;
!!VRy72:+y1 -y71;
!!VRy73:S0R10;
!!VRy73&y72<0:S11;
!!VRy73&y73>y72:S11;
!!if&y73=11;
!!SN:W^SpellTrainerHero%Y99_Spell18^/d+1;
!!SN&y79=1:W^SpellTrainerHero%Y99_Spell18^/d+1;
!!SN:W^SpellTrainerHero%Y99_Spell18^/?y1;
!!VRy10:Sy1 *y60; !!VRy10&y79=1::2;
!!VRy90:+1;
!!UN:N1/2/y2; !!SN:T^AC_Spells.Trainer^/?z1/^damage^/y60/^damage2^/y10; !!VRz1:S^{%Z2 %Z1}^;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!en;
!!en;

!!if&y2=26/y81>=0;                      [1/4 chance to level]
!!SN:W^SpellTrainerHero%Y99_Spell26^/?y1;
!!VRy72:+y1 -y71;
!!VRy73:S0R10;
!!VRy73&y72<0:S11;
!!VRy73&y73>y72:S11;
!!if&y73=11;
!!SN:W^SpellTrainerHero%Y99_Spell26^/d+1;
!!SN&y79=1:W^SpellTrainerHero%Y99_Spell26^/d+1;
!!SN:W^SpellTrainerHero%Y99_Spell26^/?y1;
!!VRy10:Sy1 *y60; !!VRy10&y79=1::2;
!!VRy90:+1;
!!UN:N1/2/y2; !!SN:T^AC_Spells.Trainer^/?z1/^damage^/y60/^damage2^/y10; !!VRz1:S^{%Z2 %Z1}^;
!!BU:Mz1;
*!SN:W^SpellTrainer_Sound_End^/1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!en;
!!en;

!!if&y2=24/y84>=0;                      [24  Death Ripple]
!!SN:W^SpellTrainerHero%Y99_Spell24^/?y1;
!!VRy72:+y1 -y71;
!!VRy73:S0R10;
!!VRy73&y72<0:S11;
!!VRy73&y73>y72:S11;
!!if&y73=11;
!!SN:W^SpellTrainerHero%Y99_Spell24^/d+1;
!!SN&y79=1:W^SpellTrainerHero%Y99_Spell24^/d+1;
!!SN:W^SpellTrainerHero%Y99_Spell24^/?y1;
!!VRy10:Sy1 *y60; !!VRy10&y79=1::2;
!!VRy90:+1;
!!UN:N1/2/y2; !!SN:T^AC_Spells.Trainer^/?z1/^damage^/y60/^damage2^/y10; !!VRz1:S^{%Z2 %Z1}^;
!!BU:Mz1;
*!SN:W^SpellTrainer_Sound_End^/1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!en;
!!en;

!!if&y2=25/y82>=0;                      [25 Destroy Undead]
!!SN:W^SpellTrainerHero%Y99_Spell25^/?y1;
!!VRy72:+y1 -y71;
!!VRy73:S0R10;
!!VRy73&y72<0:S11;
!!VRy73&y73>y72:S11;
!!if&y73=11;
!!SN:W^SpellTrainerHero%Y99_Spell25^/d+1;
!!SN&y79=1:W^SpellTrainerHero%Y99_Spell25^/d+1;
!!SN:W^SpellTrainerHero%Y99_Spell25^/?y1;
!!VRy10:Sy1 *y60; !!VRy10&y79=1::2;
!!VRy90:+1;
!!UN:N1/2/y2; !!SN:T^AC_Spells.Trainer^/?z1/^damage^/y60/^damage2^/y10; !!VRz1:S^{%Z2 %Z1}^;
!!BU:Mz1;
*!SN:W^SpellTrainer_Sound_End^/1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!en;
!!en;

!!en;
!!en;
!!SN:W^Upgrade_Counter^/y90;


*------------------------------------------------------------------------------*
!?MR1&1000;                             [after stack takes magic damage]

!!SN:W^Spell_Trainer_Mod^/?y1; !!FU&y1=0:E; [Check if options have already been activated]
!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>1:E;

!!BG:Q?y1;
!!BA:Hy1/?y99;
!!FU&y99=-2:E;                          [Exit if no Hero]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S18/?y85; [Checke current hero Scholar und Magien hat]
!!HEy99&y99>=0:E?y70/?y71/1;            [Get Heroes level]

!!MR:N?y50;

!!MR:S?y4;                              [Spell Number]
!!FU|y4<10/y4>26:E;                     [Exit if no valid Spell]
!!SN:W^Spell_Number_Damage^/y4;
!!MR:F?y10;                             [Get damage in y10]
!!SN:W^ST_Stack_Number1^/y50;
!!BMy50&y50>=0:T?y51;
!!MA:Ly51/?y52;                         [monster type and level}]
!!SN:W^Monster_Level^/y52;

!!SN:W^Flag_V896_Value^/1;
!!FU:E;                                 [Test Rest is Disabled and moved to Spell Description]

!!SN:W^Damage_Spells_Increment^/?y60;   [Get global value for damage increase]


!!if&y4=15;                             [Magic Arrow]
!!SN:W^SpellTrainerHero%Y99_Spell15^/?y1;
!!VRy11:Sy1 *y60 +100;                  [3% stronger with every use]
!!VRy10:Sy10 *y11 :100;
!!en;

!!if&y4=16/y83>=0;                      [Ice Bolt]
!!SN:W^SpellTrainerHero%Y99_Spell16^/?y1;
!!VRy11:Sy1 *y60 +100;                  [3% stronger with every use]
!!VRy10:Sy10 *y11 :100;
!!en;

!!if&y4=17/y82>=0;                      [Lightning Bolt]
!!SN:W^SpellTrainerHero%Y99_Spell17^/?y1;
!!VRy11:Sy1 *y60 +100;                  [3% stronger with every use]
!!VRy10:Sy10 *y11 :100;
!!en;

!!if&y4=21/y81>=0;                      [Fireball]
!!SN:W^SpellTrainerHero%Y99_Spell21^/?y1;
!!VRy11:Sy1 *y60 +100;                  [3% stronger with every use]
!!VRy10:Sy10 *y11 :100;
!!en;

!!if&y4=23/y84>=0;                      [Meteor Shower]
!!SN:W^SpellTrainerHero%Y99_Spell23^/?y1;
!!VRy11:Sy1 *y60 +100;                  [3% stronger with every use]
!!VRy10:Sy10 *y11 :100;
!!en;

!!if&y4=20/y83>=0;                      [Frost Ring]
!!SN:W^SpellTrainerHero%Y99_Spell20^/?y1;
!!VRy11:Sy1 *y60 +100;                  [3% stronger with every use]
!!VRy10:Sy10 *y11 :100;
!!en;

!!if&y4=19/y82>=0;                      [Chain Lightning]
!!SN:W^SpellTrainerHero%Y99_Spell19^/?y1;
!!VRy11:Sy1 *y60 +100;                  [3% stronger with every use]
!!VRy10:Sy10 *y11 :100;
!!en;

!!if&y4=22/y81>=0;                      [Inferno]
!!SN:W^SpellTrainerHero%Y99_Spell22^/?y1;
!!VRy11:Sy1 *y60 +100;                  [3% stronger with every use]
!!VRy10:Sy10 *y11 :100;
!!en;

!!if&y4=18/y84>=0;                      [Implosion]
!!SN:W^SpellTrainerHero%Y99_Spell18^/?y1;
!!VRy11:Sy1 *y60 +100;                  [3% stronger with every use]
!!VRy10:Sy10 *y11 :100;
!!en;

!!if&y4=26/y84>=0;                      [Armageddon]
!!SN:W^SpellTrainerHero%Y99_Spell26^/?y1;
!!VRy11:Sy1 *y60 +100;                  [3% stronger with every use]
!!VRy10:Sy10 *y11 :100;
!!en;

!!MR:Fy10;                              [apply new damage]

!!SN:W^Flag_V896_Value^/1;


*------------------------------------------------------------------------------*
!?FU(Spell_Trainer_Reset_1);

!!DO(Spell_Trainer_Reset)/0/69/1:Px16;  [Reset spell damage increase/counter for all Heroes when Map Starts]

!?FU(Spell_Trainer_Reset);
!!SN:W^SpellTrainerHero%X1_Spell%X16^/0;


*------------------------------------------------------------------------------*
!?FU(Spell_Trainer_Reset_2);

!!DO(Map_Start_Upgrade_Spells_Reset)/0/155/1:P; [Reset Spell Upgrades for all Heroes when Map Starts]


!?FU(Map_Start_Upgrade_Spells_Reset);

!!SS27:E3/?y10;
!!SN:W^Hero%X16_Shield_Upgrade^/0;
!!SN:W^Shield_Value_Start^/y10;

!!SS43:E3/?y10;
!!SN:W^Hero%X16_Bloodlust_Upgrade^/0;
!!SN:W^Bloodlust_Value_Start^/y10;

!!SS41:E3/?y10;
!!SN:W^Hero%X16_Bless_Upgrade^/0;
!!SN:W^Bless_Value_Start^/y10;

!!SS42:E3/?y10;
!!SN:W^Hero%X16_Curse_Upgrade^/0;
!!SN:W^Curse_Value_Start^/y10;

!!SS44:E3/?y10;
!!SN:W^Hero%X16_Precision_Upgrade^/0;
!!SN:W^Precision_Value_Start^/y10;

!!SS45:E3/?y10;
!!SN:W^Hero%X16_Weakness_Upgrade^/0;
!!SN:W^Weakness_Value_Start^/y10;

!!SS46:E3/?y10;
!!SN:W^Hero%X16_Stoneskin_Upgrade^/0;
!!SN:W^Stoneskin_Value_Start^/y10;

!!SS28:E3/?y10;
!!SN:W^Hero%X16_Air Shield_Upgrade^/0;
!!SN:W^Air Shield_Value_Start^/y10;

!!SS29:E3/?y10;
!!SN:W^Hero%X16_Fire Shield_Upgrade^/0;
!!SN:W^Fire Shield_Value_Start^/y10;

!!SS53:E3/?y10;
!!SN:W^Hero%X16_Haste_Upgrade^/0;
!!SN:W^Haste_Value_Start^/y10;

!!SS54:E3/?y10;
!!SN:W^Hero%X16_Slow_Upgrade^/0;
!!SN:W^Slow_Value_Start^/y10;

!!SS47:E3/?y10;
!!SN:W^Hero%X16_Disrupting Ray_Upgrade^/0;
!!SN:W^Disrupting Ray_Value_Start^/y10;

!!SS66:E3/?y10;
!!SN:W^Hero%X16_Summoning_Upgrade^/0;
!!SN:W^SummoningFire_Value_Start^/y10;

!!SS67:E3/?y10;
!!SN:W^Hero%X16_Summoning_Upgrade^/0;
!!SN:W^SummoningAir_Value_Start^/y10;

!!SS68:E3/?y10;
!!SN:W^Hero%X16_Summoning_Upgrade^/0;
!!SN:W^SummoningWater_Value_Start^/y10;

!!SS69:E3/?y10;
!!SN:W^Hero%X16_Summoning_Upgrade^/0;
!!SN:W^SummoningEarth_Value_Start^/y10;

!!SS31:E3/?y10;
!!SN:W^Hero%X16_Protection_Upgrade^/0;
!!SN:W^ProtectionFire_Value_Start^/y10;

!!SS30:E3/?y10;
!!SN:W^Hero%X16_Protection_Upgrade^/0;
!!SN:W^ProtectionAir_Value_Start^/y10;

!!SS32:E3/?y10;
!!SN:W^Hero%X16_Protection_Upgrade^/0;
!!SN:W^ProtectionWater_Value_Start^/y10;

!!SS33:E3/?y10;
!!SN:W^Hero%X16_Protection_Upgrade^/0;
!!SN:W^ProtectionEarth_Value_Start^/y10;

!!SS38:E3/?y10;
!!SN:W^Hero%X16_Resurrection_Upgrade^/0;
!!SN:W^Resurrection_Value_Start^/y10;

!!SS39:E3/?y10;
!!SN:W^Hero%X16_Animation_Upgrade^/0;
!!SN:W^Animation_Value_Start^/y10;

!!SS24:E3/?y10;
!!SN:W^Hero%X16_Death Ripple_Upgrade^/0;
!!SN:W^Death Ripple_Value_Start^/y10;

!!SS25:E3/?y10;
!!SN:W^Hero%X16_Destroy Undead_Upgrade^/0;
!!SN:W^Destroy Undead_Value_Start^/y10;

!!SS48:E3/?y10;
!!SN:W^Hero%X16_Prayer_Upgrade^/0;
!!SN:W^Prayer_Value_Start^/y10;

!!SS55:E3/?y10;
!!SN:W^Hero%X16_Slayer_Upgrade^/0;
!!SN:W^Slayer_Value_Start^/y10;

!!SS49:E3/?y10;
!!SN:W^Hero%X16_Mirth_Upgrade^/0;
!!SN:W^Mirth_Value_Start^/y10;

!!SS50:E3/?y10;
!!SN:W^Hero%X16_Sorrow_Upgrade^/0;
!!SN:W^Sorrow_Value_Start^/y10;

!!SS51:E3/?y10;
!!SN:W^Hero%X16_Fortune_Upgrade^/0;
!!SN:W^Fortune_Value_Start^/y10;

!!SS52:E3/?y10;
!!SN:W^Hero%X16_Misfortune_Upgrade^/0;
!!SN:W^Misfortune_Value_Start^/y10;

!!SS56:E3/?y10;
!!SN:W^Hero%X16_Frenzy_Upgrade^/0;
!!SN:W^Frenzy_Value_Start^/y10;

!!SS37:E3/?y10;
!!SN:W^Hero%X16_Cure_Upgrade^/0;
!!SN:W^Cure_Value_Start^/y10;

!!SS11:E3/?y10;
!!SN:W^Hero%X16_Land Mine_Upgrade^/0;
!!SN:W^Land Mine_Value_Start^/y10;

!!SS13:E3/?y10;
!!SN:W^Hero%X16_Fire Wall_Upgrade^/0;
!!SN:W^Fire Wall_Value_Start^/y10;


****************************************************************************************************
Various Tweaks

*Code to Unlock the Secret Commander Class
!?FU(OnAfterBattleUniversal)&1000;
!!BA:H0/?y1;
!!SN:W^Commander_Kill_Counter_%Y1^/?y10;[Increase counter by one if kill happened]
!!FU(Unlock_Secret_Stuff_0)&y10>=125:P0;[If Kill count is bigger 125 class gets unlocked]

!!BA:H1/?y1; !!FU&y1<0:E;               [Exit if no Hero]
!!SN:W^Commander_Kill_Counter_%Y1^/?y10;[Increase counter by one if kill happened]
!!FU(Unlock_Secret_Stuff_0)&y10>=125:P0;[If Kill count is bigger 125 class gets unlocked]

!?FU(OnGameEnter);
!!FU(Unlock_Secret_Stuff_0):P1;
!!FU(Unlock_Secret_Stuff_1):P1;


!?FU(Unlock_Secret_Stuff_0);
x1=1 Means "OngameEnter"
x1=0 Means after any battle

!!VRz-1:S^^;                            [empty var]
!!SN:W^Fire_Mage_Unlocked^/?y1; !!FU&y1=1:E; [Exit if class is already unlocked]
!!VRz-2:S^Fire Mage^;                   [User-defined section of WoG.ini file ("Fire Mage")]
!!UN:N6/-1/1/-2;                        [Check if Fire Mage Message has already been displayed]
!!VRz-1:H2;                             [Set Flag 2 to False  if z-1 is empty: Flag 2]
!!SN&2/x1=1:W^Fire_Mage_Unlocked^/1;    [Set variable to true]
!!FU&2/x1=1:E;                          [If Message is there and we enter the game Exit]

!!if&-2/x1=0;                           [If it is not there and we are after a battle]
  !!SN:T^AC_Misc.Fire_Mage_Unlocked^/?s^Text^;
  !!VRz-9:S^ULTIMATEARTIFACT.wav^;
  !!SN:Pz-9;                            [play quest sound when unlocking]
  !!IF:Q1/21/134/1^%S(Text)^;           [Show Message when class was unlocked, but not when entering the game]
  !!SN:W^Fire_Mage_Unlocked^/1;
  !!VRz-1:S^Unlocked^;                  ["message shown"]
  !!UN:N5/-1/1/-2;                      [Write data to WoG.ini to show that Ctrl Message has already been displayed]
!!en;


!?FU(Unlock_Secret_Stuff_1);
x1=1 Means "OngameEnter"
x1=0 Means after any battle

!!VRz-1:S^^;                            [empty var]
!!SN:W^Ancient_Unlocked^/?y1; !!FU&y1=1:E; [Exit if class is already unlocked]
!!VRz-2:S^Ancient^;                     [User-defined section of WoG.ini file ("Fire Mage")]
!!UN:N6/-1/1/-2;                        [Check if Fire Mage Message has already been displayed]
!!VRz-1:H2;                             [Set Flag 2 to False  if z-1 is empty: Flag 2]
!!SN&2/x1=1:W^Ancient_Unlocked^/1;      [Set variable to true]
!!FU&2/x1=1:E;                          [If Message is there and we enter the game Exit]

!!if&-2/x1=0;                           [If it is not there and we are after a battle]
  !!SN:T^AC_Misc.Ancient_Com_Unlocked^/?s^Text^;
  !!VRz-9:S^ULTIMATEARTIFACT.wav^;
  !!SN:Pz-9;                            [play quest sound when unlocking]
  !!IF:Q1/21/134/1^%S(Text)^;           [Show Message when class was unlocked, but not when entering the game]
  !!SN:W^Ancient_Unlocked^/1;
  !!VRz-1:S^Unlocked^;                  ["message shown"]
  !!UN:N5/-1/1/-2;                      [Write data to WoG.ini to show that Ctrl Message has already been displayed]
!!en;


*DL trigger to unlock the secret commander class
!?DL&v998=274/v1000=13;                 [LMB on the options icons to activate class]
@Archer -> you are not allowed to spoil this :P 

!!if&v999>=40/v999<=48;
  
  !!SN:W^Riddle_Click_Counter^/d1;      [times clicked in the DL]
  !!SN:W^The_Riddle_Sum^/dv999;         [set sum of clicked IDs]
  !!SN:W^The_Riddle_Sum^/?y1;           [set sum of clicked IDs]
  !!SN:W^Riddle_Click_Counter^/?y2;     [get click counter]
  !!SN:W^Riddle_Click_%Y2^/?y3;

  !!if&y1=y3/y2>3;                      [if correct pattern is followed]
    !!VRz1:S^Quest.wav^;
    !!SN:Pz1;                           [Play Sound]
    !!FU(Unlock_Secret_Stuff_1)&y2=9/y3=396:P0; [fct to unlock commander class]
  !!en;
  !!if&y1<>y3;                          [if wrong pattern is clicked cancel]
    !!SN:W^The_Riddle_Sum^/0;
    !!SN:W^Riddle_Click_Counter^/0;
    !!VRz1:S^Error.wav^;                [play error sound]
    !!SN&y2>4:Pz1;                      [Play Sound]
  !!en;   
!!el;

!!SN:W^The_Riddle_Sum^/0;               [reset sum]
!!SN:W^Riddle_Click_Counter^/0;         [reset counter]


*?CM1;                                  [town screen click]
*!CM:I?y1;
*!FU&y1>5:E;                            [if tavern click]
*!if&y1=5;
*!IF:M^{Bartender}

"Hey you! I recently heard a rumor about the {~orange}Secret Commander class{~}." 
"Would you be interested to hear it?"^;
*!en;


*Obelisk Trigger to show Riddle text
!?OB57&1000;
!!SN:W^Ancient_Unlocked^/?y1;
!!FU&y1=1:E;                            [Show no more riddle when the class has been unlocked]
!!VRy1:S0R1; !!FU&y1=0:E;               [50% chance to work]
!!MT998:N?y4;                           [Get Obelisk number]
!!VRy4:+1;                              [add +1 for correct offset]
!!if&y4>=1/y4<=9;                       [if a valid number]
  !!SN:T^AC_Misc.The_Riddle_%Y4^/?z1;   [get text]
  !!IF:M^%Z1^;                          [show message]
!!en;

!#SN:W^Riddle_Click_Counter^/0; 
!#SN:W^Riddle_Click_1^/44;              [Supporter]
!#SN:W^Riddle_Click_2^/90;              [Scout]
!#SN:W^Riddle_Click_3^/132;             [Defender]
!#SN:W^Riddle_Click_4^/172;             [Fighter]
!#SN:W^Riddle_Click_5^/217;             [Leader]
!#SN:W^Riddle_Click_6^/260;             [Caster]
!#SN:W^Riddle_Click_7^/301;             [Ranger]
!#SN:W^Riddle_Click_8^/348;             [Vampire]
!#SN:W^Riddle_Click_9^/396;             [Fire Mage]
Click Order is: 5,7,3,1,6,4,2,8,9 ###DO NOT SPOIL THIS###
 

// Change graphics of Meteor Shower and Implosion when at Master and GM level

; Archer30's new implementation
!?FU(OnBeforeBattleAction)&i^battle_isVisible^;
; Exit if not hero casting
!!BG:A?(action:y);
!!FU&(action)<>(BATTLE_ACTION_HERO_CAST):E;

; Exit if not the ideal spells
!!BG:S?(spell:y);
!!FU&(spell)<>(SPELL_METEOR_SHOWER)/(spell)<>(SPELL_IMPLOSION):E;

; Exit if the casting hero doesn't learn Master Earth Magic
!!BG:H?(hero:y);
!!FU&i^H3_Earth Magic_0_Hero%(hero)^=0:E;

; Set up new spell animation
!!UN:C(COMBAT_MANAGER)/(UNC_INT)/?(cmbMgr:y);
!!UN:C(cmbMgr)/78572/(UNC_INT)/-1;

!!if&(spell)=(SPELL_METEOR_SHOWER);
  !!SN:B6837004/d/^Meteor.def^;
!!el&(spell)=(SPELL_IMPLOSION);
  !!SN:B6837156/d/^Implosion.def^;
!!en;

!!VRi^acm_spellAnimationReplaced^:S(TRUE);

; Restore the spell animations if any was changed
!?FU(OnBattleActionEnd)&i^acm_spellAnimationReplaced^;
!!SN:B6837004/d/^C08SPE0.def^;
!!SN:B6837156/d/^C05SPE0.def^;

!!UN:C(COMBAT_MANAGER)/(UNC_INT)/?(cmbMgr:y);
!!UN:C(cmbMgr)/78572/(UNC_INT)/-1;

; Old implementation - replaced by Archer's script as they did not solve the problem of ligering animation problem.
; With this implemtatnion, in a 2-hero battle, there is no way to show different animation for the 2 players if one has Master level of earth magic and one has not. 
!?BG0&1000;
Change graphics of Meteor Shower and Implosion when at Master and GM level
!!FU:E;

!!BG:A?v1 S?v2;
!!FU|v1<>1/v2<>23:E;                    [exit if not Hero cast or spell not FB]

!!BG:H?y10;
!!SN:W^H3_Earth Magic_0_Hero%Y10^/?y20; [Checke ob der Held Grandmaster Nobility hat und Speichere in y12]
!!FU&y20=0:E;

!!SN:L^Era.dll^/?y1;                    [y1=handle]
!!SN:Ay1/^RedirectFile^/?y2;            [y2=FU address]
!!SN:Ey2/1/^C08SPE0.def^/^Meteor.def^;  [switch Lightning DEF to asdFireball C20SPX.DEF C13SPF.DEF]

!?BG1&1000;
!!FU:E;

!!SN:L^Era.dll^/?y1;                    [y1=handle]
!!SN:Ay1/^RedirectFile^/?y2;            [y2=FU address]
!!SN:Ey2/1/^C08SPE0.def^/^^;            [restore Fireball DEF]


!?BG0&1000;
Change graphics of Meteor Shower and Implosion when at Master and GM level
!!FU:E;

!!BG:A?v1 S?v2;
!!FU|v1<>1/v2<>18:E;                    [exit if not Hero cast or spell not CL]

!!BG:H?y10;
!!SN:W^H3_Earth Magic_0_Hero%Y10^/?y20; [Checke ob der Held Grandmaster Nobility hat und Speichere in y12]
!!FU&y20=0:E;

!!SN:L^Era.dll^/?y1;                    [y1=handle]
!!SN:Ay1/^RedirectFile^/?y2;            [y2=FU address]
*!SN:Ey2/1/^C06SPF0.def^/^C07SPE0.def^; switch  Armageddon to Mass Fear
*!SN:Ey2/1/^C06SPF0.def^/^C08SPE0.def^; switch  Armageddon to Meteor Shower
!!SN:Ey2/1/^C05SPE0.def^/^Implosion.def^;[switch  Old Implosion to new Animation]

!?BG1&1000;
!!FU:E;

!!SN:L^Era.dll^/?y1;                    [y1=handle]
!!SN:Ay1/^RedirectFile^/?y2;            [y2=FU address]
!!SN:Ey2/1/^C05SPE0.def^/^^;


*?CM4;                                  [Disable the renewal spell book cast bypass]
*Now you cannot mulitcast by clicking on your hero in battle, you need to perform min one action
*!CM:I?v1 D?v2;
*!CM&v1=0/v2=252:R;

!?FU(OnCombatRound)&v997=0;
*Bad fix: prevent Soul Eater from casting in all quick Battles to prevent crash
!!SN:W^Typhon_Third_Upgrade_Mod_Active^/?y1; !!FU&y1=0:E; [Check for Third Upgrade Mod]
!!BA:Q?y1;                              [check for quick battle]
!!FU&y1=0:E;                            [Exit if normal battle]
!!re i/0/41;                            [loop all stacks]
  !!BMi:T?y3;                           [Get creature type]
  !!if|y3=178/y3=187/y3=182/y3=191;     [Check for commander ID]
  !!BMi:E0;                             [Set casts to zero if commander]
  !!en;
!!en;


!?FU(OnAfterBattleUniversal);
*Fights and Hero kill counter*
!!BA:H0/?y1 H1/?y10;                    [Attacker Hero Number]
!!FU&y1<0:E;                            [Exit if no attacking hero]
!!HEy1:O?y2;                            [get owner of this hero]
!!HEy10&y10>=0:O?y20;                   [get owner of defending hero]
!!SN:W^Hero_Attacker_Owner0^/?y3;       [Check Owner Before Fight]
!!FU&y2<>y3:E;                          [Prevent to give Bonus if retreat]
!!FU&y2=-1:E;                           [Exit if no owner]
!!SN:W^Hero_%Y1_Fights_Won^/d1;         [Increase counter by 1]
!!SN&y10>=0:W^Hero_%Y1_Heroes_Killed^/d1;[Increase counter by 1]


!?FU(OnBeforeBattleUniversal); 
*Disable Tactics if option was selected. Changed Trigger because old is no longer working.                       
!!BA:H0/?y1;                            [Attacker]
!!HEy1:S19/?y3;                         [Checke ob der Held Tactics hat und Speichere in y10]
!!SN:W^Tactics_enabled^/?y99;
!!HEy1&y3>0/y99=0:R4/0;                 [remove attackers tactics]

!!BA:H1/?y1; !!FU&y1<0:E;               [Defender]
!!HEy1:S19/?y3;                         [Checke ob der Held Tactics hat und Speichere in y10]
!!SN:W^Tactics_enabled^/?y99;
!!HEy1&y3>0/y99=0:R4/0;                 [remove Defenders tactics]


********************************************************************************
When clicking on Kingdom Overview Icon at Adventure Map
This needs to be done to prevent an unkown crash with Kingdom Overview
Hint: If you remove UN44.def and UN32.def from ACM pack file the crash can be avoided

!?FU(OnAdventureMapRightMouseClick);
!!CM:F?v3 I?v4 S?v5;                    [where we click and click subtype]
!!if&v3=512/v4=3;                       [if right click and kingdom overview icon are clicked]
  *!CM:R0;                              [Disable]
  !!OW:C?y1;
  !!re i/0/6;                           [loop all player res]
    !!VRy2:S10+i; !!VRy3:S20+i;
    !!OW:Ry1/i/?yy2;                    [get players res]
    !!SN&i^timerWeekDay^=1:W^Day_7_Player_%Y1_Res_%i^/?yy3; [save them Monday]
    !!SN&i^timerWeekDay^=2:W^Day_1_Player_%Y1_Res_%i^/?yy3; [save them]
    !!SN&i^timerWeekDay^=3:W^Day_2_Player_%Y1_Res_%i^/?yy3; [save them]
    !!SN&i^timerWeekDay^=4:W^Day_3_Player_%Y1_Res_%i^/?yy3; [save them]
    !!SN&i^timerWeekDay^=5:W^Day_4_Player_%Y1_Res_%i^/?yy3; [save them]
    !!SN&i^timerWeekDay^=6:W^Day_5_Player_%Y1_Res_%i^/?yy3; [save them]
    !!SN&i^timerWeekDay^=7:W^Day_6_Player_%Y1_Res_%i^/?yy3; [save them Sunday]
  !!en;
  !!VRy40:Sy10-y20; !!VRy41:Sy11-y21; !!VRy42:Sy12-y22; !!VRy43:Sy13-y23; !!VRy44:Sy14-y24; !!VRy45:Sy15-y25; !!VRy46:Sy16-y26;
  !!SN:T^AC_Misc.No_Kingdom_Overview^/?z1; !!SN:Iz1/?z1; [Interpolate String]
  !!IF:M0/4/^%Z1^;                      [show Text]
  !!CM:R0;
!!en;

!?FU(WOG_EndOfTurn);                    [On end of every day for every player]
!!OW:C?y1 I-1/?y3;                      [Get current player and if AI]
!!VRy30:Si^timerWeekDay^;
!!re i/0/7;                             [loop all player res]
!!OW:Ry1/i/?y2;                         [get players res]
  !!SN:W^Day_%Y30_Player_%Y1_Res_%i^/y2;[save them Monday]
!!en;


****************************************************************************************************
*Mobile Market of Time*
Allows a hero to forget a secondary skill. Can be used once or twice for each hero.
This should help to better roll your desired class.
The Market can be accessed by right cklicking the market in the citiy or the GEM town buttons.

!?FU(OnTownMouseClick)&i^mouse_action^=(MOUSE_RMB_PRESSED)/i^dlg_action^=(DLG_CMD_TYPE_DEFAULT)/i^mouse_flags^=(MOUSE_FLAG_RMB)/i^mouse_item^=14;[if right click on marketplace]
!!CA-1:H1/?(garrisonHeroId:y);                        [y5, town Visitor]
!!if&(garrisonHeroId)<>(NO_HERO);
  !!FU(Mobile_Time_Market):P(garrisonHeroId)/?(skillWasChosen:y);
  !!SN:W^ACM_Skill_Match_Found^/-1;
  !!SN:W^WM_Upgrade_Hero^/(garrisonHeroId);
  !!SN:W^ACM_MobileMarket_Finished^/0;
  !!UN:P(WOG_OPT_DISABLE_TOWN_DEMOLISHING)/?(noDemolishTown:y);

  !!if|(noDemolishTown)=(FALSE)/(skillWasChosen:y);
    !!CM:R0;
  !!en;
!!en;



!?FU(gem_OnOpenButtonDlg);              [Function from GEM Mod that is called when clicking the new buttons]
  !!CA-1:H1/?y5;                        [y5, town Visitor]
  !!FU|y5<0/y5>155:E;                   [Exit if no hero]
  !!SN:T^AC_Misc.Time_Market_GEM_button^/?z20; [z20]
  !!SN:T^AC_Misc.Time_Market_GEM_button_desc^/?z21; [z21]
  !!FU(gem_AddTownButton):P^avxmktt0.def^/64/64/^%Z20^/^%Z21^/^%Z21^/(Mobile_Time_Market)/y5/3/0; [Mobile Market of Time button]
  !!SN:W^ACM_Skill_Match_Found^/-1;
  !!SN:W^WM_Upgrade_Hero^/y5;
  !!SN:W^ACM_MobileMarket_Finished^/0;


!?FU(Mobile_Time_Market);
  !#VA(heroId:x) (skillWasChosen:x);
  !!VRz1:S^Warlock Bank 01.wav^;
  !!SN:Pz1;

  !!DL233:N^ss_popup.txt^;              [Name of Dialogue text file]
  !!VRi^ACM_Skill_Match_Found^:S-1;

  !!FU(acm_Dlg_TimeMarket_Clear):P233;
  !!DL233:A2/3/^%T(AC_Misc.Time_Market_Welcome)^/1; [Name of Class]
  !!DL233:A3/3/^%T(AC_Misc.Time_Market_Button3)^/1; [Accept button]
  !!DL233:A4/3/^%T(AC_Misc.Time_Market_Button4)^/1; [Cancel button]

  !!DL233:S;
  !!VR(skillWasChosen):Si^acm_timeMarket_hasChosenSkill^;
  !!VRi^acm_timeMarket_hasChosenSkill^:S(NULL);
  !!SN:D;                               [Refresh resources bar (after dialog closed)]

!?FU(acm_Dlg_TimeMarket_Clear);
  !#VA(dlgId:x);
  !!FU(DL_FindById):P(dlgId)/?(dlg:y);
  !!UN:C(dlg)/(UNC_INT)/?(dlg);
  !!re (defId:y)/10/19;
    !!VR(textId:y):S(defId)+10;
    !!FU(acm_DlgShowItem):P(defId)/(FALSE)/(FALSE)/(FALSE)/(dlg);
    !!FU(acm_DlgShowItem):P(textId)/(FALSE)/(FALSE)/(FALSE)/(dlg);
    !!VRi^acm_MarketSkill_%(defId)^:S-1;
  !!en;
  !!FU(acm_DlgShowItem):P5/(FALSE)/(FALSE)/(FALSE)/(dlg);
  !!FU(acm_DlgShowItem):P6/(FALSE)/(FALSE)/(FALSE)/(dlg);

!?FU(acm_Dlg_TimeMarket_AdjustSkills);
  !#VA(dlgId:x) (dlg:x);

  !!VR(random:y):R0/1/2;
  !!SN:T^AC_Misc.Time_Market_Input%(random)^/?(msg:z);
  !!DL(dlgId):A2/(DLG_CMD_SET_TEXT)/^%(msg)^/1;
  !!VR(defId:y):S10;
  !!VR(textId:y):S20;
  !!re i/0/(SEC_SKILL_LAST);
    !!HEi^WM_Upgrade_Hero^:Si/?(isSkill:y);
    !!if&(isSkill);
      !!FU(acm_DlgShowItem):P(defId)/(TRUE)/(TRUE)/(FALSE)/(dlg);
      !!FU(acm_DlgShowItem):P(textId)/(TRUE)/(TRUE)/(FALSE)/(dlg);

      !!FU(acm_DlgItemPosition):P(defId)/?(x:y)/?(y:y)/(dlg);
      !!FU(acm_DlgItemSize):P(defId)/?(width:y)/?(height:y)/(dlg);
      !!VR(x):+(width) +5;
      !!FU(acm_DlgItemPosition):P(textId)/(x)/(y)/(dlg);

      !!SN:H^secskill^/i/0/?(skillName:z);
      !!VRi^acm_MarketSkill_%(defId)^:Si;
      !!DL(dlgId):A(defId)/(DLG_CMD_SET_DEF_FRAME)/i/1 A(textId)/(DLG_CMD_SET_TEXT)/(skillName)/1;
      !!if&(defId)<19;
        !!VR(defId):+1;
        !!VR(textId):+1;
      !!el;
        !!br;
      !!en;

    !!en;
  !!en;

!?FU(OnCustomDialogEvent)&x1=233/i^mouse_item^>=10/i^mouse_item^<=29/i^mouse_action^=(MOUSE_LMB_PRESSED);
  !!VR(itemId:y):Si^mouse_item^;
  !!if&(itemId)>=20;
    !!VR(itemId):-10;
  !!en;
  !!VRi^ACM_Skill_Match_Found^:Si^acm_MarketSkill_%(itemId)^;
  !!VRi^ACM_Hit_Counter^:S1;
  !!FU(H3Dlg_GetCurrentDlg):P?(dlg:y);
  !!FU(acm_DlgItemPosition):P(itemId)/?(x:y)/?(y:y)/(dlg);
  !!FU(acm_DlgShowItem):P5/(TRUE)/(TRUE)/(FALSE)/(dlg) P6/(TRUE)/(TRUE)/(FALSE)/(dlg);
  !!VR(x):-5;
  !!VR(y):-2;
  !!FU(acm_DlgItemPosition):P5/(x)/(y)/(dlg);
  !!FU(acm_DlgItemSize):P5/?(width:y)/?(height:y)/(dlg);
  !!VR(x):+(width);
  !!FU(acm_DlgItemPosition):P6/(x)/(y)/(dlg);
  !!DLx1:E30722/1;

!?DL&v998=233/v999>=5/v999<=6/v1000=13/i^ACM_Skill_Match_Found^>=0; [Confirm left click]
    !!FU(acm_Dlg_TimeMarket_Clear):P233;
    !!FU(ACM_Time_Market_Forget_Skill):Pi^WM_Upgrade_Hero^/i^ACM_Hit_Counter^;

!?DL&v998=233/v999=30722/v1000=13;      [Confirm left click]
  !!if&i^ACM_Skill_Match_Found^=-1;
    !!DLv998:Ev999/0;
    !!FU(H3Dlg_GetCurrentDlg):P?(dlg:y);
    !!FU(acm_Dlg_TimeMarket_AdjustSkills):P233/(dlg);
  !!el;
    !!FU(acm_Dlg_TimeMarket_Clear)&i^ACM_Hit_Counter^=1:P233;
    !!if&i^ACM_MobileMarket_Finished^<>2;
      !!FU(ACM_Time_Market_Forget_Skill):Pi^WM_Upgrade_Hero^/i^ACM_Hit_Counter^;
      !!VRi^acm_timeMarket_hasChosenSkill^:S(TRUE); [global var to deal with demolishing town behaviour later]
    !!el;
      !!DL233:C1;
    !!en;
  !!en;

!?FU(ACM_Time_Market_Forget_Skill);
  !#VA(heroId:x) (hits:x);
  !!SN:W^ACM_Skill_Match_Found^/?y10; !!FU&y10<0:E;
  !!SN:W^ACM_Hit_Counter^/?y40;
  !!HEx1:Sy10/?y6;                      [Get level of that skill]
  !!SN:H^secskill^/y10/0/?z10;          [Get name of Sec Skill]
  !!if&y6>0;
    !!FU(H3_Mod_Check_Skill_Level):Px1/?y2/?y3/y10; [get M/GM level of secondary skill]
    !!VRz15:S^^;                        [Set z-var blank]
    !!SN&y6=1:T^AC_Misc.Basic^/?z15;    [set skill level name acordingly]
    !!SN&y6=2:T^AC_Misc.Advanced^/?z15; [...]
    !!SN&y6=3:T^AC_Misc.Expert^/?z15;   [...]
    !!SN&y6=3/y2=1/y3=0:T^AC_Misc.Master^/?z15; [...]
    !!SN&y6=3/y2=1/y3=1:T^AC_Misc.Grandmaster^/?z15; [...]

    !!OW:R-1/6/?y60;                    [give the resources]
    !!if&y40>1/y60>=1000;
      !!OW:R-1/6/d-1000;                [give the resources]      
    !!en;

    !!SN:W^ACM_Hit_Counter^/?y30;       [check hit counter]
    !!VRy30:-1;                         [reduce by 1 default]
    !!VRy30&y60<1000:-1;                [if player has not enough gold reduce hit counter]
    !!VRy31:Sy30*1000;                  [calc total gold]
    !!VRy30&y30<0:S0;                   [show zero if needed]
    !!VRy31&y31<0:S0;

    !!SN&y60>=1000:T^AC_Misc.Time_Market_Main2^/?z20/^skill^/z10/^level^/z15/^hits^/y30/^amount^/y31;
    !!SN&y60<1000:T^AC_Misc.Time_Market_No_Gold^/?z20/^skill^/z10/^level^/z15/^hits^/y30/^amount^/y31;
    !!SN:T^AC_Misc.Time_Market_Button3^/?z21;
    !!SN:T^AC_Misc.Time_Market_Button4^/?z22;

    !!DL233:A2/3/z20/1;                 [Main Text]
    !!DL233:A3/3/z21/1;                 [Accept button]
    !!DL233:A4/3/z22/1;                 [Cancel button]

    !!FU&y60<1000:E;                    [Exit if player has not enough money]
    !!FU(GetArtAtSlot):Px1/0/?y45;      [Check if hero wears a helmet]

    !!if&y40>1;
      !!VRy4:S0R2;
      !!VRz2&y4=0:S^wood weapon vs leather01l.wav^; [load sound file]
      !!VRz2&y4=1:S^wood weapon vs leather02m.wav^;
      !!VRz2&y4=2:S^wood weapon vs leather03h.wav^;
      !!if&y45>0;
        !!VRz2&y4=0:S^wood vs metal01l.wav^; [load sound file in case hero wears a helmet]
        !!VRz2&y4=1:S^wood vs metal02m.wav^;
        !!VRz2&y4=2:S^wood vs metal03h.wav^;
      !!en;
      !!SN:Pz2;
      !!VRz2:S^LM115e.wav^;             [good by sound]
      !!SN:Pz2;

      !!if&y4=2;                        [33% chance for hit to succeed]
        !!FU(H3_Mod_Set_Skill_ExtraLevel)&y2=1/y3=1/y6=3:Px1/1/0/y10; [Decrease GM Level]
        !!FU(H3_Mod_Set_Skill_ExtraLevel)&y2=1/y3=0/y6=3:Px1/0/0/y10; [Decrease M Level]
        !!if&y2=0/y3=0;                 [If no M and GM]
          !!VRy6&y6>0:Sy6-1;
          !!HEx1:Sy10/y6;               [reduce secondary skill level by 1]
          !!SN&y6=0:W^ACM_MobileMarket_Finished^/1; [if skill is forgotten set flag to finsihed]
        !!en;      
      !!en;
    !!en;
    !!SN:W^ACM_Hit_Counter^/d1;         [add + 1 to hit counter when key was pressed]
  !!el;

    !!SN:W^ACM_MobileMarket_Finished^/?y1;
    !!if&y1=1;                          [load new text in text field when skill is forgotten or nor enough gold]
      !!SN:W^ACM_Hit_Counter^/?y80;
      !!SN&y80>=0:T^AC_Misc.Time_Market_perform1^/?z11; !!SN&y80>3:T^AC_Misc.Time_Market_perform2^/?z11; 
      !!SN&y80>7:T^AC_Misc.Time_Market_perform3^/?z11; !!SN&y80>15:T^AC_Misc.Time_Market_perform4^/?z11;
      
      !!SN:T^AC_Misc.Time_Market_Main3^/?z20/^skill^/z10/^perform^/z11;
      !!SN:T^AC_Misc.Time_Market_Button5^/?z21;
      !!SN:T^AC_Misc.Time_Market_Button6^/?z22;

      !!DL233:A2/3/z20/1;               [Main Text]
      !!DL233:A3/3/z21/1;               [Accept button]
      !!DL233:A4/3/z22/1;               [Cancel button]
      !!VRz2:S^Quest.wav^;
      !!SN:Pz2;                         [play sound]
      !!SN:W^ACM_MobileMarket_Finished^/2; [set flag]
    !!en;
  !!en;
!?DL&v998=233/v999=30721/v1000=13;      [Save Confirm]
  !!SN:W^ACM_Hit_Counter^/0;
  !!VRz1:S^Wi_WS_04.wav^;
  !!SN:Pz1;  
  !!VRz1:S^WoodDRClose.wav^;
  !!SN:Pz1;
  !!DL:C1;


****************************************************************************************************
*Code to set Master and Grandmaster icons in Hero screen*

Set hooks at Map Start/Load
!?FU(OnStartOrLoad);
  !!SN:L^EraPlugins\erm_hooker.era^/?y1;
  !!if&y1<>0;
    !!SN:Ay1/^SetHook^/?y2 Ey2/1/5120844/(acm_OnUpdateHeroBackPackScreen); [Set Hook provided by Daemon :*]
    !!SN:Ey2/1/5213968/(acm_BeforeOnHeroLvlUp); [Set Hook provided by Daemon :*]
    !!SN:Ey2/1/5217657/(acm_OnHeroLvlUp);[Set Hook provided by Daemon :*]
    !!SN:Ey2/1/5218358/(acm_OnHeroLvlUp_RMC_SS); [Set Hook provided by Daemon :*]
    !!SN:Ey2/1/5968384/(acm_OnSwapHeroDlgUpdate); [Set Hook provided by Daemon :*]

  **KingdomOverview update dlg - first hook get hero, skill and fram, 2nd hook - set frame
    !!SN:Ey2/1/5365867/(acm_OnKingdomOverViewGetHeroSkill); [Set Hook provided by Daemon :*]
    !!SN:Ey2/1/5365884/(acm_OnKingdomOverView_SetSkillDEfFrame); [Set Hook provided by Daemon :*]

  **Mouse Over hooks - sets text for skill name and prepare sec skill def frame id;
    !!SN:Ey2/1/5094933/(acm_OnHeroScreen_HeroSpec_MouseOver); [Set Hook provided by Daemon :*]
    !!SN:Ey2/1/5095015/(acm_OnHeroScreen_SecSkill_MouseOver); [Set Hook provided by Daemon :*]

    !!SN:Ey2/1/5379483/(acm_OnKingdomOverView_SecSkill_MouseOver); [Set Hook provided by Daemon :*]
    !!SN:Ey2/1/5371153/(acm_OnKingdomOverView_SecSkill_MouseClick); [Set Hook provided by Daemon :*]

    !!SN:Ey2/1/4234696/(acm_OnKingdomOverView_Close); [Set Hook provided by Daemon :*]
    !!SN:Ey2/1/5967453/(acm_OnLeftHeroMeetingScreen_SecSkill_MouseOver); [Set Hook provided by Daemon :*]
    !!SN:Ey2/1/5967500/(acm_OnRightHeroMeetingScreen_SecSkill_MouseOver); [Set Hook provided by Daemon :*]

  **When MsgBox prepared we set own def frame
    !!SN:Ey2/1/5201399/(acm_OnMsgBox_SetSecSkillPicture); [Set Hook provided by Daemon :*]
    !!SN:Ey2/1/5181941/(acm_OnMsgBox_RmcProc); [Set Hook provided by Daemon :*]

  !!en;
!?FU(acm_OnHeroScreen_HeroSpec_MouseOver);
  !!HE(CURRENT_HERO):X?(specType:y)/?(specSkill:y) N?(heroId:y);


  !!if&(specType)=0/(specSkill)>=(SEC_SKILL_FIRST)/(specSkill)<=(SEC_SKILL_LAST); [Make sure the secondary skill is in range]
    !!HE(CURRENT_HERO):S(specSkill)/?(skillLvl:y);
    !!if&(skillLvl)=3;
      !!FU(acm_UNC_SetSecSkillLevel_Text):P(heroId)/(specSkill);
      !!FU:E;
    !!el&(skillLvl)=2;
      !!SN:W^acm_text_currentSkillLevel^/^%T(AC_Misc.Advanced)^ W^acm_text_currentSkillLevel^/-1;

    !!el&(skillLvl)=1;
      !!SN:W^acm_text_currentSkillLevel^/^%T(AC_Misc.Basic)^ W^acm_text_currentSkillLevel^/-2;
    !!el&(skillLvl)=0;
      !!SN:W^acm_text_currentSkillLevel^/^^ W^acm_text_currentSkillLevel^/-2;
    !!en;

  !!en;

!?FU(acm_OnLeftHeroMeetingScreen_SecSkill_MouseOver);
!!FU(acm_SwapHeroDlg_SetSkillHint):Px1/0;

!?FU(acm_OnRightHeroMeetingScreen_SecSkill_MouseOver);
!!FU(acm_SwapHeroDlg_SetSkillHint):Px1/1;

!?FU(acm_SwapHeroDlg_SetSkillHint);
!#VA(this:x) (side:x);
  !!UN:C(this)/(STRUCT_HOOK_CONTEXT_EBP)/4/?(ebp:y);
  !!UN:C(ebp)/8/4/?(itemId:y);
  !!VR(slotIndex:y):S(itemId)-200 %8 +1;
  !!HEi^swap_hero_%(side)^:S(slotIndex)/?(skill:y)/1;
  !!if&(skill)<>(NO_SKILL);
    !!FU(acm_UNC_SetSecSkillLevel_Text):Pi^swap_hero_%(side)^/(skill);
    !!DO(AC_Set_SS_Description)/(skill)/(skill)/1:Pi^swap_hero_%(side)^; [Set new Skill description]
    !!DO(AC_Set_SS_Names)/(skill)/(skill)/1:Pi^swap_hero_%(side)^; [Set new Skill name]
  !!el;
    !!SN:W^acm_text_currentSkillLevel^;
  !!en;

!?FU(acm_OnKingdomOverView_SecSkill_MouseClick);
  !!UN:Cx1/(STRUCT_HOOK_CONTEXT_ESI)/4/?(hero:y) Cx1/(STRUCT_HOOK_CONTEXT_EBP)/4/?(ebp:y) C(ebp)/8/4/?(clickSlot:y);
  !!FU(acm_KingdomOverviewGetHeroSkillLvl):P(hero)/(clickSlot);

!?FU(acm_OnKingdomOverView_SecSkill_MouseOver);
  !!UN:Cx1/(STRUCT_HOOK_CONTEXT_ESI)/4/?(hero:y);
  !!UN:Cx1/(STRUCT_HOOK_CONTEXT_EBX)/4/?(clickSlot:y);

  !!FU(acm_KingdomOverviewGetHeroSkillLvl):P(hero)/(clickSlot);

!?FU(acm_KingdomOverviewGetHeroSkillLvl);
!#VA(hero:x) (itemId:x);
  !!VR(skillSlot:y):S(itemId) -158 +1;

  !!UN:C(hero)/26/4/?(heroId:y);
  !!HE(heroId):S(skillSlot)/?(skill:y)/1;
  !!if&(skill)<>(NO_SKILL);
    !!FU(acm_UNC_SetSecSkillLevel_Text):P(heroId)/(skill);
    !!DO(AC_Set_SS_Description)/(skill)/(skill)/1:P(heroId); [Set new Skill description]
    !!DO(AC_Set_SS_Names)/(skill)/(skill)/1:P(heroId); [Set new Skill name]
  !!el;
    !!SN:W^acm_text_currentSkillLevel^;
  !!en;
!?FU(acm_OnKingdomOverView_Close);
!!FU(acm_UNC_ClearVariables):P;

!?FU(acm_OnHeroScreen_SecSkill_MouseOver);
  !!UN:C6916976/4/?(hero:y);
  !!UN:C(hero)/26/4/?(heroId:y);
  !!UN:Cx1/(STRUCT_HOOK_CONTEXT_ECX)/4/?(ecx:y);
  !!VR(skillSlot:y):S(ecx);
  !!HE(heroId):S(skillSlot)/?(skill:y)/1;

  !!if&(skill)<>(NO_SKILL);
    !!FU(acm_UNC_SetSecSkillLevel_Text):P(heroId)/(skill);
  !!el;
    !!SN:W^acm_text_currentSkillLevel^;
  !!en;

!?FU(acm_OnMsgBox_SetSecSkillPicture)&i^acm_text_currentSkillLevel^;

  !!UN:Cx1/(STRUCT_HOOK_CONTEXT_EBX)/4/?(ebx:y);                                                                       [edx = [ebx +0x4] or v7 = vDlg8ItemPo->PicSubType;]

  !!VR(ebx):+4;
  !!UN:C(ebx)/4/?(picNum:y);                                                                                           [picNum is PicSubType]
  !!VRi^acm_MsgBoxOldPicNum^:S(picNum:y);                                                                              [store pic id to evade crash at EMC click later]
  !!VR(skillId:y):S(picNum) -3 :3;                                                                                     [get skill id by pic id 0 IF:Q - case 20]
  !!if&i^acm_text_currentSkillLevel^>0;
    !!VR(picNum):S(skillId)*2 +i^acm_text_currentSkillLevel^ +86;                                                      [set new pic id by offset]

  !!el;
    !!VR(picNum):+i^acm_text_currentSkillLevel^;                                                                       [this is for hero spec]
  !!en;
  !!UN:C(ebx)/4/(picNum);                                                                                              [replace current pic id by own]

!?FU(acm_OnMsgBox_RmcProc)&i^acm_text_currentSkillLevel^;
  !!UN:Cx1/(STRUCT_HOOK_CONTEXT_ESI)/4/?(dlgMsgBox:y) C(dlgMsgBox)/60/4/i^acm_MsgBoxOldPicNum^;                        [restore pic to set proper hint at RMC]


!?FU(acm_OnKingdomOverViewGetHeroSkill);

  !!UN:Cx1/(STRUCT_HOOK_CONTEXT_ESI)/4/?(esi:y);                                                                       [esi here is skill id]
  !!UN:Cx1/(STRUCT_HOOK_CONTEXT_ECX)/4/?(ecx:y);                                                                       [ecx here is heroStructure]
  !!if&(ecx)/(esi);
    !!UN:C(ecx)/26/4/?(heroId:y);
    !!FU(H3_Mod_Check_Skill_Level):P(heroId)/?(masterLvl:y)/?(gmLvl:y)/(esi);
    !!HE(heroId):S(esi)/?(skillLvl:y);
    !!FU(ACM_Calc_Correct_Def_Cadre):P(esi)/(skillLvl)/(masterLvl)/(gmLvl)/?i^acm_KingdomOverview_SecSkill_DefFrame^/1;
  !!el;
    !!VRi^acm_KingdomOverview_SecSkill_DefFrame^:S(FALSE);
  !!en;

!?FU(acm_OnKingdomOverView_SetSkillDEfFrame)&i^acm_KingdomOverview_SecSkill_DefFrame^;
  !!UN:Cx1/(STRUCT_HOOK_CONTEXT_EDX)/4/i^acm_KingdomOverview_SecSkill_DefFrame^; [edx here is frame id]

!?FU(acm_BeforeOnHeroLvlUp);
  !!UN:Cx1/4/4/?(left:y);
  !!UN:Cx1/4/?(right:y);

  !!if&(left)>=0/(left)<=(SEC_SKILL_LAST);
    !!SN:W^ACM_Left_Skill_ID^/(left);
  !!en;  
  !!if&(right)>=0/(left)<=(SEC_SKILL_LAST);
    !!SN:W^ACM_Right_Skill_ID^/(right); 
  !!en;

!?FU(ACM_Calc_Correct_Def_Cadre); 
  x1=Skill ID, x2=Skill Level, x3=Master, x4=Grandmaster, x5=returns cadre, x6=Level_Up(0) or HeroScreen(1)
  !!if&x6=1;
    !!VRx5:Sx1*3+3+x2-1;                [Handle normal Basic until Expert skills. To get correct cadre from Def. Basic Pathfinding starts at 3. The first 3 cadres are empty.]
    !!VRx5&x3=1:Sx1*2+x4+87;            [Handle correct Master and GM cadres. X3=1 means at least Master skill]
  !!en;

*Level up dialogue whenever hero gains a level. Set correct text and def cadre.
!?FU(acm_OnHeroLvlUp);

  !!UN:Cx1/4/?y1;                       [Get dialouge ID]

  !!SN:W^ACM_Left_Skill_ID^/?y10;       [Left skill ID]
  !!if&y10>=0/y10<=27;                  [If valid secondary skill found]
  !!SN:H^secskill^/y10/0/?z10;          [Get name of Sec Skill]
    !!HE-1:N?y99; !!FU&y99<0/y99>=155:E;[Exit if no valid hero number]
    !!HEy99:Sy10/?y6;                   [Get level of that skill]
    !!HEy99:Sy10/?y8;                   [Get level of that skill]
    !!VRy6&y6<3:+1;                     [Increase skill level to show potential next level]
    !!SN:W^ACM_SSkill_%Y10^/?y7;        [get skill level before it was decreased]
    !!FU(H3_Mod_Check_Skill_Level):Py99/?y2/?y3/y10; [get M/GM level of secondary skill]
    !!VRz15:S^^;                        [Set z-var blank]
    !!SN&y6=1:T^AC_Misc.Basic^/?z15;    [set skill level name acordingly]
    !!SN&y6=2:T^AC_Misc.Advanced^/?z15; [...]
    !!SN&y6=3/y7=2:T^AC_Misc.Expert^/?z15; [...]
    !!SN&y6=3/y7=3/y8=2:T^AC_Misc.Master^/?z15; [...]
    !!SN&y6=3/y7=3/y8=2/y2=1:T^AC_Misc.Grandmaster^/?z15; [...]
    !!VRy3&y6=3/y7=3/y8=2/y2=1:S1;      [Set GM skill check to true to show correct cadre]
    !!VRy2&y6=3/y7=3/y8=2:S1;           [Set Master skill check to true to show correct cadre]
    !!FU(ACM_Calc_Correct_Def_Cadre):Py10/y6/y2/y3/?y20/1;
  !!en;

  !!SN:W^ACM_Right_Skill_ID^/?y11;      [Right Skill ID]
  !!if&y11>=0/y11<=27;                  [If valid secondary skill found]
  !!SN:H^secskill^/y11/0/?z11;          [Get name of Sec Skill]
    !!HE-1:N?y99; !!FU&y99<0/y99>=155:E;
    !!HEy99:Sy11/?y6;                   [Get level of that skill]
    !!HEy99:Sy11/?y8;                   [Get level of that skill]
    !!VRy6&y6<3:+1;                     [Increase skill level to show potential next level]
    !!SN:W^ACM_SSkill_%Y11^/?y7;        [get skill level before it was decreased]
    !!FU(H3_Mod_Check_Skill_Level):Py99/?y2/?y3/y11; [get M/GM level of secondary skill]
    !!VRz16:S^^;
    !!SN&y6=1:T^AC_Misc.Basic^/?z16;    [set skill level name acordingly]
    !!SN&y6=2:T^AC_Misc.Advanced^/?z16; [...]
    !!SN&y6=3/y7=2:T^AC_Misc.Expert^/?z16; [...]
    !!SN&y6=3/y7=3/y8=2:T^AC_Misc.Master^/?z16; [...]
    !!SN&y6=3/y7=3/y8=2/y2=1:T^AC_Misc.Grandmaster^/?z16; [...]
    !!VRy3&y6=3/y7=3/y8=2/y2=1:S1;      [Set GM skill check to true to show correct cadre]
    !!VRy2&y6=3/y7=3/y8=2:S1;           [Set Master skill check to true to show correct cadre]
    !!FU(ACM_Calc_Correct_Def_Cadre):Py11/y6/y2/y3/?y21/1;
  !!en;

  !!SN:T^AC_Misc.LvLUp_Text_Double^/?z20/^skill^/z11/^level^/z16/^skill2^/z10/^level2^/z15; [load text for left and right skill]
  !!SN&y10<0:T^AC_Misc.LvLUp_Text_Single^/?z20/^skill^/z11/^level^/z16; [load text for only one skill displayed]

  !!VRz10:S^%Z15
  %Z10^; Set text below left skill icon
  !!VRz11:S^%Z16
  %Z11^; Set text below right skill icon

  !!FU(H3Dlg_SendCmdToItem):Py1/2005/(DLG_CMD_SET_TEXT)/z20/(DLG_CMD_TYPE_DEFAULT); [Long skill text what hero can learn]
  !!FU(H3Dlg_SendCmdToItem)&y10>=0:Py1/2007/(DLG_CMD_SET_TEXT)/z10/(DLG_CMD_TYPE_DEFAULT); [Left side]
  !!FU(H3Dlg_SendCmdToItem):Py1/2008/(DLG_CMD_SET_TEXT)/z11/(DLG_CMD_TYPE_DEFAULT); [Right side]
  !!FU(H3Dlg_SendCmdToItem)&y10<0/y11>=0:Py1/2007/(DLG_CMD_SET_TEXT)/z11/(DLG_CMD_TYPE_DEFAULT); [Right side]
  !!FU(H3Dlg_SendCmdToItem)&y10>=0:Py1/2010/(DLG_CMD_SET_DEF_FRAME)/y20/(DLG_CMD_TYPE_DEFAULT); [Send cmd to set def cadre]
  !!FU(H3Dlg_SendCmdToItem):Py1/2011/(DLG_CMD_SET_DEF_FRAME)/y21/(DLG_CMD_TYPE_DEFAULT); [Send cmd to set def cadre]
  !!FU(H3Dlg_SendCmdToItem)&y10<0/y11>=0:Py1/2010/(DLG_CMD_SET_DEF_FRAME)/y21/(DLG_CMD_TYPE_DEFAULT); [Send cmd to set def cadre]

  !!SN:W^ACM_Left_Skill_ID^/-1;         [Reset variables]
  !!SN:W^ACM_Right_Skill_ID^/-1;

****************************************************************************************************
On open hero screen set correct def cadres and skill tags

!?FU(acm_OnUpdateHeroBackPackScreen);   [When opening hero screen]
  !!FU(SetCorrectText):P;

!?FU(SetCorrectText);
  !!UN:C6916808/4/?(heroDlgStructure:y);[hero dlg structure]
  
  !!HE-1:N?y7; !!FU|y7<0/y7>155:E;      [Exit if no valid Hero number]

  !!SN:F^PluginExists^/^10sskills^;     [Check for 10 SSkill Plugin]
  !!VRy99&v1=0:S8; !!VRy99&v1=1:S10;
 *Set correct skill level tag
  !!re i/1/y99;                         [cycle secondary skill slots 1-8]
    !!VRy11:S49+i;                      [iteration of z variable that holds name of skill level text]
    !!VRy10:S94+i;                      [iteration of y10 that holds name of skill level text]
    !!VRy10&i=9:S503;                   [Correct field ID for 9th Slot]
    !!VRy10&i=10:S506;                  [Correct field ID for 10th Slot]
    !!HEy7:Si/?y5/1;                    [Get what skill is displayed in slot 1 to 8]
    !!if&y5>=0/y5<=27;                  [If valid secondary skill found]
    !!HEy7:Sy5/?y6;                     [Get level of that skill]
    !!FU(H3_Mod_Check_Skill_Level):Py7/?y2/?y3/y5; [get M/GM level of secondary skill]
    !!SN&y6=1:T^AC_Misc.Basic^/?zy11;   [set skill level name acordingly]
    !!SN&y6=2:T^AC_Misc.Advanced^/?zy11;[...]
    !!SN&y6=3:T^AC_Misc.Expert^/?zy11;  [...]
    !!SN&y6=3/y2=1/y3=0:T^AC_Misc.Master^/?zy11; [...]
    !!SN&y6=3/y2=1/y3=1:T^AC_Misc.Grandmaster^/?zy11; [...]
    !!FU(H3Dlg_SendCmdToItem):P(heroDlgStructure)/y10/(DLG_CMD_SET_TEXT)/^%Zy11^/(DLG_CMD_TYPE_DEFAULT); [Send text to command ID]
    !!en;
  !!en;

 *Set correct skill cadre 
  !!re i/1/y99;                         [cycle secondary skill slots 1-8]
    !!VRy10:Si+78;                      [iteration of skill slot ID from 79-86]
    !!VRy10&i=9:S501;                   [Correct field ID for 9th Slot]
    !!VRy10&i=10:S504;                  [Correct field ID for 10th Slot]
    !!HEy7:Si/?y2/1;                    [get what skill is in first slot and get Hero name]
    !!if&y2>=0/y2<=27;                  [if valid hero number and valid secondary skill is in the slot]
      !!HEy7:Sy2/?y3;                   [get level of secondary skill and exit if it is not at least Expert Level]
      !!FU(H3_Mod_Check_Skill_Level):Py7/?y4/?y5/y2; [get M/GM level of secondary skill]
      !!FU(ACM_Calc_Correct_Def_Cadre):Py2/y3/y4/y5/?y11/1;
      !!FU(H3Dlg_SendCmdToItem):P(heroDlgStructure)/y10/(DLG_CMD_SET_DEF_FRAME)/y11/(DLG_CMD_TYPE_DEFAULT); [Send cmd to set def cadre]
    !!en;
  !!en;


****************************************************************************************************
!?FU(OnOpenHeroScreen);
  !!FU(acm_UNC_ClearVariables):P;
!?FU(OnPostHeroScreen);
  !!FU(acm_UNC_ClearVariables):P;

********************************************************************************
!?FU(acm_UNC_SetSecSkillLevel_Text);
!#VA(heroId:x) (skill:x) (skillLvlCheck:x);

  !!UN:C6976992/4/?(expLvlTextPtr:y);

  !!FU(H3_Mod_Check_Skill_Level):P(heroId)/?(masterLvl:y)/?(gmLvl:y)/(skill); [get M/GM level of secondary skill]

  !!if&(gmLvl);
    !!SN:B(expLvlTextPtr)/d/^%T(AC_Misc.Grandmaster)^ W^acm_text_currentSkillLevel^/^%T(AC_Misc.Grandmaster)^ W^acm_text_currentSkillLevel^/2;
    !!FU:E;
  !!en;

  !!if&(masterLvl);
    !!SN:B(expLvlTextPtr)/d/^%T(AC_Misc.Master)^ W^acm_text_currentSkillLevel^/^%T(AC_Misc.Master)^ W^acm_text_currentSkillLevel^/1;
    !!FU:E;
  !!en;

  !!SN:B(expLvlTextPtr)/d/^%T(AC_Misc.Expert)^ W^acm_text_currentSkillLevel^;
  

!?FU(acm_UNC_ClearVariables);
  !!UN:C6976992/4/?(expLvlTextPtr:y);
  !!SN:B(expLvlTextPtr)/d/^%T(AC_Misc.Expert)^ W^acm_text_currentSkillLevel^;

!?FU(WOG_OnBeforeHeroSwap)&1000;
  !!UN:C6962576/(UNC_INT32)/?(heroSwapStructure:y);

  !!UN:C(heroSwapStructure)/64/(UNC_INT32)/?(leftHeroStructure:y);
  !!UN:C(heroSwapStructure)/68/(UNC_INT32)/?(rightHeroStructure:y);

  !!UN:C(leftHeroStructure)/26/(UNC_INT32)/?i^swap_hero_0^;
  !!UN:C(rightHeroStructure)/26/(UNC_INT32)/?i^swap_hero_1^;
  !!VRi^acm_SwapActionOnce^:S(FALSE);


!?FU(OnHeroesMeetScreenMouseClick)&i^mouse_item^<>301/i^mouse_item^;
!!VRi^acm_SwapActionOnce^:S(FALSE);


!?FU(acm_OnSwapHeroDlgUpdate)&i^acm_SwapActionOnce^=(FALSE);
!!re i/0/1;
  !!FU(ACM_HeroMeetingScreen_SetCorrectDescription):Pi/i^swap_hero_%i^;
!!en;
!!VRi^acm_SwapActionOnce^:S(TRUE);


!?FU(OnAfterHeroInteraction);
!!VRi^acm_SwapActionOnce^:S(FALSE);
!!FU(acm_UNC_ClearVariables):P;

!?FU(ACM_HeroMeetingScreen_SetCorrectDescription);

!#VA(side:x) (heroId:x);
!#VA(usedY[5]:y);
  !!if&(side)=0;
    !!VR(startItemSkillId:y):S199;
  !!el;
    !!VR(startItemSkillId:y):S207;
  !!en;

    !!re i/1/8;                         [cycle secondary skill slots 1-8]
      !!VR(itemId:y):Si+(startItemSkillId); [iteration of skill slot ID from 200-207]
      !!HE(heroId):Si/?(skill:y)/1;     [get what skill is in first slot and get Hero name]
      !!if&(skill)>=0/(skill)<=27;      [if valid hero number and valid secondary skill is in the slot]
        !!HE(heroId):S(skill)/?(skillLvl:y); [get level of secondary skill and exit if it is not at least Expert Level]
        !!FU(H3_Mod_Check_Skill_Level):P(heroId)/?y4/?y5/(skill); [get M/GM level of secondary skill]
        !!FU(ACM_Calc_Correct_Def_Cadre):P(skill)/(skillLvl)/y4/y5/?(defId:y)/1;
        !!UN:C6962576/(UNC_INT32)/?(heroSwapStructure:y);
        !!UN:C(heroSwapStructure)/56/(UNC_INT32)/?(currentDlg:y);
        !!FU(H3Dlg_SendCmdToItem):P(currentDlg)/(itemId)/(DLG_CMD_SET_DEF_FRAME)/(defId)/(DLG_CMD_TYPE_DEFAULT); [Send cmd to set def cadre]
      !!en;
    !!en;


!?FU(OnHeroScreenMouseClick)&i^mouse_item^>=501/i^mouse_item^<=506;

  !!if&i^mouse_action^=(MOUSE_LMB_PRESSED);
    !!VR(msgType:y):S(MSG_TYPE_MES);
  !!el&i^mouse_action^=(MOUSE_RMB_PRESSED);
    !!VR(msgType:y):S(MSG_TYPE_POPUP);
  !!el;
    !!FU:E;
  !!en;

  !!if&i^mouse_item^<504;
    !!VR(skillSlot:y):S9;
  !!el;
    !!VR(skillSlot:y):S10;
  !!en;

  !!HE(CURRENT_HERO):S(skillSlot)/?(skill:y)/1 N?(heroId:y);
  
  !!if&(skill)<>(NO_SKILL);
    !!HE(heroId):S(skill)/?(skillLvl:y);

    !!if&(skillLvl)>2;
      !!CM:R0;
      !!FU(acm_UNC_SetSecSkillLevel_Text):P(heroId)/(skill);
      !!VR(picNum:y):S(skill) *3 +5;

      !!SN:H^secskill^/(skill)/3/?(skillExpDescr:z);
      !!IF:Q1/20/(picNum)/(msgType)^%(skillExpDescr)^;
    !!en;

  !!el;
    !!SN:W^acm_text_currentSkillLevel^;
  !!en;

!?FU(acm_DlgItemPosition);
!#VA(itemId:x) (xPos:x) (yPos:x) (dlgStruct:x);
  !!FU:A?(argNum:y);
  ; parameters of any dialog element
  ; text, pictures, buttons, etc.
  !!VR(savedV1:y):Sv1;
  !!SN:E6288816/2/(dlgStruct)/(itemId);

  !!VR(itemStructure:y):Sv1;            [getItemStruture] item = (_Dlg_*)->GetItem(id)]

  !!FU:S(@xPos)/?(xSyntax:y);

  !!VR(itemAction:y):S(itemStructure) +24;
    !!if&(xSyntax)=(ARG_SYNTAX_GET);
      !!UN:C(itemAction)/2/?(xPos);
    !!el&(xSyntax)=(ARG_SYNTAX_SET);
      !!UN:C(itemAction)/2/(xPos);
    !!el;
      !!UN:C(itemAction)/2/?(currX:y);
      !!VR(xPos):+(currX);
      !!UN:C(itemAction)/2/(xPos);
    !!en;

  !!FU:S(@yPos)/?(ySyntax:y);

  !!VR(itemAction:y):S(itemStructure) +26;
    !!if&(ySyntax)=(ARG_SYNTAX_GET);
      !!UN:C(itemAction)/2/?(yPos);
    !!el&(ySyntax)=(ARG_SYNTAX_SET);
      !!UN:C(itemAction)/2/(yPos);
    !!el;
      !!UN:C(itemAction)/2/?(currY:y);
      !!VR(yPos):+(currY);
      !!UN:C(itemAction)/2/(yPos);    
    !!en;
  !!VRv1:S(savedV1);

!?FU(acm_DlgItemSize);
!#VA(itemId:x) (width:x) (height:x) (dlgStruct:x);
  
  !!FU:A?(argc:y);
  !!if&(argc)>(@itemId);
    !!VR(savedV1:y):Sv1;

    !!if&(dlgStruct)=0;
      !!FU(H3Dlg_GetCurrentDlg):P?(dlgStruct);
    !!en;

    !!SN:E6288816/2/(dlgStruct)/(itemId);

    !!if&v1>0;
      !!VR(itemStructure:y):Sv1;        [getItemStruture] item = (_Dlg_*)->GetItem(id)]

      !!FU:S(@width)/?(widthSyntax:y) S(@height)/?(heightSyntax:y);

      !!VR(itemAction:y):S(itemStructure) +28;

      !!if&(widthSyntax)=(ARG_SYNTAX_GET);
        !!UN:C(itemAction)/2/?(width);
      !!el&(widthSyntax)=(ARG_SYNTAX_SET);
        !!UN:C(itemAction)/2/(width);
      !!el;
        !!UN:C(itemAction)/2/?(currWidth:y);
        !!VR(width):+(currWidth);

        !!if&(width)>0;
          !!UN:C(itemAction)/2/(width);
        !!el;
          !!UN:C(itemAction)/2/0;
        !!en;
      !!en;

      !!if&(argc)>(@width);
      
        !!VR(itemAction:y):S(itemStructure) +30;
        
        !!if&(heightSyntax)=(ARG_SYNTAX_GET);
          !!UN:C(itemAction)/2/?(height);
        !!el&(heightSyntax)=(ARG_SYNTAX_SET);
          !!UN:C(itemAction)/2/(height);
        !!el;
          !!UN:C(itemAction)/2/?(currHeight:y);
          !!VR(height):+(currHeight);
          !!UN:C(itemAction)/2/(height);

          !!if&(height)>0;
            !!UN:C(itemAction)/2/(height);
          !!el;
            !!UN:C(itemAction)/2/0;
          !!en;
        !!en;
      !!en;
    !!en;
    !!VRv1:S(savedV1);
  !!en;


!?FU(acm_DlgShowItem);
!#VA(itemId:x) (showItem:x) (clickableItem:x) (redraw:x) (currentDlgStruct:x);
  !!if&(itemId)<0;
    !!IF:M^itemId is incorrect!
    should be 0 and higher^;
    !!FU:E;
  !!en;

  !!VR(savedV1:y):Sv1;

  !!if&(currentDlgStruct)=0;
    !!FU(H3Dlg_GetCurrentDlg):P?(currentDlgStruct);
  !!en;

  !!SN:E6288816/2/(currentDlgStruct)/(itemId);

  !!if&v1>0;
    !!VR(itemStructure:y):Sv1; 

    !!if&(showItem);

      !!SN:E6286720/2/(itemStructure)/5/6;
    !!el;


      !!if&(clickableItem);
        !!SN:E6286720/2/(itemStructure)/6/4;
      !!el;
        !!SN:E6286720/2/(itemStructure)/6/6;
      !!en;
    !!en;

    !!if&(redraw);
      !!SN&(redraw)=1:E6288864/2/(currentDlgStruct)/1/-65535/65535; [update currentDlg;]
      !!SN&(redraw)=-1:E6288864/2/(currentDlgStruct)/1/(itemId)/(itemId); [update onlyItem;]
    !!en;
  !!en;

  !!VRv1:S(savedV1);


****************************************************************************************************


New Commanders Section


*remade the regeneration ability from commanders. Instead of just 50HP per turn it is now 50+5% of max health points.
!?FU(OnBattleRegeneratePhase);          [Commanders with regeneration ability regenerate 10% of HP each battle round]

!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]
!!SN:X?y1;                              [Event parameter]
!!BMy1:I?y2;                            [Acting Side Monster]
!!BA:Hy2/?y4;                           [Current Hero]
!!FU&y4<0:E;                            [Exit if none]
!!COy4:D?y30 X2/?y31; !!FU&y30=1:E;     [Get Commander Alive Dead status and level]
!!SN&y2=0:W^Att_Com_Regeneration_ability^/?y10; [check if the commander actually has regeneration ability]
!!SN&y2=1:W^Def_Com_Regeneration_ability^/?y10;
!!SN&y2=0:W^Att_Com_Regeneration_flag^/?y20; [check battle round flag so it only happens once and not twice in case of morale]
!!SN&y2=1:W^Def_Com_Regeneration_flag^/?y20;
!!BMy1:T?y3;                            [Get Creature Number]
!!FU(Commander_Regeneration)&y3>=174/y3<=191/y10=1/y20=0:Py1/y31/y4; [If any commander and had regeneration ability and has not happended this round already]


!?FU(Commander_Regeneration);

!!BMx1:H?y1 N?y2 L?y3 I?y4;             [Get Health]
!!FU&y3<=0:E;                           [Exit if no HP has been lost so far]
!!VRy10:Sy1;                            [set y10 to max HP]
!!VRy11:S5;                             [set to base value 5% reg]
!!VRy11&x3=4:Sx2:2+5;                   [Commander level divided by 5%+1 per 5 commander levels of playing with Lort Haart]
!!VRy10&x3=4:*y11:100+20;               [Exception for Lort Haart +20 fix HP]
!!VRy10&x3<>4:*y11:100+50;              [Make 5 percent of live +50 fix HP]
!!VRy3:-y10;                            [Substract heal amount from lost hit points]
!!VRy3&y3<=0:S0;                        [cannot be negative]
!!BMx1:Ly3;                             [Set new lost HP and show cure animation]
!!BA:Q?f;                               [get quick combat status]
!!if&i^battle_isVisible^/1000;          [do not run in quick battle]
  !!BMx1:V39;                           [Show cure animation]
  !!SN:T^AC_Misc.Commander_Regeneration_Battle^/?z1/^heal^/y10; !!SN:Iz1/?z1; [set text]
  !!BU:Mz1;                             [show messag in battle log]
  !!VRz2:S^Cure.wav^;                   [get sound file]
  !!SN:Pz2;                             [Play Sound]
!!en;

!!SN&y4=0:W^Att_Com_Regeneration_flag^/1;[set variable if commander was healed]
!!SN&y4=1:W^Def_Com_Regeneration_flag^/1;


!?FU(OnCombatRound);
!!SN:W^Att_Com_Regeneration_flag^/0;    [reset variable in new battle round]
!!SN:W^Def_Com_Regeneration_flag^/0;

*Rewritten Block Mechanic from commander
!?MF1;                                  

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676;[Only run when melee, shooting damage or strikes all around]
  !!BG:A?y1;                            [get action type]
  !!if|y1=6/y1=7;                       [if melee or shooting]
    !!MF:N?y4;                          [damage receiving stack]
    !!BMy4:I?y5;                        [Side index as for heroes (0:left, 1:right)]
    
    !!SN&y5=0:W^Att_Com_Block_ability^/?y10; [check if the commander actually has block ability]
    !!SN&y5=1:W^Def_Com_Block_ability^/?y10;    

    !!if&y10;
      !!BMy4:T?y7;                        [get creature type]
      !!if&y7>=174/y7<=191;               [if any commander]
        !!VRy90:S0R99;                    [make random roll]
        !!VRy98:S30;                      [Chance to Block]
        !!VRy97:S50;                      [Damage reduction]
        !!BA:Hy5/?y99;                    [get hero by side index]

        !!if&y99=36;                      [if special hero]
          !!HEy99:E?y80/?y81/1;           [get level of hero in case of Vey]
          !!VRy98:Sy81:2+30 F30/100;      [Calc chance to block based on level]
          !!VRy96:Sy81:2+50 F50/95;
          !!VRy97:S100 -y96;              [Calc damage reduction based on level]
        !!en;
        !!FU&y90>=y98:E;                  [30% chance for success]
        !!MF:F?y6;                        [Damage Dealt]
        !!VRy6:*y97:100;                  [Reduce damage by 50%]
        !!if&i^battle_isVisible^;
          !!SN:P^CRUSDFND.wav^;           [play block sound]
          !!BMy4:V84;                     [play commander block animation]
        !!en;
        !!MF:Fy6;                         [apply reduced damage]
      !!en;
    !!en;
  !!en;
!!en;


[set commander description in battle]
!?CM4;

!!CM:D?y1;                              [Get Battlefield position with click]
!!FU(ACM_Set_Com_Desc_in_battle):Dy1;   [execute function remotely]
!!FU(ACM_Set_Com_Desc_in_battle):Py1;   [execute function locally]

!?FU(ACM_Set_Com_Desc_in_battle);
!!VRy30:S(FALSE);

!!if&x1>=0/x1<=186;                     [If a valid battlefield position]
  !!BU:Ex1/?y2;                         [get monster ID at position and exit if no monster]

  !!if&y2>(NO_STACK);
    !!BMy2:T?y3 I?y4;                     [get monster type and side index]

    !!if&y3>=174/y3<=191;               [if any commander]
      !!FU(ACM_RestoreCommanderAbilities):P;

      !!VRy30:S(TRUE);
    !!en;
  !!en;
!!en;

!!FU(ACM_RemoveCommanderAbilities)&y30=(FALSE):P;

!?FU(OnBeforeBattleAction);
!!FU(ACM_RemoveCommanderAbilities):P;

!?FU(ACM_RemoveCommanderAbilities);
!!COi^battle_hero_0^&i^Att_Com_Block_ability^:B1/8/0; [remove Block ability - attacker]
!!CO-4&i^Def_Com_Block_ability^:B1/8/0; [remove Block ability - defender]
!!COi^battle_hero_0^&i^Att_Com_Regeneration_ability^:B1/11/0; [remove regeneration - attacker]
!!CO-4&i^Def_Com_Regeneration_ability^:B1/11/0; [remove regeneration - defender]
!!COi^battle_hero_0^&i^Att_Com_Poison_ability^:B1/12/0; [remove Posion - attacker]
!!CO-4&i^Def_Com_Poison_ability^:B1/12/0;[remove Posion - defender]

; New timing for restoring commander abilities
; by Archer30
!?FU(ACM_CreateERMHook);
!#VA(setHook:x);

!!SN:E(setHook)/1/4681149/(ACM_OnBeforeBattleResult); 476DBD

!?FU(ACM_OnBeforeBattleResult);
!#VA(hook:x);

!!FU(ACM_RestoreCommanderAbilities):P;

!?FU(OnBeforeBattleReplay);
!!FU(ACM_RestoreCommanderAbilities):P;

!?FU(ACM_RestoreCommanderAbilities);
!!COi^battle_hero_0^&i^Att_Com_Block_ability^:B1/8/1; [give Block ability - attacker]
!!CO-4&i^Def_Com_Block_ability^:B1/8/1; [give Block ability - defender]

!!COi^battle_hero_0^&i^Att_Com_Regeneration_ability^:B1/11/1; [give regeneration - attacker]
!!CO-4&i^Def_Com_Regeneration_ability^:B1/11/1; [give regeneration - defender]

!!COi^battle_hero_0^&i^Att_Com_Poison_ability^:B1/12/1; [give Posion - attacker]
!!CO-4&i^Def_Com_Poison_ability^:B1/12/1;[give Posion - defender]

; Old timing is disabled due to later than commander leveling up procedures
!?FU(OnAfterBattleAction);
!!FU:E;

!!BU:C?(battleEnded:y);               	[check for end of battle]
!!if&(battleEnded);  
  !!SN:W^Att_Com_Block_ability^/?y1;
  !!COv7083&v7083>=0/y1=1:B1/8/1;       [give Block ability - attacker]
  !!SN:W^Def_Com_Block_ability^/?y2;
  !!COv7085&v7085>=0/y2=1:B1/8/1;       [give Block ability - defender]

  !!SN:W^Att_Com_Regeneration_ability^/?y1;
  !!COv7083&v7083>=0/y1=1:B1/11/1;      [give regeneration - attacker]
  !!SN:W^Def_Com_Regeneration_ability^/?y2;
  !!COv7085&v7085>=0/y2=1:B1/11/1;      [give regeneration - defender]

  !!SN:W^Att_Com_Poison_ability^/?y1;
  !!COv7083&v7083>=0/y1=1:B1/12/1;      [give Posion - attacker]
  !!SN:W^Def_Com_Poison_ability^/?y2; 
  !!COv7085&v7085>=0/y2=1:B1/12/1;      [give Posion - defender]
!!en;

!?FU(OnAfterBattleUniversal);
*Ending the battle with Trainer "burn them all" would remove commander skills
  !!SN:W^Att_Com_Block_ability^/?y1;
  !!COv7083&v7083>=0/y1=1:B1/8/1;       [give Block ability - attacker]
  !!SN:W^Def_Com_Block_ability^/?y2;
  !!COv7085&v7085>=0/y2=1:B1/8/1;       [give Block ability - defender]

  !!SN:W^Att_Com_Regeneration_ability^/?y1;
  !!COv7083&v7083>=0/y1=1:B1/11/1;      [give regeneration - attacker]
  !!SN:W^Def_Com_Regeneration_ability^/?y2;
  !!COv7085&v7085>=0/y2=1:B1/11/1;      [give regeneration - defender]

  !!SN:W^Att_Com_Poison_ability^/?y1;
  !!COv7083&v7083>=0/y1=1:B1/12/1;      [give Posion - attacker]
  !!SN:W^Def_Com_Poison_ability^/?y2; 
  !!COv7085&v7085>=0/y2=1:B1/12/1;      [give Posion - defender]

****************************************************************************************************



New Commander Specialisation window during combat to set new classes



****************************************************************************************************
*Function to show Commander class promotion screen and set initial text
!?FU(ACM_Select_Commander_Role_Upg);

!!VRy99:Sx1;                            [y99 holds current Hero ID]
!!SN:W^ACM_Commander_Hero_ID^/y99;      [Save current hero ID for later]
!!HEy99:O?y80;                          [Get hero color]
!!OW:Gy80/?y81;                         [Check if a player IS a player that is sitting before the PC screen]
!!FU&y81=0:E;                           [Exit if not sitting before PC]

!!FU(Check_Com_Masteries):Py99/0/?y90/0/?y98; [Pass Hero Number and return current class]
!!SN:W^ACM_Commander_Class_Before_Upgrade^/y98; [Save current commander class in this DL]
!!DL276:N^Com_Opt2.txt^;                [parse dialogue]

!!VRz1:S^C_Opt11.pcx^; !!DL276:A1/11/z1/1; [Picture of Class]
!!VRz2:S^C_Opt12.pcx^; !!DL276:A2/11/z2/1;
!!VRz3:S^C_Opt13.pcx^; !!DL276:A3/11/z3/1;
!!VRz4:S^C_Opt14.pcx^; !!DL276:A4/11/z4/1;
!!VRz5:S^C_Opt15.pcx^; !!DL276:A5/11/z5/1;
!!VRz6:S^C_Opt16.pcx^; !!DL276:A6/11/z6/1;
!!VRz7:S^C_Opt17.pcx^; !!DL276:A7/11/z7/1;
!!VRz8:S^C_Opt18.pcx^; !!DL276:A8/11/z8/1;
!!VRz9:S^C_Opt19.pcx^; !!DL276:A9/11/z9/1;

!!VRz10:S^C_Opt20.pcx^; !!DL276:A10/11/z10/1; 
!!VRz11:S^C_Opt21.pcx^; !!DL276:A11/11/z11/1;
!!VRz12:S^C_Opt22.pcx^; !!DL276:A12/11/z12/1;
!!VRz13:S^C_Opt23.pcx^; !!DL276:A13/11/z13/1;
!!VRz14:S^C_Opt24.pcx^; !!DL276:A14/11/z14/1;
!!VRz15:S^C_Opt25.pcx^; !!DL276:A15/11/z15/1;
!!VRz16:S^C_Opt26.pcx^; !!DL276:A16/11/z16/1;
!!VRz17:S^C_Opt27.pcx^; !!DL276:A17/11/z17/1;
!!VRz18:S^C_Opt28.pcx^; !!DL276:A18/11/z18/1;


!!SN:T^AC_Misc.Commander_Opt_11^/?z20; !!DL276:A20/3/z20/1; [Name of Class]
!!SN:T^AC_Misc.Commander_Opt_21^/?z21; !!DL276:A21/3/z21/1;
!!SN:T^AC_Misc.Commander_Opt_12^/?z22; !!DL276:A22/3/z22/1;
!!SN:T^AC_Misc.Commander_Opt_22^/?z23; !!DL276:A23/3/z23/1;
!!SN:T^AC_Misc.Commander_Opt_13^/?z24; !!DL276:A24/3/z24/1;
!!SN:T^AC_Misc.Commander_Opt_23^/?z25; !!DL276:A25/3/z25/1;
!!SN:T^AC_Misc.Commander_Opt_14^/?z26; !!DL276:A26/3/z26/1;
!!SN:T^AC_Misc.Commander_Opt_24^/?z27; !!DL276:A27/3/z27/1;
!!SN:T^AC_Misc.Commander_Opt_15^/?z28; !!DL276:A28/3/z28/1;

!!SN:T^AC_Misc.Commander_Opt_25^/?z29; !!DL276:A29/3/z29/1; 
!!SN:T^AC_Misc.Commander_Opt_16^/?z30; !!DL276:A30/3/z30/1;
!!SN:T^AC_Misc.Commander_Opt_26^/?z31; !!DL276:A31/3/z31/1;
!!SN:T^AC_Misc.Commander_Opt_17^/?z32; !!DL276:A32/3/z32/1;
!!SN:T^AC_Misc.Commander_Opt_27^/?z33; !!DL276:A33/3/z33/1;
!!SN:T^AC_Misc.Commander_Opt_18^/?z34; !!DL276:A34/3/z34/1;
!!SN:T^AC_Misc.Commander_Opt_28^/?z35; !!DL276:A35/3/z35/1;
!!SN:T^AC_Misc.Commander_Opt_19^/?z36; !!DL276:A36/3/z36/1;
!!SN:W^Ancient_Unlocked^/?y50;          [check if secret class has been unlocked]
!!SN&y50=1:T^AC_Misc.Commander_Opt_29^/?z37; !!SN&y50=0:T^AC_Misc.Commander_Opt_Secret^/?z37; !!DL276:A37/3/z37/1;

!!SN:T^AC_Misc.Commander_Opt_Promo_Text^/?z60; !!DL276:A60/3/z60/1; [heading additional game options]
!!SN:T^AC_Misc.Commander_Opt_Text_Info^/?z62; !!DL276:A62/3/z62/1; [heading additional game options]
!!SN:T^AC_Misc.Commander_Opt_%Y98^/?z65;[Get name of base class]
!!VRz65&y98=0:S^%T(AC_Misc.Spell_Book_Description_None)^;
!!SN:T^AC_Misc.Commander_Opt_Text_Class^/?z63/^class^/z65; !!SN:Iz63/?z63; !!DL276:A63/3/z63/1; [heading additional game options]

!!SN:T^AC_Misc.Commander_Play_as^/?z80; [Set Hint text when hovering mouse over icons]
!!VRz40:S^%Z80 %Z20^; !!DL276:H1/40;
!!VRz41:S^%Z80 %Z21^; !!DL276:H2/41;
!!VRz42:S^%Z80 %Z22^; !!DL276:H3/42;
!!VRz43:S^%Z80 %Z23^; !!DL276:H4/43;
!!VRz44:S^%Z80 %Z24^; !!DL276:H5/44;
!!VRz45:S^%Z80 %Z25^; !!DL276:H6/45;
!!VRz46:S^%Z80 %Z26^; !!DL276:H7/46;
!!VRz47:S^%Z80 %Z27^; !!DL276:H8/47;
!!VRz48:S^%Z80 %Z28^; !!DL276:H9/48;

!!VRz49:S^%Z80 %Z29^; !!DL276:H10/49;
!!VRz50:S^%Z80 %Z30^; !!DL276:H11/50;
!!VRz51:S^%Z80 %Z31^; !!DL276:H12/51;
!!VRz52:S^%Z80 %Z32^; !!DL276:H13/52;
!!VRz53:S^%Z80 %Z33^; !!DL276:H14/53;
!!VRz54:S^%Z80 %Z34^; !!DL276:H15/54;
!!VRz55:S^%Z80 %Z35^; !!DL276:H16/55;
!!VRz56:S^%Z80 %Z36^; !!DL276:H17/56;
!!VRz57:S^%Z80 %Z37^; !!DL276:H18/57;

!!SN:T^AC_Misc.Commander_Opt_Hint_Play^/?z61; !!DL276:H30722/61; [set confirm as hint]

*!SN:W^Commander_Fighter_%Y99^/?y1;     [Check if options have already been activated]
*!SN:W^Commander_Ranger_%Y99^/?y2;
*!SN:W^Commander_Defender_%Y99^/?y3;
*!SN:W^Commander_Caster_%Y99^/?y4;
*!SN:W^Commander_Supporter_%Y99^/?y5;
*!SN:W^Commander_Leader_%Y99^/?y6;
*!SN:W^Commander_Scout_%Y99^/?y7;
*!SN:W^Commander_Undead_%Y99^/?y8;
*!SN:W^Commander_FireMage_%Y99^/?y9;

!!SN:W^Commander_Dragonslayer_%Y99^/?y10; 
!!SN:W^Commander_Sniper_%Y99^/?y11; 
!!SN:W^Commander_Retaliator_%Y99^/?y12; 
!!SN:W^Commander_ArchMage_%Y99^/?y13; 
!!SN:W^Commander_Constructor_%Y99^/?y14; 
!!SN:W^Commander_King_%Y99^/?y15; 
!!SN:W^Commander_Prospector_%Y99^/?y16;
!!SN:W^Commander_Lich_%Y99^/?y17; 
!!SN:W^Commander_Vampire_%Y99^/?y18; 

!!SN:W^Commander_Paladin_%Y99^/?y19; 
!!SN:W^Commander_Marksmen_%Y99^/?y20; 
!!SN:W^Commander_Avenger_%Y99^/?y21; 
!!SN:W^Commander_Warden_%Y99^/?y22; 
!!SN:W^Commander_Arcanist_%Y99^/?y23;
!!SN:W^Commander_General_%Y99^/?y24; 
!!SN:W^Commander_Lancer_%Y99^/?y25; 
!!SN:W^Commander_Necromant_%Y99^/?y26; 
!!SN:W^Commander_Ancient_%Y99^/?y27; 

!!DL276:A40/4/y10/1;                    [switch def cardre to 0 or 1]
!!DL276:A41/4/y11/1;
!!DL276:A42/4/y12/1;
!!DL276:A43/4/y13/1;
!!DL276:A44/4/y14/1;
!!DL276:A45/4/y15/1;  
!!DL276:A46/4/y16/1;  
!!DL276:A47/4/y17/1;  
!!DL276:A48/4/y18/1;

!!DL276:A49/4/y19/1;                    [switch def cardre to 0 or 1]
!!DL276:A50/4/y20/1;
!!DL276:A51/4/y21/1;
!!DL276:A52/4/y22/1;
!!DL276:A53/4/y23/1;
!!DL276:A54/4/y24/1;  
!!DL276:A55/4/y25/1;  
!!DL276:A56/4/y26/1;  
!!DL276:A57/4/y27/1; 

!!FU(DL_FindById):P276/?(dlgPtr:y);
!!UN:C(dlgPtr:y)/(UNC_INT)/?(dlg:y);
!!re i/40/57;
!!FU(acm_DlgShowItem):Pi/(FALSE)/(FALSE)/(FALSE)/(dlg); [remove all buttons from dialouge]
!!en;

!!SN:W^ACM_Commander_Hero_ID^/?y99; 
!!SN:W^ACM_Commander_Class_Before_Upgrade^/?y98; 
!!FU(Check_Com_Masteries):Py99/0/0/0/0/0/0/?y50/?y51/?y52/?y53/d/d/d/y98/1; [Get possible upgrades for current commander class to remove selection]
!!FU(acm_DlgShowItem):Py50/(TRUE)/(FALSE)/(FALSE)/(dlg); [restore button if current class can be upgraded]
!!FU(acm_DlgShowItem):Py51/(TRUE)/(FALSE)/(FALSE)/(dlg);
!!FU(acm_DlgShowItem):Py52/(TRUE)/(FALSE)/(FALSE)/(dlg);
!!FU(acm_DlgShowItem):Py53/(TRUE)/(FALSE)/(FALSE)/(dlg);

!!DL276:S;                              [Show Dialogue]


!?DL&v998=276/v999>=1/v999<=129/v1000=14;[right click on the options to show text for upgrade, description and values]

!!FU&v999>18/v999<121:E;
!!DL275:N^Com_Class.txt^;               [parse dialogue]
!!VRy98:S0;

!!SN|v999=121:T^AC_Misc.Play_Com_Opt_1^/?z1; !!VRy98&v999=121:S1;
!!SN|v999=122:T^AC_Misc.Play_Com_Opt_2^/?z1; !!VRy98&v999=122:S2; 
!!SN|v999=123:T^AC_Misc.Play_Com_Opt_3^/?z1; !!VRy98&v999=123:S3;
!!SN|v999=124:T^AC_Misc.Play_Com_Opt_4^/?z1; !!VRy98&v999=124:S4;
!!SN|v999=125:T^AC_Misc.Play_Com_Opt_5^/?z1; !!VRy98&v999=125:S5;
!!SN|v999=126:T^AC_Misc.Play_Com_Opt_6^/?z1; !!VRy98&v999=126:S6;
!!SN|v999=127:T^AC_Misc.Play_Com_Opt_7^/?z1; !!VRy98&v999=127:S7;
!!SN|v999=128:T^AC_Misc.Play_Com_Opt_8^/?z1; !!VRy98&v999=128:S8;
!!SN|v999=129:T^AC_Misc.Play_Com_Opt_9^/?z1; !!VRy98&v999=129:S9; 

!!SN|v999=1:T^AC_Misc.Play_Com_Opt_11^/?z1; !!VRy98&v999=1:S11; [set description text and set correct commander class ID for later use]
!!SN|v999=2:T^AC_Misc.Play_Com_Opt_21^/?z1; !!VRy98&v999=2:S21; 
!!SN|v999=3:T^AC_Misc.Play_Com_Opt_12^/?z1; !!VRy98&v999=3:S12;
!!SN|v999=4:T^AC_Misc.Play_Com_Opt_22^/?z1; !!VRy98&v999=4:S22;
!!SN|v999=5:T^AC_Misc.Play_Com_Opt_13^/?z1; !!VRy98&v999=5:S13;
!!SN|v999=6:T^AC_Misc.Play_Com_Opt_23^/?z1; !!VRy98&v999=6:S23;
!!SN|v999=7:T^AC_Misc.Play_Com_Opt_14^/?z1; !!VRy98&v999=7:S14;
!!SN|v999=8:T^AC_Misc.Play_Com_Opt_24^/?z1; !!VRy98&v999=8:S24;
!!SN|v999=9:T^AC_Misc.Play_Com_Opt_15^/?z1; !!VRy98&v999=9:S15; 

!!SN|v999=10:T^AC_Misc.Play_Com_Opt_25^/?z1; !!VRy98&v999=10:S25;
!!SN|v999=11:T^AC_Misc.Play_Com_Opt_16^/?z1; !!VRy98&v999=11:S16; 
!!SN|v999=12:T^AC_Misc.Play_Com_Opt_26^/?z1; !!VRy98&v999=12:S26;
!!SN|v999=13:T^AC_Misc.Play_Com_Opt_17^/?z1; !!VRy98&v999=13:S17;
!!SN|v999=14:T^AC_Misc.Play_Com_Opt_27^/?z1; !!VRy98&v999=14:S27;
!!SN|v999=15:T^AC_Misc.Play_Com_Opt_18^/?z1; !!VRy98&v999=15:S18;
!!SN|v999=16:T^AC_Misc.Play_Com_Opt_28^/?z1; !!VRy98&v999=16:S28;
!!SN|v999=17:T^AC_Misc.Play_Com_Opt_19^/?z1; !!VRy98&v999=17:S19;
!!SN:W^Ancient_Unlocked^/?y50;
!!SN&v999=18/y50=1:T^AC_Misc.Play_Com_Opt_29^/?z1; !!SN&v999=18/y50=0:T^AC_Misc.Play_Com_Opt_Secret_1^/?z1; !!VRy98&v999=18:S29;

!!SN:W^ACM_Commander_Hero_ID^/?y99; 
!!FU(Check_Com_Masteries):P-1/0/0/0/0/?y90/?y91/?y92/?y93/?y20/?y21/?y22/?y23/?y24/y98/0; [Get commander class modifier from function]
!!FU(Check_Com_Masteries):P-1/0/0/0/0/?y86/?y87/d/d/d/d/d/d/d/y98/1; [Get commander class modifier from function]
!!SN:T^AC_Misc.Bonus_Table_Commander_Class^/?z2; !!SN:Iz2/?z2; [set text for 1st]
!!VRz30:S^^;
!!VRz30&y24>=0:S^+^;                    [add a plus before Spells in commander attribute list]
!!SN:T^AC_Misc.Bonus_Table_Commander_ClassII^/?z3; !!SN:Iz3/?z3; [set text for 1st]
!!SN:T^AC_Misc.Commander_Opt_%Y98^/?z5; !!SN:Iz5/?z5; [set text for 1st]
!!VRz5&v999=18/y50=0:S^%T(AC_Misc.Bonus_Table_Secret_Class)^;
!!SN:T^AC_Misc.Bonus_Table_Commander_ClassIII^/?z4; !!SN:Iz4/?z4; [set text for 1st]

!!FU(Set_Com_Battle_Description):Py98/y99/0/y22/0/5/0;
x1=commader class (1-29), x2=hero ID, x3=kill count, x4=passive mod, x5=Mastery, x6=speed, x7=Side

!!SN:W^Commander_%Y99_Ancient_Fighter^/0;[Resest Ancient commander variable when commander promotion screen is first shown]
!!SN:W^Commander_%Y99_Ancient_Ranger^/0;
!!SN:W^Commander_%Y99_Ancient_Defender^/0;
!!SN:W^Commander_%Y99_Ancient_Caster^/0;
!!SN:W^Commander_%Y99_Ancient_Supporter^/0;
!!SN:W^Commander_%Y99_Ancient_Leader^/0;
!!SN:W^Commander_%Y99_Ancient_Scout^/0;
!!SN:W^Commander_%Y99_Ancient_Undead^/0;
!!SN:W^Commander_%Y99_Ancient_FireMage^/0;

!!SN:W^ACM_Commander_Class_Before_Upgrade^/?y98; [check class of commander from before the upgrade]
!!SN&y98=1:T^AC_Misc.Ancient_Fighter^/?z20; [get text for commander passive to show in Ancient commander text field]
!!SN&y98=2:T^AC_Misc.Ancient_Ranger^/?z20;
!!SN&y98=3:T^AC_Misc.Ancient_Defender^/?z20;
!!SN&y98=4:T^AC_Misc.Ancient_Caster^/?z20;
!!SN&y98=5:T^AC_Misc.Ancient_Supporter^/?z20;
!!SN&y98=6:T^AC_Misc.Ancient_Leader^/?z20;
!!SN&y98=7:T^AC_Misc.Ancient_Scout^/?z20;
!!SN&y98=8:T^AC_Misc.Ancient_Undead^/?z20;
!!SN&y98=9:T^AC_Misc.Ancient_FireMage^/?z20;
!!SN:Iz1/?z1;

!!SN&y98=1:W^Commander_%Y99_Ancient_Fighter^/1; [enable commander Mastery for Ancient commander based on his former class]
!!SN&y98=2:W^Commander_%Y99_Ancient_Ranger^/1;
!!SN&y98=3:W^Commander_%Y99_Ancient_Defender^/1;
!!SN&y98=4:W^Commander_%Y99_Ancient_Caster^/1;
!!SN&y98=5:W^Commander_%Y99_Ancient_Supporter^/1;
!!SN&y98=6:W^Commander_%Y99_Ancient_Leader^/1;
!!SN&y98=7:W^Commander_%Y99_Ancient_Scout^/1;
!!SN&y98=8:W^Commander_%Y99_Ancient_Undead^/1;
!!SN&y98=9:W^Commander_%Y99_Ancient_FireMage^/1;

!!DL275:A1/3/z1/1; 
!!DL275:A2/3/z2/1;
!!DL275:A3/3/z3/1;
!!DL275:A4/3/z4/1;
!!DL275:A5/3/z11/1;
!!FU(DL_ShowPopup):P275;                [Show Popup DL]


!?DL&v998=276/v999=63/v1000=14;         [right click on the options to show text for upgrade and description]

!!DL275:N^Com_Class.txt^;               [parse dialogue]
!!SN:W^ACM_Commander_Hero_ID^/?y99;
!!SN:W^ACM_Commander_Class_Before_Upgrade^/?y98; 

!!SN|y98=1:T^AC_Misc.Play_Com_Opt_1^/?z1;
!!SN|y98=2:T^AC_Misc.Play_Com_Opt_2^/?z1;
!!SN|y98=3:T^AC_Misc.Play_Com_Opt_3^/?z1;
!!SN|y98=4:T^AC_Misc.Play_Com_Opt_4^/?z1;
!!SN|y98=5:T^AC_Misc.Play_Com_Opt_5^/?z1;
!!SN|y98=6:T^AC_Misc.Play_Com_Opt_6^/?z1;
!!SN|y98=7:T^AC_Misc.Play_Com_Opt_7^/?z1;
!!SN|y98=8:T^AC_Misc.Play_Com_Opt_8^/?z1;
!!SN|y98=9:T^AC_Misc.Play_Com_Opt_9^/?z1;

!!FU(Check_Com_Masteries):P-1/0/0/0/0/?y90/?y91/?y92/?y93/?y20/?y21/?y22/?y23/?y24/y98/0; [Get commander class modifier from function]
!!FU(Check_Com_Masteries):P-1/0/0/0/0/?y86/?y87/d/d/d/d/d/d/d/y98/1; [Get commander class modifier from function]
!!SN:T^AC_Misc.Bonus_Table_Commander_Class^/?z2; !!SN:Iz2/?z2; [set text for 1st]
!!VRz30:S^^;
!!VRz30&y24>=0:S^+^;
!!SN:T^AC_Misc.Bonus_Table_Commander_ClassII^/?z3; !!SN:Iz3/?z3; [set text for 1st]
!!SN:T^AC_Misc.Commander_Opt_%Y98^/?z5; !!SN:Iz5/?z5; [set text for 1st]
!!SN:W^Fire_Mage_Unlocked^/?y50;
!!SN&y50=0:T^AC_Misc.Bonus_Table_Secret_Class^/?z5;
!!SN:T^AC_Misc.Bonus_Table_Commander_ClassIII^/?z4; !!SN:Iz4/?z4; [set text for 1st]

!!FU(Set_Com_Battle_Description):Py98/y99/0/y22/0/5/0;
x1=commader class (1-29), x2=hero ID, x3=kill count, x4=passive mod, x5=Mastery, x6=speed, x7=Side

!!DL275:A1/3/z1/1; 
!!DL275:A2/3/z2/1;
!!DL275:A3/3/z3/1;
!!DL275:A4/3/z4/1;
!!DL275:A5/3/z11/1;
!!FU(DL_ShowPopup):P275;                [Show Popup DL]


!?DL&v998=276/v999>=40/v999<=57/v1000=13;[LMB on the options icons to activate class]
!!VRz1:S^Button.wav^;
!!SN:Pz1;                               [Play Sound]
!!SN:W^ACM_Commander_Hero_ID^/?y99;

!!SN:W^Commander_Fighter_%Y99^/?y1;     [Check if options have already been activated]
!!SN:W^Commander_Ranger_%Y99^/?y2;
!!SN:W^Commander_Defender_%Y99^/?y3;
!!SN:W^Commander_Caster_%Y99^/?y4;
!!SN:W^Commander_Supporter_%Y99^/?y5;
!!SN:W^Commander_Leader_%Y99^/?y6;
!!SN:W^Commander_Scout_%Y99^/?y7;
!!SN:W^Commander_Undead_%Y99^/?y8;
!!SN:W^Commander_FireMage_%Y99^/?y9;

!!SN:W^Commander_Dragonslayer_%Y99^/?y10; 
!!SN:W^Commander_Sniper_%Y99^/?y11; 
!!SN:W^Commander_Retaliator_%Y99^/?y12; 
!!SN:W^Commander_ArchMage_%Y99^/?y13; 
!!SN:W^Commander_Constructor_%Y99^/?y14; 
!!SN:W^Commander_King_%Y99^/?y15; 
!!SN:W^Commander_Prospector_%Y99^/?y16;
!!SN:W^Commander_Lich_%Y99^/?y17; 
!!SN:W^Commander_Vampire_%Y99^/?y18; 

!!SN:W^Commander_Paladin_%Y99^/?y19; 
!!SN:W^Commander_Marksmen_%Y99^/?y20; 
!!SN:W^Commander_Avenger_%Y99^/?y21; 
!!SN:W^Commander_Warden_%Y99^/?y22; 
!!SN:W^Commander_Arcanist_%Y99^/?y23;
!!SN:W^Commander_General_%Y99^/?y24; 
!!SN:W^Commander_Lancer_%Y99^/?y25; 
!!SN:W^Commander_Necromant_%Y99^/?y26; 
!!SN:W^Commander_Ancient_%Y99^/?y27; 

!!VRy50:S0+y1+y2+y3+y4+y5+y6+y7+y8+y9;  [Get number of activated options]
!!VRy50:+y10+y11+y12+y13+y14+y15+y16+y17+y18; [Get number of activated options]
!!VRy50:+y19+y20+y21+y22+y23+y24+y25+y26+y27; [Get number of activated options]

!!if&y50>0;
  !!SN:W^Commander_Fighter_%Y99^/0;     
  !!SN:W^Commander_Ranger_%Y99^/0;
  !!SN:W^Commander_Defender_%Y99^/0;
  !!SN:W^Commander_Caster_%Y99^/0;
  !!SN:W^Commander_Supporter_%Y99^/0;
  !!SN:W^Commander_Leader_%Y99^/0;
  !!SN:W^Commander_Scout_%Y99^/0;
  !!SN:W^Commander_Undead_%Y99^/0;
  !!SN:W^Commander_FireMage_%Y99^/0;

  !!SN:W^Commander_Dragonslayer_%Y99^/0; 
  !!SN:W^Commander_Sniper_%Y99^/0; 
  !!SN:W^Commander_Retaliator_%Y99^/0; 
  !!SN:W^Commander_ArchMage_%Y99^/0; 
  !!SN:W^Commander_Constructor_%Y99^/0; 
  !!SN:W^Commander_King_%Y99^/0; 
  !!SN:W^Commander_Prospector_%Y99^/0;
  !!SN:W^Commander_Lich_%Y99^/0; 
  !!SN:W^Commander_Vampire_%Y99^/0; 

  !!SN:W^Commander_Paladin_%Y99^/0; 
  !!SN:W^Commander_Marksmen_%Y99^/0; 
  !!SN:W^Commander_Avenger_%Y99^/0; 
  !!SN:W^Commander_Warden_%Y99^/0; 
  !!SN:W^Commander_Arcanist_%Y99^/0;
  !!SN:W^Commander_General_%Y99^/0; 
  !!SN:W^Commander_Lancer_%Y99^/0; 
  !!SN:W^Commander_Necromant_%Y99^/0; 
  !!SN:W^Commander_Ancient_%Y99^/0;
!!en;

!!SN&v999=40/y10=0:W^Commander_Dragonslayer_%Y99^/1; [activate 1st]
!!SN&v999=40/y10=1:W^Commander_Dragonslayer_%Y99^/0; [deactivate first]
!!SN&v999=41/y19=0:W^Commander_Paladin_%Y99^/1; [activate 1st]
!!SN&v999=41/y19=1:W^Commander_Paladin_%Y99^/0; [deactivate first]
!!SN&v999=42/y11=0:W^Commander_Sniper_%Y99^/1;
!!SN&v999=42/y11=1:W^Commander_Sniper_%Y99^/0;
!!SN&v999=43/y20=0:W^Commander_Marksmen_%Y99^/1;
!!SN&v999=43/y20=1:W^Commander_Marksmen_%Y99^/0;
!!SN&v999=44/y12=0:W^Commander_Retaliator_%Y99^/1;
!!SN&v999=44/y12=1:W^Commander_Retaliator_%Y99^/0;
!!SN&v999=45/y21=0:W^Commander_Avenger_%Y99^/1;
!!SN&v999=45/y21=1:W^Commander_Avenger_%Y99^/0;
!!SN&v999=46/y13=0:W^Commander_ArchMage_%Y99^/1;
!!SN&v999=46/y13=1:W^Commander_ArchMage_%Y99^/0;
!!SN&v999=47/y22=0:W^Commander_Warden_%Y99^/1;
!!SN&v999=47/y22=1:W^Commander_Warden_%Y99^/0;
!!SN&v999=48/y14=0:W^Commander_Constructor_%Y99^/1;
!!SN&v999=48/y14=1:W^Commander_Constructor_%Y99^/0;
!!SN&v999=49/y23=0:W^Commander_Arcanist_%Y99^/1;
!!SN&v999=49/y23=1:W^Commander_Arcanist_%Y99^/0;
!!SN&v999=50/y15=0:W^Commander_King_%Y99^/1;
!!SN&v999=50/y15=1:W^Commander_King_%Y99^/0;
!!SN&v999=51/y24=0:W^Commander_General_%Y99^/1;
!!SN&v999=51/y24=1:W^Commander_General_%Y99^/0;
!!SN&v999=52/y16=0:W^Commander_Prospector_%Y99^/1;
!!SN&v999=52/y16=1:W^Commander_Prospector_%Y99^/0;
!!SN&v999=53/y25=0:W^Commander_Lancer_%Y99^/1;
!!SN&v999=53/y25=1:W^Commander_Lancer_%Y99^/0;
!!SN&v999=54/y17=0:W^Commander_Lich_%Y99^/1;
!!SN&v999=54/y17=1:W^Commander_Lich_%Y99^/0;
!!SN&v999=55/y26=0:W^Commander_Necromant_%Y99^/1;
!!SN&v999=55/y26=1:W^Commander_Necromant_%Y99^/0;
!!SN&v999=56/y18=0:W^Commander_Vampire_%Y99^/1;
!!SN&v999=56/y18=1:W^Commander_Vampire_%Y99^/0;
!!SN&v999=57/y27=0:W^Commander_Ancient_%Y99^/1;
!!SN&v999=57/y27=1:W^Commander_Ancient_%Y99^/0;

!!SN:W^Commander_Fighter_%Y99^/?y1;     [Check if options have already been activated]
!!SN:W^Commander_Ranger_%Y99^/?y2;
!!SN:W^Commander_Defender_%Y99^/?y3;
!!SN:W^Commander_Caster_%Y99^/?y4;
!!SN:W^Commander_Supporter_%Y99^/?y5;
!!SN:W^Commander_Leader_%Y99^/?y6;
!!SN:W^Commander_Scout_%Y99^/?y7;
!!SN:W^Commander_Undead_%Y99^/?y8;
!!SN:W^Commander_FireMage_%Y99^/?y9;

!!SN:W^Commander_Dragonslayer_%Y99^/?y10; 
!!SN:W^Commander_Sniper_%Y99^/?y11; 
!!SN:W^Commander_Retaliator_%Y99^/?y12; 
!!SN:W^Commander_ArchMage_%Y99^/?y13; 
!!SN:W^Commander_Constructor_%Y99^/?y14; 
!!SN:W^Commander_King_%Y99^/?y15; 
!!SN:W^Commander_Prospector_%Y99^/?y16;
!!SN:W^Commander_Lich_%Y99^/?y17; 
!!SN:W^Commander_Vampire_%Y99^/?y18; 

!!SN:W^Commander_Paladin_%Y99^/?y19; 
!!SN:W^Commander_Marksmen_%Y99^/?y20; 
!!SN:W^Commander_Avenger_%Y99^/?y21; 
!!SN:W^Commander_Warden_%Y99^/?y22; 
!!SN:W^Commander_Arcanist_%Y99^/?y23;
!!SN:W^Commander_General_%Y99^/?y24; 
!!SN:W^Commander_Lancer_%Y99^/?y25; 
!!SN:W^Commander_Necromant_%Y99^/?y26; 
!!SN:W^Commander_Ancient_%Y99^/?y27; 

!!DL276:A40/4/y10/1;                    [switch def cardre to 0 or 1]
!!DL276:A41/4/y19/1;
!!DL276:A42/4/y11/1;
!!DL276:A43/4/y20/1;
!!DL276:A44/4/y12/1;
!!DL276:A45/4/y21/1;  
!!DL276:A46/4/y13/1;  
!!DL276:A47/4/y22/1;  
!!DL276:A48/4/y14/1;

!!DL276:A49/4/y23/1;                    [switch def cardre to 0 or 1]
!!DL276:A50/4/y15/1;
!!DL276:A51/4/y24/1;
!!DL276:A52/4/y16/1;
!!DL276:A53/4/y25/1;
!!DL276:A54/4/y17/1;  
!!DL276:A55/4/y26/1;  
!!DL276:A56/4/y18/1;  
!!DL276:A57/4/y27/1;         


Close Dialouge
!?DL&v998=276/v999=30722/v1000=13;
!!SN:W^ACM_Commander_Hero_ID^/?y99;

!!SN:W^Commander_Fighter_%Y99^/?y1;     [Check if options have already been activated]
!!SN:W^Commander_Ranger_%Y99^/?y2;
!!SN:W^Commander_Defender_%Y99^/?y3;
!!SN:W^Commander_Caster_%Y99^/?y4;
!!SN:W^Commander_Supporter_%Y99^/?y5;
!!SN:W^Commander_Leader_%Y99^/?y6;
!!SN:W^Commander_Scout_%Y99^/?y7;
!!SN:W^Commander_Undead_%Y99^/?y8;
!!SN:W^Commander_FireMage_%Y99^/?y9;

!!SN:W^Commander_Dragonslayer_%Y99^/?y10; 
!!SN:W^Commander_Sniper_%Y99^/?y11; 
!!SN:W^Commander_Retaliator_%Y99^/?y12; 
!!SN:W^Commander_ArchMage_%Y99^/?y13; 
!!SN:W^Commander_Constructor_%Y99^/?y14; 
!!SN:W^Commander_King_%Y99^/?y15; 
!!SN:W^Commander_Prospector_%Y99^/?y16;
!!SN:W^Commander_Lich_%Y99^/?y17; 
!!SN:W^Commander_Vampire_%Y99^/?y18; 

!!SN:W^Commander_Paladin_%Y99^/?y19; 
!!SN:W^Commander_Marksmen_%Y99^/?y20; 
!!SN:W^Commander_Avenger_%Y99^/?y21; 
!!SN:W^Commander_Warden_%Y99^/?y22; 
!!SN:W^Commander_Arcanist_%Y99^/?y23;
!!SN:W^Commander_General_%Y99^/?y24; 
!!SN:W^Commander_Lancer_%Y99^/?y25; 
!!SN:W^Commander_Necromant_%Y99^/?y26; 
!!SN:W^Commander_Ancient_%Y99^/?y27; 

!!VRy50:Sy1+y2+y3+y4+y5+y6+y7+y8+y9;    [Get number of activated options]
!!VRy50:+y10+y11+y12+y13+y14+y15+y16+y17+y18; [Get number of activated options]
!!VRy50:+y19+y20+y21+y22+y23+y24+y25+y26+y27; [Get number of activated options]

!!SN:W^ACM_Commander_Class_Before_Upgrade^/?y97; [Get current commander class in this DL]
!!if&y50=0;                             [If no new class was selected fall back to old class]
  !!SN&y97=1:W^Commander_Fighter_%Y99^/1;[Check if options have already been activated]
  !!SN&y97=2:W^Commander_Ranger_%Y99^/1;
  !!SN&y97=3:W^Commander_Defender_%Y99^/1;
  !!SN&y97=4:W^Commander_Caster_%Y99^/1;
  !!SN&y97=5:W^Commander_Supporter_%Y99^/1;
  !!SN&y97=6:W^Commander_Leader_%Y99^/1;
  !!SN&y97=7:W^Commander_Scout_%Y99^/1;
  !!SN&y97=8:W^Commander_Undead_%Y99^/1;
  !!SN&y97=9:W^Commander_FireMage_%Y99^/1;
!!en;

!!DL:C1;                                
!!FU(Check_Com_Masteries):Py99/0/0/0/?y98; [Pass Hero Number and return current class]
!!SN&y98>10:W^Commander_Kill_Counter_%Y99^/0; [If a promotion class has been selected reset the kill counter for that commander]

!!FU(ACM_Com_Support_Passive_Selection)&y23=1:Py99; [If 2Supporter class was selected offer new passive ability]
!!FU(ACM_MP_Sync_Commander_Classes):Py99; [Send potential change about commander class to other players computer]


****************************************************************************************************


Scripting of the new commander classes from ID 10 to 30



***************************Dragonslayer Commander***************************************************
*Deals extra damage vs any level 7 creature and with mastery enabled only gets 50% damage.
Has permanent Slayer spell enabled
!?MF1;                                  [deals more damage vs any level 7 creature]
!!FU:E;                                 [Moved to OnStacktoStackDmg]
!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676;[Only run when melee or shooting damage or strikes all enemies around damage type]
  !!BG:A?y1;                            [Aktion in y1]
  !!if&y1=6|y1=7;                       [Attack or Shoot]
    !!BG:N?y1;                          [Attacking Stack]
    !!MF:N?y4;                          [damage receiving stack]
    !!BMy4:T?y5;                        [get creature type of attacked stack]
    !!MA:Ly5/?y6;                       [Get level of attacked stack]
    !!FU&y6<6:E;                        [Exit if it was not level 7 creature]
    !!SN:W^Dragonslayer1_Attacking_Stack^/?y50;
    !!VRy1&y4=y1/y50>=0/y50<=41:Sy50;   [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
    !!SN:W^Dragonslayer1_Attacking_Stack^/y4;
    !!if&y4>=0/y4<=41;                  [if any valid battlestack]
      !!BMy1:T?y2 I?y8;                 [Creature Type and Side index as for heroes (0:left, 1:right)]
      !!if&y2>=174/y2<=191;             [if any commander]
        !!BA:Hy8/?y99;                  [Get hero by side]
        !!FU&y99<0:E;                   [Exit if no hero]
        !!FU(Check_Com_Masteries):Py99/0/?y15/0/?y10/0/0/0/0/0/0/?y45; [Pass Hero Number and return current com class and Passive Modifier]
        !!FU&y10<>11:E;                 [exit if the wrong class]
        !!VRy16:Sy15*2+100;             [2% damage increase per kill count]
        !!MF:F?y6;                      [Get damage in y6]
        !!VRy6:*y16:100;                [Increase damage]
        !!MF&y6>=0:Fy6;                 [apply new damage]
      !!en;
    !!en;
  !!en;
!!en;


!?MF1;
*50% damage reduction
!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676;[Only run when melee or shooting damage or strikes all enemies around damage type]
  !!BG:A?y1;                            [Aktion in y1]
  !!if&y1=6|y1=7;                       [Attack or Shoot]
    !!BG:N?y1;                          [Attacking Stack]
    !!MF:N?y4;                          [damage receiving stack]
    !!SN:W^Dragonslayer2_Attacking_Stack^/?y50;
    !!VRy1&y4=y1/y50>=0/y50<=41:Sy50;   [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
    !!SN:W^Dragonslayer2_Attacking_Stack^/y4;
    !!BMy1:T?y5;                        [get creature type of attacking stack]
    !!MA:Ly5/?y6;                       [Get level of attacked stack]
    !!FU&y6<6:E;                        [Exit if it was not level 7 creature]
    !!if&y4>=0/y4<=41;                  [if any valid battlestack]
      !!BMy4:T?y2 I?y8;                 [Creature Type and Side index as for heroes (0:left, 1:right)]
      !!if&y2>=174/y2<=191;             [if any commander]
        !!BA:Hy8/?y99;                  [Get hero by side]
        !!FU&y99<0:E;                   [Exit if no hero]
        !!FU(Check_Com_Masteries):Py99/?y15/0/0/?y10; [Pass Hero Number and return current com class and mastery status]
        !!FU|y10<>11/y15=0:E;           [exit if the wrong class or no mastery enabled]
        !!MF:F?y6;                      [Get damage in y6]
        !!VRy6::2;                      [Halve damage]
        !!MF&y6>=0:Fy6;                 [apply new damage]
      !!en;
    !!en;
  !!en;
!!en;


On first battle round apply Slayer spell on Dragonslayer commander
!?FU(OnCombatRound)&v997=0;

!!BA:H0/?y2;                            [Attacker]
!!FU(Check_Com_Masteries):Py2/0/0/0/?y10;[Pass Hero Number and return current com class]
!!DO(ACM_Apply_Com_Spell_1)/0/20/1&y10=11:P; [call fkt to set Slayer spell on commander]

!!BA:H1/?y2;                            [Defender]
!!FU&y2<0:E;
!!FU(Check_Com_Masteries):Py2/0/0/0/?y10;[Pass Hero Number and return current com class]
!!DO(ACM_Apply_Com_Spell_1)/21/41/1&y10=11:P; [call fkt to set Slayer spell on commander]

!?FU(ACM_Apply_Com_Spell_1);                  
!!BMx16:T?y1 N?y2;                      [Get creature type]
!!BMx16&y1>=174/y1<=191/y2=1:M55/999/3; [apply slayer]


***************************Paladin Commander********************************************************
*Deals extra damage vs undead units and non living creatures, *Blessed and Prayered 
!?MF1;
!!FU:E;                                 [Moved to OnStacktoStackDmg]
!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676;[Only run when melee or shooting damage or strikes all enemies around damage type]
  !!BG:A?y1;                            [Aktion in y1]
  !!if&y1=6|y1=7;                       [Attack or Shoot]
    !!BG:N?y1;                          [Attacking Stack]
    !!MF:N?y4;                          [damage receiving stack]
    !!BMy4:F?i;                         [read flags]
    !!VRi:&16; !!FU&i>0:E;              [just look at alive bit and exit if yes]
    !!SN:W^Com_Paladin_Attacking_Stack^/?y50;
    !!VRy1&y4=y1/y50>=0/y50<=41:Sy50;   [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
    !!SN:W^Com_Paladin_Attacking_Stack^/y4;    
    !!if&y4>=0/y4<=41;                  [if any valid battlestack]
      !!BMy1:T?y2 I?y8;                 [Creature Type and Side index as for heroes (0:left, 1:right)]
      !!if&y2>=174/y2<=191;             [if any commander]
        !!BA:Hy8/?y99;                  [Get hero by side]
        !!FU&y99<0:E;                   [Exit if no hero]
        !!FU(Check_Com_Masteries):Py99/0/?y15/0/?y10/0/0/0/0/0/0/?y45; [Pass Hero Number and return current com class and Passive Modifier]
        !!FU&y10<>21:E;                 [exit if the wrong class]
        !!VRy16:Sy15*2+100;             [2% damage increase per kill count]
        !!MF:F?y6;                      [Get damage in y6]
        !!VRy6:*y16:100;                [Increase damage]
        !!MF&y6>=0:Fy6;                 [apply new damage]
      !!en;
    !!en;   
  !!en;
!!en;


On first battle round apply Bless and Prayer Spells on Paladin commander if mastery is active
!?FU(OnCombatRound)&v997=0;

!!BA:H0/?y2;                            [Attacker]
!!FU(Check_Com_Masteries):Py2/?y11/0/0/?y10; [Pass Hero Number and return current com class and mastery status]
!!DO(ACM_Apply_Com_Spell)/0/20/1&y10=21/y11=1:P; [call fkt to set Bless/Prayer spell on commander]

!!BA:H1/?y2;                            [Defender]
!!FU&y2<0:E;
!!FU(Check_Com_Masteries):Py2/?y11/0/0/?y10; [Pass Hero Number and return current com class and mastery status]
!!DO(ACM_Apply_Com_Spell)/21/41/1&y10=21/y11=1:P; [call fkt to set Bless/Prayer spell on commander]

!?FU(ACM_Apply_Com_Spell);                  
!!BMx16:T?y1 N?y2;                      [Get creature type]
!!BMx16&y1>=174/y1<=191/y2=1:M41/999/3; [apply 41  Bless]
!!BMx16&y1>=174/y1<=191/y2=1:M48/999/3; [apply 48  Prayer]


*******************************Sniper Commander*****************************************************
*Deals damage based on the max heatlth of target creatures

!?MF1;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if&y10=4455011;                       [shooting damage type]
  !!BG:A?y1;                            [Aktion in y1]
  !!if&y1=7;                            [Attack or Shoot]
    !!BG:N?y1;                          [Attacking Stack]
    !!MF:N?y4;                          [damage receiving stack]
    !!if&y4>=0/y4<=41;                  [if any valid battlestack]
      !!BMy1:T?y2 I?y8 U3/?y12;         [Creature Type and Side index as for heroes (0:left, 1:right)]
      !!if&y2>=174/y2<=191;             [if any commander]
        !!BA:Hy8/?y99;                  [Get hero by side]
        !!FU&y99<0:E;                   [Exit if no hero]
        !!FU(Check_Com_Masteries):Py99/0/?y15/0/?y10/0/0/0/0/0/0/?y45; [Pass Hero Number and return current com class and Passive Modifier]
        !!FU&y10<>12:E;                 [exit if the wrong class]
        !!BMy4:H?y10 N?y11;             [get health and number of target creature]
        !!VRy20:Sy11*y10;               [total HP of target]
        !!VRy30:Sy15:7 +7 F0/50;        [set percentage damage based on kill count 1% for 7 kill count +7, max at 50%]

        ; For boss creatures (creature with HP >= 5000), the HP percentage as damage is halved
        ; by Archer30
        !!MA:Py2/?y31;
        !!VRy30&y31>=5000::2;

        !!MF:F?y6;                      [Get damage in y6]
        !!VRy7:Sy20*y30:100;            [calc additional damage]        
        !!VRy6:+y7;                     [Increase damage]
        *!MF&y6>=0:Fy6;                 [apply new damage]
        !!VRy60&y8=0:S10;
        !!VRy61&y8=0:S0;
        !!VRy60&y8=1:S31;
        !!VRy61&y8=1:S21;
        !!re i/y61/y60;                 [loop battle stacks]
          !!BMi:T?y50;                  [get creature type and search for Ammo cart]
          !!if&y50=148;                 [if Ammo Cart is found]
            !!BMy1:U3/d-1;              [reduce number of shots by one for commander]
            !!BMy1:U3/?y2;              [check remaining shots]
            !!BMy1&y2<=0:U3/0;          [shots cannot be below zero]
            !!br;                       [exit loop]
          !!en;
        !!en;
      !!en;
    !!en;
  !!en;
!!en;


Sniper class gets 1 shot per battleround. Chance to reload increases with kill count
!?FU(OnCombatRound)&v997>=0;

!!BA:H0/?y2;                            [Attacker]
!!FU(Check_Com_Masteries):Py2/0/0/0/?y10;[Pass Hero Number and return current com class]
!!DO(ACM_Sniper_Shots)/0/10/1&y10=12:P; [call fkt to set shots on commander]

!!BA:H1/?y2;                            [Defender]
!!FU&y2<0:E;
!!FU(Check_Com_Masteries):Py2/0/0/0/?y10;[Pass Hero Number and return current com class]
!!DO(ACM_Sniper_Shots)/0/10/1&y10=12:P; [call fkt to set shots on commander]

!?FU(ACM_Sniper_Shots);                  
!!BMx16:T?y1 N?y2;                      [Get creature type]
!!BMx16&y1>=174/y1<=191/y2=1:U3/1;      [set available shots to 1]


*sniper com class can make ranged attack in close combat when mastery is active
!?FU(OnBattleStackObtainsTurn);
!#VA(stackSide:x) (stackInd:x);

!!BMi^battle_current_stack^:T?y2 I?y3;  [Get type and side of current battlestack]
!!BA:Hy3/?y99;                          [get hero from current side]
!!if&y2>=174/y2<=191/y99>=0;            [If any commander and a hero]
  !!FU(Check_Com_Masteries):Py99/?y11/0/0/?y10; [Pass Hero Number and return current com class]
  !!if&y11=1/y10=12;                    [If sniper class and mastery active]
    !!UN:C4466213/(UNC_INT)/y2;         [make the game think the commander is an arrow tower]
    !!UN:C4479001/(UNC_INT)/y2;         [make the game think the commander is an arrow tower]
  !!en;
!!el;
!!UN:C4466213/(UNC_INT)/(MON_ARROW_TOWERS); [Restore Arrow Tower UN:Cs]
!!UN:C4479001/(UNC_INT)/(MON_ARROW_TOWERS);


Restore Arrow Tower UN:Cs OnAfterBattleUniversal & OnAfterLoadGame
!?FU(OnAfterBattleUniversal);
!!UN:C4466213/(UNC_INT)/(MON_ARROW_TOWERS);
!!UN:C4479001/(UNC_INT)/(MON_ARROW_TOWERS);

!?FU(OnAfterLoadGame);
!!UN:C4466213/(UNC_INT)/(MON_ARROW_TOWERS);
!!UN:C4479001/(UNC_INT)/(MON_ARROW_TOWERS);


**********************************Marksman commander************************************************
Can shot muliable targets at once, depending on kill count
One extra shot is fired after the commander is shooting.

!?FU(ACM_OnAfterShoot);
!#VA(atkStack:x) (defStack:x);

!!BA:Q?y1; !!FU&y1=1:E;                 [Exit in Quick Combat]

!!VRy1:Sx1;                             [acting stack]
!!BMx1:I?y2;                            [Acting Side Monster]
!!BA:Hy2/?y99;                          [Current Hero]
!!FU&y99<0:E;                           [Exit if none]

!!BMx1:T?y3 P?y9;                       [Get Creature Number and current battlefield position]
!!if&y3>=174/y3<=191;                   [if any commander]
  !!FU(Check_Com_Masteries):Py99/0/0/0/?y10; [Pass Hero Number and return current com class and kill count]
  !!FU&y10<>22:E;                       [Exit if wrong com class]

  !!SN&y2=0:W^ACM_Marksmen_Shots_Att^/?y20;
  !!SN&y2=1:W^ACM_Marksmen_Shots_Def^/?y20;
  !!FU&y20=0:E;                         [exit if no extra shot is available]
  !!SN&y2=0:W^ACM_Marksmen_Shots_Att^/d-1; [reduce number of extra shots by 1]
  !!SN&y2=1:W^ACM_Marksmen_Shots_Def^/d-1; [reduce number of extra shots by 1]

  !!BMx2:I?y30;
  !!FU(ACM_GetRandomLivingStackFromSide):Py30/?y10/(NO_STACK)/(TRUE)/(FALSE);
  !!FU(BattleStack_Shoot)&y10>(NO_STACK):Py1/y10; [call fct from stdlib that gives extra attack and pass attacker and target stack]
!!en;

!?FU(OnCombatRound)&v997>=0;
Refills Marksman extra shots depending on kill count and mastery
!!SN:W^ACM_Marksmen_Shots_Att^/0;       [resets to no extra shot at round start]
!!SN:W^ACM_Marksmen_Shots_Def^/0;       [resets to no extra shot at round start]

!!BA:H0/?y2;                            [Attacker]
!!FU(Check_Com_Masteries):Py2/?y3/?y20/0/?y10; [Pass Hero Number and return current com class]
!!if&y10=22;
  !!FU(Set_Com_Battle_Description):Py10/y2/y20/0/y3/0/0/0/?y21; [get amount of additional targets to shot in y21]
  !!SN:W^ACM_Marksmen_Shots_Att^/y21;   [starts every battle round with one extra shot]
!!en;

!!BA:H1/?y2; !!FU&y2<0:E;               [Defender]
!!FU(Check_Com_Masteries):Py2/?y3/?y20/0/?y10; [Pass Hero Number and return current com class]
!!if&y10=22;
  !!FU(Set_Com_Battle_Description):Py10/y2/y20/0/y3/0/1/0/?y21; [get amount of additional targets to shot in y21]
  !!SN:W^ACM_Marksmen_Shots_Def^/y21;   [starts every battle round with one extra shot]
!!en;

// Get a valid stack from a side
; by Archer30
; This is better than FU(AC_Function_55) as it consideres stack to ignore/living status, also possible to ignore blind/stoned/paralysed stacks
!?FU(ACM_GetRandomLivingStackFromSide);
!#VA(side:x);                           [Side of the stack]
!#VA(result:x);                         [Return value. Random stack number of the side]
!#VA(exceptionStack:x);                 [Optional. Stack number not counting as a valid result]
!#VA(ignoreControlled:x);               [Optional. Boolean. Ignore controlled (Blind, Stone and Paralysis) units]
!#VA(isFromArmy:x);                     [Optional. Boolean. Value for setting whether only stacks from a hero's army are considered as valid]

; Initialization
!!VR(result):S(NO_STACK);
!!FU:A?(numArgs:y);
!!VR(exceptionStack)&(numArgs)<3:S(NO_STACK);
!!VR(ignoreControlled)&(numArgs)<4:S(FALSE);
!!VR(isFromArmy)&(numArgs)<5:S(FALSE);

; Set up a local array for all the living stacks of the side
!!FU(NewIntArray):P?(livingStacks:y);    [Create the array]
!!VR(firstStack:y):S(side) *(BATTLE_STACKS_PER_SIDE);
!!VR(lastStack:y):S(firstStack) +20;

; Loop through all the stacks, add any valid stack number to the array
!!re i/(firstStack)/(lastStack);
  !!BMi:T?(type:y) N?(num:y);

  !!if&(type)>(NO_MON)/(type)<>(MON_ARROW_TOWERS)/(num)>0/i<>(exceptionStack);
    !!if&(ignoreControlled);
      !!BMi:G(SPELL_BLIND)/?(blindTurns:y)/d G70/?(stoneTurns:y)/d G74/?(paralyzeTurns:y)/d;
      !!co|(blindTurns)>0/(stoneTurns)>0/(paralyzeTurns)>0;
    !!en;

    !!if&(isFromArmy);
      !!BMi:O?(armySlot:y);
      !!FU(Array_Push)&(armySlot)>-1:P(livingStacks)/i; [Push the found stack id to the end of the array]
    !!el;
      !!FU(Array_Push):P(livingStacks)/i;
    !!en;
  !!en;
!!en;

; Check if the array has at least one item
!!SN:M(livingStacks)/?(size:y);

; Return a random item from he array if applicable
!!if&(size)>0;
  !!FU(Array_Shuffle):P(livingStacks);  [Shuffle the array]
  !!FU(Array_Pop):P(livingStacks)/?(result); [Get the last item of the array and remove the item from the array]
!!en;


***************************Retaliator Commander*****************************************************
*Has increased retaliation damage based on kill count

!?MF1;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4456676;           [Only run when melee or strikes all enemies around damage type]
  !!BG:A?y1;                            [Aktion in y1]
  !!if&y1=6;                            [Attack]
    !!SN:W^ACM_Now_Retail^/0;           [reset flag]
    !!BG:N?y1;                          [Attacking Stack]
    !!MF:N?y4;                          [damage receiving stack]
    !!SN&y1=y4:W^ACM_Now_Retail^/1;     [this is retail attack]
    !!SN:W^Com_Retaliation_Attacking_Stack^/?y50;
    !!VRy1&y4=y1/y50>=0/y50<=41:Sy50;   [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
    !!SN:W^Com_Retaliation_Attacking_Stack^/y4;    
    !!SN:W^ACM_Now_Retail^/?y30;    
    !!if&y4>=0/y4<=41/y30=1;            [if any valid battlestack]
      !!BMy1:T?y2 I?y8;                 [Creature Type and Side index as for heroes (0:left, 1:right)]      
      !!if&y2>=174/y2<=191;             [if any commander]
        !!BA:Hy8/?y99;                  [Get hero by side]
        !!FU&y99<0:E;                   [Exit if no hero]
        !!FU(Check_Com_Masteries):Py99/0/?y15/0/?y10; [Pass Hero Number and return current com class]
        !!FU&y10<>13:E;                 [exit if the wrong class]
        !!FU(Set_Com_Battle_Description):Py10/y99/y15/0/0/0/y8/0/?y16; [get value of damage increase from fct]        
        !!VRy16:+100;                   [1% retail damage increase per kill count]
        !!MF:F?y6;                      [Get damage in y6]        
        !!VRy6:*y16:100;                [Increase damage]
        !!MF&y6>=0:Fy6;                 [apply new damage]        
      !!en;
    !!en;
  !!en;
!!en;


*Retaliator commander gets one additional 50% chance for extra retaliation strike with mastery
!?FU(ACM_OnAfterMelee); 

!!SN:W^ACM_Now_Retail^/?y30; !!FU&y30<>1:E; [Exit if flag not active]
!!VRy1:S0R1; !!FU&y1=0:E;               [Only 50% chance to trigger event]
!!BA:Q?y1; !!FU&y1=1:E;                 [Exit in Quick Combat]
!!VRy1:Sx1;                             [acting stack]
!!BMx1:I?y2;                            [Acting Side Monster]
!!BA:Hy2/?y99;                          [Current Hero]
!!FU&y99<0:E;                           [Exit if none]
!!BMx1:T?y3 P?y9;                       [Get Creature Number and current battlefield position]
!!if&y3>=174/y3<=191;                   [if any commander]
  !!FU(Check_Com_Masteries):Py99/?y15/0/0/?y10; [Pass Hero Number and return current com class]
  !!FU|y10<>13/y15=0:E;                 [exit if the wrong class or mastery not enabled]
  !!SN:W^ACM_Com_Retail_Counter^/?y30;  [check flag]
  !!SN:W^ACM_Com_Retail_Counter^/0;     [reset flag]
  !!FU(ACM_BattleStack_MeleeAttack)&y30>0:Px1/x2/0; [make the stack attack another stack in melee combat]
!!en;

!?BG0;
!!SN:W^ACM_Com_Retail_Counter^/1;       [reset flag]


// Initiate a melee attack
!?FU(ACM_BattleStack_MeleeAttack);      [by Hawaiing]
!#VA(atkStack:x) (defStack:x);
!#VA(direction:x);                      [0 for upper, 1 for forward and 2 for lower]

!!UN:C(COMBAT_MANAGER)/(UNC_INT)/?(value:y);
!!VR(value2:x):S(atkStack) *1352 +21708 +(value);
!!VR(value3:x):S(defStack) *1352 +21708 +(value);
!!SN:E4461360/2/(value2)/(value3)/(direction);


***************************Avenger Commander********************************************************
*Absorbs damage applied to surrounding units and transfers it to the commander
!?MF1;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676;[Only run when melee or shooting damage or strikes all enemies around damage type]
  !!BG:A?y1;                            [Aktion in y1]
  !!if&y1=6|y1=7;                       [Attack or Shoot]
    !!BG:N?y1;                          [Attacking Stack]
    !!MF:N?y4 F?y50;                    [damage receiving stack and damage applied]
    !!if&y4>=0/y4<=41;                  [if any valid battlestack]
      !!BMy4:I?y7 P?y20;                [Creature Type and Side index as for heroes (0:left, 1:right)]
      !!BA:Hy7/?y99;                    [Current Hero]
      !!FU&y99<0:E;                     [Exit if none]
      !!re i/0/5;                       [loop target stack surrounding]
        !!FU(ACM_Calc_neighbouring_hex_2):Py20/i/?y30; [Pass position and return first neighbouring hex field]
        !!if&y30>=0/y30<=186;
          !!BU:Ey30/?y8;                [If no alive monster is at that position, a value of -1 will be returned]
          !!if&y8>=0/y8<=41;            [if a valid creature ]
            !!BMy8:I?y11 T?y9;          [get side and creature flag]
            !!if&y9>=174/y9<=191/y11=y7;[if any commander and same team]
              !!FU(Check_Com_Masteries):Py99/0/?y15/0/?y10; [Pass Hero Number and return current com class]
              !!FU&y10<>23:E;           [exit if the wrong class or mastery not enabled]
              !!FU(Set_Com_Battle_Description):Py10/y99/y15/0/0/0/y11/0/?y60; [get value of damage increase from fct]
              !!VRy60:*-1+100;          [calc rest percentage]
              !!VRy60&y60<10:S10;       [damage reduction cannot be below 90%]
              !!VRy50:*y60:100;         [reduce the incoming damage by a certain percentage]
              !!BMy8:H?y12 L?y13;       [Get current HP of commander]
              !!VRy15:Sy12-y13;         [calc available rest life]
              !!SN:W^Avenger_Com_Mastery_Flag^/?y40; [check mastery flag]
              !!if&y50>y15/y40=1;       [If damage is bigger than rest life and mastery active]
                !!SN:T^AC_Misc.ACM_Com_Avenger_Revive^/?z1; !!SN:Iz1/?z1; [get text] 
                !!BU&i^battle_isVisible^:Mz1;
                !!SN:W^Avenger_Com_Mastery_Flag^/0; [set flag to zero after first commander would drop below zero life]
                !!VRy50:Sy15-1;         [set damage to just nearly kill commander]
              !!en;
              !!BMy8:Ky50;              [Apply damage to commander stack]
              !!MF:F1;                  [apply 1 damage to attacked unit. for some reason the battle log says always 1 damage]
              !!SN:T^AC_Misc.ACM_Com_Avenger_Absorb^/?z1; !!SN:Iz1/?z1; [get text]
              !!BU&i^battle_isVisible^:Mz1; [print message in battle log how much damage was saved by commander]
              !!FU(ACM_DrawActionPlay):P;
              !!FU(ACM_ExecutePhoenixResurrection):P;
            !!en;
          !!en;
        !!en;  
      !!en;
    !!en;
  !!en;
!!en;


******************************Arch Mage and Warden Commander****************************************
Arch Mage or Warden commander class can select different spells during combat by 
CTRL+Left click on commander to change the spell to cast 
; Archer30: Note that AI doesn't know how to use it. The script is also not compatible with MP
; WARNING: For some reason, the spell damage on two sides in MP is DIFFERENT. This must be fixed ASAP. 
; I can't as I don't how spell damage is calculated in ACM. It will be Perry to fix.

!?FU(OnBattleScreenMouseClick)&i^key_ctrl^/i^battle_round^>=0/i^mouse_battleHex^>=1/i^mouse_battleHex^<=185/i^battle_isActingSideUiUser^; [i^battle_round^>=0 is important not to crash in tactics phase]
!!BU:Ei^mouse_battleHex^/?y2;
!!FU&y2=-1:E;                         [get monster ID at position and exit if no monster]

; Exit if not current stack
!!FU&y2<>i^battle_current_stack^:E;

!!BMy2:I?y4;
!!BHy4:N?y5;                          [Get hero or commander ID]
!!FU&y5<=(NO_HERO):E;

!!COy5:T?y31;

!!if&y4=(BATTLE_LEFT);
  !!VRy31:+(MON_COMMANDER_FIRST_A);
!!el;
  !!VRy31:+(MON_COMMANDER_FIRST_D);
!!en;

!!BMy2:T?y3;                          [get monster type and side index]

!!FU(ACM_GetActualStackSide):Py2/?y30;[Get the actual side of the stack, reverse the side if hypnotized]

!!if&y3=y31/y30=i^battle_current_side^/y4=y30; [if any commander and a hero, the same side with the current side]
  !!FU(Check_Com_Masteries):Py5/?y10/?y11/?y12/?y13; [Pass Hero Number and return commander class]

  !!if|y13=(ACM_CMD_CLASS_ARCHMAGE)/y13=(ACM_CMD_CLASS_WARDEN);
    !!CM:R0;                            [Disable standard reaction]

    !!SN:W^ACM_Com_Stack_ID^/y2;        [set stack ID to be used later]

    !!FU(ACM_Select_Com_Spell):Py5/1;   [pass hero ID and combat battle status]

    ; Set up the outcome of setting up commander spell
    !!VRy32:Si^battle_current_side^ X(TRUE);
    !!IP:Di^battle_owner_%y32^;
    !!FU(ACM_SetUpCommanderSpellOutcome):Py2/y5/i^acm_cmdSpell_%y5^ Dy2/y5/i^acm_cmdSpell_%y5^ ;
  !!en;
!!en;



!?FU(ACM_Select_Com_Spell);
!#VA(hero:x) (mode:x);

!!VRy99:S(hero);                        [y99 holds current Hero ID]
!!FU(Check_Com_Masteries):Py99/0/0/0/?y10; [Pass Hero Number and return commander class]
!!FU&y10<>14/y10<>24:E;

!!SN:W^ACM_Commander_Hero_ID^/y99;  
!!DL278:N^Com_Spell.txt^;               [parse dialogue]

!!if&y10=14;
!!VRy11:S11; !!VRy12:S13; !!VRy13:S15; !!VRy14:S16; !!VRy15:S17; !!VRy16:S18; !!VRy17:S19; [Set spell IDs for offensive caster]
!!VRy18:S20; !!VRy19:S21; !!VRy20:S22; !!VRy21:S23; !!VRy22:S24; !!VRy23:S25; !!VRy24:S26; 
!!en;

!!if&y10=24;
!!VRy11:S27; !!VRy12:S28; !!VRy13:S29; !!VRy14:S35; !!VRy15:S38; !!VRy16:S39; !!VRy17:S48; [Set spell IDs for utility caster]
!!VRy18:S53; !!VRy19:S54; !!VRy20:S59; !!VRy21:S60; !!VRy22:S62; !!VRy23:S65; !!VRy24:S66; 
!!en;

!!re i/1/14;
  !!VRy70:S10+i;
  !!DL278:Ai/4/yy70/1;                  [Picture of Offensive Spell]
!!en;

!!SN:T^AC_Misc.Commander_Caster_DL^/?z60; !!DL278:A60/3/z60/1; [heading additional game options]

loop to set hint text with spell name
!!re i/1/14;
  !!VRy70:S10+i;
  !!VRy71:S39+i;
  !!SN:H^spell^/yy70/(SPELL_TEXT_NAME)/?zy71; 
  !!DL278:Hi/y71;
!!en;

!!SN:T^AC_Misc.Commander_Opt_Hint_Play^/?z61; !!DL278:H30722/61;

!!FU(ACM_UpdateCommanderSpellTable):Py99/y10;

!!VRi^acm_cmdSpell_mode^:S(mode);

!!DL278:S;                              [Show Dialogue]

!!VRi^acm_cmdSpell_mode^:S(NULL);


!?DL&v998=278/v1000=14;[right click on the options to show text for upgrade and description]
!!VRy30:S(FALSE);
!!VRy30&v999>=1/v999<=14:S(TRUE);
!!VRy30&v999>=40/v999<=53:S(TRUE);
!!FU&y30=(FALSE):E;

!!VRy31:Sv999;
!!VRy31&v999>=40:-39;

!!SN:W^ACM_Commander_Hero_ID^/?y99;
!!FU(Check_Com_Masteries):Py99/0/0/0/?y10/0/0/0/0/0/?y71; [Pass Hero Number and return commander class and spell efficiency]
!!FU&y10<>14/y10<>24:E; Exit if not Archmage or Warden class

!!if&y10=14;
!!VRy11:S11; !!VRy12:S13; !!VRy13:S15; !!VRy14:S16; !!VRy15:S17; !!VRy16:S18; !!VRy17:S19; [Set spell IDs for offensive caster]
!!VRy18:S20; !!VRy19:S21; !!VRy20:S22; !!VRy21:S23; !!VRy22:S24; !!VRy23:S25; !!VRy24:S26; 
!!en;

!!if&y10=24;
!!VRy11:S27; !!VRy12:S28; !!VRy13:S29; !!VRy14:S35; !!VRy15:S38; !!VRy16:S39; !!VRy17:S48; [Set spell IDs for utility caster]
!!VRy18:S53; !!VRy19:S54; !!VRy20:S59; !!VRy21:S60; !!VRy22:S62; !!VRy23:S65; !!VRy24:S66; 
!!en;

!!VRy1&y31=1:Sy11; !!VRy1&y31=2:Sy12; !!VRy1&y31=3:Sy13; !!VRy1&y31=4:Sy14; !!VRy1&y31=5:Sy15; !!VRy1&y31=6:Sy16; !!VRy1&y31=7:Sy17;
!!VRy1&y31=8:Sy18; !!VRy1&y31=9:Sy19; !!VRy1&y31=10:Sy20; !!VRy1&y31=11:Sy21; !!VRy1&y31=12:Sy22; !!VRy1&y31=13:Sy23; !!VRy1&y31=14:Sy24;

!!FU(H3_Set_Spell_Descriptions_Orginal):P;
!!SN:H^spell^/y1/(SPELL_TEXT_DESCR)/?z1;

; non-battle (mising detailed info here, should be improved)
!!if&i^acm_cmdSpell_mode^=0;
  !!IF:M0/(MSG_TYPE_POPUP)/^%Z1^;
; battle
!!el;
  !!FU(ACM_Calc_Commander_Spell_damage):Py99/?y50/y1/1/0/0/?y51/?y52;
x1=Hero Number, x2=returns spell damage from commander, x3 Spell Number, x4=In Fight 1  0=No Fight, x5=Target Creature, X6=Crit(1) or No Crit(0)
x7=spell points x8=spell damage modifier

  !!SN:T^AC_Misc.ACM_Com_Buy_Spell_3^/?z2; !!SN:Iz2/?z2;

  !!if&y10=24;                          [Set text for spell efficiency in case of Warden Caster]    
    
    !!VRy70&y1=27:Sy71:5; !!VRy70:F20/80;
    !!VRz2&y1=27:S^
    Melee damage reduction is: {~r}%Y70%{~}
    Scales with 1% per 5 spell modifier (%Y71)^;

    !!VRy70&y1=28:Sy71:5; !!VRy70:F20/80;
    !!VRz2&y1=28:S^
    Range damage reduction is: {~r}%Y70%{~}
    Scales with 1% per 5 spell modifier (%Y71)^;

    !!VRy70&y1=29:Sy71:10 +8; !!VRy70:F10/90;
    !!VRz2&y1=29:S^
    Returns damage: {~r}%Y70%{~}
    Scales with 8+1% per 10 spell modifier (%Y71)^;

    !!VRy70&y1=38:Sy71*10;
    !!VRz2&y1=38:S^
    Resurrects a total of: {~r}%Y70{~}HP
    Scales with 10HP per 1 spell modifier (%Y71)^;

    !!VRy70&y1=39:Sy71*10;
    !!VRz2&y1=39:S^
    Animates a total of: {~r}%Y70{~}HP
    Scales with 10HP per 1 spell modifier (%Y71)^;

    !!VRy70&y1=48:Sy71:40;
    !!VRz2&y1=48:S^
    Increases stats by: {~r}%Y70{~}
    Scales with +1 per 40 spell modifier (%Y71)^;

    !!VRy70&y1=53:Sy71:30;
    !!VRz2&y1=53:S^
    Increases speed by: {~r}%Y70{~}
    Scales with +1 per 30 spell modifier (%Y71)^;

    !!VRy70&y1=54:Sy71:4 -100 *-1; !!VRy70:F20/80;
    !!VRz2&y1=54:S^
    Slows down until: {~r}%Y70{~}
    Scales with 1% per 4 spell modifier (%Y71)^;

    !!VRy70&y1=60:Sy71*20;
    !!VRz2&y1=60:S^
    Total HP: {~r}%Y70{~}
    Scales with +20HP per 1 spell modifier (%Y71)^;

    !!VRy70&y1=66:Sy71:10 +5;
    !!VRz2&y1=66:S^
    Summons Fire Elementals: {~r}%Y70{~}
    Scales with 5 +1 element per 10 spell modifier (%Y71)^;

    !!VRz2&y1=35:S^
    Casts at advanced level.^;
    !!VRz2&y1=59:S^
    Casts at advanced level.^;
    !!VRz2&y1=62:S^
    Casts at advanced level.^;
    !!VRz2&y1=65:S^
    Casts at advanced level.^;
  !!en;

  !!IF&y10=14:M0/(MSG_TYPE_POPUP)/^%Z1 %Z2^; [Show Spell Description for Archmage]
  !!IF&y10=24:M0/(MSG_TYPE_POPUP)/^%Z1 %Z2^; [Show Spell Description for Warden]
!!en;


!?DL&v998=278/v999>=1/v999<=14/v1000=13;[Left click on the spell pictures icons to purchase the spell]
!!SN:W^ACM_Commander_Hero_ID^/?y99;
!!FU(Check_Com_Masteries):Py99/0/?y8/0/?y10; [Pass Hero Number and return commander class]
!!FU&y10<>14/y10<>24:E;

!!FU(ACM_BuyCommanderSpell):Py99/y8/y10/v999;


!?FU(ACM_BuyCommanderSpell);
!#VA(hero:x) (killCount:x) (cmdClass:x) (item:x);

!!VR(item)&(item)>=40:-39;

!!if&(cmdClass)=14;
  !!VRy11:S11; !!VRy12:S13; !!VRy13:S15; !!VRy14:S16; !!VRy15:S17; !!VRy16:S18; !!VRy17:S19; [Set spell IDs for offensive caster]
  !!VRy18:S20; !!VRy19:S21; !!VRy20:S22; !!VRy21:S23; !!VRy22:S24; !!VRy23:S25; !!VRy24:S26; 
!!en;

!!if&(cmdClass)=24;
  !!VRy11:S27; !!VRy12:S28; !!VRy13:S29; !!VRy14:S35; !!VRy15:S38; !!VRy16:S39; !!VRy17:S48; [Set spell IDs for utility caster]
  !!VRy18:S53; !!VRy19:S54; !!VRy20:S59; !!VRy21:S60; !!VRy22:S62; !!VRy23:S65; !!VRy24:S66; 
!!en;

!!VRy1&(item)=1:Sy11; !!VRy1&(item)=2:Sy12; !!VRy1&(item)=3:Sy13; !!VRy1&(item)=4:Sy14; !!VRy1&(item)=5:Sy15; !!VRy1&(item)=6:Sy16; !!VRy1&(item)=7:Sy17;
!!VRy1&(item)=8:Sy18; !!VRy1&(item)=9:Sy19; !!VRy1&(item)=10:Sy20; !!VRy1&(item)=11:Sy21; !!VRy1&(item)=12:Sy22; !!VRy1&(item)=13:Sy23; !!VRy1&(item)=14:Sy24;


!!SN:W^Com_Attack_Caster_%(hero)_%Y1_purchased^/?y2; [Check if options have already been activated]

; If it's not purchased, check if the spell is the default spell of commander. If it is, treat the spell as purchased.
!!if&y2=0;
  !!CO(hero):T?y30;
  !!FU(ACM_GetDefaultCommanderSpell):Py30/?y31;
  !!VRy2&y1=y31:S(TRUE);
!!en;

!!if&y2=0;
  !!SSy1:L?y3;                          [Get spell level to determine costs]
  !!VRy4&y3=1:S5000;                    [Level 1 spells cost 5000 gold]
  !!VRy4&y3=2:S8000;
  !!VRy4&y3=3:S10000;
  !!VRy4&y3=4:S15000;
  !!VRy4&y3=5:S20000;                   [Level 5 spells cost 20000 gold]

required kill count per level
  !!VRy7&y3=1:S10;                      [Level 1 spells require 10 kill count to learn]
  !!VRy7&y3=2:S20;
  !!VRy7&y3=3:S35;
  !!VRy7&y3=4:S55;
  !!VRy7&y3=5:S75;                      [Level 5 spells require 70 kill count to learn]

  !!SN:T^AC_Misc.ACM_Com_Buy_Spell^/?z2; !!SN:Iz2/?z2; [get text]
  !!SN:T^AC_Misc.ACM_Com_Buy_Spell_1^/?z3; !!SN:Iz3/?z3;
  !!SN:T^AC_Misc.ACM_Com_Buy_Spell_2^/?z4; !!SN:Iz4/?z4;  
  !!IF:Q1^%Z2^;     [Show question to player]
  !!FU&-1:E;

  !!HE(hero):O?y5;                         [get hero owner]
  !!OW:Ry5/6/?y6;                       [get current player gold]
  !!IF&y6<y4:M^%Z3^; !!FU&y6<y4:E;      [gold]
  !!IF&(killCount)<y7:M^%Z4^; !!FU&(killCount)<y7:E;      [kill count]

  !!SN:P^Gold01^;

  !!SN:W^Com_Attack_Caster_%(hero)_%Y1_purchased^/1; [Set spell to purchased if enough gold and kill count and confirm clicked]
  !!OW:Ry5/6/d-y4;        [reduce player gold]
!!en;


!?DL&v998=278/v999>=40/v999<=53/v1000=13;[LMB on the options icons to select spell]
!!SN:W^ACM_Commander_Hero_ID^/?(hero:y);
!!FU(Check_Com_Masteries):P(hero)/0/?(killCount:y)/0/?(cmdClass:y); [Pass Hero Number and return commander class]
!!FU&(cmdClass)<>14/(cmdClass)<>24:E;

!!FU(ACM_GetClickedCommanderSpell):Pi^mouse_item^/(cmdClass)/?(clickedSpell:y);

!!CO(hero):T?(cmdType:y);
!!FU(ACM_GetDefaultCommanderSpell):P(cmdType)/?(cmdDefaultSpell:y);

; If the clicked spell is not bought, and not default spell, propose to buy
!!if|i^Com_Attack_Caster_%(hero)_%(clickedSpell)_purchased^<>(TRUE)/(clickedSpell)<>(cmdDefaultSpell);
  !!FU(ACM_BuyCommanderSpell):P(hero)/(killCount)/(cmdClass)/i^mouse_item^;
!!en;

!!if|i^Com_Attack_Caster_%(hero)_%(clickedSpell)_purchased^/(clickedSpell)=(cmdDefaultSpell);
  ; If clicked on a selected spell, disable it (restore the chosen spell to default)
  !!if&i^acm_cmdSpell_%(hero)^=(clickedSpell);
    !!VRi^acm_cmdSpell_%(hero)^:S(cmdDefaultSpell);
  !!el;
    !!VRi^acm_cmdSpell_%(hero)^:S(clickedSpell);
  !!en;

  !!SN:P^Button.wav^;                     [Play Sound]

  ; Update checkmarks
  !!FU(ACM_UpdateCommanderSpellTable):P(hero)/(cmdClass);
!!en;


Close Dialouge
!?DL&v998=278/v999=30722/v1000=13;

!!SN:W^ACM_Commander_Hero_ID^/?y99;
!!SN&i^acm_cmdSpell_mode^=1:W^ACM_Com_Stack_ID^/?y4; [Set up stack Id - battle only]
!!FU(Check_Com_Masteries):Py99/0/0/0/?y10; [Pass Hero Number and return commander class]
!!FU&y10<>14/y10<>24:E;

!!DL:C1;                                [CLose dlg]


; Archer30: Is this needed at all? I will block weird hooks from Amethyst anyway. Long live BM:U4.
*this code below fixes the problem with not beeing able to select spells for commander classes when played with TUM.
But it requires newer amethyst pluing version, which is currently not officialy available, meaning we must wait for proper TUM update.

*!SN:F^PluginExists^/^amethyst2_4^;     [Check for amethyst Plugin]
*!if&v1=1;
  
  *!if&y98>=27/y98<=69;                 [For setting buff spell IDs]
    *!MA:Wy97/^        
            Spell 1=10
            Spell 2=2
            Spell 3=1
            CreatureSpellPowerMultiplier=0
            CreatureSpellPowerAdder=6
            CastsSpell=%Y98
            ^; 
  *!en;  
  *!if&y98>=11/y98<=26;                 [For setting damage spell IDs]
    *!MA:Wy97/^        
            Spell 1=8
            Spell 2=7
            Spell 3=2
            CreatureSpellPowerMultiplier=0
            CreatureSpellPowerAdder=6
            CastsSpell=%Y98            
            ^; 
  *!en;        
*!en;


; Archer30: Is this needed at all? I will block weird hooks from Amethyst anyway. Long live BM:U4.
!?FU(OnAfterBattleUniversal);
!!FU:E;                                 [temporaily disabled until newer plugin version available]
*restore default spells for commanders if they were changed for commander class and only if playing with Amethyst

!!SN:F^PluginExists^/^amethyst2_4^;     [Check for amethyst Plugin]
!!if&v1=1;                              [If enabled]
  !!FU(Restore_Default_Com_Spells_Buff):P174/37; [Paladin Cure Spell]
  !!FU(Restore_Default_Com_Spells_Buff):P183/37; [Paladin Cure Spell]

  !!FU(Restore_Default_Com_Spells_Buff):P175/27; [Hierophant Shield Spell]
  !!FU(Restore_Default_Com_Spells_Buff):P184/27; [Hierophant Shield Spell]

  !!FU(Restore_Default_Com_Spells_Dmg):P176/17; [Temple Guardian Lightning Bolt Spell]
  !!FU(Restore_Default_Com_Spells_Dmg):P185/17; [Temple Guardian Lightning Bolt Spell]

  !!FU(Restore_Default_Com_Spells_Dmg):P177/21; [Succubus Fireball Spell]
  !!FU(Restore_Default_Com_Spells_Dmg):P186/21; [Succubus Fireball Spell]

  !!FU(Restore_Default_Com_Spells_Buff):P178/39; [Soul Eater Animate Dead Spell]
  !!FU(Restore_Default_Com_Spells_Buff):P187/39; [Soul Eater Animate Dead Spell]

  !!FU(Restore_Default_Com_Spells_Dmg):P179/15; [Brute Magic Arrow Spell]
  !!FU(Restore_Default_Com_Spells_Dmg):P188/15; [Brute Magic Arrow Spell]

  !!FU(Restore_Default_Com_Spells_Buff):P180/43; [Ogre Leader Bloodlust Spell]
  !!FU(Restore_Default_Com_Spells_Buff):P189/43; [Ogre Leader Bloodlust Spell]

  !!FU(Restore_Default_Com_Spells_Buff):P181/53; [Shaman Haste Spell]
  !!FU(Restore_Default_Com_Spells_Buff):P190/53; [Shaman Haste Spell]

  !!FU(Restore_Default_Com_Spells_Buff):P182/69; [Astral Spirit Air Elemental Spell]
  !!FU(Restore_Default_Com_Spells_Buff):P191/69; [Astral Spirit Air Elemental Spell]
!!en;


!?FU(Restore_Default_Com_Spells_Buff);
[For setting buff spell IDs]
!!MA:Wx1/^        
        Spell 1=10
        Spell 2=2
        Spell 3=1
        CreatureSpellPowerMultiplier=0
        CreatureSpellPowerAdder=6
        CastsSpell=%X2
        ^; 

!?FU(Restore_Default_Com_Spells_Dmg);
[For setting damage spell IDs]
!!MA:Wx1/^        
        Spell 1=8
        Spell 2=7
        Spell 3=2
        CreatureSpellPowerMultiplier=0
        CreatureSpellPowerAdder=6
        CastsSpell=%X2            
        ^; 


; Function to update commander spell table
; by Archer30
!?FU(ACM_UpdateCommanderSpellTable);
!#VA(hero:x) (cmdClass:x);

!!re i/40/53;
  !!FU(ACM_GetClickedCommanderSpell):Pi/(cmdClass)/?(spell:y);

  !!if&i^acm_cmdSpell_%(hero)^=(spell);
    !!DL278:Ai/(DLG_CMD_SET_DEF_FRAME)/1/1;
  !!el;
    !!DL278:Ai/(DLG_CMD_SET_DEF_FRAME)/0/1;
  !!en;
!!en;

; Function to get the spell Id of the clicked DL item
; by Archer30
!?FU(ACM_GetClickedCommanderSpell);
!#VA(item:x) (class:x) (result:x);

!!VR(result):S0;

; Convert clicked item id
!!VR(item)&(item)>=40/(item)<=53:-39;

; Archmage
!!if&(class)=14;
  !!VR(result)&(item)=1:S11; 
  !!VR(result)&(item)=2:S13; 
  !!VR(result)&(item)=3:S15; 
  !!VR(result)&(item)=4:S16; 
  !!VR(result)&(item)=5:S17; 
  !!VR(result)&(item)=6:S18; 
  !!VR(result)&(item)=7:S19; 
  !!VR(result)&(item)=8:S20; 
  !!VR(result)&(item)=9:S21; 
  !!VR(result)&(item)=10:S22; 
  !!VR(result)&(item)=11:S23; 
  !!VR(result)&(item)=12:S24; 
  !!VR(result)&(item)=13:S25; 
  !!VR(result)&(item)=14:S26; 
; Warden
!!el;
  !!VR(result)&(item)=1:S27; 
  !!VR(result)&(item)=2:S28; 
  !!VR(result)&(item)=3:S29; 
  !!VR(result)&(item)=4:S35; 
  !!VR(result)&(item)=5:S38; 
  !!VR(result)&(item)=6:S39; 
  !!VR(result)&(item)=7:S48; 
  !!VR(result)&(item)=8:S53; 
  !!VR(result)&(item)=9:S54; 
  !!VR(result)&(item)=10:S59; 
  !!VR(result)&(item)=11:S60; 
  !!VR(result)&(item)=12:S62; 
  !!VR(result)&(item)=13:S65; 
  !!VR(result)&(item)=14:S66; 
!!en;

; Function for setting up commander spell table outcome on the battlefield - crucial for MP support
; Here we didn't set i^acm_cmdSpell_%(hero)^ nor the gold. Could it be a problem?
; by Archer30
!?FU(ACM_SetUpCommanderSpellOutcome);
!#VA(stack:x) (hero:x) (spell:x);

!!BM(stack):U4/(spell);                 [Set spell to cast for commander stack]

; Function to set (correct) default commander spell variable of a hero
; by Archer30
!?FU(ACM_FixCommanderSpellData);
!#VA(hero:x);

; Exit if the current spell is bought
!!VR(currSpell:y):Si^acm_cmdSpell_%(hero)^;
!!FU&i^Com_Attack_Caster_%(hero)_%(currSpell)_purchased^:E;

; Exit if the spell is the default spell of the commander
!!CO(hero):T?(cmd:y);
!!FU(ACM_GetDefaultCommanderSpell):P(cmd)/?(defaultSpell:y);
!!FU&(currSpell)=(defaultSpell):E;

!!VRi^acm_cmdSpell_%(hero)^:S(defaultSpell);

; Function to get the default spell of a commander
; by Archer30
; Here we use commander mon Id to get correct result even when a hero has multiple commanders by chance
!?FU(ACM_GetDefaultCommanderSpell);
!#VA(mon:x);                            [commander mon Id or 0-8]
!#VA(result:x);

!!if|(mon)=(MON_PALADIN_A)/(mon)=(MON_PALADIN_D)/(mon)=0;
  !!VR(result):S(SPELL_CURE);
!!el|(mon)=(MON_HIEROPHANT_A)/(mon)=(MON_HIEROPHANT_D)/(mon)=1;
  !!VR(result):S(SPELL_SHIELD);
!!el|(mon)=(MON_TEMPLE_GUARDIAN_A)/(mon)=(MON_TEMPLE_GUARDIAN_D)/(mon)=2;
  !!VR(result):S(SPELL_LIGHTNING_BOLT);
!!el|(mon)=(MON_SUCCUBUS_A)/(mon)=(MON_SUCCUBUS_D)/(mon)=3;
  !!VR(result):S(SPELL_FIREBALL);
!!el|(mon)=(MON_SOUL_EATER_A)/(mon)=(MON_SOUL_EATER_D)/(mon)=4;
  !!VR(result):S(SPELL_ANIMATE_DEAD);
!!el|(mon)=(MON_BRUTE_A)/(mon)=(MON_BRUTE_D)/(mon)=5;
  !!VR(result):S(SPELL_MAGIC_ARROW);
!!el|(mon)=(MON_OGRE_LEADER_A)/(mon)=(MON_OGRE_LEADER_D)/(mon)=6;
  !!VR(result):S(SPELL_BLOODLUST);
!!el|(mon)=(MON_SHAMAN_A)/(mon)=(MON_SHAMAN_D)/(mon)=7;
  !!VR(result):S(SPELL_HASTE);
!!el|(mon)=(MON_ASTRAL_SPIRIT_A)/(mon)=(MON_ASTRAL_SPIRIT_D)/(mon)=8;
  !!VR(result):S(SPELL_AIR_ELEMENTAL);
!!en;


***************************Fighter Mage Commander***************************************************
*Deals on hit damage based on Magic Power and Kill count, after a cast the next attack deals double damage

!?MF1;
!!FU:E; Test
!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676;[Only run when melee or shooting damage or strikes all enemies around damage type]
  !!BG:A?y1;                            [Aktion in y1]
  !!if&y1=6|y1=7;                       [Attack or Shoot]
    !!BG:N?y1;                          [Attacking Stack]
    !!MF:N?y4;                          [damage receiving stack]
    !!SN:W^Com_FighterMage_Attacking_Stack^/?y50;
    !!VRy1&y4=y1/y50>=0/y50<=41:Sy50;   [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
    !!SN:W^Com_FighterMage_Attacking_Stack^/y4;    
    !!if&y4>=0/y4<=41;                  [if any valid battlestack]
      !!BMy1:T?y2 I?y8;                 [Creature Type and Side index as for heroes (0:left, 1:right)]
      !!if&y2>=174/y2<=191;             [if any commander]
        !!BA:Hy8/?y99;                  [Get hero by side]
        !!FU&y99<0:E;                   [Exit if no hero]
        !!FU(Check_Com_Masteries):Py99/0/?y15/0/?y10/0/0/0/0/0/?y50; [Pass Hero Number and return current com class and Spell Modifier]
        !!FU&y10<>14:E;                 [exit if the wrong class]
        !!FU(Calc_Fighter_On_Hit_Damage):Py99/y15/?y16/y8/y50; [Pass Hero ID and Kill Count returns damage]
        !!MF:F?y6;                      [Get damage in y6]
        !!VRy6:+y16;                    [Increase damage]
        !!MF&y6>=0:Fy6;                 [apply new damage]
      !!en;
    !!en;  
  !!en;
!!en;


!?FU(Calc_Fighter_On_Hit_Damage);

!!VRy10:S0;
!!HEx1:E?y1/?y2/1 F?y3/?y4/?y5/?y6;     [Get hero level, Spell Power and Knowledge]
!!SN&x4=0:W^Att_Com_Fighter_Mage_Cast^/?y50;
!!SN&x4=1:W^Def_Com_Fighter_Mage_Cast^/?y50;
!!VRy10:S0+x2+y2+y3+y4+y5+y6*x5:100;    [Sum up level and all prim stats and influence by spell modifier]
*!VRy10&y50>=1:*2;                       [Double damage if goes after a cast from commander]
!!VRx3:Sy10;                            [return damage]


*casting with commander
!?BG0; !!FU:E; Test
!!BG:A?y1; !!FU&y1<>10:E;               [Exit if No Creature Cast]
!!BG:N?y1;                              [Attacking Stack Commander]
!!BMy1:T?y2 I?y6;                       [get creature type and side]
!!if&y2>=174/y2<=191;                   [if any commander]
!!BG:S?y2 E?y4;                         [Spell and Destination Poistion]
!!FU&y4=-1:E;                           [Exit if no Monster there]
!!if&y2=-1/y4>=0/y4<=41;                [if commander cast]
  !!BG:H?y5;                            [Get Hero]
  !!FU&y5<0:E;                          [Exit if no Hero]
  !!FU(Check_Com_Masteries):Py5/0/0/0/?y10; [Pass Hero Number and return current com class and Spell Modifier]
  !!FU&y10<>14:E;                       [Exit if no fighter Mage commander class]
  !!SN&y6=0:W^Att_Com_Fighter_Mage_Cast^/d1; [add one to cast counter]
  !!SN&y6=1:W^Def_Com_Fighter_Mage_Cast^/d1;
!!en;
!!en;


!?MF1; !!FU:E; Test
*reset cast flag for Fighter Mage commander as soon as he deals damage, this will disable extra strikes based on his cast count
Only disables when attacking and not on retaliations
!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676;[Only run when melee or shooting damage]
  !!BG:A?y1;
  !!if|y1=6/y1=7;                       [If Melee or Range]
    !!MF:N?y1;                          [damage receiving stack]
    !!BG:N?y4;                          [attacking stack]
    !!FU&y1=y4:E;                       [Exit if retaliation]
    !!BMy4:I?y5 T?y2;                   [Side index as for heroes (0:left, 1:right)]
    !!BA:Hy5/?y99; !!FU&y99<0:E;        [Get Hero and exit if nonne]
    !!if&y2>=174/y2<=191;               [if commander]
    !!FU(Check_Com_Masteries):Py99/0/0/0/?y10; [Pass Hero Number and return current com class and Spell Modifier]
    !!FU&y10<>14:E;                     [exit if the wrong class]
    !!MF:F?y6; !!FU&y6=0:E;             [Exit if no damage was dealt]
      !!SN&y5=0:W^Att_Com_Fighter_Mage_Cast^/0; [reset extra strike flag]
      !!SN&y5=1:W^Def_Com_Fighter_Mage_Cast^/0;     
    !!en;
  !!en;
!!en;


*********************************Constructor Commander**********************************************
*Each turn of the commander there is a chance that he summons a random Warmachine to help in battle
The amount he can summon depends on his kill count. With Mastery the WM will have +50% HP

!?FU(OnCombatRound)&v997=0;

!!SN:W^Att_Commander_Summon_WM^/0;      [set how many WM can be summoned this fight by the commander]
!!SN:W^Def_Commander_Summon_WM^/0; 

!!BA:H0/?y2;                            [Attacker]
!!FU(Check_Com_Masteries):Py2/?y3/?y20/0/?y10; [Pass Hero Number and return current com class]
!!if&y10=15;
  !!FU(Set_Com_Battle_Description):Py10/y2/y20/0/y3/0/0/0/?y21; [gets one extra warmachine per 40 kill count +1]
  !!SN:W^Att_Commander_Summon_WM^/y21;  [set value]
!!en;

!!BA:H1/?y2; !!FU&y2<0:E;               [Defender]
!!FU(Check_Com_Masteries):Py2/?y3/?y20/0/?y10; [Pass Hero Number and return current com class]
!!if&y10=15;
  !!FU(Set_Com_Battle_Description):Py10/y2/y20/0/y3/0/1/0/?y21; [gets one extra warmachine per 40 kill count +1]
  !!SN:W^Def_Commander_Summon_WM^/y21;  [set value]
!!en;


!?FU(OnBattleRegeneratePhase);     

!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]
!!SN:X?y1;                              [Event parameter]
!!BMy1:I?y2;                            [Acting Side Monster]
!!SN&y2=0:W^Att_Commander_Summon_WM^/?y30; [check how many WM can be summoned this fight by the commander]
!!SN&y2=1:W^Def_Commander_Summon_WM^/?y30; 
!!FU&y30=0:E;                           [Exit if no more available summons this combat]
!!BA:Hy2/?y99;                          [Current Hero]
!!FU&y99<0:E;                           [Exit if none]
!!BMy1:T?y3 P?y9;                       [Get Creature Number and current battlefield position]
!!if&y3>=174/y3<=191;                   [if any commander and constructor commander]
  !!FU(Check_Com_Masteries):Py99/?y50/?y15/0/?y10; [Pass Hero Number and return current com class and kill count]
  !!FU&y10<>15:E;                       [Exit if wrong com class]
  !!VRy20:S0R2;                         [Generate random number to determine summoned Warmachine type]
  !!VRy21&y20=0:S146;                   [Ballista]
  !!VRy21&y20=1:S147;                   [First Aid Tent]
  !!VRy21&y20=2:S148;                   [Ammo Cart]
  !!FU(ACM_Com_Summon_Warmachine):Py9/y21/y15/y2/y50; [pass position, WM type, kill count, attacking side]
!!en;


!?FU(ACM_Com_Summon_Warmachine);
x1=position, x2=WM type, x3=kill count, x4=attacking side, x5=mastery 

!!re i/0/40;                            [loop around the creatures in cirlce 0-6 positions]
  !!VRy9:S0R5;                          [generate random number from 0 to 5]
  !!FU(ACM_Calc_neighbouring_hex_2):Px1/y9/?y11; [Pass position and return first neighbouring hex field]
  !!FU|y11<0/y11>189:E;                 [Exit if wrong battlefield position]

  !!if|x2=146/x2=147;                   [For a Ballista or First Aid Tent]
    !!BU:Oy11/?y12 Ey11/?y15;           [check battlefield for obstacle]
    !!VRy13&x4=0:Sy11+1;                [get the in front position also for attacker]
    !!VRy13&x4=1:Sy11-1;                [get the in front position also for defender]
    !!FU|y13<0/y13>189:E;               [Exit if wrong battlefield position]
    !!BU:Oy13/?y14 Ey13/?y16;           [check it too]
    !!if&y12=0/y14=0/y15=-1/y16=-1;     [if there is free space and two free spaces for ballista]
      !!BU:Sx2/1/y11/x4/-1/1;           [summon a Warmachine]
      !!if&x5=1;                        [If Mastery enabeld increase life of WM by +100%]
        !!BU:Ey11/?y15;
        !!BMy15&y15>0:H?y40 A?y41 D?y42;
        !!VRx3:+100;                    [Add 100 to kill count]
        !!VRy40:*x3:100;                [increase life of summoned WMs]
        !!VRy41:*x3:100;                [increase attack of summoned WMs]
        !!VRy42:*x3:100;                [increase defense of summoned WMs]
        !!BMy15&y15>0:Hy40 Ay41 Dy42;
      !!en;
      !!SN&x4=0:W^Att_Commander_Summon_WM^/d-1; [reduce summoning amount]
      !!SN&x4=1:W^Def_Commander_Summon_WM^/d-1; [reduce summoning amount]
      !!br;                             [End loop if valid place to summon has been found]
    !!en;
  !!en;

  !!if&x2=148;                          [For Ammo Cart]
    !!BU:Oy11/?y12 Ey11/?y15;           [check battlefield for obstacle]
    !!if&y12=0/y15=-1;                  [if there is free space]
      !!BU:Sx2/1/y11/x4/-1/1;           [summon a Warmachine]
      !!if&x5=1;                        [If Mastery enabeld increase life of WM by +100%]
        !!BU:Ey11/?y15;
        !!BMy15&y15>0:H?y40 A?y41 D?y42;
        !!VRx3:+100;                    [Add 100 to kill count]
        !!VRy40:*x3:100;                [increase life of summoned WMs]
        !!VRy41:*x3:100;                [increase attack of summoned WMs]
        !!VRy42:*x3:100;                [increase defense of summoned WMs]
        !!BMy15&y15>0:Hy40 Ay41 Dy42;
      !!en;
      !!SN&x4=0:W^Att_Commander_Summon_WM^/d-1; [reduce summoning amount]
      !!SN&x4=1:W^Def_Commander_Summon_WM^/d-1; [reduce summoning amount]
      !!br;                             [End loop if valid place to summon has been found]
    !!en;
  !!en;
!!en;


**********************************Arcanist Commander************************************************
*Arcanist Commander class can select a second passive modifier from any class when selected
It only has half the passive value to compensate

!?FU(ACM_Com_Support_Passive_Selection);
x1=Hero ID

!!SN:T^AC_Misc.Com_Sup_Text^/?z1;       [set text in header]
!!SN:T^AC_Misc.Com_Sup_Text_Passive_1^/?z2; 
!!SN:T^AC_Misc.Com_Sup_Text_Passive_2^/?z3; 
!!SN:T^AC_Misc.Com_Sup_Text_Passive_3^/?z4; 
!!SN:T^AC_Misc.Com_Sup_Text_Passive_4^/?z5; 
!!SN:T^AC_Misc.Com_Sup_Text_Passive_5^/?z6; 
!!SN:T^AC_Misc.Com_Sup_Text_Passive_6^/?z7; 
!!SN:T^AC_Misc.Com_Sup_Text_Passive_7^/?z8; 
!!SN:T^AC_Misc.Com_Sup_Text_Passive_8^/?z9; 
!!SN:T^AC_Misc.Com_Sup_Text_Passive_9^/?z10; 

!!COx1:T?y50;                           [Get commander type and name]
!!SN&y50=0:T^AC_Misc.Bonus_Name_Paladin^/?z20; 
!!SN&y50=1:T^AC_Misc.Bonus_Name_Hierophant^/?z20; 
!!SN&y50=2:T^AC_Misc.Bonus_Name_TempleGuardian^/?z20; 
!!SN&y50=3:T^AC_Misc.Bonus_Name_Succubus^/?z20; 
!!SN&y50=4:T^AC_Misc.Bonus_Name_Brute^/?z20; 
!!SN&y50=5:T^AC_Misc.Bonus_Name_SoulEater^/?z20; 
!!SN&y50=6:T^AC_Misc.Bonus_Name_OgreLeader^/?z20; 
!!SN&y50=7:T^AC_Misc.Bonus_Name_Shaman^/?z20; 
!!SN&y50=8:T^AC_Misc.Bonus_Name_AstralSpirit^/?z20;

!!SN:T^AC_Misc.Arcanist_Passive_Text_Header^/?z1;
!!SN:Iz1/?z1;
!!SN:T^AC_Misc.Arcanist_Passive_1^/?z2;
!!SN:T^AC_Misc.Arcanist_Passive_2^/?z3;
!!SN:T^AC_Misc.Arcanist_Passive_3^/?z4;
!!SN:T^AC_Misc.Arcanist_Passive_4^/?z5;
!!SN:T^AC_Misc.Arcanist_Passive_5^/?z6;
!!SN:T^AC_Misc.Arcanist_Passive_6^/?z7;
!!SN:T^AC_Misc.Arcanist_Passive_7^/?z8;
!!SN:T^AC_Misc.Arcanist_Passive_8^/?z9;
!!SN:T^AC_Misc.Arcanist_Passive_9^/?z10;

!!IF:G1/3/0/1/2/3/4/5/6/7/8/9/10/0/0/;  [Show Choice Dialouge]

!!SN&v3=1:W^ACM_Com_%X1_Passive_1^/1;
!!SN&v3=2:W^ACM_Com_%X1_Passive_2^/1;
!!SN&v3=4:W^ACM_Com_%X1_Passive_3^/1;
!!SN&v3=8:W^ACM_Com_%X1_Passive_4^/1;
!!SN&v3=16:W^ACM_Com_%X1_Passive_5^/1;
!!SN&v3=32:W^ACM_Com_%X1_Passive_6^/1;
!!SN&v3=64:W^ACM_Com_%X1_Passive_7^/1;
!!SN&v3=128:W^ACM_Com_%X1_Passive_8^/1;
!!SN&v3=256:W^ACM_Com_%X1_Passive_9^/1;


***********************************King Commander***************************************************
*King Commander class generates Class Points with kill count
*Mastery always acts twice

!?FU(OnCombatRound)&v997>=0;
!!SN:W^ACM_twice_acting stack^/-1;      [reset act twice counter and battle stack each new battle round]
!!if&i^battle_round^>=0;
  !!re i/0/41;                          [loop all stacks and reset]
    !!SN:W^ACM_Com_abilityCounter_%i^/0;
  !!en;
!!en;


!?FU(OnBeforeBattleAction)&i^battle_round^>=0;
!!SN:W^ACM_twice_acting stack^/-1;
!!BG:A?y1 N?y2;                         [Get action type and stack number]
!!FU&y1<>2/
     y1<>6/
     y1<>7/
     y1<>9/
     y1<>10/
     y1<>11:E; exit for wrong condition

!!BMy2:T?y3 I?y4;                       [get type and side]
!!if&y3>=174/y3<=191;                   [if any commander]
  !!BA:Hy4/?y99;                        [Current Hero]
  !!FU&y99<0:E;                         [Exit if none]
  !!FU(Check_Com_Masteries):Py99/?y15/0/0/?y10; [Pass Hero Number and return current com class and kill count]
  !!FU|y10<>16/y15=0:E;                 [Exit if wrong class or no mastery]
  !!SN:W^ACM_twice_acting stack^/y2;    [set and save stack that should act twice]
!!en;


!?FU(OnBattleActionEnd);
!!SN:W^ACM_twice_acting stack^/?y1;
!!if&y1>=0/y1<=41;                      [if a valid battle stack]
  !!SN:W^ACM_Com_abilityCounter_%Y1^/?y2;[check ability counter]
  !!BMy1&y2=0:Fd~(MON_FLAG_ACTED);      [set act twice flag for stack]
  !!SN:W^ACM_Com_abilityCounter_%Y1^/d-1;[reduce ability counter]
!!en;


!?FU(OnBeforeBattleStackTurn);
!!SN:W^ACM_twice_acting stack^/?y1; 
!!FU&y1=-1:E;                           [exit if no valid stack]
!!BMy1:T?y2 N?y3;                       [get type and number]
!!FU|y2=-1/y3<=0;                       [exit if not valid]
!!SN:W^ACM_twice_acting stack^/x1;      [set stack that should act twice]


*******************************General Commander****************************************************
*General Commander class has a Fear Aura that lets surrounding creatures go in defend position
*Mastery 

!?FU(OnBattleActionEnd);

!!BG:H?y99 N?y1 A?y3 D?y20; !!FU&y99<0:E;[Exit if no Hero]
!!BMy1:T?y2 I?y11;                      [Get monster and side]
!!if&y2>=174/y2<=191;                   [if any commander]
!!if|y3=2/y3=3/y3=6;                    [if walk or walk and attack or defend]
  !!FU(Check_Com_Masteries):Py99/0/?y15/0/?y10; [Pass Hero Number and return current com class and kill count]
  !!FU(Set_Com_Battle_Description):Py10/y99/y15/0/0/0/y11/0/?y40; [get value of chance from fct Initial chance is 20% Each 10 Kill counts adds 1% chance]  
  !!VRy50:S0R99;                        [generate random number]
  !!FU|y10<>26/y50>y40:E;               [Exit if no General commander or roll was not successfull]
  !!re i/0/5;                           [loop target stack surrounding]
    !!FU(ACM_Calc_neighbouring_hex_2):Py20/i/?y30; [Pass position and return first neighbouring hex field]
    !!if&y30>=0/y30<=186;    
      !!BU:Ey30/?y8;                    [-2 if there is alive stack at that position]
      !!if&y8>=0/y8<=41;                [if a valid creature and not the same ID]
        !!BMy8:I?y40 F?j F?s F?r;       [get side and creature flag alive, done acting and defending ]
        *!VRj:&16;                      [Check living flag]
        *!VRs:&67108864; *!FU&s>0:E;    [Check This stack has done acting this round]
        *!VRr:&134217728; *!FU&r>0:E;   [Check This stack is defending]
        !!VRj:|134217728;               [Set defending bit]
        !!VRr:|67108864;                [Set done acting bit]
        !!VRz2:S^Fear.wav^;             [get sound file]
        !!SN&y40<>y11/i^battle_isVisible^:Pz2; [Play Sound]
        !!BMy8&y40<>y11:V15 Fj Fr R0;   [if creatures arent same side play animation set flag and set retaliation to zero]
      !!en;
    !!en;  
  !!en;
!!en;
!!en;


*General Commander Mastery
Killing the enemy commander grants a stat boost for the whole army for the rest of the combat

!?BG0;                                

!!BG:A?y1;
!!if|y1=6/y1=7;                         [If Shoot or Melee]
  !!SN:W^Commander_Aktion^/y1;          [Save if Melee or Shooting]
  !!BG:H?y5; !!FU&y5<0:E;               [Exit if no Hero]
  !!BG:N?y1;                            [Attacking Stack]
  !!BMy1:T?y2;                          [Creature Type]
  !!if&y2>=174/y2<=191;                 [if any commander]
    !!FU(Check_Com_Masteries):Py5/0/?y15/0/?y10; [Pass Hero Number and return current com class and kill count]
    !!FU|y10<>26/y15=0:E;               [Exit if no General commander or no Mastery enabled]
    !!BG:E?y3;                          [Destination Poistion]
    !!FU&y3=-1:E;                       [Exit if no Monster there]
    !!BMy3:N?y5;                        [Number of Attacked Stack]
    !!BMy3:H?y6;                        [Health of Attacked Stack]
    !!SN:W^General_Commander_Target^/y3;[save target stack ID]
    !!SN:W^General_Commander_Stack^/y1; [save commander ID]
  !!en;
!!en;


!?BG1;                                  [Killed enemies get reanimated as Skeletons during combat]

!!SN:W^General_Commander_Target^/?y3;   [Readout Var]
!!SN:W^General_Commander_Stack^/?y4;
!!SN:W^General_Commander_Target^/-1;    [Reset Var]
!!SN:W^General_Commander_Stack^/-1;            
!!if&y3>=0/y3<=41/y4>=0/y4<=41;         [exit if no valid stacks]
  !!BMy4:N?y7 I?y5; !!FU&y7=0:E;        [Exit if commander is no valid stack]
  !!BMy3:N?y6;                          [Current Number of stack]
  !!FU&y6>0:E;                          [Exit if the target hasnt died]
  !!VRy10&y5=0:S0; !!VRy11&y5=0:S20;    [Attacking side]
  !!VRy10&y5=1:S1; !!VRy11&y5=1:S41;    [Defending side]
  !!re i/y10/y11;                       [loop battle stacks depending on side]
    !!BMi:N?y20 T?y21;                  [get stack numbers and type]
    !!if&y20>0/y21<>145/y21<>146/y21<>147/y21<>148/y21<>149; [Exit for Warmachines]
      !!BMi&y20>0:Ad4 Dd4 Sd1;          [add attack defense and speed]
    !!en;
  !!en;
  !!VRz2:S^Heroism.wav^;                [get sound file]
  !!SN&i^battle_isVisible^:Pz2;         [Play Sound]
  !!SN:T^AC_Misc.General_Com_killed^/?z-1;
  !!BU&i^battle_isVisible^:Mz-1;        [show message in log]
!!en;


**********************************Scout Commander***************************************************
*Scout Commander has chance to avoid damage based on his combat speed
!?MF1;
*Chance to Evade/Dodge melee or ranged attacks*
!!UN:C42149568/4/?y10;                  [Physical Damage]
!!if|y10=4462398/y10=4455011/y10=4456676;[Only run when melee or shooting damage]
  !!BG:A?y1;
    !!if|y1=6/y1=7;                     [If Melee or Range]
    !!MF:N?y4;                          [damage receiving stack]
    !!BMy4:T?y3 I?y5 S?y6;              [Monster Side Index type and speed]
    !!BA:Hy5/?y99;                      [get hero number]
    !!FU&y99<0:E;                       [Exit if no valid Hero]
    !!if&y3>=174/y3<=191;               [if any commander]
      !!FU(Check_Com_Masteries):Py99/?y14/?y15/0/?y10; [Pass Hero Number and return current com class and kill count]
      !!FU&y10<>7:E;                    [Exit if wrong com class]
      !!VRy20:S0R99;                    [Generate Random number]
      !!FU(ACM_Scout_Dodge_Chance):Py6/?y22; [give speed and return chance to dodge attacks]
      !!if&y20<=y22;                    [chance is ]
        !!VRz-1:S^AIRSHELD^;
        !!SN&i^battle_isVisible^:Pz-1;
        !!MF:E0;                        [set damage to zero]
        !!MF:F0;                        [set final damage to zero]
        !!SN:T^AC_Misc.Air Dodge^/?z-1;
        !!BU&i^battle_isVisible^:Mz-1;  [show message in log]
      !!en;
    !!en;
  !!en;
!!en;

!?FU(ACM_Scout_Dodge_Chance);
x1=Speed and x2 returns chance to dodge

!!VRy2:S0;
!!VRy2:Sx1;
!!VRx2:Sy2;                             [return value]


*************************************Lancer Commander***********************************************
*Lancer Commander increases damage for each tile walked in combat
!?BG0;
!!BU:T?y1; !!FU&y1=1:E;                 [Get if combat is in Tactics phase and exit if yes]
!!BG:A?y9;
!!if|y9=2/y9=6;                         [If walk or walk and attack]
  !!BG:N?y1;                            [Attacking Stack Commander]
  !!BMy1:T?y2 I?y3 P?y4;                [get creature type and side]
  !!if&y2>=174/y2<=191;                 [if any commander]
    !!BG:E?y5 D?y6;                     [Spell and Destination Poistion]
    !!FU(ACM_CalcDistanceBetweenHexes)&y4<>y6:Py4/y6/?y7;
    !!VRy7&y9=6:-1;
    !!FU&y7=0:E;                        [Exit if no distance covered]
    !!BG:H?y8;                          [Get Hero]
    !!FU&y8<0:E;                        [Exit if no Hero]
    !!FU(Check_Com_Masteries):Py8/0/0/0/?y10; [Pass Hero Number and return current com class and Spell Modifier]
    !!FU&y10<>27:E;                     [Exit if no Lancer commander class]
    !!SN&y3=0:W^Lancer_Commander_Distance_Att^/dy7;
    !!SN&y3=1:W^Lancer_Commander_Distance_Def^/dy7;
  !!en;
!!en;


// Calculate distance between two hexes
!?FU(ACM_CalcDistanceBetweenHexes);      [by wessonsm]
!#VA(hex1:x) (hex2:x) (distance:x);

!!VR(x1:y):S(hex1) %17;
!!VR(y1:y):S(hex1) :17;
!!VR(x2:y):S(hex2) %17;
!!VR(y2:y):S(hex2) :17;
!!VR(distanceY:y):S(y1) -(y2);
!!VR(distanceY)&(distanceY)<0: *-1;
!!VR(x1):*2;
!!VR(y1):&1;
!!VR(x2):*2;
!!VR(y2):&1;
!!VR(distanceX:y):S(x1) -(y1) -(x2) +(y2);
!!VR(distanceX)&(distanceX)<0:*-1;
!!VR(distanceX):-(distanceY);
!!VR(distance):S(distanceX);
!!VR(distance)&(distance)<0:S0;
!!VR(distanceY):*2;
!!VR(distance):+(distanceY) :2;


**************************Undead Commander**********************************************************
*Undead commanders mastery can resurrect at a new battleround with 25% of total HP. 
Can happen once per combat

!?FU(OnCombatRound)&v997>0;

!!re i/0/40;
  !!BMi:T?y2 I?y3 P?y4 N?y5 H?y7;       [get creature type and side and position]
  !!SN&y3=0:W^Undead_Commander_Revive_Att^/?y20; [check revive flag attacker]
  !!SN&y3=1:W^Undead_Commander_Revive_Def^/?y20; [check revive flag defender]
  !!BHy3:N?y1;                          [Attacker Hero ID]
  !!if&y2>=174/y2<=191/y1>=0/y5=0;      [if any commander and a hero and the stack is dead]
    !!FU(Check_Com_Masteries):Py1/?y15/0/0/?y10; [Pass Hero Number and return current com class and Spell Modifier]
    !!SN:W^Commander_%Y1_Ancient_Undead^/?y11;
    !!VRy10&y11=1:S8; !!VRy15&y11=1:S1; [Check for Ancient Undead Commander and set Mastery active]
    !!FU|y10<>8/y15=0/y20=1:E;          [Exit if no Undead commander class or Mastery not enabled or no more revives left this battle]
    !!VRy8:Sy7:4;                       [calculate 25% of commander health]
    !!COy1:D?y6;                        [check if commander is alive]
    !!FU(ACM_Stack_Resurrect):Pi/y8/0/y3;[call resurrect fct]
    !!SN:T^AC_Misc.Undead_Com_revive^/?z-1;
    !!BU&i^battle_isVisible^:Mz-1;      [show message in log]
    !!SN&y3=0:W^Undead_Commander_Revive_Att^/1; [set revive flag attacker]
    !!SN&y3=1:W^Undead_Commander_Revive_Def^/1; [set revive flag defender]
  !!en;
!!en;


!?FU(ACM_Stack_Resurrect); [revive a stack By 007]
**x1=stack
**x2=hp recovered [one will revive as long as >0]
**x3=revival type [0=live,1=undead,2=golem,3=dragon,4=all]
**x4=caster side[0=left,1=right]
!!FU|x1<0/x1>41/x2<1/x3<0/x3>4:E;
!!BMx1:T?y1 N?y2 B?y3 O?y4 L?y6 F?i;
!!VRy7:Si &1;
*!VRy8:Si &16;
*!VRy9:Si &262144;
!!VRy10:Si &8388608;
!!VRy11:Si &-2147483648;
!!VRy12:Si &268435456;
!!FU|y1<0/y1=124/y1=149/y10>0/y12>0:E; 

!!FU&y2>=y3/y6=0:E;       
*!FU&x3=0/y8=0:E; Exit if Alive flag   
*!FU&x3=1/y9=0:E; Exit if Undead flag   
!!FU&x3=2/y8>0:E;    
!!FU&x3=2/y9>0:E;
!!FU&x3<3/y11<>0:E;  
!!UN:C6919200/4/?y13;    
!!VRy14:Sx1 *1352 +21708 +y13;
!!SN:E4481984/2/y14;
!!BMx1:P?y15;
!!VRy16:Sv1;      
!!if&y2=0:;         
!!BU:Ey15/?y17;
!!FU&y17>-1:E;
!!if&y7=1:;        
!!BU:Ey16/?y18;
!!FU&y18>-1:E;
!!en:;
!!en:;
!!SN:E5929072/2/y13/y14/x2/0;  
!!VRz-9:S^^;        
!!VRz-9&x3=0:S^Resurect.wav^;
!!VRz-9&x3=1:S^Animdead.wav^;
!!VRz-9&x3=2:S^Removeob.wav^;
!!VRz-9&x3=3:S^Sacrif1.wav^;
!!VRz-9&x3=4:S^Regener.wav^;
!!SN&i^battle_isVisible^:Pz-9;


**********************************Lich Commander****************************************************
*Lich commander has Death Cloud attack. 
The cloud damage is based on kill count and starts with 50% from commander damage
Will do normal damage with 100 kill count
Death Cloud damage only works on living creatures

!?MF1;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if&y10=4455011;                       [Only run when shooting damage]
  !!BG:A?y1;                            [get action type]
  !!if&y1=7;                            [If Range]
    !!MF:N?y1;                          [damage receiving stack]
    !!BG:N?y4;                          [attacking stack]
    !!FU&y1=y4:E;                       [Exit if retaliation]
    !!BMy4:I?y5 T?y2;                   [Side index as for heroes (0:left, 1:right)]
    !!BA:Hy5/?y99; !!FU&y99<0:E;        [Get Hero and exit if nonne]
    !!if&y2>=174/y2<=191;               [if commander]
      !!FU(Check_Com_Masteries):Py99/0/?y15/0/?y10; [Pass Hero Number and return current com class and kill count]
      !!FU&y10<>18:E;                   [exit if the wrong class must be Lich commander]
      !!MF:F?y6; !!FU&y6=0:E;           [Exit if no damage was dealt]
      !!BMy1:P?y20 I?y50;               [get position and side of attacked stack]
      !!FU(ACM_GetStackHeadPosition):Py1/?y20; [While BM:P returns the position of the "ass" of a wide stack, this function always returns the position of the head]
      !!CM&1000:D?y20;                  [get where we clicked to have correct position of the fireball]
      !!VRz3&i^battle_isVisible^:S^Sp04_.def^;
      !!FU(ACM_PlayCustomAnimation)&i^battle_isVisible^:P0/3/y20/100/1/0/1; [Function to play custom animation]
      !!FU(Set_Com_Battle_Description):Py10/y99/y15/0/0/0/y5/0/?y16; [get dmg increase from fct]
      !!VRy60:Sy6:2;                    [set surrounding damage to half the normal damage]
      !!VRy16:+100;                     [set kill count percentage]
      !!VRy60:*y16:100;                 [calc surrounding damage]
      !!re i/0/5;                       [loop target stack surrounding]
        !!FU(ACM_Calc_neighbouring_hex_2):Py20/i/?y30; [Pass position and return first neighbouring hex field]
        !!if&y30>=0/y30<=186;
          !!BU:Ey30/?y8;                [-2 if there is alive stack at that position]
          !!if&y8>=0/y8<=41/y1<>y8;     [if a valid creature and not the same ID]
            !!BMy8:I?y40 F?j;           [get side and creature flag]
            !!VRj:&16;                  [Check living flag]

            !!if&y40=y50/j>0;
              !!BMy8:Ky60;    [apply damage to surrounding creatures if same side]
              !!FU(ACM_DrawActionPlay):P;
              !!FU(ACM_ExecutePhoenixResurrection):P;
            !!en;
          !!en;
        !!en;  
      !!en;
    !!en;
  !!en;
!!en;


!?FU(ACM_PlayCustomAnimation);

!!FU|x1<0/x1>82/x2<0/x2>1000:E;
!!VRx3|x3<0/x3>187:S93;
!!VRx4&x4<0:S100;
!!VRx5|x5<0/x5>4:S0;
!!VRx6|x6<0/x6>1:S0;
!!UN:C6919200/4/?y20;
!!VRy21:Sy20 +78568;
!!VRy22:Sy20 +78572;
!!UN:C4454270/4/?y1;
!!UN:Cy21/4/0 Cy22/4/-1;
!!VRy2:Sx1 *12 +y1;
!!VRy3:Sy2 +8;
!!VRy4:Sx2 *512 +9597416;
!!VRy5:Sx6 *256 +x5;
!!UN:Cy2/4/?y10;
!!UN:Cy3/4/?y11;
!!UN:Cy2/4/y4;
!!UN&x7<>0:Cy3/4/y5;
!!SN:E4810128/2/y20/x1/x3/x4/0;
!!UN:Cy2/4/y10;
!!UN&x7<>0:Cy3/4/y11;
!!UN:Cy21/4/0 Cy22/4/-1;


; While BM:P returns the position of the "ass" of a wide stack, this function always returns the position of the head.
!?FU(ACM_GetStackHeadPosition);
!#VA(stack:x) (pos:x);

!!BM(stack):Z?(stackStuct:y) P?(pos) F?(flags:y);
!!VR(isWide:y):S(flags) &(MON_FLAG_WIDE);

!!if&(isWide);
  !!UN:C(stackStuct)/68/4/?(secPosOrientation:y);

  ; If the stack is wide
  !!if&(secPosOrientation)>=0;
    !!if&(secPosOrientation)=0;
      !!VR(pos):-1;
    !!el&(secPosOrientation)=1;
      !!VR(pos):+1;
    !!en;
  !!en;
!!en;


***********************************Necromant commander**********************************************
*Necromant commander
raises undead creatures during combat and after attacking

!?FU(OnCombatRound)&v997=0;

!!SN:W^Att_Commander_Summon_Undead^/0;  [set how many Undead can be summoned this fight by the commander]
!!SN:W^Def_Commander_Summon_Undead^/0; 

!!BA:H0/?y2;                            [Attacker]
!!FU(Check_Com_Masteries):Py2/?y3/?y20/0/?y10; [Pass Hero Number and return current com class]
!!if&y10=28;
  !!FU(Set_Com_Battle_Description):Py10/y2/y20/0/y3/0/0/0/?y21; [gets one extra summon per 10 kill count +3]
  !!SN:W^Att_Commander_Summon_Undead^/y21; [set value]
!!en;

!!BA:H1/?y2; !!FU&y2<0:E;               [Defender]
!!FU(Check_Com_Masteries):Py2/?y3/?y20/0/?y10; [Pass Hero Number and return current com class]
!!if&y10=28;
  !!FU(Set_Com_Battle_Description):Py10/y2/y20/0/y3/0/1/0/?y21; [gets one extra summon per 10 kill count +3]
  !!SN:W^Def_Commander_Summon_Undead^/y21; [set value]
!!en;


!?FU(ACM_OnAfterAttack);

!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]
!!BMx1:I?y2;                            [Acting Side Monster]
!!SN&y2=0:W^Att_Commander_Summon_Undead^/?y30; [check how many Undead can be summoned this fight by the commander]
!!SN&y2=1:W^Def_Commander_Summon_Undead^/?y30; 
!!FU&y30=0:E;                           [Exit if no more available summons this combat]
!!BA:Hy2/?y99;                          [Current Hero]
!!FU&y99<0:E;                           [Exit if none]
!!BMx1:T?y3 P?y9;                       [Get Creature Number and current battlefield position]
!!if&y3>=174/y3<=191;                   [if any commander and Necromant commander]
  !!FU(Check_Com_Masteries):Py99/?y20/?y15/0/?y10; [Pass Hero Number and return current com class and kill count]
  !!FU&y10<>28:E;                       [Exit if wrong com class]
  !!VRy42:S0;                           [initial number of stacks per side]
  !!VRy44&y2=0:S0; !!VRy45&y2=0:S20;    [set side IDs for loop attacker]
  !!VRy44&y2=1:S21; !!VRy45&y2=1:S41;   [defender]
  !!re i/y44/y45;                       [loop all battlestacks to check if not above 20 units]
    !!BMi:N?y40 I?y41;                  [Get number and type]
    !!VRy42&y40>0/y41=0:+1;             [count +1]
    !!VRy42&y40>0/y41=1:+1;             [count +1]
  !!en;
  !!VRy21&y20=0:S0R2*2+56;              [Generate random number to determine raised undead creature]
  !!VRy21&y20=0/y15>20:S0R3*2+56;       [include fourth level]
  !!VRy21&y20=0/y15>30:S0R4*2+56;       [include fifth level]
  !!VRy21&y20=0/y15>40:S0R5*2+56;       [include sixth level]
  !!VRy21&y20=0/y15>50:S0R6*2+56;       [include seventh level]
  !!VRy21&y20=1:S56R13;                 [With Mastery enabled it can raise all creatures and also upgraded version]
  !!FU(ACM_Com_Summon_Undead)&y42<19:Py9/y21/y15/y2/x1/x2/y99; [pass position, Undead type, kill count, attacking side, attacker and attacked stack]
!!en;


!?FU(ACM_Com_Summon_Undead);
x1=position, x2=Undead type, x3=kill count, x4=attacking side, x5=attacker, x6=attacked stack, x7=hero 

!!re i/0/40;                            [loop around the creatures in cirlce 0-6 positions]
  !!VRy9:S0R5;                          [generate random number from 0 to 5]
  !!FU(ACM_Calc_neighbouring_hex_2):Px1/y9/?y11; [Pass position and return first neighbouring hex field]
  !!FU|y11<0/y11>189:E;                 [Exit if wrong battlefield position]

  !!if|x2=66/x2=67/x2=68/x2=69;         [For a any two hex creature]
    !!BU:Oy11/?y12 Ey11/?y15;           [check battlefield for obstacle]
    !!VRy13&x4=0:Sy11+1;                [get the in front position also for attacker]
    !!VRy13&x4=1:Sy11-1;                [get the in front position also for defender]
    !!FU|y13<0/y13>189:E;               [Exit if wrong battlefield position]
    !!BU:Oy13/?y14 Ey13/?y16;           [check it too]
    !!if&y12=0/y14=0/y15=-1/y16=-1;     [if there is free space and two free spaces for two hex units]
      !!BU:Sx2/1/y11/x4/-1/1;           [summon an undead helper]
      !!FU(Set_Undead_Helper_Stats):Py11/x2/x3/x4/x5/x6/x7; [Pass Position, Undead type, Kill Count]
      !!SN&x4=0:W^Att_Commander_Summon_Undead^/d-1; [reduce summoning amount]
      !!SN&x4=1:W^Def_Commander_Summon_Undead^/d-1; [reduce summoning amount]
      !!br;                             [End loop if valid place to summon has been found]
    !!en;
  !!el;

*single hex units
  !!BU:Oy11/?y12 Ey11/?y15;             [check battlefield for obstacle]
  !!if&y12=0/y15=-1;                    [if there is free space]
    !!BU:Sx2/1/y11/x4/-1/1;             [summon an undead helper]
    !!FU(Set_Undead_Helper_Stats):Py11/x2/x3/x4/x5/x6/x7; [Pass Position, Undead type, Kill Count]
    !!SN&x4=0:W^Att_Commander_Summon_Undead^/d-1; [reduce summoning amount]
    !!SN&x4=1:W^Def_Commander_Summon_Undead^/d-1; [reduce summoning amount]
    !!br;                               [End loop if valid place to summon has been found]
  !!en;
!!en;


****
!?FU(Set_Undead_Helper_Stats);
* formula for increased stats of summoned units
y10 starts with 100%
+10% for each level of attacked unit
+1% for each commander level and double over level 50
+1% for each 2 kill counts
+10% of max damage from commander 
+5% per magic level of commander

!!BU:Ex1/?y15; !!FU|y15<0/y15>41:E;     [Exit if no valid battle stack at the summoned position]
!!VRy10:S100;
!!BMx6:T?y30;                           [get type of attacked unit]
!!MA:Ly30/?y31;                         [get level of attacked unit]
!!VRy32:Sy31*10;                        [make 10% per creature level]
!!HEx7:E?y33/?y34;                      [Get level of hero]
!!COx7:S4/?y36;                         [Get magic level of commander]
!!VRy36:*5;                             [+5% per level of magic]
!!VRy34&y34>=50:*2;                     [Double Bonus when over level 50]
!!VRy35:Sx3:2;                          [Get half amount of kill count]
!!BMx5:U2/?y50;                         [get max damage of commander]
!!VRy50::10;                            [Get 10% of max damage from commander]
!!VRy10:S100+y32+y34+y35+y50+y36;       [add all up to get new value]
!!BMy15:H?y40 A?y41 D?y42 S?y43 U2/?y44;[Get Stats of summoned creature]
!!VRy40:*y10:100;                       [increase life of summoned WMs]
!!VRy41:*y10:200;                       [increase attack of summoned WMs]
!!VRy42:*y10:200;                       [increase defense of summoned WMs]
!!VRy44:*y10:50 +10;                    [increase damage of summoned WMs]
!!BMy15:Hy40 Ay41 Dy42 U2/y44;          [set new stats]
!!SN&x4=0:W^Att_Commander_Summon_Stats^/y10; [save stats to show later]
!!SN&x4=1:W^Def_Commander_Summon_Stats^/y10; [save stats to show later]


*************************Ancient Commander**********************************************************
Ancient Commander has no limit on the Kill count. Each stack adds a random attribut of 2%. After 100
kill count you get +4% of a random attribute


****************************************************************************************************

!?FU(ACM_CreateERMHook);
!#VA(setHook:x);

!!SN:E(setHook)/1/4445929/(ACM_HOOK_AfterStackInitParams); [Trigger after initialising the stats of a stack on the battlefield]
!!SN:E(setHook)/1/4461377/(ACM_HOOK_BeforeMeleeMainFunc); [Trigger before melee attack, works for retaliation] 441341
!!SN:E(setHook)/1/4453930/(ACM_HOOK_BeforeShootMainFunc); [Trigger before shooting] 43F62A
!!SN:E(setHook)/1/4462998/(ACM_HOOK_AfterMeleeMainFunc); [Trigger after melee attack, before retaliation] 441996
!!SN:E(setHook)/1/4455129/(ACM_HOOK_AfterShootMainFunc); [Trigger after shooting]

!?FU(ACM_HOOK_AfterStackInitParams);    [by daemon_n]
!#VA(hook:x);

!!UN:C(hook)/(STRUCT_HOOK_CONTEXT_ESI)/4/?(stackStruct:y) C(stackStruct)/244/(UNC_INT)/?(side:y) C(stackStruct)/248/(UNC_INT)/?(stackPerSide:y);
!!VR(stackId:y):S(side) *(BATTLE_STACKS_PER_SIDE) +(stackPerSide);
!!FU(ACM_BattleStack_InitParams):P(stackId)/(side);

!?FU(ACM_HOOK_BeforeMeleeMainFunc);
!#VA(hook:x);

!!FU(ACM_HOOK_BeforeAttackMainFunc):P(hook)/0;

!?FU(ACM_HOOK_BeforeShootMainFunc);
!#VA(hook:x);

!!FU(ACM_HOOK_BeforeAttackMainFunc):P(hook)/1;

!?FU(ACM_HOOK_BeforeAttackMainFunc);
!#VA(hook:x) (mode:x);

!!UN:C(hook)/(STRUCT_HOOK_CONTEXT_ESI)/(UNC_INT)/?(stackStructAttacker:y);
!!UN:C(hook)/(STRUCT_HOOK_CONTEXT_EBP)/(UNC_INT)/?(ebp:y);
!!UN:C(ebp)/8/(UNC_INT)/?(stackStructDefender:y);

!!VR(stackAttackerID:y):S(NO_STACK); 
!!VR(stackDefenderID:y):S(NO_STACK); 

!!if&(stackStructAttacker); 
  !!UN:C(stackStructAttacker)/244/(UNC_INT)/?(attakerSide:y);
  !!UN:C(stackStructAttacker)/248/(UNC_INT)/?(attakerStackIdInSide:y);
  !!VR(stackAttackerID):S(attakerSide) *(BATTLE_STACKS_PER_SIDE) +(attakerStackIdInSide);
!!en;

!!if&(stackStructDefender);
  !!UN:C(stackStructDefender)/244/(UNC_INT)/?(defenderSide:y);
  !!UN:C(stackStructDefender)/248/(UNC_INT)/?(defenderStackIdInSide:y);
  !!VR(stackDefenderID):S(defenderSide) *(BATTLE_STACKS_PER_SIDE) +(defenderStackIdInSide);
!!en;

!!VRi^acm_attackStack^:S(stackAttackerID);
!!VRi^acm_defendStack^:S(stackDefenderID);

!!if&(mode)=0;
  !!FU(ACM_OnBeforeMelee):P(stackAttackerID)/(stackDefenderID);
!!el;
  !!FU(ACM_OnBeforeShoot):P(stackAttackerID)/(stackDefenderID);
!!en;

!!FU(ACM_OnBeforeAttack):P(stackAttackerID)/(stackDefenderID);

!?FU(ACM_HOOK_AfterMeleeMainFunc);
!#VA(hook:x);

!!FU(ACM_HOOK_AfterAttackMainFunc):P(hook)/0;

!?FU(ACM_HOOK_AfterShootMainFunc);
!#VA(hook:x);

!!FU(ACM_HOOK_AfterAttackMainFunc):P(hook)/1;

!?FU(ACM_HOOK_AfterAttackMainFunc);
!#VA(hook:x) (mode:x);

!!UN:C(hook)/0/(UNC_INT)/?(stackStructDefender:y);   
!!UN:C(hook)/4/(UNC_INT)/?(stackStructAttacker:y);  

!!VR(stackAttackerID:y):S(NO_STACK); 
!!VR(stackDefenderID:y):S(NO_STACK); 

!!if&(stackStructAttacker); 
  !!UN:C(stackStructAttacker)/244/(UNC_INT)/?(attakerSide:y); 
  !!UN:C(stackStructAttacker)/248/(UNC_INT)/?(attakerStackIdInSide:y);
  !!VR(stackAttackerID):S(attakerSide) *(BATTLE_STACKS_PER_SIDE) +(attakerStackIdInSide); 
!!en;

!!if&(stackStructDefender);
  !!UN:C(stackStructDefender)/244/(UNC_INT)/?(defenderSide:y);
  !!UN:C(stackStructDefender)/248/(UNC_INT)/?(defenderStackIdInSide:y);
  !!VR(stackDefenderID):S(defenderSide) *(BATTLE_STACKS_PER_SIDE) +(defenderStackIdInSide);
!!en;

!!if&(mode)=0;
  !!FU(ACM_OnAfterMelee):P(stackAttackerID)/(stackDefenderID);
!!el;
  !!FU(ACM_OnAfterShoot):P(stackAttackerID)/(stackDefenderID);
!!en;

!!FU(ACM_OnAfterAttack):P(stackAttackerID)/(stackDefenderID)/(mode);


****************************** Artifact Set description made by kongsuni****************************
****************************** Artifact Set description made by CW ****************************
!?FU(ACM_WorkWithArtifact);
!#VA(piHero:x);
!#VA(piArtClicked:x);
----------------------------------------------------------------------------------------------------
!!VR(newLine:z):S^
^;
!!VR(set:y):S0;

;[set variables for sets which do not result in combo artifacts
!!VR(set):+1; !!VRs^artSet_%(set)^:S^,8,14,20,26,56,104,^;      [Darzog's Armor]
!!VR(set):+1; !!VRs^artSet_%(set)^:S^,9,13,22,25,98,103,^;      [Priest of the Light]
!!VR(set):+1; !!VRs^artSet_%(set)^:S^,39,40,41,42,43,44,^;      [Dragon's Fire]
!!VR(set):+1; !!VRs^artSet_%(set)^:S^,11,17,23,29,101^;         [Archdevils Suite]
!!VR(set):+1; !!VRs^artSet_%(set)^:S^,7,16,21,28,100,^;         [Battle Mage War Dress]
!!VR(set):+1; !!VRs^artSet_%(set)^:S^,49,50,51,108,^;           [The Champion's Honor]
!!VR(set):+1; !!VRs^artSet_%(set)^:S^,79,80,81,82,^;            [Elemental Unity]
!!VR(set):+1; !!VRs^artSet_%(set)^:S^,45,46,47,48,^;            [The Adventurer's Fidelity]
!!VR(set):+1; !!VRs^artSet_%(set)^:S^,10,15,19,27,^;            [Basilisk Venom Teeth]
!!VR(set):+1; !!VRs^artSet_%(set)^:S^,86,87,88,89,^;            [Wizard's Knowledge]
!!VR(set):+1; !!VRs^artSet_%(set)^:S^,164,166,167,^;            [Class Set: Adventurer]
!!VR(set):+1; !!VRs^artSet_%(set)^:S^,163,165,168,^;            [Class Set: Mage]
!!VR(set):+1; !!VRs^artSet_%(set)^:S^,161,162,169,^;            [Class Set: Warrior]
!!VR(set):+1; !!VRs^artSet_%(set)^:S^,69,97,99,^;               [Pegasus Harness]
!!VR(set):+1; !!VRs^artSet_%(set)^:S^,57,58,59,^;               [Veil of Light]
!!VR(set):+1; !!VRs^artSet_%(set)^:S^,66,67,68,^;               [Vestments of Authority]
!!VR(set):+1; !!VRs^artSet_%(set)^:S^,63,64,65,^;               [Vision of the Eagle]
!!VR(set):+1; !!VRs^artSet_%(set)^:S^,52,53,^;                  [Ancient Spyglass]

;[set variables for sets which result in combo artifacts
!!VR(comboArtIdFirst:y):S(ART_FIRST);                           [get first comboArtId]
!!FU(acm_GetComboArtIdLast):P?(comboArtIdLast:y);               [get last  comboArtId]

!!VR(artIdFirst:y):S(ART_FIRST);                                [get first artIdId]
!!FU(GetMaxArtifactId):P?(artIdLast:y);                         [get last  artIdId]

;[loop over all combo artIds]
!!re (comboArtId:y)/(comboArtIdFirst)/(comboArtIdLast):;
  !!VR(set):+1;                                                 [increase set]
  !!VRs^artSet_%(set)^:S^,^;                                    [start with comma]

  !!re (artId:y)/(artIdFirst)/(artIdLast):;                     [loop over all artIds]
    !!UN:A(artId)/5/?(belongsToComboArtId:y);                   [check if artId belongs to comboArtId]
    !!co&(comboArtId)<>(belongsToComboArtId):;                  [continue loop when not]
    !!VRs^artSet_%(set)^:+^%(artId),^;                          [add artId to set]
  !!en:;
  !!VRs^artSet_%(set)^:+^999,^;                                 [add dummy artId to set to indicate comboArt]
!!en:;

!!VR(addArtDesc:z):S^%T(gem.endl)^;
!!VR(artClickedZ:z):M3/(piArtClicked);                          [convert to string and ...]
!!VR(artClickedZ):S^,%(artClickedZ),^;                          [... add leading and trailing blank]

!!re (idx:y)/1/(set):;
  !!VRs^artSet_%(idx)^:U(artClickedZ);                          [check if  given artifact is in artifact string]
  ;!IF:M^artClickedZ=<%(artClickedZ)> artSet=<%S(artSet_%(idx))>^;
  !!co&-1:;                                                     [continue when not]
  !!VR(isComboArt:y):S(FALSE);                                  [init with default]
  !!re (token:y)/1/99:;                                         [loop over set; ignore token 0 (leading comma)]
    !!VR(tokenZ:z):M2/s^artSet_%(idx)^/(token);                 [get token]
    !!br&(tokenZ)=^^:;                                          [exit when empty token found]
    !!if&(tokenZ)=^999^:;
      !!VR(isComboArt):S(TRUE);                                 [this set is a comboArt]
      !!br:;                                                    [skip dummy artId]
    !!en:;
    !!VR(artId:y):V(tokenZ);                                    [convert tokenZ into integer]
    !!HE(piHero):A2/(artId)/?(has:y)/?(equipped:y);             [check if art in backpack (has) and/or equipped]
    !!SN:H^art^/(artId)/0/?s^artName^;                          [get artifact name]
    !!VR(color:z)             :S^{~Grey}^;                      [grey for artifacts hero does not have]
    !!VR(color)  &(has)>0     :S^{~Orange}^;                    [orange for artifacts hero at least has]
    !!VR(color)  &(equipped)>0:S^{~LightGreen}^;                [green for artifacts hero has equipped]
    !!VR(addArtDesc):+^%T(gem.endl)%(color)%s(artName){~}^;     [add to artifact description]
  !!en:;

  !!SN:H^art^/(piArtClicked)/1/?s^basicArtDesc^;                [Get basic artifact description]
  !!if&(isComboArt)=(TRUE):;
    !!UN:A(piArtClicked)/5/?(belongsToComboArtId:y);            [get ComboArtId, must be filled]
    !!FU(acm_GetArtifact2ComboArtifact):P(belongsToComboArtId)/?(comboArtId);
    !!UN:N0/(artName:z)/(comboArtId);                           [get name of comboArt]
    !!VRs^basicArtDesc^:U(artName);                             [check if name of ComboArt is already in description]
    !!VR(addArtDesc)&-1:S^%(newLine)%(newLine){~red}%(artName){~}%(addArtDesc)^;
  !!en:;
  !!SN:H^art^/(piArtClicked)/1/^%s(basicArtDesc)%(addArtDesc)^; [add extra description]

  !!VRi^art_isChanged^:S(piArtClicked);
  !!br:;                                                        [artifacts in multiple sets is not supported]
!!en:;
!!FU:E;

*****************************************************************************************************
!?FU(acm_GetComboArtIdLast);
*****************************************************************************************************
!#VA(poComboArtIdLast:x);
-----------------------------------------------------------------------------------------------------
!!VR(firstArtId:y):S(ART_FIRST);
!!FU(GetMaxArtifactId):P?(lastArtId:y);
!!re (artId:y)/(firstArtId)/(lastArtId):;
  !!UN:A(artId)/4/?(comboArtId:y);
  !!VR(poComboArtIdLast)&(comboArtId)>(poComboArtIdLast):S(comboArtId);
!!en:;
!!FU:E; #############################################################################################

*****************************************************************************************************
!?FU(acm_GetArtifact2ComboArtifact);
*****************************************************************************************************
!#VA(piComboArtifact:x);
!#VA(poArtifact:x);
-----------------------------------------------------------------------------------------------------
!!VR(poArtifact):S-1;                                  [init output var]
!!VR(firstArtifactId:y):S(ART_FIRST);                  [set first artifactId]
!!FU(GetMaxArtifactId):P?(lastArtifactId:y);           [set last  artifactId]

!!re (artifact:y)/(firstArtifactId)/(lastArtifactId):; [loop over all artifacts]
  !!UN:A(artifact)/4/?(comboArtifact:y);               [check if current artifact is request comboArtifact]
  !!if&(piComboArtifact)=(comboArtifact):;             [if yes ...]
    !!VR(poArtifact):S(artifact);                      [... set output var]
    !!br:;                                             [... and exit loop]
  !!en:;
!!en:;
!!FU:E; #############################################################################################



****************************************************************************************************
!?MR2; 
!!MR:F?y1;
!!SN:W^Total_MR2_ValueNew^/y1;


****************************************************************************************************
Code to show additional information about spells when hovering over creature stacks.
These informations are
Magical Crit Chance
Magical Crit Damage 
Magic Pierce
Magic Resistance
Spell Channeling enabled or not

!?FU(gem_GetStackIdFromSpellDescription);
!#VA(hookContext:x) (stackId:x) (spellId:x);
!!VR(stackId):S(NO_STACK);
!!UN:Cx1/(STRUCT_HOOK_CONTEXT_EBP)/4/?(ebp:y) C(ebp)/8/4/?(spellId); [get hex id from stack]
!!UN:Cx1/(STRUCT_HOOK_CONTEXT_EDI)/4/?(battleHex:y); [get combat manager from stack]
!!SN:E5141040/(CALLCONV_THISCALL)/(battleHex); [get combat stack from hex struct]
!!VR(battleStack:y):Sv1;                [save stack struct]
!!if&(battleStack);
  !!UN:C(battleStack)/244/4/?(side:y) C(battleStack)/248/4/?(stackBySide:y); [get id/side]
  !!VR(stackId):S(side:y) *21 +(stackBySide:y); [get combat id]
!!en;


!?FU(OnStartOrLoad);                      [At gamestart]
!!SN:L^EraPlugins\erm_hooker.era^/?y1;
!!if&y1;
  !!SN:Ay1/^SetHook^/?y2;
  !!SN:Ey2/1/5934078/(ACM_AfterSpellAtStackDesc); [Hook when hovering spells over enemie by daemon_n]
!!en;


!?FU(ACM_AfterSpellAtStackDesc);
!!SN:B6911016/d/?z1;
!!FU(gem_GetStackIdFromSpellDescription):Px1/?(stackId:y)/?(spellId:y);
!!if&(stackId)<>(NO_STACK);  
  !!BG:Q?y10;                           [get battle side]
  !!BHy10:N?y99; !!FU&y99<0:E;          [Get left hero number]
  !!FU(ACM_Calc_Magic_Pierce):Py99/?y14;[Pass hero number and return magic pierce value]
  !!FU(H3_Calc_Crit_Chance_and_Damage):Py99/?y11/?y12/0; [IF 1 at the end it means to in fight 0 means only check]
  !!SN:W^Total_MR2_ValueNew^/?y15;
  !!SN:T^AC_Misc.Spell_Description_Battle_Log^/?z12/^Crit1^/y11/^Crit2^/y12/^pierce^/y14/^MR^/y15; !!SN:Iz12/?z12; [set text]
  !!MM:Mz12;                            [show message in battle log]
!!en;


*Script to show magic related information when right clicking on spell book in combat
!?FU(OnBattleScreenMouseClick)&i^mouse_action^=(MOUSE_RMB_PRESSED)/i^dlg_action^=(DLG_CMD_TYPE_DEFAULT)/i^mouse_flags^=(MOUSE_FLAG_RMB);

!!CM:D?y1 I?y2;                         [Get Battlefield position with click]
!!if&y1=-1/y2=2008;                     [if right clicked on spell book in battle]
!!CM:R0;                                [Disable standard reaction]
!!BG:Q?y10;                             [get current acting side]
!!BA:Hy10/?y99;                         [get current hero]
!!FU&y99<0:E;
  !!HEy99:B0/?z4;
  !!FU(ACM_Calc_Magic_Pierce):Py99/?y14;[Pass hero number and return magic pierce value]
  !!FU(H3_Calc_Crit_Chance_and_Damage):Py99/?y11/?y12/0; [IF 1 at the end it means to in fight 0 means only check]
  !!FU(ACM_Calc_Extra_Casts):Py99/y10/?y17; [Pass hero number and return magic pierce value]
  !!SN:W^Total_MR2_ValueNew^/?y15;      [get total Magic Resistance value]
  !!SN:W^Grandmaster_Mage_Hero%Y99^/?y30;[Gm Mage Channeling ability If Spell Points are abouve maximum increase damage by +15%]
  !!if&y30=1;
    !!FU(Intelligence_Set_Spell_Points):Py99/0/?y31/1; [Return Number of Max Possible Spell Points in y31 for the Hero and only check not set]
    !!HEy99:I?y32/1;                    [Get Current Heroes Spell Points]
    !!VRy33:Sy31*95:100;                [Get 95% of max spell points]
    !!VRy16:S0;
    !!VRy16&y32>=y33:S1;
  !!en;
  !!BHy10:M?y18;                        [check if cast available]
  !!VRz2&y18=0:S^%T(AC_Misc.Spell_Book_Description_Active)^;               [set text]
  !!VRz2&y18=1:S^%T(AC_Misc.Spell_Book_Description_Disabled)^;
  !!SN:W^Arcane_Prophet_Spell_%Y99^/?y20;[Check Spell by Hero ID]
  !!SN:W^Arcane_Prophet_Spell_Damage%Y99^/?y15; [Check Spell damage by Hero ID]
  !!VRz3&y20=0:S^%T(AC_Misc.Spell_Book_Description_None)^;
  !!SN&y20>0:H^spell^/y20/(SPELL_TEXT_NAME)/?z3;
  !!SN:T^AC_Misc.Spell_Book_Description^/?z12/^Crit1^/y11/^Crit2^/y12/^pierce^/y14/^MR^/y15/^casts^/y17/^rcast^/z2/^chan^/y16/^ArPro^/z3/^damage^/y15/^name^/z4; [set text]
  !!IF&1000/999:M^%Z12^;                [Show message]
!!en;


!?FU(ACM_Calc_Extra_Casts);
x1=hero number, x2=acting side, x3=returns number of extra casts for this combat

!!BG:Q?y1;                              [get acting side]
!!SN&y1=0:W^Double_Cast_Attacker^/?y2;  [Check Extra Cast Variable Attacker]
!!SN&y1=1:W^Double_Cast_Defender^/?y2;  [Check Extra Cast Variable Defender]
!!SN&y1=0:W^Magic_Week_34_att^/?y3;
!!SN&y1=1:W^Magic_Week_34_def^/?y3;
!!SN&y1=0:W^Magic_Week_41_att^/?y4;
!!SN&y1=1:W^Magic_Week_41_def^/?y4;
!!SN:W^Magic_Week_Spell_Element^/?y5;
!!SN&y1=0:W^Elemental_Set_att^/?y6;
!!SN&y1=1:W^Elemental_Set_def^/?y6;
!!SN&y1=0:W^Master_Mage_Extra_Cast_att^/?y7;
!!SN&y1=1:W^Master_Mage_Extra_Cast_def^/?y7;
!!SN&y1=0:W^Magic_Specialists_Att^/?y8; 
!!SN&y1=1:W^Magic_Specialists_Def^/?y8; 
!!SN&y1=0:W^Special_Hero_Extra_Cast_Att^/?y9; 
!!SN&y1=1:W^Special_Hero_Extra_Cast_Def^/?y9; 

!!VRy10:S0+y2+y3+y4+y5+y6+y7+y8+y9;     [sum up all values]
!!VRx3:Sy10;                            [return in x3]


****************************************************************************************************
Set description of Warmachines when right clicking them in battle
; For dynamic description (description will change in the battle)
!?FU(OnBattleScreenMouseClick)&i^mouse_battleHex^>0/i^mouse_battleHex^<186;
!!BU:Ei^mouse_battleHex^/?y2;
!!FU&y2=-1:E;                           [get monster ID at position and exit if no monster]

!!if&y2>=0/y2<=41;
  !!BMy2:T?y3 I?y4 S?y6;                [get monster type and side index]
  !!BHy4:N?y30;                         [Get hero or commander ID]

  !!if|y3=145/y3=146/y3=147/y3=148;     [if any warmachine]
    !!FU(ACM_SetUpNewWarMachineDesc):Py2/y4; [run function to set new description]
  !!en;
!!en;


!?FU(ACM_SetUpNewWarMachineDesc);
!#VA(stack:x) (side:x);

; Exit if not owned by a hero
!!FU&i^battle_hero_%(side)^<=(NO_HERO):E;

; Exit if not a war machine/catapult in siege
!!BM(stack):T?(type:y);
!!FU|(type)<(MON_CATAPULT)/(type)>(MON_AMMO_CART):E;

; Get the stack struct
!!BM(stack):Z?(stackStruct:y);
!!VR(hero:y):Si^battle_hero_%(side)^;

*get the description of upgrades in z4 by calling the fct
!!FU(Get_WM_Upgrade_Description)&(type)=145:P(hero)/(ART_CATAPULT)/?(desc:z)/?(shortDesc:z); [145 Catapult]
!!FU(Get_WM_Upgrade_Description)&(type)=146:P(hero)/(ART_BALLISTA)/?(desc)/?(shortDesc); [146 Ballista]
!!FU(Get_WM_Upgrade_Description)&(type)=147:P(hero)/(ART_FIRST_AID_TENT)/?(desc)/?(shortDesc); [147 First Aid Tent]
!!FU(Get_WM_Upgrade_Description)&(type)=148:P(hero)/(ART_AMMO_CART)/?(desc)/?(shortDesc); [148 Ammo Cart]

*some code to get additional heal parameter
!!if&(type)=(MON_FIRST_AID_TENT);
  !!HE(hero):S27/?y80;  
  !!FU(AC_Function_35):P(stack)/y80/1/0/(hero);[function to set low and high heal value]
  !!SN:W^Heal_InCombat_Low_Hero%(hero)^/?y66; [Save Low Heal to display it in Bonus List]
  !!SN:W^Heal_InCombat_High_Hero%(hero)^/?y67; [Save High Heal to display it in Bonus List]
  !!VRy66&y66=0:S20;
  !!VRy67&y67=0:S40;                    [set to minimum heal]
  !!SN&(side)=0:W^Tent_Capacity_Att^/?y68;
  !!SN&(side)=1:W^Tent_Capacity_Def^/?y68; [Save HC from hero to show in bonus list]

!!el&(type)=(MON_BALLISTA);
  !!SN:W^Total_Ballista_Shots^/?y50;    [save number of total shots to display on right click]
  !!FU(ACM_Calc_Ballista_Shots):P146/(hero)/(stack)/?y50; [Pass Ballista ID and Hero and stack and return number of ballista shots]
!!en;

!!SN&(type)=145:T^AC_Misc.ACM_Catapult_Battle_Desc^/?z-3; [get description from json file for catapult]
!!SN&(type)=146:T^AC_Misc.ACM_Ballista_Battle_Desc^/?z-3/^shots^/y50;
!!SN&(type)=147:T^AC_Misc.ACM_Aid_Tent_Battle_Desc^/?z-3/^low^/y66/^high^/y67/^capa^/y68;
!!SN&(type)=148:T^AC_Misc.ACM_AmmoCart_Battle_Desc^/?z-3; !!SN:Iz-3/?z-3;

!!VR(desc:z)&(type)=145:S^%z-3
%z4^; set description and merge with additional info about warmachine upgrades
!!VR(desc)&(type)=146:S^%z-3
%z4^;
!!VR(desc)&(type)=147:S^%z-3
%z4^;
!!VR(desc)&(type)=148:S^%z-3
%z4^;

; Get the index of the item in the array
!!VR(index:y):S4 *(side) +(type) -(MON_CATAPULT); [4 - war machines of a side, the array size is 8]

!!FU(ACM_AllocWarMachineBattleStr):P(desc)/(index)/?(newDescAddr:y);
!!UN:C(stackStruct)/144/(UNC_INT)/(newDescAddr); [Apply new description]

// Get the string pointer to be used in battle
!?FU(OnSetupBattlefield)&i^battle_isVisible^;
; Recreate battle strings persistent storage
!!SN:Mi^acm_warMchineBattleStrings^;
!!FU(NewStrArray):P8/?i^acm_warMchineBattleStrings^/(M_TEMP); [size = 8 for 4 machines each side]

!?FU(OnAfterBattleUniversal)&i^acm_warMchineBattleStrings^;
; Free battle strings persistent storage
!!SN:Mi^acm_warMchineBattleStrings^;
!!VRi^acm_warMchineBattleStrings^:S0;

!?FU(ACM_AllocWarMachineBattleStr);
; Stores string in a battle persistent memory and returns its raw address in memory
!#VA(textPtr:x); string contents to get persistent address for
!#VA(index:x);
!#VA(result:x);  result raw string address

!!SN:Mi^acm_warMchineBattleStrings^/(index)/z(textPtr);
!!SN:Mi^acm_warMchineBattleStrings^/?(result)/(index);


*function to calc number of ballista shots
!?FU(ACM_Calc_Ballista_Shots);
x1=ballista ID, x2=hero, x3=stack, x4=returns value

!!SN:W^Total_Ballista_Shots^/1;         [save number of total shots to display on right click]
* Master and Grandmaster Artillery
!!if&x1=146;                            [If Ballista and a Ranged Attack]
  !!BMx3:I?y5;                          [get stack side]
  !!BA:Hy5/?y6;                         [Current Hero]
  !!FU&y6<0:E;                          [Exit if none]
  !!HEx2:S20/?y10;                      [Check for Artillery]
  !!SN&y10=3:W^Total_Ballista_Shots^/d1;[save number of total shots to display on right click]
  !!SN:W^H3_Artillery_0_Hero%X2^/?y71;  [Checke ob der Held Master Artillery hat und Speichere in y71]
  !!SN:W^H3_Artillery_1_Hero%X2^/?y72;  [Checke ob der Held Grandmaster Artillery hat und Speichere in y72]
  !!HEx2:X?y81/?y82/?y83/?y84/?y85/?y86/?y87 A2/142/d/?y8; [Check Hero Speciality and hero has a 142 Gold Tower Arrow]
  !!SN&y10=3/y71=1:W^Total_Ballista_Shots^/d1; [Add 1 shot for Master]
  !!SN&y10=3/y72=1:W^Total_Ballista_Shots^/d1; [Add 1 shot for Grandmaster]
  !!SN&y8=1:W^Total_Ballista_Shots^/d1; [Add 1 shot for Gold Tower Arrow]

  * Artillery Specialists
  6 Christian 54 Pyre 81 Arlach 97 Gurnisson
  !!if|x2=6/x2=97/x2=54/x2=81;
    !!HEx2:E?y86/?y87/1;
    !!SN:W^Total_Ballista_Shots^/d1;    [Add 1 Artillery Specialist]
    !!SN&y87>=20:W^Total_Ballista_Shots^/d1; [Add 1 Artillery Specialist above level 20]
    !!SN&y87>=40:W^Total_Ballista_Shots^/d1; [Add 1 Artillery Specialist above level 40]
    !!SN&y87>=60:W^Total_Ballista_Shots^/d1; [Add 1 Artillery Specialist above level 60]
    !!SN&y87>=80:W^Total_Ballista_Shots^/d1; [Add 1 Artillery Specialist above level 80]
    !!SN&y87>=100:W^Total_Ballista_Shots^/d1; [Add 1 Artillery Specialist above level 100]
  !!en;

  *Ballista Upgrade at Blacksmith can give +1 Shot
  !!SN:W^Ballista_Add_Shots_%X2^/?y11;
  !!SN&y11=1:W^Total_Ballista_Shots^/d1;[Add 1 Artillery Shot for Upgrade]
!!en;

!!SN:W^Total_Ballista_Shots^/?y50;
!!VRx4:Sy50;                            [return value in x4]


****************************************************************************************************
// Set up campaign carry over feature
// by Archer30
; Transfer Master/Grandmaster level of secondary skills to the next campaign zone

!?FU(OnWinGame);
!!SN:F^IsCampaign^;
!!FU&v1<>(TRUE):E;

!!VR(filePath:z):S^Runtime/advanced classes transfer.ini^;

!!re i/(HERO_FIRST)/(HERO_LAST_WOG);
  ; Additional secondary skill levels
  !!VR(masterSkillsFlags:y):S0;
  !!VR(grandMasterSkillsFlags:y):S0;

  !!re (ss:y)/(SEC_SKILL_FIRST)/(SEC_SKILL_LAST);
    ; Set the status of Master/Grandmaster of every secondary skills in the array
    !!SN:Mi^acm_SkillNames_ArrayId^/(ss)/?(ssName:z);

    !!if|i^H3_%(ssName)_0_Hero%i^/i^H3_%(ssName)_1_Hero%i^;
      !!VR(ssBit:y):S1 Sd<<(ss);
      !!VR(grandMasterSkillsFlags)&i^H3_%(ssName)_1_Hero%i^:+(ssBit);
      !!VR(masterSkillsFlags)&i^H3_%(ssName)_0_Hero%i^:+(ssBit);
    !!en;
  !!en;

  !!FU(WriteIniInts):P(filePath)/^master^/^%i^/(masterSkillsFlags) P(filePath)/^grandmaster^/^%i^/(grandMasterSkillsFlags);
!!en;

!!FU(SaveIni):P(filePath);

!?FU(OnTransferHero);
!#VA(hero:x);

!!VR(filePath:z):S^Runtime/advanced classes transfer.ini^;
!!FU(ReadIniInts):P(filePath)/^master^/^%(hero)^/?(masterSkillsFlags:y)/0 P(filePath)/^grandmaster^/^%(hero)^/?(grandMasterSkillsFlags:y)/0;

!!if|(masterSkillsFlags)/(grandMasterSkillsFlags);
  ; Additional secondary skills levels
  !!re (ss:y)/(SEC_SKILL_FIRST)/(SEC_SKILL_LAST);
    !!SN:Mi^acm_SkillNames_ArrayId^/(ss)/?(ssName:z);
    !!VR(ssBit:y):S1 Sd<<(ss);
    !!VRi^H3_%(ssName)_0_Hero%(hero)^:S(masterSkillsFlags) &(ssBit) B;
    !!VRi^H3_%(ssName)_1_Hero%(hero)^:S(grandMasterSkillsFlags) &(ssBit) B;
  !!en;

  ; Save a copy of initial flags to be used when restarting game
  !!VRi^acm_ssFlags_0_%(hero)_init^:S(masterSkillsFlags);
  !!VRi^acm_ssFlags_1_%(hero)_init^:S(grandMasterSkillsFlags);
!!en;

; Remove ini OnAfterErmInstructions as there is no OnTransferHero on the victory of the the last zone of a campaign
!?FU(OnAfterErmInstructions);
!!VR(filePath:z):S^Runtime/advanced classes transfer.ini^;
!!FU(FileExists):P(filePath)/?(result:y);

!!if&(result);
  !!FU(ClearIniCache):P(filePath);
  !!FU(DeleteFile):P(filePath)/?(result);
!!en;

; Restore initial flags on restarting game
!?FU(OnGameLeave);
!!SN:F^IsCampaign^;
!!FU&v1<>(TRUE):E;

; Check if it is a restarting map event
!!UN:C6911784/4/?(value:y);
!!FU&(value)<>107:E;

!!VR(filePath:z):S^Runtime/advanced classes transfer.ini^;

!!re (hero:y)/(HERO_FIRST)/(HERO_LAST_WOG);
  !!if|i^acm_ssFlags_0_%(hero)_init^/i^acm_ssFlags_1_%(hero)_init^;
    !!FU(WriteIniInts):P(filePath)/^master^/^%(hero)^/i^acm_ssFlags_0_%(hero)_init^ P(filePath)/^grandmaster^/^%(hero)^/i^acm_ssFlags_1_%(hero)_init^;
  !!en;
!!en;

!!FU(SaveIni):P(filePath);

********************************************************************************



                                      TEST SECTION




********************************************************************************
!?HM-1;

!!FU:E;
!!HE-1:N?y99; 
!!SN:W^ACM_Commander_Hero_ID^/y99;
!!SN:W^Commander_Kill_Counter_%Y99^/250;
!!FU:E;
*!FU(Check_Com_Masteries):Py99/0/0/0/?y98; [Pass Hero Number and return current class]
*!FU(ACM_Select_Commander_Role)&999:Py99;[Call DL to select Commander class on first kill. Pass current hero-y10 and commander ID-y2 if Human]
!!FU(ACM_Select_Commander_Role_Upg)&y98<10/999:Py99; [Call DL to select Commander class on first kill. Pass current hero-y10 and commander ID-y2 if Human]

!!FU(Check_Com_Masteries):Py99/0/0/0/?y98; [Pass Hero Number and return current class]
!!IF:L^Current Class is %Y98^;
!!HE-1:N?y99;
  !!SN:W^Commander_%Y99_Ancient_Fighter^/?y1;
  !!SN:W^Commander_%Y99_Ancient_Ranger^/?y2;
  !!SN:W^Commander_%Y99_Ancient_Defender^/?y3;
  !!SN:W^Commander_%Y99_Ancient_Caster^/?y4;
  !!SN:W^Commander_%Y99_Ancient_Supporter^/?y5;
  !!SN:W^Commander_%Y99_Ancient_Leader^/?y6;
  !!SN:W^Commander_%Y99_Ancient_Scout^/?y7;
  !!SN:W^Commander_%Y99_Ancient_Undead^/?y8;
  !!SN:W^Commander_%Y99_Ancient_FireMage^/?y9;
  !!IF:L^%Y1 %Y2 %Y3 %Y4 %Y5 %Y6 %Y7 %Y8 %Y9^;

!?FU(OnAdventureMapRightMouseClick);
!!FU:E;
!!CM:F?v3 I?v4 S?v5;                    [where we click and click subtype]
!!if&v3=512;                            [if right click and kingdom overview icon are clicked]  

  !!SN:W^ACM_Commander_Hero_ID^/?y99;
  !!IF:M^Now Warden Commander %Y99^;
  
  !!SN:W^Commander_Fighter_%Y99^/0;     [Check if options have already been activated]
  !!SN:W^Commander_Ranger_%Y99^/0;
  !!SN:W^Commander_Defender_%Y99^/0;
  !!SN:W^Commander_Caster_%Y99^/0;
  !!SN:W^Commander_Supporter_%Y99^/0;
  !!SN:W^Commander_Leader_%Y99^/0;
  !!SN:W^Commander_Scout_%Y99^/0;
  !!SN:W^Commander_Undead_%Y99^/0;
  !!SN:W^Commander_FireMage_%Y99^/0;

  !!SN:W^Commander_Dragonslayer_%Y99^/0; 
  !!SN:W^Commander_Sniper_%Y99^/0; 
  !!SN:W^Commander_Retaliator_%Y99^/0; 
  !!SN:W^Commander_ArchMage_%Y99^/0; 
  !!SN:W^Commander_Constructor_%Y99^/0; 
  !!SN:W^Commander_King_%Y99^/0; 
  !!SN:W^Commander_Prospector_%Y99^/0;
  !!SN:W^Commander_Lich_%Y99^/0; 
  !!SN:W^Commander_Vampire_%Y99^/0; 

  !!SN:W^Commander_Paladin_%Y99^/0; 
  !!SN:W^Commander_Marksmen_%Y99^0; 
  !!SN:W^Commander_Avenger_%Y99^/0; 
  !!SN:W^Commander_Warden_%Y99^/1; 
  !!SN:W^Commander_Arcanist_%Y99^/0;
  !!SN:W^Commander_General_%Y99^/0; 
  !!SN:W^Commander_Lancer_%Y99^/0; 
  !!SN:W^Commander_Necromant_%Y99^/0; 
  !!SN:W^Commander_Ancient_%Y99^/0; 

  !!SN:W^Commander_%Y99_Ancient_Fighter^/1;
  !!SN:W^Commander_%Y99_Ancient_Ranger^/1;
  !!SN:W^Commander_%Y99_Ancient_Defender^/1;
  !!SN:W^Commander_%Y99_Ancient_Caster^/1;
  !!SN:W^Commander_%Y99_Ancient_Supporter^/1;
  !!SN:W^Commander_%Y99_Ancient_Leader^/1;
  !!SN:W^Commander_%Y99_Ancient_Scout^/1;
  !!SN:W^Commander_%Y99_Ancient_Undead^/1;
  !!SN:W^Commander_%Y99_Ancient_FireMage^/1;
!!en;

!!FU:E;
*!SN:W^ACM_Com%X1_Artifact_151^/?y1;  [147 Mithril Mail]

*!COx1:A4/?y20/?y21/?y22/?y23/?y24/?y25/?y26/?y27/?y28/?y29/?y30/?y31; 
*!IF:L^Battles Won %Y20 %Y21 and %Y22 %Y23 and %Y24 %Y25 and %Y26 %Y27 and %Y28 %Y29 and %Y30 %Y31  y1 is%Y1^;

*diminishing return calculation
*!VRy40:S70;
*!VRy42:Sy40:50;
*!VRy41:Sy40%50;
*!VRy43&y42=1:Sy41:2+50;
*!VRy43&y42=2:Sy41:3+75;
*!VRy43&y42=3:Sy41:4+92;
*!VRy43&y42=4:Sy41:5+105;
*!VRy43&y42=5:Sy41:6+115;
*!VRy43&y42=6:Sy41:7+123;
*!VRy43&y42=7:Sy41:8+130;
*!VRy43&y42=8:Sy41:9+136;

*!IF:M^y40 is %Y40
y41 is%Y41
y42 is%Y42

Result is %Y43^;


146 Axe of Smashing ***
147 Mithril Mail ***
148 Sword of Sharpness ***
149 Helm of Immortality ***
150 Pendant of Sorcery ***
151 Boots of Haste ***
152 Bow of Seeking ***
153 Dragon Eye Ring ***
154 Hardened Shield ***
155 Slava's Ring of Power *** 


*?FU(OnCombatRound)&v997=0;

*!DO(AC_Function_499)/0/20/1:P;


*!DO(AC_Function_499)/21/41/1:P;

*?FU(AC_Function_499);
*!BMx16:T?y1;
*!BMx16:N?y2;
*!FU|y1=145/y1=146/y1=147/y1=148/y1=149:E;
*!if&y2>0;
*!BMx16:S100;
*!BMx16&x16<20:S200;
*!en;


*?HM-1;

*!VRy2:S66;

*!HE-1:N?y99; 
*!SSy2:E0/?y20;
*!SSy2:E1/?y21;
*!SSy2:E2/?y22;
*!SSy2:E3/?y23;
*!SSy2:P?y24;
*!IF:L^Spell Effect is %Y20 %Y21 %Y22 %Y23 Power %Y24^;